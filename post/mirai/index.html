<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>Mirai安装教程 :: Keep Improving</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Mirai mirai 是一个在全平台下运行，提供 QQ Android 协议支持的高效率机器人库。
" />
<meta name="keywords" content="" />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://leejay.top/post/mirai/" />




<link rel="stylesheet" href="https://leejay.top/assets/style.css">






<link rel="apple-touch-icon" href="https://leejay.top/img/favicon.png">

  <link rel="shortcut icon" href="https://leejay.top/img/favicon.png">



<meta name="twitter:card" content="summary" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Mirai安装教程">
<meta property="og:description" content="Mirai mirai 是一个在全平台下运行，提供 QQ Android 协议支持的高效率机器人库。
" />
<meta property="og:url" content="https://leejay.top/post/mirai/" />
<meta property="og:site_name" content="Keep Improving" />

  
    <meta property="og:image" content="https://leejay.top/img/favicon.png">
  

<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">

  <meta property="article:section" content="mirai" />


  <meta property="article:published_time" content="2022-03-07 10:21:01 &#43;0800 &#43;0800" />










<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fira+Code">

</head>
<body class="orange">


<div class="container center headings--one-size">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="https://leejay.top">
  <div class="logo">
    HelloWorld
  </div>
</a>

    </div>
    
  </div>
  
  
  <script type="text/javascript"
        async
        src="https://cdn.bootcss.com/mathjax/2.7.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\[\[','\]\]']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
});

MathJax.Hub.Queue(function() {
    
    
    
    var all = MathJax.Hub.getAllJax(), i;
    for(i = 0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
});
</script>

<style>
code.has-jax {
    font: inherit;
    font-size: 100%;
    background: inherit;
    border: inherit;
    color: #515151;
}
</style>

</header>


  <div class="content">
    
<div class="post">
  
  
    









<div class="toc" id="toc_id">

    <div class="page-header"><strong> ↓ 目录 ↓ </strong></div>

    <div id="page-scrollspy" class="toc-nav">

        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#mirai">
                    Mirai
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e5%89%8d%e8%a8%80">
                    前言
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#mirai%e5%ae%89%e8%a3%85">
                    mirai安装
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e6%8f%92%e4%bb%b6%e5%ae%89%e8%a3%85">
                    插件安装
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#http%e6%8f%92%e4%bb%b6">
                    Http插件
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e6%8f%92%e4%bb%b6%e9%85%8d%e7%bd%ae">
                    插件配置
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e7%99%bb%e5%bd%95qq%e8%b4%a6%e5%8f%b7">
                    登录QQ账号
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e7%99%bb%e5%bd%95%e9%aa%8c%e8%af%81">
                    登录验证
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e7%a8%8b%e5%ba%8f%e8%af%bb%e5%8f%96qq%e4%bf%a1%e6%81%af">
                    程序读取QQ信息
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        

    </div>

</div>



  
  <h1 class="post-title">
    <a href="https://leejay.top/post/mirai/">Mirai安装教程</a></h1>
  <div class="post-meta">
    
      <span class="post-date">
        2022-03-07 
      </span>
    
    
  </div>

  
  <span class="post-tags">
    
    #<a href="https://leejay.top/tags/mirai/">mirai</a>&nbsp;
    
  </span>
  

  

  

  <div class="post-content"><div>
        <h2 id="mirai">Mirai<a href="#mirai" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<blockquote>
<p><a href="https://github.com/mamoe/mirai">mirai</a> 是一个在全平台下运行，提供 QQ Android 协议支持的高效率机器人库。</p>
</blockquote>
<h3 id="前言">前言<a href="#前言" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>因为程序需要监听QQ群消息的缘故，在GITHUB上找到这款基于Android协议的机器人库，记录下安装的过程及踩坑的经历。</p>
<h3 id="mirai安装">mirai安装<a href="#mirai安装" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>官方提供了不同平台的<a   href="https://github.com/mamoe/mirai/blob/dev/docs/UserManual.md">安装教程</a>，并推荐使用纯控制台的版本（mcl-install），我们在window上安装，所以选择<code>mcl-installer-?-windows-amd64.exe</code>版本下载，下载后双击打开安装。一路回车安装，都选择默认值即可。进入cmd执行mcl命令，出现下图提示即为安装成功。</p>
<p><img src="https://image.leejay.top/FovL62-908zQoLQiPl29Jz6vWWL6" alt=""></p>
<h3 id="插件安装">插件安装<a href="#插件安装" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<h4 id="http插件">Http插件<a href="#http插件" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p>因为程序需要监听QQ群的消息，于是我们选择安装官方推荐的Http插件<a href="https://github.com/project-mirai/mirai-api-http/releases">mirai-http-api</a>与我们程序进行交互。在mirai安装目录下执行如下命令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mcl --update-package net.mamoe:mirai-api-http --type plugin --channel stable
</span></span></code></pre></div><p>上述命令执行后，再次启动mriai（mcl命令），程序会自动下载对应的插件包，但是会出现下图的错误：</p>
<p><img src="https://image.leejay.top/FjJimXKQD7GarY8aBQSOD9dwDyNP" alt=""></p>
<p>原因就是版本太高导致的（可以选择降低版本，降低为<a href="https://github.com/project-mirai/mirai-api-http/releases">1.1.0版本</a>，替换文件下的plugins内的jar包版本和config.yaml中的版本号）</p>
<p><img src="https://image.leejay.top/FhB3kqBzB_eaGAMXuONSl4AVFebb" alt=""></p>
<h4 id="插件配置">插件配置<a href="#插件配置" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e">## 配置文件中的值，全为默认值</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 启用的 adapter, 内置有 http, ws, reverse-ws, webhook</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">adapters</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">http</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">ws</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 是否开启认证流程, 若为 true 则建立连接时需要验证 verifyKey</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 建议公网连接时开启</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">enableVerify</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">verifyKey</span>: <span style="color:#ae81ff">1234567890</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 开启一些调式信息</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">debug</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 是否开启单 session 模式, 若为 true，则自动创建 session 绑定 console 中登录的 bot</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 开启后，接口中任何 sessionKey 不需要传递参数</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 若 console 中有多个 bot 登录，则行为未定义</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 确保 console 中只有一个 bot 登陆时启用</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">singleMode</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 历史消息的缓存大小</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 同时，也是 http adapter 的消息队列容量</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">cacheSize</span>: <span style="color:#ae81ff">4096</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## adapter 的单独配置，键名与 adapters 项配置相同</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">adapterSettings</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">## 详情看 http adapter 使用说明 配置</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">http</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">host</span>: <span style="color:#ae81ff">localhost</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8080</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">cors</span>: [<span style="color:#e6db74">&#34;*&#34;</span>]
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">## 详情看 websocket adapter 使用说明 配置</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ws</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">host</span>: <span style="color:#ae81ff">localhost</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8080</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">reservedSyncId</span>: -<span style="color:#ae81ff">1</span>
</span></span></code></pre></div><hr>
<h3 id="登录qq账号">登录QQ账号<a href="#登录qq账号" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<h4 id="登录验证">登录验证<a href="#登录验证" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p>我们启动mriai后，在控制台输入<code>login qq账号 qq密码</code>，一般会出现滑动验证弹窗，如下图所示：</p>
<p><img src="https://image.leejay.top/Fg7qBcaAxh-E8aK4rEZgRCnKlAgu" alt=""></p>
<p>这个问题我们需要使用<a href="https://github.com/mzdluo123/TxCaptchaHelper">滑动验证助手</a>来实现滑动验证，在安卓手机上安装软件<a href="https://maupdate.rainchan.win/txcaptcha.apk">滑动验证助手</a>，将上图中的5670输入软件后，会出现滑动弹窗，手动验证后，若出现登录成功的提示即为成功。</p>
<hr>
<h3 id="程序读取qq信息">程序读取QQ信息<a href="#程序读取qq信息" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>上面的账户登录成功后，控制台就会打印QQ中收到的信息，如果我们需要实现程序监听，那么还需要读取mirai的程序，这边提供一个基于python和websocket模式的demo。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">read_message</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">with</span> websockets<span style="color:#f92672">.</span>connect(
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;ws://</span><span style="color:#e6db74">{0}</span><span style="color:#e6db74">/message?verifyKey=</span><span style="color:#e6db74">{1}</span><span style="color:#e6db74">&amp;qq=</span><span style="color:#e6db74">{2}</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(host, verify_key, str(login_qq))) <span style="color:#66d9ef">as</span> websocket:
</span></span><span style="display:flex;"><span>        log<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#39;mirai websocket 服务连接成功！&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>            message <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> websocket<span style="color:#f92672">.</span>recv()
</span></span><span style="display:flex;"><span>            print(message)
</span></span><span style="display:flex;"><span>asyncio<span style="color:#f92672">.</span>get_event_loop()<span style="color:#f92672">.</span>run_until_complete(read_message())
</span></span></code></pre></div>
      </div></div>

  
  
<div class="pagination">
    <div class="pagination__title">
        <span class="pagination__title-h">其他文章</span>
        <hr />
    </div>
    <div class="pagination__buttons">
        
        <span class="button previous">
            <a href="https://leejay.top/post/kube_eventer/">
                <span class="button__icon">←</span>
                <span class="button__text">Kube Eventer基于mysql的使用</span>
            </a>
        </span>
        
        
        <span class="button next">
            <a href="https://leejay.top/post/aperao_cas/">
                <span class="button__text">ApereoCas安装与使用教程</span>
                <span class="button__icon">→</span>
            </a>
        </span>
        
    </div>
</div>

  

  

</div>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright copyright--user">
        <span><a rel="nofollow" href="https://beian.miit.gov.cn/" target="_blank">苏ICP备18050258号-1</a></span>
    
        
      </div>
  </div>
</footer>

<script src="https://leejay.top/assets/main.js"></script>
<script src="https://leejay.top/assets/prism.js"></script>






  
</div>

</body>
</html>
