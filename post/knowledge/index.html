<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>Java中的小知识点 :: Keep Improving</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="1. Java是值传递还是引用传递 结论： Java只有值传递没有引用传递。
值传递与引用传递的区别：对形参的修改不会影响到实参被称为值传递。引用传递则相反。
public static void change(Integer i) { i = 3; } public static void change(Person person) { person.name = &amp;#34;李四&amp;#34;; } public static void main(String.. args) { Integer x = 1; change(x); System.out.println(x); // x = 1; Person person = new Person(&amp;#34;张三&amp;#34;); change(person); System.out.println(person.getName()); // &amp;#34;李四&amp;#34; } 如果是基本数据类型，是将数据复制一份传递给方法，自然不会影响。 如果是对象做参数时，将堆中对象的引用复制一份传递给方法，引用的地址不会被修改（也是被称为值传递的根本原因)，但是地址的内容会被函数修改。 2. 包装类Integer中的缓存池 Integer x = 123; Integer y = 123; System.out.println(x == y); // true Integer a = 128; Integer b = 128; System.out.println(a == b); // false System.out.println(a.equals(b)); // true Integer z = Integer.valueOf(123); Integer w = new Integer(123); System.out.println(x == z); // true System.out.println(z == w); // false Integer类型的缓存池的范围是[-128, 127]，只要是这个范围的值自动装箱就会返回相同的对象。 Integer类型中的equals()方法是对包装的值进行了比较，而不是比较对象。 valueOf()方法利用了缓存，符合第一条的规则。 如果通过new关键字创建对象，是没用利用缓存，并不符合第一条规则。 3. 多层嵌套循环跳出问题 c中可以通过goto语句跳出多层嵌套循环，java保留了goto关键字，但没有任何作用。
public static void main(String[] args) { int[] a = new int[]{1, 2}; int[] b = new int[]{4, 5}; loop_a: for (int j : a) { for (int k : b) { if (k == 5) { break loop_a; // 跳出最外层循环 } System.out.println(j &#43; &amp;#34; -&amp;gt; &amp;#34; &#43; k); // 1 -&amp;gt; 4 } } System.out.println(&amp;#34;------------------------&amp;#34;); loop_b: for (int j : a) { for (int k : b) { if (k == 5) { continue loop_b; // 跳过内层循环值为5的，继续从外层的下一个数开始执行 } System.out.println(j &#43; &amp;#34; -&amp;gt; &amp;#34; &#43; k); // 1 -&amp;gt; 4; 2 -&amp;gt; 4 } } } } 4. String对象的创建 字符串常量池（String Common Pool）：因为字符串的大量创建会影响程序的性能，JVM引入了字符串常量池来减少字符串性能的开销（也基于字符串的不可变性才能实现）。
String a = &amp;#34;abc&amp;#34;; String b = new String(&amp;#34;abc&amp;#34;); String c = &amp;#34;a&amp;#34; &#43; &amp;#34;b&amp;#34; &#43; &amp;#34;c&amp;#34;; String d = a.intern(); String e = b.intern(); System.out.println(a == b); // false System.out.println(a == c); // true System.out.println(a == d); // true System.out.println(d == e); // true 字面量创建对象 new关键字创建对象 String.intern() 当调用 intern 方法时，如果池中已经包含一个等于该String对象的字符串，由equals(Object)方法确定，则返回池中的字符串。否则，将此String对象添加到池中并返回对该String对象的引用。
最近在阅读Spring AOP的源码(基于Spring 5.2.8.RELEASE)中，发现@EnableAspectJAutoProxy注解中的proxyTargetClass参数并不如注释（是否创建基于子类的CGLIB代理）中说所的哪样生效。无论我设置成true/false都会使用CGLIB代理。
" />
<meta name="keywords" content="" />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://leejay.top/post/knowledge/" />




<link rel="stylesheet" href="https://leejay.top/assets/style.css">






<link rel="apple-touch-icon" href="https://leejay.top/img/favicon.png">

  <link rel="shortcut icon" href="https://leejay.top/img/favicon.png">



<meta name="twitter:card" content="summary" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Java中的小知识点">
<meta property="og:description" content="Java中一些零散，容易混淆的小知识点。" />
<meta property="og:url" content="https://leejay.top/post/knowledge/" />
<meta property="og:site_name" content="Keep Improving" />

  
    <meta property="og:image" content="https://leejay.top/img/favicon.png">
  

<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">

  <meta property="article:section" content="Java" />


  <meta property="article:published_time" content="2022-05-12 17:55:10 &#43;0800 &#43;0800" />










<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fira+Code">

</head>
<body class="orange">


<div class="container center headings--one-size">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="https://leejay.top">
  <div class="logo">
    HelloWorld
  </div>
</a>

    </div>
    
  </div>
  
  
  <script type="text/javascript"
        async
        src="https://cdn.bootcss.com/mathjax/2.7.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\[\[','\]\]']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
});

MathJax.Hub.Queue(function() {
    
    
    
    var all = MathJax.Hub.getAllJax(), i;
    for(i = 0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
});
</script>

<style>
code.has-jax {
    font: inherit;
    font-size: 100%;
    background: inherit;
    border: inherit;
    color: #515151;
}
</style>

</header>


  <div class="content">
    
<div class="post">
  
  
    









<div class="toc" id="toc_id">

    <div class="page-header"><strong> ↓ 目录 ↓ </strong></div>

    <div id="page-scrollspy" class="toc-nav">

        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#1-java%e6%98%af%e5%80%bc%e4%bc%a0%e9%80%92%e8%bf%98%e6%98%af%e5%bc%95%e7%94%a8%e4%bc%a0%e9%80%92">
                    1. Java是值传递还是引用传递
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#2-%e5%8c%85%e8%a3%85%e7%b1%bbinteger%e4%b8%ad%e7%9a%84%e7%bc%93%e5%ad%98%e6%b1%a0">
                    2. 包装类Integer中的缓存池
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#3-%e5%a4%9a%e5%b1%82%e5%b5%8c%e5%a5%97%e5%be%aa%e7%8e%af%e8%b7%b3%e5%87%ba%e9%97%ae%e9%a2%98">
                    3. 多层嵌套循环跳出问题
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#4-string%e5%af%b9%e8%b1%a1%e7%9a%84%e5%88%9b%e5%bb%ba">
                    4. String对象的创建
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e5%ad%97%e9%9d%a2%e9%87%8f%e5%88%9b%e5%bb%ba%e5%af%b9%e8%b1%a1">
                    字面量创建对象
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#new%e5%85%b3%e9%94%ae%e5%ad%97%e5%88%9b%e5%bb%ba%e5%af%b9%e8%b1%a1">
                    new关键字创建对象
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#stringintern">
                    String.intern()
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e8%87%aa%e5%ae%9a%e4%b9%89%e9%85%8d%e7%bd%ae%e4%bb%a3%e7%a0%81">
                    自定义配置代码
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#5-enableaspectjautoproxy%e7%9a%84%e7%96%91%e9%97%ae">
                    5. @EnableAspectJAutoProxy的疑问
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e6%ba%90%e7%a0%81%e8%a7%a3%e6%9e%90">
                    源码解析
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e9%97%ae%e9%a2%98%e7%9a%84%e5%88%87%e5%85%a5%e5%8f%a3">
                    问题的切入口
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e9%97%ae%e9%a2%98%e7%9a%84%e6%b7%b1%e5%85%a5">
                    问题的深入
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e9%97%ae%e9%a2%98%e7%bb%a7%e7%bb%ad%e6%b7%b1%e5%85%a5">
                    问题继续深入
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#configuration">
                    @Configuration
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e6%80%bb%e7%bb%93">
                    总结
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        

    </div>

</div>



  
  <h1 class="post-title">
    <a href="https://leejay.top/post/knowledge/">Java中的小知识点</a></h1>
  <div class="post-meta">
    
      <span class="post-date">
        2022-05-12 
      </span>
    
    
  </div>

  
  <span class="post-tags">
    
    #<a href="https://leejay.top/tags/java-/">Java </a>&nbsp;
    
  </span>
  

  

  

  <div class="post-content"><div>
        <h2 id="1-java是值传递还是引用传递">1. Java是值传递还是引用传递<a href="#1-java是值传递还是引用传递" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>结论： Java只有值传递没有引用传递。</p>
<p>值传递与引用传递的区别：<code>对形参的修改不会影响到实参被称为值传递。引用传递则相反。</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">change</span><span style="color:#f92672">(</span>Integer i<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    i <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">change</span><span style="color:#f92672">(</span>Person person<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    person<span style="color:#f92672">.</span><span style="color:#a6e22e">name</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;李四&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">..</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    Integer x <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    change<span style="color:#f92672">(</span>x<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>	System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>x<span style="color:#f92672">);</span> <span style="color:#75715e">// x = 1;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    
</span></span><span style="display:flex;"><span>	Person person <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Person<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;张三&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    change<span style="color:#f92672">(</span>person<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>person<span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">());</span> <span style="color:#75715e">// &#34;李四&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<ol>
<li>如果是基本数据类型，是将数据复制一份传递给方法，自然不会影响。</li>
<li>如果是对象做参数时，将堆中对象的引用复制一份传递给方法，<code>引用的地址不会被修改（也是被称为值传递的根本原因</code>)，但是地址的内容会被函数修改。</li>
</ol>
</blockquote>
<hr>
<h2 id="2-包装类integer中的缓存池">2. 包装类Integer中的缓存池<a href="#2-包装类integer中的缓存池" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Integer x <span style="color:#f92672">=</span> <span style="color:#ae81ff">123</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>Integer y <span style="color:#f92672">=</span> <span style="color:#ae81ff">123</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>x <span style="color:#f92672">==</span> y<span style="color:#f92672">);</span> <span style="color:#75715e">// true
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>Integer a <span style="color:#f92672">=</span> <span style="color:#ae81ff">128</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>Integer b <span style="color:#f92672">=</span> <span style="color:#ae81ff">128</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>a <span style="color:#f92672">==</span> b<span style="color:#f92672">);</span> <span style="color:#75715e">// false
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>a<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>b<span style="color:#f92672">));</span> <span style="color:#75715e">// true
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>Integer z <span style="color:#f92672">=</span> Integer<span style="color:#f92672">.</span><span style="color:#a6e22e">valueOf</span><span style="color:#f92672">(</span><span style="color:#ae81ff">123</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>Integer w <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Integer<span style="color:#f92672">(</span><span style="color:#ae81ff">123</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>x <span style="color:#f92672">==</span> z<span style="color:#f92672">);</span> <span style="color:#75715e">// true
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>z <span style="color:#f92672">==</span> w<span style="color:#f92672">);</span> <span style="color:#75715e">// false
</span></span></span></code></pre></div><blockquote>
<ol>
<li>Integer类型的缓存池的范围是<code>[-128, 127]</code>，只要是这个范围的值自动装箱就会返回相同的对象。</li>
<li>Integer类型中的equals()方法是对<code>包装的值</code>进行了比较，而不是比较对象。</li>
<li>valueOf()方法利用了缓存，符合第一条的规则。</li>
<li>如果通过new关键字创建对象，是没用利用缓存，并不符合第一条规则。</li>
</ol>
</blockquote>
<hr>
<h2 id="3-多层嵌套循环跳出问题">3. 多层嵌套循环跳出问题<a href="#3-多层嵌套循环跳出问题" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<blockquote>
<p>c中可以通过goto语句跳出多层嵌套循环，java保留了goto关键字，但没有任何作用。</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span><span style="color:#f92672">[]</span> a <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">int</span><span style="color:#f92672">[]{</span><span style="color:#ae81ff">1</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">};</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span><span style="color:#f92672">[]</span> b <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">int</span><span style="color:#f92672">[]{</span><span style="color:#ae81ff">4</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">5</span><span style="color:#f92672">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        loop_a:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> j <span style="color:#f92672">:</span> a<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> k <span style="color:#f92672">:</span> b<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>k <span style="color:#f92672">==</span> <span style="color:#ae81ff">5</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">break</span> loop_a<span style="color:#f92672">;</span> <span style="color:#75715e">// 跳出最外层循环
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>j <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; -&gt; &#34;</span> <span style="color:#f92672">+</span> k<span style="color:#f92672">);</span> <span style="color:#75715e">// 1 -&gt; 4
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;------------------------&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>        loop_b<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> j <span style="color:#f92672">:</span> a<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> k <span style="color:#f92672">:</span> b<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>k <span style="color:#f92672">==</span> <span style="color:#ae81ff">5</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">continue</span> loop_b<span style="color:#f92672">;</span> <span style="color:#75715e">// 跳过内层循环值为5的，继续从外层的下一个数开始执行
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>j <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; -&gt; &#34;</span> <span style="color:#f92672">+</span> k<span style="color:#f92672">);</span> <span style="color:#75715e">// 1 -&gt; 4; 2 -&gt; 4
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><hr>
<h2 id="4-string对象的创建">4. String对象的创建<a href="#4-string对象的创建" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<blockquote>
<p>字符串常量池（String Common Pool）：因为字符串的大量创建会影响程序的性能，JVM引入了<code>字符串常量池</code>来减少字符串性能的开销（也基于字符串的不可变性才能实现）。</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>String a <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;abc&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>String b <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> String<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;abc&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>String c <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;a&#34;</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;b&#34;</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;c&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>String d <span style="color:#f92672">=</span> a<span style="color:#f92672">.</span><span style="color:#a6e22e">intern</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>String e <span style="color:#f92672">=</span> b<span style="color:#f92672">.</span><span style="color:#a6e22e">intern</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>a <span style="color:#f92672">==</span> b<span style="color:#f92672">);</span> <span style="color:#75715e">//  false
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>a <span style="color:#f92672">==</span> c<span style="color:#f92672">);</span> <span style="color:#75715e">//  true
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>a <span style="color:#f92672">==</span> d<span style="color:#f92672">);</span> <span style="color:#75715e">//  true
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>d <span style="color:#f92672">==</span> e<span style="color:#f92672">);</span> <span style="color:#75715e">//  true
</span></span></span></code></pre></div><h3 id="字面量创建对象">字面量创建对象<a href="#字面量创建对象" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p><img src="https://image.leejay.top/img/String%E5%AD%97%E9%9D%A2%E9%87%8F.png" alt="String字面量"></p>
<h3 id="new关键字创建对象">new关键字创建对象<a href="#new关键字创建对象" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p><img src="https://image.leejay.top/img/image-20220512175258152.png" alt="image-20220512175258152"></p>
<h3 id="stringintern">String.intern()<a href="#stringintern" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<blockquote>
<p>当调用 intern 方法时，如果池中已经包含一个等于该String对象的字符串，<code>由equals(Object)方法确定</code>，则返回池中的字符串。否则，将此String对象添加到池中并返回对该String对象的引用。</p>
</blockquote>
<p><img src="https://image.leejay.top/img/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20220512175811.png" alt="微信截图_20220512175811"></p>
<blockquote>
<p>最近在阅读Spring AOP的源码(基于Spring 5.2.8.RELEASE)中，发现<code>@EnableAspectJAutoProxy</code>注解中的<code>proxyTargetClass</code>参数并不如注释（<code>是否创建基于子类的CGLIB代理</code>）中说所的哪样生效。无论我设置成true/false都会使用CGLIB代理。</p>
</blockquote>
<h3 id="自定义配置代码">自定义配置代码<a href="#自定义配置代码" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Configuration</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@EnableAspectJAutoProxy</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@ComponentScan</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;org.springframework.chapter13&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AopConfiguration</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Test</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        AnnotationConfigApplicationContext ctx <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> AnnotationConfigApplicationContext<span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>                AopConfiguration<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// ....
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><hr>
<h2 id="5-enableaspectjautoproxy的疑问">5. @EnableAspectJAutoProxy的疑问<a href="#5-enableaspectjautoproxy的疑问" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<h3 id="源码解析">源码解析<a href="#源码解析" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<h4 id="问题的切入口">问题的切入口<a href="#问题的切入口" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p>我们知道Spring AOP是基于后置处理器实现对Bean的代理对象的创建，其核心类就是<code>AbstractAutoProxyCreator</code>。所以我们尝试从AOP核心类进行问题的解析。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AbstractAutoProxyCreator</span> <span style="color:#66d9ef">extends</span> ProxyProcessorSupport
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">implements</span> SmartInstantiationAwareBeanPostProcessor<span style="color:#f92672">,</span> BeanFactoryAware <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">public</span> Object <span style="color:#a6e22e">postProcessAfterInitialization</span><span style="color:#f92672">(</span><span style="color:#a6e22e">@Nullable</span> Object bean<span style="color:#f92672">,</span> String beanName<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 判断bean是否需要被代理
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>bean <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			Object cacheKey <span style="color:#f92672">=</span> getCacheKey<span style="color:#f92672">(</span>bean<span style="color:#f92672">.</span><span style="color:#a6e22e">getClass</span><span style="color:#f92672">(),</span> beanName<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">earlyProxyReferences</span><span style="color:#f92672">.</span><span style="color:#a6e22e">remove</span><span style="color:#f92672">(</span>cacheKey<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> bean<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">return</span> wrapIfNecessary<span style="color:#f92672">(</span>bean<span style="color:#f92672">,</span> beanName<span style="color:#f92672">,</span> cacheKey<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> bean<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// wrapIfNecessary中会调用此方法创建代理对象
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">protected</span> Object <span style="color:#a6e22e">createProxy</span><span style="color:#f92672">(</span>Class<span style="color:#f92672">&lt;?&gt;</span> beanClass<span style="color:#f92672">,</span> <span style="color:#a6e22e">@Nullable</span> String beanName<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">@Nullable</span> Object<span style="color:#f92672">[]</span> specificInterceptors<span style="color:#f92672">,</span> TargetSource targetSource<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 省略不相关代码
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// AOP核心判断逻辑
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// 上文我们没有设置proxyTargetClass，所以默认是false
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>proxyFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">isProxyTargetClass</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 问题的核心入口！！！
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#75715e">// 判断是否需要代理
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>shouldProxyTargetClass<span style="color:#f92672">(</span>beanClass<span style="color:#f92672">,</span> beanName<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 设置proxyTargetClass属性为true，用于走cglib代理
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				proxyFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">setProxyTargetClass</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 否则走jdk代理的校验逻辑
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				evaluateProxyInterfaces<span style="color:#f92672">(</span>beanClass<span style="color:#f92672">,</span> proxyFactory<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 省略无关代码
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// 调用代理工厂创建代理
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">return</span> proxyFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">getProxy</span><span style="color:#f92672">(</span>getProxyClassLoader<span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">evaluateProxyInterfaces</span><span style="color:#f92672">(</span>Class<span style="color:#f92672">&lt;?&gt;</span> beanClass<span style="color:#f92672">,</span> ProxyFactory proxyFactory<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 查找目标对象的所有实现接口，并筛选合适的代理接口
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		Class<span style="color:#f92672">&lt;?&gt;[]</span> targetInterfaces <span style="color:#f92672">=</span> ClassUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">getAllInterfacesForClass</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>            					beanClass<span style="color:#f92672">,</span> getProxyClassLoader<span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">boolean</span> hasReasonableProxyInterface <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Class<span style="color:#f92672">&lt;?&gt;</span> ifc <span style="color:#f92672">:</span> targetInterfaces<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>isConfigurationCallbackInterface<span style="color:#f92672">(</span>ifc<span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>isInternalLanguageInterface<span style="color:#f92672">(</span>ifc<span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>					ifc<span style="color:#f92672">.</span><span style="color:#a6e22e">getMethods</span><span style="color:#f92672">().</span><span style="color:#a6e22e">length</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>				hasReasonableProxyInterface <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>hasReasonableProxyInterface<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 设置proxyFactory的interface属性，用于实现jdk代理
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Class<span style="color:#f92672">&lt;?&gt;</span> ifc <span style="color:#f92672">:</span> targetInterfaces<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>				proxyFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">addInterface</span><span style="color:#f92672">(</span>ifc<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 如果当前被代理的目标对象不是基于接口的，那么还是会设置proxyTargetClass=true走CGLIB代理
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			proxyFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">setProxyTargetClass</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<p>从上面的代码切入，我们知道：</p>
<ol>
<li>因为<code>shouldProxyTargetClass</code>返回了true，所以设置了<code>proxyTargetClass=true</code>，从而走了CGLIB代理。</li>
<li>即使<code>shouldProxyTargetClass</code>返回false，走到了<code>evaluateProxyInterfaces</code>中，也需要找到适合的代理接口（JDK代理基于接口），否则还是会设置<code>proxyTargetClass=true</code>。</li>
</ol>
<p>但我产生了一个疑惑：这个<code>shouldProxyTargetClass()</code>是做什么的，为什么在没有设置<code>proxyTargetClass=true</code>前提下返回了true来走CGLIB代理？</p>
</blockquote>
<h4 id="问题的深入">问题的深入<a href="#问题的深入" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p>书接上文，针对上面的问题，我们继续阅读相关源码。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AbstractAutoProxyCreator</span> <span style="color:#66d9ef">extends</span> ProxyProcessorSupport
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">implements</span> SmartInstantiationAwareBeanPostProcessor<span style="color:#f92672">,</span> BeanFactoryAware <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">shouldProxyTargetClass</span><span style="color:#f92672">(</span>Class<span style="color:#f92672">&lt;?&gt;</span> beanClass<span style="color:#f92672">,</span> <span style="color:#a6e22e">@Nullable</span> String beanName<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 我们是基于AnnotationConfigApplicationContext创建的上下文，默认是其父类         
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// GenericApplicationContext创建了DefaultListableBeanFactory类
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// 而前者是ConfigurableListableBeanFactory的默认实现，所以第一个是true
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">beanFactory</span> <span style="color:#66d9ef">instanceof</span> ConfigurableListableBeanFactory <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>				AutoProxyUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">shouldProxyTargetClass</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">(</span>ConfigurableListableBeanFactory<span style="color:#f92672">)</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">beanFactory</span><span style="color:#f92672">,</span> beanName<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>    
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AutoProxyUtils</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String PRESERVE_TARGET_CLASS_ATTRIBUTE <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>			Conventions<span style="color:#f92672">.</span><span style="color:#a6e22e">getQualifiedAttributeName</span><span style="color:#f92672">(</span>AutoProxyUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;preserveTargetClass&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">shouldProxyTargetClass</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>			ConfigurableListableBeanFactory beanFactory<span style="color:#f92672">,</span> <span style="color:#a6e22e">@Nullable</span> String beanName<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// isNull判断 &amp; 容器中是否包含当前bean
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>beanName <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> beanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">containsBeanDefinition</span><span style="color:#f92672">(</span>beanName<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 如果包含，那么获取BeanDefinition判断是否包含PRESERVE_TARGET_CLASS_ATTRIBUTE属性
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			BeanDefinition bd <span style="color:#f92672">=</span> beanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">getBeanDefinition</span><span style="color:#f92672">(</span>beanName<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> Boolean<span style="color:#f92672">.</span><span style="color:#a6e22e">TRUE</span><span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>bd<span style="color:#f92672">.</span><span style="color:#a6e22e">getAttribute</span><span style="color:#f92672">(</span>PRESERVE_TARGET_CLASS_ATTRIBUTE<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<p>阅读完上述代码，我们可以了解到为什么<code>shouldProxyTargetClass()</code>返回了<code>true</code>，因为当前的BeanDefinition中包含了<code>PRESERVE_TARGET_CLASS_ATTRIBUTE</code>属性。那么：这个属性是什么时候设置的呢？</p>
</blockquote>
<h4 id="问题继续深入">问题继续深入<a href="#问题继续深入" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p>借助IDEA我们可以知道Spring在<code>ConfigurationClassPostProcessor.enhanceConfigurationClasses()方法</code>中设置了<code>PRESERVE_TARGET_CLASS_ATTRIBUTE</code>属性。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// 解析配置类注解的核心后置处理器，启动时注入到容器中
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ConfigurationClassPostProcessor</span> <span style="color:#66d9ef">implements</span> BeanDefinitionRegistryPostProcessor<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>		PriorityOrdered<span style="color:#f92672">,</span> ResourceLoaderAware<span style="color:#f92672">,</span> BeanClassLoaderAware<span style="color:#f92672">,</span> EnvironmentAware <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                   
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">postProcessBeanDefinitionRegistry</span><span style="color:#f92672">(</span>BeanDefinitionRegistry registry<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 省略无关代码
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// 最终调用了ConfigurationClassUtils.checkConfigurationClassCandidate设置了		
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// CONFIGURATION_CLASS_ATTRIBUTE属性
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		processConfigBeanDefinitions<span style="color:#f92672">(</span>registry<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">enhanceConfigurationClasses</span><span style="color:#f92672">(</span>ConfigurableListableBeanFactory beanFactory<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 核心 如果当前类被具有full属性，那么最终会添加PRESERVE_TARGET_CLASS_ATTRIBUTE属性
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// 核心，在BeanDefinition通过registry注册的时候会设置参数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// 最终调用ConfigurationClassUtils.checkConfigurationClassCandidate中设置
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ConfigurationClassUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">CONFIGURATION_CLASS_FULL</span><span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>configClassAttr<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 省略无关代码
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#75715e">// 添加成员到configBeanDefs中
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			configBeanDefs<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>beanName<span style="color:#f92672">,</span> <span style="color:#f92672">(</span>AbstractBeanDefinition<span style="color:#f92672">)</span> beanDef<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    	<span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Map<span style="color:#f92672">.</span><span style="color:#a6e22e">Entry</span><span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> AbstractBeanDefinition<span style="color:#f92672">&gt;</span> entry <span style="color:#f92672">:</span> configBeanDefs<span style="color:#f92672">.</span><span style="color:#a6e22e">entrySet</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 如果@Configuration的proxyBeanMethods=true那么会被设置PRESERVE_TARGET_CLASS_ATTRIBUTE
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			beanDef<span style="color:#f92672">.</span><span style="color:#a6e22e">setAttribute</span><span style="color:#f92672">(</span>AutoProxyUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">PRESERVE_TARGET_CLASS_ATTRIBUTE</span><span style="color:#f92672">,</span> Boolean<span style="color:#f92672">.</span><span style="color:#a6e22e">TRUE</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 设置Bean增强时被回调的操作
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            Class<span style="color:#f92672">&lt;?&gt;</span> enhancedClass <span style="color:#f92672">=</span> enhancer<span style="color:#f92672">.</span><span style="color:#a6e22e">enhance</span><span style="color:#f92672">(</span>configClass<span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">beanClassLoader</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 省略无关代码
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ConfigurationClassUtils</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">checkConfigurationClassCandidate</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>			BeanDefinition beanDef<span style="color:#f92672">,</span> MetadataReaderFactory metadataReaderFactory<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    	<span style="color:#75715e">// 省略无关代码
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// 获取配置类上@Configuration中的参数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> Object<span style="color:#f92672">&gt;</span> config <span style="color:#f92672">=</span> metadata<span style="color:#f92672">.</span><span style="color:#a6e22e">getAnnotationAttributes</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>            										Configuration<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 如果proxyBeanMethods=true，那么设置为full（默认）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>config <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>Boolean<span style="color:#f92672">.</span><span style="color:#a6e22e">FALSE</span><span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>config<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;proxyBeanMethods&#34;</span><span style="color:#f92672">)))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			beanDef<span style="color:#f92672">.</span><span style="color:#a6e22e">setAttribute</span><span style="color:#f92672">(</span>CONFIGURATION_CLASS_ATTRIBUTE<span style="color:#f92672">,</span> CONFIGURATION_CLASS_FULL<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 否则设置为lite
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>config <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> isConfigurationCandidate<span style="color:#f92672">(</span>metadata<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			beanDef<span style="color:#f92672">.</span><span style="color:#a6e22e">setAttribute</span><span style="color:#f92672">(</span>CONFIGURATION_CLASS_ATTRIBUTE<span style="color:#f92672">,</span> CONFIGURATION_CLASS_LITE<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ConfigurationClassEnhancer</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// CGLIB callback回调的逻辑
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> Callback<span style="color:#f92672">[]</span> CALLBACKS <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Callback<span style="color:#f92672">[]</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">new</span> BeanMethodInterceptor<span style="color:#f92672">(),</span> <span style="color:#75715e">// 拦截@Bean注解的核心类
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#66d9ef">new</span> BeanFactoryAwareMethodInterceptor<span style="color:#f92672">(),</span>
</span></span><span style="display:flex;"><span>			NoOp<span style="color:#f92672">.</span><span style="color:#a6e22e">INSTANCE</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">};</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> ConditionalCallbackFilter CALLBACK_FILTER <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span>        									<span style="color:#66d9ef">new</span> ConditionalCallbackFilter<span style="color:#f92672">(</span>CALLBACKS<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Class<span style="color:#f92672">&lt;?&gt;</span> enhance<span style="color:#f92672">(</span>Class<span style="color:#f92672">&lt;?&gt;</span> configClass<span style="color:#f92672">,</span> <span style="color:#a6e22e">@Nullable</span> ClassLoader classLoader<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>EnhancedConfiguration<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">.</span><span style="color:#a6e22e">isAssignableFrom</span><span style="color:#f92672">(</span>configClass<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> configClass<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 基于CGLIB创建增强代理类
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		Class<span style="color:#f92672">&lt;?&gt;</span> enhancedClass <span style="color:#f92672">=</span> createClass<span style="color:#f92672">(</span>newEnhancer<span style="color:#f92672">(</span>configClass<span style="color:#f92672">,</span> classLoader<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> enhancedClass<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> Enhancer <span style="color:#a6e22e">newEnhancer</span><span style="color:#f92672">(</span>Class<span style="color:#f92672">&lt;?&gt;</span> configSuperClass<span style="color:#f92672">,</span> <span style="color:#a6e22e">@Nullable</span> ClassLoader classLoader<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		Enhancer enhancer <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Enhancer<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>		enhancer<span style="color:#f92672">.</span><span style="color:#a6e22e">setSuperclass</span><span style="color:#f92672">(</span>configSuperClass<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 配置类会增加对EnhancedConfiguration接口的实现
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		enhancer<span style="color:#f92672">.</span><span style="color:#a6e22e">setInterfaces</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Class<span style="color:#f92672">&lt;?&gt;[]</span> <span style="color:#f92672">{</span>EnhancedConfiguration<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">});</span>
</span></span><span style="display:flex;"><span>		enhancer<span style="color:#f92672">.</span><span style="color:#a6e22e">setUseFactory</span><span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		enhancer<span style="color:#f92672">.</span><span style="color:#a6e22e">setNamingPolicy</span><span style="color:#f92672">(</span>SpringNamingPolicy<span style="color:#f92672">.</span><span style="color:#a6e22e">INSTANCE</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		enhancer<span style="color:#f92672">.</span><span style="color:#a6e22e">setStrategy</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> BeanFactoryAwareGeneratorStrategy<span style="color:#f92672">(</span>classLoader<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>		enhancer<span style="color:#f92672">.</span><span style="color:#a6e22e">setCallbackFilter</span><span style="color:#f92672">(</span>CALLBACK_FILTER<span style="color:#f92672">);</span> <span style="color:#75715e">// 设置CGLIB CALLBACK 核心！
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		enhancer<span style="color:#f92672">.</span><span style="color:#a6e22e">setCallbackTypes</span><span style="color:#f92672">(</span>CALLBACK_FILTER<span style="color:#f92672">.</span><span style="color:#a6e22e">getCallbackTypes</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> enhancer<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<p>通过上述代码的解析，我们可知，因为目标类上的<code>@Configuration(proxyBeanMethods=true)</code>注解，设置了<code>CONFIGURATION_CLASS_FULL</code>属性，继而设置了<code>PRESERVE_TARGET_CLASS_ATTRIBUTE</code>，最终设置了<code>proxyTargetClass=true</code>属性，用于创建CGLIB代理并设置默认的CALLBACK回调（<code>Spring CGLIB代理的通知类都是通过实现MethodInterceptor接口来实现的，CALLBACK中的BeanMethodInterceptor也是实现此接口，在proceed()执行时会被调用</code>）。</p>
<p>我们继续思考：</p>
<p><code>BeanMethonInterceptor</code>是做什么的呢？</p>
<p>为什么<code>@Configuration(proxyBeanMethods=true)修饰的类需要被CGLIB代理进行增强呢？？</code></p>
</blockquote>
<h4 id="configuration">@Configuration<a href="#configuration" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p>经过上面的源码阅读，我们知道解决问题的关键在于@Configuration注解。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Target</span><span style="color:#f92672">(</span>ElementType<span style="color:#f92672">.</span><span style="color:#a6e22e">TYPE</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Retention</span><span style="color:#f92672">(</span>RetentionPolicy<span style="color:#f92672">.</span><span style="color:#a6e22e">RUNTIME</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Documented</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Component</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#a6e22e">@interface</span> Configuration <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">proxyBeanMethods</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">default</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<p>翻译注释可知：</p>
<p>proxyBeanMethods属性是用来指定<code>@Bean注解标注的方法是否使用代理（默认为true）</code>，如果开启代理那么会<code>直接从IOC容器之中取得对象</code>；如果关闭则每次调用@Bean标注的方法获取到的对象则是<code>一个新的对象（与容器中不同）</code>。</p>
</blockquote>
<p>我们还是写个demo测试下把：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Configuration</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SchoolConfiguration</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Teacher <span style="color:#a6e22e">teacher</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> Teacher<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Student <span style="color:#a6e22e">student</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 我们在student方法中调用teacher()
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        teacher<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> Student<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Data</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Teacher</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">Teacher</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;teacher ...&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Data</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Student</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">Student</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;student ...&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>  	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        AnnotationConfigApplicationContext context <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> 
</span></span><span style="display:flex;"><span>            AnnotationConfigApplicationContext<span style="color:#f92672">(</span>SchoolConfiguration<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        SchoolConfiguration<span style="color:#f92672">.</span><span style="color:#a6e22e">Teacher</span> teacher <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span><span style="color:#a6e22e">getBean</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>            							SchoolConfiguration<span style="color:#f92672">.</span><span style="color:#a6e22e">Teacher</span><span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        SchoolConfiguration<span style="color:#f92672">.</span><span style="color:#a6e22e">Student</span> student <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span><span style="color:#a6e22e">getBean</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>            							SchoolConfiguration<span style="color:#f92672">.</span><span style="color:#a6e22e">Student</span><span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 问teacher ...会被调用几次
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<p>默认开启<code>proxyBeanMethods</code>那么会调用一次，如果关闭则会调用两次。</p>
<p>原理：开启<code>proxyBeanMethods</code>会在CGLIB的CALLBACK中设置了<code>BeanMethodInterceptor</code>回调，在@Bean修饰的方法被调用时候通过CGLIB代理进行拦截，从容器中返回@Bean创建的对象，保证了@Bean方法的<code>单例原则</code>。</p>
<p>注意：如果@Bean的方法上加上了<code>@Scope(&quot;prototype&quot;)</code>注解时仍会生效，多次调用会返回多个对象。</p>
</blockquote>
<h3 id="总结">总结<a href="#总结" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<ol>
<li>因为@EnableAspectJAutoProxy的<code>proxyTargetClass</code>属性不生效，从而引出的<code>@Configuration</code>的<code>proxyBeanMethods</code>问题，如果我们需要使用JDK动态代理，那么我们除了设置<code>proxyTargetClass=false</code>、目标对象实现了接口，还需要设置<code>proxyBeanMethods = false</code>或不适用@Configuration注解修饰AOP相关配置类。</li>
<li>即使设置了<code>proxyBeanMethods = true</code>，如果在@Bean修饰的方法上添加了<code>@Scope(&quot;prototype&quot;)</code>，那么方法不会返回容器中的对象，对象会创建多次。</li>
</ol>
      </div></div>

  
  
<div class="pagination">
    <div class="pagination__title">
        <span class="pagination__title-h">其他文章</span>
        <hr />
    </div>
    <div class="pagination__buttons">
        
        <span class="button previous">
            <a href="https://leejay.top/post/elasticsearch/">
                <span class="button__icon">←</span>
                <span class="button__text">Elasticsearch操作文档</span>
            </a>
        </span>
        
        
        <span class="button next">
            <a href="https://leejay.top/post/grpc/">
                <span class="button__text">Grpc快速入门</span>
                <span class="button__icon">→</span>
            </a>
        </span>
        
    </div>
</div>

  

  

</div>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright copyright--user">
        <span><a rel="nofollow" href="https://beian.miit.gov.cn/" target="_blank">苏ICP备18050258号-1</a></span>
    
        
      </div>
  </div>
</footer>

<script src="https://leejay.top/assets/main.js"></script>
<script src="https://leejay.top/assets/prism.js"></script>






  
</div>

</body>
</html>
