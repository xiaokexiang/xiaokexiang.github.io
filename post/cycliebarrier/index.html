<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>CyclieBarrier</title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="description" content="CyclicBarrier åŸºäºCountDownLatchçš„ç‰¹æ€§ï¼šè®¡æ•°å™¨ä¸º0æ—¶ï¼Œå³ä½¿è°ƒç”¨awaitï¼Œè¯¥çº¿ç¨‹ä¹Ÿä¸ä¼šç­‰å¾…å…¶ä»–çº¿ç¨‹æ‰§è¡Œå®Œæ¯•è€Œè¢«é˜»å¡ã€‚
CyclicBarrierçš„å‡ºç°æ˜¯ä¸ºäº†è§£å†³å¤æ‚åœºæ™¯CountDownLatchä½¿ç”¨çš„åŠ£åŠ¿ã€‚
 CountDownLatchä¸­å­˜åœ¨ä¸¤ç§ç±»å‹çš„çº¿ç¨‹ï¼šåˆ†åˆ«æ˜¯è°ƒç”¨awaitæ–¹æ³•å’Œè°ƒç”¨countDownæ–¹æ³•çš„çº¿ç¨‹ã€‚
è€ŒCyclicBarrierä¸­åªå­˜åœ¨ä¸€ç§çº¿ç¨‹ï¼šè°ƒç”¨awaitçš„çº¿ç¨‹æ‰®æ¼”äº†ä¸Šè¿°ä¸¤ç§è§’è‰²ï¼Œå³å…ˆcountDownåawaitã€‚
 CyclicBarrieræ‹†åˆ†æˆä¸¤éƒ¨åˆ†æ¥ç†è§£ï¼š
 Cyclicï¼ˆå›ç¯ï¼‰ï¼šå½“æ‰€æœ‰ç­‰å¾…çº¿ç¨‹æ‰§è¡Œå®Œæ¯•åï¼Œä¼šé‡ç½®çŠ¶æ€ï¼Œä½¿å…¶èƒ½å¤Ÿé‡ç”¨ã€‚ Barrierï¼ˆå±éšœï¼‰ï¼šçº¿ç¨‹è°ƒç”¨awaitæ–¹æ³•å°±ä¼šé˜»å¡ï¼Œè¿™ä¸ªé˜»å¡ç‚¹å°±æ˜¯å±éšœç‚¹ï¼Œç­‰åˆ°æ‰€æœ‰çº¿ç¨‹è°ƒç”¨awaitæ–¹æ³•åï¼Œçº¿ç¨‹å°±ä¼šç©¿è¿‡å±éšœç»§ç»­å¾€ä¸‹æ‰§è¡Œã€‚   ç›¸æ¯”CountDownLatchåªä½¿ç”¨ä¸€æ¬¡ï¼ŒCyclicBarrieræ›´å¼ºè°ƒå¾ªç¯ä½¿ç”¨ã€‚
 @Slf4j public class CyclicBarrierTest { // ä¼ å…¥æ¯æ¬¡å±éšœä¹‹å‰éœ€è¦ç­‰å¾…çš„çº¿ç¨‹æ•°é‡  private static final CyclicBarrier BARRIER = new CyclicBarrier(2, () -&amp;gt; { // ä¸èƒ½ä¿è¯æ¯ä»£æ‰§è¡Œè¯¥è¯­å¥çš„éƒ½æ˜¯åŒä¸€ä¸ªçº¿ç¨‹  log.info(&amp;#34;doSomenthing before the last thread signal other threads&amp;#34;) }); private static final ExecutorService EXECUTOR = Executors.newFixedThreadPool(2); public static void main(String[] args) { EXECUTOR.execute(() -&amp;gt; { try { //CyclicBarrier ä¿è¯await  log.info(&amp;#34;doSomething ... &amp;#34;); BARRIER."/>
<meta name="keywords" content=""/>
<meta name="robots" content="noodp"/>
<meta name="google-site-verification" content="e1ELBPEvOV5kwQNtzaLcNt-3iZy83eiNhSZkHhQPecs" />
<meta name="baidu-site-verification" content="aNoX6MUEHW" />
<link rel="canonical" href="https://www.leejay.top/post/cycliebarrier/" />

<script type="text/javascript"
        async
        src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"
        >
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\[\[','\]\]']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] },
    'HTML-CSS': {
        showMathMenu: false 
    }
  }
});

MathJax.Hub.Queue(function() {
    
    
    
    var all = MathJax.Hub.getAllJax(), i;
    for(i = 0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
});
</script>

<style>
code.has-jax {
    font: inherit;
    font-size: 100%;
    background: inherit;
    border: inherit;
    color: #515151;
}
</style>




<link rel="stylesheet" href="https://www.leejay.top/assets/style.css">




<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://www.leejay.top/img/apple-touch-icon-144-precomposed.png">
<link rel="shortcut icon" href="https://www.leejay.top/img/favicon.png">



<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="CyclieBarrier"/>
<meta name="twitter:description" content="åŸºäº`CountDownLatch`çš„ç‰¹æ€§ï¼š`è®¡æ•°å™¨ä¸º0æ—¶ï¼Œå³ä½¿è°ƒç”¨awaitï¼Œè¯¥çº¿ç¨‹ä¹Ÿä¸ä¼šç­‰å¾…å…¶ä»–çº¿ç¨‹æ‰§è¡Œå®Œæ¯•è€Œè¢«é˜»å¡ã€‚CyclicBarrier`çš„å‡ºç°æ˜¯ä¸ºäº†è§£å†³å¤æ‚åœºæ™¯`CountDownLatch`ä½¿ç”¨çš„åŠ£åŠ¿ã€‚"/>



<meta property="og:title" content="CyclieBarrier" />
<meta property="og:description" content="åŸºäº`CountDownLatch`çš„ç‰¹æ€§ï¼š`è®¡æ•°å™¨ä¸º0æ—¶ï¼Œå³ä½¿è°ƒç”¨awaitï¼Œè¯¥çº¿ç¨‹ä¹Ÿä¸ä¼šç­‰å¾…å…¶ä»–çº¿ç¨‹æ‰§è¡Œå®Œæ¯•è€Œè¢«é˜»å¡ã€‚CyclicBarrier`çš„å‡ºç°æ˜¯ä¸ºäº†è§£å†³å¤æ‚åœºæ™¯`CountDownLatch`ä½¿ç”¨çš„åŠ£åŠ¿ã€‚" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.leejay.top/post/cycliebarrier/" />
<meta property="article:published_time" content="2020-06-29T13:27:36+08:00" />
<meta property="article:modified_time" content="2020-06-29T13:27:36+08:00" /><meta property="og:site_name" content="Aurora" />






  </head>
  <body class="">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a href="https://www.leejay.top" class="logo" style="text-decoration: none;">
  
    <span class="logo__mark"><svg xmlns="https://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367"/>
</svg></span>
    <span class="logo__text">Aurora</span>
    <span class="logo__cursor"></span>
    <span class="logo__cursor2"></span>
  
</a>
    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/categories">Categories</a></li>
        
      
        
          <li><a href="/tags">Tags</a></li>
        
      
      
    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/categories">Categories</a></li>
      
    
      
        <li><a href="/tags">Tags</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none"/>
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="https://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>
      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  
  

  <div class="post">
    <h1 class="post-title"><a href="https://www.leejay.top/post/cycliebarrier/">CyclieBarrier</a></h1>
    <div class="post-meta">
      
        <span class="post-date">
          2020-06-29
        </span>

        
          
        
      

      
      
    </div>

    
      <span class="post-tags">
        
        ğŸ–<a href="https://www.leejay.top/tags/cyclicbarrier/">CyclicBarrier </a>&nbsp;
        
        ğŸ–<a href="https://www.leejay.top/tags/aqs/">AQS</a>&nbsp;
        
      </span>
    

    

    <div class="post-content">
      
      <h3 id="cyclicbarrier">CyclicBarrier</h3>
<p>åŸºäº<code>CountDownLatch</code>çš„ç‰¹æ€§ï¼š<code>è®¡æ•°å™¨ä¸º0æ—¶ï¼Œå³ä½¿è°ƒç”¨awaitï¼Œè¯¥çº¿ç¨‹ä¹Ÿä¸ä¼šç­‰å¾…å…¶ä»–çº¿ç¨‹æ‰§è¡Œå®Œæ¯•è€Œè¢«é˜»å¡</code>ã€‚</p>
<p><code>CyclicBarrier</code>çš„å‡ºç°æ˜¯ä¸ºäº†è§£å†³å¤æ‚åœºæ™¯<code>CountDownLatch</code>ä½¿ç”¨çš„åŠ£åŠ¿ã€‚</p>
<blockquote>
<p>CountDownLatchä¸­å­˜åœ¨ä¸¤ç§ç±»å‹çš„çº¿ç¨‹ï¼šåˆ†åˆ«æ˜¯<code>è°ƒç”¨awaitæ–¹æ³•å’Œè°ƒç”¨countDownæ–¹æ³•çš„çº¿ç¨‹</code>ã€‚</p>
<p>è€ŒCyclicBarrierä¸­åªå­˜åœ¨ä¸€ç§çº¿ç¨‹ï¼š<code>è°ƒç”¨awaitçš„çº¿ç¨‹æ‰®æ¼”äº†ä¸Šè¿°ä¸¤ç§è§’è‰²ï¼Œå³å…ˆcountDownåawait</code>ã€‚</p>
</blockquote>
<p><code>CyclicBarrier</code>æ‹†åˆ†æˆä¸¤éƒ¨åˆ†æ¥ç†è§£ï¼š</p>
<ul>
<li>Cyclicï¼ˆå›ç¯ï¼‰ï¼šå½“æ‰€æœ‰ç­‰å¾…çº¿ç¨‹æ‰§è¡Œå®Œæ¯•åï¼Œä¼šé‡ç½®çŠ¶æ€ï¼Œä½¿å…¶èƒ½å¤Ÿé‡ç”¨ã€‚</li>
<li>Barrierï¼ˆå±éšœï¼‰ï¼šçº¿ç¨‹è°ƒç”¨awaitæ–¹æ³•å°±ä¼šé˜»å¡ï¼Œè¿™ä¸ªé˜»å¡ç‚¹å°±æ˜¯<code>å±éšœç‚¹</code>ï¼Œç­‰åˆ°<code>æ‰€æœ‰çº¿ç¨‹è°ƒç”¨awaitæ–¹æ³•</code>åï¼Œçº¿ç¨‹å°±ä¼šç©¿è¿‡å±éšœç»§ç»­å¾€ä¸‹æ‰§è¡Œã€‚</li>
</ul>
<blockquote>
<p>ç›¸æ¯”<code>CountDownLatch</code>åªä½¿ç”¨ä¸€æ¬¡ï¼Œ<code>CyclicBarrier</code>æ›´å¼ºè°ƒå¾ªç¯ä½¿ç”¨ã€‚</p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Slf4j</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CyclicBarrierTest</span> <span style="color:#f92672">{</span>

    <span style="color:#75715e">// ä¼ å…¥æ¯æ¬¡å±éšœä¹‹å‰éœ€è¦ç­‰å¾…çš„çº¿ç¨‹æ•°é‡
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> CyclicBarrier BARRIER <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> CyclicBarrier<span style="color:#f92672">(</span>2<span style="color:#f92672">,</span> <span style="color:#f92672">()</span> <span style="color:#f92672">-&gt;</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// ä¸èƒ½ä¿è¯æ¯ä»£æ‰§è¡Œè¯¥è¯­å¥çš„éƒ½æ˜¯åŒä¸€ä¸ªçº¿ç¨‹
</span><span style="color:#75715e"></span>        log<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;doSomenthing before the last thread signal other threads&#34;</span><span style="color:#f92672">)</span>
    <span style="color:#f92672">});</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> ExecutorService EXECUTOR <span style="color:#f92672">=</span> Executors<span style="color:#f92672">.</span><span style="color:#a6e22e">newFixedThreadPool</span><span style="color:#f92672">(</span>2<span style="color:#f92672">);</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        EXECUTOR<span style="color:#f92672">.</span><span style="color:#a6e22e">execute</span><span style="color:#f92672">(()</span> <span style="color:#f92672">-&gt;</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">//CyclicBarrier ä¿è¯await
</span><span style="color:#75715e"></span>                log<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;doSomething ... &#34;</span><span style="color:#f92672">);</span>
                BARRIER<span style="color:#f92672">.</span><span style="color:#a6e22e">await</span><span style="color:#f92672">();</span>
                log<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;continue exec ...&#34;</span><span style="color:#f92672">);</span>
                BARRIER<span style="color:#f92672">.</span><span style="color:#a6e22e">await</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">});</span>
        EXECUTOR<span style="color:#f92672">.</span><span style="color:#a6e22e">execute</span><span style="color:#f92672">(()</span> <span style="color:#f92672">-&gt;</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                log<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;doSomething ... &#34;</span><span style="color:#f92672">);</span>
                BARRIER<span style="color:#f92672">.</span><span style="color:#a6e22e">await</span><span style="color:#f92672">();</span>
                log<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;continue exec ...&#34;</span><span style="color:#f92672">);</span>
                <span style="color:#75715e">// å¦‚æœä¸­æ–­çº¿ç¨‹ï¼Œé‚£ä¹ˆä¼šæŠ›å‡ºå¼‚å¸¸
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// Thread.currentThread().interrupt();
</span><span style="color:#75715e"></span>                BARRIER<span style="color:#f92672">.</span><span style="color:#a6e22e">await</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">});</span>
        EXECUTOR<span style="color:#f92672">.</span><span style="color:#a6e22e">shutdown</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
<span style="color:#75715e">// doSomething
</span><span style="color:#75715e">// doSomething
</span><span style="color:#75715e">// continue exec
</span><span style="color:#75715e">// continue exec
</span></code></pre></div><blockquote>
<p>ä¸ºä»€ä¹ˆç»“æœä¸æ˜¯éšæœºæ‰“å°æ—¥å¿—ï¼Œè€Œæ˜¯å…ˆæ‰“å°å®Œ<code>doSomething</code>ï¼Œå†æ‰“å°<code>continue exec</code>?</p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// ä½¿ç”¨ReentrantLockå’ŒCondition
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> ReentrantLock lock <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ReentrantLock<span style="color:#f92672">();</span>
<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> Condition trip <span style="color:#f92672">=</span> lock<span style="color:#f92672">.</span><span style="color:#a6e22e">newCondition</span><span style="color:#f92672">();</span>

<span style="color:#75715e">// æ³¨æ„è¿™é‡Œæ˜¯finalä¿®é¥°ï¼Œä»£è¡¨çº¿ç¨‹æ€»æ•°ï¼Œå½“count=0æ—¶é‡ç½®ä½¿ç”¨
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> parties<span style="color:#f92672">;</span>
<span style="color:#75715e">// è¡¨æ˜è¿˜éœ€è¦å¤šå°‘ä¸ªçº¿ç¨‹åˆ°è¾¾å±éšœ
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> count<span style="color:#f92672">;</span>

<span style="color:#75715e">// è¡¨æ˜æ¯ä¸€ä»£çº¿ç¨‹é€šè¿‡å±éšœä¹‹å‰éœ€è¦å®Œæˆçš„äº‹æƒ…ï¼ˆå¹¶ä¸æ˜¯é€šè¿‡æ–°èµ·çº¿ç¨‹æ¥å®ç°ï¼‰
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> Runnable barrierCommand<span style="color:#f92672">;</span>
<span style="color:#75715e">// æ¯ä¸€ç»„ä¸€èµ·é€šè¿‡å±éšœçš„çº¿ç¨‹å«åšä¸€ä»£Generationï¼Œä¸åŒä»£ä¹‹é—´é€šè¿‡==æ¯”è¾ƒ
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> Generation generation <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Generation<span style="color:#f92672">();</span>

<span style="color:#66d9ef">public</span> <span style="color:#a6e22e">CyclicBarrier</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> parties<span style="color:#f92672">,</span> Runnable barrierAction<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// pariesçš„å€¼å¿…é¡»å¤§äº0
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>parties <span style="color:#f92672">&lt;=</span> 0<span style="color:#f92672">)</span> <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> IllegalArgumentException<span style="color:#f92672">();</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">parties</span> <span style="color:#f92672">=</span> parties<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">count</span> <span style="color:#f92672">=</span> parties<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">barrierCommand</span> <span style="color:#f92672">=</span> barrierAction<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e">// Generationåªæœ‰ä¸€ä¸ªå±æ€§ï¼šbroken
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Generation</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// false è¡¨æ˜çº¿ç¨‹æ˜¯å…¨éƒ¨åˆ°è¾¾åä¸€èµ·ç©¿è¿‡å±éšœ
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// trueè¡¨æ˜çº¿ç¨‹æ²¡æœ‰å…¨éƒ¨åˆ°è¾¾å‰ï¼Œå°±æœ‰çº¿ç¨‹ç©¿è¿‡å±éšœäº†
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// çº¿ç¨‹ç›‘æµ‹åˆ°ä¼šæŠ›å‡ºBrokenBarrierException
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">boolean</span> broken <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<ol>
<li><code>CyclicBarrier</code>çš„éœ€è¦å€ŸåŠ©<code>Condition</code>æ¥å®ç°ï¼Œæ‰§è¡Œ<code>awaitçš„çº¿ç¨‹</code>éœ€è¦åŠ å…¥æ¡ä»¶é˜Ÿåˆ—ç­‰å¾…å”¤é†’ã€‚</li>
<li><code>parties</code>æ˜¯finalä¿®é¥°çš„å˜é‡ï¼Œä½œç”¨äºcount = 0æ—¶çš„<code>é‡æ–°å¤ä½è®¡æ•°å™¨</code>ã€‚</li>
<li><code>Generation</code>è¡¨ç¤ºä¸€ç»„ä¸€èµ·é€šè¿‡å±éšœçš„çº¿ç¨‹ï¼Œä¸åŒä»£ä¹‹é—´é€šè¿‡<code>==</code>æ¥æ¯”è¾ƒã€‚</li>
<li><code>barrierCommand</code>ç”¨äºæ¯ä»£çº¿ç¨‹é€šè¿‡å±éšœä¹‹å‰éœ€è¦å®Œæˆçš„äº‹æƒ…ï¼ˆä¸ä¼šå¦èµ·çº¿ç¨‹æ‰§è¡Œï¼‰ã€‚</li>
<li>æ¯ä»£éƒ½åŒ…å«ä¸€å®š<code>parties</code>çš„çº¿ç¨‹ï¼Œé€šè¿‡å±æ€§<code>broken = true</code>æ¥è¡¨æ˜å½“ä»£çº¿ç¨‹å…¨éƒ¨ä½œåºŸã€‚</li>
</ol>
</blockquote>
<h3 id="nextgeneration">nextGeneration</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">nextGeneration</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// å”¤é†’ä¸Šä¸€ä»£çš„çº¿ç¨‹ï¼ˆè¡¨æ˜æ­¤æ—¶æ˜¯æœ‰é”çš„ï¼‰
</span><span style="color:#75715e"></span>    trip<span style="color:#f92672">.</span><span style="color:#a6e22e">signalAll</span><span style="color:#f92672">();</span>
    <span style="color:#75715e">// å°†counté‡ç½®ä¸ºparties
</span><span style="color:#75715e"></span>    count <span style="color:#f92672">=</span> parties<span style="color:#f92672">;</span>
    <span style="color:#75715e">// new ç”Ÿæˆæ–°ä¸€ä»£
</span><span style="color:#75715e"></span>    generation <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Generation<span style="color:#f92672">();</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<p>è¯¥æ–¹æ³•çš„ç›®çš„æ˜¯ä¸ºäº†<code>å”¤é†’ä¸Šä¸€ä»£çš„çº¿ç¨‹ï¼Œå¹¶é‡ç½®countåŠé€šè¿‡åˆ›å»ºå¯¹è±¡å¼€å¯ä¸‹ä¸€ä»£</code>ã€‚</p>
</blockquote>
<h3 id="breakbarrier">breakBarrier</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">breakBarrier</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// ä¿®æ”¹Generationå¯¹è±¡å‚æ•°
</span><span style="color:#75715e"></span>    generation<span style="color:#f92672">.</span><span style="color:#a6e22e">broken</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
    <span style="color:#75715e">// é‡ç½®è®¡æ•°å™¨
</span><span style="color:#75715e"></span>    count <span style="color:#f92672">=</span> parties<span style="color:#f92672">;</span>
    <span style="color:#75715e">// å”¤é†’ä¸Šä¸€ä»£ç­‰åœ°çš„çº¿ç¨‹
</span><span style="color:#75715e"></span>    trip<span style="color:#f92672">.</span><span style="color:#a6e22e">signalAll</span><span style="color:#f92672">();</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<p>ä¸<code>nextGeneration</code>ä¸åŒç‚¹åœ¨äºï¼šä¿®æ”¹<code>Generationå¯¹è±¡</code>å‚æ•°ï¼Œä»¥åŠ<code>æ²¡æœ‰åˆ›å»ºä¸‹ä¸€ä»£Generation</code>ã€‚</p>
</blockquote>
<h3 id="reset">reset</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">reset</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">final</span> ReentrantLock lock <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">lock</span><span style="color:#f92672">;</span>
    lock<span style="color:#f92672">.</span><span style="color:#a6e22e">lock</span><span style="color:#f92672">();</span>
    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
        breakBarrier<span style="color:#f92672">();</span>   <span style="color:#75715e">// break the current generation
</span><span style="color:#75715e"></span>        nextGeneration<span style="color:#f92672">();</span> <span style="color:#75715e">// start a new generation
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
        lock<span style="color:#f92672">.</span><span style="color:#a6e22e">unlock</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<p>resetæ–¹æ³•åœ¨è·å–é”çš„å‰æä¸‹è°ƒç”¨äº†<code>breakBarrier å’Œ nextGeneration</code>æ–¹æ³•ï¼Œé™¤äº†<code>ä¿®æ”¹è¿™ä¸€ä»£Generationçš„brokenã€é‡ç½®è®¡æ•°å™¨å¤–ï¼Œè¿˜åˆ›å»ºäº†ä¸‹ä¸€ä»£Generation</code>ï¼ˆè™½ç„¶ä»£ç æœ‰äº›é‡å¤ï¼‰ã€‚</p>
</blockquote>
<hr>
<h3 id="await">await</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// åŒä¸€ä¸ªçº¿ç¨‹å¯èƒ½å¤šæ¬¡è°ƒç”¨awaitæ–¹æ³•
</span><span style="color:#75715e">// è¿”å›å€¼è¡¨æ˜è¿˜éœ€è¦å¤šå°‘ä¸ªçº¿ç¨‹åˆ°è¾¾å±éšœå¤„
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">await</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> InterruptedException<span style="color:#f92672">,</span> BrokenBarrierException <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// falseè¡¨æ˜ä¸éœ€è¦åˆ¤æ–­è¶…æ—¶
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span> dowait<span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> 0L<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>TimeoutException toe<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// await()ä¸­çš„dowaitæŒ‰é“ç†ä¸ä¼šæŠ›å‡ºè¯¥å¼‚å¸¸
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error<span style="color:#f92672">(</span>toe<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">dowait</span><span style="color:#f92672">(</span><span style="color:#66d9ef">boolean</span> timed<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> nanos<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> InterruptedException<span style="color:#f92672">,</span> 										BrokenBarrierException<span style="color:#f92672">,</span> TimeoutException <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">final</span> ReentrantLock lock <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">lock</span><span style="color:#f92672">;</span>
    <span style="color:#75715e">// è·å–ç‹¬å é”
</span><span style="color:#75715e"></span>    lock<span style="color:#f92672">.</span><span style="color:#a6e22e">lock</span><span style="color:#f92672">();</span>
    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// è·å–è¿™ä¸€ä»£çš„Generation
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">final</span> Generation g <span style="color:#f92672">=</span> generation<span style="color:#f92672">;</span>
		<span style="color:#75715e">// ä¹‹å‰breakBarrieræ–¹æ³•ä¼šä¿®æ”¹brokenå‚æ•°ä¸ºtrueï¼Œå¦‚æœçº¿ç¨‹ç›‘æµ‹åˆ°ä¼šæŠ›å‡ºå¼‚å¸¸
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>g<span style="color:#f92672">.</span><span style="color:#a6e22e">broken</span><span style="color:#f92672">)</span>
            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> BrokenBarrierException<span style="color:#f92672">();</span>
        <span style="color:#75715e">// è¯¥æ–¹æ³•å“åº”ä¸­æ–­ï¼ŒæŠ›å‡ºä¸­æ–­å¼‚å¸¸å‰ä¼šè°ƒç”¨breakBarrier
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">interrupted</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            breakBarrier<span style="color:#f92672">();</span>
            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> InterruptedException<span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>
		<span style="color:#75715e">// æ­¤ä¸­ä»£ç ä¸éœ€è¦è€ƒè™‘ç«äº‰
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// å°†count-1ç±»ä¼¼countDownLatchä¸­çš„countDown
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">int</span> index <span style="color:#f92672">=</span> <span style="color:#f92672">--</span>count<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>index <span style="color:#f92672">==</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span> 
            <span style="color:#75715e">// index = 0è¯´æ˜é™¤å½“å‰çº¿ç¨‹å¤–çš„å…¶ä»–çº¿ç¨‹éƒ½æ‰§è¡Œäº†awaitæ–¹æ³•
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// å½“å‰éœ€è¦å‡†å¤‡å¸¦é¢†å…¶ä»–çº¿ç¨‹ä¸€èµ·å†²ç ´å±éšœäº†
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">boolean</span> ranAction <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// æ‰§è¡Œå†²ç ´å±éšœå‰çš„ä»»åŠ¡
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">final</span> Runnable command <span style="color:#f92672">=</span> barrierCommand<span style="color:#f92672">;</span>
                <span style="color:#75715e">// è¿™é‡Œå¯ä»¥çœ‹å‡ºï¼Œæ²¡æœ‰å¦èµ·çº¿ç¨‹å»æ‰§è¡Œï¼Œå°±æ˜¯å½“å‰çº¿ç¨‹å¤„ç†çš„
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>command <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
                    command<span style="color:#f92672">.</span><span style="color:#a6e22e">run</span><span style="color:#f92672">();</span>
                <span style="color:#75715e">// ä¿®æ”¹ranActionå‚æ•°
</span><span style="color:#75715e"></span>                ranAction <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                <span style="color:#75715e">// è°ƒç”¨nextGenerationå”¤é†’æ‰€æœ‰ç­‰å¾…çº¿ç¨‹ã€é‡ç½®countå¹¶åˆ›å»ºä¸‹ä¸€ä»£
</span><span style="color:#75715e"></span>                nextGeneration<span style="color:#f92672">();</span>
                <span style="color:#66d9ef">return</span> 0<span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// å¦‚æœå½“å‰çº¿ç¨‹æ‰§è¡Œcommandä»»åŠ¡å¤±è´¥
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>ranAction<span style="color:#f92672">)</span>
                    <span style="color:#75715e">// è°ƒç”¨breakBarrier
</span><span style="color:#75715e"></span>                    breakBarrier<span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// æ‰§è¡Œåˆ°æ­¤è¯´æ˜å½“å‰çº¿ç¨‹ä¸æ˜¯å½“ä»£æœ€åä¸€ä¸ªçº¿ç¨‹
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// è‡ªæ—‹ç›´åˆ°è¢«ä¸­æ–­ã€awaitè¶…æ—¶ã€broken=trueæˆ–count=0
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(;;)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// è¿›è¡Œawait(time)æ–¹æ³•çš„å¤„ç†
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>timed<span style="color:#f92672">)</span>
                    <span style="color:#75715e">// å½“å‰count!=0ï¼Œæ‰€ä»¥å°†å½“å‰çº¿ç¨‹æ”¾å…¥æ¡ä»¶é˜Ÿåˆ—ç­‰å¾…å”¤é†’
</span><span style="color:#75715e"></span>                    <span style="color:#75715e">// å”¤é†’åä»æ­¤å¤„ç»§ç»­æ‰§è¡Œ
</span><span style="color:#75715e"></span>                    trip<span style="color:#f92672">.</span><span style="color:#a6e22e">await</span><span style="color:#f92672">();</span>
                <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>nanos <span style="color:#f92672">&gt;</span> 0L<span style="color:#f92672">)</span>
                    <span style="color:#75715e">// Condition.await(æŒ‡å®šæ—¶é•¿)
</span><span style="color:#75715e"></span>                    <span style="color:#75715e">// è¿”å›çš„æ˜¯deadline - currentTimeçš„å·®å€¼
</span><span style="color:#75715e"></span>                    nanos <span style="color:#f92672">=</span> trip<span style="color:#f92672">.</span><span style="color:#a6e22e">awaitNanos</span><span style="color:#f92672">(</span>nanos<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>InterruptedException ie<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// å¦‚æœå½“å‰çº¿ç¨‹è¢«ä¸­æ–­æ‰§è¡Œæ­¤å¤„é€»è¾‘
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// åˆ¤æ–­å½“å‰çº¿ç¨‹çš„generationæ˜¯å¦æ”¹å˜ï¼Œå¦‚æœæ²¡æœ‰æ”¹å˜ä¸”g.brokençš„å€¼æ˜¯false
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// æ‰§è¡ŒbreakBarrieræ–¹æ³•å¹¶æŠ›å‡ºä¸­æ–­å¼‚å¸¸
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>g <span style="color:#f92672">==</span> generation <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span> g<span style="color:#f92672">.</span><span style="color:#a6e22e">broken</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    breakBarrier<span style="color:#f92672">();</span>
                    <span style="color:#66d9ef">throw</span> ie<span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                    <span style="color:#75715e">// æ‰§è¡Œåˆ°æ­¤å¤„
</span><span style="color:#75715e"></span>                    <span style="color:#75715e">// è¦ä¹ˆæ˜¯Generationå·²ç»æ›´æ–°äº†ï¼Œé‚£ä¹ˆä¸èƒ½æ‰§è¡ŒbreakBarrierå½±å“è¿™ä¸€ä»£
</span><span style="color:#75715e"></span>                    <span style="color:#75715e">// è¦ä¹ˆæ˜¯g.broken = trueï¼Œè¯´æ˜å·²ç»æ‰§è¡Œè¿‡breakBarrierï¼Œé‚£å°±ä¸å†æ‰§è¡Œ
</span><span style="color:#75715e"></span>                    <span style="color:#75715e">// æœ€ç»ˆä¿®æ”¹å½“å‰çº¿ç¨‹ä¸­æ–­ä½ä½true
</span><span style="color:#75715e"></span>                    Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">currentThread</span><span style="color:#f92672">().</span><span style="color:#a6e22e">interrupt</span><span style="color:#f92672">();</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
			<span style="color:#75715e">// æ­¤æ—¶è¿˜åœ¨å¾ªç¯ä¸­ï¼Œç»§ç»­åˆ¤æ–­broken
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>g<span style="color:#f92672">.</span><span style="color:#a6e22e">broken</span><span style="color:#f92672">)</span>
                <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> BrokenBarrierException<span style="color:#f92672">();</span>
			<span style="color:#75715e">// æ‰§è¡Œåˆ°æ­¤å¦‚æœä¸æ˜¯åŒä¸€ä»£ï¼Œé‚£ä¹ˆæ­¤æ—¶åªæœ‰ä¸¤ç§å¯èƒ½
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// 1. å½“å‰çº¿ç¨‹awaitåè¢«å”¤é†’ï¼Œå‘ç°ä»£å·²ç»æ›´æ–°ï¼Œå³æœ€åä¸€ä¸ªçº¿ç¨‹å·²æ‰§è¡Œè¿‡ã€‚ç›´æ¥è¿”å›å³å¯
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// 2. resetæ–¹æ³•è¢«è°ƒç”¨ï¼Œå®ƒå…¶ä¸­çš„nextGenerationåˆ›å»ºäº†æ–°ä¸€ä»£ã€‚
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>g <span style="color:#f92672">!=</span> generation<span style="color:#f92672">)</span>
                <span style="color:#66d9ef">return</span> index<span style="color:#f92672">;</span>
			
            <span style="color:#75715e">// æ‰§è¡Œåˆ°æ­¤è¯´æ˜broken = false ä¸” ä»£æ²¡æœ‰æ›´æ–°ï¼Œæœ€åä¸€ä¸ªçº¿ç¨‹è¿˜æ²¡æ¥
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// ç»§ç»­åˆ¤æ–­æ˜¯å¦è¶…æ—¶ï¼Œå¦‚æœè¶…æ—¶è°ƒç”¨breakBarrierå¹¶æŠ›å‡ºå¼‚å¸¸
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>timed <span style="color:#f92672">&amp;&amp;</span> nanos <span style="color:#f92672">&lt;=</span> 0L<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                breakBarrier<span style="color:#f92672">();</span>
                <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> TimeoutException<span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// æœ€ç»ˆé‡Šæ”¾é”
</span><span style="color:#75715e"></span>        lock<span style="color:#f92672">.</span><span style="color:#a6e22e">unlock</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<ol>
<li>awaitæ–¹æ³•æ˜¯å“åº”ä¸­æ–­çš„ï¼Œå¹¶ä¸”å¦‚æœ<code>Generation.broken = true</code>åˆ™ä¼šæŠ›å‡ºæŒ‡å®šå¼‚å¸¸ã€‚</li>
<li>è‹¥å½“å‰çº¿ç¨‹æ°å¥½æ˜¯æ‰§è¡Œ<code>å½“å‰ä»£æ‰§è¡Œawaitæ–¹æ³•çš„æœ€åä¸€ä¸ªçº¿ç¨‹</code>ï¼Œé‚£ä¹ˆå®ƒä¼šæ‰§è¡Œ<code>barrierCommand</code>ã€‚</li>
<li>è‹¥ä¸æ˜¯å½“å‰ä»£çš„æœ€åä¸€ä¸ªçº¿ç¨‹ï¼Œé‚£ä¹ˆä¼šè¿›å…¥<code>è‡ªæ—‹</code>ï¼ŒåŠ å…¥æ¡ä»¶é˜Ÿåˆ—é˜»å¡<code>ç›´åˆ°è¢«æœ€åä¸€ä¸ªçº¿ç¨‹å”¤é†’</code>ã€‚</li>
<li>CyclicBarrieræš´éœ²äº†<code>reset</code>æ–¹æ³•ï¼Œåªæœ‰é€šè¿‡è¿™ä¸ªæ–¹æ³•æ‰èƒ½<code>æ˜¾å¼ä¸­æ–­è¿™ä¸€ä»£ã€é‡ç½®countå’Œå¼€å¯ä¸‹ä¸€ä»£</code>ã€‚</li>
</ol>
</blockquote>
<hr>
<h3 id="awaittime">await(time)</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">await</span><span style="color:#f92672">(</span><span style="color:#66d9ef">long</span> timeout<span style="color:#f92672">,</span> TimeUnit unit<span style="color:#f92672">)</span>
<span style="color:#66d9ef">throws</span> InterruptedException<span style="color:#f92672">,</span> BrokenBarrierException<span style="color:#f92672">,</span>TimeoutException <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> dowait<span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">,</span> unit<span style="color:#f92672">.</span><span style="color:#a6e22e">toNanos</span><span style="color:#f92672">(</span>timeout<span style="color:#f92672">));</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e">// ä¸‹é¢æ˜¯ä¸awaitæ–¹æ³•å”¯äºŒä¸åŒçš„åœ°æ–¹
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">dowait</span><span style="color:#f92672">(</span><span style="color:#66d9ef">boolean</span> timed<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> nanos<span style="color:#f92672">){</span>
    <span style="color:#f92672">...</span>
    <span style="color:#66d9ef">for</span><span style="color:#f92672">(;;)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>timed<span style="color:#f92672">)</span>
            trip<span style="color:#f92672">.</span><span style="color:#a6e22e">await</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>nanos <span style="color:#f92672">&gt;</span> 0L<span style="color:#f92672">)</span>
            <span style="color:#75715e">// æ‰§è¡Œçš„æ˜¯Condition.await(time)æ–¹æ³•
</span><span style="color:#75715e"></span>            nanos <span style="color:#f92672">=</span> trip<span style="color:#f92672">.</span><span style="color:#a6e22e">awaitNanos</span><span style="color:#f92672">(</span>nanos<span style="color:#f92672">);</span>
        <span style="color:#f92672">...</span>
    <span style="color:#f92672">}</span>
    <span style="color:#f92672">...</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>timed <span style="color:#f92672">&amp;&amp;</span> nanos <span style="color:#f92672">&lt;=</span> 0L<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
       breakBarrier<span style="color:#f92672">();</span>
        <span style="color:#75715e">// awaitå¹¶ä¸ä¼šæŠ›å‡ºæ­¤å¼‚å¸¸
</span><span style="color:#75715e"></span>       <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> TimeoutException<span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<p>await(time)æ–¹æ³•ä¸awaitå¤§éƒ¨åˆ†æ˜¯ç›¸åŒçš„ï¼ŒåŒºåˆ«åœ¨äºï¼š</p>
<ol>
<li>await(time)æ‰§è¡Œçš„æ˜¯Condition.await(time)æ–¹æ³•ï¼Œåˆ°æ—¶<code>è‡ªåŠ¨å”¤é†’ï¼ˆåº•å±‚LockSupprt.parkNanosï¼‰</code>æ¥å®ç°çš„ã€‚</li>
<li>await(time)ä¼š<code>æŠ›å‡ºTimeoutException</code>å¼‚å¸¸ã€‚</li>
</ol>
</blockquote>
<hr>
<h3 id="æ€»ç»“">æ€»ç»“</h3>
<ul>
<li>CyclicBarrierå’ŒCountDownLatchç±»ä¼¼ï¼Œéƒ½è¦ä¼ å…¥<code>intå€¼æ¥è®¾ç½®è®¡æ•°å™¨ï¼ˆåŒºåˆ«ï¼šå‰è€…&gt;0ï¼Œåè€…&gt;=0ï¼‰</code>ã€‚</li>
<li>CyclicBarrierçš„countDownå’Œawaitéƒ½<code>ç”±åŒä¸€ä¸ªçº¿ç¨‹å®ç°</code>ï¼Œè€ŒCountDownLatchç”±ä¸¤ç§çº¿ç¨‹åˆ†åˆ«å®ç°ã€‚</li>
<li>CyclicBarrierå®ç°äº†å¾ªç¯åˆ©ç”¨ï¼Œæ¯æœ‰<code>parties</code>ä¸ªçº¿ç¨‹åˆ°è¾¾å±éšœï¼Œå°±<code>ç”Ÿæˆæ–°ä¸€ä»£å¹¶å”¤é†’è€ä¸€ä»£çº¿ç¨‹ä»awaitå¤„é€€å‡º</code>ç»§ç»­æ‰§è¡Œå„è‡ªçº¿ç¨‹ä¸­çš„ä»£ç ï¼Œç›´åˆ°ä»£ç æ‰§è¡Œå®Œæ¯•æˆ–ä¸‹ä¸€ä¸ªawaitã€‚</li>
</ul>

    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h">å…¶ä»–æ–‡ç« </span>
            <hr />
          </div>
          <div class="pagination__buttons">
            
              <span class="button previous">
                <a href="https://www.leejay.top/post/stampedlock/">
                  <span class="button__icon">â†</span>
                  <span class="button__text">StampedLock</span>
                </a>
              </span>
            
            
              <span class="button next">
                <a href="https://www.leejay.top/post/countdownlatch/">
                  <span class="button__text">CountDownLatch</span>
                  <span class="button__icon">â†’</span>
                </a>
              </span>
            
          </div>
        </div>
      
    


    
      
        

      
    

    </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright copyright--user">è‹ICPå¤‡18050258å·-1</div>
    
  </div>
</footer>

<script src="https://www.leejay.top/assets/main.js"></script>
<script src="https://www.leejay.top/assets/prism.js"></script>


      
    </div>

    
  </body>
</html>
