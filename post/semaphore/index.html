<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>Semaphore :: é»„æ˜ç°ç™½éª¨ â€” Just a normal blog</title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="description" content="acquire // å…±äº«é”å¯ä»¥ç«‹å³å“åº”ä¸­æ–­å¼‚å¸¸ public void acquire() throws InterruptedException { sync.acquireSharedInterruptibly(1); } public final void acquireSharedInterruptibly(int arg) throws InterruptedException { // å¦‚æœçº¿ç¨‹è¢«ä¸­æ–­ç«‹å³æŠ›å‡ºå¼‚å¸¸  if (Thread.interrupted()) throw new InterruptedException(); if (tryAcquireShared(arg) &amp;lt; 0) doAcquireSharedInterruptibly(arg); } å…±äº«é”tryAcquireShared()ä¸ç‹¬å é”tryAcquire()çš„ä¸åŒåœ¨äºã€‚å‰è€…çš„è¿”å›å€¼å­˜åœ¨ä¸‰ç§æƒ…å†µï¼Œåè€…åªæœ‰ä¸¤ç§æƒ…å†µ(true/false)ã€‚
   tryAcquireShared å€¼ æ˜¯å¦è·å–é”     0 è·å–å…±äº«é”æˆåŠŸï¼Œåç»­è·å–å¯èƒ½ä¸æˆåŠŸ   &amp;lt; 0 è·å–å…±äº«é”å¤±è´¥   &amp;gt; 0 è·å–å…±äº«é”æˆåŠŸï¼Œåç»­è·å–å¯èƒ½æˆåŠŸ    tryAcquireShared protected int tryAcquireShared(int acquires) { return nonfairTryAcquireShared(acquires); } // é»˜è®¤æ˜¯é‡‡ç”¨äº†éå…¬å¹³è·å–é”çš„æ–¹å¼ final int nonfairTryAcquireShared(int acquires) { for (;;) { int available = getState(); int remaining = available - acquires; // å¦‚æœremaining&amp;gt;=0æ—¶å°±ä¸€ç›´è‡ªæ—‹CASä¿®æ”¹stateçŠ¶æ€  if (remaining &amp;lt; 0 || compareAndSetState(available, remaining)) return remaining; } }  ä¸ºä»€ä¹ˆremaining=0çš„æ—¶å€™ä¹Ÿè¦å°è¯•å»ä¿®æ”¹çŠ¶æ€ï¼Œå› ä¸ºè¿™ä¸ªæ—¶å€™å¯èƒ½æœ‰å…¶ä»–çº¿ç¨‹é‡Šæ”¾äº†å…±äº«é”ï¼Œæ‰€ä»¥æœ‰æ¦‚ç‡èƒ½è·å–åˆ°é”ã€‚"/>
<meta name="keywords" content=""/>
<meta name="robots" content="noodp"/>
<link rel="canonical" href="https://xiaokexiang.github.io/post/semaphore/" />





<link rel="stylesheet" href="https://xiaokexiang.github.io/assets/style.css">


<link rel="stylesheet" href="https://xiaokexiang.github.io/style.css">


<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://xiaokexiang.github.io/img/apple-touch-icon-144-precomposed.png">
<link rel="shortcut icon" href="https://xiaokexiang.github.io/img/favicon.png">



<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Semaphore"/>
<meta name="twitter:description" content="Semaphoreæ˜¯åŸºäºAQSçš„`å¯é‡å…¥å…±äº«é”`ï¼Œå…·æœ‰å…¬å¹³å’Œéå…¬å¹³æ¨¡å¼ã€‚"/>



<meta property="og:title" content="Semaphore" />
<meta property="og:description" content="Semaphoreæ˜¯åŸºäºAQSçš„`å¯é‡å…¥å…±äº«é”`ï¼Œå…·æœ‰å…¬å¹³å’Œéå…¬å¹³æ¨¡å¼ã€‚" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://xiaokexiang.github.io/post/semaphore/" />
<meta property="article:published_time" content="2020-06-20T16:09:38+08:00" />
<meta property="article:modified_time" content="2020-06-20T16:09:38+08:00" /><meta property="og:site_name" content="é»„æ˜ç°ç™½éª¨" />






  </head>
  <body class="">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a href="https://xiaokexiang.github.io" class="logo" style="text-decoration: none;">
  
    <span class="logo__mark"><svg xmlns="https://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367"/>
</svg></span>
    <span class="logo__text">é»„æ˜ç°ç™½éª¨</span>
    <span class="logo__cursor"></span>
    <span class="logo__cursor2"></span>
  
</a>
    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/categories">Categories</a></li>
        
      
        
          <li><a href="/tags">Tags</a></li>
        
      
      
    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/categories">Categories</a></li>
      
    
      
        <li><a href="/tags">Tags</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none"/>
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="https://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>
      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  
  

  <div class="post">
    <h1 class="post-title"><a href="https://xiaokexiang.github.io/post/semaphore/">Semaphore</a></h1>
    <div class="post-meta">
      
        <span class="post-date">
          2020-06-20
        </span>

        
          
        
      

      
      
    </div>

    
      <span class="post-tags">
        
        ğŸ–<a href="https://xiaokexiang.github.io/tags/semaphore/">Semaphore </a>&nbsp;
        
        ğŸ–<a href="https://xiaokexiang.github.io/tags/aqs/">AQS</a>&nbsp;
        
      </span>
    

    

    <div class="post-content">
      
      <h3 id="acquire">acquire</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// å…±äº«é”å¯ä»¥ç«‹å³å“åº”ä¸­æ–­å¼‚å¸¸
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">acquire</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> InterruptedException <span style="color:#f92672">{</span>
    sync<span style="color:#f92672">.</span><span style="color:#a6e22e">acquireSharedInterruptibly</span><span style="color:#f92672">(</span>1<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">acquireSharedInterruptibly</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> arg<span style="color:#f92672">)</span>
    <span style="color:#66d9ef">throws</span> InterruptedException <span style="color:#f92672">{</span>
    <span style="color:#75715e">// å¦‚æœçº¿ç¨‹è¢«ä¸­æ–­ç«‹å³æŠ›å‡ºå¼‚å¸¸
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">interrupted</span><span style="color:#f92672">())</span>
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> InterruptedException<span style="color:#f92672">();</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>tryAcquireShared<span style="color:#f92672">(</span>arg<span style="color:#f92672">)</span> <span style="color:#f92672">&lt;</span> 0<span style="color:#f92672">)</span>
        doAcquireSharedInterruptibly<span style="color:#f92672">(</span>arg<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>å…±äº«é”tryAcquireShared()ä¸ç‹¬å é”tryAcquire()çš„ä¸åŒåœ¨äºã€‚å‰è€…çš„è¿”å›å€¼å­˜åœ¨ä¸‰ç§æƒ…å†µï¼Œåè€…åªæœ‰ä¸¤ç§æƒ…å†µ(true/false)ã€‚</p>
<table>
<thead>
<tr>
<th align="center">tryAcquireShared å€¼</th>
<th align="center">æ˜¯å¦è·å–é”</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">0</td>
<td align="center">è·å–å…±äº«é”æˆåŠŸï¼Œåç»­è·å–å¯èƒ½ä¸æˆåŠŸ</td>
</tr>
<tr>
<td align="center">&lt; 0</td>
<td align="center">è·å–å…±äº«é”å¤±è´¥</td>
</tr>
<tr>
<td align="center">&gt; 0</td>
<td align="center">è·å–å…±äº«é”æˆåŠŸï¼Œåç»­è·å–å¯èƒ½æˆåŠŸ</td>
</tr>
</tbody>
</table>
<h4 id="tryacquireshared">tryAcquireShared</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">tryAcquireShared</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> acquires<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> nonfairTryAcquireShared<span style="color:#f92672">(</span>acquires<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
<span style="color:#75715e">// é»˜è®¤æ˜¯é‡‡ç”¨äº†éå…¬å¹³è·å–é”çš„æ–¹å¼
</span><span style="color:#75715e"></span><span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">nonfairTryAcquireShared</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> acquires<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(;;)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">int</span> available <span style="color:#f92672">=</span> getState<span style="color:#f92672">();</span>
        <span style="color:#66d9ef">int</span> remaining <span style="color:#f92672">=</span> available <span style="color:#f92672">-</span> acquires<span style="color:#f92672">;</span>
        <span style="color:#75715e">// å¦‚æœremaining&gt;=0æ—¶å°±ä¸€ç›´è‡ªæ—‹CASä¿®æ”¹stateçŠ¶æ€
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>remaining <span style="color:#f92672">&lt;</span> 0 <span style="color:#f92672">||</span>
            compareAndSetState<span style="color:#f92672">(</span>available<span style="color:#f92672">,</span> remaining<span style="color:#f92672">))</span>
            <span style="color:#66d9ef">return</span> remaining<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<p>ä¸ºä»€ä¹ˆremaining=0çš„æ—¶å€™ä¹Ÿè¦å°è¯•å»ä¿®æ”¹çŠ¶æ€ï¼Œå› ä¸ºè¿™ä¸ªæ—¶å€™å¯èƒ½æœ‰å…¶ä»–çº¿ç¨‹é‡Šæ”¾äº†å…±äº«é”ï¼Œæ‰€ä»¥æœ‰æ¦‚ç‡èƒ½è·å–åˆ°é”ã€‚</p>
<p>å¦‚æœtryAcquireSharedçš„è¿”å›å€¼å°äº0ï¼Œè¯´æ˜æ­¤æ—¶æ²¡æœ‰é”å¯ä»¥è·å–ï¼Œæ‰§è¡Œå…¥é˜Ÿç­‰ç›¸å…³æ“ä½œã€‚</p>
</blockquote>
<h4 id="doacquiresharedinterruptibly">doAcquireSharedInterruptibly</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">doAcquireSharedInterruptibly</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> arg<span style="color:#f92672">)</span>
          <span style="color:#66d9ef">throws</span> InterruptedException <span style="color:#f92672">{</span>
      <span style="color:#75715e">// å°è£…å…±äº«èŠ‚ç‚¹æ·»åŠ åˆ°åŒæ­¥é˜Ÿåˆ—é˜Ÿå°¾
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">final</span> Node node <span style="color:#f92672">=</span> addWaiter<span style="color:#f92672">(</span>Node<span style="color:#f92672">.</span><span style="color:#a6e22e">SHARED</span><span style="color:#f92672">);</span>
    <span style="color:#66d9ef">boolean</span> failed <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(;;)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// è·å–å‰é©±èŠ‚ç‚¹
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">final</span> Node p <span style="color:#f92672">=</span> node<span style="color:#f92672">.</span><span style="color:#a6e22e">predecessor</span><span style="color:#f92672">();</span>
            <span style="color:#75715e">// å¦‚æœå‰é©±èŠ‚ç‚¹æ˜¯headèŠ‚ç‚¹
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>p <span style="color:#f92672">==</span> head<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// å°è¯•è·å–å…±äº«é”
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">int</span> r <span style="color:#f92672">=</span> tryAcquireShared<span style="color:#f92672">(</span>arg<span style="color:#f92672">);</span>
                <span style="color:#75715e">// æ³¨æ„è¿™é‡Œæ˜¯r&gt;=0
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>r <span style="color:#f92672">&gt;=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#75715e">// ä¸ç‹¬å é”ä¸åŒä¹‹å¤„ï¼Œç‹¬å é”æ˜¯setHead()
</span><span style="color:#75715e"></span>                    <span style="color:#75715e">// é™¤äº†å½“å‰çº¿ç¨‹è·å–é”ï¼Œåé¢çš„çº¿ç¨‹ä¹Ÿæœ‰å¯èƒ½è·å–å…±äº«é”
</span><span style="color:#75715e"></span>                    setHeadAndPropagate<span style="color:#f92672">(</span>node<span style="color:#f92672">,</span> r<span style="color:#f92672">);</span>
                    p<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span> <span style="color:#75715e">// help GC
</span><span style="color:#75715e"></span>                    failed <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
                    <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
            <span style="color:#75715e">// åˆ¤æ–­æ˜¯å¦éœ€è¦ä¸­æ–­åŠä¸­æ–­æ­¥éª¤ ä¸ç‹¬å é”ç›¸åŒ
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>shouldParkAfterFailedAcquire<span style="color:#f92672">(</span>p<span style="color:#f92672">,</span> node<span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span>
                parkAndCheckInterrupt<span style="color:#f92672">())</span>
                <span style="color:#75715e">// å…±äº«é”åŠæ—¶å“åº”ä¸­æ–­
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> InterruptedException<span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// å¦‚æœæŠ›å‡ºä¸­æ–­å¼‚å¸¸ï¼Œæ­¤å¤„å°±ä¼šæ‰§è¡Œè¯¥é€»è¾‘
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>failed<span style="color:#f92672">)</span>
            cancelAcquire<span style="color:#f92672">(</span>node<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h4 id="setheadandpropagate">setHeadAndPropagate</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setHeadAndPropagate</span><span style="color:#f92672">(</span>Node node<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> propagate<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// è®°å½•è€çš„headç”¨äºä¸‹é¢çš„å¯¹æ¯”æ ¡éªŒ
</span><span style="color:#75715e"></span>    Node h <span style="color:#f92672">=</span> head<span style="color:#f92672">;</span> 
    <span style="color:#75715e">// å’Œç‹¬å é”ä¸€è‡´ï¼Œå°†è·å–é”çš„nodeè®¾ä¸ºæ–°headï¼Œæ¸…ç©ºthreadå±æ€§
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// æ­¤æ—¶node=new headï¼Œh=old head
</span><span style="color:#75715e"></span>    setHead<span style="color:#f92672">(</span>node<span style="color:#f92672">);</span>
    <span style="color:#75715e">// æ­¤æ—¶h = old head
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>propagate <span style="color:#f92672">&gt;</span> 0 <span style="color:#f92672">||</span> h <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> h<span style="color:#f92672">.</span><span style="color:#a6e22e">waitStatus</span> <span style="color:#f92672">&lt;</span> 0 <span style="color:#f92672">||</span>
        <span style="color:#75715e">// æ­¤æ—¶h = new node
</span><span style="color:#75715e"></span>        <span style="color:#f92672">(</span>h <span style="color:#f92672">=</span> head<span style="color:#f92672">)</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> h<span style="color:#f92672">.</span><span style="color:#a6e22e">waitStatus</span> <span style="color:#f92672">&lt;</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        Node s <span style="color:#f92672">=</span> node<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>s <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> s<span style="color:#f92672">.</span><span style="color:#a6e22e">isShared</span><span style="color:#f92672">())</span>
            doReleaseShared<span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<p>doReleaseShared()å¯ä»¥ç†è§£æˆunparkSuccessorçš„å‡çº§æ–¹æ³•ï¼Œä¸æ­¢è·å–é”çš„è¿‡ç¨‹ä¸­è¢«è°ƒç”¨ï¼Œé‡Šæ”¾é”çš„è¿‡ç¨‹ä¸­ä¹Ÿä¼šè¢«è°ƒç”¨ã€‚</p>
<ol>
<li>h == null å’Œ ((h = head) == null) ä¸ä¼šæˆç«‹ï¼Œå› ä¸ºä¹‹å‰ä»£ç æ‰§è¡Œè¿‡addWaiterï¼Œæ‰€ä»¥é˜Ÿåˆ—è‚¯å®šå·²åˆå§‹åŒ–ï¼Œå·²ç»åˆå§‹åŒ–é‚£ä¹ˆè‚¯å®šä¸ä¸ºnull(headèŠ‚ç‚¹ä¸­åªæ˜¯thread = null)ã€‚</li>
<li>æ¡ä»¶åˆ¤æ–­åªå‰© <code>propagate &gt; 0 || h.waitStatus &lt; 0 || h.waitStatus &lt; 0 </code>ï¼Œéœ€è¦æ³¨æ„æ­¤å¤„çš„hä¸æ˜¯åŒä¸€ä¸ªï¼Œå‰é¢çš„hæ˜¯æ—§headï¼Œåé¢çš„hæ˜¯æ–°headã€‚</li>
<li>æ ¹æ®å¤–å±‚æ–¹æ³•è¦æ±‚ propagate &gt;= 0ï¼Œé‚£ä¹ˆ<code>propagate &gt; 0</code>æ—¶ï¼Œè·å–nodeçš„nextèŠ‚ç‚¹ï¼Œå¦‚æœnodeæ˜¯tailå°¾èŠ‚ç‚¹ï¼Œé‚£ä¹ˆ <code>s == null</code>æˆç«‹ï¼Œæ‰§è¡Œ<code>doReleaseShared</code>æ–¹æ³•ï¼Œå¦‚æœ<code>s == null</code>ä¸æˆç«‹ï¼Œåˆ™åˆ¤æ–­ <code>s.nextWaiter == SHARED</code>ï¼Œæ·»åŠ å…±äº«èŠ‚ç‚¹æ—¶ä¼šè®¾ç½®æ­¤å‚æ•°ï¼Œç”¨äºåˆ¤æ–­æ˜¯å¦æ˜¯å…±äº«èŠ‚ç‚¹ã€‚</li>
<li>é‚£ä¹ˆå¦‚æœ<code>propagate  = 0</code>æ—¶ï¼Œç»§ç»­åˆ¤æ–­<code>h.waitStatus &lt; 0</code>ï¼Œä»ä¹‹å‰ç‹¬å é”çš„å”¤é†’æˆ‘ä»¬çŸ¥é“åœ¨<code>unparkSuccessor</code>ä¼šå°†<code>headå¤´èŠ‚ç‚¹çš„waitStatusè®¾ä¸º0</code>ï¼Œé‚£ä¹ˆæ­¤å¤„çš„æ¡ä»¶ä½•æ—¶ä¼šå‘ç”Ÿå‘¢ï¼Ÿæˆ‘ä»¬éœ€è¦å…ˆæŸ¥çœ‹<code>doReleaseShared</code>ä¸­çš„ä»£ç ï¼Œå®ƒåœ¨<code>compareAndSetWaitStatus(h, 0, Node.PROPAGATE)</code>å¤„å°†headå¤´èŠ‚ç‚¹è®¾ç½®ä¸º<code>PROPAGATE</code>ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¹ŸçŸ¥é“<code>release</code>æ–¹æ³•ä¸­ä¹Ÿä¼šè°ƒç”¨<code>doReleaseShared</code>å»é‡Šæ”¾å…±äº«é”ï¼Œæ‰€ä»¥æ­¤å¤„å¾ˆæœ‰å¯èƒ½æ˜¯å…¶ä»–çº¿ç¨‹é‡Šæ”¾äº†é”ï¼Œè¿›å…¥ä¸‹ä¸€å±‚åˆ¤æ–­ï¼Œæ‰€ä»¥æ­¤æ—¶ä¹Ÿå¯èƒ½å»æ‰§è¡Œ<code>doReleaseShared</code>å»å°è¯•è·å–é”ã€‚å½“ç„¶æ­¤æƒ…å†µæ¯”è¾ƒå‡‘å·§ï¼Œä½†ç¡®å®ä¼šå‘ç”Ÿã€‚</li>
<li>æ¥ä¸Šæ®µï¼Œå¦‚æœ<code>æ—§h.waitStatus  &lt; 0</code>ä¸æˆç«‹ï¼Œé‚£ä¹ˆ<code>æ–°h.waitStatus &lt; 0</code>æ¡ä»¶ä½•æ—¶æˆç«‹å‘¢ï¼Ÿåœ¨<code>shouldParkAfterFailedAcquire</code>ä¸­ä¼šå°†å‰é©±èŠ‚ç‚¹è®¾ç½®ä¸º<code>SIGNAL</code>çŠ¶æ€åå»parkå½“å‰èŠ‚ç‚¹ï¼Œæ‰€ä»¥åªè¦å…ˆæ‰§è¡Œè¿‡<code>shouldParkAfterFailedAcquire</code>æ–¹æ³•ï¼Œåè·å–é”ï¼Œé‚£ä¹ˆ<code>æ–°h.waitStatus &lt; 0</code>è‚¯å®šæˆç«‹ï¼Œè¿›å…¥ä¸‹ä¸€å±‚åˆ¤æ–­ï¼Œæ‰€ä»¥è¿™é‡Œä¹Ÿå¯èƒ½ä¼šæ‰§è¡Œ<code>doReleaseShared</code>æ–¹æ³•å°è¯•å”¤é†’åç»§èŠ‚ç‚¹ã€‚</li>
<li><code>setHeadAndPropagate</code>çš„æ³¨é‡Šä¸­è¯´æ˜äº†æ­¤æ–¹æ³•ç¡®å®ä¼šå¯¼è‡´<code>ä¸å¿…è¦çš„å”¤é†’æ“ä½œ</code>ã€‚</li>
</ol>
</blockquote>
<h4 id="doreleaseshared">doReleaseShared</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// å”¤é†’åç»§èŠ‚ç‚¹å¹¶ç¡®è®¤ä¼ æ’­
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">doReleaseShared</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// å¾ªç¯æ‰§è¡Œ
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(;;)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// è·å–å¤´èŠ‚ç‚¹ï¼Œæ¥ä¸Šæ–‡ï¼Œæ­¤æ—¶çš„å¤´èŠ‚ç‚¹æ˜¯nodeï¼Œä¸æ˜¯è€çš„headèŠ‚ç‚¹äº†
</span><span style="color:#75715e"></span>        Node h <span style="color:#f92672">=</span> head<span style="color:#f92672">;</span>
        <span style="color:#75715e">// h != null ï¼Œåªè¦é˜Ÿåˆ—åˆå§‹åŒ–è¿‡ï¼Œå°±ä¸€ç›´æˆç«‹
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// h != tail å¦‚æœé˜Ÿåˆ—ä¸­æ·»åŠ è¿‡èŠ‚ç‚¹ï¼Œå°±ä¸€ç›´æˆç«‹
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// è¿™ä¸¤ä¸ªæ¡ä»¶ä¿è¯äº†é˜Ÿåˆ—è‡³å°‘æœ‰ä¸¤ä¸ªnodeï¼Œå…¶ä¸­ä¸€ä¸ªå“¨å…µèŠ‚ç‚¹
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>h <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> h <span style="color:#f92672">!=</span> tail<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">int</span> ws <span style="color:#f92672">=</span> h<span style="color:#f92672">.</span><span style="color:#a6e22e">waitStatus</span><span style="color:#f92672">;</span>
            <span style="color:#75715e">// å¦‚æœheadæ˜¯SIGNALï¼Œå°±æ‰§è¡ŒunparkSuccessor()
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ws <span style="color:#f92672">==</span> Node<span style="color:#f92672">.</span><span style="color:#a6e22e">SIGNAL</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>compareAndSetWaitStatus<span style="color:#f92672">(</span>h<span style="color:#f92672">,</span> Node<span style="color:#f92672">.</span><span style="color:#a6e22e">SIGNAL</span><span style="color:#f92672">,</span> 0<span style="color:#f92672">))</span>
                    <span style="color:#66d9ef">continue</span><span style="color:#f92672">;</span>
                <span style="color:#75715e">// ä¿®æ”¹æˆåŠŸå°±å”¤é†’å¤´èŠ‚ç‚¹çš„æœ‰æ•ˆåç»§èŠ‚ç‚¹
</span><span style="color:#75715e"></span>                unparkSuccessor<span style="color:#f92672">(</span>h<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
            <span style="color:#75715e">// å¦‚æœws == 0è¯´æ˜hçš„åç»§èŠ‚ç‚¹å·²ç»æˆ–å³å°†è¢«å”¤é†’
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// CASè®¾ç½®ä¸ºPROPAGATE
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ws <span style="color:#f92672">==</span> 0 <span style="color:#f92672">&amp;&amp;</span>
                     <span style="color:#f92672">!</span>compareAndSetWaitStatus<span style="color:#f92672">(</span>h<span style="color:#f92672">,</span> 0<span style="color:#f92672">,</span> Node<span style="color:#f92672">.</span><span style="color:#a6e22e">PROPAGATE</span><span style="color:#f92672">))</span>
                <span style="color:#66d9ef">continue</span><span style="color:#f92672">;</span>                <span style="color:#75715e">// loop on failed CAS
</span><span style="color:#75715e"></span>        <span style="color:#f92672">}</span>
        <span style="color:#75715e">// å¦‚æœwaitStatusæ˜¯PROPAGATEç›´æ¥åˆ¤æ–­
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// è·³å‡ºå¾ªç¯çš„å…³é”®: åªè¦æ–°è€headç›¸ç­‰å°±è·³å‡ºå¾ªç¯
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>h <span style="color:#f92672">==</span> head<span style="color:#f92672">)</span>
            <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<p>åªè¦æœ‰çº¿ç¨‹è·å–é”è®¾ç½®äº†<code>æ–°head</code>ï¼Œ<code>h == head</code>å°±ä¼šä¸æˆç«‹å¯¼è‡´å†æ¬¡å¾ªç¯ï¼Œå…¶ç›®çš„æ˜¯ä¸ºäº†æ‰§è¡Œ<code>unparkSuccessor(head)æ¥å”¤é†’æœ‰æ•ˆåç»§èŠ‚ç‚¹</code>ã€‚</p>
</blockquote>
<h3 id="release">release</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">releaseShared</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> arg<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// è°ƒç”¨semaphoreçš„å†…éƒ¨å®ç°å»é‡Šæ”¾é”
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>tryReleaseShared<span style="color:#f92672">(</span>arg<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// å¦‚æœæˆåŠŸå°±å°è¯•å”¤é†’åç»§èŠ‚ç‚¹ä¸”ä¼ æ’­
</span><span style="color:#75715e"></span>        doReleaseShared<span style="color:#f92672">();</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
<span style="color:#75715e">// é‡Šæ”¾å…±äº«é”
</span><span style="color:#75715e"></span><span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">tryReleaseShared</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> releases<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(;;)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// è·å–å½“å‰state
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">int</span> current <span style="color:#f92672">=</span> getState<span style="color:#f92672">();</span>
        <span style="color:#75715e">// å°† state + 1
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">int</span> next <span style="color:#f92672">=</span> current <span style="color:#f92672">+</span> releases<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>next <span style="color:#f92672">&lt;</span> current<span style="color:#f92672">)</span> <span style="color:#75715e">// overflow
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Maximum permit count exceeded&#34;</span><span style="color:#f92672">);</span>
        <span style="color:#75715e">// CASä¿®æ”¹stateæˆåŠŸè¿”å›true
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>compareAndSetState<span style="color:#f92672">(</span>current<span style="color:#f92672">,</span> next<span style="color:#f92672">))</span>
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<ol>
<li>
<p><code>doReleaseShared</code>æ–¹æ³•åœ¨æ­¤ä¸å†èµ˜è¿°ï¼Œå®ƒä¿è¯äº†<code>å¤šçº¿ç¨‹æƒ…å†µä¸‹çš„åç»§èŠ‚ç‚¹èƒ½å¤Ÿæ­£å¸¸è¢«å”¤é†’</code>ã€‚</p>
</li>
<li>
<p><code>tryReleaseShared</code>ç›®çš„å°±æ˜¯ä¸ºäº†æ¢å¤<code>å…±äº«å˜é‡state</code>ã€‚ä¾¿äºåé¢çš„æ–°çº¿ç¨‹è·å–é”ã€‚</p>
</li>
<li>
<p>Sempahoreé‡Šæ”¾é”çš„æ—¶å€™ï¼Œ<code>ä¸æ ¡éªŒä½ æ˜¯å¦æŒæœ‰å…±äº«é”çš„ï¼Œæ‰€ä»¥å¯ä»¥ç†è§£æˆä»»æ„çº¿ç¨‹éƒ½å¯ä»¥é‡Šæ”¾é”ã€‚</code>é‚£ä¹ˆå°±ä¼šå‡ºç°ä½ çš„<code>permitè®¾ç½®ä¸º2ï¼Œå½“ä½ è°ƒç”¨äº†ä¸‰æ¬¡releaseï¼Œä½ çš„stateä¸º3çš„æƒ…å†µã€‚</code></p>
</li>
</ol>
</blockquote>
<blockquote>
<p>å³ä½¿è°ƒç”¨å¤šæ¬¡releaseæ–¹æ³•ä¹Ÿä¸ä¼šäº§ç”Ÿå½±å“ï¼Œå› ä¸ºåœ¨<code>unparkSuccessor</code>æ–¹æ³•ä¸­ï¼Œä¼šå»è·å–nextèŠ‚ç‚¹ï¼Œå¦‚æœæ²¡æœ‰å°±<code>ä»åå¾€å‰æŸ¥æ‰¾æœ‰æ•ˆèŠ‚ç‚¹</code>å†å”¤é†’ï¼Œæ²¡æœ‰æœ‰æ•ˆèŠ‚ç‚¹å°±ä¸ä¼šå”¤é†’ã€‚</p>
</blockquote>
<h3 id="å…±äº«é”æ€»ç»“">å…±äº«é”æ€»ç»“</h3>
<ul>
<li>å…±äº«é”ç›¸æ¯”ç‹¬å é”æœ€å¤§çš„ä¸åŒåœ¨äº<code>setHeadAndPropagate</code> å’Œ <code>doReleaseShared</code>ã€‚</li>
<li><code>setHeadAndPropagate</code> ç”¨äºè®¾ç½®æ–°headï¼ŒåŠä¸€å®šæ¡ä»¶ä¸‹è°ƒç”¨<code>doReleaseShared</code>ï¼Œä¸”è°ƒç”¨<code>doReleaseShared</code>ä¼šå¯¼è‡´çº¿ç¨‹ä¸å¿…è¦çš„å”¤é†’ã€‚</li>
<li><code>doReleaseShared</code>åœ¨è·å–é”å’Œé‡Šæ”¾é”çš„æ—¶å€™éƒ½å¯èƒ½è¢«è°ƒç”¨ï¼Œå› ä¸ºæ˜¯å…±äº«é”ï¼Œå³ä¾¿ä½ è·å–äº†é”ï¼Œåç»§èŠ‚ç‚¹ä¹Ÿæœ‰å¯èƒ½è·å–é”ã€‚</li>
<li><code>PROPAGATE</code>ä¸<code>SIGNAL</code>çš„æ„ä¹‰ç›¸åŒï¼Œéƒ½ä¸ºäº†è®©å”¤é†’çº¿ç¨‹èƒ½æ£€æµ‹åˆ°çŠ¶æ€å˜åŒ–ï¼ŒåŒºåˆ«åœ¨äºå‰è€…<code>åªä½œç”¨äºå…±äº«é”</code>ã€‚</li>
<li>å…±äº«é”æ“ä½œå…±äº«å˜é‡è‚¯å®šä¼šå‡ºç°<code>åŸå­æ€§å’Œæœ‰åºæ€§</code>çš„æƒ…å†µ(<code>permit = 1é™¤å¤–,æ­¤æ—¶æ˜¯ç‰¹æ®Šçš„ç‹¬å é”</code>)ã€‚</li>
</ul>

    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h">å…¶ä»–æ–‡ç« </span>
            <hr />
          </div>
          <div class="pagination__buttons">
            
              <span class="button previous">
                <a href="https://xiaokexiang.github.io/post/readwritelock/">
                  <span class="button__icon">â†</span>
                  <span class="button__text">ReadWriteLock</span>
                </a>
              </span>
            
            
              <span class="button next">
                <a href="https://xiaokexiang.github.io/post/condition/">
                  <span class="button__text">Condition</span>
                  <span class="button__icon">â†’</span>
                </a>
              </span>
            
          </div>
        </div>
      
    


    
      
        

      
    

    </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright copyright--user">è‹ICPå¤‡18050258å·-1</div>
    
  </div>
</footer>

<script src="https://xiaokexiang.github.io/assets/main.js"></script>
<script src="https://xiaokexiang.github.io/assets/prism.js"></script>


      
    </div>

    
  </body>
</html>
