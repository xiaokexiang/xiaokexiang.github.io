<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>AQSä¸ReentrantLockç‹¬å é”</title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="description" content="Lockä¸Synchronizedéƒ½æ˜¯å¯é‡å…¥é”ï¼Œå¦åˆ™ä¼šå‘ç”Ÿæ­»é”ã€‚Locké”æ ¸å¿ƒåœ¨äºAbstractQueueSynchronizerï¼Œåˆåé˜Ÿåˆ—åŒæ­¥å™¨(ç®€ç§°AQS)ã€‚å¦‚æœéœ€è¦å®ç°è‡ªå®šä¹‰é”ï¼Œé™¤äº†éœ€è¦å®ç°Lockæ¥å£å¤–ï¼Œè¿˜éœ€è¦å†…éƒ¨ç±»ç»§æ‰¿Syncç±»ã€‚
AbstractQueueSynchronizer è®°å½•å½“å‰é”çš„æŒæœ‰çº¿ç¨‹ ç”±AQSçš„çˆ¶ç±»AbstractOwnableSynchronizerå®ç°è®°å½•å½“å‰é”çš„æŒæœ‰çº¿ç¨‹åŠŸèƒ½ï¼ˆç‹¬å é”ï¼‰ã€‚
stateå˜é‡ å†…éƒ¨ç»´æŠ¤äº†volatileä¿®é¥°çš„stateå˜é‡ï¼Œstate = 0æ—¶è¡¨æ˜æ²¡æœ‰çº¿ç¨‹è·å–é”ï¼Œstate = 1æ—¶è¡¨æ˜æœ‰ä¸€ä¸ªçº¿ç¨‹è·å–é”ï¼Œå½“state &amp;gt; 1æ—¶ï¼Œè¯´æ˜è¯¥çº¿ç¨‹é‡å…¥äº†è¯¥é”ã€‚
çº¿ç¨‹é˜»å¡å’Œå”¤é†’ ç”±LockSupportç±»å®ç°ï¼Œå…¶åº•å±‚æ˜¯è°ƒç”¨äº†Unsafeçš„park å’Œ unparkã€‚å¦‚æœå½“å‰çº¿ç¨‹æ˜¯éä¸­æ–­çŠ¶æ€ï¼Œè°ƒç”¨park()é˜»å¡ï¼Œè¿”å›ä¸­æ–­çŠ¶æ€æ˜¯falseï¼Œå¦‚æœå½“å‰çº¿ç¨‹æ˜¯ä¸­æ–­çŠ¶æ€ï¼Œè°ƒç”¨park()ä¼šä¸èµ·ä½œç”¨ç«‹å³è¿”å›ã€‚ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆAQSè¦æ¸…ç©ºä¸­æ–­çŠ¶æ€çš„åŸå› ã€‚
FIFOé˜Ÿåˆ— AQSå†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªåŸºäºCLH(Craig, Landin, and Hagersten(CLH)locksã€‚åŸºäºé“¾è¡¨çš„å…¬å¹³çš„è‡ªæ—‹é”)å˜ç§çš„FIFOåŒå‘é“¾è¡¨é˜»å¡é˜Ÿåˆ—ï¼Œåœ¨ç­‰å¾…æœºåˆ¶ä¸Šç”±è‡ªæ—‹æ”¹æˆé˜»å¡å”¤é†’(park/unpark)ã€‚
 è¿˜æœªåˆå§‹åŒ–çš„æ—¶å€™ï¼Œhead = tail = nullï¼Œä¹‹ååˆå§‹åŒ–é˜Ÿåˆ—ï¼Œå¾€å…¶ä¸­å‡å¦‚é˜»å¡çš„çº¿ç¨‹æ—¶ï¼Œä¼šæ–°å»ºä¸€ä¸ªç©ºçš„nodeï¼Œè®©headå’Œtailéƒ½æŒ‡å‘è¿™ä¸ªç©ºnodeã€‚ä¹‹ååŠ å…¥è¢«é˜»å¡çš„çº¿ç¨‹å¯¹è±¡ã€‚å½“head=taiæ—¶å€™è¯´æ˜é˜Ÿåˆ—ä¸ºç©ºã€‚
 Nodeçš„waitStatus    NodeçŠ¶æ€ æè¿°     INIT=0 Nodeåˆå§‹åˆ›å»ºæ—¶é»˜è®¤ä¸º0   CANCELLED=1 ç”±äºè¶…æ—¶æˆ–è€…ä¸­æ–­ï¼Œçº¿ç¨‹è·å–é”çš„è¯·æ±‚å–æ¶ˆäº†ï¼ŒèŠ‚ç‚¹ä¸€æ—¦å˜æˆæ­¤çŠ¶æ€å°±ä¸ä¼šå†å˜åŒ–ã€‚   SIGNAL=-1 è¡¨ç¤ºçº¿ç¨‹å·²ç»å‡†å¤‡å¥½äº†ï¼Œç­‰å¾…èµ„æºé‡Šæ”¾å»è·å–é”ã€‚   CONDITION=-2 è¡¨ç¤ºèŠ‚ç‚¹å¤„äºç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…è¢«å”¤é†’ã€‚   PROPAGATE=-3 åªæœ‰å½“å‰çº¿ç¨‹å¤„äºSHAREDæƒ…å†µä¸‹ï¼Œè¯¥å­—æ®µæ‰ä¼šä½¿ç”¨ï¼Œç”¨äºå…±äº«é”çš„è·å–ã€‚     ReentrentLock æˆ‘ä»¬é€‰æ‹©ReentrentLockä½œä¸ºå…¥å£è¿›è¡Œæºç è§£è¯»ï¼Œè‡ªå®šä¹‰çš„è·å–é‡Šæ”¾é”çš„æ–¹æ³•ï¼Œç”±å…¶å†…éƒ¨æŠ½è±¡ç±»Syncçš„å­ç±»FairSyncå’ŒNonfairSyncä¸­çš„tryAcquireã€tryReleaseå®ç°ã€‚
class Test { private static final ReentrantLock LOCK = new ReentrantLock(); public void run() { LOCK."/>
<meta name="keywords" content=""/>
<meta name="robots" content="noodp"/>
<meta name="google-site-verification" content="e1ELBPEvOV5kwQNtzaLcNt-3iZy83eiNhSZkHhQPecs" />
<meta name="baidu-site-verification" content="aNoX6MUEHW" />
<link rel="canonical" href="https://www.leejay.top/post/reentrantlock/" />

<script type="text/javascript"
        async
        src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"
        >
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\[\[','\]\]']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] },
    'HTML-CSS': {
        showMathMenu: false 
    }
  }
});

MathJax.Hub.Queue(function() {
    
    
    
    var all = MathJax.Hub.getAllJax(), i;
    for(i = 0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
});
</script>

<style>
code.has-jax {
    font: inherit;
    font-size: 100%;
    background: inherit;
    border: inherit;
    color: #515151;
}
.MathJax {
  font-family: 'Fira Code'!important;
  font-weight: bold!important;
  line-height: 2!important;
}
</style>




<link rel="stylesheet" href="https://www.leejay.top/assets/style.css">




<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://www.leejay.top/img/apple-touch-icon-144-precomposed.png">
<link rel="shortcut icon" href="https://www.leejay.top/img/favicon.png">



<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="AQSä¸ReentrantLockç‹¬å é”"/>
<meta name="twitter:description" content="AbstractQueueSynchronizeræ˜¯ä¸€ç§åŒæ­¥æ¡†æ¶ï¼Œè€ŒReentrantLockæ˜¯åŸºäºå®ƒå®ç°çš„`å¯é‡å…¥ç‹¬å é”`ï¼Œå…·æœ‰å…¬å¹³/éå…¬å¹³ä¸¤ç§å®ç°ã€‚"/>



<meta property="og:title" content="AQSä¸ReentrantLockç‹¬å é”" />
<meta property="og:description" content="AbstractQueueSynchronizeræ˜¯ä¸€ç§åŒæ­¥æ¡†æ¶ï¼Œè€ŒReentrantLockæ˜¯åŸºäºå®ƒå®ç°çš„`å¯é‡å…¥ç‹¬å é”`ï¼Œå…·æœ‰å…¬å¹³/éå…¬å¹³ä¸¤ç§å®ç°ã€‚" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.leejay.top/post/reentrantlock/" />
<meta property="article:published_time" content="2020-06-15T15:53:46+08:00" />
<meta property="article:modified_time" content="2020-06-15T15:53:46+08:00" /><meta property="og:site_name" content="Aurora" />






  </head>
  <body class="">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a href="https://www.leejay.top" class="logo" style="text-decoration: none;">
  
    <span class="logo__mark"><svg xmlns="https://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367"/>
</svg></span>
    <span class="logo__text">Aurora</span>
    <span class="logo__cursor"></span>
    <span class="logo__cursor2"></span>
  
</a>
    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/categories">Categories</a></li>
        
      
        
          <li><a href="/tags">Tags</a></li>
        
      
      
    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/categories">Categories</a></li>
      
    
      
        <li><a href="/tags">Tags</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none"/>
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="https://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>
      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  
  

  <div class="post">
    <h1 class="post-title"><a href="https://www.leejay.top/post/reentrantlock/">AQSä¸ReentrantLockç‹¬å é”</a></h1>
    <div class="post-meta">
      
        <span class="post-date">
          2020-06-15
        </span>

        
          
        
      

      
      
    </div>

    
      <span class="post-tags">
        
        ğŸ–<a href="https://www.leejay.top/tags/reentrantlock/">ReentrantLock </a>&nbsp;
        
        ğŸ–<a href="https://www.leejay.top/tags/aqs/">AQS</a>&nbsp;
        
      </span>
    

    

    <div class="post-content">
      
      <p>Lockä¸Synchronizedéƒ½æ˜¯<code>å¯é‡å…¥é”</code>ï¼Œå¦åˆ™ä¼šå‘ç”Ÿæ­»é”ã€‚Locké”æ ¸å¿ƒåœ¨äº<code>AbstractQueueSynchronizer</code>ï¼Œåˆå<code>é˜Ÿåˆ—åŒæ­¥å™¨(ç®€ç§°AQS)</code>ã€‚å¦‚æœéœ€è¦å®ç°è‡ªå®šä¹‰é”ï¼Œé™¤äº†éœ€è¦å®ç°Lockæ¥å£å¤–ï¼Œè¿˜éœ€è¦å†…éƒ¨ç±»ç»§æ‰¿Syncç±»ã€‚</p>
<h3 id="abstractqueuesynchronizer">AbstractQueueSynchronizer</h3>
<p><img src="https://image.leejay.top/image/20200608/GVtL7ztzwtCl.png?imageslim" alt=""></p>
<h4 id="è®°å½•å½“å‰é”çš„æŒæœ‰çº¿ç¨‹">è®°å½•å½“å‰é”çš„æŒæœ‰çº¿ç¨‹</h4>
<p>ç”±AQSçš„çˆ¶ç±»<code>AbstractOwnableSynchronizer</code>å®ç°è®°å½•å½“å‰é”çš„æŒæœ‰çº¿ç¨‹åŠŸèƒ½ï¼ˆç‹¬å é”ï¼‰ã€‚</p>
<h4 id="stateå˜é‡">stateå˜é‡</h4>
<p>å†…éƒ¨ç»´æŠ¤äº†volatileä¿®é¥°çš„stateå˜é‡ï¼Œstate = 0æ—¶è¡¨æ˜æ²¡æœ‰çº¿ç¨‹è·å–é”ï¼Œstate = 1æ—¶è¡¨æ˜æœ‰ä¸€ä¸ªçº¿ç¨‹è·å–é”ï¼Œå½“state &gt; 1æ—¶ï¼Œè¯´æ˜è¯¥çº¿ç¨‹é‡å…¥äº†è¯¥é”ã€‚</p>
<h4 id="çº¿ç¨‹é˜»å¡å’Œå”¤é†’">çº¿ç¨‹é˜»å¡å’Œå”¤é†’</h4>
<p>ç”±<code>LockSupport</code>ç±»å®ç°ï¼Œå…¶åº•å±‚æ˜¯è°ƒç”¨äº†Unsafeçš„park å’Œ unparkã€‚<code>å¦‚æœå½“å‰çº¿ç¨‹æ˜¯éä¸­æ–­çŠ¶æ€ï¼Œè°ƒç”¨park()é˜»å¡ï¼Œè¿”å›ä¸­æ–­çŠ¶æ€æ˜¯falseï¼Œå¦‚æœå½“å‰çº¿ç¨‹æ˜¯ä¸­æ–­çŠ¶æ€ï¼Œè°ƒç”¨park()ä¼šä¸èµ·ä½œç”¨ç«‹å³è¿”å›ã€‚ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆAQSè¦æ¸…ç©ºä¸­æ–­çŠ¶æ€çš„åŸå› </code>ã€‚</p>
<h4 id="fifoé˜Ÿåˆ—">FIFOé˜Ÿåˆ—</h4>
<p>AQSå†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªåŸºäº<code>CLH(Craig, Landin, and Hagersten(CLH)locksã€‚åŸºäºé“¾è¡¨çš„å…¬å¹³çš„è‡ªæ—‹é”)</code>å˜ç§çš„FIFOåŒå‘é“¾è¡¨é˜»å¡é˜Ÿåˆ—ï¼Œåœ¨ç­‰å¾…æœºåˆ¶ä¸Šç”±è‡ªæ—‹æ”¹æˆé˜»å¡å”¤é†’(park/unpark)ã€‚</p>
<p><img src="https://image.leejay.top/image/20200609/CHJldTlsLVp2.png?imageslim" alt=""></p>
<blockquote>
<p>è¿˜æœªåˆå§‹åŒ–çš„æ—¶å€™ï¼Œhead = tail = nullï¼Œä¹‹ååˆå§‹åŒ–é˜Ÿåˆ—ï¼Œå¾€å…¶ä¸­å‡å¦‚é˜»å¡çš„çº¿ç¨‹æ—¶ï¼Œä¼šæ–°å»ºä¸€ä¸ªç©ºçš„nodeï¼Œè®©headå’Œtailéƒ½æŒ‡å‘è¿™ä¸ªç©ºnodeã€‚ä¹‹ååŠ å…¥è¢«é˜»å¡çš„çº¿ç¨‹å¯¹è±¡ã€‚å½“head=taiæ—¶å€™è¯´æ˜é˜Ÿåˆ—ä¸ºç©ºã€‚</p>
</blockquote>
<h4 id="nodeçš„waitstatus">Nodeçš„waitStatus</h4>
<table>
<thead>
<tr>
<th align="left">NodeçŠ¶æ€</th>
<th align="left">æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">INIT=0</td>
<td align="left">Nodeåˆå§‹åˆ›å»ºæ—¶é»˜è®¤ä¸º0</td>
</tr>
<tr>
<td align="left">CANCELLED=1</td>
<td align="left">ç”±äºè¶…æ—¶æˆ–è€…ä¸­æ–­ï¼Œçº¿ç¨‹è·å–é”çš„è¯·æ±‚å–æ¶ˆäº†ï¼ŒèŠ‚ç‚¹ä¸€æ—¦å˜æˆæ­¤çŠ¶æ€å°±ä¸ä¼šå†å˜åŒ–ã€‚</td>
</tr>
<tr>
<td align="left">SIGNAL=-1</td>
<td align="left">è¡¨ç¤ºçº¿ç¨‹å·²ç»å‡†å¤‡å¥½äº†ï¼Œç­‰å¾…èµ„æºé‡Šæ”¾å»è·å–é”ã€‚</td>
</tr>
<tr>
<td align="left">CONDITION=-2</td>
<td align="left">è¡¨ç¤ºèŠ‚ç‚¹å¤„äºç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…è¢«å”¤é†’ã€‚</td>
</tr>
<tr>
<td align="left">PROPAGATE=-3</td>
<td align="left">åªæœ‰å½“å‰çº¿ç¨‹å¤„äºSHAREDæƒ…å†µä¸‹ï¼Œè¯¥å­—æ®µæ‰ä¼šä½¿ç”¨ï¼Œç”¨äºå…±äº«é”çš„è·å–ã€‚</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="reentrentlock">ReentrentLock</h3>
<p>æˆ‘ä»¬é€‰æ‹©<code>ReentrentLock</code>ä½œä¸ºå…¥å£è¿›è¡Œæºç è§£è¯»ï¼Œè‡ªå®šä¹‰çš„è·å–é‡Šæ”¾é”çš„æ–¹æ³•ï¼Œç”±å…¶å†…éƒ¨æŠ½è±¡ç±»Syncçš„å­ç±»FairSyncå’ŒNonfairSyncä¸­çš„tryAcquireã€tryReleaseå®ç°ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Test</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> ReentrantLock LOCK <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ReentrantLock<span style="color:#f92672">();</span>
    
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        LOCK<span style="color:#f92672">.</span><span style="color:#a6e22e">lock</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">//dosomething
</span><span style="color:#75715e"></span>        <span style="color:#f92672">}</span><span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
            LOCK<span style="color:#f92672">.</span><span style="color:#a6e22e">unlock</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>  
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<p>åˆ¤æ–­æ˜¯å¦æˆåŠŸè·å–é”çš„æ ‡å¿—ï¼Œå°±æ˜¯CASä¿®æ”¹volatileä¿®é¥°çš„stateå˜é‡æ˜¯å¦æˆåŠŸã€‚</p>
</blockquote>
<h3 id="å…¬å¹³é”å’Œéå…¬å¹³é”">å…¬å¹³é”å’Œéå…¬å¹³é”</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// éå…¬å¹³é”å®ç°
</span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">NonfairSync</span> <span style="color:#66d9ef">extends</span> Sync <span style="color:#f92672">{</span>
	<span style="color:#66d9ef">final</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">lock</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// å…ˆå°è¯•CASè·å–é”
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>compareAndSetState<span style="color:#f92672">(</span>0<span style="color:#f92672">,</span> 1<span style="color:#f92672">))</span>
            setExclusiveOwnerThread<span style="color:#f92672">(</span>Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">currentThread</span><span style="color:#f92672">());</span>
        <span style="color:#66d9ef">else</span>
            <span style="color:#75715e">// å†æ’é˜Ÿ
</span><span style="color:#75715e"></span>            acquire<span style="color:#f92672">(</span>1<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#f92672">...</span>
<span style="color:#f92672">}</span>
<span style="color:#75715e">// å…¬å¹³é”å®ç°
</span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">FairSync</span> <span style="color:#66d9ef">extends</span> Sync <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">long</span> serialVersionUID <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>3000897897090466540L<span style="color:#f92672">;</span>
	<span style="color:#75715e">// å»æ’é˜Ÿ
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">lock</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        acquire<span style="color:#f92672">(</span>1<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#f92672">...</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<p>å…¬å¹³é”å’Œéå…¬å¹³é”å¦‚ä½•é€‰æ‹©ï¼Ÿ</p>
<p>éå…¬å¹³é”ä¸€è¿›æ¥å°±å°è¯•å»è·å–é”ï¼Œæœ‰æ•ˆçš„å‡å°‘äº†çº¿ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œæ‰€ä»¥ä¸ºäº†è¿½æ±‚<code>é«˜ååé‡</code>å»ºè®®é€‰æ‹©éå…¬å¹³é”ï¼Œä½†æ˜¯ä¼šå¯¼è‡´æŸäº›çº¿ç¨‹é•¿æ—¶é—´åœ¨æ’é˜Ÿï¼Œæ²¡æœ‰æœºä¼šè·å–é”ã€‚å¦åˆ™å»ºè®®é€‰æ‹©å…¬å¹³é”ã€‚</p>
</blockquote>
<h3 id="acquire">acquire</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// å¦‚æœç¬¬ä¸€æ¬¡è·å–é”å¤±è´¥ï¼Œè¯´æ˜æ­¤æ—¶æœ‰å…¶ä»–çº¿ç¨‹æŒæœ‰é”ï¼Œæ‰€ä»¥æ‰§è¡Œacquire
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">acquire</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> arg<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>tryAcquire<span style="color:#f92672">(</span>arg<span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span>
        acquireQueued<span style="color:#f92672">(</span>addWaiter<span style="color:#f92672">(</span>Node<span style="color:#f92672">.</span><span style="color:#a6e22e">EXCLUSIVE</span><span style="color:#f92672">),</span> arg<span style="color:#f92672">))</span>
        selfInterrupt<span style="color:#f92672">();</span>
<span style="color:#f92672">}</span>
</code></pre></div><h4 id="tryacquire">tryAcquire</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// è°ƒç”¨éå…¬å¹³é”çš„tryAcquireï¼Œå†ä¸€æ¬¡å°è¯•å»è·å–é”
</span><span style="color:#75715e"></span><span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">tryAcquire</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> acquires<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> nonfairTryAcquire<span style="color:#f92672">(</span>acquires<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
<span style="color:#75715e">// è¿”å›falseè¡¨æ˜æ²¡æœ‰è·å–åˆ°é”ï¼Œtrueè¡¨æ˜æˆåŠŸè·å–é”/é‡å…¥é”
</span><span style="color:#75715e"></span><span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">nonfairTryAcquire</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> acquires<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// è·å–å½“å‰çº¿ç¨‹
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">final</span> Thread current <span style="color:#f92672">=</span> Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">currentThread</span><span style="color:#f92672">();</span>
    <span style="color:#75715e">// è·å–stateçŠ¶æ€
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> c <span style="color:#f92672">=</span> getState<span style="color:#f92672">();</span>
    <span style="color:#75715e">// å¦‚æœstateæ˜¯0ï¼Œè¡¨æ˜å½“å‰æ²¡æœ‰çº¿ç¨‹è·å–é”
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>c <span style="color:#f92672">==</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// å°è¯•å»è·å–é”ï¼Œè·å–æˆåŠŸå°±è®¾ç½®ç‹¬å çº¿ç¨‹ä¸ºå½“å‰çº¿ç¨‹
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>compareAndSetState<span style="color:#f92672">(</span>0<span style="color:#f92672">,</span> acquires<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            setExclusiveOwnerThread<span style="color:#f92672">(</span>current<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    <span style="color:#75715e">// å¦‚æœå½“å‰çº¿ç¨‹å·²ç»æ˜¯ç‹¬å çº¿ç¨‹ï¼Œæ­¤æ—¶è¯´æ˜é”é‡å…¥äº†
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>current <span style="color:#f92672">==</span> getExclusiveOwnerThread<span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// ä¿®æ”¹stateçš„å€¼
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">int</span> nextc <span style="color:#f92672">=</span> c <span style="color:#f92672">+</span> acquires<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>nextc <span style="color:#f92672">&lt;</span> 0<span style="color:#f92672">)</span>
            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Maximum lock count exceeded&#34;</span><span style="color:#f92672">);</span>
        <span style="color:#75715e">// è®¾ç½®stateå€¼ï¼Œå› ä¸ºæ­¤æ—¶çš„è·å–é”çš„çº¿ç¨‹å°±æ˜¯å½“å‰çº¿ç¨‹
</span><span style="color:#75715e"></span>        setState<span style="color:#f92672">(</span>nextc<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
<span style="color:#75715e">// å…¬å¹³é”çš„tryAcquireå®ç°
</span><span style="color:#75715e"></span><span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">tryAcquire</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> acquires<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#f92672">...</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>c <span style="color:#f92672">==</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// hasQueuedPredecessorsæ˜¯å…¬å¹³é”çš„ä¸»è¦ä½“ç°
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>hasQueuedPredecessors<span style="color:#f92672">()</span> <span style="color:#f92672">&amp;&amp;</span>
                compareAndSetState<span style="color:#f92672">(</span>0<span style="color:#f92672">,</span> acquires<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                setExclusiveOwnerThread<span style="color:#f92672">(</span>current<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">...</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<p>Q:  ä¸ºä»€ä¹ˆæœ‰çš„åœ°æ–¹ä½¿ç”¨setState()ï¼Œæœ‰çš„åœ°æ–¹ä½¿ç”¨CASï¼Ÿ</p>
<p>A:  å› ä¸ºä½¿ç”¨setState()æ–¹æ³•çš„å‰ææ˜¯å·²ç»è·å–äº†é”ï¼Œä½¿ç”¨äº†CASçš„æ˜¯å› ä¸ºæ­¤æ—¶è¿˜æ²¡æœ‰è·å–é”ã€‚</p>
</blockquote>
<h4 id="hasqueuedpredecessors">hasQueuedPredecessors</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// true/false æœ‰èŠ‚ç‚¹åœ¨ç­‰å¾…/æ— èŠ‚ç‚¹ç­‰å¾…
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">hasQueuedPredecessors</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// è¿™é‡Œä¸ºä»€ä¹ˆtailè·å–åœ¨headä¹‹å‰ï¼Ÿ
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// å‡è®¾ç¬¬ä¸€ä¸ªèŠ‚ç‚¹å…¥é˜Ÿï¼Œæ ¹æ®enq()è®¾ç½®headå’Œtailå¯çŸ¥
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// å¦‚æœæ­¤å¤„tail = nullï¼Œhead = null | head != nulléƒ½æœ‰å¯èƒ½
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// å¦‚æœæ­¤å¤„tail != null ï¼Œé‚£ä¹ˆ(head = tail) != null
</span><span style="color:#75715e"></span>    Node t <span style="color:#f92672">=</span> tail<span style="color:#f92672">;</span>
    Node h <span style="color:#f92672">=</span> head<span style="color:#f92672">;</span>
    Node s<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">return</span> h <span style="color:#f92672">!=</span> t <span style="color:#f92672">&amp;&amp;</span>
        <span style="color:#75715e">// (s = h.next) == null æˆç«‹è¯´æ˜æœ‰å…¶ä»–çº¿ç¨‹æ­£åœ¨åˆå§‹åŒ–é˜Ÿåˆ—
</span><span style="color:#75715e"></span>        <span style="color:#f92672">((</span>s <span style="color:#f92672">=</span> h<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">)</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> s<span style="color:#f92672">.</span><span style="color:#a6e22e">thread</span> <span style="color:#f92672">!=</span> Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">currentThread</span><span style="color:#f92672">());</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<p>è¿”å›æƒ…å†µåˆ†æï¼š</p>
<ol>
<li>
<p>è‹¥<code>h == t</code>è¯´æ˜æ­¤æ—¶é˜Ÿåˆ—è¿˜æ²¡æœ‰åˆå§‹åŒ–æˆ–åªæœ‰å“¨å…µèŠ‚ç‚¹ï¼Œè¿”å›falseè¡¨æ˜æ— ç­‰å¾…èŠ‚ç‚¹ã€‚</p>
</li>
<li>
<p>è‹¥<code>h != t</code>æˆç«‹ï¼Œè¯´æ˜æ­¤æ—¶é˜Ÿåˆ—æœ‰èŠ‚ç‚¹å•Šï¼Œé‚£<code>((s = h.next) == null)</code>åº”è¯¥ä¹Ÿæˆç«‹å•Šï¼Ÿ
å…¶å®ä¸ç„¶ï¼Œæˆ‘ä»¬å‡è®¾çº¿ç¨‹Aè·å–é”å¤±è´¥ï¼Œå°è¯•åŠ å…¥é˜Ÿåˆ—ï¼Œæ­¤æ—¶é˜Ÿåˆ—è¿˜æœªåˆå§‹åŒ–ï¼ŒAæ‰§è¡Œåˆ°enqæ–¹æ³•ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">private</span> Node <span style="color:#a6e22e">enq</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> Node node<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(;;)</span> <span style="color:#f92672">{</span>
        Node t <span style="color:#f92672">=</span> tail<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>t <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// çº¿ç¨‹Aå‡†å¤‡åˆå§‹åŒ–é˜Ÿåˆ—ï¼Œå®ƒsetHead(new Node())æˆåŠŸäº†
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// æ­¤æ—¶çº¿ç¨‹åˆ‡æ¢ï¼Œçº¿ç¨‹Bæ‰§è¡Œäº†hasQueuedPredecessors()
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// æ­¤æ—¶ head != null; tail = null; head.next = null
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// æ­¤æ—¶h != t ä¸” (s = h.next) = null
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>compareAndSetHead<span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Node<span style="color:#f92672">()))</span>
                tail <span style="color:#f92672">=</span> head<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
            node<span style="color:#f92672">.</span><span style="color:#a6e22e">prev</span> <span style="color:#f92672">=</span> t<span style="color:#f92672">;</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>compareAndSetTail<span style="color:#f92672">(</span>t<span style="color:#f92672">,</span> node<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                t<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span> <span style="color:#f92672">=</span> node<span style="color:#f92672">;</span>
                <span style="color:#66d9ef">return</span> t<span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div></li>
<li>
<p>è‹¥<code>((s = h.next) == null)</code>æˆç«‹ï¼Œè¯´æ˜æ­¤æ—¶å­˜åœ¨å¦ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œåˆ°<code>compareAndSetHead(new Node())</code>å’Œ<code>tail = head</code>çš„ä¸­é—´çŠ¶æ€ã€‚æ‰€ä»¥ä¹Ÿéœ€è¦è¿”å›trueï¼Œè¡¨æ˜æœ‰èŠ‚ç‚¹åœ¨ç­‰å¾…ã€‚</p>
</li>
<li>
<p>è‹¥<code>((s = h.next) == null)</code>ä¸æˆç«‹ï¼Œæˆ‘ä»¬ç»§ç»­åˆ¤æ–­é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªç­‰å¾…çº¿ç¨‹ï¼ˆ<code>s.thread != Thread.currentThread()</code>ï¼‰æ˜¯å¦æ˜¯å½“å‰çº¿ç¨‹ï¼Œæ˜¯å°±è¿”å›trueï¼Œå¦åˆ™è¿”å›falseã€‚</p>
</li>
<li>
<p>æ–¹æ³•ä¸­ä¸ºä»€ä¹ˆ<code>Node t = tail</code>è·å–åœ¨<code>Node h = head</code>ä¹‹å‰ï¼Ÿ
æ ¹æ®ä¸Šé¢çš„åˆ†æï¼Œæˆ‘ä»¬çŸ¥é“ç¬¬ä¸€ä¸ªèŠ‚ç‚¹å…¥é˜Ÿçš„æ—¶å€™ä¼šå‡ºç°<code>head != null ä½† tail = null</code>çš„æƒ…å†µï¼Œå› ä¸ºæ˜¯<code>å…ˆè®¾ç½®headå†è®¾ç½®tail</code>ï¼Œæ“ä½œéåŸå­æ€§ã€‚
æˆ‘ä»¬å‡è®¾<code>é˜Ÿåˆ—æœªåˆå§‹åŒ–</code>ï¼ŒhasQueuedPredecessorsæ–¹æ³•ä¸­<code>tailå’Œheadä»£ç ä½ç½®äº’æ¢</code>ï¼Œçº¿ç¨‹Aå…ˆæ‰§è¡Œ<code>Node h = head;</code>æ­¤æ—¶<code>head = null</code>ï¼Œçº¿ç¨‹åˆ‡æ¢ï¼Œçº¿ç¨‹Bæ‰§è¡Œenqæ–¹æ³•åˆå§‹åŒ–é˜Ÿåˆ—å¯¼è‡´<code>ï¼ˆhead = tailï¼‰!= null</code>ï¼Œåˆåˆ‡å›çº¿ç¨‹Aï¼Œæ‰§è¡Œ<code>Node t = tail</code>ï¼Œ<code>tail != null</code>ï¼Œåˆ¤æ–­ä»£ç <code>h != t</code>æˆç«‹ï¼Œç»§ç»­åˆ¤æ–­<code>(s = h.next) == null</code>å‡ºé—®é¢˜äº†ï¼Œ<code>h =null,h.nextä¼šæŠ›ç©ºæŒ‡é’ˆ!!!</code>ï¼Œè¿™å°±æ˜¯é—®é¢˜æ‰€åœ¨ã€‚(å†æ¬¡è†œæ‹œDoug leaï¼ï¼ï¼)</p>
</li>
</ol>
</blockquote>
<h4 id="addwaiter">addWaiter</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// è·å–ä¸åˆ°é”ï¼Œå°†å½“å‰çº¿ç¨‹æ„å»ºæˆnodeå¯¹è±¡åŠ å…¥é˜Ÿåˆ—
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> Node <span style="color:#a6e22e">addWaiter</span><span style="color:#f92672">(</span>Node mode<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// åˆ›å»ºnodeå¯¹è±¡(currentThread, Node.EXCLUSIVE)
</span><span style="color:#75715e"></span>    Node node <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Node<span style="color:#f92672">(</span>Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">currentThread</span><span style="color:#f92672">(),</span> mode<span style="color:#f92672">);</span>
    Node pred <span style="color:#f92672">=</span> tail<span style="color:#f92672">;</span>
    <span style="color:#75715e">// å¦‚æœå°¾èŠ‚ç‚¹ä¸ç­‰äºnullï¼Œè¯´æ˜é˜Ÿåˆ—ä¸ä¸ºç©º
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>pred <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// è®¾ç½®nodeçš„prevä¸ºå°¾èŠ‚ç‚¹
</span><span style="color:#75715e"></span>        node<span style="color:#f92672">.</span><span style="color:#a6e22e">prev</span> <span style="color:#f92672">=</span> pred<span style="color:#f92672">;</span>
        <span style="color:#75715e">// å¦‚æœæ­¤æ—¶æœ‰ä¸¤ä¸ªçº¿ç¨‹å°è¯•ç”¨å°†nodeè®¾ç½®ä¸ºtailå°¾èŠ‚ç‚¹
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// æ‰€ä»¥éœ€è¦CASä¿è¯åªæœ‰ä¸€ä¸ªè®¾ç½®æˆåŠŸï¼Œå¦ä¸€ä¸ªæ‰§è¡Œä¸‹é¢çš„enq()åŠ å…¥é˜Ÿåˆ—
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>compareAndSetTail<span style="color:#f92672">(</span>pred<span style="color:#f92672">,</span> node<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// è®¾ç½®æˆåŠŸåï¼Œæ·»åŠ nextæŒ‡é’ˆæŒ‡å‘node
</span><span style="color:#75715e"></span>            pred<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span> <span style="color:#f92672">=</span> node<span style="color:#f92672">;</span>
            <span style="color:#66d9ef">return</span> node<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    <span style="color:#75715e">// å°¾èŠ‚ç‚¹ä¸ºnull æˆ– æ’å…¥å°¾èŠ‚ç‚¹å¤±è´¥
</span><span style="color:#75715e"></span>    enq<span style="color:#f92672">(</span>node<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">return</span> node<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
<span style="color:#75715e">// å¾ªç¯æ‰§è¡Œæ’å…¥æ“ä½œï¼Œç›´åˆ°æ’å…¥é˜Ÿå°¾æˆåŠŸ
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> Node <span style="color:#a6e22e">enq</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> Node node<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(;;)</span> <span style="color:#f92672">{</span>
        Node t <span style="color:#f92672">=</span> tail<span style="color:#f92672">;</span>
        <span style="color:#75715e">// å¦‚æœå°¾èŠ‚ç‚¹æ˜¯nullï¼Œè¯´æ˜é˜Ÿåˆ—è¿˜æ²¡æœ‰åˆå§‹åŒ–
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>t <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// å°†headè®¾ç½®æˆç©ºnodeï¼Œå¹¶ä¸”tail=head(è¯´æ˜æ­¤æ—¶é˜Ÿåˆ—åˆå§‹åŒ–äº†ä½†è¿˜æ²¡æœ‰èŠ‚ç‚¹)
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>compareAndSetHead<span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Node<span style="color:#f92672">()))</span>
                tail <span style="color:#f92672">=</span> head<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// t!=nullï¼Œè®¾ç½®node.prev=t
</span><span style="color:#75715e"></span>            node<span style="color:#f92672">.</span><span style="color:#a6e22e">prev</span> <span style="color:#f92672">=</span> t<span style="color:#f92672">;</span>
            <span style="color:#75715e">// CASè®¾ç½®nodeåˆ°é˜Ÿå°¾ï¼Œå¦‚æœä¸æˆåŠŸç»§ç»­å¾ªç¯è·å–tailç›´åˆ°è®¾ç½®æˆåŠŸ
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>compareAndSetTail<span style="color:#f92672">(</span>t<span style="color:#f92672">,</span> node<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// CASæˆåŠŸï¼Œè®¾ç½®tçš„nextå±æ€§
</span><span style="color:#75715e"></span>                t<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span> <span style="color:#f92672">=</span> node<span style="color:#f92672">;</span>
                <span style="color:#75715e">// è·³å‡ºå¾ªç¯è¿”å›nodeçš„å‰é©±èŠ‚ç‚¹
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">return</span> t<span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h4 id="acquirequeued">acquireQueued</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// è‡³æ­¤nodeå·²ç»æ’å…¥é˜Ÿåˆ—æˆåŠŸï¼Œå¹¶è¿”å›
</span><span style="color:#75715e"></span><span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">acquireQueued</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> Node node<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> arg<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">boolean</span> failed <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">boolean</span> interrupted <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(;;)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// è·å–nodeçš„å‰ç»§èŠ‚ç‚¹
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">final</span> Node p <span style="color:#f92672">=</span> node<span style="color:#f92672">.</span><span style="color:#a6e22e">predecessor</span><span style="color:#f92672">();</span>
            <span style="color:#75715e">// å¦‚æœnodeçš„å‰ç»§èŠ‚ç‚¹æ˜¯å¤´èŠ‚ç‚¹ï¼Œåˆ™nodeå°è¯•å»è·å–é”
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// tryAcquire(arg)ä¼šæŠ›å‡ºå¼‚å¸¸
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>p <span style="color:#f92672">==</span> head <span style="color:#f92672">&amp;&amp;</span> tryAcquire<span style="color:#f92672">(</span>arg<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// è·å–é”æˆåŠŸï¼Œè®¾ç½®å¤´èŠ‚ç‚¹ä¸ºnodeï¼Œå¹¶æ¸…ç©ºthreadå’Œprevå±æ€§
</span><span style="color:#75715e"></span>                setHead<span style="color:#f92672">(</span>node<span style="color:#f92672">);</span>
                <span style="color:#75715e">// æ–¹ä¾¿å›æ”¶å‰ç»§èŠ‚ç‚¹p
</span><span style="color:#75715e"></span>                p<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
                <span style="color:#75715e">// ä¿®æ”¹failedå‚æ•°
</span><span style="color:#75715e"></span>                failed <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
                <span style="color:#75715e">// è·³å‡ºå¾ªç¯å¹¶è¿”å›
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">return</span> interrupted<span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
            <span style="color:#75715e">// å¦‚æœå‰ç»§èŠ‚ç‚¹ä¸æ˜¯headèŠ‚ç‚¹ æˆ– å‰ç»§èŠ‚ç‚¹æ˜¯headèŠ‚ç‚¹ä½†è·å–ä¸åˆ°é”
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// åˆ¤æ–­æ˜¯å¦éœ€è¦æŒ‚èµ·,å¦‚æœé˜»å¡èŠ‚ç‚¹è¢«å”¤é†’ï¼Œè¿˜ä¼šç»§ç»­å¾ªç¯è·å–ï¼Œç›´åˆ°è·å–é”æ‰return
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>shouldParkAfterFailedAcquire<span style="color:#f92672">(</span>p<span style="color:#f92672">,</span> node<span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span>
                parkAndCheckInterrupt<span style="color:#f92672">())</span>
                interrupted <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// å¦‚æœè·³å‡ºå¾ªç¯ï¼Œfailed=falseï¼Œä¸è·³å‡ºå¾ªç¯ä¹Ÿä¸ä¼šæ‰§è¡Œåˆ°è¿™é‡Œ
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// ä¹Ÿå°±æ˜¯åªæœ‰tryAcquire(arg)å‘ç”Ÿå¼‚å¸¸äº†æ‰ä¼šæ‰§è¡ŒcancelAcquire()
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>failed<span style="color:#f92672">)</span>
            cancelAcquire<span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">final</span> Node <span style="color:#a6e22e">predecessor</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> NullPointerException <span style="color:#f92672">{</span>
    <span style="color:#75715e">// è·å–nodeçš„prevèŠ‚ç‚¹p
</span><span style="color:#75715e"></span>    Node p <span style="color:#f92672">=</span> prev<span style="color:#f92672">;</span>
    <span style="color:#75715e">// å¦‚æœpä¸ºnullåˆ™æŠ›å‡ºå¼‚å¸¸ï¼Œè¿™é‡Œçš„ç©ºæŒ‡é’ˆä¸€èˆ¬ä¸ä¼šç”Ÿæ•ˆï¼Œåªæ˜¯ä¸ºäº†å¸®åŠ©è™šæ‹Ÿæœº
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>p <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> NullPointerException<span style="color:#f92672">();</span>
    <span style="color:#66d9ef">else</span>
    <span style="color:#75715e">// å¦åˆ™è¿”å›å‰ç»§èŠ‚ç‚¹p
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span> p<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
<span style="color:#75715e">// å°†nodeèŠ‚ç‚¹è®¾ç½®ä¸ºheadå¤´èŠ‚ç‚¹ï¼Œè·å–é”ä¹‹åéƒ½ä¼šå°†å¤´èŠ‚ç‚¹ç›¸å…³ä¿¡æ¯æ¸…é™¤
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setHead</span><span style="color:#f92672">(</span>Node node<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    head <span style="color:#f92672">=</span> node<span style="color:#f92672">;</span>
    node<span style="color:#f92672">.</span><span style="color:#a6e22e">thread</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
    node<span style="color:#f92672">.</span><span style="color:#a6e22e">prev</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e">// åˆ¤æ–­è·å–é”å¤±è´¥ä¹‹åæ˜¯å¦éœ€è¦park
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">shouldParkAfterFailedAcquire</span><span style="color:#f92672">(</span>Node pred<span style="color:#f92672">,</span> Node node<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// è·å–nodeå‰ç»§èŠ‚ç‚¹çš„waitStatusï¼Œé»˜è®¤æƒ…å†µä¸‹å€¼ä¸º0
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> ws <span style="color:#f92672">=</span> pred<span style="color:#f92672">.</span><span style="color:#a6e22e">waitStatus</span><span style="color:#f92672">;</span>
    <span style="color:#75715e">// å¦‚æœæ˜¯signalï¼Œè¯´æ˜å‰ç»§èŠ‚ç‚¹å·²ç»å‡†å¤‡å°±ç»ªï¼Œç­‰å¾…è¢«å ç”¨çš„èµ„æºé‡Šæ”¾
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ws <span style="color:#f92672">==</span> Node<span style="color:#f92672">.</span><span style="color:#a6e22e">SIGNAL</span><span style="color:#f92672">)</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
    <span style="color:#75715e">// å¦‚æœå‰ç»§èŠ‚ç‚¹waitStatus&gt;0ï¼Œè¯´æ˜æ˜¯Cancel
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ws <span style="color:#f92672">&gt;</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">do</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// è·å–å‰ç»§èŠ‚ç‚¹çš„å‰ç»§èŠ‚ç‚¹ï¼Œç›´åˆ°å®ƒçš„çŠ¶æ€&gt;0(ç›´åˆ°å‰ç»§èŠ‚ç‚¹ä¸æ˜¯cancelèŠ‚ç‚¹)
</span><span style="color:#75715e"></span>            node<span style="color:#f92672">.</span><span style="color:#a6e22e">prev</span> <span style="color:#f92672">=</span> pred <span style="color:#f92672">=</span> pred<span style="color:#f92672">.</span><span style="color:#a6e22e">prev</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>pred<span style="color:#f92672">.</span><span style="color:#a6e22e">waitStatus</span> <span style="color:#f92672">&gt;</span> 0<span style="color:#f92672">);</span>
        <span style="color:#75715e">// å°†ä¸æ˜¯cancelçš„èŠ‚ç‚¹ä¸nodeç›¸è¿
</span><span style="color:#75715e"></span>        pred<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span> <span style="color:#f92672">=</span> node<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// å°è¯•å°†å‰ç»§èŠ‚ç‚¹predè®¾ç½®æˆsignalçŠ¶æ€ï¼Œè®¾ç½®signalçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// åœ¨è§£é”çš„æ—¶å€™åªæœ‰head!=nullä¸”ä¸ºsignalçŠ¶æ€æ‰ä¼šå”¤é†’headçš„ä¸‹ä¸ªèŠ‚ç‚¹
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// å¦‚æœpredçŠ¶æ€è®¾ç½®æˆåŠŸï¼Œç¬¬äºŒæ¬¡å°±ä¼šè¿›å…¥ws == Node.SIGNALï¼Œè¿”å›true
</span><span style="color:#75715e"></span>        compareAndSetWaitStatus<span style="color:#f92672">(</span>pred<span style="color:#f92672">,</span> ws<span style="color:#f92672">,</span> Node<span style="color:#f92672">.</span><span style="color:#a6e22e">SIGNAL</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e">// å°†çº¿ç¨‹æŒ‚èµ·å¹¶æ£€æŸ¥æ˜¯å¦è¢«ä¸­æ–­
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">parkAndCheckInterrupt</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// æŒ‚æœºå½“å‰çº¿ç¨‹ï¼Œä¸ä¼šå¾€ä¸‹æ‰§è¡Œäº†
</span><span style="color:#75715e"></span>    LockSupport<span style="color:#f92672">.</span><span style="color:#a6e22e">park</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
    <span style="color:#75715e">// å¾€ä¸‹æ‰§è¡Œçš„æ¡ä»¶: unpark(t)æˆ–è¢«ä¸­æ–­
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// è¿”å›ä¸­æ–­çŠ¶æ€(å¹¶æ¸…ç©ºä¸­æ–­çŠ¶æ€)
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">return</span> Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">interrupted</span><span style="color:#f92672">();</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<p>LockSupport.park()é™¤äº†<code>èƒ½å¤Ÿè¢«unpark()å”¤é†’ï¼Œè¿˜ä¼šå“åº”interrupt()æ‰“æ–­</code>ï¼Œä½†æ˜¯Locké”ä¸èƒ½å“åº”ä¸­æ–­ï¼Œå¦‚æœæ˜¯unparkï¼Œä¼šè¿”å›falseï¼Œå¦‚æœæ˜¯interruptåˆ™è¿”å›trueã€‚</p>
</blockquote>
<h4 id="cancelacquire">cancelAcquire</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// èŠ‚ç‚¹å–æ¶ˆè·å–é”
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">cancelAcquire</span><span style="color:#f92672">(</span>Node node<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      <span style="color:#75715e">// å¿½ç•¥ä¸å­˜åœ¨çš„node
</span><span style="color:#75715e"></span>      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>node <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
          <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
  	<span style="color:#75715e">// æ¸…ç©ºnodeçš„threadå±æ€§
</span><span style="color:#75715e"></span>      node<span style="color:#f92672">.</span><span style="color:#a6e22e">thread</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
  
      <span style="color:#75715e">// è·å–nodeçš„ä¸æ˜¯cancelçš„å‰ç»§èŠ‚ç‚¹
</span><span style="color:#75715e"></span>      Node pred <span style="color:#f92672">=</span> node<span style="color:#f92672">.</span><span style="color:#a6e22e">prev</span><span style="color:#f92672">;</span>
      <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>pred<span style="color:#f92672">.</span><span style="color:#a6e22e">waitStatus</span> <span style="color:#f92672">&gt;</span> 0<span style="color:#f92672">)</span>
          node<span style="color:#f92672">.</span><span style="color:#a6e22e">prev</span> <span style="color:#f92672">=</span> pred <span style="color:#f92672">=</span> pred<span style="color:#f92672">.</span><span style="color:#a6e22e">prev</span><span style="color:#f92672">;</span>
  
      <span style="color:#75715e">// è·å–æœ‰æ•ˆå‰ç»§èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹
</span><span style="color:#75715e"></span>      Node predNext <span style="color:#f92672">=</span> pred<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">;</span>
  
      <span style="color:#75715e">// è®¾ç½®nodeèŠ‚ç‚¹ä¸ºcancelçŠ¶æ€
</span><span style="color:#75715e"></span>      node<span style="color:#f92672">.</span><span style="color:#a6e22e">waitStatus</span> <span style="color:#f92672">=</span> Node<span style="color:#f92672">.</span><span style="color:#a6e22e">CANCELLED</span><span style="color:#f92672">;</span>
  
      <span style="color:#75715e">// å¦‚æœnodeæ˜¯tailå°¾èŠ‚ç‚¹ï¼Œå°†pred(écancelèŠ‚ç‚¹)è®¾ç½®ä¸ºå°¾èŠ‚ç‚¹
</span><span style="color:#75715e"></span>      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>node <span style="color:#f92672">==</span> tail <span style="color:#f92672">&amp;&amp;</span> compareAndSetTail<span style="color:#f92672">(</span>node<span style="color:#f92672">,</span> pred<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
          <span style="color:#75715e">// è®¾ç½®å°¾èŠ‚ç‚¹predçš„nextæŒ‡é’ˆä¸ºnull
</span><span style="color:#75715e"></span>          compareAndSetNext<span style="color:#f92672">(</span>pred<span style="color:#f92672">,</span> predNext<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
      <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
          <span style="color:#66d9ef">int</span> ws<span style="color:#f92672">;</span>
          <span style="color:#75715e">// å¦‚æœnodeä¸æ˜¯tailå°¾èŠ‚ç‚¹
</span><span style="color:#75715e"></span>          <span style="color:#75715e">// 1.predä¸æ˜¯å¤´èŠ‚ç‚¹
</span><span style="color:#75715e"></span>          <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>pred <span style="color:#f92672">!=</span> head <span style="color:#f92672">&amp;&amp;</span>
              <span style="color:#75715e">// 2.å¦‚æœä¸æ˜¯åˆ™åˆ¤æ–­å‰ç»§èŠ‚ç‚¹çŠ¶æ€æ˜¯å¦æ˜¯signal
</span><span style="color:#75715e"></span>              <span style="color:#f92672">((</span>ws <span style="color:#f92672">=</span> pred<span style="color:#f92672">.</span><span style="color:#a6e22e">waitStatus</span><span style="color:#f92672">)</span> <span style="color:#f92672">==</span> Node<span style="color:#f92672">.</span><span style="color:#a6e22e">SIGNAL</span> <span style="color:#f92672">||</span>
               <span style="color:#75715e">// 3.å¦‚æœä¸æ˜¯signalåˆ™å°è¯•å°†predå‰ç»§èŠ‚ç‚¹è®¾ç½®ä¸ºsignal
</span><span style="color:#75715e"></span>               <span style="color:#f92672">(</span>ws <span style="color:#f92672">&lt;=</span> 0 <span style="color:#f92672">&amp;&amp;</span> compareAndSetWaitStatus<span style="color:#f92672">(</span>pred<span style="color:#f92672">,</span> ws<span style="color:#f92672">,</span> Node<span style="color:#f92672">.</span><span style="color:#a6e22e">SIGNAL</span><span style="color:#f92672">)))</span> <span style="color:#f92672">&amp;&amp;</span>
              <span style="color:#75715e">// 4.åˆ¤æ–­å‰ç»§èŠ‚ç‚¹çº¿ç¨‹ä¿¡æ¯æ˜¯å¦ä¸ºnull
</span><span style="color:#75715e"></span>              pred<span style="color:#f92672">.</span><span style="color:#a6e22e">thread</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
              <span style="color:#75715e">// 1ï¼Œ2/3ï¼Œ4æ¡ä»¶æ»¡è¶³ï¼Œè·å–nodeçš„åç»§èŠ‚ç‚¹
</span><span style="color:#75715e"></span>              Node next <span style="color:#f92672">=</span> node<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">;</span>
              <span style="color:#75715e">// å¦‚æœåç»§èŠ‚ç‚¹ä¸ä¸ºnullä¸”waitStatus&lt;=0
</span><span style="color:#75715e"></span>              <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>next <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> next<span style="color:#f92672">.</span><span style="color:#a6e22e">waitStatus</span> <span style="color:#f92672">&lt;=</span> 0<span style="color:#f92672">)</span>
                  <span style="color:#75715e">// å°†nodeçš„å‰ç»§èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹æ”¹æˆnodeçš„åç»§èŠ‚ç‚¹
</span><span style="color:#75715e"></span>                  compareAndSetNext<span style="color:#f92672">(</span>pred<span style="color:#f92672">,</span> predNext<span style="color:#f92672">,</span> next<span style="color:#f92672">);</span>
          <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
              <span style="color:#75715e">// å¦‚æœnodeå‰ç»§ä¸æ˜¯head &amp; ä¹Ÿä¸æ˜¯tail
</span><span style="color:#75715e"></span>              unparkSuccessor<span style="color:#f92672">(</span>node<span style="color:#f92672">);</span>
          <span style="color:#f92672">}</span>
  		<span style="color:#75715e">// å°†nodeçš„åç»§èŠ‚ç‚¹è®¾ç½®ä¸ºè‡ªèº«ï¼Œæ–¹ä¾¿å›æ”¶
</span><span style="color:#75715e"></span>          node<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span> <span style="color:#f92672">=</span> node<span style="color:#f92672">;</span>
      <span style="color:#f92672">}</span>
  <span style="color:#f92672">}</span>
  <span style="color:#75715e">// å”¤é†’headèŠ‚ç‚¹åä¸ä¸ºcancelçš„énullèŠ‚ç‚¹
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">unparkSuccessor</span><span style="color:#f92672">(</span>Node node<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      <span style="color:#66d9ef">int</span> ws <span style="color:#f92672">=</span> node<span style="color:#f92672">.</span><span style="color:#a6e22e">waitStatus</span><span style="color:#f92672">;</span>
      <span style="color:#75715e">// å¦‚æœnode.waitStatus &lt; 0 ï¼Œå°†å…¶è®¾ç½®ä¸º0(åˆå§‹çŠ¶æ€)
</span><span style="color:#75715e"></span>      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ws <span style="color:#f92672">&lt;</span> 0<span style="color:#f92672">)</span>
          compareAndSetWaitStatus<span style="color:#f92672">(</span>node<span style="color:#f92672">,</span> ws<span style="color:#f92672">,</span> 0<span style="color:#f92672">);</span>
  	<span style="color:#75715e">// è·å–nodeçš„åç»§èŠ‚ç‚¹
</span><span style="color:#75715e"></span>      Node s <span style="color:#f92672">=</span> node<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">;</span>
      <span style="color:#75715e">// å¦‚æœåç»§èŠ‚ç‚¹ä¸ºnullæˆ–æ˜¯cancelï¼Œå¾ªç¯æŸ¥æ‰¾ç›´åˆ°ä¸ç¬¦åˆè¯¥æ¡ä»¶çš„node
</span><span style="color:#75715e"></span>      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>s <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> s<span style="color:#f92672">.</span><span style="color:#a6e22e">waitStatus</span> <span style="color:#f92672">&gt;</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
          s <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
          <span style="color:#75715e">// é‡ç‚¹ï¼šä»é˜Ÿå°¾å¾€å‰æ‰¾ï¼ï¼ï¼ï¼
</span><span style="color:#75715e"></span>          <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Node t <span style="color:#f92672">=</span> tail<span style="color:#f92672">;</span> t <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> t <span style="color:#f92672">!=</span> node<span style="color:#f92672">;</span> t <span style="color:#f92672">=</span> t<span style="color:#f92672">.</span><span style="color:#a6e22e">prev</span><span style="color:#f92672">)</span>
              <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>t<span style="color:#f92672">.</span><span style="color:#a6e22e">waitStatus</span> <span style="color:#f92672">&lt;=</span> 0<span style="color:#f92672">)</span>
                  s <span style="color:#f92672">=</span> t<span style="color:#f92672">;</span>
      <span style="color:#f92672">}</span>
      <span style="color:#75715e">// æ‰¾åˆ°ä¸ä¸ºcancelçš„énullèŠ‚ç‚¹
</span><span style="color:#75715e"></span>      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>s <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
          <span style="color:#75715e">// å”¤é†’å¯¹åº”çš„çº¿ç¨‹
</span><span style="color:#75715e"></span>          LockSupport<span style="color:#f92672">.</span><span style="color:#a6e22e">unpark</span><span style="color:#f92672">(</span>s<span style="color:#f92672">.</span><span style="color:#a6e22e">thread</span><span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<p>Qï¼šä¸ºä»€ä¹ˆAQSçš„é˜Ÿåˆ—æŸ¥æ‰¾ä¸­ï¼Œæ˜¯ä»é˜Ÿåˆ—å°¾ä»åå‘å‰æŸ¥æ‰¾çš„ï¼Ÿ</p>
<p>Aï¼šèŠ‚ç‚¹å…¥é˜Ÿæ—¶ï¼Œéƒ½æ˜¯éµå¾ªå¦‚ä¸‹èŒƒå¼è®¾ç½®tailèŠ‚ç‚¹ï¼š</p>
<p><code>â‘  node.prev = tail; </code></p>
<p><code>â‘¡ if(compareAndSetTail(tail, node)) { </code></p>
<p><code>			â‘¢ tail.next = node; }</code></p>
<p>â‘¡å’Œâ‘¢ä¸¤è¡Œä»£ç ä¸æ˜¯åŸå­æ€§çš„ï¼Œæ‰€ä»¥å°±å­˜åœ¨ï¼šçº¿ç¨‹Aå°†nodeAæˆåŠŸè®¾ç½®ä¸ºtailå°¾èŠ‚ç‚¹ï¼Œå¦‚æœæ­¤æ—¶çº¿ç¨‹åˆ‡æ¢ï¼Œçº¿ç¨‹Bæ‰§è¡ŒunparkSuccessoræ–¹æ³•å”¤é†’å°¾èŠ‚ç‚¹ï¼Œå¦‚æœä»å‰å¾€åæŸ¥è¯¢ï¼Œä¼šå‘ç°<code>tail.next = null</code>ï¼Œä¼šè®¤ä¸ºtailæ˜¯å°¾èŠ‚ç‚¹ï¼Œå…¶å®æ­¤æ—¶çš„å°¾èŠ‚ç‚¹å·²ç»è¢«çº¿ç¨‹Aæ”¹æˆäº†nodeAï¼Œdoug leaåœ¨AQSçš„æ–‡æ¡£ä¸­ä¹Ÿè¯´æ˜äº†<code>prevæ˜¯åŠ¡å¿…è¦ä¿è¯çš„å¯é å¼•ç”¨ï¼Œè€Œnextåªæ˜¯ä¸€ç§ä¼˜åŒ–ã€‚</code></p>
<p>åˆæ¯”å¦‚cancelAcquireæ–¹æ³•ä¸­ï¼Œéƒ½æ˜¯æ–­å¼€äº†nextæŒ‡é’ˆï¼ŒprevæŒ‡é’ˆæ²¡æœ‰æ–­å¼€ï¼Œä¹Ÿæ˜¯ä¸Šè¯‰ç†è®ºçš„ä¸€ç§ä½“ç°ã€‚</p>
</blockquote>
<h4 id="selfinterrupt">selfInterrupt</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// å½“è·å–é”æˆ–æ’å…¥nodeåˆ°é˜Ÿåˆ—çš„è¿‡ç¨‹ä¸­å‘ç”Ÿäº†interruptï¼Œé‚£ä¹ˆè¿™é‡Œéœ€è¦è¡¥ä¸Šæ‰“æ–­
</span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">selfInterrupt</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">currentThread</span><span style="color:#f92672">().</span><span style="color:#a6e22e">interrupt</span><span style="color:#f92672">();</span>
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="ç‹¬å é”è·å–æ‰§è¡Œæµç¨‹">ç‹¬å é”è·å–æ‰§è¡Œæµç¨‹</h3>
<p><img src="https://image.leejay.top/image/20200628/9RLQ683DruWq.png?imageslim" alt=""></p>
<h3 id="unlock">unlock</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">release</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> arg<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// å°è¯•é‡Šæ”¾é”
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>tryRelease<span style="color:#f92672">(</span>arg<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        Node h <span style="color:#f92672">=</span> head<span style="color:#f92672">;</span>
        <span style="color:#75715e">// å¦‚æœå¤´èŠ‚ç‚¹ä¸ä¸ºnullä¸”ä¸æ˜¯åˆå§‹çŠ¶æ€
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>h <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> h<span style="color:#f92672">.</span><span style="color:#a6e22e">waitStatus</span> <span style="color:#f92672">!=</span> 0<span style="color:#f92672">)</span>
            <span style="color:#75715e">// å”¤é†’å¤´èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹
</span><span style="color:#75715e"></span>            unparkSuccessor<span style="color:#f92672">(</span>h<span style="color:#f92672">);</span>
        <span style="color:#75715e">// å”¤é†’çš„çº¿ç¨‹ä¼šé‡æ–°ä»parkAndCheckInterrupt()æ–¹æ³•ä¸­è¢«unpark
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// ç„¶åç»§ç»­æ–°ä¸€è½®çš„è·å–é”æˆ–è€…è·å–ä¸åˆ°é”parkçš„æµç¨‹
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">tryRelease</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> releases<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// æ­¤æ—¶å¤„äºå·²è·å–é”çŠ¶æ€ï¼Œæ‰€ä»¥ä¸éœ€è¦casè·å–stateï¼Œè¿™é‡Œä¹Ÿä¼šå¤„ç†å¤šæ¬¡é‡å…¥çš„æƒ…å†µ
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> c <span style="color:#f92672">=</span> getState<span style="color:#f92672">()</span> <span style="color:#f92672">-</span> releases<span style="color:#f92672">;</span>
    <span style="color:#75715e">// å¦‚æœå½“å‰çº¿ç¨‹ä¸æ˜¯ç‹¬å çº¿ç¨‹æŠ›å¼‚å¸¸
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">currentThread</span><span style="color:#f92672">()</span> <span style="color:#f92672">!=</span> getExclusiveOwnerThread<span style="color:#f92672">())</span>
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> IllegalMonitorStateException<span style="color:#f92672">();</span>
    <span style="color:#66d9ef">boolean</span> free <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
    <span style="color:#75715e">// å¦‚æœstate=0è¯´æ˜ç‹¬å é”æˆ–é”é‡å…¥é‡Šæ”¾å‡†å¤‡å®Œæ¯•
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>c <span style="color:#f92672">==</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        free <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
        setExclusiveOwnerThread<span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#75715e">// è®¾ç½®çŠ¶æ€ä¸º0
</span><span style="color:#75715e"></span>    setState<span style="color:#f92672">(</span>c<span style="color:#f92672">);</span>
    <span style="color:#75715e">// é‡Šæ”¾é”æˆåŠŸ
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> free<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="lockinterruptibly">lockInterruptibly</h3>
<p>å¯åŠæ—¶å“åº”çº¿ç¨‹ä¸­æ–­çš„è·å–é”çš„API</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// æ–¹æ³•å…¥å£
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">lockInterruptibly</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> InterruptedException <span style="color:#f92672">{</span>
  sync<span style="color:#f92672">.</span><span style="color:#a6e22e">acquireInterruptibly</span><span style="color:#f92672">(</span>1<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
<span style="color:#75715e">// å¯å“åº”ä¸­æ–­
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">acquireInterruptibly</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> arg<span style="color:#f92672">)</span>
  <span style="color:#66d9ef">throws</span> InterruptedException <span style="color:#f92672">{</span>
    <span style="color:#75715e">// å¦‚æœçº¿ç¨‹è¢«æ‰“æ–­ç›´æ¥æŠ›å‡ºå¼‚å¸¸
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">interrupted</span><span style="color:#f92672">())</span>
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> InterruptedException<span style="color:#f92672">();</span>
    <span style="color:#75715e">// å°è¯•å»è·å–é”ï¼Œè·å–å¤±è´¥å°†nodeåŠ å…¥é˜Ÿåˆ—ï¼Œè¢«ä¸­æ–­æŠ›å‡ºå¼‚å¸¸
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>tryAcquire<span style="color:#f92672">(</span>arg<span style="color:#f92672">))</span>
        doAcquireInterruptibly<span style="color:#f92672">(</span>arg<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
<span style="color:#75715e">// ä¸acquireQueueå‡ ä¹ç›¸åŒ
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">doAcquireInterruptibly</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> arg<span style="color:#f92672">)</span>
    <span style="color:#f92672">...</span>
    	<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>shouldParkAfterFailedAcquire<span style="color:#f92672">(</span>p<span style="color:#f92672">,</span> node<span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span>
        	parkAndCheckInterrupt<span style="color:#f92672">())</span>
            <span style="color:#75715e">// ä¸acquireQueueå”¯ä¸€çš„åŒºåˆ«
</span><span style="color:#75715e"></span>        	<span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> InterruptedException<span style="color:#f92672">();</span>
    <span style="color:#f92672">...</span>
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="trylocktime">tryLock(time)</h3>
<p>å“åº”ä¸­æ–­ä¸”éé˜»å¡ï¼ŒæŒ‡å®šæ—¶é—´å†…è·å–ä¸åˆ°é”å°±è¿”å›ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">tryLock</span><span style="color:#f92672">(</span><span style="color:#66d9ef">long</span> timeout<span style="color:#f92672">,</span> TimeUnit unit<span style="color:#f92672">)</span>
    <span style="color:#66d9ef">throws</span> InterruptedException <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> sync<span style="color:#f92672">.</span><span style="color:#a6e22e">tryAcquireNanos</span><span style="color:#f92672">(</span>1<span style="color:#f92672">,</span> unit<span style="color:#f92672">.</span><span style="color:#a6e22e">toNanos</span><span style="color:#f92672">(</span>timeout<span style="color:#f92672">));</span>
<span style="color:#f92672">}</span>
<span style="color:#75715e">// ä¸lockInterruptiblyç›¸åŒæŠ›å‡ºä¸­æ–­å¼‚å¸¸åˆ‡æ¢å°è¯•è·å–é”ï¼Œè·å–é”è¿‡ç¨‹ä¸­å“åº”ä¸­æ–­
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">tryAcquireNanos</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> arg<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> nanosTimeout<span style="color:#f92672">)</span>
    <span style="color:#66d9ef">throws</span> InterruptedException <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">interrupted</span><span style="color:#f92672">())</span>
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> InterruptedException<span style="color:#f92672">();</span>
    <span style="color:#75715e">// å¦‚æœè·å–é”å¤±è´¥å°±å»æ‰§è¡ŒdoAcquireNanosï¼Œç›´åˆ°è¶…æ—¶è¿”å›false
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> tryAcquire<span style="color:#f92672">(</span>arg<span style="color:#f92672">)</span> <span style="color:#f92672">||</span>
        doAcquireNanos<span style="color:#f92672">(</span>arg<span style="color:#f92672">,</span> nanosTimeout<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
<span style="color:#75715e">// è·å–é”çš„è¶…æ—¶æ–¹æ³•
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">doAcquireNanos</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> arg<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> nanosTimeout<span style="color:#f92672">)</span>
    <span style="color:#66d9ef">throws</span> InterruptedException <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>nanosTimeout <span style="color:#f92672">&lt;=</span> 0L<span style="color:#f92672">)</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
    <span style="color:#75715e">// è®¡ç®—deadline
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">long</span> deadline <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">nanoTime</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> nanosTimeout<span style="color:#f92672">;</span>
    <span style="color:#75715e">// å°†nodeæ·»åŠ åˆ°é˜Ÿåˆ—ä¸­
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">final</span> Node node <span style="color:#f92672">=</span> addWaiter<span style="color:#f92672">(</span>Node<span style="color:#f92672">.</span><span style="color:#a6e22e">EXCLUSIVE</span><span style="color:#f92672">);</span>
    <span style="color:#66d9ef">boolean</span> failed <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(;;)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">final</span> Node p <span style="color:#f92672">=</span> node<span style="color:#f92672">.</span><span style="color:#a6e22e">predecessor</span><span style="color:#f92672">();</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>p <span style="color:#f92672">==</span> head <span style="color:#f92672">&amp;&amp;</span> tryAcquire<span style="color:#f92672">(</span>arg<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                setHead<span style="color:#f92672">(</span>node<span style="color:#f92672">);</span>
                p<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span> <span style="color:#75715e">// help GC
</span><span style="color:#75715e"></span>                failed <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
            <span style="color:#75715e">// è®¡ç®—å‰©ä½™æ—¶é—´
</span><span style="color:#75715e"></span>            nanosTimeout <span style="color:#f92672">=</span> deadline <span style="color:#f92672">-</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">nanoTime</span><span style="color:#f92672">();</span>
            <span style="color:#75715e">// å¦‚æœå°äº0è¯´æ˜è®¡æ—¶ç»“æŸï¼Œè·å–å¤±è´¥
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>nanosTimeout <span style="color:#f92672">&lt;=</span> 0L<span style="color:#f92672">)</span>
                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
            <span style="color:#75715e">// åˆ¤æ–­æ˜¯å¦éœ€è¦é˜»å¡ï¼ŒåŒºåˆ«åœ¨äºè¯¥æ–¹æ³•é˜»å¡äº†æŒ‡å®šäº†æ—¶é•¿
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// ä¸ºä»€ä¹ˆå‰©ä½™æ—¶é—´è¦å¤§äºspinForTimeoutThreshold(1000)æ‰ä¼šé˜»å¡
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// è¯´æ˜æ­¤æ—¶å‰©ä½™æ—¶é—´éå¸¸çŸ­ï¼Œæ²¡å¿…è¦å†æ‰§è¡ŒæŒ‚èµ·æ“ä½œäº†ï¼Œä¸å¦‚ç›´æ¥æ‰§è¡Œä¸‹ä¸€æ¬¡å¾ªç¯
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>shouldParkAfterFailedAcquire<span style="color:#f92672">(</span>p<span style="color:#f92672">,</span> node<span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span>
                nanosTimeout <span style="color:#f92672">&gt;</span> spinForTimeoutThreshold<span style="color:#f92672">)</span>
                <span style="color:#75715e">// è°ƒç”¨lockSupport parkæŒ‡å®šæ—¶é•¿
</span><span style="color:#75715e"></span>                LockSupport<span style="color:#f92672">.</span><span style="color:#a6e22e">parkNanos</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> nanosTimeout<span style="color:#f92672">);</span>
            <span style="color:#75715e">// parkè¿‡ç¨‹ä¸­è¢«ä¸­æ–­ç›´æ¥æŠ›å‡ºå¼‚å¸¸
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">interrupted</span><span style="color:#f92672">())</span>
                <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> InterruptedException<span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>failed<span style="color:#f92672">)</span>
            cancelAcquire<span style="color:#f92672">(</span>node<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<p>ç›¸æ¯”lockInterruptiblyæ–¹æ³•ï¼ŒtryLock(time)é™¤äº†å“åº”ä¸­æ–­å¤–ï¼Œè¿˜æ‹¥æœ‰è¶…æ—¶æ§åˆ¶ï¼Œç”±LockSupport.parkNanos()å®ç°ã€‚</p>
</blockquote>

    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h">å…¶ä»–æ–‡ç« </span>
            <hr />
          </div>
          <div class="pagination__buttons">
            
              <span class="button previous">
                <a href="https://www.leejay.top/post/condition/">
                  <span class="button__icon">â†</span>
                  <span class="button__text">Condition</span>
                </a>
              </span>
            
            
              <span class="button next">
                <a href="https://www.leejay.top/post/cas/">
                  <span class="button__text">CAS</span>
                  <span class="button__icon">â†’</span>
                </a>
              </span>
            
          </div>
        </div>
      
    


    
      
        

      
    

    </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright copyright--user">è‹ICPå¤‡18050258å·-1</div>
    
  </div>
</footer>

<script src="https://www.leejay.top/assets/main.js"></script>
<script src="https://www.leejay.top/assets/prism.js"></script>


      
    </div>

    
  </body>
</html>
