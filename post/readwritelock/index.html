<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>ReadWriteLock</title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="description" content="ReadWriteLock ReadWriteLockæ˜¯æ¥å£ï¼Œå®ƒå®šä¹‰äº†ä¸¤ä¸ªæ–¹æ³•ï¼šReadLockå’ŒWriteLockï¼Œè¯»å†™é”çš„å…·ä½“å®ç°åœ¨ReentrantReadWriteLockä¸­ã€‚è¯»å†™é”æ˜¯ä¹‹å‰åˆ†æçš„ç‹¬å é”å’Œå…±äº«é”ä¸¤ä¸ªç‰¹æ€§çš„é›†åˆä½“ï¼Œå…·æœ‰å¦‚ä¸‹è§„å®šï¼š
 å…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»å–å˜é‡ã€‚ æŸæ—¶åˆ»åªå…è®¸ä¸€ä¸ªçº¿ç¨‹å†™å˜é‡ã€‚ å¦‚æœæœ‰å†™çº¿ç¨‹æ­£åœ¨æ‰§è¡Œå†™æ“ä½œï¼Œé‚£ä¹ˆç¦æ­¢å…¶ä»–è¯»çº¿ç¨‹è¯»å–å˜é‡ã€‚  ReadWriteLockçš„é»˜è®¤å®ç°ç±»ReentrantReadWriteLock
public class ReentrantReadWriteLock implements ReadWriteLock { // è¯»é”å’Œå†™é”éƒ½æ˜¯ReentrantReadWriteLockçš„å†…éƒ¨ç±»  private final ReentrantReadWriteLock.ReadLock readerLock; private final ReentrantReadWriteLock.WriteLock writerLock; final Sync sync; // è¯»å†™é”é»˜è®¤æ˜¯éå…¬å¹³é”  public ReentrantReadWriteLock() { this(false); } // ReadLockå’ŒWriteLockéƒ½æ˜¯ç»§æ‰¿äº†åŒä¸€ä¸ªæŠ½è±¡ç±»Lockï¼Œæ‰€ä»¥ä»–ä»¬å±äºåŒä¸€ä¸ªAQSé˜Ÿåˆ—  public ReentrantReadWriteLock(boolean fair) { sync = fair ? new FairSync() : new NonfairSync(); readerLock = new ReadLock(this); writerLock = new WriteLock(this); } }  ç›¸æ¯”äºSemaphoreï¼ŒReentrantReadWriteLocké‡‡ç”¨å…±äº«å’Œç‹¬å ç»“åˆçš„æ–¹æ³•ã€‚Semaphoreå°±åƒæ˜¯ä¸€ä¸ªä»¤ç‰Œæ¡¶ï¼Œè°éƒ½å¯ä»¥æ‹¿å–ä»¤ç‰Œæ‰§è¡Œä»»åŠ¡ï¼Œè°éƒ½å¯ä»¥å½’è¿˜ä»¤ç‰Œã€‚å®ƒä¸ä¼šè®°å½•æ˜¯å“ªä¸ªçº¿ç¨‹è·å–äº†é”ï¼Œè€ŒReentrantReadWriteLockä¼šè®°å½•ï¼Œåªæœ‰æŒæœ‰ç›¸å…³é”æ‰èƒ½æ¥é‡Šæ”¾é”ã€‚
 state ä¸ç‹¬å é”ã€å…±äº«é”çš„stateçš„ä½¿ç”¨ä¸åŒï¼Œå› ä¸ºéœ€è¦è¡¨ç¤ºä¸¤ç§çŠ¶æ€ï¼Œæ‰€ä»¥å¯¹intå‹stateåšäº†é«˜ä½ä½åˆ‡å‰²ï¼Œåˆ†åˆ«è¡¨ç¤ºä¸åŒçš„çŠ¶æ€ã€‚å·²çŸ¥int=4byte= 32bitï¼Œæ‰€ä»¥é«˜16ä½è¡¨ç¤ºè¯»ï¼Œä½16ä½è¡¨ç¤ºå†™ã€‚ä»–ä»¬çš„å–å€¼èŒƒå›´åœ¨[0 ~ 2^16 - 1]ï¼Œè¿›è€Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºï¼Œæœ€å¤šæœ‰2^16 -1ä¸ªçº¿ç¨‹å¯ä»¥è·å–è¯»é”ã€‚"/>
<meta name="keywords" content=""/>
<meta name="robots" content="noodp"/>
<link rel="canonical" href="https://leejay.top/post/readwritelock/" />





<link rel="stylesheet" href="https://leejay.top/assets/style.css">


<link rel="stylesheet" href="https://leejay.top/style.css">


<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://leejay.top/img/apple-touch-icon-144-precomposed.png">
<link rel="shortcut icon" href="https://leejay.top/img/favicon.png">



<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="ReadWriteLock"/>
<meta name="twitter:description" content="å…·å¤‡`ç‹¬å é”å’Œå…±äº«é”`ä¸¤è€…ç‰¹æ€§çš„è¯»å†™é”ï¼Œé€‚ç”¨äºè¯»æ“ä½œå¤šäºå†™æ“ä½œçš„åœºæ™¯ã€‚"/>



<meta property="og:title" content="ReadWriteLock" />
<meta property="og:description" content="å…·å¤‡`ç‹¬å é”å’Œå…±äº«é”`ä¸¤è€…ç‰¹æ€§çš„è¯»å†™é”ï¼Œé€‚ç”¨äºè¯»æ“ä½œå¤šäºå†™æ“ä½œçš„åœºæ™¯ã€‚" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://leejay.top/post/readwritelock/" />
<meta property="article:published_time" content="2020-06-24T09:15:29+08:00" />
<meta property="article:modified_time" content="2020-06-24T09:15:29+08:00" /><meta property="og:site_name" content="Aurora" />






  </head>
  <body class="">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a href="https://leejay.top" class="logo" style="text-decoration: none;">
  
    <span class="logo__mark"><svg xmlns="https://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367"/>
</svg></span>
    <span class="logo__text">Aurora</span>
    <span class="logo__cursor"></span>
    <span class="logo__cursor2"></span>
  
</a>
    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/categories">Categories</a></li>
        
      
        
          <li><a href="/tags">Tags</a></li>
        
      
      
    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/categories">Categories</a></li>
      
    
      
        <li><a href="/tags">Tags</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none"/>
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="https://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>
      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  
  

  <div class="post">
    <h1 class="post-title"><a href="https://leejay.top/post/readwritelock/">ReadWriteLock</a></h1>
    <div class="post-meta">
      
        <span class="post-date">
          2020-06-24
        </span>

        
          
        
      

      
      
    </div>

    
      <span class="post-tags">
        
        ğŸ–<a href="https://leejay.top/tags/reentrantreadwritelock/">ReentrantReadWriteLock </a>&nbsp;
        
        ğŸ–<a href="https://leejay.top/tags/aqs/">AQS</a>&nbsp;
        
      </span>
    

    

    <div class="post-content">
      
      <h3 id="readwritelock">ReadWriteLock</h3>
<p>ReadWriteLockæ˜¯æ¥å£ï¼Œå®ƒå®šä¹‰äº†ä¸¤ä¸ªæ–¹æ³•ï¼š<code>ReadLock</code>å’Œ<code>WriteLock</code>ï¼Œè¯»å†™é”çš„å…·ä½“å®ç°åœ¨<code>ReentrantReadWriteLock</code>ä¸­ã€‚è¯»å†™é”æ˜¯ä¹‹å‰åˆ†æçš„<code>ç‹¬å é”</code>å’Œ<code>å…±äº«é”</code>ä¸¤ä¸ªç‰¹æ€§çš„é›†åˆä½“ï¼Œå…·æœ‰å¦‚ä¸‹è§„å®šï¼š</p>
<ol>
<li>å…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»å–å˜é‡ã€‚</li>
<li>æŸæ—¶åˆ»åªå…è®¸ä¸€ä¸ªçº¿ç¨‹å†™å˜é‡ã€‚</li>
<li>å¦‚æœæœ‰å†™çº¿ç¨‹æ­£åœ¨æ‰§è¡Œå†™æ“ä½œï¼Œé‚£ä¹ˆç¦æ­¢å…¶ä»–è¯»çº¿ç¨‹è¯»å–å˜é‡ã€‚</li>
</ol>
<p>ReadWriteLockçš„é»˜è®¤å®ç°ç±»<code>ReentrantReadWriteLock</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ReentrantReadWriteLock</span>  <span style="color:#66d9ef">implements</span> ReadWriteLock <span style="color:#f92672">{</span>
	<span style="color:#75715e">// è¯»é”å’Œå†™é”éƒ½æ˜¯ReentrantReadWriteLockçš„å†…éƒ¨ç±»
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> ReentrantReadWriteLock<span style="color:#f92672">.</span><span style="color:#a6e22e">ReadLock</span> readerLock<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> ReentrantReadWriteLock<span style="color:#f92672">.</span><span style="color:#a6e22e">WriteLock</span> writerLock<span style="color:#f92672">;</span>

    <span style="color:#66d9ef">final</span> Sync sync<span style="color:#f92672">;</span>
    <span style="color:#75715e">// è¯»å†™é”é»˜è®¤æ˜¯éå…¬å¹³é”
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">ReentrantReadWriteLock</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    
    <span style="color:#75715e">// ReadLockå’ŒWriteLockéƒ½æ˜¯ç»§æ‰¿äº†åŒä¸€ä¸ªæŠ½è±¡ç±»Lockï¼Œæ‰€ä»¥ä»–ä»¬å±äºåŒä¸€ä¸ªAQSé˜Ÿåˆ—
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">ReentrantReadWriteLock</span><span style="color:#f92672">(</span><span style="color:#66d9ef">boolean</span> fair<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        sync <span style="color:#f92672">=</span> fair <span style="color:#f92672">?</span> <span style="color:#66d9ef">new</span> FairSync<span style="color:#f92672">()</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">new</span> NonfairSync<span style="color:#f92672">();</span>
        readerLock <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ReadLock<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
        writerLock <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> WriteLock<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<p>ç›¸æ¯”äº<code>Semaphore</code>ï¼Œ<code>ReentrantReadWriteLock</code>é‡‡ç”¨å…±äº«å’Œç‹¬å ç»“åˆçš„æ–¹æ³•ã€‚Semaphoreå°±åƒæ˜¯ä¸€ä¸ªä»¤ç‰Œæ¡¶ï¼Œè°éƒ½å¯ä»¥æ‹¿å–ä»¤ç‰Œæ‰§è¡Œä»»åŠ¡ï¼Œè°éƒ½å¯ä»¥å½’è¿˜ä»¤ç‰Œã€‚å®ƒä¸ä¼šè®°å½•æ˜¯å“ªä¸ªçº¿ç¨‹è·å–äº†é”ï¼Œè€Œ<code>ReentrantReadWriteLock</code>ä¼šè®°å½•ï¼Œåªæœ‰æŒæœ‰ç›¸å…³é”æ‰èƒ½æ¥é‡Šæ”¾é”ã€‚</p>
</blockquote>
<h4 id="state">state</h4>
<p>ä¸ç‹¬å é”ã€å…±äº«é”çš„stateçš„ä½¿ç”¨ä¸åŒï¼Œå› ä¸ºéœ€è¦è¡¨ç¤ºä¸¤ç§çŠ¶æ€ï¼Œæ‰€ä»¥å¯¹<code>intå‹state</code>åšäº†<code>é«˜ä½ä½åˆ‡å‰²</code>ï¼Œåˆ†åˆ«è¡¨ç¤ºä¸åŒçš„çŠ¶æ€ã€‚å·²çŸ¥<code>int=4byte= 32bit</code>ï¼Œæ‰€ä»¥<code>é«˜16ä½è¡¨ç¤ºè¯»ï¼Œä½16ä½è¡¨ç¤ºå†™</code>ã€‚ä»–ä»¬çš„å–å€¼èŒƒå›´åœ¨<code>[0 ~ 2^16 - 1]</code>ï¼Œè¿›è€Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºï¼Œæœ€å¤šæœ‰<code>2^16 -1</code>ä¸ªçº¿ç¨‹å¯ä»¥è·å–è¯»é”ã€‚</p>
<p><img src="https://image.leejay.top/image/20200630/iU956J9I2D6U.png?imageslim" alt=""></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Sync</span> <span style="color:#66d9ef">extends</span> AbstractQueuedSynchronizer <span style="color:#f92672">{</span>
      
    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> SHARED_SHIFT   <span style="color:#f92672">=</span> 16<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> SHARED_UNIT    <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>1 <span style="color:#f92672">&lt;&lt;</span> SHARED_SHIFT<span style="color:#f92672">);</span>
    <span style="color:#75715e">// è¯»é”å’Œå†™é”çš„countä¸èƒ½è¶…è¿‡MAX_COUNT
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> MAX_COUNT      <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>1 <span style="color:#f92672">&lt;&lt;</span> SHARED_SHIFT<span style="color:#f92672">)</span> <span style="color:#f92672">-</span> 1<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> EXCLUSIVE_MASK <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>1 <span style="color:#f92672">&lt;&lt;</span> SHARED_SHIFT<span style="color:#f92672">)</span> <span style="color:#f92672">-</span> 1<span style="color:#f92672">;</span>

    <span style="color:#75715e">// è¿”å›è¯»é”çš„count
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">sharedCount</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> c<span style="color:#f92672">)</span> <span style="color:#f92672">{</span> 
        <span style="color:#66d9ef">return</span> c <span style="color:#f92672">&gt;&gt;&gt;</span> SHARED_SHIFT<span style="color:#f92672">;</span> 
    <span style="color:#f92672">}</span>
    <span style="color:#75715e">// è¿”å›å†™é”çš„count
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">exclusiveCount</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> c<span style="color:#f92672">)</span> <span style="color:#f92672">{</span> 
        <span style="color:#66d9ef">return</span> c <span style="color:#f92672">&amp;</span> EXCLUSIVE_MASK<span style="color:#f92672">;</span> 
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<ol>
<li>
<p>è¯»é”å’Œå†™é”çš„countä¸èƒ½è¶…è¿‡<code>MAX_COUNTå³2^16-1</code>ã€‚</p>
</li>
<li>
<p>int å‹ state æ— ç¬¦å·å³ç§»16ä½ï¼Œå¾—åˆ°çš„å³ä¸ºé«˜16ä½çš„countã€‚</p>
</li>
<li>
<p>int å‹ state ä¸ <code>1111 1111 1111 1111</code>åš<code>ä¸è¿ç®—</code>ï¼Œå®ƒçš„ç»“æœä¹Ÿä¸ä¼šè¶…è¿‡<code>1111 1111 1111 1111</code>ï¼Œå› ä¸º<code>ä¸è¿ç®—</code>çš„è§„åˆ™æ˜¯<code>éƒ½1ä¸º1ï¼Œå¦åˆ™ä¸º0</code>ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">å¦‚int state <span style="color:#f92672">=</span> 3<span style="color:#960050;background-color:#1e0010">ï¼Œ</span>é‚£ä¹ˆå®ƒçš„äºŒè¿›åˆ¶å¦‚ä¸‹
       
  0000 0000 0000 0000 0000 0000 0000 0011
<span style="color:#f92672">&amp;</span>                     1111 1111 1111 1111
<span style="color:#960050;background-color:#1e0010">â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”</span>    
                      0000 0000 0000 0011
</code></pre></div></li>
<li>
<p>å¦‚æœè¯»count + 1ï¼Œé‚£ä¹ˆå°±ç­‰äº <code>c  =  c + 1 &lt;&lt; 16</code>ï¼Œå¦‚æœcount + 1ï¼Œé‚£ä¹ˆ<code>c = c + 1</code>ã€‚</p>
</li>
<li>
<p><code>å¦‚æœc ä¸ä¸º 0ï¼Œå½“å†™count = 0æ—¶ï¼Œè¯»count &gt; 0æˆç«‹</code>ã€‚å³è¯»é”å·²ç»è·å–ã€‚</p>
</li>
</ol>
</blockquote>
<h4 id="threadlocalholdcounter">ThreadLocalHoldCounter</h4>
<p>é™¤äº†éœ€è¦è®°å½•é”è¢«æ‹¿å–çš„æ€»æ¬¡æ•°ï¼Œè¿˜éœ€è¦è®°å½•æ¯ä¸ªçº¿ç¨‹åˆ†åˆ«æ‹¿èµ°å¤šå°‘ï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨[ThreadLocal](#7. ThreadLocalå†…å­˜æ³„æ¼é—®é¢˜)ï¼Œå°†è®°å½•çš„å·¥ä½œäº¤ç»™çº¿ç¨‹è‡ªå·±ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Sync</span> <span style="color:#66d9ef">extends</span> AbstractQueuedSynchronizer <span style="color:#f92672">{</span>
    <span style="color:#75715e">// å½“å‰çº¿ç¨‹æŒæœ‰çš„è¯»é”æ•°é‡ï¼Œå½“ä¸º0çš„æ—¶å€™ç½®ä¸ºnull
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">transient</span> ThreadLocalHoldCounter readHolds<span style="color:#f92672">;</span>
    
    <span style="color:#75715e">// ä¿å­˜æˆåŠŸè·å–è¯»é”çš„çº¿ç¨‹çš„count æ³¨æ„évolatile
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">transient</span> HoldCounter cachedHoldCounter<span style="color:#f92672">;</span>
    <span style="color:#75715e">// ç”¨äºè¯»é”ï¼Œè¡¨æ˜ç¬¬ä¸€ä¸ªè·å–è¯»é”çš„çº¿ç¨‹æ˜¯è°
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">transient</span> Thread firstReader <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
    <span style="color:#75715e">// ç”¨äºè¯»é”ï¼Œè¡¨æ˜ç¬¬ä¸€ä¸ªè·å–è¯»é”çš„çº¿ç¨‹é‡å…¥äº†å‡ æ¬¡
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">transient</span> <span style="color:#66d9ef">int</span> firstReaderHoldCount<span style="color:#f92672">;</span>
	Sync<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        readHolds <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ThreadLocalHoldCounter<span style="color:#f92672">();</span>
        setState<span style="color:#f92672">(</span>getState<span style="color:#f92672">());</span> <span style="color:#75715e">// ensures visibility of readHolds
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
    <span style="color:#75715e">// æ¯ä¸ªçº¿ç¨‹éƒ½æ‹¥æœ‰HoldCounterç±»çš„å®ä¾‹ï¼Œäº’ä¸å¹²é¢„
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">HoldCounter</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">int</span> count <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
        <span style="color:#75715e">// è¿™é‡Œçº¿ç¨‹idç›´æ¥ä½¿ç”¨idï¼Œä¸ä½¿ç”¨referenceï¼Œä¾¿äºGC
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">long</span> tid <span style="color:#f92672">=</span> getThreadId<span style="color:#f92672">(</span>Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">currentThread</span><span style="color:#f92672">());</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ThreadLocalHoldCounter</span>
        <span style="color:#66d9ef">extends</span> ThreadLocal<span style="color:#f92672">&lt;</span>HoldCounter<span style="color:#f92672">&gt;</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">public</span> HoldCounter <span style="color:#a6e22e">initialValue</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> HoldCounter<span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<ol>
<li>è¿™é‡Œä½¿ç”¨çº¿ç¨‹IDè€Œä¸æ˜¯ç”¨çº¿ç¨‹å¯¹è±¡çš„åŸå› æ—¶é¿å…<code>HoldCounterå’ŒThreadLocaläº’ç›¸ç»‘å®šå¯¼è‡´GCéš¾ä»¥é‡Šæ”¾(å¯ä»¥é‡Šæ”¾åªæ˜¯éœ€è¦ä»£ä»·)</code>ï¼Œç›®çš„å°±æ˜¯å¸®åŠ©GCå¿«é€Ÿå›æ”¶å¯¹è±¡ã€‚</li>
<li>å®šä¹‰ä¸‰ä¸ªæˆå‘˜å˜é‡ï¼šcachedHoldCounterã€firstReaderå’ŒfirstReaderHoldCountåŸå› æ˜¯ä¸ºäº†<code>å¿«é€Ÿåˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦æŒæœ‰è¯»é”</code>ã€‚</li>
</ol>
</blockquote>
<hr>
<h3 id="writelock">WriteLock</h3>
<p>æˆ‘ä»¬ä»å†™é”å¼€å§‹å…¥æ‰‹ï¼Œå†™é”å°±æ˜¯ç‹¬å é”çš„ä½“ç°ã€‚</p>
<ul>
<li>
<p>tryLock</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// å†™é”å…¥å£
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">lock</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    sync<span style="color:#f92672">.</span><span style="color:#a6e22e">acquire</span><span style="color:#f92672">(</span>1<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
  
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">acquire</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> arg<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>tryAcquire<span style="color:#f92672">(</span>arg<span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span>
        acquireQueued<span style="color:#f92672">(</span>addWaiter<span style="color:#f92672">(</span>Node<span style="color:#f92672">.</span><span style="color:#a6e22e">EXCLUSIVE</span><span style="color:#f92672">),</span> arg<span style="color:#f92672">))</span>
        selfInterrupt<span style="color:#f92672">();</span>
<span style="color:#f92672">}</span>
<span style="color:#75715e">// ä¸ç‹¬å é”ä¸åŒçš„å­ç±»å®ç°
</span><span style="color:#75715e"></span><span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">tryAcquire</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> acquires<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// è·å–å½“å‰çº¿ç¨‹
</span><span style="color:#75715e"></span>    Thread current <span style="color:#f92672">=</span> Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">currentThread</span><span style="color:#f92672">();</span>
    <span style="color:#66d9ef">int</span> c <span style="color:#f92672">=</span> getState<span style="color:#f92672">();</span>
    <span style="color:#75715e">// è·å–å†™é”çš„count
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> w <span style="color:#f92672">=</span> exclusiveCount<span style="color:#f92672">(</span>c<span style="color:#f92672">);</span>
    <span style="color:#75715e">// c!=0è¯´æ˜æœ‰é”ï¼Œä½†ä¸çŸ¥é“æ˜¯ä»€ä¹ˆé”
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>c <span style="color:#f92672">!=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// state != 0 ä¸” w = 0è¯´æ˜æ­¤æ—¶å­˜åœ¨è¯»é”ï¼Œè¿”å›false
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// w != 0 è¯´æ˜å­˜åœ¨å†™é”ï¼Œå¿…é¡»è¦æ±‚å½“å‰çº¿ç¨‹æ˜¯æŒæœ‰å†™é”çš„çº¿ç¨‹ï¼Œå¦åˆ™è¿”å›false
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>w <span style="color:#f92672">==</span> 0 <span style="color:#f92672">||</span> current <span style="color:#f92672">!=</span> getExclusiveOwnerThread<span style="color:#f92672">())</span>
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
        <span style="color:#75715e">// åˆ¤æ–­å†™é”countæ˜¯å¦è¶…è¿‡æœ€å¤§count
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>w <span style="color:#f92672">+</span> exclusiveCount<span style="color:#f92672">(</span>acquires<span style="color:#f92672">)</span> <span style="color:#f92672">&gt;</span> MAX_COUNT<span style="color:#f92672">)</span>
            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Maximum lock count exceeded&#34;</span><span style="color:#f92672">);</span>
        <span style="color:#75715e">// åˆ°æ­¤å¤„è¯´æ˜æ˜¯å½“å‰çº¿ç¨‹ï¼Œæ‰€ä»¥æ— ç«äº‰ï¼Œç›´æ¥setæ”¹å˜å†™é”count
</span><span style="color:#75715e"></span>        setState<span style="color:#f92672">(</span>c <span style="color:#f92672">+</span> acquires<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    <span style="color:#75715e">// c=0è¯´æ˜è¯´æ˜æ— é”
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// å¦‚æœä¸éœ€è¦é˜»å¡å°±å°è¯•CASä¿®æ”¹state
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>writerShouldBlock<span style="color:#f92672">()</span> <span style="color:#f92672">||</span>
        <span style="color:#f92672">!</span>compareAndSetState<span style="color:#f92672">(</span>c<span style="color:#f92672">,</span> c <span style="color:#f92672">+</span> acquires<span style="color:#f92672">))</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
    <span style="color:#75715e">// è®¾ç½®å½“å‰çº¿ç¨‹ä¸ºç‹¬å çº¿ç¨‹
</span><span style="color:#75715e"></span>    setExclusiveOwnerThread<span style="color:#f92672">(</span>current<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
<span style="color:#75715e">// éå…¬å¹³é”å®ç°
</span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">NonfairSync</span> <span style="color:#66d9ef">extends</span> Sync <span style="color:#f92672">{</span>
    <span style="color:#75715e">// éå…¬å¹³ç›´æ¥è¿”å›falseå°è¯•å»è·å–é”
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">writerShouldBlock</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
  
<span style="color:#75715e">// å…¬å¹³é”å®ä¹ é‚£
</span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">FairSync</span> <span style="color:#66d9ef">extends</span> Sync <span style="color:#f92672">{</span>
    <span style="color:#75715e">// å¦‚æœè¿”å›trueè¯´æ˜å‰é¢æœ‰èŠ‚ç‚¹ç­‰å¾…
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">writerShouldBlock</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// åˆ¤æ–­é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰å‰é©±èŠ‚ç‚¹åœ¨ç­‰å¾…
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span> hasQueuedPredecessors<span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
  
</code></pre></div></li>
</ul>
<blockquote>
<p>å†™é”è·å–æˆåŠŸçš„æƒ…å†µï¼š</p>
<ol>
<li>å†™é”çš„çº¿ç¨‹æŒæœ‰è€…é‡å…¥äº†å†™é”ã€‚</li>
<li>å†™é”ä¸è¢«ä»»ä½•çº¿ç¨‹æŒæœ‰ï¼Œå½“å‰çº¿ç¨‹ç«äº‰å¾—åˆ°äº†é”ã€‚</li>
</ol>
<p>å†™é”è·å–å¤±è´¥çš„æƒ…å†µï¼š</p>
<ol>
<li>
<p>å½“å‰çº¿ç¨‹ä¸æ˜¯å†™é”çš„æŒæœ‰è€…ã€‚</p>
</li>
<li>
<p><code>å½“å‰åªæœ‰è¯»é”æ²¡æœ‰å†™é”</code>ï¼Œä¸èƒ½å°†è¯»é”å‡çº§ä¸ºå†™é”ã€‚</p>
</li>
<li>
<p>å…¬å¹³é”åˆ¤æ–­å½“å‰çº¿ç¨‹æ’åœ¨äº†é˜Ÿåˆ—ä¸­å…¶ä»–çº¿ç¨‹åé¢ã€‚</p>
</li>
<li>
<p>å°è¯•CASä¿®æ”¹stateå¤±è´¥äº†ã€‚</p>
</li>
</ol>
</blockquote>
<h4 id="trywritelock">tryWriteLock</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">tryWriteLock</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    Thread current <span style="color:#f92672">=</span> Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">currentThread</span><span style="color:#f92672">();</span>
    <span style="color:#66d9ef">int</span> c <span style="color:#f92672">=</span> getState<span style="color:#f92672">();</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>c <span style="color:#f92672">!=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">int</span> w <span style="color:#f92672">=</span> exclusiveCount<span style="color:#f92672">(</span>c<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>w <span style="color:#f92672">==</span> 0 <span style="color:#f92672">||</span> current <span style="color:#f92672">!=</span> getExclusiveOwnerThread<span style="color:#f92672">())</span>
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
        <span style="color:#75715e">// å¦‚æœç­‰äºæœ€å¤§å€¼å°±æŠ›æº¢å‡ºå¼‚å¸¸
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>w <span style="color:#f92672">==</span> MAX_COUNT<span style="color:#f92672">)</span>
            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Maximum lock count exceeded&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#75715e">// å³ä½¿æ˜¯å†™é”çš„æŒæœ‰çº¿ç¨‹è¿˜æ˜¯é€šè¿‡CASè®¾ç½®state
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>compareAndSetState<span style="color:#f92672">(</span>c<span style="color:#f92672">,</span> c <span style="color:#f92672">+</span> 1<span style="color:#f92672">))</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
    setExclusiveOwnerThread<span style="color:#f92672">(</span>current<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<p>ä¸tryAcquireç±»ä¼¼ï¼Œæ˜¯<code>éå…¬å¹³ã€ä¸€æ¬¡æ€§</code>çš„è·å–å†™é”ï¼Œå†™é”è®¡æ•°é»˜è®¤åŠ 1ã€‚</p>
</blockquote>
<h4 id="release">release</h4>
<p>å†™é”çš„é‡Šæ”¾æµç¨‹ä¸ç‹¬å é”é‡Šæ”¾ç±»ä¼¼ï¼Œåªæ˜¯tryReleaseä¸åŒï¼Œæˆ‘ä»¬åªéœ€è¦å…³æ³¨AQSçš„å­ç±»å®ç°å³å¯</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// ReentrentReadWriteLock
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">unlock</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  sync<span style="color:#f92672">.</span><span style="color:#a6e22e">release</span><span style="color:#f92672">(</span>1<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
<span style="color:#75715e">//AQS.release
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">release</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> arg<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>tryRelease<span style="color:#f92672">(</span>arg<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        Node h <span style="color:#f92672">=</span> head<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>h <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> h<span style="color:#f92672">.</span><span style="color:#a6e22e">waitStatus</span> <span style="color:#f92672">!=</span> 0<span style="color:#f92672">)</span>
            unparkSuccessor<span style="color:#f92672">(</span>h<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
<span style="color:#75715e">// boolean/false é‡Šæ”¾/ä¸æ˜¯å
</span><span style="color:#75715e"></span><span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">tryRelease</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> releases<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// å¦‚æœä¸æ˜¯å†™é”æŒæœ‰çº¿ç¨‹åˆ™æŠ›å‡ºå¼‚å¸¸
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>isHeldExclusively<span style="color:#f92672">())</span>
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> IllegalMonitorStateException<span style="color:#f92672">();</span>
    <span style="color:#75715e">// è®¡ç®—é‡Šæ”¾åæ–°å€¼
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> nextc <span style="color:#f92672">=</span> getState<span style="color:#f92672">()</span> <span style="color:#f92672">-</span> releases<span style="color:#f92672">;</span>
    <span style="color:#75715e">// åˆ¤æ–­å†™é”count == 0 å†™é”æ˜¯å¦å­˜åœ¨é‡å…¥
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">boolean</span> free <span style="color:#f92672">=</span> exclusiveCount<span style="color:#f92672">(</span>nextc<span style="color:#f92672">)</span> <span style="color:#f92672">==</span> 0<span style="color:#f92672">;</span>
    <span style="color:#75715e">// ä¸ºtrueè¯´æ˜å·²ç»å…¨éƒ¨é‡Šæ”¾
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>free<span style="color:#f92672">)</span>
        <span style="color:#75715e">// æ¸…ç©ºå½“å‰ç‹¬å çº¿ç¨‹
</span><span style="color:#75715e"></span>        setExclusiveOwnerThread<span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
    <span style="color:#75715e">// è®¾ç½®state
</span><span style="color:#75715e"></span>    setState<span style="color:#f92672">(</span>nextc<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">return</span> free<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<p>åªæœ‰<code>stateä¸­ä½16ä½å€¼ = 0</code>çš„æ—¶å€™æ‰è¡¨æ˜å†™é”é‡Šæ”¾å®Œæ¯•ã€‚</p>
</blockquote>
<hr>
<h3 id="readlock">ReadLock</h3>
<p>è¯»é”å°±æ˜¯å…±äº«é”çš„ä½“ç°ï¼Œæˆ‘ä»¬ç›´æ¥æŸ¥çœ‹ReentrantReadWriteLockä¸­AQSçš„å­ç±»çš„<code>tryAcquireShared</code>å’Œ<code>tryReleaseShared</code>å®ç°å³å¯ã€‚</p>
<ul>
<li>
<p>tryAcquireShared</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// é¦–å…ˆæˆ‘ä»¬çŸ¥é“intè¿”å›å€¼çš„ä¸åŒä»£è¡¨äº†å…±äº«é”è·å–çš„ä¸åŒæƒ…å†µ(å’Œsemaphoreä¸€è‡´)
</span><span style="color:#75715e"></span><span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">tryAcquireShared</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> unused<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
<span style="color:#75715e">// è·å–å½“å‰çº¿ç¨‹
</span><span style="color:#75715e"></span>    Thread current <span style="color:#f92672">=</span> Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">currentThread</span><span style="color:#f92672">();</span>
    <span style="color:#75715e">// è·å–state
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> c <span style="color:#f92672">=</span> getState<span style="color:#f92672">();</span>
    <span style="color:#75715e">// 1. å†™é”count = 0ï¼Œè¯´æ˜æ­¤æ—¶æ²¡æœ‰å†™é”ã€‚ç»§ç»­æ‰§è¡Œ
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// 2. å†™é”count != 0 ,æ­¤æ—¶æœ‰å†™é”ï¼Œä½†å†™é”æŒæœ‰è€…æ˜¯å½“å‰çº¿ç¨‹ã€‚ç»§ç»­æ‰§è¡Œ
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// 3. å†™é”count != 0,æ­¤æ—¶æœ‰å†™é”ï¼Œä½†å†™é”æŒæœ‰è€…ä¸æ˜¯å½“å‰çº¿ç¨‹ï¼Œè·å–å¤±è´¥ï¼Œæ‰§è¡Œä¸­æ–­ã€‚
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>exclusiveCount<span style="color:#f92672">(</span>c<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> 0 <span style="color:#f92672">&amp;&amp;</span>
        getExclusiveOwnerThread<span style="color:#f92672">()</span> <span style="color:#f92672">!=</span> current<span style="color:#f92672">)</span>
        <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span>1<span style="color:#f92672">;</span>
    <span style="color:#75715e">// è®¡ç®—è¯»é”countï¼Œæ— ç¬¦å·å³ç§»16ä½
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> r <span style="color:#f92672">=</span> sharedCount<span style="color:#f92672">(</span>c<span style="color:#f92672">);</span>
    <span style="color:#75715e">// 1. readerShouldBlock åˆ¤æ–­æ˜¯å¦éœ€è¦é˜»å¡ï¼Œfalse/true ä¸é˜»å¡/é˜»å¡
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// 2. è¯»é”count &lt; MAX_COUNT
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// 3. å°†è¯»é”åŠ 1ï¼Œå³stateé«˜16ä½åŠ 1
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>readerShouldBlock<span style="color:#f92672">()</span> <span style="color:#f92672">&amp;&amp;</span>
        r <span style="color:#f92672">&lt;</span> MAX_COUNT <span style="color:#f92672">&amp;&amp;</span>
        compareAndSetState<span style="color:#f92672">(</span>c<span style="color:#f92672">,</span> c <span style="color:#f92672">+</span> SHARED_UNIT<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// æ‰§è¡Œåˆ°è¿™é‡Œè¯´æ˜å·²ç»æˆåŠŸå°†è¯»é”åŠ 1
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// å¦‚æœ r = 0è¯´æ˜å½“å‰çº¿ç¨‹æ˜¯ç¬¬ä¸€ä¸ªè·å–è¯»é”çš„çº¿ç¨‹ï¼Œæ­¤æ—¶ä¸å­˜åœ¨ç«äº‰
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>r <span style="color:#f92672">==</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// è®¾ç½®firstReader å’Œ firstReaderHoldCountå±æ€§
</span><span style="color:#75715e"></span>            firstReader  <span style="color:#f92672">=</span> current<span style="color:#f92672">;</span>
            firstReaderHoldCount <span style="color:#f92672">=</span> 1<span style="color:#f92672">;</span>
          <span style="color:#75715e">// å¦‚æœr != 0 ä½† firstReader == currentè¯´æ˜
</span><span style="color:#75715e"></span>          <span style="color:#75715e">// ç¬¬ä¸€ä¸ªè¯»é”çº¿ç¨‹åˆé‡å…¥äº†ï¼Œé‚£ä¹ˆåªè¦ä¿®æ”¹firstReaderHoldCountå³å¯
</span><span style="color:#75715e"></span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>firstReader <span style="color:#f92672">==</span> current<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// è¿™é‡Œä¸éœ€è¦åŠ é”ï¼Œå› ä¸ºå½“å‰çº¿ç¨‹å°±æ˜¯ç¬¬ä¸€ä¸ªè¯»é”çº¿ç¨‹ï¼Œä¸ä¼šæœ‰å…¶ä»–çº¿ç¨‹æ¥æ“ä½œ
</span><span style="color:#75715e"></span>            firstReaderHoldCount<span style="color:#f92672">++;</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// æ­¤å¤„è¯´æ˜å½“å‰çº¿ç¨‹ä¸æ˜¯ç¬¬ä¸€ä¸ªæ¥è·å–è¯»é”çš„çº¿ç¨‹
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// å®šä¹‰å±€éƒ¨å˜é‡rh = æˆå‘˜å˜é‡cachedHoldCounter
</span><span style="color:#75715e"></span>            HoldCounter rh <span style="color:#f92672">=</span> cachedHoldCounter<span style="color:#f92672">;</span>
            <span style="color:#75715e">// è¯¥æ¡ä»¶èƒ½å¤Ÿä¿è¯rhæŒæœ‰çš„æ˜¯å½“å‰çº¿ç¨‹çš„HoldCounter
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>rh <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> rh<span style="color:#f92672">.</span><span style="color:#a6e22e">tid</span> <span style="color:#f92672">!=</span> getThreadId<span style="color:#f92672">(</span>current<span style="color:#f92672">))</span>
                <span style="color:#75715e">// a.å°†rh å’Œ cachedHoldCounter æŒ‡å‘ThreadLocalä¸­çš„HoldCounter
</span><span style="color:#75715e"></span>                cachedHoldCounter <span style="color:#f92672">=</span> rh <span style="color:#f92672">=</span> readHolds<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">();</span>
            <span style="color:#75715e">// æ‰§è¡Œåˆ°è¿™é‡Œè¯´æ˜æ˜¯ä¹‹å‰è®¾ç½®è¿‡cachedHoldCounterçš„çº¿ç¨‹æ¥è·å–è¯»é”
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// è¿æ°”å¾ˆå¥½ã€‚è¿™é‡Œå°è¯•è·å–ç»“æœå‘ç°cachedHoldCounterå°±æ˜¯å½“å‰çº¿ç¨‹
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// å¦‚æœrh.count = 0å°±è¯´æ˜å½“å‰çº¿ç¨‹é‡Šæ”¾äº†è¯»é”ï¼Œä¸”æ²¡æœ‰è·å–è¯»é”çš„çº¿ç¨‹HC=null
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// æ‰€ä»¥è¿™é‡Œå½“rh.count=0æ—¶éœ€è¦è®¾ç½®rhåˆ°å½“å‰çº¿ç¨‹ThreadLocalä¸­
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>rh<span style="color:#f92672">.</span><span style="color:#a6e22e">count</span> <span style="color:#f92672">==</span> 0<span style="color:#f92672">)</span>
                readHolds<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>rh<span style="color:#f92672">);</span>
            <span style="color:#75715e">// ä¸è®ºå¦‚ä½•rh.countéƒ½ä¼š+1ï¼Œæ³¨æ„cacheHoldCounter = rh,æ‰€cHC.countä¹Ÿ+1
</span><span style="color:#75715e"></span>            rh<span style="color:#f92672">.</span><span style="color:#a6e22e">count</span><span style="color:#f92672">++;</span>
        <span style="color:#f92672">}</span>
        <span style="color:#75715e">// è¿”å›1è¡¨æ˜è·å–æˆåŠŸ
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span> 1<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    <span style="color:#75715e">// å¦‚æœä¸èƒ½è·å–è¯»é”æ‰§è¡Œä¸‹é¢é€»è¾‘
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> fullTryAcquireShared<span style="color:#f92672">(</span>current<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
<span style="color:#75715e">// å…¬å¹³é”å®ç°
</span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">FairSync</span> <span style="color:#66d9ef">extends</span> Sync <span style="color:#f92672">{</span>
    <span style="color:#75715e">// åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦æ˜¯é˜Ÿåˆ—ç¬¬ä¸€ä¸ªèŠ‚ç‚¹
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">readerShouldBlock</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> hasQueuedPredecessors<span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
<span style="color:#75715e">// éå…¬å¹³é”å®ç°
</span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">NonfairSync</span> <span style="color:#66d9ef">extends</span> Sync <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">readerShouldBlock</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// ç¬¬ä¸€ä¸ªèŠ‚ç‚¹æ˜¯sharedå°±è¿”å›falseå¦åˆ™è¿”å›true
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span> apparentlyFirstQueuedIsExclusive<span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<ol>
<li>
<p>å½“<code>!readerShouldBlock() &amp;&amp; r &lt; MAX_COUNT &amp;&amp; compareAndSetState(c, c + SHARED_UNIT)</code>ä¸ºtrueæ—¶ï¼Œæ­¤æ—¶å…±äº«é”å·²ç»è·å–æˆåŠŸï¼Œå¤§æ‹¬å·ä¸­çš„ä»£ç éƒ½æ˜¯åœ¨è®¾ç½®ç›¸å…³å‚æ•°ã€‚</p>
</li>
<li>
<p><code>r(share read count) = 0</code>è¯´æ˜æ­¤æ—¶æš‚æ— å…±äº«é”ï¼Œè¿›å…¥è¯¥åˆ†æ”¯çš„åªèƒ½æ˜¯<code>ç¬¬ä¸€ä¸ª</code>æ¥è·å–å…±äº«é”çš„çº¿ç¨‹ï¼Œæ‰€ä»¥è¿™ä¸ªåˆ†æ”¯è®¾ç½®å±æ€§æ—¶ä¸éœ€è¦è¿›è¡ŒåŒæ­¥æ“ä½œã€‚</p>
</li>
<li>
<p>è‹¥<code>r != 0</code>ï¼Œè¿›å…¥<code>else if åˆ†æ”¯</code>ï¼Œæ­¤æ—¶<code>firstReader != null</code>å¿…æˆç«‹ï¼Œè‹¥<code>firstReader = current</code>ï¼Œè¯´æ˜å½“å‰çº¿ç¨‹æ˜¯ç¬¬ä¸€ä¸ªè·å–å…±äº«é”çš„çº¿ç¨‹ï¼Œå®ƒé‡å…¥äº†ï¼Œæ‰€ä»¥è¿™é‡Œåªéœ€è¦å°†<code>firstReaderHoldCount</code>åŠ 1å³å¯ã€‚</p>
</li>
<li>
<p>è¿›å…¥æœ€åä¸€ä¸ªelseåˆ†æ”¯ï¼Œåˆ°è¿™ä¸ªåœ°æ–¹çš„çº¿ç¨‹å¿…æ˜¯<code>éç¬¬ä¸€ä¸ªè·å–å…±äº«é”çš„çº¿ç¨‹</code>ï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦æ˜ç™½æ­¤å¤„çš„ä»£ç æ˜¯æ²¡æœ‰åŒæ­¥æ“ä½œçš„ï¼Œä¸”<code>cachedHoldCounteræ²¡æœ‰ç”¨volatile</code>ä¿®é¥°çš„ï¼Œä¹Ÿå°±æ˜¯<code>ä¸‹ä¸ªçº¿ç¨‹å¯èƒ½çœ‹ä¸åˆ°ä¸Šä¸ªçº¿ç¨‹å¯¹cachedHoldCounterçš„æ“ä½œ</code>ã€‚</p>
</li>
<li>
<p>â‘ è‹¥<code>rh = null</code>ï¼Œé‚£ä¹ˆè·³è½¬â‘¢ã€‚</p>
<p>â‘¡ è‹¥<code>rh != null ä½† HC.tid != currentTid</code>ï¼Œè¯´æ˜<code>ä¸Šä¸ªè·å–è¯»é”çš„çº¿ç¨‹å’Œå½“å‰çº¿ç¨‹ä¸åŒ</code>ï¼Œè·³è½¬â‘¢ã€‚</p>
<p>â‘¢ è·å–å½“å‰çº¿ç¨‹çš„<code>HoldCounter(ç®€ç§°HC)</code>ï¼Œè·³è½¬â‘¥ã€‚</p>
<p>â‘£ è‹¥ <code>rh != null ä½† rh.tid = currentTid</code>ï¼Œè¯´æ˜<code>ä¸Šä¸ªè·å–è¯»é”çš„çº¿ç¨‹å’Œå½“å‰çº¿ç¨‹ç›¸åŒ</code>ï¼Œè¯»é”é‡å…¥äº†ï¼Œè·³è½¬â‘¤ã€‚</p>
<p>â‘¤ è‹¥ <code>rh.count = 0</code>ï¼Œè®¾ç½®<code>å½“å‰çº¿ç¨‹çš„HC = rh</code>ï¼Œè·³è½¬â‘¥ã€‚</p>
<p>â‘¥ è‡³æ­¤<code>rh = å½“å‰çº¿ç¨‹çš„HC</code>ï¼Œå°†<code>rh++çš„åŒæ—¶cachedHoldCounter++</code>ï¼Œç„¶å<code> return 1</code>ï¼ŒtryAcquireSharedæ–¹æ³•ç»“æŸã€‚</p>
</li>
<li>
<p>step5 ä¸­æ¯”è¾ƒç–‘æƒ‘çš„æ˜¯ä½•æ—¶<code>else if(rh.count == 0)</code>æˆç«‹ï¼Ÿè¿™é‡Œéœ€è¦æ¶‰åŠåˆ°è¯»é”é‡Šæ”¾çš„ä»£ç æ¥å¸®åŠ©ç†è§£ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">HoldCounter rh <span style="color:#f92672">=</span> cachedHoldCounter<span style="color:#f92672">;</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>rh <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> rh<span style="color:#f92672">.</span><span style="color:#a6e22e">tid</span> <span style="color:#f92672">!=</span> getThreadId<span style="color:#f92672">(</span>current<span style="color:#f92672">))</span>
    rh <span style="color:#f92672">=</span> readHolds<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">();</span>
<span style="color:#66d9ef">int</span> count <span style="color:#f92672">=</span> rh<span style="color:#f92672">.</span><span style="color:#a6e22e">count</span><span style="color:#f92672">;</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>count <span style="color:#f92672">&lt;=</span> 1<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    readHolds<span style="color:#f92672">.</span><span style="color:#a6e22e">remove</span><span style="color:#f92672">();</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>count <span style="color:#f92672">&lt;=</span> 0<span style="color:#f92672">)</span>
        <span style="color:#66d9ef">throw</span> unmatchedUnlockException<span style="color:#f92672">();</span>
<span style="color:#f92672">}</span>
<span style="color:#f92672">--</span>rh<span style="color:#f92672">.</span><span style="color:#a6e22e">count</span><span style="color:#f92672">;</span>
</code></pre></div><blockquote>
<p>é¦–å…ˆæˆ‘ä»¬éœ€è¦æ˜ç¡®ï¼Œåœ¨<code>è¯»é”é‡Šæ”¾è¿‡ç¨‹ä¸­ï¼Œå®ƒåªæ˜¯æ¸…ç©ºäº†çº¿ç¨‹çš„è²Œç§æœ‰HCï¼Œå¹¶æ²¡æœ‰å¤„ç†cHC</code>ã€‚</p>
<p>æˆ‘ä»¬å‡è®¾çº¿ç¨‹Aï¼ˆéç¬¬ä¸€ä¸ªè·å–è¯»é”çš„çº¿ç¨‹ï¼‰è·å–äº†è¯»é”ï¼Œé‡Šæ”¾è¯»é”åå†ä¸€æ¬¡è·å–è¯»é”è¿™ä¸ªæµç¨‹æ¥åˆ†æï¼š</p>
<ol>
<li>çº¿ç¨‹Aè·å–è¯»é”æˆåŠŸè¿›å…¥elseåˆ†æ”¯åï¼Œå®ƒä¼šè®¾ç½®<code>threadA.HoldCounter.count = cacheHoldCounter = 1</code>ï¼Œè¿›çº¿ç¨‹Aè¯»é”é‡Šæ”¾ï¼Œ<code>rh = cacheHoldCounter != null</code>ä¸”æ­¤æ—¶count = 1ï¼Œæ‰§è¡Œ<code>readHolds.remove()</code>ï¼Œç„¶å<code>--rh.count</code>ï¼Œè¿™æ ·<code>cacheHoldCounter.countä¹Ÿè¦å‡1ï¼Œå˜æˆäº†0</code>ã€‚</li>
<li>æ­¤æ—¶çº¿ç¨‹Aç»§ç»­è·å–è¯»é”æˆåŠŸï¼Œè¿›å…¥è¯»é”elseåˆ¤æ–­æµç¨‹å‘ç°<code>rh = cacheHoldCounter != null</code>ï¼Œä¸”<code>rh.tid = currentTid</code>ï¼Œæ‰€ä»¥æ‰§è¡Œ<code>else if (rh.count == 0)</code>åˆ¤æ–­ï¼Œæ­¤æ—¶è¯¥æ¡ä»¶æˆç«‹ï¼Œå¹¶ä¸”å½“å‰çº¿ç¨‹çš„HC = nullï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦è®¾ç½®å½“å‰çº¿ç¨‹çš„HCã€‚ä»£ç çš„ç›®çš„å°±æ˜¯ä¸ºäº†ä¿è¯<code>è¯»é”çš„è·å–-é‡Šæ”¾ä¹‹åå†è·å–è¯»é”æ—¶ï¼Œä¸ä¼šå› ä¸ºä¹‹å‰è¯»é”çš„é‡Šæ”¾å¯¼è‡´å½“å‰çº¿ç¨‹çš„HCä¸ºnull</code>ã€‚</li>
</ol>
</blockquote>
</li>
<li>
<p>è·å–å…±äº«é”æˆåŠŸåçš„ä»£ç ï¼Œéƒ½æ˜¯åœ¨å¤„ç†</p>
<p><code>firstReader</code>ï¼šç¬¬ä¸€ä¸ªè·å–è¯»é”çš„çº¿ç¨‹ã€‚</p>
<p><code>firstReaderHoldCount</code>ï¼šç¬¬ä¸€ä¸ªè·å–è¯»é”çš„çº¿ç¨‹è·å–è¯»é”æ¬¡æ•°ã€‚</p>
<p><code>cachedHoldCounter</code>ï¼šè·å–æœ€æ–°è·å–è¯»é”çš„çº¿ç¨‹çš„HoldCounterã€‚</p>
<p><code>HoldCounter.count</code>ï¼šå°†æ¯ä¸ªçº¿ç¨‹è·å–çš„è¯»é”æ¬¡æ•°è®°å½•åœ¨æœ¬åœ°çº¿ç¨‹ä¸­ã€‚</p>
</li>
</ol>
</blockquote>
</li>
</ul>
<h4 id="apparentlyfirstqueuedisexclusive">apparentlyFirstQueuedIsExclusive</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// ä¸€å®šæ¦‚ç‡é˜²æ­¢è¯»é”éå…¬å¹³è·å–é”ï¼Œè®©å®ƒå»æ’é˜Ÿï¼Œè®©å†™é”ä¸è¦æ— é™ç­‰å¾…ã€‚
</span><span style="color:#75715e"></span><span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">apparentlyFirstQueuedIsExclusive</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    Node h<span style="color:#f92672">,</span> s<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span>h <span style="color:#f92672">=</span> head<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span>
        <span style="color:#f92672">(</span>s <span style="color:#f92672">=</span> h<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">)</span>  <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span>
        <span style="color:#f92672">!</span>s<span style="color:#f92672">.</span><span style="color:#a6e22e">isShared</span><span style="color:#f92672">()</span>         <span style="color:#f92672">&amp;&amp;</span>
        s<span style="color:#f92672">.</span><span style="color:#a6e22e">thread</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<ol>
<li>å¦‚æœheadçš„nextèŠ‚ç‚¹ä¸å­˜åœ¨ï¼ˆé˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªç­‰å¾…çš„èŠ‚ç‚¹ï¼‰ç›´æ¥è¿”å›falseï¼›</li>
<li>å¦‚æœé˜Ÿåˆ—ç¬¬ä¸€ä¸ªç­‰å¾…èŠ‚ç‚¹æ˜¯<code>Sharedè¯»</code>èŠ‚ç‚¹ï¼Œé‚£ä¹ˆè¿”å›falseï¼Œå½“å‰çº¿ç¨‹å°±å¯ä»¥è·å–è¯»é”ã€‚</li>
<li>å¦‚æœé˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ªç­‰å¾…èŠ‚ç‚¹æ˜¯<code>EXCLUSIVEå†™é”</code>ï¼Œé‚£ä¹ˆè¿”å›trueï¼Œå½“å‰çº¿ç¨‹å°±ä¸èƒ½è·å–è¯»é”ã€‚</li>
<li>æ–¹æ³•ç›®çš„ï¼š<code>ä¸€å®šæ¦‚ç‡é˜»æ­¢è¯»é”éå…¬å¹³è·å–åŠ¨ä½œï¼Œå¦‚æœç¬¬ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å†™é”ï¼Œè®©è¯»é”å»æ’é˜Ÿï¼Œé˜²æ­¢å†™é”æ— é™ç­‰å¾…ï¼ˆæ³¨æ„æ˜¯ä¸€å®šæ¦‚ç‡ï¼Œå¦‚æœç¬¬ä¸€ä¸ªæ˜¯è¯»é”ï¼Œç¬¬äºŒä¸ªæ˜¯å†™é”ï¼Œå°±ä¸ä¼šæ’é˜Ÿï¼‰ï¼Œæ˜¯éå®Œå…¨ä¸å…¬å¹³è¯»é”ã€‚</code></li>
</ol>
</blockquote>
<h4 id="fulltryacquireshared">fullTryAcquireShared</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// ç¬¬ä¸€æ¬¡å°è¯•è·å–å…±äº«é”å¤±è´¥å°±ä¼šè¿›å…¥æ­¤æ–¹æ³•
</span><span style="color:#75715e"></span><span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">fullTryAcquireShared</span><span style="color:#f92672">(</span>Thread current<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// å®šä¹‰å±€éƒ¨å˜é‡rh
</span><span style="color:#75715e"></span>    HoldCounter rh <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
    <span style="color:#75715e">// å¾ªç¯è·å–å…±äº«é”
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(;;)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// è·å–state
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">int</span> c <span style="color:#f92672">=</span> getState<span style="color:#f92672">();</span>
        <span style="color:#75715e">// å¦‚æœå­˜åœ¨å†™é”ï¼Œå½“å‰çº¿ç¨‹ä¸æ˜¯å†™é”çš„æŒæœ‰çº¿ç¨‹ï¼Œç›´æ¥æŠ›é”™ã€‚
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>exclusiveCount<span style="color:#f92672">(</span>c<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>getExclusiveOwnerThread<span style="color:#f92672">()</span> <span style="color:#f92672">!=</span> current<span style="color:#f92672">)</span>
                <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span>1<span style="color:#f92672">;</span>
            <span style="color:#66d9ef">else</span> 
                <span style="color:#75715e">// do nothing
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// å¦‚æœåœ¨è¿™ä¸ªelseåˆ†æ”¯ä¸­return -1ï¼Œä¼šå¯¼è‡´æ­»é”
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// å› ä¸ºå†™é”çš„æŒæœ‰çº¿ç¨‹è·å–å…±äº«é”å¤±è´¥ï¼Œä¼šè¢«é˜»å¡ï¼Œé‚£å°±æ²¡äººå”¤é†’å®ƒäº†
</span><span style="color:#75715e"></span>                
        <span style="color:#75715e">// æ‰§è¡Œåˆ°æ­¤å¤„è¯´æ˜ä¸å­˜åœ¨å†™é” 
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// éå…¬å¹³é”éœ€è¦åˆ¤æ–­é˜Ÿåˆ—ç¬¬ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¦æ˜¯å†™é”åœ¨ç­‰å¾…
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// å…¬å¹³é”éœ€è¦æŸ¥çœ‹é˜Ÿåˆ—æ˜¯å¦æœ‰headåç»§èŠ‚ç‚¹åœ¨ç­‰å¾…
</span><span style="color:#75715e"></span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>readerShouldBlock<span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// æ‰§è¡Œè‡³æ­¤è¯´æ˜æš‚æ— å†™é”ï¼Œä½†é˜Ÿåˆ—ä¸­æœ‰headåç»§èŠ‚ç‚¹åœ¨ç­‰å¾…ï¼ˆå…¬å¹³ï¼‰
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// ä¸€èˆ¬æœ‰ç­‰å¾…çš„èŠ‚ç‚¹ç›´æ¥è¿”å›-1ï¼Œç»§ç»­æ‰§è¡Œä»£ç çš„åŸå› æ˜¯å› ä¸ºéœ€è¦åˆ¤æ–­è¯»é”æ˜¯å¦é‡å…¥
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// æŸ¥çœ‹ç¬¬ä¸€ä¸ªè·å–å…±äº«é”æ˜¯å¦æ˜¯å½“å‰çº¿ç¨‹
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>firstReader <span style="color:#f92672">==</span> current<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// æ‰§è¡Œåˆ°æ­¤å¤„è¯´æ˜å½“å‰çº¿ç¨‹æ˜¯æŒæœ‰è¯»é”çš„ï¼Œä¸”æ˜¯ç¬¬ä¸€æ¬¡è·å–è¯»é”çš„çº¿ç¨‹
</span><span style="color:#75715e"></span>            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>rh <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    rh <span style="color:#f92672">=</span> cachedHoldCounter<span style="color:#f92672">;</span>
                    <span style="color:#75715e">// åˆ¤æ–­å½“å‰æ˜¯å¦è·å–äº†è¯»é”ï¼Œè‹¥æ²¡æœ‰åˆ™å°†å½“å‰çº¿ç¨‹çš„HCç½®ä¸ºnull
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>rh <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> rh<span style="color:#f92672">.</span><span style="color:#a6e22e">tid</span> <span style="color:#f92672">!=</span> getThreadId<span style="color:#f92672">(</span>current<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                        rh <span style="color:#f92672">=</span> readHolds<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">();</span>
                        <span style="color:#75715e">// æ‰§è¡Œåˆ°è¿™è¯´æ˜å½“å‰çº¿ç¨‹ç¬¬ä¸€æ¬¡è·å–è¯»é”
</span><span style="color:#75715e"></span>                        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>rh<span style="color:#f92672">.</span><span style="color:#a6e22e">count</span> <span style="color:#f92672">==</span> 0<span style="color:#f92672">)</span>
                            readHolds<span style="color:#f92672">.</span><span style="color:#a6e22e">remove</span><span style="color:#f92672">();</span>
                    <span style="color:#f92672">}</span>
                <span style="color:#f92672">}</span>
                <span style="color:#75715e">// 1. rh=cachedHoldCounter=!=null æ˜¯å½“å‰çº¿ç¨‹çš„HCï¼Œrh.count!=0
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// 2. rh=å½“å‰çº¿ç¨‹HCï¼ŒcachedHoldCounter=nullï¼Œ rh.count=0
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>rh<span style="color:#f92672">.</span><span style="color:#a6e22e">count</span> <span style="color:#f92672">==</span> 0<span style="color:#f92672">)</span>
                    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span>1<span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
        <span style="color:#75715e">// è‡³æ­¤å½“å‰çº¿ç¨‹å¯ä»¥è·å–è¯»é”
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// åˆ¤æ–­è¯»é”countæ˜¯å¦è¶…è¿‡MAX_COUNT
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>sharedCount<span style="color:#f92672">(</span>c<span style="color:#f92672">)</span> <span style="color:#f92672">==</span> MAX_COUNT<span style="color:#f92672">)</span>
            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Maximum lock count exceeded&#34;</span><span style="color:#f92672">);</span>
        <span style="color:#75715e">// CASä¿®æ”¹state
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>compareAndSetState<span style="color:#f92672">(</span>c<span style="color:#f92672">,</span> c <span style="color:#f92672">+</span> SHARED_UNIT<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// è¿™é‡Œçš„é€»è¾‘ä¸tryAcquireSharedç±»ä¼¼
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>sharedCount<span style="color:#f92672">(</span>c<span style="color:#f92672">)</span> <span style="color:#f92672">==</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                firstReader <span style="color:#f92672">=</span> current<span style="color:#f92672">;</span>
                firstReaderHoldCount <span style="color:#f92672">=</span> 1<span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>firstReader <span style="color:#f92672">==</span> current<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                firstReaderHoldCount<span style="color:#f92672">++;</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// è¿™éƒ¨åˆ†å°±æ˜¯è®¾ç½®æ¯ä¸ªçº¿ç¨‹è·å–è¯»é”çš„count
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>rh <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
                    rh <span style="color:#f92672">=</span> cachedHoldCounter<span style="color:#f92672">;</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>rh <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> rh<span style="color:#f92672">.</span><span style="color:#a6e22e">tid</span> <span style="color:#f92672">!=</span> getThreadId<span style="color:#f92672">(</span>current<span style="color:#f92672">))</span>
                    rh <span style="color:#f92672">=</span> readHolds<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">();</span>
                <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>rh<span style="color:#f92672">.</span><span style="color:#a6e22e">count</span> <span style="color:#f92672">==</span> 0<span style="color:#f92672">)</span>
                    readHolds<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>rh<span style="color:#f92672">);</span>
                rh<span style="color:#f92672">.</span><span style="color:#a6e22e">count</span><span style="color:#f92672">++;</span>
                <span style="color:#75715e">// è®¾ç½®cachedHoldCounter = æœ€æ–°è·å–è¯»é”æˆåŠŸçš„çº¿ç¨‹çš„HC
</span><span style="color:#75715e"></span>                cachedHoldCounter <span style="color:#f92672">=</span> rh<span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">return</span> 1<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<ol>
<li>
<p>å¦‚æœ<code>å­˜åœ¨å†™é”ï¼Œä½†å½“å‰çº¿ç¨‹ä¸æ˜¯å†™é”çš„æŒæœ‰çº¿ç¨‹</code>ï¼Œç›´æ¥è¿”å›-1ï¼Œè·å–å…±äº«é”å¤±è´¥ã€‚è‹¥å½“å‰çº¿ç¨‹æ˜¯å†™é”çš„æŒæœ‰çº¿ç¨‹ï¼Œé‚£ä¹ˆç›´æ¥å°è¯•è·å–è¯»é”ã€‚</p>
</li>
<li>
<p>ä¸ä¹‹å‰<code>readerShouldBlock</code>æ–¹æ³•è¿”å›trueç›´æ¥å…±äº«é”è·å–å¤±è´¥ä¸åŒï¼Œè¿™é‡Œéœ€è¦ç»§ç»­<code>åˆ¤æ–­æ˜¯å¦è¯»é”é‡å…¥</code>çš„æƒ…å†µã€‚å¦‚æœå½“å‰çº¿ç¨‹å·²è·å–è¿‡è¯»é”ï¼Œé‚£ä¹ˆç›´æ¥è·å–å…±äº«é”ï¼Œå¦åˆ™è¿”å›-1å»æ’é˜Ÿã€‚</p>
</li>
<li>
<p><code>firstReader = current</code>è¯´æ˜å½“å‰çº¿ç¨‹æ˜¯ç¬¬ä¸€ä¸ªè·å–å…±äº«é”çš„çº¿ç¨‹ï¼Œå¹¶ä¸”å½“å‰çº¿ç¨‹å‡†å¤‡é‡å…¥é”ï¼Œæ‰€ä»¥ç›´æ¥å‡†å¤‡è·å–è¯»é”ã€‚</p>
</li>
<li>
<p><code>firstReader != current</code>å°±æ— æ³•å¿«é€Ÿåˆ¤æ–­äº†ï¼Œæ ¹æ®ä¹‹å‰tryAcquireSharedä¸­ç±»ä¼¼çš„ä»£ç ï¼Œæ‰§è¡Œåˆ°ç¬¬ä¸€ä¸ª<code>if (rh.count == 0)</code>ä»£ç å‰ï¼Œè¯´æ˜<code>rh = å½“å‰çº¿ç¨‹çš„HC = new HoldCounter</code>ï¼Œè¯´æ˜å½“å‰çº¿ç¨‹æ˜¯ç¬¬ä¸€æ¬¡è·å–è¯»é”ï¼Œæ­¤æ—¶ç¬¬ä¸€ä¸ª<code>if (rh.count == 0)</code>å¿…å®šæˆç«‹ï¼Œéœ€è¦ç§»é™¤<code>å½“å‰çº¿ç¨‹çš„HoldCounter</code>ï¼ˆä¸ºä»€ä¹ˆï¼Ÿ<code>å› ä¸ºå½“çº¿ç¨‹æ²¡æœ‰è¯»é”çš„æ—¶å€™ï¼Œå½“å‰çº¿ç¨‹çš„HoldCounter = null</code>ï¼‰ï¼Œè¿™æ ·ç»§ç»­æ‰§è¡Œåˆ°ç¬¬äºŒä¸ª<code>rh.count == 0</code>æˆç«‹ï¼Œè¿”å›-1å¹¶é€€å‡ºã€‚</p>
</li>
<li>
<p>å¦‚æœä¸æ‰§è¡Œç¬¬ä¸€ä¸ªè€Œæ˜¯æ‰§è¡Œåˆ°<code>if (rh.count == 0)</code>å‰ï¼Œè¯´æ˜å½“å‰çº¿ç¨‹æ˜¯é‡å…¥é”ï¼Œé‚£ä¹ˆ<code>rh.count != 0</code>å¿…å®šæˆç«‹ï¼Œæ‰€ä»¥ç»§ç»­æ‰§è¡Œå‡†å¤‡è·å–å…±äº«é”ã€‚step4å’Œstep5çš„ä½œç”¨å°±æ˜¯ï¼š<code>å…ˆåˆ¤æ–­å½“é˜Ÿåˆ—ç¬¬ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å†™é”æ—¶ï¼ˆéå…¬å¹³ï¼‰ï¼Œå†åˆ¤æ–­å¦‚æœæ˜¯é‡å…¥è¯»é”å¯ä»¥è·å–ï¼Œå¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è·å–è¯»é”åˆ™ä¸èƒ½è·å–</code></p>
</li>
<li>
<p>ä¸‹é¢è·å–å…±äº«é”çš„ä»£ç é€»è¾‘ä¸<code>tryAcquirShared</code>ä½œç”¨ç±»ä¼¼ï¼Œéƒ½æ˜¯è·å–è¯»é”æˆåŠŸçš„å–„åå·¥ä½œã€‚</p>
</li>
</ol>
</blockquote>
<hr>
<h3 id="trylock">tryLock</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">tryReadLock</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    Thread current <span style="color:#f92672">=</span> Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">currentThread</span><span style="color:#f92672">();</span>
    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(;;)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">int</span> c <span style="color:#f92672">=</span> getState<span style="color:#f92672">();</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>exclusiveCount<span style="color:#f92672">(</span>c<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> 0 <span style="color:#f92672">&amp;&amp;</span>
            getExclusiveOwnerThread<span style="color:#f92672">()</span> <span style="color:#f92672">!=</span> current<span style="color:#f92672">)</span>
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">int</span> r <span style="color:#f92672">=</span> sharedCount<span style="color:#f92672">(</span>c<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>r <span style="color:#f92672">==</span> MAX_COUNT<span style="color:#f92672">)</span>
            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Maximum lock count exceeded&#34;</span><span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>compareAndSetState<span style="color:#f92672">(</span>c<span style="color:#f92672">,</span> c <span style="color:#f92672">+</span> SHARED_UNIT<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>r <span style="color:#f92672">==</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                firstReader <span style="color:#f92672">=</span> current<span style="color:#f92672">;</span>
                firstReaderHoldCount <span style="color:#f92672">=</span> 1<span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>firstReader <span style="color:#f92672">==</span> current<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                firstReaderHoldCount<span style="color:#f92672">++;</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                HoldCounter rh <span style="color:#f92672">=</span> cachedHoldCounter<span style="color:#f92672">;</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>rh <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> rh<span style="color:#f92672">.</span><span style="color:#a6e22e">tid</span> <span style="color:#f92672">!=</span> getThreadId<span style="color:#f92672">(</span>current<span style="color:#f92672">))</span>
                    cachedHoldCounter <span style="color:#f92672">=</span> rh <span style="color:#f92672">=</span> readHolds<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">();</span>
                <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>rh<span style="color:#f92672">.</span><span style="color:#a6e22e">count</span> <span style="color:#f92672">==</span> 0<span style="color:#f92672">)</span>
                    readHolds<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>rh<span style="color:#f92672">);</span>
                rh<span style="color:#f92672">.</span><span style="color:#a6e22e">count</span><span style="color:#f92672">++;</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<p>tryLockå’Œæˆ‘ä»¬åˆ†æçš„tryAcquireSharedç±»ä¼¼ï¼Œè¿”å›å€¼ä¸åŒtryLockæ˜¯booleanå€¼ï¼ŒåŒæ—¶tryLocké‡‡ç”¨çš„æ˜¯<code>è‡ªæ—‹</code>ç›´åˆ°æˆåŠŸè·å–ï¼Œæˆ–è€…<code>å†™é”è¢«å…¶ä»–çº¿ç¨‹è·å–åˆ™è¿”å›falseï¼Œè·å–å¤±è´¥ã€‚</code></p>
</blockquote>
<h3 id="tryreleaseshared">tryReleaseShared</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// AQS.unlock
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">unlock</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    sync<span style="color:#f92672">.</span><span style="color:#a6e22e">releaseShared</span><span style="color:#f92672">(</span>1<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">releaseShared</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> arg<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>tryReleaseShared<span style="color:#f92672">(</span>arg<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        doReleaseShared<span style="color:#f92672">();</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
<span style="color:#75715e">// æˆ‘ä»¬åªåˆ†æReentrentReadWriteLock-tryReleaseSharedå…·ä½“å®ç°
</span><span style="color:#75715e"></span><span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">tryReleaseShared</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> unused<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// è·å–å½“å‰çº¿ç¨‹
</span><span style="color:#75715e"></span>    Thread current <span style="color:#f92672">=</span> Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">currentThread</span><span style="color:#f92672">();</span>
    <span style="color:#75715e">// å¦‚æœå½“å‰çº¿ç¨‹æ˜¯ç¬¬ä¸€ä¸ªè·å–è¯»é”çš„çº¿ç¨‹
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>firstReader <span style="color:#f92672">==</span> current<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// è‹¥firstReaderHoldCount = 1æˆç«‹ã€‚è¯´æ˜è¯¥çº¿ç¨‹åªè·å–äº†ä¸€æ¬¡å…±äº«é”
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>firstReaderHoldCount <span style="color:#f92672">==</span> 1<span style="color:#f92672">)</span>
            firstReader <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">else</span>
            <span style="color:#75715e">// è¯´æ˜ç¬¬ä¸€ä¸ªè·å–è¯»é”çš„çº¿ç¨‹é‡å…¥äº†è¯»é”
</span><span style="color:#75715e"></span>            firstReaderHoldCount<span style="color:#f92672">--;</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// æ‰§è¡Œåˆ°è¿™è¯´æ˜å½“å‰çº¿ç¨‹ä¸æ˜¯ç¬¬ä¸€ä¸ªè·å–è¯»é”çš„çº¿ç¨‹
</span><span style="color:#75715e"></span>        HoldCounter rh <span style="color:#f92672">=</span> cachedHoldCounter<span style="color:#f92672">;</span>
        <span style="color:#75715e">// ä¸è¯»é”è·å–ä»£ç ç±»ä¼¼
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>rh <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> rh<span style="color:#f92672">.</span><span style="color:#a6e22e">tid</span> <span style="color:#f92672">!=</span> getThreadId<span style="color:#f92672">(</span>current<span style="color:#f92672">))</span>
            rh <span style="color:#f92672">=</span> readHolds<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">();</span>
        <span style="color:#75715e">// æ‰§è¡Œåˆ°æ­¤rh = å½“å‰çº¿ç¨‹çš„HC
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// å¦‚æœrh != null ä¸” rh.tid = getThreadId(current)
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// è¯´æ˜cachedHoldCounteræ°å¥½æ˜¯å½“å‰çº¿ç¨‹çš„HC
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">int</span> count <span style="color:#f92672">=</span> rh<span style="color:#f92672">.</span><span style="color:#a6e22e">count</span><span style="color:#f92672">;</span>
        <span style="color:#75715e">// å¦‚æœrh.count &gt; 1è¯´æ˜è¯¥çº¿ç¨‹çš„è¯»é”é‡å…¥äº†
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// å¦‚æœrh.count = 1è¯´æ˜è¯¥çº¿ç¨‹çš„è¯»é”è·å–äº†ä¸€æ¬¡
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>count <span style="color:#f92672">&lt;=</span> 1<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// æ¸…ç©ºå½“å‰çº¿ç¨‹çš„HoldCounterï¼Œä½†æ˜¯ä¸å¤„ç†cachedHoldCounter
</span><span style="color:#75715e"></span>            readHolds<span style="color:#f92672">.</span><span style="color:#a6e22e">remove</span><span style="color:#f92672">();</span>
            <span style="color:#75715e">// å¦‚æœrh.count = 0è¯´æ˜å½“å‰çº¿ç¨‹æ²¡æœ‰æŒæœ‰è¿‡è¯»é”ï¼ŒæŠ›å¼‚å¸¸
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>count <span style="color:#f92672">&lt;=</span> 0<span style="color:#f92672">)</span>
                <span style="color:#66d9ef">throw</span> unmatchedUnlockException<span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>
        <span style="color:#75715e">// å°†rh.countå‡1çš„åŒæ—¶ï¼Œå¦‚æœcachedHoldCounter!= null
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// cachedHoldCounter.count ä¹Ÿè¦å‡1
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// å› ä¸ºä»–ä»¬æŒ‡å‘äº†éƒ½æ˜¯å½“å‰çº¿ç¨‹ç§æœ‰çš„HoldCounter
</span><span style="color:#75715e"></span>        <span style="color:#f92672">--</span>rh<span style="color:#f92672">.</span><span style="color:#a6e22e">count</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    <span style="color:#75715e">//è™½ç„¶è¯»é”å‡1äº†ï¼Œä½†æ˜¯å…³é”®å˜é‡stateè¿˜æ²¡æœ‰ä¿®æ”¹
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(;;)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">int</span> c <span style="color:#f92672">=</span> getState<span style="color:#f92672">();</span>
        <span style="color:#66d9ef">int</span> nextc <span style="color:#f92672">=</span> c <span style="color:#f92672">-</span> SHARED_UNIT<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>compareAndSetState<span style="color:#f92672">(</span>c<span style="color:#f92672">,</span> nextc<span style="color:#f92672">))</span>
            <span style="color:#75715e">// åªæœ‰å½“è¯»å†™é”å…¨éƒ¨é‡Šæ”¾äº†ï¼Œæ‰ä¼šè¿”å›trueï¼Œå¦åˆ™ä¸€ç›´æ˜¯false
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">return</span> nextc <span style="color:#f92672">==</span> 0<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<ol>
<li>è¯»é”çš„é‡Šæ”¾å®¹æ˜“ç†è§£ï¼Œå°±æ˜¯åˆ¤æ–­å½“å‰çº¿ç¨‹çš„è¯»é”æ˜¯å¦æ˜¯é‡å…¥é”ï¼Œä»¥åŠå°†æ¯ä¸ªçº¿ç¨‹ä¸­çš„<code>HoldCounter</code>ä¸­çš„<code>count-1</code>ã€‚</li>
<li>éœ€è¦æ³¨æ„æ‰§è¡Œåˆ°<code>--rh.count;</code>ï¼Œå¦‚æœ<code>cachedHoldCounter != nullï¼ˆè¯´æ˜cachedHoldCounter æ°å¥½æ˜¯å½“å‰çº¿ç¨‹çš„HCï¼‰</code>é‚£ä¹ˆé™¤äº†<code>rh.countï¼ŒcachedHoldCounter.count</code>ä¹Ÿéœ€è¦å‡1ã€‚</li>
<li><code>if (count &lt;= 1) </code>ä½•æ—¶<code>count = 0</code>ï¼Ÿè¯´æ˜å½“å‰çº¿ç¨‹æ²¡æœ‰æŒæœ‰è¿‡è¯»é”ï¼Œå°±è°ƒç”¨äº†é‡Šæ”¾è¯»é”çš„æ–¹æ³•ã€‚</li>
<li>åªæœ‰è¯»å†™é”å®Œå…¨é‡Šæ”¾ï¼ŒtryReleaseSharedæ‰è¿”å›trueï¼Œç»§è€Œè°ƒç”¨<code>doReleaseShared</code>æ–¹æ³•ã€‚</li>
</ol>
</blockquote>
<hr>
<h3 id="é”å‡çº§ä¸é™çº§">é”å‡çº§ä¸é™çº§</h3>
<p>è¯»é”çº¿ç¨‹å¤šä¸ªçº¿ç¨‹å…±äº«çš„ï¼Œè€Œå†™é”å•ä¸ªçº¿ç¨‹ç‹¬å çš„ï¼Œæ‰€ä»¥å†™é”çš„å¹¶å‘é™åˆ¶æ¯”è¯»é”é«˜ã€‚</p>
<p>åŸºäºä»¥ä¸Šå®šä¹‰ï¼š</p>
<ul>
<li>
<p>åŒä¸€ä¸ªçº¿ç¨‹ä¸­ï¼Œ<code>åœ¨é‡Šæ”¾è¯»é”çš„å‰ï¼Œè·å–äº†å†™é”</code>ï¼Œè¿™ç§æƒ…å†µå«åš<code>é”å‡çº§</code>ï¼ˆè¯»å†™é”ä¸æ”¯æŒï¼‰ã€‚</p>
<p>æˆ‘ä»¬çŸ¥é“è·å–å†™é”çš„å‰ææ¡ä»¶æ˜¯<code>è¯»é”é‡Šæ”¾å®Œæ¯•</code>ï¼Œå‡è®¾æ­¤æ—¶æœ‰ä¸¤ä¸ªè¯»é”çº¿ç¨‹éƒ½æƒ³è·å–å†™é”ï¼Œè¿™ä¸¤ä¸ªçº¿ç¨‹éƒ½æƒ³é‡Šæ”¾é™¤è‡ªå·±ä»¥å¤–çš„è¯»é”ï¼Œä½†æ˜¯ä»–ä»¬éƒ½åœ¨ç­‰å¯¹æ–¹é‡Šæ”¾ï¼Œé‚£ä¹ˆä¼šå¯¼è‡´<code>æ­»é”</code>ã€‚ç©¶å…¶åŸå› ï¼šè¯»é”æ˜¯å¤šçº¿ç¨‹å…±äº«çš„ï¼Œå¤§å®¶éƒ½æœ‰è¯»é”ï¼Œå‡­å•¥æˆ‘è¦è®©ç€ä½ å»é‡Šæ”¾æˆ‘è‡ªå·±çš„è¯»é”ï¼Œéƒ½ä¸è®©é‚£å°±æ­»é”äº†ã€‚</p>
</li>
<li>
<p>åŒä¸€ä¸ªçº¿ç¨‹ä¸­ï¼Œ<code>åœ¨é‡Šæ”¾å†™é”çš„å‰ï¼Œè·å–äº†è¯»é”</code>ï¼Œè¿™ç§æƒ…å†µå«åš<code>é”é™çº§</code>ï¼ˆè¯»å†™é”æ”¯æŒï¼‰ã€‚</p>
<p>é‚£ä¸ºä»€ä¹ˆæ”¯æŒé”é™çº§å‘¢ï¼Ÿå› ä¸º<code>å†™é”æ˜¯ç‹¬å çš„</code>ï¼Œæ­¤åˆ»åªæœ‰æˆ‘ä¸€ä¸ªäººæŒæœ‰å†™é”ï¼Œæ‰€ä»¥æˆ‘æƒ³è·å–è¯»é”å°±è·å–ï¼Œä¸ä¼šæœ‰å…¶ä»–äººå’Œæˆ‘æŠ¢è¯»é”ï¼ˆé™¤éè¿™ä¸ªè¯»é”æœ¬èº«ï¼Œä½†åªæ˜¯è¯»é”é‡å…¥è€Œå·²ä¸ä¼šäº§ç”Ÿç«äº‰ï¼‰ã€‚</p>
</li>
</ul>
<h3 id="æ€»ç»“">æ€»ç»“ï¼š</h3>
<ul>
<li>
<p>å¦‚æœæœ‰ä¸€çº¿ç¨‹æŒæœ‰è¯»é”ï¼Œé‚£ä¹ˆæ­¤æ—¶å…¶ä»–çº¿ç¨‹ï¼ˆåŒ…æ‹¬å·²æŒæœ‰è¯»é”çº¿ç¨‹ï¼‰æ— æ³•è·å–å†™é”<code>ï¼ˆè·å–å†™é”çš„å‰ææ¡ä»¶æ˜¯æ‰€æœ‰çš„è¯»é”é‡Šæ”¾å®Œæ¯•ï¼‰</code>ã€‚</p>
</li>
<li>
<p>å¦‚æœæœ‰ä¸€çº¿ç¨‹æŒæœ‰è¯»é”ï¼Œé‚£ä¹ˆå…¶ä»–çº¿ç¨‹ï¼ˆåŒ…æ‹¬å·²æŒæœ‰è¯»é”çº¿ç¨‹ï¼‰æ˜¯å¯ä»¥è·å–è¯»é”çš„ï¼Œè¯»å†™äº’æ–¥ï¼Œè¯»è¯»ä¸äº’æ–¥ã€‚</p>
</li>
<li>
<p>å¦‚æœæœ‰ä¸€çº¿ç¨‹æŒæœ‰å†™é”ï¼Œï¼ˆé™¤éæ˜¯æŒæœ‰å†™é”çº¿ç¨‹æœ¬èº«ï¼‰å¦åˆ™å…¶ä»–çº¿ç¨‹éƒ½ä¸èƒ½è·å–è¯»é”/å†™é”ã€‚å†™è¯»/å†™å†™äº’æ–¥ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CachedDate</span> <span style="color:#f92672">{</span>
    Object data<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">volatile</span> <span style="color:#66d9ef">boolean</span> cacheValid<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">final</span> ReentrantReadWriteLock rwl <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ReentrantReadWriteLock<span style="color:#f92672">();</span>
  
    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">processCachedData</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// å…ˆè·å–è¯»é”
</span><span style="color:#75715e"></span>        rwl<span style="color:#f92672">.</span><span style="color:#a6e22e">readLock</span><span style="color:#f92672">().</span><span style="color:#a6e22e">lock</span><span style="color:#f92672">();</span>
        <span style="color:#75715e">// åˆ¤æ–­cacheValidå³ç¼“å­˜æ˜¯å¦å¯ç”¨
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>cacheValid<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// åˆ°è¿™é‡Œè¯´æ˜cacheå¯ç”¨å‡†å¤‡å†™å€¼
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// éœ€è¦å…ˆé‡Šæ”¾è¯»é”åœ¨è·å–å†™é”
</span><span style="color:#75715e"></span>            rwl<span style="color:#f92672">.</span><span style="color:#a6e22e">readLock</span><span style="color:#f92672">().</span><span style="color:#a6e22e">unlock</span><span style="color:#f92672">();</span>
            rwl<span style="color:#f92672">.</span><span style="color:#a6e22e">writeLock</span><span style="color:#f92672">().</span><span style="color:#a6e22e">lock</span><span style="color:#f92672">();</span>
            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// éœ€è¦å†æ¬¡ç®€è¦cacheValidï¼Œé˜²æ­¢å…¶ä»–çº¿ç¨‹åœ¨æ­¤æœŸé—´æ”¹è¿‡è¯¥å€¼
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// åœ¨useæ–¹æ³•ä¹‹å‰è·å–å†™é”å†™å…¥dataå€¼åŠä¿®æ”¹cacheValidçŠ¶æ€
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>cacheValid<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    data <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">currentTimeMillis</span><span style="color:#f92672">();</span>
                    cacheValid <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
                <span style="color:#75715e">// è¿™é‡Œå°±æ˜¯é”é™çº§ã€‚åœ¨å†™é”é‡Šæ”¾ä¹‹å‰å…ˆè·å–è¯»é”ã€‚
</span><span style="color:#75715e"></span>                rwl<span style="color:#f92672">.</span><span style="color:#a6e22e">readLock</span><span style="color:#f92672">().</span><span style="color:#a6e22e">lock</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// é‡Šæ”¾å†™é”
</span><span style="color:#75715e"></span>                rwl<span style="color:#f92672">.</span><span style="color:#a6e22e">writeLock</span><span style="color:#f92672">().</span><span style="color:#a6e22e">unlock</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
        <span style="color:#75715e">// æ¨¡æ‹Ÿæ‰§è¡Œuseå‰çš„è€—æ—¶æ“ä½œ
</span><span style="color:#75715e"></span>      Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">sleep</span><span style="color:#f92672">(</span>1000L<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// å¯¹ç¼“å­˜æ•°æ®è¿›è¡Œæ‰“å°
</span><span style="color:#75715e"></span>            use<span style="color:#f92672">(</span>data<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// æœ€ç»ˆé‡Šæ”¾è¯»é”
</span><span style="color:#75715e"></span>            rwl<span style="color:#f92672">.</span><span style="color:#a6e22e">readLock</span><span style="color:#f92672">().</span><span style="color:#a6e22e">unlock</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    <span style="color:#75715e">// åªæ˜¯æ‰“å°ç¼“å­˜å€¼
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">use</span><span style="color:#f92672">(</span>Object data<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;use cache data &#34;</span> <span style="color:#f92672">+</span> data<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<p>Qï¼šä¸ºä»€ä¹ˆè¦åœ¨å†™é”é‡Šæ”¾å‰ï¼Œè·å–è¯»é”å‘¢ï¼Ÿ</p>
<p>Aï¼šå¦‚æœçº¿ç¨‹Aä¿®æ”¹äº†å€¼Vï¼Œåœ¨é‡Šæ”¾å†™é”å‰æ²¡æœ‰è·å–è¯»é”ï¼Œé‚£ä¹ˆåœ¨è°ƒç”¨use()æ–¹æ³•å‰ï¼Œçº¿ç¨‹Bè·å–äº†å†™é”ï¼Œå¹¶ä¿®æ”¹äº†å€¼Vï¼Œè¿™ä¸ªä¿®æ”¹<code>å¯¹çº¿ç¨‹Aæ˜¯ä¸å¯è§çš„</code>ã€‚æœ€ç»ˆæ‰“å°çš„dataå¯èƒ½æ˜¯çº¿ç¨‹Bä¿®æ”¹çš„å€¼ã€‚</p>
<p>Qï¼šé”é™çº§æ˜¯å¦æ˜¯å¿…è¦çš„ï¼Ÿ</p>
<p>Aï¼šå¦‚æœçº¿ç¨‹Aåœ¨æ‰§è¡Œuseæ—¶ä¼ é€’çš„<code>æƒ³æ˜¯è‡ªå·±ä¿®æ”¹çš„æ•°æ®ï¼Œé‚£ä¹ˆéœ€è¦é”é™çº§</code>ã€‚å¦‚æœå¸Œæœ›<code>ä¼ é€’çš„æ˜¯æœ€æ–°çš„æ•°æ®ï¼Œé‚£ä¹ˆä¸éœ€è¦é”é™çº§</code>ã€‚</p>
</blockquote>
</li>
</ul>
<h5 id="è¯»å†™é”æ€»ç»“">è¯»å†™é”æ€»ç»“</h5>
<ul>
<li>ReetrentReadWriteLocké€šè¿‡å°†stateå˜é‡åˆ†ä¸ºé«˜ä½16ä½æ¥è§£å†³è®°å½•è¯»é”å†™é”è·å–çš„æ€»æ•°ã€‚</li>
<li>è¯»é”çš„ç§æœ‰å˜HoldCounterè®°å½•è€…å½“å‰çº¿ç¨‹è·å–è¯»é”çš„æ¬¡æ•°ï¼Œåº•å±‚é€šè¿‡<code>ThreadLocal</code>å®ç°ã€‚</li>
<li>è¯»é”çš„éå…¬å¹³è·è·å–ï¼Œé€šè¿‡<code>apparentlyFirstQueuedIsExclusive</code>æ–¹æ³•ä¸€å®šæ¦‚ç‡é˜²æ­¢äº†å†™é”æ— é™ç­‰å¾…ã€‚</li>
<li>å½“çº¿ç¨‹Aè·å–å†™é”æ—¶ï¼Œä¼šå› ä¸ºå…¶ä»–æŒæœ‰<code>å†™é”ï¼ˆä¸åŒ…æ‹¬çº¿ç¨‹Aï¼‰</code>æˆ–<code>è¯»é”ï¼ˆåŒ…æ‹¬çº¿ç¨‹Aï¼‰</code>çš„çº¿ç¨‹è€Œé˜»å¡ã€‚</li>
<li>å½“çº¿ç¨‹Aè·å–è¯»é”æ—¶ï¼Œä¼šå› ä¸ºå…¶ä»–æŒæœ‰<code>å†™é”ï¼ˆä¸åŒ…æ‹¬çº¿ç¨‹A)</code>è€Œé˜»å¡ã€‚</li>
</ul>

    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h">å…¶ä»–æ–‡ç« </span>
            <hr />
          </div>
          <div class="pagination__buttons">
            
              <span class="button previous">
                <a href="https://leejay.top/post/countdownlatch/">
                  <span class="button__icon">â†</span>
                  <span class="button__text">CountDownLatch</span>
                </a>
              </span>
            
            
              <span class="button next">
                <a href="https://leejay.top/post/semaphore/">
                  <span class="button__text">Semaphore</span>
                  <span class="button__icon">â†’</span>
                </a>
              </span>
            
          </div>
        </div>
      
    


    
      
        

      
    

    </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright copyright--user">è‹ICPå¤‡18050258å·-1</div>
    
  </div>
</footer>

<script src="https://leejay.top/assets/main.js"></script>
<script src="https://leejay.top/assets/prism.js"></script>


      
    </div>

    
  </body>
</html>
