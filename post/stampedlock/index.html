<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>StampedLock</title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="description" content="JDK1.8æ–°å¢çš„å¹¶å‘å·¥å…·ï¼Œå›é¡¾ä¹‹å‰çš„ReentrentReadWriteLockï¼Œå®ƒæ˜¯æ‚²è§‚é”çš„å®ç°ï¼šåªè¦æœ‰çº¿ç¨‹è·å–äº†è¯»é”ï¼Œè·å–å†™é”çš„çº¿ç¨‹å°±éœ€è¦ç­‰å¾…ï¼Œä½†æœ‰å¯èƒ½å¯¼è‡´å†™é”æ— é™ç­‰å¾…ï¼ˆå…¶ä¸­ä½¿ç”¨äº†apparentlyFirstQueuedIsExclusiveæ–¹æ³•ä¸€å®šæ¦‚ç‡é™ä½äº†å†™é”æ— é™ç­‰å¾…çš„é—®é¢˜ï¼‰ã€‚
è€ŒStampedLockæ˜¯ä¹è§‚é”çš„å®ç°ï¼Œä¹è§‚è¯»çš„æ—¶å€™ä¸åŠ é”ï¼Œè¯»å–åå‘ç°æ•°æ®æ”¹å˜äº†å†å‡çº§ä¸ºæ‚²è§‚è¯»ï¼Œæ­¤æ—¶ä¸å†™äº’æ–¥ã€‚
@Slf4j public class StampedLockTest { private static final StampedLock LOCK = new StampedLock(); private static int x, y; static void add() { long stamp = LOCK.writeLock(); try { x &#43;= 1; y &#43;= 1; } finally { LOCK.unlockWrite(stamp); } } static void print() { // å°è¯•ä¹è§‚è¯»  long stamp = LOCK.tryOptimisticRead(); int currentX = xï¼Œ currentY = y; // å¦‚æœstampä¿®æ”¹äº†ï¼Œè¿™æ—¶å†åŠ æ‚²è§‚è¯»é”  if (!LOCK.validate(stamp)) { log.info(&amp;#34;value has changed ...&amp;#34;); stamp = LOCK."/>
<meta name="keywords" content=""/>
<meta name="robots" content="noodp"/>
<meta name="google-site-verification" content="e1ELBPEvOV5kwQNtzaLcNt-3iZy83eiNhSZkHhQPecs" />
<meta name="baidu-site-verification" content="aNoX6MUEHW" />

<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/tonsky/FiraCode@1.206/distr/fira_code.css">
<link rel="canonical" href="https://leejay.top/post/stampedlock/" />

<script type="text/javascript"
        async
        src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"
        >
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\[\[','\]\]']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] },
    'HTML-CSS': {
        showMathMenu: false 
    }
  }
});

MathJax.Hub.Queue(function() {
    
    
    
    var all = MathJax.Hub.getAllJax(), i;
    for(i = 0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
});
</script>

<style>
code.has-jax {
    font: inherit;
    font-size: 100%;
    background: inherit;
    border: inherit;
    color: #515151;
}
</style>




<link rel="stylesheet" href="https://leejay.top/assets/style.css">




<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://leejay.top/img/apple-touch-icon-144-precomposed.png">
<link rel="shortcut icon" href="https://leejay.top/img/favicon.png">



<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="StampedLock"/>
<meta name="twitter:description" content="ä¸ºäº†å®ç°æ›´å¿«çš„è¯»å†™é”æ¨¡å¼è€Œè¯ç”Ÿçš„æ¡†æ¶ï¼ŒåŸºäº`ä¹è§‚é”`ã€`è‡ªæ—‹&#43;CAS`ã€`ç±»ä¼¼AQS`çš„é€»è¾‘å®ç°"/>



<meta property="og:title" content="StampedLock" />
<meta property="og:description" content="ä¸ºäº†å®ç°æ›´å¿«çš„è¯»å†™é”æ¨¡å¼è€Œè¯ç”Ÿçš„æ¡†æ¶ï¼ŒåŸºäº`ä¹è§‚é”`ã€`è‡ªæ—‹&#43;CAS`ã€`ç±»ä¼¼AQS`çš„é€»è¾‘å®ç°" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://leejay.top/post/stampedlock/" />
<meta property="article:published_time" content="2020-07-01T10:32:01+08:00" />
<meta property="article:modified_time" content="2020-07-01T10:32:01+08:00" /><meta property="og:site_name" content="Aurora" />






  </head>
  <body class="">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a href="https://leejay.top" class="logo" style="text-decoration: none;">
  
    <span class="logo__mark"><svg xmlns="https://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367"/>
</svg></span>
    <span class="logo__text">Aurora</span>
    <span class="logo__cursor"></span>
    <span class="logo__cursor2"></span>
  
</a>
    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/categories">Categories</a></li>
        
      
        
          <li><a href="/tags">Tags</a></li>
        
      
      
    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/categories">Categories</a></li>
      
    
      
        <li><a href="/tags">Tags</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none"/>
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="https://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>
      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  
  

  <div class="post">
    <h1 class="post-title"><a href="https://leejay.top/post/stampedlock/">StampedLock</a></h1>
    <div class="post-meta">
      
        <span class="post-date">
          2020-07-01
        </span>

        
          
        
      

      
      
    </div>

    
      <span class="post-tags">
        
        ğŸ–<a href="https://leejay.top/tags/stampedlock/">StampedLock </a>&nbsp;
        
      </span>
    

    

    <div class="post-content">
      
      <p><code>JDK1.8</code>æ–°å¢çš„å¹¶å‘å·¥å…·ï¼Œå›é¡¾ä¹‹å‰çš„<code>ReentrentReadWriteLock</code>ï¼Œå®ƒæ˜¯æ‚²è§‚é”çš„å®ç°ï¼š<code>åªè¦æœ‰çº¿ç¨‹è·å–äº†è¯»é”ï¼Œè·å–å†™é”çš„çº¿ç¨‹å°±éœ€è¦ç­‰å¾…ï¼Œä½†æœ‰å¯èƒ½å¯¼è‡´å†™é”æ— é™ç­‰å¾…ï¼ˆå…¶ä¸­ä½¿ç”¨äº†apparentlyFirstQueuedIsExclusiveæ–¹æ³•ä¸€å®šæ¦‚ç‡é™ä½äº†å†™é”æ— é™ç­‰å¾…çš„é—®é¢˜ï¼‰</code>ã€‚</p>
<p>è€Œ<code>StampedLock</code>æ˜¯<code>ä¹è§‚é”</code>çš„å®ç°ï¼Œ<code>ä¹è§‚è¯»</code>çš„æ—¶å€™ä¸åŠ é”ï¼Œè¯»å–å<code>å‘ç°æ•°æ®æ”¹å˜äº†å†å‡çº§ä¸ºæ‚²è§‚è¯»ï¼Œæ­¤æ—¶ä¸å†™äº’æ–¥</code>ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Slf4j</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">StampedLockTest</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> StampedLock LOCK <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> StampedLock<span style="color:#f92672">();</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> x<span style="color:#f92672">,</span> y<span style="color:#f92672">;</span>

    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">add</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">long</span> stamp <span style="color:#f92672">=</span> LOCK<span style="color:#f92672">.</span><span style="color:#a6e22e">writeLock</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
            x <span style="color:#f92672">+=</span> 1<span style="color:#f92672">;</span>
            y <span style="color:#f92672">+=</span> 1<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
            LOCK<span style="color:#f92672">.</span><span style="color:#a6e22e">unlockWrite</span><span style="color:#f92672">(</span>stamp<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">print</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// å°è¯•ä¹è§‚è¯»
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">long</span> stamp <span style="color:#f92672">=</span> LOCK<span style="color:#f92672">.</span><span style="color:#a6e22e">tryOptimisticRead</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">int</span> currentX <span style="color:#f92672">=</span> x<span style="color:#960050;background-color:#1e0010">ï¼Œ</span> currentY <span style="color:#f92672">=</span> y<span style="color:#f92672">;</span>
        <span style="color:#75715e">// å¦‚æœstampä¿®æ”¹äº†ï¼Œè¿™æ—¶å†åŠ æ‚²è§‚è¯»é”
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>LOCK<span style="color:#f92672">.</span><span style="color:#a6e22e">validate</span><span style="color:#f92672">(</span>stamp<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            log<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;value has changed ...&#34;</span><span style="color:#f92672">);</span>
            stamp <span style="color:#f92672">=</span> LOCK<span style="color:#f92672">.</span><span style="color:#a6e22e">readLock</span><span style="color:#f92672">();</span>
            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                currentX <span style="color:#f92672">=</span> x<span style="color:#f92672">;</span>
                currentY <span style="color:#f92672">=</span> y<span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
                LOCK<span style="color:#f92672">.</span><span style="color:#a6e22e">unlockRead</span><span style="color:#f92672">(</span>stamp<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
        log<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;x: {}, y: {}&#34;</span><span style="color:#f92672">,</span> currentX<span style="color:#f92672">,</span> currentY<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> InterruptedException <span style="color:#f92672">{</span>

        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> 10<span style="color:#f92672">;</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">new</span> Thread<span style="color:#f92672">(</span>StampedLockTest<span style="color:#f92672">::</span>add<span style="color:#f92672">).</span><span style="color:#a6e22e">start</span><span style="color:#f92672">();</span>
            Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">sleep</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Random<span style="color:#f92672">().</span><span style="color:#a6e22e">nextInt</span><span style="color:#f92672">(</span>2<span style="color:#f92672">)</span> <span style="color:#f92672">*</span> 1000<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">new</span> Thread<span style="color:#f92672">(</span>StampedLockTest<span style="color:#f92672">::</span>print<span style="color:#f92672">).</span><span style="color:#a6e22e">start</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<p>å¦‚ä¸Šè¿°ä»£ç æ‰€ç¤ºï¼š</p>
<ol>
<li>ç›¸æ¯”è¯»å†™é”ï¼Œ<code>StampedLock</code>å¼•å…¥äº†ä¹è§‚é”æ¦‚å¿µï¼Œåªæœ‰å˜é‡å‘ç”Ÿæ”¹å˜æ‰å»åŠ è¯»é”ã€‚</li>
<li>é™¤æ­¤ä¹‹å¤–<code>StampedLock</code>çš„æ–¹æ³•éƒ½ä¼šè¿”å›ä¸€ä¸ª<code>ç‰ˆæœ¬å·ï¼šstampï¼ˆstateï¼‰ï¼Œç”¨æ¥ä»£è¡¨æ­¤æ—¶æ­¤åˆ»çš„ç‰ˆæœ¬</code>ã€‚</li>
</ol>
</blockquote>
<h3 id="stampedlock">StampedLock</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// ç§»ä½åŸºæ•°
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> LG_READERS <span style="color:#f92672">=</span> 7<span style="color:#f92672">;</span>
<span style="color:#75715e">// è¯»é”ä¸ªæ•°æ¯æ¬¡å¢åŠ çš„å•ä½
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">long</span> RUNIT <span style="color:#f92672">=</span> 1L<span style="color:#f92672">;</span>
<span style="color:#75715e">// ç¬¬8ä½è¡¨ç¤ºå†™é”
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">long</span> WBIT  <span style="color:#f92672">=</span> 1L <span style="color:#f92672">&lt;&lt;</span> LG_READERS<span style="color:#f92672">;</span>
<span style="color:#75715e">// ä½7ä½è¡¨ç¤ºè¯»é”
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">long</span> RBITS <span style="color:#f92672">=</span> WBIT <span style="color:#f92672">-</span> 1L<span style="color:#f92672">;</span>
<span style="color:#75715e">// æœ€å¤§è¯»çº¿ç¨‹ä¸ªæ•°
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">long</span> RFULL <span style="color:#f92672">=</span> RBITS <span style="color:#f92672">-</span> 1L<span style="color:#f92672">;</span>
<span style="color:#75715e">// å†™é”å’Œè¯»é”ä¸ªæ•°çš„äºŒè¿›åˆ¶ç 
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">long</span> ABITS <span style="color:#f92672">=</span> RBITS <span style="color:#f92672">|</span> WBIT<span style="color:#f92672">;</span>
<span style="color:#75715e">// å¯¹è¯»çº¿ç¨‹ä¸ªæ•°å–å
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">long</span> SBITS <span style="color:#f92672">=</span> <span style="color:#f92672">~</span>RBITS<span style="color:#f92672">;</span>
<span style="color:#75715e">// å°†å†™çº¿ç¨‹å·¦ç§»ä¸€ä½
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">long</span> ORIGIN <span style="color:#f92672">=</span> WBIT <span style="color:#f92672">&lt;&lt;</span> 1<span style="color:#f92672">;</span>
<span style="color:#66d9ef">public</span> <span style="color:#a6e22e">StampedLock</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    state <span style="color:#f92672">=</span> ORIGIN<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<p>åˆå§‹çŠ¶æ€<code>state = ORIGIN = 1L &lt;&lt; 8</code>ï¼Œstateç±»å‹æ˜¯<code>long</code>ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥çœ‹å‡º<code>ç¬¬8ä½è¡¨ç¤ºå†™é”çš„çŠ¶æ€</code>ï¼Œåªæœ‰0/1ä¸¤ç§æƒ…å†µï¼Œè¿™æ ·<code>å†™é”å°±ä¸æ”¯æŒé‡å…¥</code>äº†ã€‚<code>ä½7ä½è¡¨ç¤ºè¯»é”è¢«è·å–çš„æ¬¡æ•°</code>ã€‚å‰©ä¸‹çš„å…¶ä»–ä½æ˜¯ç”¨æ¥è¡¨ç¤ºç‰ˆæœ¬å·çš„ï¼Œä»–ä»¬å…±åŒæ„æˆäº†stateã€‚</p>
<p><img src="https://image.leejay.top/image/20200714/LseXmJNKqjCv.png?imageslim" alt=""></p>
</blockquote>
<table>
<thead>
<tr>
<th align="left">å˜é‡ï¼ˆlongï¼‰</th>
<th align="left">äºŒè¿›åˆ¶(64bitï¼Œçœç•¥ä¸º0)</th>
<th align="left">åè¿›åˆ¶</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">RUNIT = 1L</td>
<td align="left">0000 &hellip; 0000 0001</td>
<td align="left">1</td>
</tr>
<tr>
<td align="left"><strong>WBIT =  1L &laquo; 7</strong></td>
<td align="left">0000 &hellip; 1000 0000</td>
<td align="left">128</td>
</tr>
<tr>
<td align="left"><strong>RBITS = WBIT - 1L</strong></td>
<td align="left">0000 &hellip; 0111 1111</td>
<td align="left">127</td>
</tr>
<tr>
<td align="left">RFULL = RBITS - 1L</td>
<td align="left">0000 &hellip; 0111 1110</td>
<td align="left">126</td>
</tr>
<tr>
<td align="left"><strong>ABIT =  RBITS |  WBIT</strong></td>
<td align="left">0000 &hellip; 1111 1111</td>
<td align="left">255</td>
</tr>
<tr>
<td align="left">SBITS = ~RBITS</td>
<td align="left">1111 &hellip; 1000 0000</td>
<td align="left">-128</td>
</tr>
<tr>
<td align="left"><strong>ORIGIN =  WBIT &laquo; 1</strong></td>
<td align="left">0000 &hellip; 0001 0000 0000</td>
<td align="left">256</td>
</tr>
</tbody>
</table>
<h3 id="wait-node">Wait Node</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">WNode</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// å‰é©±èŠ‚ç‚¹
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">volatile</span> WNode prev<span style="color:#f92672">;</span>
    <span style="color:#75715e">// åç»§èŠ‚ç‚¹
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">volatile</span> WNode next<span style="color:#f92672">;</span>
    <span style="color:#75715e">// è¯»çº¿ç¨‹ä½¿ç”¨ï¼Œç±»ä¼¼æ ˆç»“æ„çš„é“¾è¡¨è¿æ¥è¯»çº¿ç¨‹
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">volatile</span> WNode cowait<span style="color:#f92672">;</span>
    <span style="color:#75715e">// èŠ‚ç‚¹æŒæœ‰çš„çº¿ç¨‹
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">volatile</span> Thread thread<span style="color:#f92672">;</span>
    <span style="color:#75715e">// èŠ‚ç‚¹çš„çŠ¶æ€ï¼š 0ã€WAITINGã€CANCELED
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">volatile</span> <span style="color:#66d9ef">int</span> status<span style="color:#f92672">;</span>
    <span style="color:#75715e">// RMODE WMODE
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> mode<span style="color:#f92672">;</span>
    <span style="color:#75715e">// æ„é€ å‡½æ•° éœ€è¦ä¼ å…¥modeå’Œå½“å‰èŠ‚ç‚¹å‰é©±èŠ‚ç‚¹
</span><span style="color:#75715e"></span>    WNode<span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> m<span style="color:#f92672">,</span> WNode p<span style="color:#f92672">)</span> <span style="color:#f92672">{</span> mode <span style="color:#f92672">=</span> m<span style="color:#f92672">;</span> prev <span style="color:#f92672">=</span> p<span style="color:#f92672">;</span> <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<p>StampedLockå†…éƒ¨ç»´æŠ¤äº†å’Œ<code>AQSçš„Nodeç±»ä¼¼</code>çš„èŠ‚ç‚¹ï¼Œä½†æœ‰å‡ ç‚¹ä¸åŒï¼š</p>
<ol>
<li>WNodeä¸­çš„<code>cowaitå±æ€§ç”¨äºå°†è¯»èŠ‚ç‚¹é€šè¿‡é“¾è¡¨çš„å½¢å¼</code>è¿›è¡Œè¿æ¥ã€‚</li>
<li>WNodeä¸­çš„statusåªæœ‰ä¸‰ç§çŠ¶æ€ï¼š<code>0ã€WAITINGã€CANCELED</code>ã€‚</li>
<li>WNodeä¸­çš„modeå±æ€§ç”¨äºè¡¨ç¤ºå½“å‰çš„èŠ‚ç‚¹æ˜¯ï¼š<code>RMODE(è¯») or WMODE(å†™)</code>ã€‚</li>
</ol>
</blockquote>
<p><img src="https://image.leejay.top/image/20200707/oyfmhKphdfR2.png?imageslim" alt=""></p>
<h3 id="writelock">writeLock</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">long</span> <span style="color:#a6e22e">writeLock</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">long</span> s<span style="color:#f92672">,</span> next<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">((((</span>s <span style="color:#f92672">=</span> state<span style="color:#f92672">)</span> <span style="color:#f92672">&amp;</span> ABITS<span style="color:#f92672">)</span> <span style="color:#f92672">==</span> 0L <span style="color:#f92672">&amp;&amp;</span>
             U<span style="color:#f92672">.</span><span style="color:#a6e22e">compareAndSwapLong</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> STATE<span style="color:#f92672">,</span> s<span style="color:#f92672">,</span> next <span style="color:#f92672">=</span> s <span style="color:#f92672">+</span> WBIT<span style="color:#f92672">))</span> <span style="color:#f92672">?</span>
            next <span style="color:#f92672">:</span> acquireWrite<span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> 0L<span style="color:#f92672">));</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<p>æˆ‘ä»¬å°†returnæ‹†åˆ†æˆä¸‰ä¸ªéƒ¨åˆ†æ¥çœ‹ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#960050;background-color:#1e0010">â‘ </span> <span style="color:#f92672">((</span>s <span style="color:#f92672">=</span> state<span style="color:#f92672">)</span> <span style="color:#f92672">&amp;</span> ABITS<span style="color:#f92672">)</span> <span style="color:#f92672">==</span> 0L
<span style="color:#960050;background-color:#1e0010">â‘¡</span> U<span style="color:#f92672">.</span><span style="color:#a6e22e">compareAndSwapLong</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> STATE<span style="color:#f92672">,</span> s<span style="color:#f92672">,</span> next <span style="color:#f92672">=</span> s <span style="color:#f92672">+</span> WBIT<span style="color:#f92672">)</span>
<span style="color:#960050;background-color:#1e0010">â‘¢</span> <span style="color:#f92672">?</span> next <span style="color:#f92672">:</span> acquireWrite<span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> 0L<span style="color:#f92672">)</span>
</code></pre></div><ol>
<li>â‘  ä¸ â‘¡ åŒæ—¶æˆç«‹æ—¶ï¼Œè¿”å›<code>next</code>ã€‚è‹¥æœ‰ä¸€ä¸ªä¸æˆç«‹ï¼Œè¿”å›<code>acquireWrite(false, 0L)</code>ã€‚</li>
<li>é»˜è®¤æƒ…å†µä¸‹<code>stateç¬¬9ä½æ˜¯1ï¼Œå…¶ä½™ä½éƒ½æ˜¯0</code>ï¼Œè€Œ``ABITä½8ä½éƒ½æ˜¯1(final)<code>ã€‚æ‰€ä»¥è¿›è¡Œ</code>&amp;<code>è¿ç®—ï¼Œå¯ä»¥æ¨å¯¼å‡º</code>åªè¦&amp;è¿ç®—çš„ç»“æœä¸ä¸º0ï¼Œè¯´æ˜æ­¤æ—¶æœ‰å†™é”æˆ–è€…è¯»é”ã€‚<code>è‹¥ç»“æœä¸ä¸º0ï¼Œæ‰§è¡Œ</code>acquireWrite`ã€‚</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">  1 0000 0000
<span style="color:#f92672">&amp;</span> 0 1111 1111
<span style="color:#960050;background-color:#1e0010">â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”</span>  <span style="color:#f92672">==</span> 0 æˆç«‹<span style="color:#960050;background-color:#1e0010">ï¼Œ</span>stateçš„ä½8ä½ä¸­æœ‰ä¸€ä½ä¸ä¸º0<span style="color:#960050;background-color:#1e0010">ï¼Œ</span>é‚£ä¹ˆè¿™ä¸ªå…¬å¼çš„ç»“æœè‚¯å®šä¸ä¸º0
  0 0000 0000     
</code></pre></div><ol start="3">
<li>å‡è®¾stateæ˜¯åˆå§‹çŠ¶æ€ï¼Œ<code>((s = state) &amp; ABITS) == 0L</code>æˆç«‹ï¼Œé‚£ä¹ˆæ‰§è¡ŒCASæ–¹æ³•ï¼Œå°è¯•å°†<code>state</code>çš„å€¼ç”±<code>åˆå§‹çŠ¶æ€sæ”¹ä¸ºs + WBIT(1000 0000)</code>ï¼Œå³<code>1 1000 0000</code>ï¼Œè¡¨æ˜è·å–å†™é”æˆåŠŸã€‚é‚£ä¹ˆè¿”å›<code>next</code>ä½œä¸ºç‰ˆæœ¬å·ã€‚</li>
<li>è‹¥CASä¿®æ”¹å¤±è´¥ï¼Œé‚£ä¹ˆè¯´æ˜æœ‰å¦å¤–ä¸€ä¸ªçº¿ç¨‹è·å–äº†å†™é”ï¼Œé‚£ä¹ˆæ‰§è¡Œ<code>acquireWrite</code>æ–¹æ³•ã€‚</li>
</ol>
</blockquote>
<h4 id="acquirewrite">acquireWrite</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// è·å–CPUæ ¸å¿ƒæ•°
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> NCPU <span style="color:#f92672">=</span> Runtime<span style="color:#f92672">.</span><span style="color:#a6e22e">getRuntime</span><span style="color:#f92672">().</span><span style="color:#a6e22e">availableProcessors</span><span style="color:#f92672">();</span>
<span style="color:#75715e">// åŠ å…¥é˜Ÿåˆ—å‰çš„æœ€å¤§è‡ªæ—‹æ¬¡æ•° 64æ¬¡
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> SPINS <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>NCPU <span style="color:#f92672">&gt;</span> 1<span style="color:#f92672">)</span> <span style="color:#f92672">?</span> 1 <span style="color:#f92672">&lt;&lt;</span> 6 <span style="color:#f92672">:</span> 0<span style="color:#f92672">;</span>
<span style="color:#75715e">// å‰é©±èŠ‚ç‚¹æ˜¯headæ—¶çš„è‡ªæ—‹æ¬¡æ•°ï¼Œå¤§äºåŠ å…¥é˜Ÿåˆ—çš„è‡ªæ—‹ï¼Œè¯´æ˜è¦åˆ°æˆ‘è·å–é”äº†ï¼Œæ¿€åŠ¨çš„è‡ªæ—‹æ¬¡æ•°ä¹Ÿå¤šäº†
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> HEAD_SPINS <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>NCPU <span style="color:#f92672">&gt;</span> 1<span style="color:#f92672">)</span> <span style="color:#f92672">?</span> 1 <span style="color:#f92672">&lt;&lt;</span> 10 <span style="color:#f92672">:</span> 0<span style="color:#f92672">;</span>
<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">long</span> <span style="color:#a6e22e">acquireWrite</span><span style="color:#f92672">(</span><span style="color:#66d9ef">boolean</span> interruptible<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> deadline<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// å®šä¹‰æ­¤æ¬¡çº¿ç¨‹çš„wnodeèŠ‚ç‚¹å’Œå‰é©±èŠ‚ç‚¹p
</span><span style="color:#75715e"></span>    WNode node <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> p<span style="color:#f92672">;</span>
    <span style="color:#75715e">// ç¬¬ä¸€æ¬¡è‡ªæ—‹ï¼Œspins = -1ï¼Œé€šè¿‡è‡ªæ—‹åŠ å…¥é˜Ÿåˆ—å°¾éƒ¨
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> spins <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>1<span style="color:#f92672">;;)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">long</span> m<span style="color:#f92672">,</span> s<span style="color:#f92672">,</span> ns<span style="color:#f92672">;</span>
        <span style="color:#75715e">// å¦‚æœ(s = state) &amp; ABITS) == 0Lè¯´æ˜æ°å·§å†™é”è¢«é‡Šæ”¾äº†ï¼Œé‚£ä¹ˆç›´æ¥å»CASè·å–é”
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>m <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>s <span style="color:#f92672">=</span> state<span style="color:#f92672">)</span> <span style="color:#f92672">&amp;</span> ABITS<span style="color:#f92672">)</span> <span style="color:#f92672">==</span> 0L<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// è‹¥è·å–æˆåŠŸç›´æ¥è¿”å›ns = æ–°çš„ç‰ˆæœ¬å·
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>U<span style="color:#f92672">.</span><span style="color:#a6e22e">compareAndSwapLong</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> STATE<span style="color:#f92672">,</span> s<span style="color:#f92672">,</span> ns <span style="color:#f92672">=</span> s <span style="color:#f92672">+</span> WBIT<span style="color:#f92672">))</span>
                <span style="color:#66d9ef">return</span> ns<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
        <span style="color:#75715e">// å¦‚æœè‡ªæ—‹æ¬¡æ•°å°äº0ï¼Œé‡æ–°è®¡ç®—è‡ªæ—‹æ¬¡æ•°
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>spins <span style="color:#f92672">&lt;</span> 0<span style="color:#f92672">)</span>
            <span style="color:#75715e">// 1. ä½•æ—¶m == WBITï¼Œåªæœ‰å†™é”æ²¡æœ‰è¯»é”çš„æ‰ä¼šæˆç«‹
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// 2. wtail = wheadçš„æƒ…å†µå’ŒAQSçš„ä¸€è‡´ï¼Œå°±æ˜¯
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// é˜Ÿåˆ—æœªåˆå§‹åŒ–ï¼ˆwtail = whead = nullï¼‰æˆ–
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// åªæœ‰ä¸€ä¸ªå“¨å…µèŠ‚ç‚¹è¿˜æ²¡æœ‰å…¶ä»–èŠ‚ç‚¹çš„æƒ…å†µ(wtail = whead = new WNode())
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// 1å’Œ2åŒæ—¶æˆç«‹è¯´æ˜é˜Ÿåˆ—æ²¡æœ‰ç­‰å¾…èŠ‚ç‚¹ï¼Œä¸”å†™é”ä¼šè¢«é‡Šæ”¾ï¼ˆæ—¶é—´ä¸ç¡®å®šï¼‰ï¼Œç»§ç»­è‡ªæ—‹
</span><span style="color:#75715e"></span>            spins <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>m <span style="color:#f92672">==</span> WBIT <span style="color:#f92672">&amp;&amp;</span> wtail <span style="color:#f92672">==</span> whead<span style="color:#f92672">)</span> <span style="color:#f92672">?</span> SPINS <span style="color:#f92672">:</span> 0<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>spins <span style="color:#f92672">&gt;</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// è·å–å½“å‰çº¿ç¨‹çš„éšæœºæ•°ï¼ˆåŸºäºThreadLocalRandomï¼‰&gt;= 0æ—¶è‡ªæ—‹æ¬¡æ•°å‡1
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>LockSupport<span style="color:#f92672">.</span><span style="color:#a6e22e">nextSecondarySeed</span><span style="color:#f92672">()</span> <span style="color:#f92672">&gt;=</span> 0<span style="color:#f92672">)</span>
                <span style="color:#f92672">--</span>spins<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
        <span style="color:#75715e">// å¦‚æœwtail = nullè¯´æ˜é˜Ÿåˆ—è¿˜æœªåˆå§‹åŒ–
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// æ— è®ºpæ˜¯å¦ä¸ºnullï¼Œå®ƒéƒ½ä»£è¡¨äº†é˜Ÿåˆ—çš„å°¾èŠ‚ç‚¹
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>p <span style="color:#f92672">=</span> wtail<span style="color:#f92672">)</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// åˆ›å»ºå†™æ¨¡å¼èŠ‚ç‚¹
</span><span style="color:#75715e"></span>            WNode hd <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> WNode<span style="color:#f92672">(</span>WMODE<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
            <span style="color:#75715e">// é€šè¿‡CASå°†hdè®¾ç½®ä¸ºå¤´èŠ‚ç‚¹
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>U<span style="color:#f92672">.</span><span style="color:#a6e22e">compareAndSwapObject</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> WHEAD<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> hd<span style="color:#f92672">))</span>
                <span style="color:#75715e">// è®¾ç½®æˆåŠŸå°†hdä¹Ÿè®¾ç½®ä¸ºwtailï¼ˆéåŸå­æ€§ï¼Œæ­¤æ—¶å¯èƒ½çº¿ç¨‹åˆ‡æ¢ï¼‰
</span><span style="color:#75715e"></span>                wtail <span style="color:#f92672">=</span> hd<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
        <span style="color:#75715e">// å¦‚æœå½“å‰çº¿ç¨‹çš„WNode = nullï¼Œé‚£ä¹ˆåˆ›å»ºå½“å‰çº¿ç¨‹çš„WNodeï¼Œæ­¤æ—¶ p = whead
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>node <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
            node <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> WNode<span style="color:#f92672">(</span>WMODE<span style="color:#f92672">,</span> p<span style="color:#f92672">);</span>
        <span style="color:#75715e">// å¦‚æœnodeå‰é©±ä¸æ˜¯pï¼Œé‚£ä¹ˆè®¾ç½®ä¸ºpï¼Œå› ä¸ºpä»£è¡¨äº†é˜Ÿåˆ—çš„tailèŠ‚ç‚¹
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// å› ä¸ºå­˜åœ¨å¦ä¸€ä¸ªçº¿ç¨‹æ¯”å½“å‰çº¿ç¨‹æ—©åŠ å…¥äº†é˜Ÿåˆ—
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>node<span style="color:#f92672">.</span><span style="color:#a6e22e">prev</span> <span style="color:#f92672">!=</span> p<span style="color:#f92672">)</span>
            node<span style="color:#f92672">.</span><span style="color:#a6e22e">prev</span> <span style="color:#f92672">=</span> p<span style="color:#f92672">;</span>
        <span style="color:#75715e">// é€šè¿‡CASä¿®æ”¹tailå°¾èŠ‚ç‚¹ï¼Œå’ŒAQSä¸€æ ·ï¼Œprevæ˜¯åŠ¡å¿…è¦ä¿è¯çš„
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>U<span style="color:#f92672">.</span><span style="color:#a6e22e">compareAndSwapObject</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> WTAIL<span style="color:#f92672">,</span> p<span style="color:#f92672">,</span> node<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// CASæˆåŠŸï¼Œè®¾ç½®nextæŒ‡é’ˆï¼ŒéåŸå­æ€§ï¼Œæ‰€ä»¥nextéå¯é ï¼Œæ­¤æ—¶çº¿ç¨‹åˆ‡æ¢ä¼šæœ‰å½±å“
</span><span style="color:#75715e"></span>            p<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span> <span style="color:#f92672">=</span> node<span style="color:#f92672">;</span>
            <span style="color:#75715e">// åªæœ‰æˆåŠŸå°†å½“å‰çº¿ç¨‹åŠ å…¥é˜Ÿåˆ—å°¾éƒ¨ï¼Œé‚£ä¹ˆæ‰ä¼šé€€å‡ºç¬¬ä¸€æ¬¡çš„è‡ªæ—‹
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>

    <span style="color:#75715e">// ç¬¬äºŒæ¬¡è‡ªæ—‹
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> spins <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>1<span style="color:#f92672">;;)</span> <span style="color:#f92672">{</span>
        WNode h<span style="color:#f92672">,</span> np<span style="color:#f92672">,</span> pp<span style="color:#f92672">;</span> <span style="color:#66d9ef">int</span> ps<span style="color:#f92672">;</span>
        <span style="color:#75715e">// pä»£è¡¨äº†å½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹ï¼Œä¹Ÿä»£è¡¨äº†æ­¤åˆ»çš„å°¾èŠ‚ç‚¹wtail
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// å¦‚æœp = headè¯´æ˜å½“å‰çº¿ç¨‹çš„å‰é©±ç»“ç‚¹æ˜¯headèŠ‚ç‚¹ï¼Œå¿«è¦åˆ°è‡ªå·±
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>h <span style="color:#f92672">=</span> whead<span style="color:#f92672">)</span> <span style="color:#f92672">==</span> p<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// å¦‚æœè‡ªæ—‹æ¬¡æ•°å°äº0èµ‹äºˆæ–°çš„è‡ªæ—‹æ¬¡æ•°
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>spins <span style="color:#f92672">&lt;</span> 0<span style="color:#f92672">)</span>
                spins <span style="color:#f92672">=</span> HEAD_SPINS<span style="color:#f92672">;</span>
            <span style="color:#75715e">// å¦‚æœè‡ªæ—‹æ¬¡æ•°å°äºæœ€å¤§è‡ªæ—‹æ¬¡æ•°é‚£ä¹ˆå°†å½“å‰è‡ªæ—‹æ¬¡æ•°ç¿»å€
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>spins <span style="color:#f92672">&lt;</span> MAX_HEAD_SPINS<span style="color:#f92672">)</span>
                spins <span style="color:#f92672">&lt;&lt;=</span> 1<span style="color:#f92672">;</span>
            <span style="color:#75715e">// ç¬¬ä¸‰ä¸ªè‡ªæ—‹ï¼Œè‡ªæ—‹ä¸­åˆå¥—äº†ä¸€ä¸ªè‡ªæ—‹
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> k <span style="color:#f92672">=</span> spins<span style="color:#f92672">;;)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">long</span> s<span style="color:#f92672">,</span> ns<span style="color:#f92672">;</span>
                <span style="color:#75715e">// å…ˆåˆ¤æ–­å†™é”æ˜¯å¦é‡Šæ”¾å¹¶CASä¿®æ”¹state
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(((</span>s <span style="color:#f92672">=</span> state<span style="color:#f92672">)</span> <span style="color:#f92672">&amp;</span> ABITS<span style="color:#f92672">)</span> <span style="color:#f92672">==</span> 0L<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>U<span style="color:#f92672">.</span><span style="color:#a6e22e">compareAndSwapLong</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> STATE<span style="color:#f92672">,</span> s<span style="color:#f92672">,</span>
                                             ns <span style="color:#f92672">=</span> s <span style="color:#f92672">+</span> WBIT<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                        <span style="color:#75715e">// è·å–æˆåŠŸï¼Œè®¾ç½®nodeä¸ºå¤´èŠ‚ç‚¹
</span><span style="color:#75715e"></span>                        whead <span style="color:#f92672">=</span> node<span style="color:#f92672">;</span>
                        <span style="color:#75715e">// æ¸…ç©ºprevæŒ‡é’ˆ
</span><span style="color:#75715e"></span>                        node<span style="color:#f92672">.</span><span style="color:#a6e22e">prev</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
                        <span style="color:#75715e">// è¿”å›state
</span><span style="color:#75715e"></span>                        <span style="color:#66d9ef">return</span> ns<span style="color:#f92672">;</span>
                    <span style="color:#f92672">}</span>
                <span style="color:#f92672">}</span>
                <span style="color:#75715e">// è¯´æ˜æ­¤æ—¶å†™é”è¿˜æ²¡é‡Šæ”¾æˆ–è€…CASå¤±è´¥ï¼ˆæ­¤æ—¶å…¶ä»–çº¿ç¨‹è·å–äº†é”ï¼‰
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// éšæœºå°†è‡ªæ—‹æ¬¡æ•°kå‡1ï¼Œç›´åˆ°k &lt;= 0æ—¶é€€å‡ºç¬¬ä¸‰æ¬¡è‡ªæ—‹
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// è¿™é‡Œçš„é€€å‡ºè¯´æ˜headè‡ªæ—‹æ¬¡æ•°å·²ç»ç”¨å®Œäº†
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>LockSupport<span style="color:#f92672">.</span><span style="color:#a6e22e">nextSecondarySeed</span><span style="color:#f92672">()</span> <span style="color:#f92672">&gt;=</span> 0 <span style="color:#f92672">&amp;&amp;</span>
                         <span style="color:#f92672">--</span>k <span style="color:#f92672">&lt;=</span> 0<span style="color:#f92672">)</span>
                    <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
        <span style="color:#75715e">// æ‰§è¡Œåˆ°æ­¤ï¼š
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// 1. å½“å‰çº¿ç¨‹çš„å‰é©±èŠ‚ç‚¹ä¸æ˜¯å¤´èŠ‚ç‚¹ï¼Œ
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// 2.ç¬¬ä¸‰æ¬¡è‡ªæ—‹è·å–å†™é”ä¸€ç›´æ²¡æˆåŠŸï¼ˆæœ‰ä¸ªçº¿ç¨‹æŒæœ‰çš„å†™é”æœªé‡Šæ”¾ï¼‰
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>h <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// ååŠ©å”¤é†’headå¤´èŠ‚ç‚¹ä¸‹é¢çš„cowaitä¸‹çš„è¯»èŠ‚ç‚¹
</span><span style="color:#75715e"></span>            WNode c<span style="color:#f92672">;</span> Thread w<span style="color:#f92672">;</span>
            <span style="color:#75715e">// å¾ªç¯æ‰§è¡Œï¼Œåªè¦èŠ‚ç‚¹çš„cowaitå±æ€§ä¸ä¸ºnull
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">while</span> <span style="color:#f92672">((</span>c <span style="color:#f92672">=</span> h<span style="color:#f92672">.</span><span style="color:#a6e22e">cowait</span><span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// åªæœ‰CASè®¾ç½®å½“å‰è¯»èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªè¯»èŠ‚ç‚¹æˆåŠŸæ‰èƒ½å”¤é†’å½“å‰è¯»èŠ‚ç‚¹çš„çº¿ç¨‹
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>U<span style="color:#f92672">.</span><span style="color:#a6e22e">compareAndSwapObject</span><span style="color:#f92672">(</span>h<span style="color:#f92672">,</span> WCOWAIT<span style="color:#f92672">,</span> c<span style="color:#f92672">,</span> c<span style="color:#f92672">.</span><span style="color:#a6e22e">cowait</span><span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span>
                    <span style="color:#f92672">(</span>w <span style="color:#f92672">=</span> c<span style="color:#f92672">.</span><span style="color:#a6e22e">thread</span><span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
                    <span style="color:#75715e">// å”¤é†’è¯»çº¿ç¨‹
</span><span style="color:#75715e"></span>                    U<span style="color:#f92672">.</span><span style="color:#a6e22e">unpark</span><span style="color:#f92672">(</span>w<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
        <span style="color:#75715e">// è‹¥whead = hï¼Œè¯´æ˜æ­¤é—´å¤´èŠ‚ç‚¹æ²¡æœ‰å‘ç”Ÿå˜åŒ–
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>whead <span style="color:#f92672">==</span> h<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// è‹¥å½“å‰çº¿ç¨‹çš„å‰é©±èŠ‚ç‚¹ä¸æ˜¯å°¾èŠ‚ç‚¹pï¼Œè¯´æ˜å°¾èŠ‚ç‚¹æ”¹å˜äº†
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>np <span style="color:#f92672">=</span> node<span style="color:#f92672">.</span><span style="color:#a6e22e">prev</span><span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> p<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// æ›´æ–°å°¾èŠ‚ç‚¹på¹¶è®¾ç½®å°¾èŠ‚ç‚¹pçš„nextæŒ‡é’ˆä¸ºå½“å‰çº¿ç¨‹çš„node
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>np <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
                    <span style="color:#f92672">(</span>p <span style="color:#f92672">=</span> np<span style="color:#f92672">).</span><span style="color:#a6e22e">next</span> <span style="color:#f92672">=</span> node<span style="color:#f92672">;</span>   <span style="color:#75715e">// stale
</span><span style="color:#75715e"></span>            <span style="color:#f92672">}</span>
            <span style="color:#75715e">// å¦‚æœpèŠ‚ç‚¹çš„çŠ¶æ€ä¸º0ï¼ŒCASä¿®æ”¹ä¸ºWAITING
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>ps <span style="color:#f92672">=</span> p<span style="color:#f92672">.</span><span style="color:#a6e22e">status</span><span style="color:#f92672">)</span> <span style="color:#f92672">==</span> 0<span style="color:#f92672">)</span>
                U<span style="color:#f92672">.</span><span style="color:#a6e22e">compareAndSwapInt</span><span style="color:#f92672">(</span>p<span style="color:#f92672">,</span> WSTATUS<span style="color:#f92672">,</span> 0<span style="color:#f92672">,</span> WAITING<span style="color:#f92672">);</span>
            <span style="color:#75715e">// å¦‚æœpèŠ‚ç‚¹æ˜¯CANCELLEDï¼Œå°†pçš„å‰é©±é¢å’Œnodeç›¸è¿
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ps <span style="color:#f92672">==</span> CANCELLED<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>pp <span style="color:#f92672">=</span> p<span style="color:#f92672">.</span><span style="color:#a6e22e">prev</span><span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    node<span style="color:#f92672">.</span><span style="color:#a6e22e">prev</span> <span style="color:#f92672">=</span> pp<span style="color:#f92672">;</span>
                    pp<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span> <span style="color:#f92672">=</span> node<span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// å¤„ç†è¶…æ—¶é—®é¢˜
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">long</span> time<span style="color:#f92672">;</span> 
                <span style="color:#75715e">// å¦‚æœdeadline = 0Lå°±è®¾ç½®time = 0L
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>deadline <span style="color:#f92672">==</span> 0L<span style="color:#f92672">)</span>
                    time <span style="color:#f92672">=</span> 0L<span style="color:#f92672">;</span>
                <span style="color:#75715e">// åˆ¤æ–­deadline -currenttime æ˜¯å¦å°äº 0ï¼Œå°äº0éœ€è¦å°†èŠ‚ç‚¹cancel
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>time <span style="color:#f92672">=</span> deadline <span style="color:#f92672">-</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">nanoTime</span><span style="color:#f92672">())</span> <span style="color:#f92672">&lt;=</span> 0L<span style="color:#f92672">)</span>
                    <span style="color:#66d9ef">return</span> cancelWaiter<span style="color:#f92672">(</span>node<span style="color:#f92672">,</span> node<span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
                <span style="color:#75715e">// è·å–å½“å‰çº¿ç¨‹
</span><span style="color:#75715e"></span>                Thread wt <span style="color:#f92672">=</span> Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">currentThread</span><span style="color:#f92672">();</span>
                <span style="color:#75715e">// æ·»åŠ å½“å‰çº¿ç¨‹åˆ°parkBlockerå±æ€§
</span><span style="color:#75715e"></span>                U<span style="color:#f92672">.</span><span style="color:#a6e22e">putObject</span><span style="color:#f92672">(</span>wt<span style="color:#f92672">,</span> PARKBLOCKER<span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
                <span style="color:#75715e">// ä¿®æ”¹nodeçš„threadå±æ€§
</span><span style="color:#75715e"></span>                node<span style="color:#f92672">.</span><span style="color:#a6e22e">thread</span> <span style="color:#f92672">=</span> wt<span style="color:#f92672">;</span>
                <span style="color:#75715e">// å¦‚æœå‰é©±èŠ‚ç‚¹çŠ¶æ€å°äº0 ä¸” é˜Ÿåˆ—å·²åˆå§‹åŒ– ä¸” æ— æ³•è·å–å†™é”
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// ä¸” å¤´èŠ‚ç‚¹æ²¡æœ‰å‘ç”Ÿå˜åŒ– ä¸” nodeçš„å‰é©±èŠ‚ç‚¹æ²¡æœ‰å˜åŒ–
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>p<span style="color:#f92672">.</span><span style="color:#a6e22e">status</span> <span style="color:#f92672">&lt;</span> 0 <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">(</span>p <span style="color:#f92672">!=</span> h <span style="color:#f92672">||</span> <span style="color:#f92672">(</span>state <span style="color:#f92672">&amp;</span> ABITS<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> 0L<span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span>
                    whead <span style="color:#f92672">==</span> h <span style="color:#f92672">&amp;&amp;</span> node<span style="color:#f92672">.</span><span style="color:#a6e22e">prev</span> <span style="color:#f92672">==</span> p<span style="color:#f92672">)</span>
                    <span style="color:#75715e">// å°±å»é˜»å¡å½“å‰çº¿ç¨‹
</span><span style="color:#75715e"></span>                    U<span style="color:#f92672">.</span><span style="color:#a6e22e">park</span><span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> time<span style="color:#f92672">);</span>
                node<span style="color:#f92672">.</span><span style="color:#a6e22e">thread</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
                U<span style="color:#f92672">.</span><span style="color:#a6e22e">putObject</span><span style="color:#f92672">(</span>wt<span style="color:#f92672">,</span> PARKBLOCKER<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
                <span style="color:#75715e">// å¦‚æœè¢«ä¸­æ–­äº†é‚£ä¹ˆå°±å–æ¶ˆå½“å‰èŠ‚ç‚¹
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>interruptible <span style="color:#f92672">&amp;&amp;</span> Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">interrupted</span><span style="color:#f92672">())</span>
                    <span style="color:#66d9ef">return</span> cancelWaiter<span style="color:#f92672">(</span>node<span style="color:#f92672">,</span> node<span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<p>ä¸AQSçš„å†™é”è·å–åŒºåˆ«ï¼š<code>StampedLockçš„é”è·å–çš„è‡ªæ—‹æ˜¯æœ‰æ¬¡æ•°é™åˆ¶çš„ï¼Œå¹¶ä¸”ä¸åŒæƒ…å†µè‡ªæ—‹æ¬¡æ•°ä¸åŒ</code>ã€‚</p>
<p>å†™é”çš„è·å–æ€»ä½“åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼Œåˆ†åˆ«å¯¹åº”ç€<code>ä¸‰æ¬¡è‡ªæ—‹</code>ï¼š</p>
<ol>
<li>ç¬¬ä¸€æ¬¡è‡ªæ—‹ï¼šå°è¯•è·å–å†™é”ï¼Œè‹¥æˆåŠŸåˆ™è¿”å›stateï¼Œå¤±è´¥å°±ç»§ç»­åˆ¤æ–­<code>spinsæ˜¯å¦éœ€è¦é‡æ–°èµ‹å€¼ï¼ˆè‹¥é˜Ÿåˆ—åˆšåˆå§‹åŒ–ä¸”å†™é”è¿˜æ²¡è¢«é‡Šæ”¾ï¼Œspins = 0ï¼‰</code>ï¼Œè‹¥<code>spins = 0</code>åˆ™å°†<code>å½“å‰çº¿ç¨‹æ„é€ æˆnodeæ·»åŠ åˆ°é˜Ÿå°¾ï¼ˆæ­¤è¿‡ç¨‹å¯èƒ½åŒ…æ‹¬é˜Ÿåˆ—åˆå§‹åŒ–ï¼‰</code>ï¼Œå¦åˆ™è‡ªæ—‹åŠ å…¥é˜Ÿå°¾ï¼Œæœ€ç»ˆåªæœ‰åŠ å…¥æˆåŠŸæ‰ä¼šè·³å‡ºè‡ªæ—‹ã€‚</li>
<li>ç¬¬äºŒæ¬¡è‡ªæ—‹ä¸Šï¼šå…ˆåˆ¤æ–­<code>å½“å‰çº¿ç¨‹å‰é©±èŠ‚ç‚¹æ˜¯å¦æ˜¯headèŠ‚ç‚¹</code>ï¼Œå¦‚æœæ˜¯é‚£ä¹ˆåŠ å¤§è‡ªæ—‹æ¬¡æ•°ï¼Œå¹¶å¼€å¯ç¬¬ä¸‰æ¬¡è‡ªæ—‹å»è·å–å†™é”ï¼Œè‹¥æˆåŠŸåˆ™è®¾ç½®nodeä¸ºæ–°headä¸”æ¸…ç©ºprevå±æ€§ã€‚</li>
<li>ç¬¬äºŒæ¬¡è‡ªæ—‹ä¸‹ï¼šè‹¥å½“å‰èŠ‚ç‚¹ä¸æ˜¯headçš„åç»§èŠ‚ç‚¹ï¼Œé‚£ä¹ˆ<code>å°è¯•å”¤é†’å¤´èŠ‚ç‚¹ä¸­cowaitè¿æ¥çš„è¯»çº¿ç¨‹</code>ã€‚æœ€åå¤„ç†èŠ‚ç‚¹çš„çŠ¶æ€å¹¶å¤„ç†è¶…æ—¶é—®é¢˜ï¼ˆåŒ…æ‹¬æ¸…ç†æ— æ•ˆèŠ‚ç‚¹ï¼‰ï¼Œè‹¥æœ€ç»ˆè¿˜æ˜¯æ— æ³•è·å–å†™é”ï¼Œé‚£ä¹ˆå°±ä¼šé˜»å¡å½“å‰çº¿ç¨‹ã€‚</li>
</ol>
<p>è·å–å†™é”çš„æ ‡å¿—ï¼šå°†å˜é‡<code>state</code>çš„ç¬¬8ä½è®¾ä¸º1ã€‚åä¹‹ä¸º0è¡¨ç¤ºæ²¡æœ‰è·å–å†™é”ã€‚</p>
</blockquote>
<h4 id="unlockwrite">unlockWrite</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">unlockWrite</span><span style="color:#f92672">(</span><span style="color:#66d9ef">long</span> stamp<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    WNode h<span style="color:#f92672">;</span>
    <span style="color:#75715e">// è‹¥state != stamp è¯´æ˜å½“å‰ä¼ å…¥çš„ç‰ˆæœ¬å·ä¸å¯¹
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// è‹¥stamp &amp; WBIT = 0Lè¯´æ˜å†™é”æ²¡è¢«è·å–ï¼Œé‚£å°±æ— éœ€é‡Šæ”¾
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// ä¸Šè¿°æ¡ä»¶æˆç«‹ä¸€ä¸ªæŠ›å‡ºå¼‚å¸¸
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>state <span style="color:#f92672">!=</span> stamp <span style="color:#f92672">||</span> <span style="color:#f92672">(</span>stamp <span style="color:#f92672">&amp;</span> WBIT<span style="color:#f92672">)</span> <span style="color:#f92672">==</span> 0L<span style="color:#f92672">)</span>
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> IllegalMonitorStateException<span style="color:#f92672">();</span>
    <span style="color:#75715e">// å°†stampåŠ 1åŒæ—¶åˆ¤æ–­ç‰ˆæœ¬å·æ˜¯å¦ä¸º0ï¼Œä¸º0å°±è®¾ä¸ºåˆå§‹å€¼å¦åˆ™è®¾ä¸ºå½“å‰å€¼
</span><span style="color:#75715e"></span>    state <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>stamp <span style="color:#f92672">+=</span> WBIT<span style="color:#f92672">)</span> <span style="color:#f92672">==</span> 0L <span style="color:#f92672">?</span> ORIGIN <span style="color:#f92672">:</span> stamp<span style="color:#f92672">;</span>
    <span style="color:#75715e">// å¦‚æœå¤´èŠ‚ç‚¹ä¸ä¸ºnullï¼Œä¸”å¤´èŠ‚ç‚¹ä¸ä¸º0
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>h <span style="color:#f92672">=</span> whead<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> h<span style="color:#f92672">.</span><span style="color:#a6e22e">status</span> <span style="color:#f92672">!=</span> 0<span style="color:#f92672">)</span>
        release<span style="color:#f92672">(</span>h<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
<span style="color:#75715e">// é‡Šæ”¾å¤´èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">release</span><span style="color:#f92672">(</span>WNode h<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>h <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        WNode q<span style="color:#f92672">;</span> Thread w<span style="color:#f92672">;</span>
        <span style="color:#75715e">// å°†å¤´èŠ‚ç‚¹statusæ”¹ä¸ºWAITING
</span><span style="color:#75715e"></span>        U<span style="color:#f92672">.</span><span style="color:#a6e22e">compareAndSwapInt</span><span style="color:#f92672">(</span>h<span style="color:#f92672">,</span> WSTATUS<span style="color:#f92672">,</span> WAITING<span style="color:#f92672">,</span> 0<span style="color:#f92672">);</span>
        <span style="color:#75715e">// å¦‚æœheadçš„åç»§æ— æ•ˆï¼Œé‚£ä¹ˆä»åå¾€å‰æŸ¥æ‰¾ï¼ˆå’ŒAQSä¸€è‡´ï¼‰ï¼Œç›´åˆ°æ‰¾åˆ°
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>q <span style="color:#f92672">=</span> h<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">)</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> q<span style="color:#f92672">.</span><span style="color:#a6e22e">status</span> <span style="color:#f92672">==</span> CANCELLED<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>WNode t <span style="color:#f92672">=</span> wtail<span style="color:#f92672">;</span> t <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> t <span style="color:#f92672">!=</span> h<span style="color:#f92672">;</span> t <span style="color:#f92672">=</span> t<span style="color:#f92672">.</span><span style="color:#a6e22e">prev</span><span style="color:#f92672">)</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>t<span style="color:#f92672">.</span><span style="color:#a6e22e">status</span> <span style="color:#f92672">&lt;=</span> 0<span style="color:#f92672">)</span>
                    q <span style="color:#f92672">=</span> t<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
        <span style="color:#75715e">// å”¤é†’ç¬¦åˆæ¡ä»¶çš„åç»§èŠ‚ç‚¹
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>q <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">(</span>w <span style="color:#f92672">=</span> q<span style="color:#f92672">.</span><span style="color:#a6e22e">thread</span><span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
            U<span style="color:#f92672">.</span><span style="color:#a6e22e">unpark</span><span style="color:#f92672">(</span>w<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<ol>
<li>
<p><code>state = (stamp += WBIT) == 0L ? ORIGIN : stamp</code>ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">å·²çŸ¥ä»£ç æ‰§è¡Œåˆ°æ­¤<span style="color:#960050;background-color:#1e0010">ï¼Œ</span>å½“å‰çº¿ç¨‹å¿…æœ‰å†™é”<span style="color:#960050;background-color:#1e0010">ï¼Œ</span>é‚£ä¹ˆå½“å‰stampå¿…ç¬¦åˆå¦‚ä¸‹ä¸ªè§„åˆ™<span style="color:#960050;background-color:#1e0010">ï¼š</span>
xxxx <span style="color:#f92672">...</span> xxxx 1xxx xxxx ç¬¬8ä½æ˜¯1
é‚£ä¹ˆåŠ ä¸ŠWBIT<span style="color:#960050;background-color:#1e0010">ï¼š</span> 1000 0000 å˜ä¸º
xxxx <span style="color:#f92672">...</span> xxx1 0000 0000<span style="color:#960050;background-color:#1e0010">ï¼Œ</span>å³ä¼šå‘é«˜ä½è¿›1<span style="color:#960050;background-color:#1e0010">ï¼Œ</span>ä¹Ÿå°±æ˜¯å°†ç‰ˆæœ¬å· <span style="color:#f92672">+</span> 1
</code></pre></div><blockquote>
<p>ä½•æ—¶<code>stamp += WBIT = 0L</code>å‘¢ï¼Ÿ</p>
<p>å½“<code>stamp = 0b1111...1000 0000ï¼ˆ64bitï¼‰</code>å³é™¤äº†ä½7ä½æ˜¯0ï¼Œå…¶ä»–ä½å…¨æ˜¯1ä½ï¼ŒåŠ ä¸Š<code>WBIT = 1000 0000</code>å°±ä¼šä¸º0ï¼Œè¯´æ˜æ­¤æ—¶stampç‰ˆæœ¬å·å·²å…¨éƒ¨ç”¨å®Œï¼Œéœ€è¦é‡ç½®ã€‚</p>
</blockquote>
</li>
<li>
<p>å†™é”çš„é‡Šæ”¾ä¸AQSçš„ç±»ä¼¼ï¼Œé™¤äº†<code>åˆ¤æ–­æ˜¯å¦å·²æœ‰å†™é”çš„</code>ä¸åŒï¼Œå‰©ä¸‹çš„æ¯”å¦‚<code>å”¤é†’å¤´èŠ‚ç‚¹çš„æœ‰æ•ˆåç»§èŠ‚ç‚¹ã€ä»é˜Ÿå°¾å¾€å‰æŸ¥æ‰¾</code>éƒ½æ˜¯ç›¸åŒçš„ã€‚</p>
</li>
</ol>
</blockquote>
<hr>
<h3 id="readlock">readLock</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">long</span> <span style="color:#a6e22e">readLock</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">long</span> s <span style="color:#f92672">=</span> state<span style="color:#f92672">,</span> next<span style="color:#f92672">;</span>  <span style="color:#75715e">// bypass acquireRead on common uncontended case
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">((</span>whead <span style="color:#f92672">==</span> wtail <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">(</span>s <span style="color:#f92672">&amp;</span> ABITS<span style="color:#f92672">)</span> <span style="color:#f92672">&lt;</span> RFULL <span style="color:#f92672">&amp;&amp;</span>
        U<span style="color:#f92672">.</span><span style="color:#a6e22e">compareAndSwapLong</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> STATE<span style="color:#f92672">,</span> s<span style="color:#f92672">,</span> next <span style="color:#f92672">=</span> s <span style="color:#f92672">+</span> RUNIT<span style="color:#f92672">))</span> <span style="color:#f92672">?</span>
            next <span style="color:#f92672">:</span> acquireRead<span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> 0L<span style="color:#f92672">));</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<p>åˆç§°ä¸º<code>æ‚²è§‚è¯»</code>ï¼Œå’Œå†™é”äº’æ–¥ï¼Œæµç¨‹åˆ†æˆä¸‰ä¸ªéƒ¨åˆ†ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#960050;background-color:#1e0010">â‘ </span> whead <span style="color:#f92672">==</span> wtail
<span style="color:#960050;background-color:#1e0010">â‘¡</span> <span style="color:#f92672">(</span>s <span style="color:#f92672">&amp;</span> ABITS<span style="color:#f92672">)</span> <span style="color:#f92672">&lt;</span> RFULL 
<span style="color:#960050;background-color:#1e0010">â‘¢</span> U<span style="color:#f92672">.</span><span style="color:#a6e22e">compareAndSwapLong</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> STATE<span style="color:#f92672">,</span> s<span style="color:#f92672">,</span> next <span style="color:#f92672">=</span> s <span style="color:#f92672">+</span> RUNIT<span style="color:#f92672">)</span>
</code></pre></div><ol>
<li><code>whead = wtail </code>è¯´æ˜é˜Ÿåˆ—ä¸­è¿˜æ²¡æœ‰è¿‡èŠ‚ç‚¹ï¼ˆéå“¨å…µèŠ‚ç‚¹ï¼‰ã€‚</li>
<li><code>(s &amp; ABITS) &lt; RFULL </code>åˆ¤æ–­å½“å‰è¯»é”æ•°é‡æ˜¯å¦è¶…è¿‡æœ€å¤§æ•°é‡ã€‚</li>
<li>è‹¥â‘ ã€â‘¡æˆç«‹åˆ™å°è¯•CASä¿®æ”¹<code>STATE</code>çŠ¶æ€ï¼Œå°†è¯»çº¿ç¨‹æ•°é‡ + 1ã€‚</li>
<li>è‹¥â‘ ã€â‘¡ã€â‘¢å…¨æˆç«‹è¿”å›æ–°çš„stateï¼Œå¦åˆ™è¿”å›<code>acquireRead</code>çš„è¿”å›å€¼</li>
</ol>
</blockquote>
<h4 id="acquireread">acquireRead</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">long</span> <span style="color:#a6e22e">acquireRead</span><span style="color:#f92672">(</span><span style="color:#66d9ef">boolean</span> interruptible<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> deadline<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    WNode node <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> p<span style="color:#f92672">;</span>
    <span style="color:#75715e">// ç¬¬ä¸€ä¸ªè‡ªæ—‹
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> spins <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>1<span style="color:#f92672">;;)</span> <span style="color:#f92672">{</span>
        WNode h<span style="color:#f92672">;</span>
        <span style="color:#75715e">// åˆ¤æ–­é˜Ÿåˆ—æ˜¯å¦åˆå§‹åŒ–ä¸”æœ‰æ— é™¤å½“å‰çº¿ç¨‹å¤–çš„å…¶ä»–èŠ‚ç‚¹
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>h <span style="color:#f92672">=</span> whead<span style="color:#f92672">)</span> <span style="color:#f92672">==</span> <span style="color:#f92672">(</span>p <span style="color:#f92672">=</span> wtail<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// ç¬¬äºŒä¸ªè‡ªæ—‹ å°è¯•è·å–è¯»é”
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">long</span> m<span style="color:#f92672">,</span> s<span style="color:#f92672">,</span> ns<span style="color:#f92672">;;)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// è‹¥ç›¸åŒåˆ™ç»§ç»­åˆ¤æ–­è¯»çº¿ç¨‹æ˜¯å¦è¶…è¿‡æœ€å¤§æ•°é‡
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>m <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>s <span style="color:#f92672">=</span> state<span style="color:#f92672">)</span> <span style="color:#f92672">&amp;</span> ABITS<span style="color:#f92672">)</span> <span style="color:#f92672">&lt;</span> RFULL <span style="color:#f92672">?</span>
                    <span style="color:#75715e">// trueæ‰§è¡ŒCASä¿®æ”¹å¹¶è¿”å›state
</span><span style="color:#75715e"></span>                    U<span style="color:#f92672">.</span><span style="color:#a6e22e">compareAndSwapLong</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> STATE<span style="color:#f92672">,</span> s<span style="color:#f92672">,</span> ns <span style="color:#f92672">=</span> s <span style="color:#f92672">+</span> RUNIT<span style="color:#f92672">)</span> <span style="color:#f92672">:</span>			  				<span style="color:#75715e">// false æ­¤æ—¶è¯»çº¿ç¨‹æº¢å‡ºï¼Œé‡ç½®RBITSå¹¶è¿”å›0L
</span><span style="color:#75715e"></span>                    <span style="color:#f92672">(</span>m <span style="color:#f92672">&lt;</span> WBIT <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">(</span>ns <span style="color:#f92672">=</span> tryIncReaderOverflow<span style="color:#f92672">(</span>s<span style="color:#f92672">))</span> <span style="color:#f92672">!=</span> 0L<span style="color:#f92672">))</span>
                    <span style="color:#66d9ef">return</span> ns<span style="color:#f92672">;</span>
                
                <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>m <span style="color:#f92672">&gt;=</span> WBIT<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>spins <span style="color:#f92672">&gt;</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        <span style="color:#75715e">// å’Œå†™é”ç±»ä¼¼ï¼Œæœ‰æ¦‚ç‡å°†spins-1
</span><span style="color:#75715e"></span>                        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>LockSupport<span style="color:#f92672">.</span><span style="color:#a6e22e">nextSecondarySeed</span><span style="color:#f92672">()</span> <span style="color:#f92672">&gt;=</span> 0<span style="color:#f92672">)</span>
                            <span style="color:#f92672">--</span>spins<span style="color:#f92672">;</span>
                    <span style="color:#f92672">}</span>
                    <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                        <span style="color:#75715e">// è‡ªæ—‹ä¸º0éœ€è¦åˆ¤æ–­æ˜¯å¦è·³å‡ºå¾ªç¯
</span><span style="color:#75715e"></span>                        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>spins <span style="color:#f92672">==</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                            WNode nh <span style="color:#f92672">=</span> whead<span style="color:#f92672">,</span> np <span style="color:#f92672">=</span> wtail<span style="color:#f92672">;</span>
                            <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>nh <span style="color:#f92672">==</span> h <span style="color:#f92672">&amp;&amp;</span> np <span style="color:#f92672">==</span> p<span style="color:#f92672">)</span> <span style="color:#f92672">||</span> <span style="color:#f92672">(</span>h <span style="color:#f92672">=</span> nh<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> <span style="color:#f92672">(</span>p <span style="color:#f92672">=</span> np<span style="color:#f92672">))</span>
                                <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
                        <span style="color:#f92672">}</span>
                        <span style="color:#75715e">// é‡ç½®spins
</span><span style="color:#75715e"></span>                        spins <span style="color:#f92672">=</span> SPINS<span style="color:#f92672">;</span>
                    <span style="color:#f92672">}</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
        
       <span style="color:#75715e">// æ— å°¾èŠ‚ç‚¹é‚£ä¹ˆåˆå§‹åŒ–é˜Ÿåˆ—
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>p <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span> 
            WNode hd <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> WNode<span style="color:#f92672">(</span>WMODE<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
            <span style="color:#75715e">// å’Œå†™é”ç›¸åŒè®¾ç½®headèŠ‚ç‚¹
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>U<span style="color:#f92672">.</span><span style="color:#a6e22e">compareAndSwapObject</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> WHEAD<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> hd<span style="color:#f92672">))</span>
                wtail <span style="color:#f92672">=</span> hd<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
        <span style="color:#75715e">// å’Œå†™é”ç±»ä¼¼ï¼Œåªæ˜¯modeå˜ä¸ºRMODE
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>node <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
            node <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> WNode<span style="color:#f92672">(</span>RMODE<span style="color:#f92672">,</span> p<span style="color:#f92672">);</span>
        <span style="color:#75715e">// å¦‚æœå¤´å°¾ç›¸åŒæˆ–å°¾èŠ‚ç‚¹ä¸æ˜¯è¯»æ¨¡å¼èŠ‚ç‚¹
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>h <span style="color:#f92672">==</span> p <span style="color:#f92672">||</span> p<span style="color:#f92672">.</span><span style="color:#a6e22e">mode</span> <span style="color:#f92672">!=</span> RMODE<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// å°†å½“å‰èŠ‚ç‚¹å…¥é˜Ÿå°¾
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>node<span style="color:#f92672">.</span><span style="color:#a6e22e">prev</span> <span style="color:#f92672">!=</span> p<span style="color:#f92672">)</span>
                node<span style="color:#f92672">.</span><span style="color:#a6e22e">prev</span> <span style="color:#f92672">=</span> p<span style="color:#f92672">;</span>
            <span style="color:#75715e">// ç›´åˆ°æ·»åŠ æˆåŠŸé€€å‡ºè‡ªæ—‹
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>U<span style="color:#f92672">.</span><span style="color:#a6e22e">compareAndSwapObject</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> WTAIL<span style="color:#f92672">,</span> p<span style="color:#f92672">,</span> node<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                p<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span> <span style="color:#f92672">=</span> node<span style="color:#f92672">;</span>
                <span style="color:#75715e">// è¿™é‡Œçš„breakä¼šè·³åˆ°ç¬¬äº”ä¸ªè‡ªæ—‹å¤„
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
        <span style="color:#75715e">// è¿™é‡Œè¯´æ˜å°¾èŠ‚ç‚¹æ˜¯è¯»æ¨¡å¼èŠ‚ç‚¹ CAS å°†å½“å‰èŠ‚ç‚¹æŒ‚åˆ°cowaitå±æ€§ä¸‹
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>U<span style="color:#f92672">.</span><span style="color:#a6e22e">compareAndSwapObject</span><span style="color:#f92672">(</span>p<span style="color:#f92672">,</span> WCOWAIT<span style="color:#f92672">,</span>
                                         node<span style="color:#f92672">.</span><span style="color:#a6e22e">cowait</span> <span style="color:#f92672">=</span> p<span style="color:#f92672">.</span><span style="color:#a6e22e">cowait</span><span style="color:#f92672">,</span> node<span style="color:#f92672">))</span>
            <span style="color:#75715e">// CASå¤±è´¥å°±è®¾ä¸ºnull
</span><span style="color:#75715e"></span>            node<span style="color:#f92672">.</span><span style="color:#a6e22e">cowait</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// ç¬¬ä¸‰æ®µè‡ªæ—‹ ç”¨äºé˜»å¡å½“å‰çº¿ç¨‹
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">for</span> <span style="color:#f92672">(;;)</span> <span style="color:#f92672">{</span>
                WNode pp<span style="color:#f92672">,</span> c<span style="color:#f92672">;</span> Thread w<span style="color:#f92672">;</span>
                <span style="color:#75715e">// è‹¥å¤´èŠ‚ç‚¹ä¸ä¸ºç©ºä¸”cowaitä¸ä¸ºç©ºï¼Œé‚£ä¹ˆå”¤é†’å…¶ä¸­ç­‰å¾…çš„è¯»çº¿ç¨‹
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>h <span style="color:#f92672">=</span> whead<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">(</span>c <span style="color:#f92672">=</span> h<span style="color:#f92672">.</span><span style="color:#a6e22e">cowait</span><span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span>
                    U<span style="color:#f92672">.</span><span style="color:#a6e22e">compareAndSwapObject</span><span style="color:#f92672">(</span>h<span style="color:#f92672">,</span> WCOWAIT<span style="color:#f92672">,</span> c<span style="color:#f92672">,</span> c<span style="color:#f92672">.</span><span style="color:#a6e22e">cowait</span><span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span>
                    <span style="color:#f92672">(</span>w <span style="color:#f92672">=</span> c<span style="color:#f92672">.</span><span style="color:#a6e22e">thread</span><span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> 
                    U<span style="color:#f92672">.</span><span style="color:#a6e22e">unpark</span><span style="color:#f92672">(</span>w<span style="color:#f92672">);</span>
                <span style="color:#75715e">// è‹¥å¤´èŠ‚ç‚¹ç­‰äºtailçš„å‰é©±èŠ‚ç‚¹ï¼Œè¯´æ˜å¿«åˆ°è‡ªå·±è·å–é”äº†
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>h <span style="color:#f92672">==</span> <span style="color:#f92672">(</span>pp <span style="color:#f92672">=</span> p<span style="color:#f92672">.</span><span style="color:#a6e22e">prev</span><span style="color:#f92672">)</span> <span style="color:#f92672">||</span> h <span style="color:#f92672">==</span> p <span style="color:#f92672">||</span> pp <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">long</span> m<span style="color:#f92672">,</span> s<span style="color:#f92672">,</span> ns<span style="color:#f92672">;</span>
                    <span style="color:#75715e">// ç¬¬å››æ®µè‡ªæ—‹ å°è¯•è·å–é”
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">do</span> <span style="color:#f92672">{</span>
                        <span style="color:#75715e">// ä»£ç å’Œç¬¬ä¸€æ®µè‡ªæ—‹ä¸­çš„è·å–é”ç›¸åŒï¼Œåˆ¤æ–­è¯»é”æ•°é‡åŒæ—¶è·å–è¯»é”
</span><span style="color:#75715e"></span>                        <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>m <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>s <span style="color:#f92672">=</span> state<span style="color:#f92672">)</span> <span style="color:#f92672">&amp;</span> ABITS<span style="color:#f92672">)</span> <span style="color:#f92672">&lt;</span> RFULL <span style="color:#f92672">?</span>
                            U<span style="color:#f92672">.</span><span style="color:#a6e22e">compareAndSwapLong</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> STATE<span style="color:#f92672">,</span> s<span style="color:#f92672">,</span>
                                                 ns <span style="color:#f92672">=</span> s <span style="color:#f92672">+</span> RUNIT<span style="color:#f92672">)</span> <span style="color:#f92672">:</span>
                            <span style="color:#f92672">(</span>m <span style="color:#f92672">&lt;</span> WBIT <span style="color:#f92672">&amp;&amp;</span>
                             <span style="color:#f92672">(</span>ns <span style="color:#f92672">=</span> tryIncReaderOverflow<span style="color:#f92672">(</span>s<span style="color:#f92672">))</span> <span style="color:#f92672">!=</span> 0L<span style="color:#f92672">))</span>
                            <span style="color:#66d9ef">return</span> ns<span style="color:#f92672">;</span>
                    <span style="color:#f92672">}</span> <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>m <span style="color:#f92672">&lt;</span> WBIT<span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>
                <span style="color:#75715e">// å¦‚æœå¤´èŠ‚ç‚¹æ²¡æœ‰å˜è¿‡ä¸”å‰é©±èŠ‚ç‚¹æ²¡æœ‰æ”¹å˜ï¼Œé‚£ä¹ˆéœ€è¦é˜»å¡å½“å‰çº¿ç¨‹äº†
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>whead <span style="color:#f92672">==</span> h <span style="color:#f92672">&amp;&amp;</span> p<span style="color:#f92672">.</span><span style="color:#a6e22e">prev</span> <span style="color:#f92672">==</span> pp<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">long</span> time<span style="color:#f92672">;</span>
                    <span style="color:#75715e">// å¦‚æœå‰ç½®èŠ‚ç‚¹çš„å‰èŠ‚ç‚¹ä¸ºnullæˆ–å¤´èŠ‚ç‚¹ç­‰äºå‰ç»§èŠ‚ç‚¹æˆ–å‰ç½®èŠ‚ç‚¹çŠ¶æ€æ˜¯cancel
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>pp <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> h <span style="color:#f92672">==</span> p <span style="color:#f92672">||</span> p<span style="color:#f92672">.</span><span style="color:#a6e22e">status</span> <span style="color:#f92672">&gt;</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        <span style="color:#75715e">// ç½®ä¸ºnull
</span><span style="color:#75715e"></span>                        node <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
                        <span style="color:#75715e">// é€€å‡ºè‡ªæ—‹ä»ç¬¬ä¸€ä¸ªè‡ªæ—‹é‡è¯•
</span><span style="color:#75715e"></span>                        <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
                    <span style="color:#f92672">}</span>
                    <span style="color:#75715e">// ä»¥ä¸‹æ˜¯æ‰§è¡Œè¶…æ—¶æœºåˆ¶çš„ä»£ç ï¼Œå’Œå†™é”ç›¸åŒ
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>deadline <span style="color:#f92672">==</span> 0L<span style="color:#f92672">)</span>
                        time <span style="color:#f92672">=</span> 0L<span style="color:#f92672">;</span>
                    <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>time <span style="color:#f92672">=</span> deadline <span style="color:#f92672">-</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">nanoTime</span><span style="color:#f92672">())</span> <span style="color:#f92672">&lt;=</span> 0L<span style="color:#f92672">)</span>
                        <span style="color:#66d9ef">return</span> cancelWaiter<span style="color:#f92672">(</span>node<span style="color:#f92672">,</span> p<span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
                    Thread wt <span style="color:#f92672">=</span> Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">currentThread</span><span style="color:#f92672">();</span>
                    U<span style="color:#f92672">.</span><span style="color:#a6e22e">putObject</span><span style="color:#f92672">(</span>wt<span style="color:#f92672">,</span> PARKBLOCKER<span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
                    <span style="color:#75715e">// è®¾ç½®å½“å‰çº¿ç¨‹åˆ°èŠ‚ç‚¹ä¸­
</span><span style="color:#75715e"></span>                    node<span style="color:#f92672">.</span><span style="color:#a6e22e">thread</span> <span style="color:#f92672">=</span> wt<span style="color:#f92672">;</span>
                    <span style="color:#75715e">// è‹¥å‰é©±èŠ‚ç‚¹ä¸æ˜¯å¤´èŠ‚ç‚¹ ä¸” å¤´èŠ‚ç‚¹å’Œå‰é©±èŠ‚ç‚¹æ²¡å˜è¿‡
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>h <span style="color:#f92672">!=</span> pp <span style="color:#f92672">||</span> <span style="color:#f92672">(</span>state <span style="color:#f92672">&amp;</span> ABITS<span style="color:#f92672">)</span> <span style="color:#f92672">==</span> WBIT<span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span>
                        whead <span style="color:#f92672">==</span> h <span style="color:#f92672">&amp;&amp;</span> p<span style="color:#f92672">.</span><span style="color:#a6e22e">prev</span> <span style="color:#f92672">==</span> pp<span style="color:#f92672">)</span>
                        <span style="color:#75715e">// å½“æ¡ä»¶ç¬¦åˆçš„æ—¶å€™é˜»å¡å½“å‰çº¿ç¨‹
</span><span style="color:#75715e"></span>                        U<span style="color:#f92672">.</span><span style="color:#a6e22e">park</span><span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> time<span style="color:#f92672">);</span>
                    node<span style="color:#f92672">.</span><span style="color:#a6e22e">thread</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
                    U<span style="color:#f92672">.</span><span style="color:#a6e22e">putObject</span><span style="color:#f92672">(</span>wt<span style="color:#f92672">,</span> PARKBLOCKER<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>interruptible <span style="color:#f92672">&amp;&amp;</span> Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">interrupted</span><span style="color:#f92672">())</span>
                        <span style="color:#66d9ef">return</span> cancelWaiter<span style="color:#f92672">(</span>node<span style="color:#f92672">,</span> p<span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
	<span style="color:#75715e">//ç¬¬äº”æ®µè‡ªæ—‹ï¼Œå¤„ç†ç¬¬ä¸€ä¸ªåŠ å…¥é˜Ÿå°¾çš„è¯»çº¿ç¨‹
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> spins <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>1<span style="color:#f92672">;;)</span> <span style="color:#f92672">{</span>
        WNode h<span style="color:#f92672">,</span> np<span style="color:#f92672">,</span> pp<span style="color:#f92672">;</span> <span style="color:#66d9ef">int</span> ps<span style="color:#f92672">;</span>
        <span style="color:#75715e">// è¿™å…¶ä¸­çš„é€»è¾‘å’Œä¹‹å‰çš„ä»£ç ç±»ä¼¼ï¼Œéƒ½æ˜¯åˆ¤æ–­æ˜¯å¦å‰ç»§èŠ‚ç‚¹æ˜¯å¤´èŠ‚ç‚¹ï¼Œç„¶åå°è¯•è·å–è¯»é”
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>h <span style="color:#f92672">=</span> whead<span style="color:#f92672">)</span> <span style="color:#f92672">==</span> p<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>spins <span style="color:#f92672">&lt;</span> 0<span style="color:#f92672">)</span>
                spins <span style="color:#f92672">=</span> HEAD_SPINS<span style="color:#f92672">;</span>
            <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>spins <span style="color:#f92672">&lt;</span> MAX_HEAD_SPINS<span style="color:#f92672">)</span>
                spins <span style="color:#f92672">&lt;&lt;=</span> 1<span style="color:#f92672">;</span>
            <span style="color:#75715e">// ç¬¬å…­æ®µè‡ªæ—‹
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> k <span style="color:#f92672">=</span> spins<span style="color:#f92672">;;)</span> <span style="color:#f92672">{</span> <span style="color:#75715e">// spin at head
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">long</span> m<span style="color:#f92672">,</span> s<span style="color:#f92672">,</span> ns<span style="color:#f92672">;</span>
                <span style="color:#75715e">// è·å–è¯»é”ä¸”åˆ¤æ–­æ˜¯å¦è¶…è¿‡æœ€å¤§è¯»é”é™åˆ¶
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>m <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>s <span style="color:#f92672">=</span> state<span style="color:#f92672">)</span> <span style="color:#f92672">&amp;</span> ABITS<span style="color:#f92672">)</span> <span style="color:#f92672">&lt;</span> RFULL <span style="color:#f92672">?</span>
                    U<span style="color:#f92672">.</span><span style="color:#a6e22e">compareAndSwapLong</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> STATE<span style="color:#f92672">,</span> s<span style="color:#f92672">,</span> ns <span style="color:#f92672">=</span> s <span style="color:#f92672">+</span> RUNIT<span style="color:#f92672">)</span> <span style="color:#f92672">:</span>
                    <span style="color:#f92672">(</span>m <span style="color:#f92672">&lt;</span> WBIT <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">(</span>ns <span style="color:#f92672">=</span> tryIncReaderOverflow<span style="color:#f92672">(</span>s<span style="color:#f92672">))</span> <span style="color:#f92672">!=</span> 0L<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                    WNode c<span style="color:#f92672">;</span> Thread w<span style="color:#f92672">;</span>
                    whead <span style="color:#f92672">=</span> node<span style="color:#f92672">;</span>
                    node<span style="color:#f92672">.</span><span style="color:#a6e22e">prev</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
                    <span style="color:#75715e">// ååŠ©å”¤é†’å½“å‰èŠ‚ç‚¹ä¸­çš„æŒ‚åœ¨cowaitå±æ€§ä¸Šçš„è¯»èŠ‚ç‚¹
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">while</span> <span style="color:#f92672">((</span>c <span style="color:#f92672">=</span> node<span style="color:#f92672">.</span><span style="color:#a6e22e">cowait</span><span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>U<span style="color:#f92672">.</span><span style="color:#a6e22e">compareAndSwapObject</span><span style="color:#f92672">(</span>node<span style="color:#f92672">,</span> WCOWAIT<span style="color:#f92672">,</span>
                                                   c<span style="color:#f92672">,</span> c<span style="color:#f92672">.</span><span style="color:#a6e22e">cowait</span><span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span>
                            <span style="color:#f92672">(</span>w <span style="color:#f92672">=</span> c<span style="color:#f92672">.</span><span style="color:#a6e22e">thread</span><span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
                            U<span style="color:#f92672">.</span><span style="color:#a6e22e">unpark</span><span style="color:#f92672">(</span>w<span style="color:#f92672">);</span>
                    <span style="color:#f92672">}</span>
                    <span style="color:#66d9ef">return</span> ns<span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
                <span style="color:#75715e">// è‹¥å…¶ä»–çº¿ç¨‹å æœ‰å†™é”ï¼Œéšæœºå°†spins-1ä¸”è‹¥æ²¡æœ‰è‡ªæ—‹æ¬¡æ•°å°±break
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>m <span style="color:#f92672">&gt;=</span> WBIT <span style="color:#f92672">&amp;&amp;</span>
                         LockSupport<span style="color:#f92672">.</span><span style="color:#a6e22e">nextSecondarySeed</span><span style="color:#f92672">()</span> <span style="color:#f92672">&gt;=</span> 0 <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">--</span>k <span style="color:#f92672">&lt;=</span> 0<span style="color:#f92672">)</span>
                    <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>h <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            WNode c<span style="color:#f92672">;</span> Thread w<span style="color:#f92672">;</span>
            <span style="color:#66d9ef">while</span> <span style="color:#f92672">((</span>c <span style="color:#f92672">=</span> h<span style="color:#f92672">.</span><span style="color:#a6e22e">cowait</span><span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>U<span style="color:#f92672">.</span><span style="color:#a6e22e">compareAndSwapObject</span><span style="color:#f92672">(</span>h<span style="color:#f92672">,</span> WCOWAIT<span style="color:#f92672">,</span> c<span style="color:#f92672">,</span> c<span style="color:#f92672">.</span><span style="color:#a6e22e">cowait</span><span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span>
                    <span style="color:#f92672">(</span>w <span style="color:#f92672">=</span> c<span style="color:#f92672">.</span><span style="color:#a6e22e">thread</span><span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
                    U<span style="color:#f92672">.</span><span style="color:#a6e22e">unpark</span><span style="color:#f92672">(</span>w<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
        <span style="color:#75715e">// å¦‚æœå¤´èŠ‚ç‚¹æ²¡å˜åŒ–
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>whead <span style="color:#f92672">==</span> h<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// æ›´æ–°å‰ç½®èŠ‚ç‚¹çŠ¶æ€
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>np <span style="color:#f92672">=</span> node<span style="color:#f92672">.</span><span style="color:#a6e22e">prev</span><span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> p<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>np <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
                    <span style="color:#f92672">(</span>p <span style="color:#f92672">=</span> np<span style="color:#f92672">).</span><span style="color:#a6e22e">next</span> <span style="color:#f92672">=</span> node<span style="color:#f92672">;</span>   <span style="color:#75715e">// stale
</span><span style="color:#75715e"></span>            <span style="color:#f92672">}</span>
            <span style="color:#75715e">// å°†ç­‰å¾…çš„èŠ‚ç‚¹çŠ¶æ€è®¾ä¸ºWAITING
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>ps <span style="color:#f92672">=</span> p<span style="color:#f92672">.</span><span style="color:#a6e22e">status</span><span style="color:#f92672">)</span> <span style="color:#f92672">==</span> 0<span style="color:#f92672">)</span>
                U<span style="color:#f92672">.</span><span style="color:#a6e22e">compareAndSwapInt</span><span style="color:#f92672">(</span>p<span style="color:#f92672">,</span> WSTATUS<span style="color:#f92672">,</span> 0<span style="color:#f92672">,</span> WAITING<span style="color:#f92672">);</span>
            <span style="color:#75715e">// å¦‚æœèŠ‚ç‚¹å·²å–æ¶ˆï¼Œé‚£ä¹ˆç§»é™¤é˜Ÿåˆ—
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ps <span style="color:#f92672">==</span> CANCELLED<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>pp <span style="color:#f92672">=</span> p<span style="color:#f92672">.</span><span style="color:#a6e22e">prev</span><span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    node<span style="color:#f92672">.</span><span style="color:#a6e22e">prev</span> <span style="color:#f92672">=</span> pp<span style="color:#f92672">;</span>
                    pp<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span> <span style="color:#f92672">=</span> node<span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// å’Œä¹‹å‰é€»è¾‘ç›¸åŒï¼Œå¤„ç†è¶…æ—¶é—®é¢˜
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">long</span> time<span style="color:#f92672">;</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>deadline <span style="color:#f92672">==</span> 0L<span style="color:#f92672">)</span>
                    time <span style="color:#f92672">=</span> 0L<span style="color:#f92672">;</span>
                <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>time <span style="color:#f92672">=</span> deadline <span style="color:#f92672">-</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">nanoTime</span><span style="color:#f92672">())</span> <span style="color:#f92672">&lt;=</span> 0L<span style="color:#f92672">)</span>
                    <span style="color:#66d9ef">return</span> cancelWaiter<span style="color:#f92672">(</span>node<span style="color:#f92672">,</span> node<span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
                Thread wt <span style="color:#f92672">=</span> Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">currentThread</span><span style="color:#f92672">();</span>
                U<span style="color:#f92672">.</span><span style="color:#a6e22e">putObject</span><span style="color:#f92672">(</span>wt<span style="color:#f92672">,</span> PARKBLOCKER<span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
                node<span style="color:#f92672">.</span><span style="color:#a6e22e">thread</span> <span style="color:#f92672">=</span> wt<span style="color:#f92672">;</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>p<span style="color:#f92672">.</span><span style="color:#a6e22e">status</span> <span style="color:#f92672">&lt;</span> 0 <span style="color:#f92672">&amp;&amp;</span>
                    <span style="color:#f92672">(</span>p <span style="color:#f92672">!=</span> h <span style="color:#f92672">||</span> <span style="color:#f92672">(</span>state <span style="color:#f92672">&amp;</span> ABITS<span style="color:#f92672">)</span> <span style="color:#f92672">==</span> WBIT<span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span>
                    whead <span style="color:#f92672">==</span> h <span style="color:#f92672">&amp;&amp;</span> node<span style="color:#f92672">.</span><span style="color:#a6e22e">prev</span> <span style="color:#f92672">==</span> p<span style="color:#f92672">)</span>
                    U<span style="color:#f92672">.</span><span style="color:#a6e22e">park</span><span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> time<span style="color:#f92672">);</span>
                node<span style="color:#f92672">.</span><span style="color:#a6e22e">thread</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
                U<span style="color:#f92672">.</span><span style="color:#a6e22e">putObject</span><span style="color:#f92672">(</span>wt<span style="color:#f92672">,</span> PARKBLOCKER<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>interruptible <span style="color:#f92672">&amp;&amp;</span> Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">interrupted</span><span style="color:#f92672">())</span>
                    <span style="color:#66d9ef">return</span> cancelWaiter<span style="color:#f92672">(</span>node<span style="color:#f92672">,</span> node<span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<ol>
<li>ä¸€è¿›æ¥å¦‚æœæ— å†™é”ã€å½“å‰é˜Ÿåˆ—æ²¡æœ‰å…¶ä»–èŠ‚ç‚¹æˆ–é˜Ÿåˆ—æœªåˆå§‹åŒ–ï¼Œé‚£ä¹ˆå°è¯•è·å–è¯»é”ï¼ŒæˆåŠŸå°±è¿”å›ã€‚</li>
<li>è‹¥æ— æ³•è·å–è¯»é”ï¼Œé‚£ä¹ˆå’Œå†™é”ä¸€æ ·ï¼Œä¼šå°è¯•æŠŠå½“å‰çº¿ç¨‹åŠ å…¥é˜Ÿåˆ—ï¼Œä½†è¿™é‡Œåˆ†ä¸ºä¸¤ç§ï¼š
<ol>
<li>å¦‚æœå½“å‰çº¿ç¨‹æ˜¯<code>è¿ç»­å‡ ä¸ªè¯»çº¿ç¨‹ä¸­ç¬¬ä¸€ä¸ªåŠ å…¥çš„è¯»çº¿ç¨‹</code>ï¼Œé‚£ä¹ˆç›´æ¥<code>åŠ å…¥é˜Ÿå°¾</code>ã€‚</li>
<li>è‹¥ä¸æ˜¯è¿ç»­å‡ ä¸ªè¯»çº¿ç¨‹ç¬¬ä¸€ä¸ªåŠ å…¥çš„è¯»çº¿ç¨‹ï¼Œä¼š<code>è¿›å…¥åˆ°é¦–ä¸ªè¯»èŠ‚ç‚¹çš„cowaitå±æ€§ä¸­ï¼Œå½¢æˆé“¾è¡¨ç»“æ„</code>ã€‚</li>
</ol>
</li>
<li>å’Œå†™é”ç›¸åŒï¼Œå¦‚æœé•¿æ—¶é—´æ— æ³•è·å–è¯»é”ï¼Œé‚£ä¹ˆä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œç›´åˆ°è¢«å”¤é†’ç»§ç»­è‡ªæ—‹è·å–é”ã€‚</li>
</ol>
</blockquote>
<h4 id="unlockread">unlockRead</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">unlockRead</span><span style="color:#f92672">(</span><span style="color:#66d9ef">long</span> stamp<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">long</span> s<span style="color:#f92672">,</span> m<span style="color:#f92672">;</span> WNode h<span style="color:#f92672">;</span>
    <span style="color:#75715e">// å¾ªç¯æ‰§è¡Œ
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(;;)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// è‹¥ç‰ˆæœ¬å·ä¸åŒ æˆ– ä¸å­˜åœ¨å†™é” æˆ– åªæœ‰å†™é”æ— è¯»é”
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// ä¸Šè¿°æ¡ä»¶ç¬¦åˆä¸€æ¡å°±æŠ›å¼‚å¸¸
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(((</span>s <span style="color:#f92672">=</span> state<span style="color:#f92672">)</span> <span style="color:#f92672">&amp;</span> SBITS<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> <span style="color:#f92672">(</span>stamp <span style="color:#f92672">&amp;</span> SBITS<span style="color:#f92672">)</span> <span style="color:#f92672">||</span>
            <span style="color:#f92672">(</span>stamp <span style="color:#f92672">&amp;</span> ABITS<span style="color:#f92672">)</span> <span style="color:#f92672">==</span> 0L <span style="color:#f92672">||</span> <span style="color:#f92672">(</span>m <span style="color:#f92672">=</span> s <span style="color:#f92672">&amp;</span> ABITS<span style="color:#f92672">)</span> <span style="color:#f92672">==</span> 0L <span style="color:#f92672">||</span> m <span style="color:#f92672">==</span> WBIT<span style="color:#f92672">)</span>
            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> IllegalMonitorStateException<span style="color:#f92672">();</span>
        <span style="color:#75715e">// åªæœ‰å½“å‰è¯»é”æ¬¡æ•°å°äºæœ€å¤§è¯»é”æ¬¡æ•°å°è¯•é‡Šæ”¾é”
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>m <span style="color:#f92672">&lt;</span> RFULL<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// CASä¿®æ”¹state
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>U<span style="color:#f92672">.</span><span style="color:#a6e22e">compareAndSwapLong</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> STATE<span style="color:#f92672">,</span> s<span style="color:#f92672">,</span> s <span style="color:#f92672">-</span> RUNIT<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// ç›´åˆ°è¯»é”å…¨éƒ¨é‡Šæ”¾ä¸”å¤´èŠ‚ç‚¹ä¸ä¸ºnullä¸”å¤´èŠ‚ç‚¹çŠ¶æ€ä¸ä¸º0
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>m <span style="color:#f92672">==</span> RUNIT <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">(</span>h <span style="color:#f92672">=</span> whead<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> h<span style="color:#f92672">.</span><span style="color:#a6e22e">status</span> <span style="color:#f92672">!=</span> 0<span style="color:#f92672">)</span>
                    <span style="color:#75715e">// å”¤é†’å¤´èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹å¹¶break
</span><span style="color:#75715e"></span>                    release<span style="color:#f92672">(</span>h<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
        <span style="color:#75715e">// è¯»çº¿ç¨‹æ•°é‡æº¢å‡ºå¦‚æœ
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>tryDecReaderOverflow<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> 0L<span style="color:#f92672">)</span>
            <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<p>å¾ªç¯é‡Šæ”¾è¯»é”èŠ‚ç‚¹ç›´åˆ°ä¸º0ï¼Œç„¶åå”¤é†’å¤´èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªæœ‰æ•ˆåç»§èŠ‚ç‚¹ã€‚</p>
</blockquote>
<hr>
<h3 id="tryoptimisticread">tryOptimisticRead</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// é”çš„ä¹è§‚è¯»
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">long</span> <span style="color:#a6e22e">tryOptimisticRead</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">long</span> s<span style="color:#f92672">;</span>
    <span style="color:#75715e">// åˆ¤æ–­æ˜¯å¦å­˜åœ¨å†™é”ï¼Œå­˜åœ¨å°±è¿”å›0Lï¼Œä¸å­˜åœ¨å°±è¿”å› stateçš„é«˜56ä½
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">(((</span>s <span style="color:#f92672">=</span> state<span style="color:#f92672">)</span> <span style="color:#f92672">&amp;</span> WBIT<span style="color:#f92672">)</span> <span style="color:#f92672">==</span> 0L<span style="color:#f92672">)</span> <span style="color:#f92672">?</span> <span style="color:#f92672">(</span>s <span style="color:#f92672">&amp;</span> SBITS<span style="color:#f92672">)</span> <span style="color:#f92672">:</span> 0L<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<p>åˆç§°ä¸º<code>ä¹è§‚è¯»</code>ï¼Œæ­¤å¤„çš„ä»£ç æ˜¯æ²¡æœ‰åŠ é”çš„ï¼Œæ‰€ä»¥éœ€è¦é…åˆ<code>validate</code>æ–¹æ³•ä½¿ç”¨ã€‚</p>
</blockquote>
<hr>
<h3 id="validate">validate</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// æ ¡éªŒç‰ˆæœ¬å·
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">validate</span><span style="color:#f92672">(</span><span style="color:#66d9ef">long</span> stamp<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// Unsafeçš„å†…å­˜å±éšœapi 
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// ä¸ºä»€ä¹ˆä½¿ç”¨å†…å­˜å±éšœï¼Œå› ä¸ºtampå˜é‡æ²¡æœ‰è¢«volatileä¿®é¥°
</span><span style="color:#75715e"></span>    U<span style="color:#f92672">.</span><span style="color:#a6e22e">loadFence</span><span style="color:#f92672">();</span>
    <span style="color:#75715e">// è¿”å›stateå’Œstampæ˜¯å¦ç›¸åŒ
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span>stamp <span style="color:#f92672">&amp;</span> SBITS<span style="color:#f92672">)</span> <span style="color:#f92672">==</span> <span style="color:#f92672">(</span>state <span style="color:#f92672">&amp;</span> SBITS<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">print</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
	<span style="color:#66d9ef">long</span> stamp <span style="color:#f92672">=</span> LOCK<span style="color:#f92672">.</span><span style="color:#a6e22e">tryOptimisticRead</span><span style="color:#f92672">();</span>
    <span style="color:#75715e">// å¦‚æœstampä¿®æ”¹äº†ï¼Œè¿™æ—¶å†åŠ æ‚²è§‚è¯»é”
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> currentX <span style="color:#f92672">=</span> x<span style="color:#f92672">,</span> currentY <span style="color:#f92672">=</span> y<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>LOCK<span style="color:#f92672">.</span><span style="color:#a6e22e">validate</span><span style="color:#f92672">(</span>stamp<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        <span style="color:#f92672">...</span>
    <span style="color:#f92672">}</span>   
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<p>æˆ‘ä»¬éœ€è¦ä¿éšœ<code>tryOptimisticRead</code>å’Œ<code>validate</code>è®¾è®¡çš„ä¸‰è¡Œä»£ç <code>ä¸èƒ½è¢«é‡æ’åº</code>ï¼Œå› ä¸ºstateå·²ç»è¢«volatileä¿®é¥°ï¼Œä½†stampä¸æ˜¯volatileï¼Œæ‰€ä»¥åœ¨validateä¸­åŠ å…¥<code>å†…å­˜å±éšœ</code>ã€‚</p>
</blockquote>
<hr>
<h3 id="æ€»ç»“">æ€»ç»“</h3>
<ul>
<li><code>StampedLock</code>ä¸æ˜¯åŸºäºAQSæ¥å®ç°çš„ï¼Œä½†æ˜¯å…¶å†…éƒ¨å®ç°å’ŒAQSç±»ä¼¼ã€‚</li>
<li><code>StampedLock</code>ä¸æ”¯æŒé”çš„é‡å…¥ã€ä¸æ”¯æŒæ¡ä»¶å˜é‡ä¸”åªæœ‰éå…¬å¹³å®ç°ã€‚</li>
<li><code>StampedLock</code>çš„<code>å…è®¸ä¸€ä¸ªçº¿ç¨‹åœ¨å­˜åœ¨å¤šä¸ªè¯»çº¿ç¨‹çš„æ—¶å€™è·å–å†™é”</code>ã€‚</li>
<li><code>StampedLock</code>çš„æ‚²è§‚è¯»å’Œ<code>ReentrentReadWriteLock</code>ç›¸åŒï¼Œéƒ½ä¼šå› ä¸ºå†™é”å­˜åœ¨è€Œé˜»å¡ã€‚</li>
<li><code>StampedLock</code>çš„ä¹è§‚è¯»ï¼Œæ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼Œä½†è¯»å†™ä¸äº’æ–¥ã€‚</li>
<li><code>StampedLock</code>æ”¯æŒ<code>é”çš„å‡çº§å’Œé™çº§</code>ï¼Œè€Œ<code>ReentrentReadWriteLock</code>åªæ”¯æŒ<code>é”é™çº§</code>ã€‚</li>
<li><code>StampedLock</code>å”¤é†’çº¿ç¨‹æ˜¯ä¸€æ¬¡æ€§å”¤é†’è¿ç»­çš„è¯»é”ï¼Œå¹¶ä¸”å…¶ä»–çº¿ç¨‹è¿˜ä¼šååŠ©å”¤é†’ã€‚</li>
</ul>

    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h">å…¶ä»–æ–‡ç« </span>
            <hr />
          </div>
          <div class="pagination__buttons">
            
              <span class="button previous">
                <a href="https://leejay.top/post/blockingqueue/">
                  <span class="button__icon">â†</span>
                  <span class="button__text">BlockingQueue</span>
                </a>
              </span>
            
            
              <span class="button next">
                <a href="https://leejay.top/post/cycliebarrier/">
                  <span class="button__text">CyclieBarrier</span>
                  <span class="button__icon">â†’</span>
                </a>
              </span>
            
          </div>
        </div>
      
    


    
      
        

      
    

    </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright copyright--user">è‹ICPå¤‡18050258å·-1</div>
    
  </div>
</footer>

<script src="https://leejay.top/assets/main.js"></script>
<script src="https://leejay.top/assets/prism.js"></script>


      
    </div>

    
  </body>
</html>
