<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>Condition</title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="description" content="Conditionæ˜¯ä¸€ä¸ªæ¥å£ï¼Œå…¶å®ç°åœ¨Lockå†…ï¼Œéœ€è¦é…åˆLocké”ä½¿ç”¨ã€‚å…¶å†…éƒ¨æ„å»ºäº†ä¸€ä¸ªå•å‘é˜Ÿåˆ—ï¼Œæ“ä½œæ—¶ä¸éœ€è¦ä½¿ç”¨CASæ¥ä¿è¯åŒæ­¥ã€‚
final ConditionObject newCondition() { return new ConditionObject(); } public class ConditionObject implements Condition { /** First node of condition queue. */ private transient Node firstWaiter; /** Last node of condition queue. */ private transient Node lastWaiter; public ConditionObject() { } } await // æ‰§è¡Œawaitæ—¶è‚¯å®šå·²ç»è·å–äº†é”ï¼Œæ‰€ä»¥ä¸éœ€è¦CASæ“ä½œ public final void await() throws InterruptedException { // å¦‚æœå½“å‰çº¿ç¨‹å·²ä¸­æ–­å°±æŠ›å‡ºä¸­æ–­å¼‚å¸¸  if (Thread.interrupted()) throw new InterruptedException(); // å°†å½“å‰çº¿ç¨‹æ·»åŠ åˆ°ç­‰å¾…é˜Ÿåˆ—  Node node = addConditionWaiter(); // çº¿ç¨‹é˜»å¡ä¹‹å‰å¿…é¡»è¦å…ˆé‡Šæ”¾é”ï¼Œå¦åˆ™ä¼šæ­»é”ï¼Œè¿™é‡Œæ˜¯å…¨éƒ¨é‡Šæ”¾ï¼ŒåŒ…æ‹¬é‡å…¥é”  int savedState = fullyRelease(node); int interruptMode = 0; // åˆ¤æ–­nodeæ˜¯å¦åœ¨AQSåŒæ­¥é˜Ÿåˆ—é‡Œé¢ï¼Œåˆå§‹æ˜¯åœ¨æ¡ä»¶é˜Ÿåˆ—é‡Œé¢  while (!"/>
<meta name="keywords" content=""/>
<meta name="robots" content="noodp"/>
<meta name="google-site-verification" content="e1ELBPEvOV5kwQNtzaLcNt-3iZy83eiNhSZkHhQPecs" />
<link rel="canonical" href="https://leejay.top/post/condition/" />





<link rel="stylesheet" href="https://leejay.top/assets/style.css">


<link rel="stylesheet" href="https://leejay.top/style.css">

<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://leejay.top/img/apple-touch-icon-144-precomposed.png">
<link rel="shortcut icon" href="https://leejay.top/img/favicon.png">



<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Condition"/>
<meta name="twitter:description" content="Conditionæ¥å£æä¾›äº†ç±»ä¼¼Object.wait/notifyçš„ç›‘è§†å™¨æ–¹æ³•ï¼Œä¸Lock(åŸºäºAQSçš„é”)é…åˆå¯ä»¥å®ç°`ç­‰å¾…/é€šçŸ¥`æ¨¡å¼ã€‚"/>



<meta property="og:title" content="Condition" />
<meta property="og:description" content="Conditionæ¥å£æä¾›äº†ç±»ä¼¼Object.wait/notifyçš„ç›‘è§†å™¨æ–¹æ³•ï¼Œä¸Lock(åŸºäºAQSçš„é”)é…åˆå¯ä»¥å®ç°`ç­‰å¾…/é€šçŸ¥`æ¨¡å¼ã€‚" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://leejay.top/post/condition/" />
<meta property="article:published_time" content="2020-06-18T20:01:58+08:00" />
<meta property="article:modified_time" content="2020-06-18T20:01:58+08:00" /><meta property="og:site_name" content="Aurora" />






  </head>
  <body class="">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a href="https://leejay.top" class="logo" style="text-decoration: none;">
  
    <span class="logo__mark"><svg xmlns="https://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367"/>
</svg></span>
    <span class="logo__text">Aurora</span>
    <span class="logo__cursor"></span>
    <span class="logo__cursor2"></span>
  
</a>
    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/categories">Categories</a></li>
        
      
        
          <li><a href="/tags">Tags</a></li>
        
      
      
    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/categories">Categories</a></li>
      
    
      
        <li><a href="/tags">Tags</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none"/>
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="https://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>
      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  
  

  <div class="post">
    <h1 class="post-title"><a href="https://leejay.top/post/condition/">Condition</a></h1>
    <div class="post-meta">
      
        <span class="post-date">
          2020-06-18
        </span>

        
          
        
      

      
      
    </div>

    
      <span class="post-tags">
        
        ğŸ–<a href="https://leejay.top/tags/condition/">Condition </a>&nbsp;
        
        ğŸ–<a href="https://leejay.top/tags/aqs/">AQS</a>&nbsp;
        
      </span>
    

    

    <div class="post-content">
      
      <p>Conditionæ˜¯ä¸€ä¸ªæ¥å£ï¼Œå…¶å®ç°åœ¨Lockå†…ï¼Œéœ€è¦é…åˆLocké”ä½¿ç”¨ã€‚å…¶å†…éƒ¨æ„å»ºäº†ä¸€ä¸ªå•å‘é˜Ÿåˆ—ï¼Œæ“ä½œæ—¶ä¸éœ€è¦ä½¿ç”¨CASæ¥ä¿è¯åŒæ­¥ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">final</span> ConditionObject <span style="color:#a6e22e">newCondition</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> ConditionObject<span style="color:#f92672">();</span>
<span style="color:#f92672">}</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ConditionObject</span> <span style="color:#66d9ef">implements</span> Condition <span style="color:#f92672">{</span>
    <span style="color:#75715e">/** First node of condition queue. */</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">transient</span> Node firstWaiter<span style="color:#f92672">;</span>
  <span style="color:#75715e">/** Last node of condition queue. */</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">transient</span> Node lastWaiter<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">ConditionObject</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span> <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h5 id="await">await</h5>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// æ‰§è¡Œawaitæ—¶è‚¯å®šå·²ç»è·å–äº†é”ï¼Œæ‰€ä»¥ä¸éœ€è¦CASæ“ä½œ
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">await</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> InterruptedException <span style="color:#f92672">{</span>
    <span style="color:#75715e">// å¦‚æœå½“å‰çº¿ç¨‹å·²ä¸­æ–­å°±æŠ›å‡ºä¸­æ–­å¼‚å¸¸
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">interrupted</span><span style="color:#f92672">())</span>
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> InterruptedException<span style="color:#f92672">();</span>
    <span style="color:#75715e">// å°†å½“å‰çº¿ç¨‹æ·»åŠ åˆ°ç­‰å¾…é˜Ÿåˆ—
</span><span style="color:#75715e"></span>    Node node <span style="color:#f92672">=</span> addConditionWaiter<span style="color:#f92672">();</span>
    <span style="color:#75715e">// çº¿ç¨‹é˜»å¡ä¹‹å‰å¿…é¡»è¦å…ˆé‡Šæ”¾é”ï¼Œå¦åˆ™ä¼šæ­»é”ï¼Œè¿™é‡Œæ˜¯å…¨éƒ¨é‡Šæ”¾ï¼ŒåŒ…æ‹¬é‡å…¥é”
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> savedState <span style="color:#f92672">=</span> fullyRelease<span style="color:#f92672">(</span>node<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">int</span> interruptMode <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
    <span style="color:#75715e">// åˆ¤æ–­nodeæ˜¯å¦åœ¨AQSåŒæ­¥é˜Ÿåˆ—é‡Œé¢ï¼Œåˆå§‹æ˜¯åœ¨æ¡ä»¶é˜Ÿåˆ—é‡Œé¢
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">while</span> <span style="color:#f92672">(!</span>isOnSyncQueue<span style="color:#f92672">(</span>node<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// signalåä¼šåœ¨æ­¤å¤„å”¤é†’
</span><span style="color:#75715e"></span>        LockSupport<span style="color:#f92672">.</span><span style="color:#a6e22e">park</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
        <span style="color:#75715e">// æ­¤å¤„ç”¨äºæ£€æµ‹æ˜¯è¢«unparkè¿˜æ˜¯è¢«ä¸­æ–­å”¤é†’
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>interruptMode <span style="color:#f92672">=</span> checkInterruptWhileWaiting<span style="color:#f92672">(</span>node<span style="color:#f92672">))</span> <span style="color:#f92672">!=</span> 0<span style="color:#f92672">)</span>
            <span style="color:#75715e">// è¢«ä¸­æ–­ç›´æ¥é€€å‡ºï¼Œè¯´æ˜awaitæ˜¯å¯ä»¥å“åº”ä¸­æ–­çš„
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    <span style="color:#75715e">// å¦‚æœè¢«å”¤é†’æˆ–ä¸­æ–­ï¼Œnodeå°è¯•åŠ å…¥AQSåŒæ­¥é˜Ÿåˆ—ï¼Œåœ¨æ­¤è¿‡ç¨‹ä¸­è¢«ä¸­æ–­ä¿®æ”¹çŠ¶æ€ä¸ºREINTERRUPT
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>acquireQueued<span style="color:#f92672">(</span>node<span style="color:#f92672">,</span> savedState<span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span> interruptMode <span style="color:#f92672">!=</span> THROW_IE<span style="color:#f92672">)</span>
        interruptMode <span style="color:#f92672">=</span> REINTERRUPT<span style="color:#f92672">;</span>
    <span style="color:#75715e">// æ¸…é™¤cancelèŠ‚ç‚¹
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>node<span style="color:#f92672">.</span><span style="color:#a6e22e">nextWaiter</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
        unlinkCancelledWaiters<span style="color:#f92672">();</span>
    <span style="color:#75715e">// è¢«ä¸­æ–­å”¤é†’ï¼ŒæŠ›å‡ºè¢«ä¸­æ–­å¼‚å¸¸
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>interruptMode <span style="color:#f92672">!=</span> 0<span style="color:#f92672">)</span>
        reportInterruptAfterWait<span style="color:#f92672">(</span>interruptMode<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e">// æ·»åŠ çº¿ç¨‹åˆ°æ¡ä»¶é˜Ÿåˆ—
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> Node <span style="color:#a6e22e">addConditionWaiter</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    Node t <span style="color:#f92672">=</span> lastWaiter<span style="color:#f92672">;</span>
    <span style="color:#75715e">// å¦‚æœlastWaiterä¸æ˜¯æ¡ä»¶èŠ‚ç‚¹ï¼Œåˆ é™¤éæ¡ä»¶èŠ‚ç‚¹
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>t <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> t<span style="color:#f92672">.</span><span style="color:#a6e22e">waitStatus</span> <span style="color:#f92672">!=</span> Node<span style="color:#f92672">.</span><span style="color:#a6e22e">CONDITION</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        unlinkCancelledWaiters<span style="color:#f92672">();</span>
        t <span style="color:#f92672">=</span> lastWaiter<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    <span style="color:#75715e">// å°†å½“å‰çº¿ç¨‹åˆ›å»ºnode
</span><span style="color:#75715e"></span>    Node node <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Node<span style="color:#f92672">(</span>Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">currentThread</span><span style="color:#f92672">(),</span> Node<span style="color:#f92672">.</span><span style="color:#a6e22e">CONDITION</span><span style="color:#f92672">);</span>
    <span style="color:#75715e">// é˜Ÿåˆ—ä¸­æ²¡æœ‰å…¶ä»–nodeï¼Œå½“å‰nodeå°±æ˜¯first
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>t <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
        firstWaiter <span style="color:#f92672">=</span> node<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">else</span>
        <span style="color:#75715e">// å¦åˆ™å°†å½“å‰nodeåŠ å…¥åˆ°lastå
</span><span style="color:#75715e"></span>        t<span style="color:#f92672">.</span><span style="color:#a6e22e">nextWaiter</span> <span style="color:#f92672">=</span> node<span style="color:#f92672">;</span>
    <span style="color:#75715e">// å¹¶ä¿®æ”¹lastä¸ºå½“å‰node
</span><span style="color:#75715e"></span>    lastWaiter <span style="color:#f92672">=</span> node<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">return</span> node<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e">// ç§»é™¤éæ¡ä»¶èŠ‚ç‚¹
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">unlinkCancelledWaiters</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// è·å–å¤´èŠ‚ç‚¹ï¼Œä»å‰å¾€åç§»é™¤(å’ŒNodeé˜Ÿåˆ—ä»åå¾€å‰ä¸åŒ)
</span><span style="color:#75715e"></span>    Node t <span style="color:#f92672">=</span> firstWaiter<span style="color:#f92672">;</span>
    Node trail <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
    <span style="color:#75715e">// å½“å¤´èŠ‚ç‚¹ä¸ä¸ºnullæ—¶
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>t <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// è·å–å¤´èŠ‚ç‚¹çš„ä¸‹ä¸ªèŠ‚ç‚¹
</span><span style="color:#75715e"></span>        Node next <span style="color:#f92672">=</span> t<span style="color:#f92672">.</span><span style="color:#a6e22e">nextWaiter</span><span style="color:#f92672">;</span>
        <span style="color:#75715e">// å¦‚æœtèŠ‚ç‚¹ä¸æ˜¯æ¡ä»¶èŠ‚ç‚¹
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>t<span style="color:#f92672">.</span><span style="color:#a6e22e">waitStatus</span> <span style="color:#f92672">!=</span> Node<span style="color:#f92672">.</span><span style="color:#a6e22e">CONDITION</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            t<span style="color:#f92672">.</span><span style="color:#a6e22e">nextWaiter</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>trail <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
                firstWaiter <span style="color:#f92672">=</span> next<span style="color:#f92672">;</span>
            <span style="color:#66d9ef">else</span>
                trail<span style="color:#f92672">.</span><span style="color:#a6e22e">nextWaiter</span> <span style="color:#f92672">=</span> next<span style="color:#f92672">;</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>next <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
                lastWaiter <span style="color:#f92672">=</span> trail<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">else</span>
            trail <span style="color:#f92672">=</span> t<span style="color:#f92672">;</span>
        <span style="color:#75715e">// tæŒ‡å‘ä¸‹ä¸ªèŠ‚ç‚¹ç»§ç»­åˆ¤æ–­
</span><span style="color:#75715e"></span>        t <span style="color:#f92672">=</span> next<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e">// åˆ¤æ–­æ˜¯å¦åœ¨AQSçš„åŒæ­¥é˜Ÿåˆ—ä¸­
</span><span style="color:#75715e"></span><span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isOnSyncQueue</span><span style="color:#f92672">(</span>Node node<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// å¦‚æœwaitStatusè¿˜æ˜¯conditionæˆ–è€…å‰é©±èŠ‚ç‚¹ä¸ºnullï¼Œè¯´æ˜æ˜¯æ¡ä»¶é˜Ÿåˆ—é˜Ÿé¦–ï¼Œè‚¯å®šä¸å†åŒæ­¥é˜Ÿåˆ—
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>node<span style="color:#f92672">.</span><span style="color:#a6e22e">waitStatus</span> <span style="color:#f92672">==</span> Node<span style="color:#f92672">.</span><span style="color:#a6e22e">CONDITION</span> <span style="color:#f92672">||</span> node<span style="color:#f92672">.</span><span style="color:#a6e22e">prev</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
    <span style="color:#75715e">// å› ä¸ºåŒæ­¥é˜Ÿåˆ—æ‰ä¼šç»´æŠ¤nextæŒ‡é’ˆï¼Œæ‰€ä»¥ä¸ä¸ºnullï¼Œè‚¯å®šå·²ç»åœ¨äº†
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>node<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#75715e">// If has successor, it must be on queue
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
    <span style="color:#75715e">// ä»é˜Ÿå°¾å¼€å§‹æŸ¥æ‰¾nodeçœ‹æ˜¯å¦åœ¨åŒæ­¥é˜Ÿåˆ—ä¸­
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> findNodeFromTail<span style="color:#f92672">(</span>node<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<p>Qï¼šconditionçš„await()ã€signal()å’ŒObjectä¸­wait()ã€notify()çš„åŒºåˆ«ï¼Ÿ</p>
<p>Aï¼šé¦–å…ˆæ˜¯åŸºäºä¸åŒçš„é”ï¼šLockå’ŒSynchronizedï¼Œå…¶æ¬¡conditionå¯ä»¥å­˜åœ¨ä¸åŒçš„æ¡ä»¶é˜Ÿåˆ—ï¼Œæ¯ä¸ªæ¡ä»¶é˜Ÿåˆ—ä¹‹é—´äº’ä¸å½±å“ï¼Œè€ŒSynchronizedåªä¼šæœ‰ä¸€ä¸ªæ¡ä»¶é˜Ÿåˆ—(æˆ–æ¡ä»¶å˜é‡ï¼Œæ ¹æ®Synchronizedä¿®é¥°ä½ç½®ä¸åŒï¼Œåˆ†åˆ«ä¸ºthisã€classç±»å’Œä»£ç å—ä¸­å†…å®¹)ã€‚</p>
<p>await()æ–¹æ³•æ˜¯å“åº”ä¸­æ–­çš„ï¼Œè¿™ä¸lock()æ˜¯ä¸ç›¸åŒçš„ï¼Œå¹¶ä¸”await()ä¼šå°†é”é‡Šæ”¾ã€‚</p>
</blockquote>
<h5 id="signal">signal</h5>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">signal</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// çº¿ç¨‹å¿…é¡»æŒæœ‰é”æ‰èƒ½å¤Ÿè°ƒç”¨è¯¥æ–¹æ³•
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>isHeldExclusively<span style="color:#f92672">())</span>
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> IllegalMonitorStateException<span style="color:#f92672">();</span>
    <span style="color:#75715e">// è·å–æ¡ä»¶é˜Ÿåˆ—å¤´èŠ‚ç‚¹
</span><span style="color:#75715e"></span>    Node first <span style="color:#f92672">=</span> firstWaiter<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>first <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
        <span style="color:#75715e">// å”¤é†’å¤´èŠ‚ç‚¹
</span><span style="color:#75715e"></span>        doSignal<span style="color:#f92672">(</span>first<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">doSignal</span><span style="color:#f92672">(</span>Node first<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">do</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">//æ¡ä»¶é˜Ÿåˆ—å¾€åç§»åŠ¨ä¸€ä½ï¼Œæ–°é˜Ÿå¤´ä¸ºnullï¼Œå°†é˜Ÿå°¾ä¹Ÿè®¾ä¸ºnull
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span> <span style="color:#f92672">(</span>firstWaiter <span style="color:#f92672">=</span> first<span style="color:#f92672">.</span><span style="color:#a6e22e">nextWaiter</span><span style="color:#f92672">)</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
            lastWaiter <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
        <span style="color:#75715e">// æ¸…ç©ºé˜Ÿé¦–nextå¼•ç”¨ï¼Œæ­¤æ—¶å°±ä¸åœ¨æ¡ä»¶é˜Ÿåˆ—äº†
</span><span style="color:#75715e"></span>        first<span style="color:#f92672">.</span><span style="color:#a6e22e">nextWaiter</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
        <span style="color:#75715e">// å¦‚æœsignalå¤±è´¥ï¼Œé‚£ä¹ˆå°±ç§»ä¸€ä½è·å–æ–°é˜Ÿå¤´ï¼Œç›´åˆ°signalæˆåŠŸ
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">while</span> <span style="color:#f92672">(!</span>transferForSignal<span style="color:#f92672">(</span>first<span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span>
             <span style="color:#f92672">(</span>first <span style="color:#f92672">=</span> firstWaiter<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
<span style="color:#75715e">// å”¤é†’èŠ‚ç‚¹
</span><span style="color:#75715e"></span><span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">transferForSignal</span><span style="color:#f92672">(</span>Node node<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// å°è¯•å°†nodeçš„waitStatusè®¾ä¸º0ï¼Œæ¢å¤é»˜è®¤çŠ¶æ€ï¼Œå¦‚æœä¸èƒ½æ›´æ–°è¯´æ˜èŠ‚ç‚¹è¢«ä¸­æ–­ï¼Œæ‰§è¡Œäº†cancelAcquire
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>compareAndSetWaitStatus<span style="color:#f92672">(</span>node<span style="color:#f92672">,</span> Node<span style="color:#f92672">.</span><span style="color:#a6e22e">CONDITION</span><span style="color:#f92672">,</span> 0<span style="color:#f92672">))</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
	<span style="color:#75715e">// å°†é˜Ÿé¦–çš„nodeæ·»åŠ åˆ°AQSçš„åŒæ­¥é˜Ÿåˆ—ï¼Œè¿”å›nodeçš„å‰é©±èŠ‚ç‚¹ï¼ï¼
</span><span style="color:#75715e"></span>    Node p <span style="color:#f92672">=</span> enq<span style="color:#f92672">(</span>node<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">int</span> ws <span style="color:#f92672">=</span> p<span style="color:#f92672">.</span><span style="color:#a6e22e">waitStatus</span><span style="color:#f92672">;</span>
    <span style="color:#75715e">// å¦‚æœå‰é©±èŠ‚ç‚¹æ˜¯cancelæˆ–ä¸æ˜¯signalï¼Œé‚£ä¹ˆç›´æ¥å”¤é†’å½“å‰nodeï¼Œè¿™é‡Œä¼šå°†nodeåœ¨isSyncQueue()ä¸­å”¤é†’
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// å‡è®¾é€€å‡ºå¾ªç¯ï¼Œæ‰§è¡ŒacquireQueue()ï¼Œè¯¥æ–¹æ³•é‡Œé¢è¿˜æ˜¯ä¼šç»§ç»­åˆ¤æ–­èƒ½å¦è·å–é”ï¼Œä¸èƒ½å°±å°è¯•è®¾ç½®å‰é©±èŠ‚ç‚¹ä¸ºsiganl
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ws <span style="color:#f92672">&gt;</span> 0 <span style="color:#f92672">||</span> <span style="color:#f92672">!</span>compareAndSetWaitStatus<span style="color:#f92672">(</span>p<span style="color:#f92672">,</span> ws<span style="color:#f92672">,</span> Node<span style="color:#f92672">.</span><span style="color:#a6e22e">SIGNAL</span><span style="color:#f92672">))</span>
        <span style="color:#75715e">// å”¤é†’nodeèŠ‚ç‚¹ï¼Œ
</span><span style="color:#75715e"></span>        LockSupport<span style="color:#f92672">.</span><span style="color:#a6e22e">unpark</span><span style="color:#f92672">(</span>node<span style="color:#f92672">.</span><span style="color:#a6e22e">thread</span><span style="color:#f92672">);</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<p>signalåªä¼šå°†æ¡ä»¶é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªç¬¦åˆçš„èŠ‚ç‚¹ç§»åˆ°AQSçš„ç­‰å¾…é˜Ÿåˆ—</p>
</blockquote>
<h5 id="signalall">signalAll</h5>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">signalAll</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// å¿…é¡»æŒæœ‰é”æ‰èƒ½signalAll
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>isHeldExclusively<span style="color:#f92672">())</span>
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> IllegalMonitorStateException<span style="color:#f92672">();</span>
    <span style="color:#75715e">// è·å–å¤´èŠ‚ç‚¹
</span><span style="color:#75715e"></span>    Node first <span style="color:#f92672">=</span> firstWaiter<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>first <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
        doSignalAll<span style="color:#f92672">(</span>first<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
<span style="color:#75715e">// signalAllä¸signalç•¥å¾®ä¸åŒ
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">doSignalAll</span><span style="color:#f92672">(</span>Node first<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// å› ä¸ºè¦å°†æ•´ä¸ªæ¡ä»¶é˜Ÿåˆ—ç§»åˆ°åŒæ­¥é˜Ÿåˆ—ï¼Œæ‰€ä»¥æ¸…ç©ºé¦–å°¾æ ‡å¿—ï¼Œåªèƒ½é€šè¿‡firstæŸ¥æ‰¾
</span><span style="color:#75715e"></span>    lastWaiter <span style="color:#f92672">=</span> firstWaiter <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
    <span style="color:#66d9ef">do</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// å¾ªç¯æŸ¥æ‰¾firstçš„ç¬¦åˆæ¡ä»¶çš„nextWaiterèŠ‚ç‚¹å¹¶å°†å®ƒç§»å…¥åŒæ­¥é˜Ÿåˆ—
</span><span style="color:#75715e"></span>        Node next <span style="color:#f92672">=</span> first<span style="color:#f92672">.</span><span style="color:#a6e22e">nextWaiter</span><span style="color:#f92672">;</span>
        first<span style="color:#f92672">.</span><span style="color:#a6e22e">nextWaiter</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
        transferForSignal<span style="color:#f92672">(</span>first<span style="color:#f92672">);</span>
        first <span style="color:#f92672">=</span> next<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>first <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<p>signalå’ŒsignalAllæ‰§è¡Œçš„æµç¨‹ä¸­éƒ½ä¸ä¼šé‡Šæ”¾é”ï¼Œè¿™ç‚¹ä¸awaitä¸åŒã€‚</p>
</blockquote>
<h5 id="awaitæ€»ç»“">awaitæ€»ç»“</h5>
<ul>
<li>å°†å½“å‰èŠ‚ç‚¹æ„å»ºæˆæ¡ä»¶èŠ‚ç‚¹åŠ å…¥æ¡ä»¶é˜Ÿå°¾ï¼Œä¸€ä¸ªAQSåŒæ­¥é˜Ÿåˆ—å¯ä»¥å¯¹åº”ç€å¤šä¸ªæ¡ä»¶é˜Ÿåˆ—ã€‚</li>
<li><code>é‡Šæ”¾å…¨éƒ¨çš„é”</code>ï¼Œç‰¹åˆ«æ˜¯é‡å…¥é”ï¼Œå¦‚æœä¸é‡Šæ”¾é”ä¼šå¯¼è‡´æ­»é”ã€‚</li>
<li>åˆ¤æ–­æ˜¯å¦åœ¨AQSçš„åŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œå¦‚æœä¸åœ¨å°±parkå½“å‰çº¿ç¨‹ï¼Œå¦åˆ™å°±å°è¯•æ‰§è¡Œè·å–é”çš„æµç¨‹ï¼Œè¿›è€Œé˜»å¡çº¿ç¨‹æˆ–è€…è·å–é”ã€‚</li>
</ul>
<h5 id="signalsignalallæ€»ç»“">signal/signalAllæ€»ç»“</h5>
<ul>
<li>signalä¼šæ¸…ç©ºå¤´èŠ‚ç‚¹åœ¨æ¡ä»¶é˜Ÿåˆ—çš„å¼•ç”¨ï¼Œå¤´èŠ‚ç‚¹è¿˜å­˜åœ¨ï¼Œåªæ˜¯é˜Ÿåˆ—ä¸­å¼•ç”¨ä¸åœ¨äº†ã€‚</li>
<li>signalå°è¯•å°†<code>æ¡ä»¶é˜Ÿåˆ—çš„å¤´èŠ‚ç‚¹æ·»åŠ åˆ°AQSåŒæ­¥é˜Ÿåˆ—çš„é˜Ÿå°¾</code>ï¼Œå¦‚æœå¤´èŠ‚ç‚¹åœ¨åŒæ­¥é˜Ÿåˆ—ä¸­çš„å‰é©±èŠ‚ç‚¹çŠ¶æ€ä¸ç¬¦åˆæ¡ä»¶ï¼Œä¼šå”¤é†’å¤´èŠ‚ç‚¹ã€‚</li>
<li>signalAllä¼šæ¸…ç©ºé˜Ÿåˆ—é¦–å°¾æ ‡è¯†ï¼Œå¹¶<code>é€šè¿‡firstèŠ‚ç‚¹ä¾æ¬¡å°†æ¡ä»¶é˜Ÿåˆ—ä¸­çš„èŠ‚ç‚¹ç§»å…¥åŒæ­¥é˜Ÿåˆ—ä¸­</code>ï¼Œè‹¥ç¬¦åˆç›¸å…³æ¡ä»¶å°±å”¤é†’ç›¸å…³èŠ‚ç‚¹ã€‚</li>
<li>çº¿ç¨‹awaitä¸­isOnSyncQueue()è¢«å”¤é†’ï¼Œè¿›è€Œæ‰§è¡Œawaitçš„ç›¸å…³é€»è¾‘ã€‚</li>
<li><code>signalå’ŒsignalAllä¸ä¼šé‡Šæ”¾é”</code>ï¼Œè¿™ä¸awaitä¸åŒ</li>
</ul>

    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h">å…¶ä»–æ–‡ç« </span>
            <hr />
          </div>
          <div class="pagination__buttons">
            
              <span class="button previous">
                <a href="https://leejay.top/post/semaphore/">
                  <span class="button__icon">â†</span>
                  <span class="button__text">Semaphore</span>
                </a>
              </span>
            
            
              <span class="button next">
                <a href="https://leejay.top/post/reentrantlock/">
                  <span class="button__text">AQSä¸ReentrantLockç‹¬å é”</span>
                  <span class="button__icon">â†’</span>
                </a>
              </span>
            
          </div>
        </div>
      
    


    
      
        

      
    

    </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright copyright--user">è‹ICPå¤‡18050258å·-1</div>
    
  </div>
</footer>

<script src="https://leejay.top/assets/main.js"></script>
<script src="https://leejay.top/assets/prism.js"></script>
<script type="text/javascript"
src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    showProcessingMessages: false, //å…³é—­jsåŠ è½½è¿‡ç¨‹ä¿¡æ¯
    messageStyle: "none", //ä¸æ˜¾ç¤ºä¿¡æ¯
    extensions: ["tex2jax.js"],
    jax: ["input/TeX", "output/HTML-CSS"],
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre','code', 'a', 'annotation', 'annotation-xml'],
      ignoreClass: 'crayon-.*' // 'crayon-' å¼€å¤´çš„ç±»ï¼Œå±äºWordpressä»£ç é«˜äº®åº“ï¼Œè¿™éƒ¨åˆ†ä¸éœ€è¦å¤„ç†ï¼Œå¦åˆ™ä¼šå¯¼è‡´æ˜¾ç¤ºä¸æ­£ç¡®,è¿™éƒ¨åˆ†æ˜¯æ­£åˆ™å¼ï¼Œå¤šæ¡ä¹‹é—´ç”¨'|'åˆ†å‰²    
    },
    'HTML-CSS': {
        showMathMenu: false //ç¦ç”¨å³é”®èœå•
    }
  });
</script>


      
    </div>

    
  </body>
</html>
