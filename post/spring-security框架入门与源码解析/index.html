<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>Spring Securityæ¡†æ¶å…¥é—¨ä¸æºç è§£æ :: Keep Improving</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Spring Securityå…¥é—¨ ä¾èµ–ä¸é…ç½® mavenä¾èµ– &amp;lt;dependency&amp;gt; &amp;lt;groupId&amp;gt;org.springframework.boot&amp;lt;/groupId&amp;gt; &amp;lt;artifactId&amp;gt;spring-boot-starter-security&amp;lt;/artifactId&amp;gt; &amp;lt;/dependency&amp;gt; &amp;lt;dependency&amp;gt; &amp;lt;groupId&amp;gt;org.springframework.boot&amp;lt;/groupId&amp;gt; &amp;lt;artifactId&amp;gt;spring-boot-starter-web&amp;lt;/artifactId&amp;gt; &amp;lt;/dependency&amp;gt; Spring Securityé…ç½® @Configuration public class WebSecurityConfig extends WebSecurityConfigurerAdapter { /** * è‡ªå®šä¹‰ç”¨æˆ·ç®¡ç†ç³»ç»Ÿ */ @Bean public UserDetailsManager userDetailsManager() { UserManager userManager = new UserManager(); userManager.createUser(innerUser()); return userManager; } private UserDetails innerUser() { // load user by username æ¨¡æ‹Ÿä»æ•°æ®åº“è·å–ç”¨æˆ·æƒé™ç­‰ä¿¡æ¯ List&amp;lt;GrantedAuthority&amp;gt; authorities = new ArrayList&amp;lt;&amp;gt;(); // æ·»åŠ  ADMIN &amp;amp; USER æƒé™ authorities.add(new SimpleGrantedAuthority(&amp;#34;USER&amp;#34;)); authorities.add(new SimpleGrantedAuthority(&amp;#34;ADMIN&amp;#34;)); // ä¸€èˆ¬æ•°æ®åº“ç”¨æˆ·å¯†ç å­˜å…¥æ—¶ä¼šå…ˆåŠ å¯†ï¼Œæ­¤å¤„åªæ˜¯æ¨¡æ‹ŸåŠ å¯†åçš„ç”¨æˆ·ä¿¡æ¯ // ä½¿ç”¨UserDetails.User$UserBuilderæ„å»ºuser return User.withUsername(&amp;#34;jack&amp;#34;) ." />
<meta name="keywords" content="" />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://leejay.top/post/spring-security%E6%A1%86%E6%9E%B6%E5%85%A5%E9%97%A8%E4%B8%8E%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" />




<link rel="stylesheet" href="https://leejay.top/assets/style.css">






<link rel="apple-touch-icon" href="https://leejay.top/img/favicon.png">

  <link rel="shortcut icon" href="https://leejay.top/img/favicon.png">



<meta name="twitter:card" content="summary" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Spring Securityæ¡†æ¶å…¥é—¨ä¸æºç è§£æ">
<meta property="og:description" content="Spring Securityä½œä¸ºJava Webçš„å®‰å…¨æ¡†æ¶ï¼Œç”¨äºå®ç°å®‰å…¨æ§åˆ¶ã€‚" />
<meta property="og:url" content="https://leejay.top/post/spring-security%E6%A1%86%E6%9E%B6%E5%85%A5%E9%97%A8%E4%B8%8E%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" />
<meta property="og:site_name" content="Keep Improving" />

  
    <meta property="og:image" content="https://leejay.top/img/favicon.png">
  

<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">

  <meta property="article:section" content="Java" />


  <meta property="article:published_time" content="2021-03-19 17:47:21 &#43;0800 &#43;0800" />










<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fira+Code">

</head>
<body class="orange">


<div class="container center headings--one-size">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="https://leejay.top">
  <div class="logo">
    HelloWorld
  </div>
</a>

    </div>
    
  </div>
  
  
  <script type="text/javascript"
        async
        src="https://cdn.bootcss.com/mathjax/2.7.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\[\[','\]\]']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
});

MathJax.Hub.Queue(function() {
    
    
    
    var all = MathJax.Hub.getAllJax(), i;
    for(i = 0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
});
</script>

<style>
code.has-jax {
    font: inherit;
    font-size: 100%;
    background: inherit;
    border: inherit;
    color: #515151;
}
</style>

</header>


  <div class="content">
    
<div class="post">
  
  
    









<div class="toc" id="toc_id">

    <div class="page-header"><strong>- CATALOG -</strong></div>

    <div id="page-scrollspy" class="toc-nav">

        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#spring-security%e5%85%a5%e9%97%a8">
                    Spring Securityå…¥é—¨
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e4%be%9d%e8%b5%96%e4%b8%8e%e9%85%8d%e7%bd%ae">
                    ä¾èµ–ä¸é…ç½®
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#maven%e4%be%9d%e8%b5%96">
                    mavenä¾èµ–
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#spring-security%e9%85%8d%e7%bd%ae">
                    Spring Securityé…ç½®
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e7%94%a8%e6%88%b7%e6%8e%a5%e5%8f%a3%e4%b8%8e%e7%bc%96%e7%a0%81%e5%99%a8">
                    ç”¨æˆ·æ¥å£ä¸ç¼–ç å™¨
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e8%8e%b7%e5%8f%96%e7%94%a8%e6%88%b7%e4%bf%a1%e6%81%af">
                    è·å–ç”¨æˆ·ä¿¡æ¯
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#passwordencoder%e7%bc%96%e7%a0%81%e5%99%a8">
                    PasswordEncoderç¼–ç å™¨
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e8%87%aa%e5%8a%a8%e9%85%8d%e7%bd%ae">
                    è‡ªåŠ¨é…ç½®
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#securityautoconfiguration">
                    SecurityAutoConfiguration
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#springbootwebsecurityconfiguration">
                    SpringBootWebSecurityConfiguration
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#websecurityenablerconfiguration">
                    WebSecurityEnablerConfiguration
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#securityfilterautoconfiguration">
                    SecurityFilterAutoConfiguration
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#delegatingfilterproxyregistrationbean">
                    DelegatingFilterProxyRegistrationBean
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e8%87%aa%e5%ae%9a%e4%b9%89%e9%85%8d%e7%bd%ae">
                    è‡ªå®šä¹‰é…ç½®
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#httpsecurity%e5%85%a5%e9%97%a8">
                    HttpSecurityå…¥é—¨
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#authenticationmanager%e6%ba%90%e7%a0%81%e8%a7%a3%e6%9e%90">
                    AuthenticationManageræºç è§£æ
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#usernamepasswordauthenticationfilter">
                    UsernamePasswordAuthenticationFilter
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#abstractauthenticationprocessingfilter">
                    AbstractAuthenticationProcessingFilter
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#authenticationmanager%e5%88%9d%e5%a7%8b%e5%8c%96%e6%b5%81%e7%a8%8b">
                    AuthenticationManageråˆå§‹åŒ–æµç¨‹ğŸ”’
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#1-securityautoconfiguration">
                    1. SecurityAutoConfiguration
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#2-websecurityconfiguration">
                    2. WebSecurityConfiguration
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#3--enableglobalauthentication">
                    3. @EnableGlobalAuthenticationğŸˆ
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#4-websecurityconfigureradapter">
                    4. WebSecurityConfigurerAdapter
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#5-providemanager">
                    5. ProvideManager
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#6-%e6%b5%81%e7%a8%8b%e5%9b%be%e6%80%bb%e7%bb%93">
                    6. æµç¨‹å›¾æ€»ç»“
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#filter">
                    Filter
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#spring-security%e5%86%85%e7%bd%ae%e8%bf%87%e6%bb%a4%e5%99%a8">
                    Spring Securityå†…ç½®è¿‡æ»¤å™¨
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#filter%e6%89%a7%e8%a1%8c%e9%a1%ba%e5%ba%8f">
                    Filteræ‰§è¡Œé¡ºåº
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e5%86%85%e7%bd%ae%e8%bf%87%e6%bb%a4%e5%99%a8">
                    å†…ç½®è¿‡æ»¤å™¨
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#spring-security%e8%bf%87%e6%bb%a4%e5%99%a8%e9%93%be">
                    Spring Securityè¿‡æ»¤å™¨é“¾
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#jwtjson-web-token">
                    JWT(Json Web Token)
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#rbac">
                    RBAC
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e5%9f%ba%e4%ba%8e%e9%85%8d%e7%bd%ae%e7%9a%84%e6%9d%83%e9%99%90">
                    åŸºäºé…ç½®çš„æƒé™
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e5%9f%ba%e4%ba%8e%e6%b3%a8%e8%a7%a3%e7%9a%84%e6%9d%83%e9%99%90">
                    åŸºäºæ³¨è§£çš„æƒé™
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e5%90%af%e5%8a%a8%e5%85%a8%e5%b1%80%e6%9d%83%e9%99%90%e6%b3%a8%e8%a7%a3">
                    å¯åŠ¨å…¨å±€æƒé™æ³¨è§£
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#preauthorize">
                    @PreAuthorize
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#postauthorize">
                    @PostAuthorize
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#prefilter">
                    @PreFilter
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#postfilter">
                    @PostFilter
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#securitycontext%e5%ae%89%e5%85%a8%e4%b8%8a%e4%b8%8b%e6%96%87">
                    SecurityContextå®‰å…¨ä¸Šä¸‹æ–‡
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#securitycontextholder%e6%ba%90%e7%a0%81%e8%a7%a3%e6%9e%90">
                    SecurityContextHolderæºç è§£æ
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#threadlocalsecuritycontextholderstrategy">
                    ThreadLocalSecurityContextHolderStrategy
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#securitycontextimpl">
                    SecurityContextImpl
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e5%8a%a8%e6%80%81%e6%9d%83%e9%99%90">
                    åŠ¨æ€æƒé™
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e5%ae%89%e5%85%a8%e6%9d%83%e9%99%90%e6%95%b0%e6%8d%ae%e6%ba%90">
                    å®‰å…¨æƒé™æ•°æ®æº
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e8%87%aa%e5%ae%9a%e4%b9%89%e6%9d%83%e9%99%90%e6%95%b0%e6%8d%ae%e6%ba%90">
                    è‡ªå®šä¹‰æƒé™æ•°æ®æº
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e6%8a%95%e7%a5%a8%e6%a8%a1%e5%9e%8b">
                    æŠ•ç¥¨æ¨¡å‹
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e8%87%aa%e5%ae%9a%e4%b9%89accessdecisionmanager">
                    è‡ªå®šä¹‰AccessDecisionManager
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e8%87%aa%e5%ae%9a%e4%b9%89accessdecisionvoter">
                    è‡ªå®šä¹‰AccessDecisionVoter
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e5%bc%82%e5%b8%b8%e6%8e%a7%e5%88%b6%e5%99%a8">
                    å¼‚å¸¸æ§åˆ¶å™¨
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e6%9c%aa%e7%99%bb%e5%bd%95%e5%bc%82%e5%b8%b8%e6%8e%a7%e5%88%b6%e5%99%a8">
                    æœªç™»å½•å¼‚å¸¸æ§åˆ¶å™¨
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e6%97%a0%e6%9d%83%e9%99%90%e5%bc%82%e5%b8%b8%e6%8e%a7%e5%88%b6%e5%99%a8">
                    æ— æƒé™å¼‚å¸¸æ§åˆ¶å™¨
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#spring-security-config">
                    Spring Security config
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        

    </div>

</div>



  
  <h1 class="post-title">
    <a href="https://leejay.top/post/spring-security%E6%A1%86%E6%9E%B6%E5%85%A5%E9%97%A8%E4%B8%8E%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/">Spring Securityæ¡†æ¶å…¥é—¨ä¸æºç è§£æ</a></h1>
  <div class="post-meta">
    
      <span class="post-date">
        2021-03-19 
      </span>
    
    
  </div>

  
  <span class="post-tags">
    
    #<a href="https://leejay.top/tags/spring-security/">Spring Security</a>&nbsp;
    
  </span>
  

  

  

  <div class="post-content"><div>
        <h2 id="spring-securityå…¥é—¨">Spring Securityå…¥é—¨<a href="#spring-securityå…¥é—¨" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<h3 id="ä¾èµ–ä¸é…ç½®">ä¾èµ–ä¸é…ç½®<a href="#ä¾èµ–ä¸é…ç½®" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<h4 id="mavenä¾èµ–">mavenä¾èµ–<a href="#mavenä¾èµ–" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-starter-security<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-starter-web<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span></code></pre></div><h4 id="spring-securityé…ç½®">Spring Securityé…ç½®<a href="#spring-securityé…ç½®" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Configuration</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">WebSecurityConfig</span> <span style="color:#66d9ef">extends</span> WebSecurityConfigurerAdapter <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * è‡ªå®šä¹‰ç”¨æˆ·ç®¡ç†ç³»ç»Ÿ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> UserDetailsManager <span style="color:#a6e22e">userDetailsManager</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        UserManager userManager <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> UserManager<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        userManager<span style="color:#f92672">.</span><span style="color:#a6e22e">createUser</span><span style="color:#f92672">(</span>innerUser<span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> userManager<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> UserDetails <span style="color:#a6e22e">innerUser</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// load user by username æ¨¡æ‹Ÿä»æ•°æ®åº“è·å–ç”¨æˆ·æƒé™ç­‰ä¿¡æ¯
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        List<span style="color:#f92672">&lt;</span>GrantedAuthority<span style="color:#f92672">&gt;</span> authorities <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// æ·»åŠ  ADMIN &amp; USER æƒé™
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        authorities<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> SimpleGrantedAuthority<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;USER&#34;</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>        authorities<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> SimpleGrantedAuthority<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;ADMIN&#34;</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// ä¸€èˆ¬æ•°æ®åº“ç”¨æˆ·å¯†ç å­˜å…¥æ—¶ä¼šå…ˆåŠ å¯†ï¼Œæ­¤å¤„åªæ˜¯æ¨¡æ‹ŸåŠ å¯†åçš„ç”¨æˆ·ä¿¡æ¯
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// ä½¿ç”¨UserDetails.User$UserBuilderæ„å»ºuser
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span> User<span style="color:#f92672">.</span><span style="color:#a6e22e">withUsername</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;jack&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">.</span><span style="color:#a6e22e">passwordEncoder</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> BCryptPasswordEncoder<span style="color:#f92672">()::</span>encode<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">.</span><span style="color:#a6e22e">password</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;jack&#34;</span><span style="color:#f92672">)</span> <span style="color:#75715e">// å¦‚æœä¸å¼€å¯åŠ å¯†ï¼Œé‚£ä¹ˆéœ€è¦å»é™¤passwordEncoderï¼Œå¯†ç å˜æˆ&#34;{noop}jack&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#75715e">// AuthorityUtils.NO_AUTHORITIES
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#f92672">.</span><span style="color:#a6e22e">authorities</span><span style="color:#f92672">(</span>authorities<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">.</span><span style="color:#a6e22e">build</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">configure</span><span style="color:#f92672">(</span>HttpSecurity http<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// loginé¡µé¢ç™»å½•æˆåŠŸåé‡å®šå‘åœ°å€ï¼ˆå¦‚æœæ˜¯successfulForwardUrlåˆ™æ˜¯è½¬å‘ï¼‰
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        http<span style="color:#f92672">.</span><span style="color:#a6e22e">formLogin</span><span style="color:#f92672">().</span><span style="color:#a6e22e">defaultSuccessUrl</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;http://www.baidu.com&#34;</span><span style="color:#f92672">)</span> 
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">.</span><span style="color:#a6e22e">and</span><span style="color:#f92672">().</span><span style="color:#a6e22e">authorizeRequests</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">.</span><span style="color:#a6e22e">antMatchers</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/hello&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;/json&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">access</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;hasAuthority(&#39;USER&#39;)&#34;</span><span style="color:#f92672">)</span> <span style="color:#75715e">// SPELè¡¨è¾¾å¼
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#f92672">.</span><span style="color:#a6e22e">antMatchers</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/admin/**&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">access</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;hasAuthority(&#39;ADMIN&#39;) and hasAuthority(&#39;USER&#39;)&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">.</span><span style="color:#a6e22e">antMatchers</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/super/**&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">access</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;hasAuthority(&#39;SUPER_ADMIN&#39;)&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// ä½¿ç”¨è‡ªå®šä¹‰ç±»å®ç°æ ¡éªŒ,falseå°±éœ€è¦ç™»å½•
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#f92672">.</span><span style="color:#a6e22e">antMatchers</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/test&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">access</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;@rbacService.checkPermission()&#34;</span><span style="color:#f92672">)</span> 
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">.</span><span style="color:#a6e22e">antMatchers</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/**&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">authenticated</span><span style="color:#f92672">()</span> <span style="color:#75715e">// åªè¦æ˜¯ç™»å½•ç”¨æˆ·éƒ½å¯ä»¥è®¿é—®ï¼ˆä¸éœ€è¦æŸ¥éªŒæƒé™ä¹‹ç±»ï¼‰
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#f92672">.</span><span style="color:#a6e22e">and</span><span style="color:#f92672">().</span><span style="color:#a6e22e">csrf</span><span style="color:#f92672">()</span> <span style="color:#75715e">// æ·»åŠ csrfçš„æ”¯æŒ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#75715e">// è¿”å›jsonä¿¡æ¯
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#f92672">.</span><span style="color:#a6e22e">and</span><span style="color:#f92672">().</span><span style="color:#a6e22e">exceptionHandling</span><span style="color:#f92672">().</span><span style="color:#a6e22e">accessDeniedHandler</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> JsonAccessDeniedHandler<span style="color:#f92672">());</span> 
</span></span><span style="display:flex;"><span>        	<span style="color:#75715e">// hasRole å’Œ hasAuthorityçš„åŒºåˆ«ï¼Œå‰è€…ä¼šæ‹¼æ¥&#39;ROLE_&#39;å‰ç¼€ï¼Œåè€…ä¸ä¼š
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>     <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">configure</span><span style="color:#f92672">(</span>AuthenticationManagerBuilder auth<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>         auth<span style="color:#f92672">.</span><span style="color:#a6e22e">userDetailsService</span><span style="color:#f92672">(</span>userDetailsManager<span style="color:#f92672">()).</span><span style="color:#a6e22e">passwordEncoder</span><span style="color:#f92672">(</span>passwordEncoder<span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UserManager</span> <span style="color:#66d9ef">implements</span> UserDetailsManager <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> UserDetails<span style="color:#f92672">&gt;</span> users <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashMap<span style="color:#f92672">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">createUser</span><span style="color:#f92672">(</span>UserDetails user<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        users<span style="color:#f92672">.</span><span style="color:#a6e22e">putIfAbsent</span><span style="color:#f92672">(</span>user<span style="color:#f92672">.</span><span style="color:#a6e22e">getUsername</span><span style="color:#f92672">(),</span> user<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">updateUser</span><span style="color:#f92672">(</span>UserDetails user<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        users<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>user<span style="color:#f92672">.</span><span style="color:#a6e22e">getUsername</span><span style="color:#f92672">(),</span> user<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">deleteUser</span><span style="color:#f92672">(</span>String username<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        users<span style="color:#f92672">.</span><span style="color:#a6e22e">remove</span><span style="color:#f92672">(</span>username<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">changePassword</span><span style="color:#f92672">(</span>String oldPassword<span style="color:#f92672">,</span> String newPassword<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        Authentication current <span style="color:#f92672">=</span> SecurityContextHolder<span style="color:#f92672">.</span><span style="color:#a6e22e">getContext</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getAuthentication</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">null</span> <span style="color:#f92672">==</span> current<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> AccessDeniedException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Can&#39;t not change password! because no authentication found in context for current user&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        String username <span style="color:#f92672">=</span> current<span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        UserDetails userDetails <span style="color:#f92672">=</span> users<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>username<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">null</span> <span style="color:#f92672">==</span> userDetails<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> RuntimeException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Current user not exist in database!&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// change password
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">userExists</span><span style="color:#f92672">(</span>String username<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> users<span style="color:#f92672">.</span><span style="color:#a6e22e">containsKey</span><span style="color:#f92672">(</span>username<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> UserDetails <span style="color:#a6e22e">loadUserByUsername</span><span style="color:#f92672">(</span>String username<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> UsernameNotFoundException <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> users<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>username<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><hr>
<h2 id="ç”¨æˆ·æ¥å£ä¸ç¼–ç å™¨">ç”¨æˆ·æ¥å£ä¸ç¼–ç å™¨<a href="#ç”¨æˆ·æ¥å£ä¸ç¼–ç å™¨" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<h3 id="è·å–ç”¨æˆ·ä¿¡æ¯">è·å–ç”¨æˆ·ä¿¡æ¯<a href="#è·å–ç”¨æˆ·ä¿¡æ¯" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>Spring Securityï¼ˆç®€ç§°SSï¼‰çš„ç”¨æˆ·ä¿¡æ¯ç”±ä½¿ç”¨è€…é€šè¿‡å®ç°æ¡†æ¶æä¾›çš„<code>UserDetailsService$loadUserByUsername()</code>æ¥å£æ–¹æ³•æä¾›ã€‚SSè¿˜æä¾›äº†<code>UserDetailsæ¥å£</code>ï¼Œä½œä¸ºæä¾›ç”¨æˆ·ä¿¡æ¯çš„æ ¸å¿ƒæ¥å£ã€‚å†…åµŒäº†<code>Userç±»</code>ä½œä¸º<code>UserDetails</code>çš„é»˜è®¤å®ç°ã€‚<code>UserDetailsManager</code>ä½œä¸ºç®¡ç†ç”¨æˆ·ä¿¡æ¯ï¼ˆå¢åˆ æ”¹æŸ¥ï¼‰çš„é»˜è®¤å†…åµŒç®¡ç†å™¨æ¥å£ã€‚è€Œ<code>InMemoryUserDetailsManager</code>åˆ™æ˜¯é»˜è®¤çš„ç”¨æˆ·ç®¡ç†å™¨å®ç°ã€‚<img src="https://image.leejay.top/FkHsFi8_iqAaYOZ9nXECDTbk8L0d" alt=""></p>
<blockquote>
<p>Userç±»å†…åµŒäº†<code>UserBuilder</code>ï¼Œç”¨äºå»ºé€ è®¾è®¡æ¨¡å¼çš„ä½¿ç”¨ã€‚</p>
<p><code>InMemoryUserDetailsManager</code>é»˜è®¤æ˜¯ç”±<code>UserDetailsServiceAutoConfiguration</code>ç±»æ„é€ å¹¶æ³¨å…¥IOCå®¹å™¨ã€‚</p>
</blockquote>
<h3 id="passwordencoderç¼–ç å™¨">PasswordEncoderç¼–ç å™¨<a href="#passwordencoderç¼–ç å™¨" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">PasswordEncoder</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    String <span style="color:#a6e22e">encode</span><span style="color:#f92672">(</span>CharSequence rawPassword<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">matches</span><span style="color:#f92672">(</span>CharSequence rawPassword<span style="color:#f92672">,</span> String encodedPassword<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">default</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">upgradeEncoding</span><span style="color:#f92672">(</span>String encodedPassword<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DelegatingPasswordEncoder</span> <span style="color:#66d9ef">implements</span> PasswordEncoder <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">DelegatingPasswordEncoder</span><span style="color:#f92672">(</span>String idForEncode<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>		Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> PasswordEncoder<span style="color:#f92672">&gt;</span> idToPasswordEncoder<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">PasswordEncoderFactories</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> PasswordEncoder <span style="color:#a6e22e">createDelegatingPasswordEncoder</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    	String encodingId <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;bcrypt&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>		Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> PasswordEncoder<span style="color:#f92672">&gt;</span> encoders <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashMap<span style="color:#f92672">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>		encoders<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>encodingId<span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> BCryptPasswordEncoder<span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// æ­¤å¤„çœç•¥
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> DelegatingPasswordEncoder<span style="color:#f92672">(</span>encodingId<span style="color:#f92672">,</span> encoders<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">WebSecurityConfigurerAdapter</span> <span style="color:#66d9ef">implements</span>
</span></span><span style="display:flex;"><span>		WebSecurityConfigurer<span style="color:#f92672">&lt;</span>WebSecurity<span style="color:#f92672">&gt;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">LazyPasswordEncoder</span> <span style="color:#66d9ef">implements</span> PasswordEncoder <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">private</span> PasswordEncoder <span style="color:#a6e22e">getPasswordEncoder</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// æ­¤å¤„çœç•¥
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>passwordEncoder <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>				passwordEncoder <span style="color:#f92672">=</span> PasswordEncoderFactories<span style="color:#f92672">.</span><span style="color:#a6e22e">createDelegatingPasswordEncoder</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<ol>
<li>æ‰€æœ‰çš„ç¼–ç å™¨éƒ½è¦å®ç°è¯¥æ¥å£ï¼Œå½“IOCå®¹å™¨ä¸­æ— ç¼–ç å™¨æ—¶ï¼ŒSSé»˜è®¤çš„ç¼–ç å™¨å°±æ˜¯<code>BCrypt</code>ã€‚</li>
<li>æ­¤å¤„é‡‡ç”¨äº†<code>é€‚é…å™¨</code>æ¨¡å¼ï¼Œäº¤ç”±<code>DelegatingPasswordEncoder</code>æ¥å¤„ç†é»˜è®¤çš„ç¼–ç å™¨å·¥ä½œã€‚</li>
<li>é»˜è®¤ç”±<code>PasswordEncoderFactories</code>é™æ€å·¥å‚ç”Ÿäº§<code>DelegatingPasswordEncoder</code>ã€‚</li>
<li>é™æ€å·¥å‚ç”±SSé»˜è®¤é…ç½®æ¥å£<code>WebSecurityConfigurer</code>çš„é€‚é…å™¨ç±»å®ç°<code>WebSecurityConfigurerAdapter</code>è°ƒç”¨ã€‚</li>
</ol>
</blockquote>
<hr>
<h2 id="è‡ªåŠ¨é…ç½®">è‡ªåŠ¨é…ç½®<a href="#è‡ªåŠ¨é…ç½®" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<h3 id="securityautoconfiguration">SecurityAutoConfiguration<a href="#securityautoconfiguration" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Configuration</span><span style="color:#f92672">(</span>proxyBeanMethods <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@ConditionalOnClass</span><span style="color:#f92672">(</span>DefaultAuthenticationEventPublisher<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@EnableConfigurationProperties</span><span style="color:#f92672">(</span>SecurityProperties<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Import</span><span style="color:#f92672">({</span> SpringBootWebSecurityConfiguration<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> WebSecurityEnablerConfiguration<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>		SecurityDataConfiguration<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span> <span style="color:#f92672">})</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SecurityAutoConfiguration</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">@Bean</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">@ConditionalOnMissingBean</span><span style="color:#f92672">(</span>AuthenticationEventPublisher<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">public</span> DefaultAuthenticationEventPublisher <span style="color:#a6e22e">authenticationEventPublisher</span><span style="color:#f92672">(</span>ApplicationEventPublisher publisher<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> DefaultAuthenticationEventPublisher<span style="color:#f92672">(</span>publisher<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<ol>
<li>é»˜è®¤æ³¨å…¥<code>DefaultAuthenticationEventPublisher</code>ç”¨äºæ—¶é—´çš„å‘å¸ƒã€‚</li>
<li>æ³¨å…¥é…ç½®ç±»<code>SecurityProperties</code></li>
<li>æ³¨å…¥<code>SpringBootWebSecurityConfiguration</code>ã€<code>WebSecurityEnablerConfiguration</code>ã€<code>SecurityDataConfiguration</code></li>
</ol>
</blockquote>
<h4 id="springbootwebsecurityconfiguration">SpringBootWebSecurityConfiguration<a href="#springbootwebsecurityconfiguration" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Configuration</span><span style="color:#f92672">(</span>proxyBeanMethods <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@ConditionalOnClass</span><span style="color:#f92672">(</span>WebSecurityConfigurerAdapter<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@ConditionalOnMissingBean</span><span style="color:#f92672">(</span>WebSecurityConfigurerAdapter<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@ConditionalOnWebApplication</span><span style="color:#f92672">(</span>type <span style="color:#f92672">=</span> Type<span style="color:#f92672">.</span><span style="color:#a6e22e">SERVLET</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SpringBootWebSecurityConfiguration</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">@Configuration</span><span style="color:#f92672">(</span>proxyBeanMethods <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">@Order</span><span style="color:#f92672">(</span>SecurityProperties<span style="color:#f92672">.</span><span style="color:#a6e22e">BASIC_AUTH_ORDER</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DefaultConfigurerAdapter</span> <span style="color:#66d9ef">extends</span> WebSecurityConfigurerAdapter <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<ol>
<li>å½“å‰ç¯å¢ƒæ˜¯<code>Servlet</code>ï¼Œå½“å­˜åœ¨<code>WebSecurityConfigurerAdapter</code>æ—¶ï¼Œä¸æ³¨å…¥<code>SpringBootWebSecurityConfiguration</code>ï¼Œä¸å­˜åœ¨æ—¶åˆ™æ³¨å…¥é»˜è®¤çš„<code>DefaultConfigurerAdapter</code>ã€‚</li>
<li>æ³¨å…¥é»˜è®¤çš„<code>DefaultConfigurerAdapter</code>ï¼ŒåŒæ—¶æŒ‡å®š<code>Order(Integer.MAX_VALUE - 5)</code>ã€‚</li>
</ol>
</blockquote>
<h4 id="websecurityenablerconfiguration">WebSecurityEnablerConfiguration<a href="#websecurityenablerconfiguration" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Configuration</span><span style="color:#f92672">(</span>proxyBeanMethods <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@ConditionalOnBean</span><span style="color:#f92672">(</span>WebSecurityConfigurerAdapter<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@ConditionalOnMissingBean</span><span style="color:#f92672">(</span>name <span style="color:#f92672">=</span> BeanIds<span style="color:#f92672">.</span><span style="color:#a6e22e">SPRING_SECURITY_FILTER_CHAIN</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@ConditionalOnWebApplication</span><span style="color:#f92672">(</span>type <span style="color:#f92672">=</span> ConditionalOnWebApplication<span style="color:#f92672">.</span><span style="color:#a6e22e">Type</span><span style="color:#f92672">.</span><span style="color:#a6e22e">SERVLET</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@EnableWebSecurity</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">WebSecurityEnablerConfiguration</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<ol>
<li>å½“å­˜åœ¨<code>WebSecurityConfigurerAdapter</code>ã€ä¸å­˜åœ¨<code>springSecurityFilterChain</code>ä¸”æ˜¯<code>Servlet</code>ç¯å¢ƒæ—¶ï¼Œæ¿€æ´»<code>@EnableWebSecurity</code>æ³¨è§£ã€‚</li>
</ol>
</blockquote>
<h5 id="enablewebsecurity">@EnableWebSecurity<a href="#enablewebsecurity" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Retention</span><span style="color:#f92672">(</span>value <span style="color:#f92672">=</span> java<span style="color:#f92672">.</span><span style="color:#a6e22e">lang</span><span style="color:#f92672">.</span><span style="color:#a6e22e">annotation</span><span style="color:#f92672">.</span><span style="color:#a6e22e">RetentionPolicy</span><span style="color:#f92672">.</span><span style="color:#a6e22e">RUNTIME</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Target</span><span style="color:#f92672">(</span>value <span style="color:#f92672">=</span> <span style="color:#f92672">{</span> java<span style="color:#f92672">.</span><span style="color:#a6e22e">lang</span><span style="color:#f92672">.</span><span style="color:#a6e22e">annotation</span><span style="color:#f92672">.</span><span style="color:#a6e22e">ElementType</span><span style="color:#f92672">.</span><span style="color:#a6e22e">TYPE</span> <span style="color:#f92672">})</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Documented</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Import</span><span style="color:#f92672">({</span> WebSecurityConfiguration<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>   	SpringWebMvcImportSelector<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>   	OAuth2ImportSelector<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span> <span style="color:#f92672">})</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@EnableGlobalAuthentication</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Configuration</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#a6e22e">@interface</span> EnableWebSecurity <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">debug</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">default</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<p><code>@EnableWebSecurity</code>æ³¨è§£çš„æ ¸å¿ƒåœ¨äºå¼•å…¥<code>WebSecurityConfiguration</code>ã€<code>SpringWebMvcImportSelector</code>ã€<code>OAuth2ImportSelector</code>ä¸‰ä¸ªç±»ã€‚</p>
</blockquote>
<ul>
<li>WebSecurityConfiguration</li>
</ul>
<p>åˆ›å»º<code>Spring Security</code>ç›¸å…³çš„å®‰å…¨è¿‡æ»¤å™¨ï¼ˆbeanId = <code>springSecurityFilterChain</code>ï¼‰æ¥å¯¹ç”¨æˆ·çš„è¯·æ±‚è¿›è¡Œè¿‡æ»¤ã€‚</p>
<ul>
<li>SpringWebMvcImportSelector</li>
</ul>
<p>å½“classpathä¸‹å­˜åœ¨<code>DispatcherServlet</code>æ—¶æ³¨å…¥<code>WebMvcSecurityConfiguration</code>ç±»ï¼Œä¸»è¦æ˜¯ç”¨äºé…ç½®<code>SpringMVC</code>ç›¸å…³ã€‚</p>
<ul>
<li>OAuth2ImportSelector</li>
</ul>
<p>å½“å­˜åœ¨<code>ClientRegistration</code>æ—¶æ³¨å…¥<code>OAuth2ClientConfiguration</code>ï¼Œå½“å­˜åœ¨<code>ExchangeFilterFunction</code>æ—¶æ³¨å…¥<code>SecurityReactorContextConfiguration</code>ï¼Œå½“å­˜åœ¨<code>BearerTokenError</code>æ—¶æ³¨å…¥<code>SecurityReactorContextConfiguration</code>ã€‚</p>
<ul>
<li>@EnableGlobalAuthentication</li>
</ul>
<p>æ ¸å¿ƒåœ¨äºæ„å»ºè®¤è¯ç®¡ç†å™¨<code>AuthenticationManager</code>ã€‚</p>
<h5 id="securitydataconfiguration">SecurityDataConfiguration<a href="#securitydataconfiguration" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h5>
<p>è‡ªåŠ¨æ·»åŠ Spring Securityä¸Spring Dataçš„é›†æˆã€‚</p>
<h3 id="securityfilterautoconfiguration">SecurityFilterAutoConfiguration<a href="#securityfilterautoconfiguration" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>ç”¨äºè‡ªåŠ¨æ³¨å…¥Spring Securityçš„Filterè¿‡æ»¤å™¨ç±»ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Configuration</span><span style="color:#f92672">(</span>proxyBeanMethods <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@ConditionalOnWebApplication</span><span style="color:#f92672">(</span>type <span style="color:#f92672">=</span> Type<span style="color:#f92672">.</span><span style="color:#a6e22e">SERVLET</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@EnableConfigurationProperties</span><span style="color:#f92672">(</span>SecurityProperties<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@ConditionalOnClass</span><span style="color:#f92672">({</span> AbstractSecurityWebApplicationInitializer<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> SessionCreationPolicy<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span> <span style="color:#f92672">})</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@AutoConfigureAfter</span><span style="color:#f92672">(</span>SecurityAutoConfiguration<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SecurityFilterAutoConfiguration</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// springSecurityFilterChain
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> 
</span></span><span style="display:flex;"><span>        String DEFAULT_FILTER_NAME <span style="color:#f92672">=</span> AbstractSecurityWebApplicationInitializer<span style="color:#f92672">.</span><span style="color:#a6e22e">DEFAULT_FILTER_NAME</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * å½“IOCå®¹å™¨ä¸­å­˜åœ¨beanNameä¸ºspringSecurityFilterChainæ—¶æ³¨å…¥DelegatingFilterProxyRegistrationBean
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">@Bean</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">@ConditionalOnBean</span><span style="color:#f92672">(</span>name <span style="color:#f92672">=</span> DEFAULT_FILTER_NAME<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">public</span> DelegatingFilterProxyRegistrationBean <span style="color:#a6e22e">securityFilterChainRegistration</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>			SecurityProperties securityProperties<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		DelegatingFilterProxyRegistrationBean registration <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> DelegatingFilterProxyRegistrationBean<span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>				DEFAULT_FILTER_NAME<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		registration<span style="color:#f92672">.</span><span style="color:#a6e22e">setOrder</span><span style="color:#f92672">(</span>securityProperties<span style="color:#f92672">.</span><span style="color:#a6e22e">getFilter</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getOrder</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		registration<span style="color:#f92672">.</span><span style="color:#a6e22e">setDispatcherTypes</span><span style="color:#f92672">(</span>getDispatcherTypes<span style="color:#f92672">(</span>securityProperties<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> registration<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// çœç•¥
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<ol>
<li>ä¸ä¸Šæ–‡ä¸­çš„<code>SecurityAutoConfiguration</code>åˆ†å¼€é…ç½®ï¼Œæ˜¯ä¸ºäº†å½“å­˜åœ¨ç”¨æˆ·æŒ‡å®šçš„<code>WebSecurityConfiguration</code>æ—¶ä»èƒ½æŒ‡å®šOrderé¡ºåºã€‚</li>
<li>åœ¨<code>SecurityFilterAutoConfiguration</code>å®Œæˆåè°ƒç”¨<code>SecurityAutoConfiguration</code>é…ç½®ç±»ã€‚</li>
<li>IOCå®¹å™¨ä¸­å­˜åœ¨BeanNameä¸º<code>springSecurityFilterChain</code>æ—¶æ³¨å…¥<code>DelegatingFilterProxyRegistrationBean</code>ï¼Œåœ¨ä¸Šæ–‡çš„<code>@EnableWebSecurity</code>ä¸­çš„<code>WebSecurityConfiguration</code>å¼•å…¥ã€‚</li>
</ol>
</blockquote>
<h4 id="delegatingfilterproxyregistrationbean">DelegatingFilterProxyRegistrationBean<a href="#delegatingfilterproxyregistrationbean" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DelegatingFilterProxyRegistrationBean</span> <span style="color:#66d9ef">extends</span> AbstractFilterRegistrationBean<span style="color:#f92672">&lt;</span>DelegatingFilterProxy<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">implements</span> ApplicationContextAware <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">public</span> DelegatingFilterProxy <span style="color:#a6e22e">getFilter</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> DelegatingFilterProxy<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">targetBeanName</span><span style="color:#f92672">,</span> getWebApplicationContext<span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">initFilterBean</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> ServletException <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// Don&#39;t initialize filter bean on init()
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">};</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// çœç•¥
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<ol>
<li>é€šè¿‡<code>å§”æ´¾æ¨¡å¼</code>å°†åˆ›å»º<code>ServletRegistrationBean</code>çš„å§”æ´¾ç±»<code>DelegatingFilterProxyRegistrationBean</code>ç”¨äºå¤„ç†urlå’Œservletçš„æ˜ å°„å…³ç³»ã€‚</li>
<li>å°†ä»»åŠ¡å§”æ´¾ç»™åä¸º<code>springSecurityFilterChain</code>çš„servletä»£ç†ç±»<code>DelegatingFilterProxy</code>æ¥å¤„ç†sevletè¯·æ±‚ã€‚</li>
<li>å®é™…å¤„ç†servletçš„æ˜¯ä»£ç†ç±»<code>DelegatingFilterProxy</code>çš„å®ç°ç±»<code>FilterChainProxy</code>ã€‚</li>
</ol>
</blockquote>
<hr>
<h2 id="è‡ªå®šä¹‰é…ç½®">è‡ªå®šä¹‰é…ç½®<a href="#è‡ªå®šä¹‰é…ç½®" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>ä¸»è¦é€šè¿‡ç»§æ‰¿<code>WebSecurityConfigurerAdapter</code>æŠ½è±¡ç±»æ¥å®ç°çš„ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">WebSecurityConfig</span> <span style="color:#66d9ef">extends</span> WebSecurityConfigurerAdapter <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">configure</span><span style="color:#f92672">(</span>HttpSecurity http<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// ç”¨äºæ„å»ºå®‰å…¨è¿‡æ»¤å™¨é“¾
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">configure</span><span style="color:#f92672">(</span>AuthenticationManagerBuilder auth<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// å¤„ç†ç”¨æˆ·è®¤è¯ç›¸å…³ï¼ˆUserDetailsï¼‰
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">configure</span><span style="color:#f92672">(</span>WebSecurity web<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// é…ç½®webSecurityï¼ˆåŸºäºDelegatingFilterProxyç®¡ç†çš„springSecurityFilterChainå®ç°ï¼‰
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h3 id="httpsecurityå…¥é—¨">HttpSecurityå…¥é—¨<a href="#httpsecurityå…¥é—¨" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Configuration</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CommonSecurityConfig</span> <span style="color:#66d9ef">extends</span> WebSecurityConfigurerAdapter <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Resource</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> UserManager userManager<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">configure</span><span style="color:#f92672">(</span>AuthenticationManagerBuilder auth<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        auth<span style="color:#f92672">.</span><span style="color:#a6e22e">userDetailsService</span><span style="color:#f92672">(</span>userManager<span style="color:#f92672">).</span><span style="color:#a6e22e">passwordEncoder</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> BCryptPasswordEncoder<span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">configure</span><span style="color:#f92672">(</span>WebSecurity web<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">super</span><span style="color:#f92672">.</span><span style="color:#a6e22e">configure</span><span style="color:#f92672">(</span>web<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String LOGIN_PROCESS_URL <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/process&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">configure</span><span style="color:#f92672">(</span>HttpSecurity http<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        http<span style="color:#f92672">.</span><span style="color:#a6e22e">csrf</span><span style="color:#f92672">().</span><span style="color:#a6e22e">disable</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">.</span><span style="color:#a6e22e">cors</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">.</span><span style="color:#a6e22e">and</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">.</span><span style="color:#a6e22e">authorizeRequests</span><span style="color:#f92672">().</span><span style="color:#a6e22e">anyRequest</span><span style="color:#f92672">().</span><span style="color:#a6e22e">authenticated</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">.</span><span style="color:#a6e22e">and</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">.</span><span style="color:#a6e22e">addFilterBefore</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> PreLoginFilter<span style="color:#f92672">(</span>LOGIN_PROCESS_URL<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">),</span> UsernamePasswordAuthenticationFilter<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">)</span> <span style="color:#75715e">// æ³¨å…¥filterï¼Œè¿›è¡Œç™»å½•æå‰æ ¡éªŒ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#f92672">.</span><span style="color:#a6e22e">formLogin</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">.</span><span style="color:#a6e22e">loginProcessingUrl</span><span style="color:#f92672">(</span>LOGIN_PROCESS_URL<span style="color:#f92672">)</span> <span style="color:#75715e">// å®é™…å‘åå°æäº¤è¯·æ±‚çš„è·¯å¾„ï¼Œæ­¤åä¼šæ‰§è¡ŒUsernamePasswordAuthenticationFilterç±»
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#75715e">// .defaultSuccessUrl(&#34;http://www.baidu.com&#34;, false) // loginé¡µé¢ç™»å½•æˆåŠŸåé‡å®šå‘åœ°å€ï¼ˆå¦‚æœæ˜¯successfulForwardUrlåˆ™æ˜¯è½¬å‘ï¼‰
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#f92672">.</span><span style="color:#a6e22e">successForwardUrl</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/login/success&#34;</span><span style="color:#f92672">)</span>  <span style="color:#75715e">// ç™»å½•æˆåŠŸåè½¬å‘çš„è·¯å¾„ï¼ˆå¯ä»¥æ˜¯æ¥å£ï¼‰
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#f92672">.</span><span style="color:#a6e22e">failureForwardUrl</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/login/failure&#34;</span><span style="color:#f92672">);</span>  <span style="color:#75715e">// ç™»å½•å¤±è´¥çš„æ—¶å€™ä¼šè½¬å‘åˆ°æ­¤è·¯å¾„
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<ol>
<li>ä¸€èˆ¬é€šè¿‡é…ç½®HttpSecurityæ¥å®ç°è‡ªå®šä¹‰ç™»å½•æˆ–é‰´æƒçš„é…ç½®ã€‚</li>
<li>æ³¨å…¥è‡ªå®šä¹‰Filterçš„æ ¸å¿ƒåŸç†åœ¨äºç™»å½•é‰´æƒç›¸å…³çš„é€»è¾‘ç”±<code>UsernamePasswordAuthenticationFilter</code>å¤„ç†ã€‚</li>
</ol>
</blockquote>
<hr>
<h2 id="authenticationmanageræºç è§£æ">AuthenticationManageræºç è§£æ<a href="#authenticationmanageræºç è§£æ" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<h3 id="usernamepasswordauthenticationfilter">UsernamePasswordAuthenticationFilter<a href="#usernamepasswordauthenticationfilter" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>ç»“åˆå‰æ–‡æ‰€ç¤ºï¼Œç”¨æˆ·çš„è´¦æˆ·å’Œå¯†ç è®¤è¯æ˜¯ç”±<code>UsernamePasswordAuthenticationFilter</code>å¤„ç†ï¼Œæ‰€ä»¥æˆ‘ä»¬ä»¥æ­¤åˆ‡å…¥ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UsernamePasswordAuthenticationFilter</span> <span style="color:#66d9ef">extends</span>
</span></span><span style="display:flex;"><span>		AbstractAuthenticationProcessingFilter <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">public</span> <span style="color:#a6e22e">UsernamePasswordAuthenticationFilter</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// å¤„ç†/loginçš„POSTè¯·æ±‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">super</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> AntPathRequestMatcher<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/login&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;POST&#34;</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// æ‰§è¡Œå®é™…çš„è®¤è¯æµç¨‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> Authentication <span style="color:#a6e22e">attemptAuthentication</span><span style="color:#f92672">(</span>HttpServletRequest request<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>			HttpServletResponse response<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> AuthenticationException <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// åªæ”¯æŒPOSTè¯·æ±‚ï¼Œå¯¹å…¶è¿›è¡Œæ ¡éªŒ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>postOnly <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>request<span style="color:#f92672">.</span><span style="color:#a6e22e">getMethod</span><span style="color:#f92672">().</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;POST&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> AuthenticationServiceException<span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>					<span style="color:#e6db74">&#34;Authentication method not supported: &#34;</span> <span style="color:#f92672">+</span> request<span style="color:#f92672">.</span><span style="color:#a6e22e">getMethod</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// é€šè¿‡request.getParameter(&#34;username&#34;);è·å–ç”¨æˆ·å
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		String username <span style="color:#f92672">=</span> obtainUsername<span style="color:#f92672">(</span>request<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// é€šè¿‡request.getParameter(&#34;password&#34;);è·å–ç”¨æˆ·å¯†ç 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		String password <span style="color:#f92672">=</span> obtainPassword<span style="color:#f92672">(</span>request<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// åˆ¤ç©ºåŠå»é‡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>username <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			username <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>password <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			password <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		username <span style="color:#f92672">=</span> username<span style="color:#f92672">.</span><span style="color:#a6e22e">trim</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// å°†ç”¨æˆ·å¯†ç å°è£…åˆ°UsernamePasswordAuthenticationTokenä¸­
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		UsernamePasswordAuthenticationToken authRequest <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> 		
</span></span><span style="display:flex;"><span>            	UsernamePasswordAuthenticationToken<span style="color:#f92672">(</span>username<span style="color:#f92672">,</span> password<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// å…è®¸å­ç±»è®¾ç½®å…¶ä»–å‚æ•°åˆ°è®¤è¯è¯·æ±‚ä¸­å»
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		setDetails<span style="color:#f92672">(</span>request<span style="color:#f92672">,</span> authRequest<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// è°ƒç”¨AuthenticationManagerå»å¤„ç†è®¤è¯è¯·æ±‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getAuthenticationManager</span><span style="color:#f92672">().</span><span style="color:#a6e22e">authenticate</span><span style="color:#f92672">(</span>authRequest<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<p>è¯¥ç±»çš„ä¸»è¦ä½œç”¨å°±æ˜¯æ‹¦æˆªrequestè¯·æ±‚å¹¶è·å–è´¦å·å’Œå¯†ç ï¼Œå†å°†å…¶å°è£…åˆ°<code>UsernamePasswordAuthenticationToken</code>ä¸­ã€‚å†äº¤ç»™<code>AuthenticationManager</code>å»è®¤è¯ã€‚</p>
</blockquote>
<h3 id="abstractauthenticationprocessingfilter">AbstractAuthenticationProcessingFilter<a href="#abstractauthenticationprocessingfilter" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AbstractAuthenticationProcessingFilter</span> <span style="color:#66d9ef">extends</span> GenericFilterBean
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">implements</span> ApplicationEventPublisherAware<span style="color:#f92672">,</span> MessageSourceAware <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> AuthenticationSuccessHandler 
</span></span><span style="display:flex;"><span>        successHandler <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> SavedRequestAwareAuthenticationSuccessHandler<span style="color:#f92672">();</span> <span style="color:#75715e">// successå¤„ç†å™¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">private</span> AuthenticationFailureHandler 
</span></span><span style="display:flex;"><span>        failureHandler <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> SimpleUrlAuthenticationFailureHandler<span style="color:#f92672">();</span> <span style="color:#75715e">// failureå¤„ç†å™¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// è¿‡æ»¤å™¨çš„æ ¸å¿ƒæ–¹æ³•
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">doFilter</span><span style="color:#f92672">(</span>ServletRequest req<span style="color:#f92672">,</span> ServletResponse res<span style="color:#f92672">,</span> FilterChain chain<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">throws</span> IOException<span style="color:#f92672">,</span> ServletException <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		HttpServletRequest request <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>HttpServletRequest<span style="color:#f92672">)</span> req<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>		HttpServletResponse response <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>HttpServletResponse<span style="color:#f92672">)</span> res<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// åˆ¤æ–­æ˜¯å¦éœ€è¦é‰´æƒï¼ˆæœ¬è´¨å°±æ˜¯åˆ¤æ–­è·¯å¾„æ˜¯å¦åŒ¹é…ï¼‰ï¼Œç”±å­ç±»æ„é€ ä¸­å®ç°çš„ï¼ˆPOST /loginè¯·æ±‚ï¼‰
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>requiresAuthentication<span style="color:#f92672">(</span>request<span style="color:#f92672">,</span> response<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			chain<span style="color:#f92672">.</span><span style="color:#a6e22e">doFilter</span><span style="color:#f92672">(</span>request<span style="color:#f92672">,</span> response<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>logger<span style="color:#f92672">.</span><span style="color:#a6e22e">isDebugEnabled</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			logger<span style="color:#f92672">.</span><span style="color:#a6e22e">debug</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Request is to process authentication&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// é‰´æƒæ ¡éªŒï¼Œå®é™…ä¸Šè°ƒç”¨äº†å­ç±»çš„attemptAuthenticationå®ç°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		Authentication authResult<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// å¦‚æœè¿”å›ä¸ºç©ºè¯´æ˜å­ç±»éªŒè¯æ²¡æœ‰å®Œæˆï¼Œç«‹å³è¿”å›
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			authResult <span style="color:#f92672">=</span> attemptAuthentication<span style="color:#f92672">(</span>request<span style="color:#f92672">,</span> response<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>authResult <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// å¤„ç†sessionç­–ç•¥ï¼Œæ­¤å¤„é»˜è®¤æ˜¯ç©ºå®ç°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			sessionStrategy<span style="color:#f92672">.</span><span style="color:#a6e22e">onAuthentication</span><span style="color:#f92672">(</span>authResult<span style="color:#f92672">,</span> request<span style="color:#f92672">,</span> response<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>InternalAuthenticationServiceException failed<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			logger<span style="color:#f92672">.</span><span style="color:#a6e22e">error</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>					<span style="color:#e6db74">&#34;An internal error occurred while trying to authenticate the user.&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>					failed<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// å¤±è´¥å¤„ç†å™¨å¤„ç†
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			unsuccessfulAuthentication<span style="color:#f92672">(</span>request<span style="color:#f92672">,</span> response<span style="color:#f92672">,</span> failed<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>AuthenticationException failed<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// ä¸ä¸ŠåŒç†
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			unsuccessfulAuthentication<span style="color:#f92672">(</span>request<span style="color:#f92672">,</span> response<span style="color:#f92672">,</span> failed<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// æ˜¯å¦è·³è¿‡å…¶ä»–è¿‡æ»¤å™¨ï¼Œé»˜è®¤æ˜¯è·³è¿‡çš„
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>continueChainBeforeSuccessfulAuthentication<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			chain<span style="color:#f92672">.</span><span style="color:#a6e22e">doFilter</span><span style="color:#f92672">(</span>request<span style="color:#f92672">,</span> response<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// æˆåŠŸåçš„å¤„ç†å™¨å¤„ç†
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		successfulAuthentication<span style="color:#f92672">(</span>request<span style="color:#f92672">,</span> response<span style="color:#f92672">,</span> chain<span style="color:#f92672">,</span> authResult<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<ol>
<li>æ˜¯<code>UsernamePasswordAuthenticationFilter</code>çš„çˆ¶ç±»ï¼Œé»˜è®¤å®ç°äº†<code>Filter</code>è¿‡æ»¤å™¨çš„æ ¸å¿ƒæ–¹æ³•<code>doFilter</code>ã€‚</li>
<li>é¦–å…ˆæ˜¯å¯¹è¯·æ±‚è·¯å¾„çš„åˆ¤æ–­ï¼Œå¿…é¡»æ˜¯<code>POST /login</code>è¯·æ±‚æ‰ä¼šæ‹¦æˆªã€‚å¦åˆ™ç›´æ¥äº¤ç”±ä¸‹ä¸ªè¿‡æ»¤å™¨å¤„ç†ã€‚</li>
<li>è°ƒç”¨å­ç±»çš„<code>attemptAuthentication</code>è¿›è¡Œè®¤è¯æ“ä½œï¼Œå¹¶è®¾ç½®sessionç›¸å…³çš„ç­–ç•¥ï¼ˆé»˜è®¤ç©ºå®ç°ï¼‰ã€‚</li>
<li>å¦‚æœå‘ç”Ÿäº†å¼‚å¸¸æˆ–æ ¡éªŒå¤±è´¥ï¼Œè°ƒç”¨å¤±è´¥å¤„ç†å™¨ã€‚ç»§è€Œåˆ¤æ–­æ˜¯å¦éœ€è¦è·³è¿‡åé¢çš„è¿‡æ»¤å™¨ï¼Œæœ€ç»ˆæ‰§è¡ŒæˆåŠŸå¤„ç†å™¨ã€‚</li>
</ol>
</blockquote>
<h3 id="authenticationmanageråˆå§‹åŒ–æµç¨‹">AuthenticationManageråˆå§‹åŒ–æµç¨‹ğŸ”’<a href="#authenticationmanageråˆå§‹åŒ–æµç¨‹" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">AuthenticationManager</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    Authentication <span style="color:#a6e22e">authenticate</span><span style="color:#f92672">(</span>Authentication authentication<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">throws</span> AuthenticationException<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<p>è®¤è¯ç®¡ç†å™¨é¡¶çº§æ¥å£ï¼Œä¸Šæ–‡ä¸­å°è£…çš„<code>UsernamePasswordAuthenticationToken</code>å°±ä¼šäº¤äºˆ<code>AuthenticationManager</code>çš„å®ç°ç±»æ¥å¤„ç†ã€‚å¦‚æœéªŒè¯æˆåŠŸå°±è¿”å›<code>Authentication</code>å¯¹è±¡ï¼Œå¦åˆ™å°±æŠ›å‡ºå¼‚å¸¸ã€‚</p>
</blockquote>
<h4 id="1-securityautoconfiguration">1. SecurityAutoConfiguration<a href="#1-securityautoconfiguration" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<blockquote>
<p>è¯·æ³¨æ„ï¼šä¸‹è¿°çš„æµç¨‹å±•ç¤ºçœç•¥äº†å¤§éƒ¨åˆ†ä¸<code>AuthenticationManager</code>åˆå§‹åŒ–æ— å…³çš„ä»£ç ï¼ï¼</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// // é€šè¿‡è‡ªåŠ¨è£…é…æ³¨å…¥äº†`SecurityAutoConfiguration`ç±»ï¼Œç»§è€Œæ³¨å…¥äº†`WebSecurityEnablerConfiguration`
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">@Import</span><span style="color:#f92672">({</span>WebSecurityEnablerConfiguration<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">})</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SecurityAutoConfiguration</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@EnableWebSecurity</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">WebSecurityEnablerConfiguration</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Import</span><span style="color:#f92672">({</span> WebSecurityConfiguration<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">})</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@EnableGlobalAuthentication</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#a6e22e">@interface</span> EnableWebSecurity <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<ol>
<li>å› ä¸ºå®¹å™¨ä¸­å­˜åœ¨<code>WebSecurityConfigurerAdapter</code>ï¼Œæ‰€ä»¥å¯ç”¨äº†<code>@EnableWebSecurity</code>æ³¨è§£ã€‚</li>
<li><code>@EnableWebSecurity</code>æ³¨è§£çš„æ ¸å¿ƒåœ¨äº<code>@EnableGlobalAuthentication</code>å’Œ<code>WebSecurityConfiguration</code>ç±»ã€‚</li>
</ol>
</blockquote>
<h4 id="2-websecurityconfiguration">2. WebSecurityConfiguration<a href="#2-websecurityconfiguration" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Configuration</span><span style="color:#f92672">(</span>proxyBeanMethods <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">WebSecurityConfiguration</span> <span style="color:#66d9ef">implements</span> ImportAware<span style="color:#f92672">,</span> BeanClassLoaderAware <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> WebSecurity webSecurity<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> List<span style="color:#f92672">&lt;</span>SecurityConfigurer<span style="color:#f92672">&lt;</span>Filter<span style="color:#f92672">,</span> WebSecurity<span style="color:#f92672">&gt;&gt;</span> webSecurityConfigurers<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// æ­¤å¤„å·²ç»æ³¨å…¥äº†AutowireBeanFactoryObjectPostProcessor
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">@Autowired</span><span style="color:#f92672">(</span>required <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> ObjectPostProcessor<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> objectObjectPostProcessor<span style="color:#f92672">;</span> 
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Autowired</span><span style="color:#f92672">(</span>required <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setFilterChainProxySecurityConfigurer</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>        ObjectPostProcessor<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> objectPostProcessor<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">@Value</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;#{@autowiredWebSecurityConfigurersIgnoreParents.getWebSecurityConfigurers()}&#34;</span><span style="color:#f92672">)</span> 			List<span style="color:#f92672">&lt;</span>SecurityConfigurer<span style="color:#f92672">&lt;</span>Filter<span style="color:#f92672">,</span> WebSecurity<span style="color:#f92672">&gt;&gt;</span> webSecurityConfigurers<span style="color:#f92672">){</span> 
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        webSecurity <span style="color:#f92672">=</span> objectPostProcessor
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">.</span><span style="color:#a6e22e">postProcess</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> WebSecurity<span style="color:#f92672">(</span>objectPostProcessor<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>                   <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>SecurityConfigurer<span style="color:#f92672">&lt;</span>Filter<span style="color:#f92672">,</span> WebSecurity<span style="color:#f92672">&gt;</span> webSecurityConfigurer <span style="color:#f92672">:</span> webSecurityConfigurers<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			webSecurity<span style="color:#f92672">.</span><span style="color:#a6e22e">apply</span><span style="color:#f92672">(</span>webSecurityConfigurer<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">webSecurityConfigurers</span> <span style="color:#f92672">=</span> webSecurityConfigurers<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// åˆ›å»ºbeanNameä¸º&#39;springSecurityFilterChain&#39;çš„è¿‡æ»¤å™¨é“¾å¹¶å¾—åˆ°æ•´åˆåçš„Filter
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">@Bean</span><span style="color:#f92672">(</span>name <span style="color:#f92672">=</span> AbstractSecurityWebApplicationInitializer<span style="color:#f92672">.</span><span style="color:#a6e22e">DEFAULT_FILTER_NAME</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">public</span> Filter <span style="color:#a6e22e">springSecurityFilterChain</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// webSecurityConfigurers æ˜¯ç”¨äºåˆ›å»ºwebé…ç½®çš„å¯¹è±¡é›†åˆ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">boolean</span> hasConfigurers <span style="color:#f92672">=</span> webSecurityConfigurers <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>webSecurityConfigurers<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>hasConfigurers<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// è‹¥æ²¡æœ‰SecurityConfigurerçš„å®ç°ç±»ï¼ˆåªè¦ç»§æ‰¿äº†WebSecurityConfigurerAdapterå°±ä¸ä¼šä¸ºç©º)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#75715e">// åˆ™åˆ›å»ºé»˜è®¤çš„WebSecurityConfigurerAdapterç±»
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			WebSecurityConfigurerAdapter adapter <span style="color:#f92672">=</span> objectObjectPostProcessor
</span></span><span style="display:flex;"><span>					<span style="color:#f92672">.</span><span style="color:#a6e22e">postProcess</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> WebSecurityConfigurerAdapter<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#f92672">});</span>
</span></span><span style="display:flex;"><span>			webSecurity<span style="color:#f92672">.</span><span style="color:#a6e22e">apply</span><span style="color:#f92672">(</span>adapter<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// å°†WebSecurityå¯¹è±¡è½¬æ¢ä¸ºFilterï¼ˆæŸ¥çœ‹ä¸‹æ–‡ï¼‰
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">return</span> webSecurity<span style="color:#f92672">.</span><span style="color:#a6e22e">build</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// é€šè¿‡SPELè°ƒç”¨ï¼Œç›®çš„æ˜¯ä¸ºäº†æŸ¥æ‰¾å®¹å™¨ä¸­æ‰€æœ‰ç±»å‹ä¸ºWebSecurityConfigurerçš„beanæ•´åˆæˆé›†åˆ                   
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AutowiredWebSecurityConfigurersIgnoreParents</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> List<span style="color:#f92672">&lt;</span>SecurityConfigurer<span style="color:#f92672">&lt;</span>Filter<span style="color:#f92672">,</span> WebSecurity<span style="color:#f92672">&gt;&gt;</span> <span style="color:#a6e22e">getWebSecurityConfigurers</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		List<span style="color:#f92672">&lt;</span>SecurityConfigurer<span style="color:#f92672">&lt;</span>Filter<span style="color:#f92672">,</span> WebSecurity<span style="color:#f92672">&gt;&gt;</span> webSecurityConfigurers 
</span></span><span style="display:flex;"><span>            												<span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>		Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> WebSecurityConfigurer<span style="color:#f92672">&gt;</span> beansOfType <span style="color:#f92672">=</span> beanFactory
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">.</span><span style="color:#a6e22e">getBeansOfType</span><span style="color:#f92672">(</span>WebSecurityConfigurer<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Entry<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> WebSecurityConfigurer<span style="color:#f92672">&gt;</span> entry <span style="color:#f92672">:</span> beansOfType<span style="color:#f92672">.</span><span style="color:#a6e22e">entrySet</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			webSecurityConfigurers<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>entry<span style="color:#f92672">.</span><span style="color:#a6e22e">getValue</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> webSecurityConfigurers<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<ol>
<li>åŸºäº<code>WebSecurityConfiguration</code>æ¥åˆ›å»º<code>WebSecurity</code>å¯¹è±¡ã€‚å¹¶è°ƒç”¨<code>build()</code>åˆå§‹åŒ–ç›¸å…³ç±»ã€‚</li>
<li><code>setFilterChainProxySecurityConfigurer</code>ä¼šå°†å®¹å™¨å†…çš„æ‰€æœ‰<code>WebSecurityConfigurer</code>ç±»å‹çš„beanæ·»åŠ åˆ°é›†åˆä¸­ä½œä¸ºå‚æ•°æ³¨å…¥ã€‚</li>
<li><code>WebSecurity</code>å¤„ç†<code>Filterè¿‡æ»¤å™¨é“¾</code>ç›¸å…³ï¼Œ<code>HttpSecurity</code>å¤„ç†httpè¯·æ±‚ç›¸å…³ï¼Œéƒ½å®ç°è‡ª<code>SecurityBuilder</code>ã€‚</li>
<li>å¦‚æœå®¹å™¨ä¸­<code>SecurityConfigurer&lt;Filter, WebSecurity&gt;</code>çš„å­ç±»ã€å®ç°ç±»é›†åˆä¸ºç©ºï¼Œé‚£ä¹ˆå°±ä¼šåˆ›å»ºé»˜è®¤çš„<code>WebSecurityConfigurerAdapter</code>å¯¹è±¡å¹¶åŠ å…¥åˆ°å®¹å™¨ä¸­ã€‚</li>
</ol>
</blockquote>
<h5 id="21-abstractsecuritybuilderbuild">2.1 AbstractSecurityBuilder.build()ğŸ”’<a href="#21-abstractsecuritybuilderbuild" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AbstractSecurityBuilder</span><span style="color:#f92672">&lt;</span>O<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">implements</span> SecurityBuilder<span style="color:#f92672">&lt;</span>O<span style="color:#f92672">&gt;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> AtomicBoolean building <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> AtomicBoolean<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">private</span> O object<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> O <span style="color:#a6e22e">build</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// CASä¿è¯å¤šçº¿ç¨‹ä¸‹åªèƒ½åˆ›å»ºä¸€æ¬¡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">building</span><span style="color:#f92672">.</span><span style="color:#a6e22e">compareAndSet</span><span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">object</span> <span style="color:#f92672">=</span> doBuild<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">object</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> AlreadyBuiltException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;This object has already been built&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// æ¨¡æ¿æ–¹æ³•,ç”±å­ç±»å…·ä½“å®ç°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">abstract</span> O <span style="color:#a6e22e">doBuild</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> Exception<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AbstractConfiguredSecurityBuilder</span><span style="color:#f92672">&lt;</span>O<span style="color:#f92672">,</span> B <span style="color:#66d9ef">extends</span> SecurityBuilder<span style="color:#f92672">&lt;</span>O<span style="color:#f92672">&gt;&gt;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">extends</span> AbstractSecurityBuilder<span style="color:#f92672">&lt;</span>O<span style="color:#f92672">&gt;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">final</span> O <span style="color:#a6e22e">doBuild</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// åŠ é”åˆå§‹åŒ–,BuildStateç”±äº”ç§çŠ¶æ€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span>configurers<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			buildState <span style="color:#f92672">=</span> BuildState<span style="color:#f92672">.</span><span style="color:#a6e22e">INITIALIZING</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>			beforeInit<span style="color:#f92672">();</span> <span style="color:#75715e">// é’©å­å‡½æ•°,åˆå§‹åŒ–å‰è°ƒç”¨,é»˜è®¤ç©ºå®ç°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			init<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>			buildState <span style="color:#f92672">=</span> BuildState<span style="color:#f92672">.</span><span style="color:#a6e22e">CONFIGURING</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>			beforeConfigure<span style="color:#f92672">();</span> <span style="color:#75715e">// é’©å­å‡½æ•°,é…ç½®å‰è°ƒç”¨,é»˜è®¤ç©ºå®ç°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			configure<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>			buildState <span style="color:#f92672">=</span> BuildState<span style="color:#f92672">.</span><span style="color:#a6e22e">BUILDING</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>			O result <span style="color:#f92672">=</span> performBuild<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>			buildState <span style="color:#f92672">=</span> BuildState<span style="color:#f92672">.</span><span style="color:#a6e22e">BUILT</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> result<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">init</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// è·å–æ‰€æœ‰securityçš„é…ç½®ç±»
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		Collection<span style="color:#f92672">&lt;</span>SecurityConfigurer<span style="color:#f92672">&lt;</span>O<span style="color:#f92672">,</span> B<span style="color:#f92672">&gt;&gt;</span> configurers <span style="color:#f92672">=</span> getConfigurers<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// ä¾æ¬¡åˆå§‹åŒ–ä»–ä»¬
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>SecurityConfigurer<span style="color:#f92672">&lt;</span>O<span style="color:#f92672">,</span> B<span style="color:#f92672">&gt;</span> configurer <span style="color:#f92672">:</span> configurers<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			configurer<span style="color:#f92672">.</span><span style="color:#a6e22e">init</span><span style="color:#f92672">((</span>B<span style="color:#f92672">)</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">);</span> <span style="color:#75715e">// æ­¤å¤„ä¼šè°ƒç”¨`WebSecurityConfigurerAdapter.init()æ–¹æ³•`
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// æ‰€æœ‰è°ƒç”¨applyçš„securityçš„é…ç½®ç±»åœ¨BuildStateä¸ºINITIALIZINGéƒ½ä¼šåŠ å…¥å…¶ä¸­ï¼Œåç»­è¡¥ä¸Šåˆå§‹åŒ–
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>SecurityConfigurer<span style="color:#f92672">&lt;</span>O<span style="color:#f92672">,</span> B<span style="color:#f92672">&gt;</span> configurer <span style="color:#f92672">:</span> configurersAddedInInitializing<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			configurer<span style="color:#f92672">.</span><span style="color:#a6e22e">init</span><span style="color:#f92672">((</span>B<span style="color:#f92672">)</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// æ¨¡æ¿æ–¹æ³•ï¼Œé»˜è®¤ç”±ä¸‰ä¸ªå®ç°ï¼šAuthenticationManagerBuilderã€HttpSecurityã€WebSecurity
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// åˆ†åˆ«å¯¹åº”å†…ç½®é‰´æƒç®¡ç†å™¨ï¼ŒDefaultSecurityFilterChainã€FilterChainProxyç›¸å…³é…ç½®
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">abstract</span> O <span style="color:#a6e22e">performBuild</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> Exception<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<ol>
<li>æ ¸å¿ƒåœ¨äºæ‰¾å‡ºæ‰€æœ‰éœ€è¦åˆå§‹åŒ–çš„<code>SecurityConfigurer</code>çš„å­ç±»å¯¹<code>SecurityBuilder</code>çš„å­ç±»è¿›è¡Œåˆå§‹åŒ–æ“ä½œã€‚</li>
<li>æ­¤å¤„ä¹Ÿä¼šè°ƒç”¨<code>WebSecurityConfigurerAdapter.init()</code>æ–¹æ³•ã€‚</li>
</ol>
</blockquote>
<h4 id="3--enableglobalauthentication">3.  @EnableGlobalAuthenticationğŸˆ<a href="#3--enableglobalauthentication" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * æ­¤æ³¨è§£å¯ç”¨äºé…ç½®`AuthenticationManagerBuilder`å®ä¾‹ï¼Œè€Œ`AuthenticationManagerBuilder`åˆ™
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * ç”¨äºåˆ›å»º`AuthenticationManager`å®ä¾‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Import</span><span style="color:#f92672">(</span>AuthenticationConfiguration<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">)</span> <span style="color:#75715e">// æ³¨å…¥AuthenticationConfigurationç±»
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#a6e22e">@interface</span> EnableGlobalAuthentication <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Import</span><span style="color:#f92672">(</span>ObjectPostProcessorConfiguration<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">)</span> <span style="color:#75715e">// æ³¨å…¥äº†ObjectPostProcessorConfigurationç±»
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AuthenticationConfiguration</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// åˆå§‹åŒ–UserDetailsServiceå®ç°ç±»ï¼Œè‹¥å­˜åœ¨å¤šä¸ªåˆ™ä¸ä¼šç»§ç»­åˆå§‹åŒ–
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// å¦‚æœå­˜åœ¨ä¸€ä¸ªï¼Œé‚£ä¹ˆä¼šåˆ›å»ºDaoAuthenticationProviderä½œä¸ºå±æ€§æ³¨å…¥åˆ°AuthenticationManagerBuilderä¸­
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">@Bean</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> InitializeUserDetailsBeanManagerConfigurer 		
</span></span><span style="display:flex;"><span>        	<span style="color:#a6e22e">initializeUserDetailsBeanManagerConfigurer</span><span style="color:#f92672">(</span>ApplicationContext context<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> InitializeUserDetailsBeanManagerConfigurer<span style="color:#f92672">(</span>context<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// å°è¯•ä»IOCå®¹å™¨ä¸­è·å–AuthenticationProviderå¯¹è±¡å¹¶è®¾ç½®åˆ°AuthenticationManagerBuilderä¸­ï¼Œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// å¦‚æœå­˜åœ¨å°±ä¸è®¾ç½®ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">@Bean</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> InitializeAuthenticationProviderBeanManagerConfigurer 
</span></span><span style="display:flex;"><span>        	<span style="color:#a6e22e">initializeAuthenticationProviderBeanManagerConfigurer</span><span style="color:#f92672">(</span>ApplicationContext context<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> InitializeAuthenticationProviderBeanManagerConfigurer<span style="color:#f92672">(</span>context<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<ol>
<li><code>@EnableGlobalAuthentication</code>çš„æ ¸å¿ƒå°±æ˜¯å¯¹<code>AuthenticationConfiguration</code>å’Œ<code>ObjectPostProcessorConfiguration</code>çš„æ³¨å…¥ã€‚</li>
<li><code>AuthenticationConfiguration</code>ä¸­çš„ä¸¤ä¸ªBeançš„æ³¨å…¥åªæœ‰æ²¡æœ‰å­ç±»å¤å†™<code>configure(AuthenticationManagerBuilder auth)</code>æ–¹æ³•æ—¶æ‰ä¼šåˆå§‹åŒ–(init()æ–¹æ³•)ã€‚</li>
</ol>
</blockquote>
<h5 id="31-objectpostprocessorconfiguration">3.1 ObjectPostProcessorConfiguration<a href="#31-objectpostprocessorconfiguration" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Configuration</span><span style="color:#f92672">(</span>proxyBeanMethods <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Role</span><span style="color:#f92672">(</span>BeanDefinition<span style="color:#f92672">.</span><span style="color:#a6e22e">ROLE_INFRASTRUCTURE</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ObjectPostProcessorConfiguration</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">@Bean</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">@Role</span><span style="color:#f92672">(</span>BeanDefinition<span style="color:#f92672">.</span><span style="color:#a6e22e">ROLE_INFRASTRUCTURE</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">public</span> ObjectPostProcessor<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">objectPostProcessor</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>			AutowireCapableBeanFactory beanFactory<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// åˆ›å»ºé»˜è®¤çš„ObjectPostProcessorå®ç°ç±»æ³¨å…¥åˆ°å®¹å™¨ä¸­
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> AutowireBeanFactoryObjectPostProcessor<span style="color:#f92672">(</span>beanFactory<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// é¡¶çº§æ¥å£
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">ObjectPostProcessor</span><span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">&lt;</span>O <span style="color:#66d9ef">extends</span> T<span style="color:#f92672">&gt;</span> O <span style="color:#a6e22e">postProcess</span><span style="color:#f92672">(</span>O object<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AutowireBeanFactoryObjectPostProcessor</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">implements</span> ObjectPostProcessor<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;,</span> DisposableBean<span style="color:#f92672">,</span> SmartInitializingSingleton <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// å°†beanæ³¨å…¥åˆ°å®¹å™¨çš„æ ¸å¿ƒæ–¹æ³•
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> <span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> T <span style="color:#a6e22e">postProcess</span><span style="color:#f92672">(</span>T object<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>object <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		T result <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// åˆå§‹åŒ–bean
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			result <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>T<span style="color:#f92672">)</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">autowireBeanFactory</span>
</span></span><span style="display:flex;"><span>                			<span style="color:#f92672">.</span><span style="color:#a6e22e">initializeBean</span><span style="color:#f92672">(</span>object<span style="color:#f92672">,</span>object<span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>RuntimeException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// çœç•¥
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// è‡ªåŠ¨æ³¨å…¥
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">autowireBeanFactory</span><span style="color:#f92672">.</span><span style="color:#a6e22e">autowireBean</span><span style="color:#f92672">(</span>object<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// çœç•¥
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">return</span> result<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<ol>
<li>æ­¤ç±»æ˜¯é€šè¿‡<code>AuthenticationConfiguration</code>æ³¨å…¥çš„ï¼Œæ­¤å¤„æ¶‰åŠä¸€ä¸ªæ¦‚å¿µï¼š<code>ObjectPostProcessor</code>ã€‚</li>
<li><code>ObjectPostProcessor</code>å¯ä»¥é€šè¿‡<code>new</code>åˆ›å»ºçš„å¯¹è±¡äº¤ç”±<code>IOCå®¹å™¨</code>è¿›è¡Œç®¡ç†ã€‚</li>
<li><code>ObjectPostProcessorConfiguration</code>é»˜è®¤æ³¨å…¥äº†<code>ObjectPostProcessor</code>çš„å®ç°ç±»<code>AutowireBeanFactoryObjectPostProcessor</code>åˆ°å®¹å™¨ä¸­ã€‚æ ¸å¿ƒå°±æ˜¯<code>åˆå§‹åŒ–Bean</code>å¹¶è‡ªåŠ¨æ³¨å…¥ã€‚</li>
<li>ä½¿ç”¨<code>ObjectPostProcessor</code>çš„ç›®çš„æ˜¯ä¸ºäº†è§£å†³<code>å› ä¸ºä¾¿äºç®¡ç†å¤§é‡å¯¹è±¡ï¼Œæ²¡æœ‰æš´éœ²è¿™äº›å¯¹è±¡çš„å±æ€§ï¼Œä½†æ˜¯éœ€è¦æ‰‹åŠ¨æ³¨å†Œbeanåˆ°å®¹å™¨ä¸­</code>çš„é—®é¢˜ï¼Œæ³¨å…¥åˆ°å®¹å™¨ä¸­çš„beanæˆ‘ä»¬å¯ä»¥å¯¹å…¶è¿›è¡Œç®¡ç†ã€ä¿®æ”¹æˆ–å¢å¼ºã€‚</li>
</ol>
</blockquote>
<h5 id="32-authenticationconfiguration">3.2 AuthenticationConfigurationğŸ”’<a href="#32-authenticationconfiguration" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Configuration</span><span style="color:#f92672">(</span>proxyBeanMethods <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Import</span><span style="color:#f92672">(</span>ObjectPostProcessorConfiguration<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">)</span> <span style="color:#75715e">// ä¸Šæ–‡å·²è§£æ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AuthenticationConfiguration</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// IOCå®¹å™¨ä¸Šä¸‹æ–‡ï¼ŒBeanFactoryçš„å®ç°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> ApplicationContext applicationContext<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// æ­¤å¤„æ¶‰åŠauthenticationManageræ³¨å…¥
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">private</span> AuthenticationManager authenticationManager<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// é»˜è®¤falseï¼Œç”¨äºåˆ¤æ–­authenticationManageræ˜¯å¦å·²ç»åˆå§‹åŒ–
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">boolean</span> authenticationManagerInitialized<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ç”¨äºæ³¨å…¥beanåˆ°å®¹å™¨ä¸­
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> ObjectPostProcessor<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> objectPostProcessor<span style="color:#f92672">;</span> 
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Bean</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">public</span> AuthenticationManagerBuilder <span style="color:#a6e22e">authenticationManagerBuilder</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>			ObjectPostProcessor<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> objectPostProcessor<span style="color:#f92672">,</span> ApplicationContext context<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// åˆ›å»ºé»˜è®¤çš„è§£ç å™¨ï¼ˆä¸Šæ–‡æœ‰è§£æè¿‡ï¼Œæ­¤å¤„ä½¿ç”¨äº†é™æ€å·¥å‚åˆ›å»ºè§£ç å™¨ï¼‰
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		LazyPasswordEncoder defaultPasswordEncoder <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> LazyPasswordEncoder<span style="color:#f92672">(</span>context<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		AuthenticationEventPublisher authenticationEventPublisher <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span>            				getBeanOrNull<span style="color:#f92672">(</span>context<span style="color:#f92672">,</span> AuthenticationEventPublisher<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// åˆ›å»ºé»˜è®¤çš„AuthenticationManagerBuilderï¼Œç”¨äºæ„å»ºAuthenticationManager
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// æ­¤å¤„ä¼ å…¥äº†ä¸Šæ–‡çš„é»˜è®¤è§£ç å™¨ï¼Œä»¥åŠAutowireBeanFactoryObjectPostProcessor
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		DefaultPasswordEncoderAuthenticationManagerBuilder result <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">new</span> DefaultPasswordEncoderAuthenticationManagerBuilder<span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>            								objectPostProcessor<span style="color:#f92672">,</span> defaultPasswordEncoder<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>authenticationEventPublisher <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			result<span style="color:#f92672">.</span><span style="color:#a6e22e">authenticationEventPublisher</span><span style="color:#f92672">(</span>authenticationEventPublisher<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> result<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// WebSecurityConfigurerAdapterä¸­é€šè¿‡AuthenticationConfigurationè°ƒç”¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> AuthenticationManager <span style="color:#a6e22e">getAuthenticationManager</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// å¦‚æœå·²ç»åˆå§‹åŒ–é‚£ä¹ˆç›´æ¥è¿”å›authenticationManager
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">authenticationManagerInitialized</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">authenticationManager</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// åˆ¤æ–­å®¹å™¨ä¸­æ˜¯å¦å­˜åœ¨AuthenticationManagerBuilderï¼ˆAuthenticationManagerçš„æ„é€ å™¨ï¼‰
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		AuthenticationManagerBuilder authBuilder <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">applicationContext</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getBean</span><span style="color:#f92672">(</span>AuthenticationManagerBuilder<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// CASä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œè°ƒç”¨å§”æ´¾æ¨¡å¼é€šè¿‡AuthenticationManagerBuilderåˆ›å»ºAuthenticationManager
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">buildingAuthenticationManager</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getAndSet</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> AuthenticationManagerDelegator<span style="color:#f92672">(</span>authBuilder<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// åˆ¤æ–­æ˜¯å¦å­˜åœ¨å…¨å±€é…ç½®ç±»ï¼ˆå³ç»§æ‰¿GlobalAuthenticationConfigurerAdapterçš„ç±»ï¼‰
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>GlobalAuthenticationConfigurerAdapter config <span style="color:#f92672">:</span> globalAuthConfigurers<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			authBuilder<span style="color:#f92672">.</span><span style="color:#a6e22e">apply</span><span style="color:#f92672">(</span>config<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// å§”æ´¾æ¨¡å¼åˆ†é…çš„ç±»ç”¨äºæ„å»ºAuthenticationManager
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		authenticationManager <span style="color:#f92672">=</span> authBuilder<span style="color:#f92672">.</span><span style="color:#a6e22e">build</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// è‹¥æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„å§”æ‰˜ç±»è¿›è¡Œé‰´æƒæ“ä½œï¼Œé‚£ä¹ˆå°±åˆ›å»º
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>authenticationManager <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// æ­¤å¤„çš„authenticationManagerè¿˜æ˜¯å¯ä»¥ä¸ºnullçš„
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			authenticationManager <span style="color:#f92672">=</span> getAuthenticationManagerBean<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// æ ‡è®°ä¸ºå·²åˆ›å»ºAuthenticationManagerå¹¶è¿”å›
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">authenticationManagerInitialized</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> authenticationManager<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AuthenticationManagerDelegator</span> <span style="color:#66d9ef">implements</span> AuthenticationManager <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">private</span> AuthenticationManagerBuilder delegateBuilder<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">private</span> AuthenticationManager delegate<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> Object delegateMonitor <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Object<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		AuthenticationManagerDelegator<span style="color:#f92672">(</span>AuthenticationManagerBuilder delegateBuilder<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			Assert<span style="color:#f92672">.</span><span style="color:#a6e22e">notNull</span><span style="color:#f92672">(</span>delegateBuilder<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;delegateBuilder cannot be null&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">delegateBuilder</span> <span style="color:#f92672">=</span> delegateBuilder<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">public</span> Authentication <span style="color:#a6e22e">authenticate</span><span style="color:#f92672">(</span>Authentication authentication<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">throws</span> AuthenticationException <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// å¦‚æœAuthenticationManagerä¸ä¸ºnullç›´æ¥è°ƒç”¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">delegate</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">delegate</span><span style="color:#f92672">.</span><span style="color:#a6e22e">authenticate</span><span style="color:#f92672">(</span>authentication<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// å¦åˆ™åŠ é”å¹¶åˆ›å»ºAuthenticationManager
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">delegateMonitor</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">delegate</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">delegate</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">delegateBuilder</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getObject</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">delegateBuilder</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// æœ€ç»ˆè°ƒç”¨AuthenticationManager.authenticate()
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">delegate</span><span style="color:#f92672">.</span><span style="color:#a6e22e">authenticate</span><span style="color:#f92672">(</span>authentication<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> AuthenticationManager <span style="color:#a6e22e">getAuthenticationManagerBean</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> lazyBean<span style="color:#f92672">(</span>AuthenticationManager<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// æ­¤æ­¥æ˜¯ç”¨äºåˆ›å»ºAuthenticationManagerå¹¶åŠ å…¥åˆ°å®¹å™¨ä¸­è¿›è¡Œç®¡ç†
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> <span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> T <span style="color:#a6e22e">lazyBean</span><span style="color:#f92672">(</span>Class<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> interfaceName<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// è·å–BeanFactoryçš„å•ä¾‹Bean
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		LazyInitTargetSource lazyTargetSource <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> LazyInitTargetSource<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// ä»å®¹å™¨ä¸­é€šè¿‡ç±»å‹è·å–beanå¯¹è±¡é›†åˆ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		String<span style="color:#f92672">[]</span> beanNamesForType <span style="color:#f92672">=</span> BeanFactoryUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">beanNamesForTypeIncludingAncestors</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>				applicationContext<span style="color:#f92672">,</span> interfaceName<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>beanNamesForType<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span> <span style="color:#f92672">==</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		String beanName<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>beanNamesForType<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span> <span style="color:#f92672">&gt;</span> 1<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// å­˜åœ¨ç›¸åŒç±»å‹çš„å¤šä¸ªbeanï¼Œåˆ¤æ–­æ˜¯å¦æœ‰@Primaryæ³¨è§£ä¿®é¥°çš„beanï¼Œè‹¥æœ‰åˆ™è¿”å›ï¼Œå¦åˆ™æŠ¥é”™
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			List<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> primaryBeanNames <span style="color:#f92672">=</span> getPrimaryBeanNames<span style="color:#f92672">(</span>beanNamesForType<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// å¦‚æœä¸å­˜åœ¨æˆ–æ•°é‡ä¸ç­‰äº1ï¼Œå°±æŠ›å‡ºå¼‚å¸¸
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			Assert<span style="color:#f92672">.</span><span style="color:#a6e22e">isTrue</span><span style="color:#f92672">(</span>primaryBeanNames<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">!=</span> 0<span style="color:#f92672">,</span> <span style="color:#f92672">()</span> <span style="color:#f92672">-&gt;</span> <span style="color:#e6db74">&#34;Found &#34;</span> <span style="color:#f92672">+</span> beanNamesForType<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span>
</span></span><span style="display:flex;"><span>					<span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; beans for type &#34;</span> <span style="color:#f92672">+</span> interfaceName <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;, but none marked as primary&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>			Assert<span style="color:#f92672">.</span><span style="color:#a6e22e">isTrue</span><span style="color:#f92672">(</span>primaryBeanNames<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">==</span> 1<span style="color:#f92672">,</span> <span style="color:#f92672">()</span> <span style="color:#f92672">-&gt;</span> <span style="color:#e6db74">&#34;Found &#34;</span> <span style="color:#f92672">+</span> primaryBeanNames<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>					<span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; beans for type &#34;</span> <span style="color:#f92672">+</span> interfaceName <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; marked as primary&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>			beanName <span style="color:#f92672">=</span> primaryBeanNames<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>0<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// å¦åˆ™ç›´æ¥è¿”å›ç¬¬ä¸€ä¸ª
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			beanName <span style="color:#f92672">=</span> beanNamesForType<span style="color:#f92672">[</span>0<span style="color:#f92672">];</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// è®¾ç½®beanFactoryç›¸å…³å‚æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		lazyTargetSource<span style="color:#f92672">.</span><span style="color:#a6e22e">setTargetBeanName</span><span style="color:#f92672">(</span>beanName<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		lazyTargetSource<span style="color:#f92672">.</span><span style="color:#a6e22e">setBeanFactory</span><span style="color:#f92672">(</span>applicationContext<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// åˆ›å»ºä»£ç†å·¥å‚å¹¶è°ƒç”¨postProcesså°†newçš„å¯¹è±¡åŠ å…¥å®¹å™¨ä¸­
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		ProxyFactoryBean proxyFactory <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ProxyFactoryBean<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>		proxyFactory <span style="color:#f92672">=</span> objectPostProcessor<span style="color:#f92672">.</span><span style="color:#a6e22e">postProcess</span><span style="color:#f92672">(</span>proxyFactory<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		proxyFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">setTargetSource</span><span style="color:#f92672">(</span>lazyTargetSource<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// è¿”å›å®¹å™¨ä¸­çš„ç¬¦åˆæ¡ä»¶çš„å¯¹è±¡(å³AuthenticationManagerå¯¹è±¡)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span>T<span style="color:#f92672">)</span> proxyFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">getObject</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<ol>
<li><code>AuthenticationConfiguration</code>æä¾›äº†é»˜è®¤è§£ç å™¨å’ŒåŸºäºé»˜è®¤è§£ç å™¨çš„é‰´æƒç®¡ç†æ„é€ å™¨ã€‚</li>
<li>æä¾›äº†<code>getAuthenticationManager()</code>ç”¨äºè¿”å›å®¹å™¨ä¸­çš„<code>AuthenticationManager</code>å¯¹è±¡ã€‚</li>
<li>å°è¯•é€šè¿‡è·å–å®¹å™¨ä¸­çš„<code>AuthenticationManagerBuilder</code>å¹¶è°ƒç”¨å§”æ´¾æ¨¡å¼ã€å»ºé€ è€…æ¨¡å¼æ¥åˆ›å»º<code>AuthenticationManager</code>ã€‚</li>
<li>å¦‚æœä»æ²¡æœ‰ï¼Œä¹ˆä¼šåŸºäºç±»å‹åœ¨å®¹å™¨ä¸­è¿›è¡ŒæŸ¥æ‰¾ï¼ˆæ‰¾ä¸åˆ°æˆ–å¤šä¸ªä¼šæŠ›å‡ºå¼‚å¸¸ï¼‰ï¼Œç„¶åè¿›è¡Œé‰´æƒï¼Œå¦‚æœæˆåŠŸè¿”å›<code>Authentication</code>ï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸ã€‚</li>
</ol>
</blockquote>
<h4 id="4-websecurityconfigureradapter">4. WebSecurityConfigurerAdapter<a href="#4-websecurityconfigureradapter" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">WebSecurityConfigurerAdapter</span> <span style="color:#66d9ef">implements</span>
</span></span><span style="display:flex;"><span>		WebSecurityConfigurer<span style="color:#f92672">&lt;</span>WebSecurity<span style="color:#f92672">&gt;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">boolean</span> disableLocalConfigureAuthenticationBldr<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">boolean</span> disableDefaults<span style="color:#f92672">;</span> <span style="color:#75715e">// åˆå§‹åŒ–æ˜¯å¦éœ€è¦é»˜è®¤é…ç½®
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> AuthenticationManager authenticationManager<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> HttpSecurity http<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> AuthenticationManagerBuilder localConfigureAuthenticationBldr<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// è‡ªåŠ¨æ³¨å…¥å®¹å™¨ä¸­çš„AuthenticationConfigurationï¼Œä¸Šæ–‡å·²ç»è§£æè¿‡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">@Autowired</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setAuthenticationConfiguration</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>			AuthenticationConfiguration authenticationConfiguration<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">authenticationConfiguration</span> <span style="color:#f92672">=</span> authenticationConfiguration<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// é…ç½®é‰´æƒç®¡ç†å™¨æ„é€ å™¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">configure</span><span style="color:#f92672">(</span>AuthenticationManagerBuilder auth<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// å½“æœ‰å­ç±»å¤å†™è¯¥æ–¹æ³•æ—¶ï¼ˆä¸è°ƒç”¨super.configureï¼‰å°±ä¸ä¼šå°†å‚æ•°æ”¹ä¸ºtrue
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">disableLocalConfigureAuthenticationBldr</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// åˆå§‹åŒ–WebSecurityç›¸å…³å±æ€§
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">init</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> WebSecurity web<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// é¦–å…ˆè·å–HttpSecurityå±æ€§
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">final</span> HttpSecurity http <span style="color:#f92672">=</span> getHttp<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// çœç•¥
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">final</span> HttpSecurity <span style="color:#a6e22e">getHttp</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>http <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> http<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// çœç•¥
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// æ ¸å¿ƒï¼ï¼ï¼ï¼ï¼ è·å–å®¹å™¨ä¸­çš„authenticationManageræˆ–å­ç±»åˆ›å»ºçš„
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		AuthenticationManager authenticationManager <span style="color:#f92672">=</span> authenticationManager<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// è®¾ç½®ä¸ºparentå±æ€§ï¼Œåœ¨AuthenticationManagerBuilderä¸­ä½œä¸ºå‚æ•°æ¥åˆ›å»ºProviderManager
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// å› ä¸ºç”¨æˆ·å¯ä»¥æŒ‡å®šå¤šä¸ªè‡ªå·±çš„AuthenticationProvider
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// åœ¨è‡ªå®šä¹‰AuthenticationProviderä¸å­˜åœ¨æ—¶ä¼šç»§ç»­å¾€ä¸ŠæŸ¥æ‰¾parentçš„AuthenticationManagerå¯¹è±¡ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        authenticationBuilder<span style="color:#f92672">.</span><span style="color:#a6e22e">parentAuthenticationManager</span><span style="color:#f92672">(</span>authenticationManager<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// è®¾ç½®HttpSecurityåˆ›å»ºçš„å¿…è¦å…±äº«å‚æ•°ï¼ˆä¸Šä¸‹æ–‡ä¹‹ç±»çš„ï¼‰
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		Map<span style="color:#f92672">&lt;</span>Class<span style="color:#f92672">&lt;?&gt;,</span> Object<span style="color:#f92672">&gt;</span> sharedObjects <span style="color:#f92672">=</span> createSharedObjects<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// åˆ›å»ºHttpSecurityå¯¹è±¡å¹¶åŠ å…¥å®¹å™¨ä¸­
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		http <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HttpSecurity<span style="color:#f92672">(</span>objectPostProcessor<span style="color:#f92672">,</span> authenticationBuilder<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>				sharedObjects<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// é»˜è®¤disableDefaultsä¸ºfalseï¼Œé™¤éæ˜¾ç¤ºçš„åœ¨æ„é€ ä¸­æŒ‡å®šä¸ºtrue
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>disableDefaults<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// è®¾ç½®é»˜è®¤çš„å‚æ•°ç»™httpSecurity
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			http
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">.</span><span style="color:#a6e22e">csrf</span><span style="color:#f92672">().</span><span style="color:#a6e22e">and</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">.</span><span style="color:#a6e22e">addFilter</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> WebAsyncManagerIntegrationFilter<span style="color:#f92672">())</span>
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">.</span><span style="color:#a6e22e">exceptionHandling</span><span style="color:#f92672">().</span><span style="color:#a6e22e">and</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">.</span><span style="color:#a6e22e">headers</span><span style="color:#f92672">().</span><span style="color:#a6e22e">and</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">.</span><span style="color:#a6e22e">sessionManagement</span><span style="color:#f92672">().</span><span style="color:#a6e22e">and</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">.</span><span style="color:#a6e22e">securityContext</span><span style="color:#f92672">().</span><span style="color:#a6e22e">and</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">.</span><span style="color:#a6e22e">requestCache</span><span style="color:#f92672">().</span><span style="color:#a6e22e">and</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">.</span><span style="color:#a6e22e">anonymous</span><span style="color:#f92672">().</span><span style="color:#a6e22e">and</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">.</span><span style="color:#a6e22e">servletApi</span><span style="color:#f92672">().</span><span style="color:#a6e22e">and</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">.</span><span style="color:#a6e22e">apply</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> DefaultLoginPageConfigurer<span style="color:#f92672">&lt;&gt;()).</span><span style="color:#a6e22e">and</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">.</span><span style="color:#a6e22e">logout</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// é€šè¿‡SPIè·å–AbstractHttpConfigurerå¯¹è±¡çš„é›†åˆ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			ClassLoader classLoader <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">context</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getClassLoader</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>			List<span style="color:#f92672">&lt;</span>AbstractHttpConfigurer<span style="color:#f92672">&gt;</span> defaultHttpConfigurers <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>					SpringFactoriesLoader<span style="color:#f92672">.</span><span style="color:#a6e22e">loadFactories</span><span style="color:#f92672">(</span>AbstractHttpConfigurer<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> classLoader<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// å°†å…¶ä»–çš„securityé…ç½®ç±»çš„å­ç±»éƒ½è¿›è¡Œåˆå§‹åŒ–æ“ä½œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>AbstractHttpConfigurer configurer <span style="color:#f92672">:</span> defaultHttpConfigurers<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>				http<span style="color:#f92672">.</span><span style="color:#a6e22e">apply</span><span style="color:#f92672">(</span>configurer<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// å¦‚æœå­ç±»å®ç°äº†è¯¥æ–¹æ³•å°±ä½¿ç”¨å­ç±»çš„ï¼Œå¦åˆ™å°±æ˜¯çˆ¶ç±»é»˜è®¤çš„httpSecurityç›¸å…³é…ç½®
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		configure<span style="color:#f92672">(</span>http<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> http<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// æ ¸å¿ƒï¼šè·å–AuthenticationManageræ¥ä½¿ç”¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">protected</span> AuthenticationManager <span style="color:#a6e22e">authenticationManager</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// AuthenticationManageræ˜¯å¦å·²ç»åˆå§‹åŒ–ï¼Œç¬¬ä¸€æ¬¡éƒ½æ˜¯æ²¡æœ‰åˆå§‹åŒ–
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>authenticationManagerInitialized<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// æŸ¥çœ‹å­ç±»æ˜¯å¦å¤å†™configure()æ¥é…ç½®é‰´æƒç®¡ç†æ„é€ å™¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			configure<span style="color:#f92672">(</span>localConfigureAuthenticationBldr<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// trueåˆ™è·å–ä¹‹å‰AuthenticationConfigurationä¸­åˆ›å»ºçš„AuthenticationManager
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>disableLocalConfigureAuthenticationBldr<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>				authenticationManager <span style="color:#f92672">=</span> authenticationConfiguration
</span></span><span style="display:flex;"><span>						<span style="color:#f92672">.</span><span style="color:#a6e22e">getAuthenticationManager</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// å¦åˆ™åŸºäºå­ç±»çš„å®ç°æ„å»ºæ–°çš„securityé…ç½®ç±»
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				authenticationManager <span style="color:#f92672">=</span> localConfigureAuthenticationBldr<span style="color:#f92672">.</span><span style="color:#a6e22e">build</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// è®¾ç½®åˆå§‹åŒ–æ ‡è¯†
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			authenticationManagerInitialized <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> authenticationManager<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">configure</span><span style="color:#f92672">(</span>AuthenticationManagerBuilder auth<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">disableLocalConfigureAuthenticationBldr</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<ol>
<li>
<p>ç”±<code>WebSecurityConfiguration</code>ä¸­æ³¨å…¥çš„bean<code>springSecurityFilterChain</code>è§¦å‘äº†<code>WebSecurityConfigurerAdapter</code>ä¸­çš„<code>init</code>åˆå§‹åŒ–æ“ä½œã€‚</p>
</li>
<li>
<p><code>init()</code>ä¼šè·å–å®¹å™¨ä¸­çš„<code>AuthenticationManager</code>ï¼Œè§¦å‘<code>HttpSecurity</code>çš„åˆå§‹åŒ–å·¥ä½œï¼Œå¹¶è®¾ç½®é»˜è®¤çš„<code>HttpSecurity</code>å‚æ•°ã€‚</p>
</li>
<li>
<p>æœ€ç»ˆ<code>AuthenticationManager</code>å¯¹è±¡ä½œä¸º``parentAuthenticationManager<code>å±æ€§è¢«ç”¨äº</code>ProviderManager`åˆ›å»ºï¼Œå¹¶æ³¨å…¥åˆ°å®¹å™¨ä¸­ã€‚</p>
</li>
<li>
<p>å’Œ<code>ProviderManager</code>æµç¨‹ç±»ä¼¼ï¼Œ<code>WebSecurity</code>å’Œ<code>HttpSecurity</code>ä¹Ÿæ˜¯è¢«è®¾ç½®å±æ€§å‚æ•°åé€šè¿‡<code>FilterChainProxy</code>æ„å»ºæˆFilterè¿‡æ»¤å™¨æ³¨å…¥åˆ°å®¹å™¨ä¸­ã€‚</p>
</li>
</ol>
</blockquote>
<h4 id="5-providemanager">5. ProvideManager<a href="#5-providemanager" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p>æ­¤å¤„ä¸»è¦è§£é‡Š<code>ProvideManager</code>ã€<code>AuthenticationManager</code>ã€<code>AuthenticationProvider</code>ä¸‰è€…ä¹‹é—´çš„è”ç³»ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">AuthenticationManager</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    Authentication <span style="color:#a6e22e">authenticate</span><span style="color:#f92672">(</span>Authentication authentication<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> AuthenticationException<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">AuthenticationProvider</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    Authentication <span style="color:#a6e22e">authenticate</span><span style="color:#f92672">(</span>Authentication authentication<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> AuthenticationException<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// æ ¹æ®ä¸åŒè§’åº¦è¿›è¡Œåˆ¤æ–­ï¼ˆé€‚é…å™¨æ¨¡å¼ï¼‰
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">supports</span><span style="color:#f92672">(</span>Class<span style="color:#f92672">&lt;?&gt;</span> authentication<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ProviderManager</span> <span style="color:#66d9ef">implements</span> AuthenticationManager<span style="color:#f92672">,</span> MessageSourceAware<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>		InitializingBean <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// æŒæœ‰AuthenticationProviderå®ç°ç±»é›†åˆçš„å¼•ç”¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">private</span> List<span style="color:#f92672">&lt;</span>AuthenticationProvider<span style="color:#f92672">&gt;</span> providers <span style="color:#f92672">=</span> Collections<span style="color:#f92672">.</span><span style="color:#a6e22e">emptyList</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ä¼šè¢«
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> Authentication <span style="color:#a6e22e">authenticate</span><span style="color:#f92672">(</span>Authentication authentication<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>												<span style="color:#66d9ef">throws</span> AuthenticationException <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// æ³¨æ„æ­¤å¤„æ˜¯ä¸¤ä¸ªresultï¼Œåˆ†åˆ«å¯¹åº”AuthenticationProviderå®ç°ç±»å’ŒAuthenticationManagerå®ç°ç±»
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		Authentication result <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>		Authentication parentResult <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// ä¾æ¬¡è°ƒç”¨AuthenticationProviderå®ç°ç±»
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>AuthenticationProvider provider <span style="color:#f92672">:</span> getProviders<span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// å¦‚æœsupportä¸ºfalseé‚£ä¹ˆå°±è·³è¿‡æ­¤æ¬¡éªŒè¯
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>provider<span style="color:#f92672">.</span><span style="color:#a6e22e">supports</span><span style="color:#f92672">(</span>toTest<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">continue</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// è¿›è¡ŒéªŒè¯ï¼Œå¦‚æœéªŒè¯æˆåŠŸï¼ˆè¿”å›Authenticationä¸ä¸ºnullï¼‰ï¼Œåˆ™ä¸éœ€è¦ç»§ç»­é‰´æƒ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				result <span style="color:#f92672">=</span> provider<span style="color:#f92672">.</span><span style="color:#a6e22e">authenticate</span><span style="color:#f92672">(</span>authentication<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>result <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// ç»“æœä¸ä¸ºç©ºï¼ˆæˆåŠŸï¼‰åˆ™ä¿å­˜detail(ipåœ°å€ï¼Œè¯ä¹¦ä¹‹ç±»çš„)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>					copyDetails<span style="color:#f92672">(</span>authentication<span style="color:#f92672">,</span> result<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// çœç•¥
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// å¦‚æœç»“æœä¸ºnullï¼ˆå³æ²¡æœ‰é‰´æƒæˆåŠŸï¼‰
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>result <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> parent <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// å°è¯•è°ƒç”¨AuthenticationManagerçš„å®ç°ç±»è¿›è¡Œé‰´æƒï¼Œå¹¶å°†ç»“æœèµ‹äºˆresult
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>				result <span style="color:#f92672">=</span> parentResult <span style="color:#f92672">=</span> parent<span style="color:#f92672">.</span><span style="color:#a6e22e">authenticate</span><span style="color:#f92672">(</span>authentication<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// çœç•¥
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// çœç•¥
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p><img src="https://image.leejay.top/FvU2DWc-HPFITz_0jZCnzyqerxFO" alt=""></p>
<blockquote>
<ol>
<li>
<p><code>ProviderManager</code>æ˜¯<code>AuthenticationManager</code>çš„å®ç°ç±»ï¼ŒæŒæœ‰<code>AuthenticationProvider</code>é›†åˆçš„å¼•ç”¨ã€‚</p>
</li>
<li>
<p>å®¹å™¨ä¸­å¯ä»¥å­˜åœ¨å¤šä¸ª<code>AuthenticationProvider</code>çš„å®ç°ç±»å’Œä¸€ä¸ª<code>AuthenticationManager</code>å®ç°ç±»ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">configure</span><span style="color:#f92672">(</span>AuthenticationManagerBuilder auth<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// å¯ä»¥é…ç½®å¤šä¸ªAuthenticationProviderçš„å®ç°ç±»
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// ä½†æ˜¯å»ºè®®ä¸€ä¸ªUserDetailServiceå¯¹åº”ä¸€ä¸ªAuthenticationProvider
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    auth<span style="color:#f92672">.</span><span style="color:#a6e22e">authenticationProvider</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">.</span><span style="color:#a6e22e">authenticationProvider</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">.</span><span style="color:#a6e22e">userDetailsService</span><span style="color:#f92672">(</span>userManager<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">.</span><span style="color:#a6e22e">passwordEncoder</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> BCryptPasswordEncoder<span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
<li>
<p><code>ProviderManager</code>åœ¨é‰´æƒæ˜¯ä¼šå…ˆå°è¯•è°ƒç”¨ç”¨æˆ·æŒ‡å®šçš„å•ä¸ªæˆ–å¤šä¸ª<code>AuthenticationProviderï¼ˆæ²¡æœ‰å°±è·³è¿‡ï¼‰</code>ï¼Œç„¶åå°è¯•æ‰§è¡Œ<code>AuthenticationManager</code>çš„å®ç°ç±»è¿›è¡Œé‰´æƒã€‚</p>
</li>
</ol>
</blockquote>
<h4 id="6-æµç¨‹å›¾æ€»ç»“">6. æµç¨‹å›¾æ€»ç»“<a href="#6-æµç¨‹å›¾æ€»ç»“" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<iframe id="embed_dom" name="embed_dom" frameborder="0" style="height:400px;" src="https://www.processon.com/embed/60498ba67d9c08214c661ec2"></iframe>
<blockquote>
<p>ç›´æ¥ç‚¹å‡»é“¾æ¥åœ¨çº¿è®¿é—®<a href="https://www.processon.com/view/link/6049dcdbe401fd39d60176e1">Spring Securityæºç è§£æ</a></p>
</blockquote>
<h2 id="filter">Filter<a href="#filter" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<h3 id="spring-securityå†…ç½®è¿‡æ»¤å™¨">Spring Securityå†…ç½®è¿‡æ»¤å™¨<a href="#spring-securityå†…ç½®è¿‡æ»¤å™¨" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>SpringSecurityä¸­å†…ç½®äº†ä¸€äº›Filterè¿‡æ»¤å™¨ï¼Œå¯ä»¥é€šè¿‡<code>HttpSecurity</code>è¿›è¡Œå†…ç½®å’Œè‡ªå®šä¹‰è¿‡æ»¤å™¨é…ç½®ã€‚</p>
<h4 id="filteræ‰§è¡Œé¡ºåº">Filteræ‰§è¡Œé¡ºåº<a href="#filteræ‰§è¡Œé¡ºåº" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<h5 id="filtercomparator">FilterComparator<a href="#filtercomparator" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">FilterComparator</span> <span style="color:#66d9ef">implements</span> Comparator<span style="color:#f92672">&lt;</span>Filter<span style="color:#f92672">&gt;,</span> Serializable <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    FilterComparator<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// ä»100å¼€å§‹ï¼Œä¾æ¬¡å åŠ 100ï¼Œæ•°ç»„è¶Šå°è¶Šé å‰
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		Step order <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Step<span style="color:#f92672">(</span>INITIAL_ORDER<span style="color:#f92672">,</span> ORDER_STEP<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		put<span style="color:#f92672">(</span>ChannelProcessingFilter<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> order<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span> <span style="color:#75715e">// 100
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		put<span style="color:#f92672">(</span>ConcurrentSessionFilter<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> order<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span> <span style="color:#75715e">// 200
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		put<span style="color:#f92672">(</span>WebAsyncManagerIntegrationFilter<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> order<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span> <span style="color:#75715e">// 300
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		put<span style="color:#f92672">(</span>SecurityContextPersistenceFilter<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> order<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		put<span style="color:#f92672">(</span>HeaderWriterFilter<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> order<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		put<span style="color:#f92672">(</span>CorsFilter<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> order<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		put<span style="color:#f92672">(</span>CsrfFilter<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> order<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		put<span style="color:#f92672">(</span>LogoutFilter<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> order<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		filterToOrder<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;org.springframework.security.oauth2.client.web.OAuth2AuthorizationRequestRedirectFilter&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>				order<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		filterToOrder<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>		<span style="color:#e6db74">&#34;org.springframework.security.saml2.provider.service.servlet.filter.Saml2WebSsoAuthenticationRequestFilter&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>				order<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		put<span style="color:#f92672">(</span>X509AuthenticationFilter<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> order<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		put<span style="color:#f92672">(</span>AbstractPreAuthenticatedProcessingFilter<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> order<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		filterToOrder<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;org.springframework.security.cas.web.CasAuthenticationFilter&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>				order<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		filterToOrder<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>			<span style="color:#e6db74">&#34;org.springframework.security.oauth2.client.web.OAuth2LoginAuthenticationFilter&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>				order<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		filterToOrder<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>		<span style="color:#e6db74">&#34;org.springframework.security.saml2.provider.service.servlet.filter.Saml2WebSsoAuthenticationFilter&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>				order<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		put<span style="color:#f92672">(</span>UsernamePasswordAuthenticationFilter<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> order<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		put<span style="color:#f92672">(</span>ConcurrentSessionFilter<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> order<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		filterToOrder<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>				<span style="color:#e6db74">&#34;org.springframework.security.openid.OpenIDAuthenticationFilter&#34;</span><span style="color:#f92672">,</span> order<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		put<span style="color:#f92672">(</span>DefaultLoginPageGeneratingFilter<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> order<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		put<span style="color:#f92672">(</span>DefaultLogoutPageGeneratingFilter<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> order<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		put<span style="color:#f92672">(</span>ConcurrentSessionFilter<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> order<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		put<span style="color:#f92672">(</span>DigestAuthenticationFilter<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> order<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		filterToOrder<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>			<span style="color:#e6db74">&#34;org.springframework.security.oauth2.server.resource.web.BearerTokenAuthenticationFilter&#34;</span><span style="color:#f92672">,</span> order<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		put<span style="color:#f92672">(</span>BasicAuthenticationFilter<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> order<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		put<span style="color:#f92672">(</span>RequestCacheAwareFilter<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> order<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		put<span style="color:#f92672">(</span>SecurityContextHolderAwareRequestFilter<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> order<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		put<span style="color:#f92672">(</span>JaasApiIntegrationFilter<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> order<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		put<span style="color:#f92672">(</span>RememberMeAuthenticationFilter<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> order<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		put<span style="color:#f92672">(</span>AnonymousAuthenticationFilter<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> order<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		filterToOrder<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>			<span style="color:#e6db74">&#34;org.springframework.security.oauth2.client.web.OAuth2AuthorizationCodeGrantFilter&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>				order<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		put<span style="color:#f92672">(</span>SessionManagementFilter<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> order<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		put<span style="color:#f92672">(</span>ExceptionTranslationFilter<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> order<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		put<span style="color:#f92672">(</span>FilterSecurityInterceptor<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> order<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		put<span style="color:#f92672">(</span>SwitchUserFilter<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> order<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// é€šè¿‡classåç§°å»mapä¸­æŸ¥æ‰¾ï¼Œæ‰¾ä¸åˆ°å°±å»æ‰¾çˆ¶ç±»çš„ï¼Œè¿˜æ˜¯æ‰¾ä¸åˆ°å°±è¿”å›null
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> Integer <span style="color:#a6e22e">getOrder</span><span style="color:#f92672">(</span>Class<span style="color:#f92672">&lt;?&gt;</span> clazz<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>clazz <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			Integer result <span style="color:#f92672">=</span> filterToOrder<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>clazz<span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>result <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">return</span> result<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>			clazz <span style="color:#f92672">=</span> clazz<span style="color:#f92672">.</span><span style="color:#a6e22e">getSuperclass</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// åˆ¤æ–­mapä¸­æ˜¯å¦å·²å­˜åœ¨è¯¥åå­—çš„è¿‡æ»¤å™¨ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isRegistered</span><span style="color:#f92672">(</span>Class<span style="color:#f92672">&lt;?</span> <span style="color:#66d9ef">extends</span> Filter<span style="color:#f92672">&gt;</span> filter<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> getOrder<span style="color:#f92672">(</span>filter<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<ol>
<li>å°†ä¸€äº›è¿‡æ»¤å™¨æŒ‰ç…§æŒ‡å®šé¡ºåºæ’åˆ—ï¼Œä»100å¼€å§‹ä¾æ¬¡å åŠ 100ï¼Œæ•°å€¼è¶Šå°è¶Šé å‰ã€‚</li>
<li>é€šè¿‡ç±»ååœ¨mapä¸­æŸ¥æ‰¾å¹¶è¿›è¡Œæ‰¾åˆ°ï¼Œåˆ¤æ–­å’Œæ¯”è¾ƒã€‚</li>
</ol>
</blockquote>
<h5 id="httpsecurity">HttpSecurity<a href="#httpsecurity" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">HttpSecurity</span> <span style="color:#66d9ef">extends</span>
</span></span><span style="display:flex;"><span>		AbstractConfiguredSecurityBuilder<span style="color:#f92672">&lt;</span>DefaultSecurityFilterChain<span style="color:#f92672">,</span> HttpSecurity<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">implements</span> SecurityBuilder<span style="color:#f92672">&lt;</span>DefaultSecurityFilterChain<span style="color:#f92672">&gt;,</span>
</span></span><span style="display:flex;"><span>		HttpSecurityBuilder<span style="color:#f92672">&lt;</span>HttpSecurity<span style="color:#f92672">&gt;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">private</span> FilterComparator comparator <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> FilterComparator<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// æ·»åŠ è¿‡æ»¤å™¨åˆ°mapä¸­
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">public</span> HttpSecurity <span style="color:#a6e22e">addFilter</span><span style="color:#f92672">(</span>Filter filter<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		Class<span style="color:#f92672">&lt;?</span> <span style="color:#66d9ef">extends</span> Filter<span style="color:#f92672">&gt;</span> filterClass <span style="color:#f92672">=</span> filter<span style="color:#f92672">.</span><span style="color:#a6e22e">getClass</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>comparator<span style="color:#f92672">.</span><span style="color:#a6e22e">isRegistered</span><span style="color:#f92672">(</span>filterClass<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> IllegalArgumentException<span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>					<span style="color:#e6db74">&#34;The Filter class &#34;</span>
</span></span><span style="display:flex;"><span>							<span style="color:#f92672">+</span> filterClass<span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>							<span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; does not have a registered order and cannot be added without a specified order. Consider using addFilterBefore or addFilterAfter instead.&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">filters</span><span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>filter<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// å°†æ–°å¢è¿‡æ»¤å™¨æ”¾åˆ°æŒ‡å®šè¿‡æ»¤å™¨ä¹‹å‰æ‰§è¡Œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">public</span> HttpSecurity <span style="color:#a6e22e">addFilterBefore</span><span style="color:#f92672">(</span>Filter filter<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>			Class<span style="color:#f92672">&lt;?</span> <span style="color:#66d9ef">extends</span> Filter<span style="color:#f92672">&gt;</span> beforeFilter<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		comparator<span style="color:#f92672">.</span><span style="color:#a6e22e">registerBefore</span><span style="color:#f92672">(</span>filter<span style="color:#f92672">.</span><span style="color:#a6e22e">getClass</span><span style="color:#f92672">(),</span> beforeFilter<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> addFilter<span style="color:#f92672">(</span>filter<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// å°†æ–°å¢çš„è¿‡æ»¤å™¨æ”¾åˆ°æŒ‡å®šçš„è¿‡æ»¤å™¨ä½ç½®ï¼ˆå³orderå€¼ç›¸åŒï¼‰
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">public</span> HttpSecurity <span style="color:#a6e22e">addFilterAt</span><span style="color:#f92672">(</span>Filter filter<span style="color:#f92672">,</span> Class<span style="color:#f92672">&lt;?</span> <span style="color:#66d9ef">extends</span> Filter<span style="color:#f92672">&gt;</span> atFilter<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">comparator</span><span style="color:#f92672">.</span><span style="color:#a6e22e">registerAt</span><span style="color:#f92672">(</span>filter<span style="color:#f92672">.</span><span style="color:#a6e22e">getClass</span><span style="color:#f92672">(),</span> atFilter<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> addFilter<span style="color:#f92672">(</span>filter<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// å°†æ–°å¢çš„è¿‡æ»¤å™¨æ”¾åˆ°æŒ‡å®šè¿‡æ»¤å™¨åé¢
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">public</span> HttpSecurity <span style="color:#a6e22e">addFilterAfter</span><span style="color:#f92672">(</span>Filter filter<span style="color:#f92672">,</span> Class<span style="color:#f92672">&lt;?</span> <span style="color:#66d9ef">extends</span> Filter<span style="color:#f92672">&gt;</span> afterFilter<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		comparator<span style="color:#f92672">.</span><span style="color:#a6e22e">registerAfter</span><span style="color:#f92672">(</span>filter<span style="color:#f92672">.</span><span style="color:#a6e22e">getClass</span><span style="color:#f92672">(),</span> afterFilter<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> addFilter<span style="color:#f92672">(</span>filter<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h4 id="å†…ç½®è¿‡æ»¤å™¨">å†…ç½®è¿‡æ»¤å™¨<a href="#å†…ç½®è¿‡æ»¤å™¨" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<table>
<thead>
<tr>
<th>è¿‡æ»¤å™¨</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody>
<tr>
<td>ChannelProcessingFilter</td>
<td>è¿‡æ»¤å“ªäº›è¯·æ±‚éœ€è¦ä½¿ç”¨httpsè¿˜æ˜¯httpåè®®</td>
</tr>
<tr>
<td>ConcurrentSessionFilter</td>
<td>åˆ¤æ–­sessionæ˜¯å¦è¿‡æœŸåŠæ›´æ–°æœ€æ–°çš„è®¿é—®æ—¶é—´</td>
</tr>
<tr>
<td>WebAsyncManagerIntegrationFilter</td>
<td>ç”¨äºé›†æˆSecurityContextåˆ°Springå¼‚æ­¥æ‰§è¡Œæœºåˆ¶ä¸­çš„ WebAsyncManagerã€‚</td>
</tr>
<tr>
<td>SecurityContextPersistenceFilter</td>
<td>æ§åˆ¶SecurityContextç”Ÿå‘½å‘¨æœŸï¼Œè¯·æ±‚æ¥æ—¶åˆ›å»ºï¼Œç»“æŸæ—¶æ¸…ç©º</td>
</tr>
<tr>
<td>HeaderWriterFilter</td>
<td>ç»™httpè¯·æ±‚æ·»åŠ header</td>
</tr>
<tr>
<td>CorsFilter</td>
<td>é’ˆå¯¹corsè·¨åŸŸè¿›è¡Œçš„è®¾ç½®</td>
</tr>
<tr>
<td>CsrfFilter</td>
<td>ç”¨äºé˜²æ­¢csrfè·¨ç«™æ”»å‡»</td>
</tr>
<tr>
<td>LogoutFilter</td>
<td>å¤„ç†æ³¨é”€çš„è¿‡æ»¤å™¨</td>
</tr>
<tr>
<td>X509AuthenticationFilte</td>
<td>X509è®¤è¯è¿‡æ»¤å™¨</td>
</tr>
<tr>
<td>AbstractPreAuthenticatedProcessingFilter</td>
<td>ä¸»è¦ç”¨äºèº«ä»½çš„æå–è€Œä¸æ˜¯éªŒè¯</td>
</tr>
<tr>
<td>CasAuthenticationFilter</td>
<td>CASå•ç‚¹ç™»å½•æ¨¡å—ï¼Œä¾èµ–äºSpring Security CASæ¨¡å—</td>
</tr>
<tr>
<td><b><code>UsernamePasswordAuthenticationFilter</code></b></td>
<td>å¤„ç†ç”¨æˆ·åŠå¯†ç è®¤è¯çš„æ ¸å¿ƒè¿‡æ»¤å™¨</td>
</tr>
<tr>
<td>DefaultLoginPageGeneratingFilter</td>
<td>ç”Ÿæˆé»˜è®¤çš„ç™»é™†é¡µé¢/login</td>
</tr>
<tr>
<td>DefaultLogoutPageGeneratingFilter</td>
<td>ç”Ÿæˆé»˜è®¤çš„ç™»å‡ºé¡µ/logout</td>
</tr>
<tr>
<td>BasicAuthenticationFilter</td>
<td>è´Ÿè´£httpå¤´ä¸­æ˜¾ç¤ºçš„åŸºæœ¬èº«ä»½éªŒè¯å‡­æ®ï¼Œé»˜è®¤å¯ç”¨</td>
</tr>
<tr>
<td>RequestCacheAwareFilter</td>
<td>ç”¨äºå¤„ç†å› ç™»å½•æ‰“æ–­åŸæœ‰è¯·æ±‚ï¼Œç»§è€Œç™»é™†åè‡ªåŠ¨è·³è½¬çš„åŠŸèƒ½ã€‚</td>
</tr>
<tr>
<td>RememberMeAuthenticationFilter</td>
<td>å¤„ç†è®°ä½æˆ‘åŠŸèƒ½çš„è¿‡æ»¤å™¨</td>
</tr>
<tr>
<td>AnonymousAuthenticationFilter</td>
<td>å¯¹äºæ— éœ€ç™»å½•ç›´æ¥è®¿é—®çš„èµ„æºä¼šæˆäºˆå…¶åŒ¿åç”¨æˆ·èº«ä»½</td>
</tr>
<tr>
<td>SessionManagementFilter</td>
<td>sessionç®¡ç†å™¨</td>
</tr>
<tr>
<td>FilterSecurityInterceptor</td>
<td>å†³å®šäº†è®¿é—®ç‰¹å®šè·¯å¾„åº”è¯¥å…·å¤‡çš„æƒé™ï¼ˆåŠ¨æ€æƒé™æ§åˆ¶å¿…å¤‡ï¼‰</td>
</tr>
</tbody>
</table>
<h3 id="spring-securityè¿‡æ»¤å™¨é“¾">Spring Securityè¿‡æ»¤å™¨é“¾<a href="#spring-securityè¿‡æ»¤å™¨é“¾" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>åœ¨Spring Security Filterä¸­æ˜¯é€šè¿‡<code>FilterChainProxy</code>æ¥ç®¡ç†å¤šä¸ªä»£ç†ä¸åŒè·¯å¾„çš„<code>SecurityFilterChain</code>è¿‡æ»¤å™¨é“¾ï¼ŒåŒæ—¶<code>FilterChainProxy</code>æ˜¯é€šè¿‡<code>DelegatingFilterProxy</code>åŠ å…¥åˆ°è¿‡æ»¤å™¨é“¾ä¸­çš„ä¸€éƒ¨åˆ†ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://image.leejay.top/Fn262VRuzsxESP1x-K4XBoie2rsC" alt=""></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">SecurityFilterChain</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">matches</span><span style="color:#f92672">(</span>HttpServletRequest request<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// è·¯å¾„å¯¹åº”çš„è¿‡æ»¤å™¨é“¾
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	List<span style="color:#f92672">&lt;</span>Filter<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">getFilters</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// é»˜è®¤å®ç°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DefaultSecurityFilterChain</span> <span style="color:#66d9ef">implements</span> SecurityFilterChain <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// WebSecurity.performBuild()ä¼šå°†SecurityFilterChainçš„å®ç°ç±»ä½œä¸ºå‚æ•°æ„å»ºä¸ºFilterChainProxy
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// FilterChainProxyæ˜¯ä¸€ä¸ªè¿‡æ»¤å™¨é“¾ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªè¿‡æ»¤å™¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">FilterChainProxy</span> <span style="color:#66d9ef">extends</span> GenericFilterBean <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> List<span style="color:#f92672">&lt;</span>SecurityFilterChain<span style="color:#f92672">&gt;</span> filterChains<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">FilterChainProxy</span><span style="color:#f92672">(</span>SecurityFilterChain chain<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">this</span><span style="color:#f92672">(</span>Arrays<span style="color:#f92672">.</span><span style="color:#a6e22e">asList</span><span style="color:#f92672">(</span>chain<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ç”¨äºä»£ç†ä¸€ä¸ªæ ‡å‡†çš„Servlet Filter ç”¨äºé›†æˆåˆ°IOCçš„ç®¡ç†
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DelegatingFilterProxy</span> <span style="color:#66d9ef">extends</span> GenericFilterBean <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ä¸ºäº†åœ¨Sevlet Filterä¸­æ³¨å…¥Spring Beançš„ç‰¹æ€§è€Œå‡ºç°çš„
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">GenericFilterBean</span> <span style="color:#66d9ef">implements</span> Filter<span style="color:#f92672">,</span> BeanNameAware<span style="color:#f92672">,</span> EnvironmentAware<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>		EnvironmentCapable<span style="color:#f92672">,</span> ServletContextAware<span style="color:#f92672">,</span> InitializingBean<span style="color:#f92672">,</span> DisposableBean <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<ol>
<li><code>SecurityFilterChain</code>ä½œä¸ºæ„å»º<code>FilterChainProxy</code>çš„å‚æ•°æ¥æ„å»ºè¿‡æ»¤å™¨é“¾ã€‚</li>
<li><code>FilterChainProxy</code>é»˜è®¤å®ç°<code>DefaultSecurityFilterChain</code>ä¸€èˆ¬ç”±<code>HttpSecurity</code>åˆ›å»ºã€‚</li>
<li><code>FilterChainProxy</code>æ—¢æ˜¯è¿‡æ»¤å™¨é“¾ä¹Ÿæ˜¯è¿‡æ»¤å™¨ã€‚</li>
<li><code>DelegatingFilterProxy</code>å¯ä»¥ä»£ç†ä¸€ä¸ª<code>Servlet Filter</code>ï¼Œå°†å…¶ç»§æ‰¿åˆ°Spring Beanä¸­å»ã€‚</li>
</ol>
</blockquote>
<hr>
<h2 id="jwtjson-web-token">JWT(Json Web Token)<a href="#jwtjson-web-token" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p><code>JOSE</code>æ˜¯ä¸€ç§æ—¨åœ¨æä¾›åœ¨å„æ–¹ä¹‹é—´å®‰å…¨ä¼ é€’å£°æ˜ï¼ˆclaimsï¼‰çš„æ–¹æ³•çš„è§„èŒƒé›†ã€‚åŒ…å«å¦‚ä¸‹è§„èŒƒï¼š</p>
<ul>
<li><code>JWSï¼ˆRFC 7515ï¼‰ -JSON Webç­¾å</code>ï¼Œæè¿°ç”Ÿæˆå’Œå¤„ç†ç­¾åæ¶ˆæ¯ã€‚</li>
<li><code>JWEï¼ˆRFC 7516ï¼‰ -JSON WebåŠ å¯†</code>ï¼Œæè¿°äº†ä¿æŠ¤å’Œå¤„ç†åŠ å¯† æ¶ˆæ¯ã€‚</li>
<li>JWKï¼ˆRFC 7517ï¼‰ -JSON Webå¯†é’¥ï¼Œæè¿° Javascript å¯¹è±¡ç­¾åå’ŒåŠ å¯†ä¸­åŠ å¯†å¯†é’¥çš„ æ ¼å¼å’Œå¤„ç†ã€‚</li>
<li>JWAï¼ˆRFC 7518ï¼‰ -JSON Webç®—æ³•ï¼Œæè¿°äº† Javascript å¯¹è±¡ç­¾åå’ŒåŠ å¯†ä¸­ä½¿ç”¨çš„ åŠ å¯† ç®—æ³•ã€‚</li>
<li><code>JWTï¼ˆRFC 7519ï¼‰ -JSON Webä»¤ç‰Œ</code>ï¼Œæè¿°ä»¥ JSON ç¼–ç å¹¶ç”± JWS æˆ– JWE ä¿æŠ¤çš„å£°æ˜çš„è¡¨ç¤ºå½¢å¼ã€‚</li>
</ul>
<blockquote>
<p><code>JWT</code>åˆåŒ…å«<code>JWS</code>å’Œ<code>JWE</code>ï¼Œä¸€èˆ¬ä½¿ç”¨çš„éƒ½æ˜¯åŸºäº<code>JWS</code>æ–¹å¼ï¼Œ<code>JWE</code>æ–¹æ³•æ›´åŠ å®‰å…¨ï¼Œä½†æ˜¯ä¹Ÿæ›´å¤æ‚ã€‚</p>
</blockquote>
<hr>
<h2 id="rbac">RBAC<a href="#rbac" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>ä¸»è¦åŒ…å«ä¸‰ä¸ªæ¦‚å¿µï¼Œåˆ†åˆ«æ˜¯<code>ç”¨æˆ·</code>ã€<code>è§’è‰²</code>å’Œ<code>æƒé™</code>ã€‚</p>
<ul>
<li>ç”¨æˆ·</li>
</ul>
<p>ä¸å±€é™äºå•ä¸ªç”¨æˆ·ï¼Œå¯ä»¥æ˜¯ä¸€ä¸ªç”¨æˆ·ç»„ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªéƒ¨é—¨ï¼Œåªè¦æœ‰è®¿é—®èµ„æºéœ€æ±‚çš„éƒ½å¯ä»¥ä½œä¸ºç”¨æˆ·ã€‚</p>
<ul>
<li>è§’è‰²</li>
</ul>
<p>è§’è‰²æ˜¯ç‰¹å®šæƒé™çš„é›†åˆã€‚è§’è‰²æ˜¯å¯ä»¥<code>ç»§æ‰¿ä¸åˆ†ç»„</code>çš„ï¼Œä¸€ä¸ªè§’è‰²å¯ä»¥å±äºå¤šä¸ªç”¨æˆ·ï¼Œä¸€ä¸ªç”¨æˆ·å¯ä»¥æ‹¥æœ‰å¤šä¸ªè§’è‰²ã€‚</p>
<ul>
<li>æƒé™</li>
</ul>
<p>ç²’åº¦æœ€å°çš„æƒé™å•ä½ã€‚ä¸€èˆ¬ä½“ç°åœ¨æ¥å£çš„æ§åˆ¶ä¸Šï¼ŒåŒä¸€ä¸ªæƒé™å¯ä»¥å±äºä¸åŒçš„è§’è‰²ã€‚</p>
<h3 id="åŸºäºé…ç½®çš„æƒé™">åŸºäºé…ç½®çš„æƒé™<a href="#åŸºäºé…ç½®çš„æƒé™" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>http<span style="color:#f92672">.</span><span style="color:#a6e22e">authorizeRequests</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// è¦æ±‚/admin/**è·¯å¾„çš„è¯·æ±‚å¿…é¡»æœ‰ADMINå’ŒUSERæƒé™
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">.</span><span style="color:#a6e22e">antMatchers</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/admin/**&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">access</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;hasAuthority(&#39;ADMIN&#39;) and hasAuthority(&#39;USER&#39;)&#34;</span><span style="color:#f92672">)</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// åªè¦ç”¨æˆ·æœ‰ADMINï¼ŒUSERå…¶ä¸­ä¸€ä¸ªæƒé™å³å¯
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">.</span><span style="color:#a6e22e">antMatchers</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/admin/**&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">access</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;hasAnyAuthority(&#39;ADMIN&#39;ï¼Œ&#39;USER&#39;)&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// è¦æ±‚/super/**è·¯å¾„å¿…é¡»æœ‰SUPER_ADMINæƒé™
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">.</span><span style="color:#a6e22e">antMatchers</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/super/**&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">access</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;hasAuthority(&#39;SUPER_ADMIN&#39;)&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// /helloè·¯å¾„éœ€è¦ç”±ROLE_USERçš„è§’è‰²
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">.</span><span style="color:#a6e22e">antMatchers</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/hello&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">access</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;hasRole(&#39;USER&#39;)&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// /testæ˜¯å¦æ”¾è¡Œç”±RbacService.checkPermission()è¿”å›å€¼å†³å®š
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">.</span><span style="color:#a6e22e">antMatchers</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/test&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">access</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;@rbacService.checkPermission()&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">.</span><span style="color:#a6e22e">antMatchers</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/api/**&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">anonymous</span><span style="color:#f92672">()</span> <span style="color:#75715e">// å¯ä»¥åŒ¿åç”¨æˆ·ç™»å½•
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">.</span><span style="color:#a6e22e">antMatchers</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/**&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">authenticated</span><span style="color:#f92672">()</span> <span style="color:#75715e">// æ‰€æœ‰ç”¨æˆ·éƒ½å¯ä»¥è®¿é—®ä¸éœ€è¦é‰´æƒ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">.</span><span style="color:#a6e22e">antMatchers</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/a/**&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">permitAll</span><span style="color:#f92672">()</span> <span style="color:#75715e">// å¼€æ”¾è¯·æ±‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Service</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RbacService</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">checkPermission</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">currentTimeMillis</span><span style="color:#f92672">()</span> <span style="color:#f92672">%</span> 2 <span style="color:#f92672">==</span> 0<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<ol>
<li><code>hasRole</code>å’Œ<code>hasAuthority</code>çš„åŒºåˆ«ï¼šå‰è€…ä¼šç»™è§’è‰²æ·»åŠ <code>ROLE_</code>å‰ç¼€ï¼Œåè€…ä¸ä¼šã€‚</li>
<li><code>hasAnyRole</code>å’Œ<code>hasAnyAuthority</code>è¡¨æ˜åªè¦ç”¨æˆ·æœ‰å…¶ä¸­ä¸€ç§æƒé™å°±å¯ä»¥ç™»å½•ã€‚</li>
<li><code>anonymous()</code>è¡¨æ˜ç”¨æˆ·ä¸éœ€è¦ç™»å½•ä¹Ÿå¯ä»¥è®¿é—®ï¼Œæ­¤ç”¨æˆ·é»˜è®¤æ‹¥æœ‰<code>ROLE_ANONYMOUS</code>æƒé™ã€‚</li>
<li><code>PermitAll()</code>è¡¨æ˜ä»»ä½•ç”¨æˆ·ï¼ˆåŒ¿åå’ŒéåŒ¿åï¼‰éƒ½èƒ½ç™»å½•ï¼Œ<code>anonymous()</code>è¡¨æ˜åªæœ‰åŒ¿åç”¨æˆ·ï¼ˆå·²ç™»å½•ç”¨æˆ·ä¸èƒ½ç™»å½•ï¼‰æ‰èƒ½ç™»å½•ã€‚</li>
</ol>
</blockquote>
<h3 id="åŸºäºæ³¨è§£çš„æƒé™">åŸºäºæ³¨è§£çš„æƒé™<a href="#åŸºäºæ³¨è§£çš„æƒé™" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<h4 id="å¯åŠ¨å…¨å±€æƒé™æ³¨è§£">å¯åŠ¨å…¨å±€æƒé™æ³¨è§£<a href="#å¯åŠ¨å…¨å±€æƒé™æ³¨è§£" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Retention</span><span style="color:#f92672">(</span>value <span style="color:#f92672">=</span> java<span style="color:#f92672">.</span><span style="color:#a6e22e">lang</span><span style="color:#f92672">.</span><span style="color:#a6e22e">annotation</span><span style="color:#f92672">.</span><span style="color:#a6e22e">RetentionPolicy</span><span style="color:#f92672">.</span><span style="color:#a6e22e">RUNTIME</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Target</span><span style="color:#f92672">(</span>value <span style="color:#f92672">=</span> <span style="color:#f92672">{</span> java<span style="color:#f92672">.</span><span style="color:#a6e22e">lang</span><span style="color:#f92672">.</span><span style="color:#a6e22e">annotation</span><span style="color:#f92672">.</span><span style="color:#a6e22e">ElementType</span><span style="color:#f92672">.</span><span style="color:#a6e22e">TYPE</span> <span style="color:#f92672">})</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Documented</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Import</span><span style="color:#f92672">({</span> GlobalMethodSecuritySelector<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span> <span style="color:#f92672">})</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@EnableGlobalAuthentication</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Configuration</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#a6e22e">@interface</span> EnableGlobalMethodSecurity <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// åŸºäºè¡¨è¾¾å¼è¿›è¡Œæ–¹æ³•è®¿é—®æ§åˆ¶
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">prePostEnabled</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">default</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// å¼€å¯@Securedæ³¨è§£
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">securedEnabled</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">default</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// å¼€å¯JSR-250æ³¨è§£
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">jsr250Enabled</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">default</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">proxyTargetClass</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">default</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>	AdviceMode <span style="color:#a6e22e">mode</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">default</span> AdviceMode<span style="color:#f92672">.</span><span style="color:#a6e22e">PROXY</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">order</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">default</span> Ordered<span style="color:#f92672">.</span><span style="color:#a6e22e">LOWEST_PRECEDENCE</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<ol>
<li>æ³¨è§£çš„ä¸‰ç§æ–¹å¼è¦é€‰æ‹©ä¸€ç§å¼€å¯ã€‚</li>
<li><code>EnableGlobalMethodSecurity</code>æ ¸å¿ƒé…ç½®ç±»æ˜¯<code>GlobalMethodSecurityConfiguration</code></li>
</ol>
</blockquote>
<h4 id="preauthorize">@PreAuthorize<a href="#preauthorize" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@PreAuthorize</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;hasAuthority(&#39;QUERY&#39;)&#34;</span><span style="color:#f92672">)</span>
</span></span></code></pre></div><blockquote>
<p>æ­¤æ–¹æ³•è¦æ±‚ç”¨æˆ·å…·æœ‰<code>QUERY</code>æƒé™æ‰èƒ½è®¿é—®ï¼Œå³ä½¿é…ç½®æ–‡ä»¶ä¸­æ²¡æœ‰å¯¹æ­¤è·¯å¾„çš„è®¿é—®æœ‰æƒé™è¦æ±‚ã€‚</p>
</blockquote>
<h4 id="postauthorize">@PostAuthorize<a href="#postauthorize" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@PostAuthorize</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;returnObject.name == &#39;test&#39;&#34;</span><span style="color:#f92672">)</span>
</span></span></code></pre></div><blockquote>
<p>åˆ¤æ–­å½“å‰è¿”å›çš„ç”¨æˆ·åæ˜¯å¦ä¸ºtestï¼Œåªæœ‰æ¡ä»¶æ»¡è¶³æ‰ä¼šè¿”å›ï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸ã€‚</p>
</blockquote>
<h4 id="prefilter">@PreFilter<a href="#prefilter" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@PreFilter</span><span style="color:#f92672">(</span>filterTarget <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;ids&#34;</span><span style="color:#f92672">,</span> value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;filterObject%2==0&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">delete</span><span style="color:#f92672">(</span>List<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">&gt;</span> ids<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// åªä¿ç•™å¶æ•°çš„id
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    Stream<span style="color:#f92672">.</span><span style="color:#a6e22e">of</span><span style="color:#f92672">(</span>ids<span style="color:#f92672">).</span><span style="color:#a6e22e">forEach</span><span style="color:#f92672">(</span>System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">::</span>println<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<p>å°†ä¼ å…¥çš„å‚æ•°æŒ‰ç…§æ¡ä»¶è¿›è¡Œè¿‡æ»¤</p>
</blockquote>
<h4 id="postfilter">@PostFilter<a href="#postfilter" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@PostFilter</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;filterObject.name == authentication.name&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> List<span style="color:#f92672">&lt;</span>Person<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">findOne</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    List<span style="color:#f92672">&lt;</span>Person<span style="color:#f92672">&gt;</span> persons <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>    persons<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Person<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;zhangsan&#34;</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>    persons<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Person<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;admin&#34;</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> persons<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<p>åªèƒ½è¿”å›nameä¸å½“å‰ç™»å½•ç”¨æˆ·åä¸€è‡´çš„æ•°æ®ã€‚</p>
</blockquote>
<hr>
<h2 id="securitycontextå®‰å…¨ä¸Šä¸‹æ–‡">SecurityContextå®‰å…¨ä¸Šä¸‹æ–‡<a href="#securitycontextå®‰å…¨ä¸Šä¸‹æ–‡" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>ä¸<code>å½“å‰çº¿ç¨‹</code>ç»‘å®šçš„å®‰å…¨ä¸Šä¸‹æ–‡ã€‚å¯ä»¥è·å–ç”¨æˆ·çš„ç›¸å…³ä¿¡æ¯ã€‚æˆ‘ä»¬é€šè¿‡</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>User user <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>User<span style="color:#f92672">)</span>SecurityContextHolder<span style="color:#f92672">.</span><span style="color:#a6e22e">getContext</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getAuthentication</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getPrincipal</span><span style="color:#f92672">();</span>
</span></span></code></pre></div><p>æ¥è·å–å½“å‰ç™»å½•ç”¨æˆ·ï¼ˆåŒ¿åç”¨æˆ·å°±æ˜¯<code>anonymousUser</code>å­—ç¬¦ä¸²ï¼‰çš„ç›¸å…³ä¿¡æ¯ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">SecurityContext</span> <span style="color:#66d9ef">extends</span> Serializable <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// è·å–å½“å‰çš„è®¤è¯ä¿¡æ¯ï¼Œæœ‰å¯èƒ½ä¸ºnull
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    Authentication <span style="color:#a6e22e">getAuthentication</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ç”¨äºä¿®æ”¹æˆ–åˆ é™¤å½“å‰çš„è®¤è¯ä¿¡æ¯
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setAuthentication</span><span style="color:#f92672">(</span>Authentication authentication<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// å®‰å…¨ä¸Šä¸‹æ–‡holderæŒæœ‰å®‰å…¨ä¸Šä¸‹æ–‡çš„å¼•ç”¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">SecurityContextHolderStrategy</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">clearContext</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>	SecurityContext <span style="color:#a6e22e">getContext</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setContext</span><span style="color:#f92672">(</span>SecurityContext context<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>	SecurityContext <span style="color:#a6e22e">createEmptyContext</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h3 id="securitycontextholderæºç è§£æ">SecurityContextHolderæºç è§£æ<a href="#securitycontextholderæºç è§£æ" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SecurityContextHolder</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ä¸Šä¸‹æ–‡ç­–ç•¥ç±»
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> SecurityContextHolderStrategy strategy<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String SYSTEM_PROPERTY <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;spring.security.strategy&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// è·å–ç³»ç»Ÿå˜é‡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> String strategyName <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">getProperty</span><span style="color:#f92672">(</span>SYSTEM_PROPERTY<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ç±»åŠ è½½æ—¶è¢«åˆå§‹åŒ–
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">static</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		initialize<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">initialize</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// åˆ¤æ–­å½“å‰çš„å®‰å…¨ä¸Šä¸‹æ–‡çš„å®ç°ç±»
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>StringUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">hasText</span><span style="color:#f92672">(</span>strategyName<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			strategyName <span style="color:#f92672">=</span> MODE_THREADLOCAL<span style="color:#f92672">;</span> <span style="color:#75715e">// æ²¡è®¾ç½®å°±é‡‡ç”¨æ­¤é»˜è®¤çš„
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>strategyName<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>MODE_THREADLOCAL<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			strategy <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ThreadLocalSecurityContextHolderStrategy<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// çœç•¥
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// åŠ è½½è‡ªå®šä¹‰çš„å®‰å…¨ä¸Šä¸‹æ–‡å®ç°ç±»
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>				Class<span style="color:#f92672">&lt;?&gt;</span> clazz <span style="color:#f92672">=</span> Class<span style="color:#f92672">.</span><span style="color:#a6e22e">forName</span><span style="color:#f92672">(</span>strategyName<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>				Constructor<span style="color:#f92672">&lt;?&gt;</span> customStrategy <span style="color:#f92672">=</span> clazz<span style="color:#f92672">.</span><span style="color:#a6e22e">getConstructor</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>				strategy <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>SecurityContextHolderStrategy<span style="color:#f92672">)</span> customStrategy<span style="color:#f92672">.</span><span style="color:#a6e22e">newInstance</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception ex<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>				ReflectionUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">handleReflectionException</span><span style="color:#f92672">(</span>ex<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// æ‰“å°æ—¥å¿—ç”¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		initializeCount<span style="color:#f92672">++;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h3 id="threadlocalsecuritycontextholderstrategy">ThreadLocalSecurityContextHolderStrategy<a href="#threadlocalsecuritycontextholderstrategy" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// é»˜è®¤çš„å®ç°ç±»ï¼ŒåŸºäºThreadLocalå®ç°çº¿ç¨‹éš”ç¦»ï¼Œä¸æ¸…æ¥šå¯ä»¥æŸ¥çœ‹ThreadLocalæºç 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// è¯¦è§ï¼šhttps://leejay.top/post/threadlocal%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F/
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ThreadLocalSecurityContextHolderStrategy</span> <span style="color:#66d9ef">implements</span> SecurityContextHolderStrategy <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> ThreadLocal<span style="color:#f92672">&lt;</span>SecurityContext<span style="color:#f92672">&gt;</span> contextHolder <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ThreadLocal<span style="color:#f92672">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">clearContext</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		contextHolder<span style="color:#f92672">.</span><span style="color:#a6e22e">remove</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">public</span> SecurityContext <span style="color:#a6e22e">getContext</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		SecurityContext ctx <span style="color:#f92672">=</span> contextHolder<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>         
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ctx <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			ctx <span style="color:#f92672">=</span> createEmptyContext<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>			contextHolder<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>ctx<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> ctx<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setContext</span><span style="color:#f92672">(</span>SecurityContext context<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		Assert<span style="color:#f92672">.</span><span style="color:#a6e22e">notNull</span><span style="color:#f92672">(</span>context<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Only non-null SecurityContext instances are permitted&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		contextHolder<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>context<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">public</span> SecurityContext <span style="color:#a6e22e">createEmptyContext</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> SecurityContextImpl<span style="color:#f92672">();</span> <span style="color:#75715e">// è°ƒç”¨SecurityContexté»˜è®¤å®ç°ç±»è®¾ç½®æƒé™ç›¸å…³
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h3 id="securitycontextimpl">SecurityContextImpl<a href="#securitycontextimpl" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SecurityContextImpl</span> <span style="color:#66d9ef">implements</span> SecurityContext <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> Authentication authentication<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">public</span> <span style="color:#a6e22e">SecurityContextImpl</span><span style="color:#f92672">()</span> <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">public</span> <span style="color:#a6e22e">SecurityContextImpl</span><span style="color:#f92672">(</span>Authentication authentication<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">authentication</span> <span style="color:#f92672">=</span> authentication<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setAuthentication</span><span style="color:#f92672">(</span>Authentication authentication<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">authentication</span> <span style="color:#f92672">=</span> authentication<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<p>åœ¨Filterè¿‡æ»¤å™¨å¤„ç†ä¸­ä¼šè®¾ç½®<code>Authentication</code>åˆ°<code>SecurityContextImpl</code>ä¸­ã€‚</p>
</blockquote>
<hr>
<h2 id="åŠ¨æ€æƒé™">åŠ¨æ€æƒé™<a href="#åŠ¨æ€æƒé™" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p><code>FilterSecurityInterceptor </code>è´Ÿè´£Spring Securityä¸­çš„æƒé™æ§åˆ¶ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">FilterSecurityInterceptor</span> <span style="color:#66d9ef">extends</span> AbstractSecurityInterceptor <span style="color:#66d9ef">implements</span>
</span></span><span style="display:flex;"><span>		Filter <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> FilterInvocationSecurityMetadataSource securityMetadataSource<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">doFilter</span><span style="color:#f92672">(</span>ServletRequest request<span style="color:#f92672">,</span> ServletResponse response<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>			FilterChain chain<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> IOException<span style="color:#f92672">,</span> ServletException <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// å°†å½“å‰çš„è¯·æ±‚å“åº”åŠè¿‡æ»¤å™¨é“¾æ„å»ºæˆFilterInvocationï¼ˆå³ä¸Httpç›¸å…³è¿çš„å¯¹è±¡ï¼‰
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		FilterInvocation fi <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> FilterInvocation<span style="color:#f92672">(</span>request<span style="color:#f92672">,</span> response<span style="color:#f92672">,</span> chain<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		invoke<span style="color:#f92672">(</span>fi<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">invoke</span><span style="color:#f92672">(</span>FilterInvocation fi<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> IOException<span style="color:#f92672">,</span> ServletException <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// åˆ¤æ–­æ˜¯å¦æœ‰æ ‡è®°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>fi<span style="color:#f92672">.</span><span style="color:#a6e22e">getRequest</span><span style="color:#f92672">()</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">(</span>fi<span style="color:#f92672">.</span><span style="color:#a6e22e">getRequest</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getAttribute</span><span style="color:#f92672">(</span>FILTER_APPLIED<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">&amp;&amp;</span> observeOncePerRequest<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			fi<span style="color:#f92672">.</span><span style="color:#a6e22e">getChain</span><span style="color:#f92672">().</span><span style="color:#a6e22e">doFilter</span><span style="color:#f92672">(</span>fi<span style="color:#f92672">.</span><span style="color:#a6e22e">getRequest</span><span style="color:#f92672">(),</span> fi<span style="color:#f92672">.</span><span style="color:#a6e22e">getResponse</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// ç»™è¯·æ±‚åŠ æ ‡è®°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>fi<span style="color:#f92672">.</span><span style="color:#a6e22e">getRequest</span><span style="color:#f92672">()</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> observeOncePerRequest<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>				fi<span style="color:#f92672">.</span><span style="color:#a6e22e">getRequest</span><span style="color:#f92672">().</span><span style="color:#a6e22e">setAttribute</span><span style="color:#f92672">(</span>FILTER_APPLIED<span style="color:#f92672">,</span> Boolean<span style="color:#f92672">.</span><span style="color:#a6e22e">TRUE</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// æ ¸å¿ƒä»£ç 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			InterceptorStatusToken token <span style="color:#f92672">=</span> <span style="color:#66d9ef">super</span><span style="color:#f92672">.</span><span style="color:#a6e22e">beforeInvocation</span><span style="color:#f92672">(</span>fi<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>				fi<span style="color:#f92672">.</span><span style="color:#a6e22e">getChain</span><span style="color:#f92672">().</span><span style="color:#a6e22e">doFilter</span><span style="color:#f92672">(</span>fi<span style="color:#f92672">.</span><span style="color:#a6e22e">getRequest</span><span style="color:#f92672">(),</span> fi<span style="color:#f92672">.</span><span style="color:#a6e22e">getResponse</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">super</span><span style="color:#f92672">.</span><span style="color:#a6e22e">finallyInvocation</span><span style="color:#f92672">(</span>token<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">super</span><span style="color:#f92672">.</span><span style="color:#a6e22e">afterInvocation</span><span style="color:#f92672">(</span>token<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AbstractSecurityInterceptor</span> <span style="color:#66d9ef">implements</span> InitializingBean<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>		ApplicationEventPublisherAware<span style="color:#f92672">,</span> MessageSourceAware <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">protected</span> InterceptorStatusToken <span style="color:#a6e22e">beforeInvocation</span><span style="color:#f92672">(</span>Object object<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// è·å–å½“å‰urlå¯¹åº”çš„æƒé™
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		Collection<span style="color:#f92672">&lt;</span>ConfigAttribute<span style="color:#f92672">&gt;</span> attributes <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">obtainSecurityMetadataSource</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">.</span><span style="color:#a6e22e">getAttributes</span><span style="color:#f92672">(</span>object<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// çœç•¥
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// é‡è¦ï¼
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// å¯¹å½“å‰ç”¨æˆ·çš„æƒé™å’Œéœ€è¦çš„æƒé™è¿›è¡ŒæŠ•ç¥¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">accessDecisionManager</span><span style="color:#f92672">.</span><span style="color:#a6e22e">decide</span><span style="color:#f92672">(</span>authenticated<span style="color:#f92672">,</span> object<span style="color:#f92672">,</span> attributes<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>AccessDeniedException accessDeniedException<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">throw</span> accessDeniedException<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// çœç•¥
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<ol>
<li>é€šè¿‡åˆ›å»º<code>FilterInvocationSecurityMetadataSource</code>å®ç°ç±»æŒ‡å®šå½“å‰urlçš„æƒé™æ˜¯ä»€ä¹ˆã€‚</li>
<li>é€šè¿‡åˆ›å»º<code>AccessDecisionManager</code>çš„å®ç°ç±»æŒ‡å®šå†³ç­–ç®¡ç†å™¨ç­–ç•¥ã€‚</li>
</ol>
</blockquote>
<h3 id="å®‰å…¨æƒé™æ•°æ®æº">å®‰å…¨æƒé™æ•°æ®æº<a href="#å®‰å…¨æƒé™æ•°æ®æº" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<h4 id="è‡ªå®šä¹‰æƒé™æ•°æ®æº">è‡ªå®šä¹‰æƒé™æ•°æ®æº<a href="#è‡ªå®šä¹‰æƒé™æ•°æ®æº" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UrlFilterInvocationSecurityMetadataSource</span> <span style="color:#66d9ef">implements</span> FilterInvocationSecurityMetadataSource <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Collection<span style="color:#f92672">&lt;</span>ConfigAttribute<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">getAttributes</span><span style="color:#f92672">(</span>Object object<span style="color:#f92672">)</span> 
</span></span><span style="display:flex;"><span>        								<span style="color:#66d9ef">throws</span> IllegalArgumentException <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// FilterInvocationæ˜¯ä¸httpå¯¹è±¡ç›¸å…³è”
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        FilterInvocation f <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>FilterInvocation<span style="color:#f92672">)</span> object<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        String url <span style="color:#f92672">=</span> f<span style="color:#f92672">.</span><span style="color:#a6e22e">getRequestUrl</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>url<span style="color:#f92672">.</span><span style="color:#a6e22e">contains</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/login&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">||</span> url<span style="color:#f92672">.</span><span style="color:#a6e22e">contains</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/logout&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// æ­¤å¤„å¤„ç†åŠ¨æ€æƒé™
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span> SecurityConfig<span style="color:#f92672">.</span><span style="color:#a6e22e">createList</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;ADMIN&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;QUERY&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Collection<span style="color:#f92672">&lt;</span>ConfigAttribute<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">getAllConfigAttributes</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">supports</span><span style="color:#f92672">(</span>Class<span style="color:#f92672">&lt;?&gt;</span> clazz<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<p>æ­¤å¤„åªæ˜¯æ¨¡æ‹Ÿèµ‹äºˆurlçš„æƒé™æ“ä½œï¼Œå®é™…ä¸šåŠ¡å¯èƒ½ä»æ•°æ®åº“æˆ–å…¶ä»–ç¬¬ä¸‰æ–¹è·å–ã€‚</p>
</blockquote>
<h3 id="æŠ•ç¥¨æ¨¡å‹">æŠ•ç¥¨æ¨¡å‹<a href="#æŠ•ç¥¨æ¨¡å‹" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<h4 id="è‡ªå®šä¹‰accessdecisionmanager">è‡ªå®šä¹‰AccessDecisionManager<a href="#è‡ªå®šä¹‰accessdecisionmanager" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">AccessDecisionManager</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// å†³ç­–çš„æ ¸å¿ƒæ–¹æ³•
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">decide</span><span style="color:#f92672">(</span>Authentication authentication<span style="color:#f92672">,</span> Object object<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>			Collection<span style="color:#f92672">&lt;</span>ConfigAttribute<span style="color:#f92672">&gt;</span> configAttributes<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> AccessDeniedException<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>			InsufficientAuthenticationException<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">supports</span><span style="color:#f92672">(</span>ConfigAttribute attribute<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">supports</span><span style="color:#f92672">(</span>Class<span style="color:#f92672">&lt;?&gt;</span> clazz<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// è‡ªå®šä¹‰å†³ç­–ç®¡ç†å™¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UrlAccessDecisionManager</span> <span style="color:#66d9ef">implements</span> AccessDecisionManager <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">decide</span><span style="color:#f92672">(</span>Authentication authentication<span style="color:#f92672">,</span> Object object<span style="color:#f92672">,</span> Collection<span style="color:#f92672">&lt;</span>ConfigAttribute<span style="color:#f92672">&gt;</span> configAttributes<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> AccessDeniedException<span style="color:#f92672">,</span> InsufficientAuthenticationException <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>ConfigAttribute configAttribute <span style="color:#f92672">:</span> configAttributes<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// æœªç™»å½•ROLE_ANONYMOUSè§’è‰²
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>authentication <span style="color:#66d9ef">instanceof</span> AnonymousAuthenticationToken<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> BadCredentialsException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;æœªç™»å½•!&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// â‘  å½“å‰urlè¯·æ±‚éœ€è¦çš„æƒé™
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            String role <span style="color:#f92672">=</span> configAttribute<span style="color:#f92672">.</span><span style="color:#a6e22e">getAttribute</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// â‘¡ å½“å‰ç”¨æˆ·æ‰€å…·æœ‰çš„è§’è‰²
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            Collection<span style="color:#f92672">&lt;?</span> <span style="color:#66d9ef">extends</span> GrantedAuthority<span style="color:#f92672">&gt;</span> authorities 
</span></span><span style="display:flex;"><span>                						<span style="color:#f92672">=</span> authentication<span style="color:#f92672">.</span><span style="color:#a6e22e">getAuthorities</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>GrantedAuthority authority <span style="color:#f92672">:</span> authorities<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// åªè¦åŒ…å«å…¶ä¸­ä¸€ä¸ªè§’è‰²å³å¯è®¿é—®
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>authority<span style="color:#f92672">.</span><span style="color:#a6e22e">getAuthority</span><span style="color:#f92672">().</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>role<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> AccessDeniedException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;è¯·è”ç³»ç®¡ç†å‘˜åˆ†é…æƒé™ï¼&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<ol>
<li><code>AffirmativeBased </code>åŸºäºè‚¯å®šçš„å†³ç­–å™¨ã€‚ ç”¨æˆ·æŒæœ‰ä¸€ä¸ªåŒæ„è®¿é—®çš„è§’è‰²å°±èƒ½é€šè¿‡ã€‚</li>
<li><code>ConsensusBased</code>åŸºäºå…±è¯†çš„å†³ç­–å™¨ã€‚ ç”¨æˆ·æŒæœ‰åŒæ„çš„è§’è‰²æ•°é‡å¤šäºç¦æ­¢çš„è§’è‰²æ•°ã€‚</li>
<li><code>UnanimousBased</code> åŸºäºä¸€è‡´çš„å†³ç­–å™¨ã€‚ ç”¨æˆ·æŒæœ‰çš„æ‰€æœ‰è§’è‰²éƒ½åŒæ„è®¿é—®æ‰èƒ½æ”¾è¡Œã€‚</li>
</ol>
</blockquote>
<h4 id="è‡ªå®šä¹‰accessdecisionvoter">è‡ªå®šä¹‰AccessDecisionVoter<a href="#è‡ªå®šä¹‰accessdecisionvoter" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p><code>AccessDecisionManager</code>çš„å®ç°ç±»ä¸­æ”¯æŒ<code>List&lt;AccessDecisionVoter&lt;?&gt;&gt; decisionVoters</code>ä½œä¸ºå‚æ•°ä¼ å…¥ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡åˆ›å»º<code>AccessDecisionVoter</code>çš„å®ç°ç±»åˆ›å»ºè‡ªå®šä¹‰æŠ•ç¥¨å™¨ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">AccessDecisionVoter</span><span style="color:#f92672">&lt;</span>S<span style="color:#f92672">&gt;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span> ACCESS_GRANTED <span style="color:#f92672">=</span> 1<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span> ACCESS_ABSTAIN <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span> ACCESS_DENIED <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>1<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ç”¨äºåˆ¤æ–­æ˜¯å¦æˆäºˆè®¿é—®æƒé™
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">vote</span><span style="color:#f92672">(</span>Authentication authentication<span style="color:#f92672">,</span> S object<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>			Collection<span style="color:#f92672">&lt;</span>ConfigAttribute<span style="color:#f92672">&gt;</span> attributes<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">supports</span><span style="color:#f92672">(</span>ConfigAttribute attribute<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">supports</span><span style="color:#f92672">(</span>Class<span style="color:#f92672">&lt;?&gt;</span> clazz<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h3 id="å¼‚å¸¸æ§åˆ¶å™¨">å¼‚å¸¸æ§åˆ¶å™¨<a href="#å¼‚å¸¸æ§åˆ¶å™¨" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<h4 id="æœªç™»å½•å¼‚å¸¸æ§åˆ¶å™¨">æœªç™»å½•å¼‚å¸¸æ§åˆ¶å™¨<a href="#æœªç™»å½•å¼‚å¸¸æ§åˆ¶å™¨" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AdminAuthenticationEntryPoint</span> <span style="color:#66d9ef">implements</span> AuthenticationEntryPoint <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">commence</span><span style="color:#f92672">(</span>HttpServletRequest request<span style="color:#f92672">,</span> 
</span></span><span style="display:flex;"><span>                         HttpServletResponse response<span style="color:#f92672">,</span> 
</span></span><span style="display:flex;"><span>                         AuthenticationException authException<span style="color:#f92672">)</span> 
</span></span><span style="display:flex;"><span>        									<span style="color:#66d9ef">throws</span> IOException<span style="color:#f92672">,</span> ServletException <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        response<span style="color:#f92672">.</span><span style="color:#a6e22e">setHeader</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Content-type&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;text/html;charset=UTF-8&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        response<span style="color:#f92672">.</span><span style="color:#a6e22e">getWriter</span><span style="color:#f92672">().</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span>ResponseBody<span style="color:#f92672">.</span><span style="color:#a6e22e">error</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;æ‚¨éœ€è¦ç™»å½•ï¼&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>        response<span style="color:#f92672">.</span><span style="color:#a6e22e">flushBuffer</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<p>å¤„ç†æœªç™»å½•æƒ…å†µä¸‹æ‰€æœ‰è®¿é—®çš„æ¥å£ï¼ˆæ”¾è¡Œé™¤å¤–ï¼‰</p>
</blockquote>
<h4 id="æ— æƒé™å¼‚å¸¸æ§åˆ¶å™¨">æ— æƒé™å¼‚å¸¸æ§åˆ¶å™¨<a href="#æ— æƒé™å¼‚å¸¸æ§åˆ¶å™¨" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UrlAccessDeniedHandler</span> <span style="color:#66d9ef">implements</span> AccessDeniedHandler <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">handle</span><span style="color:#f92672">(</span>HttpServletRequest request<span style="color:#f92672">,</span> 
</span></span><span style="display:flex;"><span>                       HttpServletResponse response<span style="color:#f92672">,</span> 
</span></span><span style="display:flex;"><span>                       AccessDeniedException accessDeniedException<span style="color:#f92672">)</span> 
</span></span><span style="display:flex;"><span>        								<span style="color:#66d9ef">throws</span> IOException<span style="color:#f92672">,</span> ServletException <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        response<span style="color:#f92672">.</span><span style="color:#a6e22e">setHeader</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Content-type&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;text/html;charset=UTF-8&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        response<span style="color:#f92672">.</span><span style="color:#a6e22e">getWriter</span><span style="color:#f92672">().</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span>ResponseBody<span style="color:#f92672">.</span><span style="color:#a6e22e">error</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;æ‚¨æ— æ­¤æƒé™ï¼&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>        response<span style="color:#f92672">.</span><span style="color:#a6e22e">flushBuffer</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<p>å¤„ç†ç™»å½•åæ²¡æœ‰æƒé™è®¿é—®çš„è·¯å¾„</p>
</blockquote>
<h3 id="spring-security-config">Spring Security config<a href="#spring-security-config" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Configuration</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">PermissionSecurityConfig</span> <span style="color:#66d9ef">extends</span> WebSecurityConfigurerAdapter <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">configure</span><span style="color:#f92672">(</span>HttpSecurity http<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        ExpressionUrlAuthorizationConfigurer<span style="color:#f92672">&lt;</span>HttpSecurity<span style="color:#f92672">&gt;.</span><span style="color:#a6e22e">ExpressionInterceptUrlRegistry</span> 									registry <span style="color:#f92672">=</span> http<span style="color:#f92672">.</span><span style="color:#a6e22e">antMatcher</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/**&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">authorizeRequests</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        http<span style="color:#f92672">.</span><span style="color:#a6e22e">csrf</span><span style="color:#f92672">().</span><span style="color:#a6e22e">disable</span><span style="color:#f92672">().</span><span style="color:#a6e22e">cors</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// æœªç™»å½•è®¤è¯å¼‚å¸¸
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        http<span style="color:#f92672">.</span><span style="color:#a6e22e">exceptionHandling</span><span style="color:#f92672">().</span><span style="color:#a6e22e">authenticationEntryPoint</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> AdminAuthenticationEntryPoint<span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// ç™»å½•è¿‡åè®¿é—®æ— æƒé™çš„æ¥å£æ—¶è‡ªå®šä¹‰403å“åº”å†…å®¹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        http<span style="color:#f92672">.</span><span style="color:#a6e22e">exceptionHandling</span><span style="color:#f92672">().</span><span style="color:#a6e22e">accessDeniedHandler</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> UrlAccessDeniedHandler<span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>        registry<span style="color:#f92672">.</span><span style="color:#a6e22e">withObjectPostProcessor</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> ObjectPostProcessor<span style="color:#f92672">&lt;</span>FilterSecurityInterceptor<span style="color:#f92672">&gt;()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">public</span> <span style="color:#f92672">&lt;</span>O <span style="color:#66d9ef">extends</span> FilterSecurityInterceptor<span style="color:#f92672">&gt;</span> O <span style="color:#a6e22e">postProcess</span><span style="color:#f92672">(</span>O object<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                object<span style="color:#f92672">.</span><span style="color:#a6e22e">setSecurityMetadataSource</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">new</span> UrlFilterInvocationSecurityMetadataSource<span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>                object<span style="color:#f92672">.</span><span style="color:#a6e22e">setAccessDecisionManager</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">new</span> UrlAccessDecisionManager<span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> object<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">});</span>
</span></span><span style="display:flex;"><span>        registry
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">.</span><span style="color:#a6e22e">antMatchers</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/hello&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">hasAuthority</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;ADMIN&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">.</span><span style="color:#a6e22e">antMatchers</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/test&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">anonymous</span><span style="color:#f92672">();</span>  <span style="color:#75715e">// helloè¿˜éœ€è¦æƒé™ï¼Œå…¶ä»–çš„ä¸éœ€è¦äº†
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">super</span><span style="color:#f92672">.</span><span style="color:#a6e22e">configure</span><span style="color:#f92672">(</span>http<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<p>è¿™é‡Œæ˜¯é€šè¿‡<code>ObjectPostProcessor</code>è®¾ç½®<code>FilterSecurityInterceptor</code>çš„å‚æ•°æ³¨å…¥åˆ°å®¹å™¨ä¸­çš„ã€‚ä¹‹å‰æœ‰æåˆ°è¿‡ï¼Œ<code>ObjectPostProcessor</code>å¯ä»¥å°†newå‡ºæ¥çš„å¯¹è±¡åŠ å…¥å®¹å™¨ä¸­ã€‚</p>
</blockquote>

      </div></div>

  
  
<div class="pagination">
    <div class="pagination__title">
        <span class="pagination__title-h">å…¶ä»–æ–‡ç« </span>
        <hr />
    </div>
    <div class="pagination__buttons">
        
        <span class="button previous">
            <a href="https://leejay.top/post/hashmap%E7%9A%84%E5%87%A0%E7%82%B9%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9/">
                <span class="button__icon">â†</span>
                <span class="button__text">HashMapçš„å‡ ç‚¹æ³¨æ„äº‹é¡¹</span>
            </a>
        </span>
        
        
        <span class="button next">
            <a href="https://leejay.top/post/redis%E4%BA%8C%E6%8C%81%E4%B9%85%E5%8C%96%E4%B8%8E%E5%A4%8D%E5%88%B6/">
                <span class="button__text">Redisï¼ˆäºŒï¼‰æŒä¹…åŒ–ä¸å¤åˆ¶</span>
                <span class="button__icon">â†’</span>
            </a>
        </span>
        
    </div>
</div>

  

  

</div>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright copyright--user">
        <span>è‹ICPå¤‡18050258å·</span>
    
        
      </div>
  </div>
</footer>

<script src="https://leejay.top/assets/main.js"></script>
<script src="https://leejay.top/assets/prism.js"></script>






  
</div>

</body>
</html>
