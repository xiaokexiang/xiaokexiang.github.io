<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>Spring Security框架入门与源码解析 :: Keep Improving</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Spring Security入门 依赖与配置 maven依赖 &amp;lt;dependency&amp;gt; &amp;lt;groupId&amp;gt;org.springframework.boot&amp;lt;/groupId&amp;gt; &amp;lt;artifactId&amp;gt;spring-boot-starter-security&amp;lt;/artifactId&amp;gt; &amp;lt;/dependency&amp;gt; &amp;lt;dependency&amp;gt; &amp;lt;groupId&amp;gt;org.springframework.boot&amp;lt;/groupId&amp;gt; &amp;lt;artifactId&amp;gt;spring-boot-starter-web&amp;lt;/artifactId&amp;gt; &amp;lt;/dependency&amp;gt; Spring Security配置 @Configuration public class WebSecurityConfig extends WebSecurityConfigurerAdapter { /** * 自定义用户管理系统 */ @Bean public UserDetailsManager userDetailsManager() { UserManager userManager = new UserManager(); userManager.createUser(innerUser()); return userManager; } private UserDetails innerUser() { // load user by username 模拟从数据库获取用户权限等信息 List&amp;lt;GrantedAuthority&amp;gt; authorities = new ArrayList&amp;lt;&amp;gt;(); // 添加 ADMIN &amp;amp; USER 权限 authorities.add(new SimpleGrantedAuthority(&amp;#34;USER&amp;#34;)); authorities.add(new SimpleGrantedAuthority(&amp;#34;ADMIN&amp;#34;)); // 一般数据库用户密码存入时会先加密，此处只是模拟加密后的用户信息 // 使用UserDetails.User$UserBuilder构建user return User.withUsername(&amp;#34;jack&amp;#34;) ." />
<meta name="keywords" content="" />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://leejay.top/post/spring-security%E6%A1%86%E6%9E%B6%E5%85%A5%E9%97%A8%E4%B8%8E%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" />




<link rel="stylesheet" href="https://leejay.top/assets/style.css">






<link rel="apple-touch-icon" href="https://leejay.top/img/favicon.png">

  <link rel="shortcut icon" href="https://leejay.top/img/favicon.png">



<meta name="twitter:card" content="summary" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Spring Security框架入门与源码解析">
<meta property="og:description" content="Spring Security作为Java Web的安全框架，用于实现安全控制。" />
<meta property="og:url" content="https://leejay.top/post/spring-security%E6%A1%86%E6%9E%B6%E5%85%A5%E9%97%A8%E4%B8%8E%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" />
<meta property="og:site_name" content="Keep Improving" />

  
    <meta property="og:image" content="https://leejay.top/img/favicon.png">
  

<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">

  <meta property="article:section" content="Java" />


  <meta property="article:published_time" content="2021-03-19 17:47:21 &#43;0800 &#43;0800" />










<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fira+Code">

</head>
<body class="orange">


<div class="container center headings--one-size">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="https://leejay.top">
  <div class="logo">
    HelloWorld
  </div>
</a>

    </div>
    
  </div>
  
  
  <script type="text/javascript"
        async
        src="https://cdn.bootcss.com/mathjax/2.7.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\[\[','\]\]']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
});

MathJax.Hub.Queue(function() {
    
    
    
    var all = MathJax.Hub.getAllJax(), i;
    for(i = 0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
});
</script>

<style>
code.has-jax {
    font: inherit;
    font-size: 100%;
    background: inherit;
    border: inherit;
    color: #515151;
}
</style>

</header>


  <div class="content">
    
<div class="post">
  
  
    









<div class="toc" id="toc_id">

    <div class="page-header"><strong>- CATALOG -</strong></div>

    <div id="page-scrollspy" class="toc-nav">

        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#spring-security%e5%85%a5%e9%97%a8">
                    Spring Security入门
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e4%be%9d%e8%b5%96%e4%b8%8e%e9%85%8d%e7%bd%ae">
                    依赖与配置
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#maven%e4%be%9d%e8%b5%96">
                    maven依赖
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#spring-security%e9%85%8d%e7%bd%ae">
                    Spring Security配置
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e7%94%a8%e6%88%b7%e6%8e%a5%e5%8f%a3%e4%b8%8e%e7%bc%96%e7%a0%81%e5%99%a8">
                    用户接口与编码器
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e8%8e%b7%e5%8f%96%e7%94%a8%e6%88%b7%e4%bf%a1%e6%81%af">
                    获取用户信息
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#passwordencoder%e7%bc%96%e7%a0%81%e5%99%a8">
                    PasswordEncoder编码器
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e8%87%aa%e5%8a%a8%e9%85%8d%e7%bd%ae">
                    自动配置
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#securityautoconfiguration">
                    SecurityAutoConfiguration
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#springbootwebsecurityconfiguration">
                    SpringBootWebSecurityConfiguration
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#websecurityenablerconfiguration">
                    WebSecurityEnablerConfiguration
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#securityfilterautoconfiguration">
                    SecurityFilterAutoConfiguration
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#delegatingfilterproxyregistrationbean">
                    DelegatingFilterProxyRegistrationBean
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e8%87%aa%e5%ae%9a%e4%b9%89%e9%85%8d%e7%bd%ae">
                    自定义配置
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#httpsecurity%e5%85%a5%e9%97%a8">
                    HttpSecurity入门
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#authenticationmanager%e6%ba%90%e7%a0%81%e8%a7%a3%e6%9e%90">
                    AuthenticationManager源码解析
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#usernamepasswordauthenticationfilter">
                    UsernamePasswordAuthenticationFilter
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#abstractauthenticationprocessingfilter">
                    AbstractAuthenticationProcessingFilter
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#authenticationmanager%e5%88%9d%e5%a7%8b%e5%8c%96%e6%b5%81%e7%a8%8b">
                    AuthenticationManager初始化流程🔒
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#1-securityautoconfiguration">
                    1. SecurityAutoConfiguration
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#2-websecurityconfiguration">
                    2. WebSecurityConfiguration
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#3--enableglobalauthentication">
                    3. @EnableGlobalAuthentication🎈
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#4-websecurityconfigureradapter">
                    4. WebSecurityConfigurerAdapter
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#5-providemanager">
                    5. ProvideManager
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#6-%e6%b5%81%e7%a8%8b%e5%9b%be%e6%80%bb%e7%bb%93">
                    6. 流程图总结
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#filter">
                    Filter
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#spring-security%e5%86%85%e7%bd%ae%e8%bf%87%e6%bb%a4%e5%99%a8">
                    Spring Security内置过滤器
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#filter%e6%89%a7%e8%a1%8c%e9%a1%ba%e5%ba%8f">
                    Filter执行顺序
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e5%86%85%e7%bd%ae%e8%bf%87%e6%bb%a4%e5%99%a8">
                    内置过滤器
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#spring-security%e8%bf%87%e6%bb%a4%e5%99%a8%e9%93%be">
                    Spring Security过滤器链
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#jwtjson-web-token">
                    JWT(Json Web Token)
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#rbac">
                    RBAC
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e5%9f%ba%e4%ba%8e%e9%85%8d%e7%bd%ae%e7%9a%84%e6%9d%83%e9%99%90">
                    基于配置的权限
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e5%9f%ba%e4%ba%8e%e6%b3%a8%e8%a7%a3%e7%9a%84%e6%9d%83%e9%99%90">
                    基于注解的权限
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e5%90%af%e5%8a%a8%e5%85%a8%e5%b1%80%e6%9d%83%e9%99%90%e6%b3%a8%e8%a7%a3">
                    启动全局权限注解
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#preauthorize">
                    @PreAuthorize
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#postauthorize">
                    @PostAuthorize
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#prefilter">
                    @PreFilter
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#postfilter">
                    @PostFilter
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#securitycontext%e5%ae%89%e5%85%a8%e4%b8%8a%e4%b8%8b%e6%96%87">
                    SecurityContext安全上下文
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#securitycontextholder%e6%ba%90%e7%a0%81%e8%a7%a3%e6%9e%90">
                    SecurityContextHolder源码解析
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#threadlocalsecuritycontextholderstrategy">
                    ThreadLocalSecurityContextHolderStrategy
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#securitycontextimpl">
                    SecurityContextImpl
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e5%8a%a8%e6%80%81%e6%9d%83%e9%99%90">
                    动态权限
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e5%ae%89%e5%85%a8%e6%9d%83%e9%99%90%e6%95%b0%e6%8d%ae%e6%ba%90">
                    安全权限数据源
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e8%87%aa%e5%ae%9a%e4%b9%89%e6%9d%83%e9%99%90%e6%95%b0%e6%8d%ae%e6%ba%90">
                    自定义权限数据源
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e6%8a%95%e7%a5%a8%e6%a8%a1%e5%9e%8b">
                    投票模型
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e8%87%aa%e5%ae%9a%e4%b9%89accessdecisionmanager">
                    自定义AccessDecisionManager
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e8%87%aa%e5%ae%9a%e4%b9%89accessdecisionvoter">
                    自定义AccessDecisionVoter
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e5%bc%82%e5%b8%b8%e6%8e%a7%e5%88%b6%e5%99%a8">
                    异常控制器
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e6%9c%aa%e7%99%bb%e5%bd%95%e5%bc%82%e5%b8%b8%e6%8e%a7%e5%88%b6%e5%99%a8">
                    未登录异常控制器
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e6%97%a0%e6%9d%83%e9%99%90%e5%bc%82%e5%b8%b8%e6%8e%a7%e5%88%b6%e5%99%a8">
                    无权限异常控制器
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#spring-security-config">
                    Spring Security config
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        

    </div>

</div>



  
  <h1 class="post-title">
    <a href="https://leejay.top/post/spring-security%E6%A1%86%E6%9E%B6%E5%85%A5%E9%97%A8%E4%B8%8E%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/">Spring Security框架入门与源码解析</a></h1>
  <div class="post-meta">
    
      <span class="post-date">
        2021-03-19 
      </span>
    
    
  </div>

  
  <span class="post-tags">
    
    #<a href="https://leejay.top/tags/spring-security/">Spring Security</a>&nbsp;
    
  </span>
  

  

  

  <div class="post-content"><div>
        <h2 id="spring-security入门">Spring Security入门<a href="#spring-security入门" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<h3 id="依赖与配置">依赖与配置<a href="#依赖与配置" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<h4 id="maven依赖">maven依赖<a href="#maven依赖" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-starter-security<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-starter-web<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span></code></pre></div><h4 id="spring-security配置">Spring Security配置<a href="#spring-security配置" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Configuration</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">WebSecurityConfig</span> <span style="color:#66d9ef">extends</span> WebSecurityConfigurerAdapter <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 自定义用户管理系统
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> UserDetailsManager <span style="color:#a6e22e">userDetailsManager</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        UserManager userManager <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> UserManager<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        userManager<span style="color:#f92672">.</span><span style="color:#a6e22e">createUser</span><span style="color:#f92672">(</span>innerUser<span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> userManager<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> UserDetails <span style="color:#a6e22e">innerUser</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// load user by username 模拟从数据库获取用户权限等信息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        List<span style="color:#f92672">&lt;</span>GrantedAuthority<span style="color:#f92672">&gt;</span> authorities <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 添加 ADMIN &amp; USER 权限
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        authorities<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> SimpleGrantedAuthority<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;USER&#34;</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>        authorities<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> SimpleGrantedAuthority<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;ADMIN&#34;</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 一般数据库用户密码存入时会先加密，此处只是模拟加密后的用户信息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// 使用UserDetails.User$UserBuilder构建user
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span> User<span style="color:#f92672">.</span><span style="color:#a6e22e">withUsername</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;jack&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">.</span><span style="color:#a6e22e">passwordEncoder</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> BCryptPasswordEncoder<span style="color:#f92672">()::</span>encode<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">.</span><span style="color:#a6e22e">password</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;jack&#34;</span><span style="color:#f92672">)</span> <span style="color:#75715e">// 如果不开启加密，那么需要去除passwordEncoder，密码变成&#34;{noop}jack&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#75715e">// AuthorityUtils.NO_AUTHORITIES
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#f92672">.</span><span style="color:#a6e22e">authorities</span><span style="color:#f92672">(</span>authorities<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">.</span><span style="color:#a6e22e">build</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">configure</span><span style="color:#f92672">(</span>HttpSecurity http<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// login页面登录成功后重定向地址（如果是successfulForwardUrl则是转发）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        http<span style="color:#f92672">.</span><span style="color:#a6e22e">formLogin</span><span style="color:#f92672">().</span><span style="color:#a6e22e">defaultSuccessUrl</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;http://www.baidu.com&#34;</span><span style="color:#f92672">)</span> 
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">.</span><span style="color:#a6e22e">and</span><span style="color:#f92672">().</span><span style="color:#a6e22e">authorizeRequests</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">.</span><span style="color:#a6e22e">antMatchers</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/hello&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;/json&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">access</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;hasAuthority(&#39;USER&#39;)&#34;</span><span style="color:#f92672">)</span> <span style="color:#75715e">// SPEL表达式
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#f92672">.</span><span style="color:#a6e22e">antMatchers</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/admin/**&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">access</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;hasAuthority(&#39;ADMIN&#39;) and hasAuthority(&#39;USER&#39;)&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">.</span><span style="color:#a6e22e">antMatchers</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/super/**&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">access</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;hasAuthority(&#39;SUPER_ADMIN&#39;)&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 使用自定义类实现校验,false就需要登录
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#f92672">.</span><span style="color:#a6e22e">antMatchers</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/test&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">access</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;@rbacService.checkPermission()&#34;</span><span style="color:#f92672">)</span> 
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">.</span><span style="color:#a6e22e">antMatchers</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/**&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">authenticated</span><span style="color:#f92672">()</span> <span style="color:#75715e">// 只要是登录用户都可以访问（不需要查验权限之类）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#f92672">.</span><span style="color:#a6e22e">and</span><span style="color:#f92672">().</span><span style="color:#a6e22e">csrf</span><span style="color:#f92672">()</span> <span style="color:#75715e">// 添加csrf的支持
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#75715e">// 返回json信息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#f92672">.</span><span style="color:#a6e22e">and</span><span style="color:#f92672">().</span><span style="color:#a6e22e">exceptionHandling</span><span style="color:#f92672">().</span><span style="color:#a6e22e">accessDeniedHandler</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> JsonAccessDeniedHandler<span style="color:#f92672">());</span> 
</span></span><span style="display:flex;"><span>        	<span style="color:#75715e">// hasRole 和 hasAuthority的区别，前者会拼接&#39;ROLE_&#39;前缀，后者不会
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>     <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">configure</span><span style="color:#f92672">(</span>AuthenticationManagerBuilder auth<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>         auth<span style="color:#f92672">.</span><span style="color:#a6e22e">userDetailsService</span><span style="color:#f92672">(</span>userDetailsManager<span style="color:#f92672">()).</span><span style="color:#a6e22e">passwordEncoder</span><span style="color:#f92672">(</span>passwordEncoder<span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UserManager</span> <span style="color:#66d9ef">implements</span> UserDetailsManager <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> UserDetails<span style="color:#f92672">&gt;</span> users <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashMap<span style="color:#f92672">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">createUser</span><span style="color:#f92672">(</span>UserDetails user<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        users<span style="color:#f92672">.</span><span style="color:#a6e22e">putIfAbsent</span><span style="color:#f92672">(</span>user<span style="color:#f92672">.</span><span style="color:#a6e22e">getUsername</span><span style="color:#f92672">(),</span> user<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">updateUser</span><span style="color:#f92672">(</span>UserDetails user<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        users<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>user<span style="color:#f92672">.</span><span style="color:#a6e22e">getUsername</span><span style="color:#f92672">(),</span> user<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">deleteUser</span><span style="color:#f92672">(</span>String username<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        users<span style="color:#f92672">.</span><span style="color:#a6e22e">remove</span><span style="color:#f92672">(</span>username<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">changePassword</span><span style="color:#f92672">(</span>String oldPassword<span style="color:#f92672">,</span> String newPassword<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        Authentication current <span style="color:#f92672">=</span> SecurityContextHolder<span style="color:#f92672">.</span><span style="color:#a6e22e">getContext</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getAuthentication</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">null</span> <span style="color:#f92672">==</span> current<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> AccessDeniedException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Can&#39;t not change password! because no authentication found in context for current user&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        String username <span style="color:#f92672">=</span> current<span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        UserDetails userDetails <span style="color:#f92672">=</span> users<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>username<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">null</span> <span style="color:#f92672">==</span> userDetails<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> RuntimeException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Current user not exist in database!&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// change password
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">userExists</span><span style="color:#f92672">(</span>String username<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> users<span style="color:#f92672">.</span><span style="color:#a6e22e">containsKey</span><span style="color:#f92672">(</span>username<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> UserDetails <span style="color:#a6e22e">loadUserByUsername</span><span style="color:#f92672">(</span>String username<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> UsernameNotFoundException <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> users<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>username<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><hr>
<h2 id="用户接口与编码器">用户接口与编码器<a href="#用户接口与编码器" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<h3 id="获取用户信息">获取用户信息<a href="#获取用户信息" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>Spring Security（简称SS）的用户信息由使用者通过实现框架提供的<code>UserDetailsService$loadUserByUsername()</code>接口方法提供。SS还提供了<code>UserDetails接口</code>，作为提供用户信息的核心接口。内嵌了<code>User类</code>作为<code>UserDetails</code>的默认实现。<code>UserDetailsManager</code>作为管理用户信息（增删改查）的默认内嵌管理器接口。而<code>InMemoryUserDetailsManager</code>则是默认的用户管理器实现。<img src="https://image.leejay.top/FkHsFi8_iqAaYOZ9nXECDTbk8L0d" alt=""></p>
<blockquote>
<p>User类内嵌了<code>UserBuilder</code>，用于建造设计模式的使用。</p>
<p><code>InMemoryUserDetailsManager</code>默认是由<code>UserDetailsServiceAutoConfiguration</code>类构造并注入IOC容器。</p>
</blockquote>
<h3 id="passwordencoder编码器">PasswordEncoder编码器<a href="#passwordencoder编码器" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">PasswordEncoder</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    String <span style="color:#a6e22e">encode</span><span style="color:#f92672">(</span>CharSequence rawPassword<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">matches</span><span style="color:#f92672">(</span>CharSequence rawPassword<span style="color:#f92672">,</span> String encodedPassword<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">default</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">upgradeEncoding</span><span style="color:#f92672">(</span>String encodedPassword<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DelegatingPasswordEncoder</span> <span style="color:#66d9ef">implements</span> PasswordEncoder <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">DelegatingPasswordEncoder</span><span style="color:#f92672">(</span>String idForEncode<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>		Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> PasswordEncoder<span style="color:#f92672">&gt;</span> idToPasswordEncoder<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">PasswordEncoderFactories</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> PasswordEncoder <span style="color:#a6e22e">createDelegatingPasswordEncoder</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    	String encodingId <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;bcrypt&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>		Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> PasswordEncoder<span style="color:#f92672">&gt;</span> encoders <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashMap<span style="color:#f92672">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>		encoders<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>encodingId<span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> BCryptPasswordEncoder<span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 此处省略
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> DelegatingPasswordEncoder<span style="color:#f92672">(</span>encodingId<span style="color:#f92672">,</span> encoders<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">WebSecurityConfigurerAdapter</span> <span style="color:#66d9ef">implements</span>
</span></span><span style="display:flex;"><span>		WebSecurityConfigurer<span style="color:#f92672">&lt;</span>WebSecurity<span style="color:#f92672">&gt;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">LazyPasswordEncoder</span> <span style="color:#66d9ef">implements</span> PasswordEncoder <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">private</span> PasswordEncoder <span style="color:#a6e22e">getPasswordEncoder</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 此处省略
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>passwordEncoder <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>				passwordEncoder <span style="color:#f92672">=</span> PasswordEncoderFactories<span style="color:#f92672">.</span><span style="color:#a6e22e">createDelegatingPasswordEncoder</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<ol>
<li>所有的编码器都要实现该接口，当IOC容器中无编码器时，SS默认的编码器就是<code>BCrypt</code>。</li>
<li>此处采用了<code>适配器</code>模式，交由<code>DelegatingPasswordEncoder</code>来处理默认的编码器工作。</li>
<li>默认由<code>PasswordEncoderFactories</code>静态工厂生产<code>DelegatingPasswordEncoder</code>。</li>
<li>静态工厂由SS默认配置接口<code>WebSecurityConfigurer</code>的适配器类实现<code>WebSecurityConfigurerAdapter</code>调用。</li>
</ol>
</blockquote>
<hr>
<h2 id="自动配置">自动配置<a href="#自动配置" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<h3 id="securityautoconfiguration">SecurityAutoConfiguration<a href="#securityautoconfiguration" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Configuration</span><span style="color:#f92672">(</span>proxyBeanMethods <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@ConditionalOnClass</span><span style="color:#f92672">(</span>DefaultAuthenticationEventPublisher<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@EnableConfigurationProperties</span><span style="color:#f92672">(</span>SecurityProperties<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Import</span><span style="color:#f92672">({</span> SpringBootWebSecurityConfiguration<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> WebSecurityEnablerConfiguration<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>		SecurityDataConfiguration<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span> <span style="color:#f92672">})</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SecurityAutoConfiguration</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">@Bean</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">@ConditionalOnMissingBean</span><span style="color:#f92672">(</span>AuthenticationEventPublisher<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">public</span> DefaultAuthenticationEventPublisher <span style="color:#a6e22e">authenticationEventPublisher</span><span style="color:#f92672">(</span>ApplicationEventPublisher publisher<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> DefaultAuthenticationEventPublisher<span style="color:#f92672">(</span>publisher<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<ol>
<li>默认注入<code>DefaultAuthenticationEventPublisher</code>用于时间的发布。</li>
<li>注入配置类<code>SecurityProperties</code></li>
<li>注入<code>SpringBootWebSecurityConfiguration</code>、<code>WebSecurityEnablerConfiguration</code>、<code>SecurityDataConfiguration</code></li>
</ol>
</blockquote>
<h4 id="springbootwebsecurityconfiguration">SpringBootWebSecurityConfiguration<a href="#springbootwebsecurityconfiguration" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Configuration</span><span style="color:#f92672">(</span>proxyBeanMethods <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@ConditionalOnClass</span><span style="color:#f92672">(</span>WebSecurityConfigurerAdapter<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@ConditionalOnMissingBean</span><span style="color:#f92672">(</span>WebSecurityConfigurerAdapter<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@ConditionalOnWebApplication</span><span style="color:#f92672">(</span>type <span style="color:#f92672">=</span> Type<span style="color:#f92672">.</span><span style="color:#a6e22e">SERVLET</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SpringBootWebSecurityConfiguration</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">@Configuration</span><span style="color:#f92672">(</span>proxyBeanMethods <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">@Order</span><span style="color:#f92672">(</span>SecurityProperties<span style="color:#f92672">.</span><span style="color:#a6e22e">BASIC_AUTH_ORDER</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DefaultConfigurerAdapter</span> <span style="color:#66d9ef">extends</span> WebSecurityConfigurerAdapter <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<ol>
<li>当前环境是<code>Servlet</code>，当存在<code>WebSecurityConfigurerAdapter</code>时，不注入<code>SpringBootWebSecurityConfiguration</code>，不存在时则注入默认的<code>DefaultConfigurerAdapter</code>。</li>
<li>注入默认的<code>DefaultConfigurerAdapter</code>，同时指定<code>Order(Integer.MAX_VALUE - 5)</code>。</li>
</ol>
</blockquote>
<h4 id="websecurityenablerconfiguration">WebSecurityEnablerConfiguration<a href="#websecurityenablerconfiguration" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Configuration</span><span style="color:#f92672">(</span>proxyBeanMethods <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@ConditionalOnBean</span><span style="color:#f92672">(</span>WebSecurityConfigurerAdapter<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@ConditionalOnMissingBean</span><span style="color:#f92672">(</span>name <span style="color:#f92672">=</span> BeanIds<span style="color:#f92672">.</span><span style="color:#a6e22e">SPRING_SECURITY_FILTER_CHAIN</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@ConditionalOnWebApplication</span><span style="color:#f92672">(</span>type <span style="color:#f92672">=</span> ConditionalOnWebApplication<span style="color:#f92672">.</span><span style="color:#a6e22e">Type</span><span style="color:#f92672">.</span><span style="color:#a6e22e">SERVLET</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@EnableWebSecurity</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">WebSecurityEnablerConfiguration</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<ol>
<li>当存在<code>WebSecurityConfigurerAdapter</code>、不存在<code>springSecurityFilterChain</code>且是<code>Servlet</code>环境时，激活<code>@EnableWebSecurity</code>注解。</li>
</ol>
</blockquote>
<h5 id="enablewebsecurity">@EnableWebSecurity<a href="#enablewebsecurity" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Retention</span><span style="color:#f92672">(</span>value <span style="color:#f92672">=</span> java<span style="color:#f92672">.</span><span style="color:#a6e22e">lang</span><span style="color:#f92672">.</span><span style="color:#a6e22e">annotation</span><span style="color:#f92672">.</span><span style="color:#a6e22e">RetentionPolicy</span><span style="color:#f92672">.</span><span style="color:#a6e22e">RUNTIME</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Target</span><span style="color:#f92672">(</span>value <span style="color:#f92672">=</span> <span style="color:#f92672">{</span> java<span style="color:#f92672">.</span><span style="color:#a6e22e">lang</span><span style="color:#f92672">.</span><span style="color:#a6e22e">annotation</span><span style="color:#f92672">.</span><span style="color:#a6e22e">ElementType</span><span style="color:#f92672">.</span><span style="color:#a6e22e">TYPE</span> <span style="color:#f92672">})</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Documented</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Import</span><span style="color:#f92672">({</span> WebSecurityConfiguration<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>   	SpringWebMvcImportSelector<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>   	OAuth2ImportSelector<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span> <span style="color:#f92672">})</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@EnableGlobalAuthentication</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Configuration</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#a6e22e">@interface</span> EnableWebSecurity <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">debug</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">default</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<p><code>@EnableWebSecurity</code>注解的核心在于引入<code>WebSecurityConfiguration</code>、<code>SpringWebMvcImportSelector</code>、<code>OAuth2ImportSelector</code>三个类。</p>
</blockquote>
<ul>
<li>WebSecurityConfiguration</li>
</ul>
<p>创建<code>Spring Security</code>相关的安全过滤器（beanId = <code>springSecurityFilterChain</code>）来对用户的请求进行过滤。</p>
<ul>
<li>SpringWebMvcImportSelector</li>
</ul>
<p>当classpath下存在<code>DispatcherServlet</code>时注入<code>WebMvcSecurityConfiguration</code>类，主要是用于配置<code>SpringMVC</code>相关。</p>
<ul>
<li>OAuth2ImportSelector</li>
</ul>
<p>当存在<code>ClientRegistration</code>时注入<code>OAuth2ClientConfiguration</code>，当存在<code>ExchangeFilterFunction</code>时注入<code>SecurityReactorContextConfiguration</code>，当存在<code>BearerTokenError</code>时注入<code>SecurityReactorContextConfiguration</code>。</p>
<ul>
<li>@EnableGlobalAuthentication</li>
</ul>
<p>核心在于构建认证管理器<code>AuthenticationManager</code>。</p>
<h5 id="securitydataconfiguration">SecurityDataConfiguration<a href="#securitydataconfiguration" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h5>
<p>自动添加Spring Security与Spring Data的集成。</p>
<h3 id="securityfilterautoconfiguration">SecurityFilterAutoConfiguration<a href="#securityfilterautoconfiguration" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>用于自动注入Spring Security的Filter过滤器类。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Configuration</span><span style="color:#f92672">(</span>proxyBeanMethods <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@ConditionalOnWebApplication</span><span style="color:#f92672">(</span>type <span style="color:#f92672">=</span> Type<span style="color:#f92672">.</span><span style="color:#a6e22e">SERVLET</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@EnableConfigurationProperties</span><span style="color:#f92672">(</span>SecurityProperties<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@ConditionalOnClass</span><span style="color:#f92672">({</span> AbstractSecurityWebApplicationInitializer<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> SessionCreationPolicy<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span> <span style="color:#f92672">})</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@AutoConfigureAfter</span><span style="color:#f92672">(</span>SecurityAutoConfiguration<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SecurityFilterAutoConfiguration</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// springSecurityFilterChain
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> 
</span></span><span style="display:flex;"><span>        String DEFAULT_FILTER_NAME <span style="color:#f92672">=</span> AbstractSecurityWebApplicationInitializer<span style="color:#f92672">.</span><span style="color:#a6e22e">DEFAULT_FILTER_NAME</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 当IOC容器中存在beanName为springSecurityFilterChain时注入DelegatingFilterProxyRegistrationBean
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">@Bean</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">@ConditionalOnBean</span><span style="color:#f92672">(</span>name <span style="color:#f92672">=</span> DEFAULT_FILTER_NAME<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">public</span> DelegatingFilterProxyRegistrationBean <span style="color:#a6e22e">securityFilterChainRegistration</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>			SecurityProperties securityProperties<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		DelegatingFilterProxyRegistrationBean registration <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> DelegatingFilterProxyRegistrationBean<span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>				DEFAULT_FILTER_NAME<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		registration<span style="color:#f92672">.</span><span style="color:#a6e22e">setOrder</span><span style="color:#f92672">(</span>securityProperties<span style="color:#f92672">.</span><span style="color:#a6e22e">getFilter</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getOrder</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		registration<span style="color:#f92672">.</span><span style="color:#a6e22e">setDispatcherTypes</span><span style="color:#f92672">(</span>getDispatcherTypes<span style="color:#f92672">(</span>securityProperties<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> registration<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 省略
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<ol>
<li>与上文中的<code>SecurityAutoConfiguration</code>分开配置，是为了当存在用户指定的<code>WebSecurityConfiguration</code>时仍能指定Order顺序。</li>
<li>在<code>SecurityFilterAutoConfiguration</code>完成后调用<code>SecurityAutoConfiguration</code>配置类。</li>
<li>IOC容器中存在BeanName为<code>springSecurityFilterChain</code>时注入<code>DelegatingFilterProxyRegistrationBean</code>，在上文的<code>@EnableWebSecurity</code>中的<code>WebSecurityConfiguration</code>引入。</li>
</ol>
</blockquote>
<h4 id="delegatingfilterproxyregistrationbean">DelegatingFilterProxyRegistrationBean<a href="#delegatingfilterproxyregistrationbean" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DelegatingFilterProxyRegistrationBean</span> <span style="color:#66d9ef">extends</span> AbstractFilterRegistrationBean<span style="color:#f92672">&lt;</span>DelegatingFilterProxy<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">implements</span> ApplicationContextAware <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">public</span> DelegatingFilterProxy <span style="color:#a6e22e">getFilter</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> DelegatingFilterProxy<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">targetBeanName</span><span style="color:#f92672">,</span> getWebApplicationContext<span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">initFilterBean</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> ServletException <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// Don&#39;t initialize filter bean on init()
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">};</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 省略
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<ol>
<li>通过<code>委派模式</code>将创建<code>ServletRegistrationBean</code>的委派类<code>DelegatingFilterProxyRegistrationBean</code>用于处理url和servlet的映射关系。</li>
<li>将任务委派给名为<code>springSecurityFilterChain</code>的servlet代理类<code>DelegatingFilterProxy</code>来处理sevlet请求。</li>
<li>实际处理servlet的是代理类<code>DelegatingFilterProxy</code>的实现类<code>FilterChainProxy</code>。</li>
</ol>
</blockquote>
<hr>
<h2 id="自定义配置">自定义配置<a href="#自定义配置" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>主要通过继承<code>WebSecurityConfigurerAdapter</code>抽象类来实现的。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">WebSecurityConfig</span> <span style="color:#66d9ef">extends</span> WebSecurityConfigurerAdapter <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">configure</span><span style="color:#f92672">(</span>HttpSecurity http<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 用于构建安全过滤器链
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">configure</span><span style="color:#f92672">(</span>AuthenticationManagerBuilder auth<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 处理用户认证相关（UserDetails）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">configure</span><span style="color:#f92672">(</span>WebSecurity web<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 配置webSecurity（基于DelegatingFilterProxy管理的springSecurityFilterChain实现）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h3 id="httpsecurity入门">HttpSecurity入门<a href="#httpsecurity入门" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Configuration</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CommonSecurityConfig</span> <span style="color:#66d9ef">extends</span> WebSecurityConfigurerAdapter <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Resource</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> UserManager userManager<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">configure</span><span style="color:#f92672">(</span>AuthenticationManagerBuilder auth<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        auth<span style="color:#f92672">.</span><span style="color:#a6e22e">userDetailsService</span><span style="color:#f92672">(</span>userManager<span style="color:#f92672">).</span><span style="color:#a6e22e">passwordEncoder</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> BCryptPasswordEncoder<span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">configure</span><span style="color:#f92672">(</span>WebSecurity web<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">super</span><span style="color:#f92672">.</span><span style="color:#a6e22e">configure</span><span style="color:#f92672">(</span>web<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String LOGIN_PROCESS_URL <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/process&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">configure</span><span style="color:#f92672">(</span>HttpSecurity http<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        http<span style="color:#f92672">.</span><span style="color:#a6e22e">csrf</span><span style="color:#f92672">().</span><span style="color:#a6e22e">disable</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">.</span><span style="color:#a6e22e">cors</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">.</span><span style="color:#a6e22e">and</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">.</span><span style="color:#a6e22e">authorizeRequests</span><span style="color:#f92672">().</span><span style="color:#a6e22e">anyRequest</span><span style="color:#f92672">().</span><span style="color:#a6e22e">authenticated</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">.</span><span style="color:#a6e22e">and</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">.</span><span style="color:#a6e22e">addFilterBefore</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> PreLoginFilter<span style="color:#f92672">(</span>LOGIN_PROCESS_URL<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">),</span> UsernamePasswordAuthenticationFilter<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">)</span> <span style="color:#75715e">// 注入filter，进行登录提前校验
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#f92672">.</span><span style="color:#a6e22e">formLogin</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">.</span><span style="color:#a6e22e">loginProcessingUrl</span><span style="color:#f92672">(</span>LOGIN_PROCESS_URL<span style="color:#f92672">)</span> <span style="color:#75715e">// 实际向后台提交请求的路径，此后会执行UsernamePasswordAuthenticationFilter类
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#75715e">// .defaultSuccessUrl(&#34;http://www.baidu.com&#34;, false) // login页面登录成功后重定向地址（如果是successfulForwardUrl则是转发）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#f92672">.</span><span style="color:#a6e22e">successForwardUrl</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/login/success&#34;</span><span style="color:#f92672">)</span>  <span style="color:#75715e">// 登录成功后转发的路径（可以是接口）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#f92672">.</span><span style="color:#a6e22e">failureForwardUrl</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/login/failure&#34;</span><span style="color:#f92672">);</span>  <span style="color:#75715e">// 登录失败的时候会转发到此路径
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<ol>
<li>一般通过配置HttpSecurity来实现自定义登录或鉴权的配置。</li>
<li>注入自定义Filter的核心原理在于登录鉴权相关的逻辑由<code>UsernamePasswordAuthenticationFilter</code>处理。</li>
</ol>
</blockquote>
<hr>
<h2 id="authenticationmanager源码解析">AuthenticationManager源码解析<a href="#authenticationmanager源码解析" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<h3 id="usernamepasswordauthenticationfilter">UsernamePasswordAuthenticationFilter<a href="#usernamepasswordauthenticationfilter" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>结合前文所示，用户的账户和密码认证是由<code>UsernamePasswordAuthenticationFilter</code>处理，所以我们以此切入。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UsernamePasswordAuthenticationFilter</span> <span style="color:#66d9ef">extends</span>
</span></span><span style="display:flex;"><span>		AbstractAuthenticationProcessingFilter <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">public</span> <span style="color:#a6e22e">UsernamePasswordAuthenticationFilter</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 处理/login的POST请求
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">super</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> AntPathRequestMatcher<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/login&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;POST&#34;</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 执行实际的认证流程
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> Authentication <span style="color:#a6e22e">attemptAuthentication</span><span style="color:#f92672">(</span>HttpServletRequest request<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>			HttpServletResponse response<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> AuthenticationException <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 只支持POST请求，对其进行校验
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>postOnly <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>request<span style="color:#f92672">.</span><span style="color:#a6e22e">getMethod</span><span style="color:#f92672">().</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;POST&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> AuthenticationServiceException<span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>					<span style="color:#e6db74">&#34;Authentication method not supported: &#34;</span> <span style="color:#f92672">+</span> request<span style="color:#f92672">.</span><span style="color:#a6e22e">getMethod</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 通过request.getParameter(&#34;username&#34;);获取用户名
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		String username <span style="color:#f92672">=</span> obtainUsername<span style="color:#f92672">(</span>request<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 通过request.getParameter(&#34;password&#34;);获取用户密码
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		String password <span style="color:#f92672">=</span> obtainPassword<span style="color:#f92672">(</span>request<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 判空及去重
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>username <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			username <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>password <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			password <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		username <span style="color:#f92672">=</span> username<span style="color:#f92672">.</span><span style="color:#a6e22e">trim</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 将用户密码封装到UsernamePasswordAuthenticationToken中
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		UsernamePasswordAuthenticationToken authRequest <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> 		
</span></span><span style="display:flex;"><span>            	UsernamePasswordAuthenticationToken<span style="color:#f92672">(</span>username<span style="color:#f92672">,</span> password<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 允许子类设置其他参数到认证请求中去
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		setDetails<span style="color:#f92672">(</span>request<span style="color:#f92672">,</span> authRequest<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 调用AuthenticationManager去处理认证请求
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getAuthenticationManager</span><span style="color:#f92672">().</span><span style="color:#a6e22e">authenticate</span><span style="color:#f92672">(</span>authRequest<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<p>该类的主要作用就是拦截request请求并获取账号和密码，再将其封装到<code>UsernamePasswordAuthenticationToken</code>中。再交给<code>AuthenticationManager</code>去认证。</p>
</blockquote>
<h3 id="abstractauthenticationprocessingfilter">AbstractAuthenticationProcessingFilter<a href="#abstractauthenticationprocessingfilter" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AbstractAuthenticationProcessingFilter</span> <span style="color:#66d9ef">extends</span> GenericFilterBean
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">implements</span> ApplicationEventPublisherAware<span style="color:#f92672">,</span> MessageSourceAware <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> AuthenticationSuccessHandler 
</span></span><span style="display:flex;"><span>        successHandler <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> SavedRequestAwareAuthenticationSuccessHandler<span style="color:#f92672">();</span> <span style="color:#75715e">// success处理器
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">private</span> AuthenticationFailureHandler 
</span></span><span style="display:flex;"><span>        failureHandler <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> SimpleUrlAuthenticationFailureHandler<span style="color:#f92672">();</span> <span style="color:#75715e">// failure处理器
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 过滤器的核心方法
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">doFilter</span><span style="color:#f92672">(</span>ServletRequest req<span style="color:#f92672">,</span> ServletResponse res<span style="color:#f92672">,</span> FilterChain chain<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">throws</span> IOException<span style="color:#f92672">,</span> ServletException <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		HttpServletRequest request <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>HttpServletRequest<span style="color:#f92672">)</span> req<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>		HttpServletResponse response <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>HttpServletResponse<span style="color:#f92672">)</span> res<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 判断是否需要鉴权（本质就是判断路径是否匹配），由子类构造中实现的（POST /login请求）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>requiresAuthentication<span style="color:#f92672">(</span>request<span style="color:#f92672">,</span> response<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			chain<span style="color:#f92672">.</span><span style="color:#a6e22e">doFilter</span><span style="color:#f92672">(</span>request<span style="color:#f92672">,</span> response<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>logger<span style="color:#f92672">.</span><span style="color:#a6e22e">isDebugEnabled</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			logger<span style="color:#f92672">.</span><span style="color:#a6e22e">debug</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Request is to process authentication&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 鉴权校验，实际上调用了子类的attemptAuthentication实现
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		Authentication authResult<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 如果返回为空说明子类验证没有完成，立即返回
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			authResult <span style="color:#f92672">=</span> attemptAuthentication<span style="color:#f92672">(</span>request<span style="color:#f92672">,</span> response<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>authResult <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 处理session策略，此处默认是空实现
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			sessionStrategy<span style="color:#f92672">.</span><span style="color:#a6e22e">onAuthentication</span><span style="color:#f92672">(</span>authResult<span style="color:#f92672">,</span> request<span style="color:#f92672">,</span> response<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>InternalAuthenticationServiceException failed<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			logger<span style="color:#f92672">.</span><span style="color:#a6e22e">error</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>					<span style="color:#e6db74">&#34;An internal error occurred while trying to authenticate the user.&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>					failed<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 失败处理器处理
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			unsuccessfulAuthentication<span style="color:#f92672">(</span>request<span style="color:#f92672">,</span> response<span style="color:#f92672">,</span> failed<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>AuthenticationException failed<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 与上同理
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			unsuccessfulAuthentication<span style="color:#f92672">(</span>request<span style="color:#f92672">,</span> response<span style="color:#f92672">,</span> failed<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 是否跳过其他过滤器，默认是跳过的
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>continueChainBeforeSuccessfulAuthentication<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			chain<span style="color:#f92672">.</span><span style="color:#a6e22e">doFilter</span><span style="color:#f92672">(</span>request<span style="color:#f92672">,</span> response<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 成功后的处理器处理
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		successfulAuthentication<span style="color:#f92672">(</span>request<span style="color:#f92672">,</span> response<span style="color:#f92672">,</span> chain<span style="color:#f92672">,</span> authResult<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<ol>
<li>是<code>UsernamePasswordAuthenticationFilter</code>的父类，默认实现了<code>Filter</code>过滤器的核心方法<code>doFilter</code>。</li>
<li>首先是对请求路径的判断，必须是<code>POST /login</code>请求才会拦截。否则直接交由下个过滤器处理。</li>
<li>调用子类的<code>attemptAuthentication</code>进行认证操作，并设置session相关的策略（默认空实现）。</li>
<li>如果发生了异常或校验失败，调用失败处理器。继而判断是否需要跳过后面的过滤器，最终执行成功处理器。</li>
</ol>
</blockquote>
<h3 id="authenticationmanager初始化流程">AuthenticationManager初始化流程🔒<a href="#authenticationmanager初始化流程" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">AuthenticationManager</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    Authentication <span style="color:#a6e22e">authenticate</span><span style="color:#f92672">(</span>Authentication authentication<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">throws</span> AuthenticationException<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<p>认证管理器顶级接口，上文中封装的<code>UsernamePasswordAuthenticationToken</code>就会交予<code>AuthenticationManager</code>的实现类来处理。如果验证成功就返回<code>Authentication</code>对象，否则就抛出异常。</p>
</blockquote>
<h4 id="1-securityautoconfiguration">1. SecurityAutoConfiguration<a href="#1-securityautoconfiguration" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<blockquote>
<p>请注意：下述的流程展示省略了大部分与<code>AuthenticationManager</code>初始化无关的代码！！</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// // 通过自动装配注入了`SecurityAutoConfiguration`类，继而注入了`WebSecurityEnablerConfiguration`
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">@Import</span><span style="color:#f92672">({</span>WebSecurityEnablerConfiguration<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">})</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SecurityAutoConfiguration</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@EnableWebSecurity</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">WebSecurityEnablerConfiguration</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Import</span><span style="color:#f92672">({</span> WebSecurityConfiguration<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">})</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@EnableGlobalAuthentication</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#a6e22e">@interface</span> EnableWebSecurity <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<ol>
<li>因为容器中存在<code>WebSecurityConfigurerAdapter</code>，所以启用了<code>@EnableWebSecurity</code>注解。</li>
<li><code>@EnableWebSecurity</code>注解的核心在于<code>@EnableGlobalAuthentication</code>和<code>WebSecurityConfiguration</code>类。</li>
</ol>
</blockquote>
<h4 id="2-websecurityconfiguration">2. WebSecurityConfiguration<a href="#2-websecurityconfiguration" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Configuration</span><span style="color:#f92672">(</span>proxyBeanMethods <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">WebSecurityConfiguration</span> <span style="color:#66d9ef">implements</span> ImportAware<span style="color:#f92672">,</span> BeanClassLoaderAware <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> WebSecurity webSecurity<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> List<span style="color:#f92672">&lt;</span>SecurityConfigurer<span style="color:#f92672">&lt;</span>Filter<span style="color:#f92672">,</span> WebSecurity<span style="color:#f92672">&gt;&gt;</span> webSecurityConfigurers<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 此处已经注入了AutowireBeanFactoryObjectPostProcessor
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">@Autowired</span><span style="color:#f92672">(</span>required <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> ObjectPostProcessor<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> objectObjectPostProcessor<span style="color:#f92672">;</span> 
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Autowired</span><span style="color:#f92672">(</span>required <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setFilterChainProxySecurityConfigurer</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>        ObjectPostProcessor<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> objectPostProcessor<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">@Value</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;#{@autowiredWebSecurityConfigurersIgnoreParents.getWebSecurityConfigurers()}&#34;</span><span style="color:#f92672">)</span> 			List<span style="color:#f92672">&lt;</span>SecurityConfigurer<span style="color:#f92672">&lt;</span>Filter<span style="color:#f92672">,</span> WebSecurity<span style="color:#f92672">&gt;&gt;</span> webSecurityConfigurers<span style="color:#f92672">){</span> 
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        webSecurity <span style="color:#f92672">=</span> objectPostProcessor
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">.</span><span style="color:#a6e22e">postProcess</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> WebSecurity<span style="color:#f92672">(</span>objectPostProcessor<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>                   <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>SecurityConfigurer<span style="color:#f92672">&lt;</span>Filter<span style="color:#f92672">,</span> WebSecurity<span style="color:#f92672">&gt;</span> webSecurityConfigurer <span style="color:#f92672">:</span> webSecurityConfigurers<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			webSecurity<span style="color:#f92672">.</span><span style="color:#a6e22e">apply</span><span style="color:#f92672">(</span>webSecurityConfigurer<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">webSecurityConfigurers</span> <span style="color:#f92672">=</span> webSecurityConfigurers<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 创建beanName为&#39;springSecurityFilterChain&#39;的过滤器链并得到整合后的Filter
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">@Bean</span><span style="color:#f92672">(</span>name <span style="color:#f92672">=</span> AbstractSecurityWebApplicationInitializer<span style="color:#f92672">.</span><span style="color:#a6e22e">DEFAULT_FILTER_NAME</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">public</span> Filter <span style="color:#a6e22e">springSecurityFilterChain</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// webSecurityConfigurers 是用于创建web配置的对象集合
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">boolean</span> hasConfigurers <span style="color:#f92672">=</span> webSecurityConfigurers <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>webSecurityConfigurers<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>hasConfigurers<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 若没有SecurityConfigurer的实现类（只要继承了WebSecurityConfigurerAdapter就不会为空)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#75715e">// 则创建默认的WebSecurityConfigurerAdapter类
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			WebSecurityConfigurerAdapter adapter <span style="color:#f92672">=</span> objectObjectPostProcessor
</span></span><span style="display:flex;"><span>					<span style="color:#f92672">.</span><span style="color:#a6e22e">postProcess</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> WebSecurityConfigurerAdapter<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#f92672">});</span>
</span></span><span style="display:flex;"><span>			webSecurity<span style="color:#f92672">.</span><span style="color:#a6e22e">apply</span><span style="color:#f92672">(</span>adapter<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 将WebSecurity对象转换为Filter（查看下文）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">return</span> webSecurity<span style="color:#f92672">.</span><span style="color:#a6e22e">build</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 通过SPEL调用，目的是为了查找容器中所有类型为WebSecurityConfigurer的bean整合成集合                   
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AutowiredWebSecurityConfigurersIgnoreParents</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> List<span style="color:#f92672">&lt;</span>SecurityConfigurer<span style="color:#f92672">&lt;</span>Filter<span style="color:#f92672">,</span> WebSecurity<span style="color:#f92672">&gt;&gt;</span> <span style="color:#a6e22e">getWebSecurityConfigurers</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		List<span style="color:#f92672">&lt;</span>SecurityConfigurer<span style="color:#f92672">&lt;</span>Filter<span style="color:#f92672">,</span> WebSecurity<span style="color:#f92672">&gt;&gt;</span> webSecurityConfigurers 
</span></span><span style="display:flex;"><span>            												<span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>		Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> WebSecurityConfigurer<span style="color:#f92672">&gt;</span> beansOfType <span style="color:#f92672">=</span> beanFactory
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">.</span><span style="color:#a6e22e">getBeansOfType</span><span style="color:#f92672">(</span>WebSecurityConfigurer<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Entry<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> WebSecurityConfigurer<span style="color:#f92672">&gt;</span> entry <span style="color:#f92672">:</span> beansOfType<span style="color:#f92672">.</span><span style="color:#a6e22e">entrySet</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			webSecurityConfigurers<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>entry<span style="color:#f92672">.</span><span style="color:#a6e22e">getValue</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> webSecurityConfigurers<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<ol>
<li>基于<code>WebSecurityConfiguration</code>来创建<code>WebSecurity</code>对象。并调用<code>build()</code>初始化相关类。</li>
<li><code>setFilterChainProxySecurityConfigurer</code>会将容器内的所有<code>WebSecurityConfigurer</code>类型的bean添加到集合中作为参数注入。</li>
<li><code>WebSecurity</code>处理<code>Filter过滤器链</code>相关，<code>HttpSecurity</code>处理http请求相关，都实现自<code>SecurityBuilder</code>。</li>
<li>如果容器中<code>SecurityConfigurer&lt;Filter, WebSecurity&gt;</code>的子类、实现类集合为空，那么就会创建默认的<code>WebSecurityConfigurerAdapter</code>对象并加入到容器中。</li>
</ol>
</blockquote>
<h5 id="21-abstractsecuritybuilderbuild">2.1 AbstractSecurityBuilder.build()🔒<a href="#21-abstractsecuritybuilderbuild" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AbstractSecurityBuilder</span><span style="color:#f92672">&lt;</span>O<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">implements</span> SecurityBuilder<span style="color:#f92672">&lt;</span>O<span style="color:#f92672">&gt;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> AtomicBoolean building <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> AtomicBoolean<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">private</span> O object<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> O <span style="color:#a6e22e">build</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// CAS保证多线程下只能创建一次
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">building</span><span style="color:#f92672">.</span><span style="color:#a6e22e">compareAndSet</span><span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">object</span> <span style="color:#f92672">=</span> doBuild<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">object</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> AlreadyBuiltException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;This object has already been built&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 模板方法,由子类具体实现
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">abstract</span> O <span style="color:#a6e22e">doBuild</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> Exception<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AbstractConfiguredSecurityBuilder</span><span style="color:#f92672">&lt;</span>O<span style="color:#f92672">,</span> B <span style="color:#66d9ef">extends</span> SecurityBuilder<span style="color:#f92672">&lt;</span>O<span style="color:#f92672">&gt;&gt;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">extends</span> AbstractSecurityBuilder<span style="color:#f92672">&lt;</span>O<span style="color:#f92672">&gt;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">final</span> O <span style="color:#a6e22e">doBuild</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 加锁初始化,BuildState由五种状态
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span>configurers<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			buildState <span style="color:#f92672">=</span> BuildState<span style="color:#f92672">.</span><span style="color:#a6e22e">INITIALIZING</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>			beforeInit<span style="color:#f92672">();</span> <span style="color:#75715e">// 钩子函数,初始化前调用,默认空实现
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			init<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>			buildState <span style="color:#f92672">=</span> BuildState<span style="color:#f92672">.</span><span style="color:#a6e22e">CONFIGURING</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>			beforeConfigure<span style="color:#f92672">();</span> <span style="color:#75715e">// 钩子函数,配置前调用,默认空实现
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			configure<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>			buildState <span style="color:#f92672">=</span> BuildState<span style="color:#f92672">.</span><span style="color:#a6e22e">BUILDING</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>			O result <span style="color:#f92672">=</span> performBuild<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>			buildState <span style="color:#f92672">=</span> BuildState<span style="color:#f92672">.</span><span style="color:#a6e22e">BUILT</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> result<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">init</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 获取所有security的配置类
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		Collection<span style="color:#f92672">&lt;</span>SecurityConfigurer<span style="color:#f92672">&lt;</span>O<span style="color:#f92672">,</span> B<span style="color:#f92672">&gt;&gt;</span> configurers <span style="color:#f92672">=</span> getConfigurers<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 依次初始化他们
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>SecurityConfigurer<span style="color:#f92672">&lt;</span>O<span style="color:#f92672">,</span> B<span style="color:#f92672">&gt;</span> configurer <span style="color:#f92672">:</span> configurers<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			configurer<span style="color:#f92672">.</span><span style="color:#a6e22e">init</span><span style="color:#f92672">((</span>B<span style="color:#f92672">)</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">);</span> <span style="color:#75715e">// 此处会调用`WebSecurityConfigurerAdapter.init()方法`
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 所有调用apply的security的配置类在BuildState为INITIALIZING都会加入其中，后续补上初始化
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>SecurityConfigurer<span style="color:#f92672">&lt;</span>O<span style="color:#f92672">,</span> B<span style="color:#f92672">&gt;</span> configurer <span style="color:#f92672">:</span> configurersAddedInInitializing<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			configurer<span style="color:#f92672">.</span><span style="color:#a6e22e">init</span><span style="color:#f92672">((</span>B<span style="color:#f92672">)</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 模板方法，默认由三个实现：AuthenticationManagerBuilder、HttpSecurity、WebSecurity
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// 分别对应内置鉴权管理器，DefaultSecurityFilterChain、FilterChainProxy相关配置
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">abstract</span> O <span style="color:#a6e22e">performBuild</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> Exception<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<ol>
<li>核心在于找出所有需要初始化的<code>SecurityConfigurer</code>的子类对<code>SecurityBuilder</code>的子类进行初始化操作。</li>
<li>此处也会调用<code>WebSecurityConfigurerAdapter.init()</code>方法。</li>
</ol>
</blockquote>
<h4 id="3--enableglobalauthentication">3.  @EnableGlobalAuthentication🎈<a href="#3--enableglobalauthentication" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * 此注解可用于配置`AuthenticationManagerBuilder`实例，而`AuthenticationManagerBuilder`则
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * 用于创建`AuthenticationManager`实例
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Import</span><span style="color:#f92672">(</span>AuthenticationConfiguration<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">)</span> <span style="color:#75715e">// 注入AuthenticationConfiguration类
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#a6e22e">@interface</span> EnableGlobalAuthentication <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Import</span><span style="color:#f92672">(</span>ObjectPostProcessorConfiguration<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">)</span> <span style="color:#75715e">// 注入了ObjectPostProcessorConfiguration类
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AuthenticationConfiguration</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 初始化UserDetailsService实现类，若存在多个则不会继续初始化
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// 如果存在一个，那么会创建DaoAuthenticationProvider作为属性注入到AuthenticationManagerBuilder中
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">@Bean</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> InitializeUserDetailsBeanManagerConfigurer 		
</span></span><span style="display:flex;"><span>        	<span style="color:#a6e22e">initializeUserDetailsBeanManagerConfigurer</span><span style="color:#f92672">(</span>ApplicationContext context<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> InitializeUserDetailsBeanManagerConfigurer<span style="color:#f92672">(</span>context<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 尝试从IOC容器中获取AuthenticationProvider对象并设置到AuthenticationManagerBuilder中，
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// 如果存在就不设置。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">@Bean</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> InitializeAuthenticationProviderBeanManagerConfigurer 
</span></span><span style="display:flex;"><span>        	<span style="color:#a6e22e">initializeAuthenticationProviderBeanManagerConfigurer</span><span style="color:#f92672">(</span>ApplicationContext context<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> InitializeAuthenticationProviderBeanManagerConfigurer<span style="color:#f92672">(</span>context<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<ol>
<li><code>@EnableGlobalAuthentication</code>的核心就是对<code>AuthenticationConfiguration</code>和<code>ObjectPostProcessorConfiguration</code>的注入。</li>
<li><code>AuthenticationConfiguration</code>中的两个Bean的注入只有没有子类复写<code>configure(AuthenticationManagerBuilder auth)</code>方法时才会初始化(init()方法)。</li>
</ol>
</blockquote>
<h5 id="31-objectpostprocessorconfiguration">3.1 ObjectPostProcessorConfiguration<a href="#31-objectpostprocessorconfiguration" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Configuration</span><span style="color:#f92672">(</span>proxyBeanMethods <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Role</span><span style="color:#f92672">(</span>BeanDefinition<span style="color:#f92672">.</span><span style="color:#a6e22e">ROLE_INFRASTRUCTURE</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ObjectPostProcessorConfiguration</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">@Bean</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">@Role</span><span style="color:#f92672">(</span>BeanDefinition<span style="color:#f92672">.</span><span style="color:#a6e22e">ROLE_INFRASTRUCTURE</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">public</span> ObjectPostProcessor<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">objectPostProcessor</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>			AutowireCapableBeanFactory beanFactory<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 创建默认的ObjectPostProcessor实现类注入到容器中
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> AutowireBeanFactoryObjectPostProcessor<span style="color:#f92672">(</span>beanFactory<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 顶级接口
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">ObjectPostProcessor</span><span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">&lt;</span>O <span style="color:#66d9ef">extends</span> T<span style="color:#f92672">&gt;</span> O <span style="color:#a6e22e">postProcess</span><span style="color:#f92672">(</span>O object<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AutowireBeanFactoryObjectPostProcessor</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">implements</span> ObjectPostProcessor<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;,</span> DisposableBean<span style="color:#f92672">,</span> SmartInitializingSingleton <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 将bean注入到容器的核心方法
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> <span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> T <span style="color:#a6e22e">postProcess</span><span style="color:#f92672">(</span>T object<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>object <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		T result <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 初始化bean
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			result <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>T<span style="color:#f92672">)</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">autowireBeanFactory</span>
</span></span><span style="display:flex;"><span>                			<span style="color:#f92672">.</span><span style="color:#a6e22e">initializeBean</span><span style="color:#f92672">(</span>object<span style="color:#f92672">,</span>object<span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>RuntimeException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 省略
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 自动注入
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">autowireBeanFactory</span><span style="color:#f92672">.</span><span style="color:#a6e22e">autowireBean</span><span style="color:#f92672">(</span>object<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 省略
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">return</span> result<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<ol>
<li>此类是通过<code>AuthenticationConfiguration</code>注入的，此处涉及一个概念：<code>ObjectPostProcessor</code>。</li>
<li><code>ObjectPostProcessor</code>可以通过<code>new</code>创建的对象交由<code>IOC容器</code>进行管理。</li>
<li><code>ObjectPostProcessorConfiguration</code>默认注入了<code>ObjectPostProcessor</code>的实现类<code>AutowireBeanFactoryObjectPostProcessor</code>到容器中。核心就是<code>初始化Bean</code>并自动注入。</li>
<li>使用<code>ObjectPostProcessor</code>的目的是为了解决<code>因为便于管理大量对象，没有暴露这些对象的属性，但是需要手动注册bean到容器中</code>的问题，注入到容器中的bean我们可以对其进行管理、修改或增强。</li>
</ol>
</blockquote>
<h5 id="32-authenticationconfiguration">3.2 AuthenticationConfiguration🔒<a href="#32-authenticationconfiguration" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Configuration</span><span style="color:#f92672">(</span>proxyBeanMethods <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Import</span><span style="color:#f92672">(</span>ObjectPostProcessorConfiguration<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">)</span> <span style="color:#75715e">// 上文已解析
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AuthenticationConfiguration</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// IOC容器上下文，BeanFactory的实现
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> ApplicationContext applicationContext<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 此处涉及authenticationManager注入
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">private</span> AuthenticationManager authenticationManager<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 默认false，用于判断authenticationManager是否已经初始化
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">boolean</span> authenticationManagerInitialized<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 用于注入bean到容器中
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> ObjectPostProcessor<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> objectPostProcessor<span style="color:#f92672">;</span> 
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Bean</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">public</span> AuthenticationManagerBuilder <span style="color:#a6e22e">authenticationManagerBuilder</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>			ObjectPostProcessor<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> objectPostProcessor<span style="color:#f92672">,</span> ApplicationContext context<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 创建默认的解码器（上文有解析过，此处使用了静态工厂创建解码器）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		LazyPasswordEncoder defaultPasswordEncoder <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> LazyPasswordEncoder<span style="color:#f92672">(</span>context<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		AuthenticationEventPublisher authenticationEventPublisher <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span>            				getBeanOrNull<span style="color:#f92672">(</span>context<span style="color:#f92672">,</span> AuthenticationEventPublisher<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 创建默认的AuthenticationManagerBuilder，用于构建AuthenticationManager
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// 此处传入了上文的默认解码器，以及AutowireBeanFactoryObjectPostProcessor
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		DefaultPasswordEncoderAuthenticationManagerBuilder result <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">new</span> DefaultPasswordEncoderAuthenticationManagerBuilder<span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>            								objectPostProcessor<span style="color:#f92672">,</span> defaultPasswordEncoder<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>authenticationEventPublisher <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			result<span style="color:#f92672">.</span><span style="color:#a6e22e">authenticationEventPublisher</span><span style="color:#f92672">(</span>authenticationEventPublisher<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> result<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// WebSecurityConfigurerAdapter中通过AuthenticationConfiguration调用
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> AuthenticationManager <span style="color:#a6e22e">getAuthenticationManager</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 如果已经初始化那么直接返回authenticationManager
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">authenticationManagerInitialized</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">authenticationManager</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 判断容器中是否存在AuthenticationManagerBuilder（AuthenticationManager的构造器）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		AuthenticationManagerBuilder authBuilder <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">applicationContext</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getBean</span><span style="color:#f92672">(</span>AuthenticationManagerBuilder<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// CAS保证线程安全，调用委派模式通过AuthenticationManagerBuilder创建AuthenticationManager
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">buildingAuthenticationManager</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getAndSet</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> AuthenticationManagerDelegator<span style="color:#f92672">(</span>authBuilder<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 判断是否存在全局配置类（即继承GlobalAuthenticationConfigurerAdapter的类）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>GlobalAuthenticationConfigurerAdapter config <span style="color:#f92672">:</span> globalAuthConfigurers<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			authBuilder<span style="color:#f92672">.</span><span style="color:#a6e22e">apply</span><span style="color:#f92672">(</span>config<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 委派模式分配的类用于构建AuthenticationManager
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		authenticationManager <span style="color:#f92672">=</span> authBuilder<span style="color:#f92672">.</span><span style="color:#a6e22e">build</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 若没有符合条件的委托类进行鉴权操作，那么就创建
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>authenticationManager <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 此处的authenticationManager还是可以为null的
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			authenticationManager <span style="color:#f92672">=</span> getAuthenticationManagerBean<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 标记为已创建AuthenticationManager并返回
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">authenticationManagerInitialized</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> authenticationManager<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AuthenticationManagerDelegator</span> <span style="color:#66d9ef">implements</span> AuthenticationManager <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">private</span> AuthenticationManagerBuilder delegateBuilder<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">private</span> AuthenticationManager delegate<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> Object delegateMonitor <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Object<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		AuthenticationManagerDelegator<span style="color:#f92672">(</span>AuthenticationManagerBuilder delegateBuilder<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			Assert<span style="color:#f92672">.</span><span style="color:#a6e22e">notNull</span><span style="color:#f92672">(</span>delegateBuilder<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;delegateBuilder cannot be null&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">delegateBuilder</span> <span style="color:#f92672">=</span> delegateBuilder<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">public</span> Authentication <span style="color:#a6e22e">authenticate</span><span style="color:#f92672">(</span>Authentication authentication<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">throws</span> AuthenticationException <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 如果AuthenticationManager不为null直接调用
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">delegate</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">delegate</span><span style="color:#f92672">.</span><span style="color:#a6e22e">authenticate</span><span style="color:#f92672">(</span>authentication<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 否则加锁并创建AuthenticationManager
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">delegateMonitor</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">delegate</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">delegate</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">delegateBuilder</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getObject</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">delegateBuilder</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 最终调用AuthenticationManager.authenticate()
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">delegate</span><span style="color:#f92672">.</span><span style="color:#a6e22e">authenticate</span><span style="color:#f92672">(</span>authentication<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> AuthenticationManager <span style="color:#a6e22e">getAuthenticationManagerBean</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> lazyBean<span style="color:#f92672">(</span>AuthenticationManager<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 此步是用于创建AuthenticationManager并加入到容器中进行管理
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> <span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> T <span style="color:#a6e22e">lazyBean</span><span style="color:#f92672">(</span>Class<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> interfaceName<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 获取BeanFactory的单例Bean
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		LazyInitTargetSource lazyTargetSource <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> LazyInitTargetSource<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 从容器中通过类型获取bean对象集合
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		String<span style="color:#f92672">[]</span> beanNamesForType <span style="color:#f92672">=</span> BeanFactoryUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">beanNamesForTypeIncludingAncestors</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>				applicationContext<span style="color:#f92672">,</span> interfaceName<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>beanNamesForType<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span> <span style="color:#f92672">==</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		String beanName<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>beanNamesForType<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span> <span style="color:#f92672">&gt;</span> 1<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 存在相同类型的多个bean，判断是否有@Primary注解修饰的bean，若有则返回，否则报错
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			List<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> primaryBeanNames <span style="color:#f92672">=</span> getPrimaryBeanNames<span style="color:#f92672">(</span>beanNamesForType<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 如果不存在或数量不等于1，就抛出异常
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			Assert<span style="color:#f92672">.</span><span style="color:#a6e22e">isTrue</span><span style="color:#f92672">(</span>primaryBeanNames<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">!=</span> 0<span style="color:#f92672">,</span> <span style="color:#f92672">()</span> <span style="color:#f92672">-&gt;</span> <span style="color:#e6db74">&#34;Found &#34;</span> <span style="color:#f92672">+</span> beanNamesForType<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span>
</span></span><span style="display:flex;"><span>					<span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; beans for type &#34;</span> <span style="color:#f92672">+</span> interfaceName <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;, but none marked as primary&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>			Assert<span style="color:#f92672">.</span><span style="color:#a6e22e">isTrue</span><span style="color:#f92672">(</span>primaryBeanNames<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">==</span> 1<span style="color:#f92672">,</span> <span style="color:#f92672">()</span> <span style="color:#f92672">-&gt;</span> <span style="color:#e6db74">&#34;Found &#34;</span> <span style="color:#f92672">+</span> primaryBeanNames<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>					<span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; beans for type &#34;</span> <span style="color:#f92672">+</span> interfaceName <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; marked as primary&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>			beanName <span style="color:#f92672">=</span> primaryBeanNames<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>0<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 否则直接返回第一个
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			beanName <span style="color:#f92672">=</span> beanNamesForType<span style="color:#f92672">[</span>0<span style="color:#f92672">];</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 设置beanFactory相关参数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		lazyTargetSource<span style="color:#f92672">.</span><span style="color:#a6e22e">setTargetBeanName</span><span style="color:#f92672">(</span>beanName<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		lazyTargetSource<span style="color:#f92672">.</span><span style="color:#a6e22e">setBeanFactory</span><span style="color:#f92672">(</span>applicationContext<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 创建代理工厂并调用postProcess将new的对象加入容器中
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		ProxyFactoryBean proxyFactory <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ProxyFactoryBean<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>		proxyFactory <span style="color:#f92672">=</span> objectPostProcessor<span style="color:#f92672">.</span><span style="color:#a6e22e">postProcess</span><span style="color:#f92672">(</span>proxyFactory<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		proxyFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">setTargetSource</span><span style="color:#f92672">(</span>lazyTargetSource<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 返回容器中的符合条件的对象(即AuthenticationManager对象)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span>T<span style="color:#f92672">)</span> proxyFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">getObject</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<ol>
<li><code>AuthenticationConfiguration</code>提供了默认解码器和基于默认解码器的鉴权管理构造器。</li>
<li>提供了<code>getAuthenticationManager()</code>用于返回容器中的<code>AuthenticationManager</code>对象。</li>
<li>尝试通过获取容器中的<code>AuthenticationManagerBuilder</code>并调用委派模式、建造者模式来创建<code>AuthenticationManager</code>。</li>
<li>如果仍没有，么会基于类型在容器中进行查找（找不到或多个会抛出异常），然后进行鉴权，如果成功返回<code>Authentication</code>，否则抛出异常。</li>
</ol>
</blockquote>
<h4 id="4-websecurityconfigureradapter">4. WebSecurityConfigurerAdapter<a href="#4-websecurityconfigureradapter" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">WebSecurityConfigurerAdapter</span> <span style="color:#66d9ef">implements</span>
</span></span><span style="display:flex;"><span>		WebSecurityConfigurer<span style="color:#f92672">&lt;</span>WebSecurity<span style="color:#f92672">&gt;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">boolean</span> disableLocalConfigureAuthenticationBldr<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">boolean</span> disableDefaults<span style="color:#f92672">;</span> <span style="color:#75715e">// 初始化是否需要默认配置
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> AuthenticationManager authenticationManager<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> HttpSecurity http<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> AuthenticationManagerBuilder localConfigureAuthenticationBldr<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 自动注入容器中的AuthenticationConfiguration，上文已经解析过
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">@Autowired</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setAuthenticationConfiguration</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>			AuthenticationConfiguration authenticationConfiguration<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">authenticationConfiguration</span> <span style="color:#f92672">=</span> authenticationConfiguration<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 配置鉴权管理器构造器
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">configure</span><span style="color:#f92672">(</span>AuthenticationManagerBuilder auth<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 当有子类复写该方法时（不调用super.configure）就不会将参数改为true
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">disableLocalConfigureAuthenticationBldr</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 初始化WebSecurity相关属性
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">init</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> WebSecurity web<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 首先获取HttpSecurity属性
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">final</span> HttpSecurity http <span style="color:#f92672">=</span> getHttp<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 省略
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">final</span> HttpSecurity <span style="color:#a6e22e">getHttp</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>http <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> http<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 省略
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// 核心！！！！！ 获取容器中的authenticationManager或子类创建的
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		AuthenticationManager authenticationManager <span style="color:#f92672">=</span> authenticationManager<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 设置为parent属性，在AuthenticationManagerBuilder中作为参数来创建ProviderManager
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// 因为用户可以指定多个自己的AuthenticationProvider
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// 在自定义AuthenticationProvider不存在时会继续往上查找parent的AuthenticationManager对象。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        authenticationBuilder<span style="color:#f92672">.</span><span style="color:#a6e22e">parentAuthenticationManager</span><span style="color:#f92672">(</span>authenticationManager<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 设置HttpSecurity创建的必要共享参数（上下文之类的）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		Map<span style="color:#f92672">&lt;</span>Class<span style="color:#f92672">&lt;?&gt;,</span> Object<span style="color:#f92672">&gt;</span> sharedObjects <span style="color:#f92672">=</span> createSharedObjects<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 创建HttpSecurity对象并加入容器中
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		http <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HttpSecurity<span style="color:#f92672">(</span>objectPostProcessor<span style="color:#f92672">,</span> authenticationBuilder<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>				sharedObjects<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 默认disableDefaults为false，除非显示的在构造中指定为true
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>disableDefaults<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 设置默认的参数给httpSecurity
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			http
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">.</span><span style="color:#a6e22e">csrf</span><span style="color:#f92672">().</span><span style="color:#a6e22e">and</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">.</span><span style="color:#a6e22e">addFilter</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> WebAsyncManagerIntegrationFilter<span style="color:#f92672">())</span>
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">.</span><span style="color:#a6e22e">exceptionHandling</span><span style="color:#f92672">().</span><span style="color:#a6e22e">and</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">.</span><span style="color:#a6e22e">headers</span><span style="color:#f92672">().</span><span style="color:#a6e22e">and</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">.</span><span style="color:#a6e22e">sessionManagement</span><span style="color:#f92672">().</span><span style="color:#a6e22e">and</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">.</span><span style="color:#a6e22e">securityContext</span><span style="color:#f92672">().</span><span style="color:#a6e22e">and</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">.</span><span style="color:#a6e22e">requestCache</span><span style="color:#f92672">().</span><span style="color:#a6e22e">and</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">.</span><span style="color:#a6e22e">anonymous</span><span style="color:#f92672">().</span><span style="color:#a6e22e">and</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">.</span><span style="color:#a6e22e">servletApi</span><span style="color:#f92672">().</span><span style="color:#a6e22e">and</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">.</span><span style="color:#a6e22e">apply</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> DefaultLoginPageConfigurer<span style="color:#f92672">&lt;&gt;()).</span><span style="color:#a6e22e">and</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">.</span><span style="color:#a6e22e">logout</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 通过SPI获取AbstractHttpConfigurer对象的集合
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			ClassLoader classLoader <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">context</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getClassLoader</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>			List<span style="color:#f92672">&lt;</span>AbstractHttpConfigurer<span style="color:#f92672">&gt;</span> defaultHttpConfigurers <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>					SpringFactoriesLoader<span style="color:#f92672">.</span><span style="color:#a6e22e">loadFactories</span><span style="color:#f92672">(</span>AbstractHttpConfigurer<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> classLoader<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 将其他的security配置类的子类都进行初始化操作
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>AbstractHttpConfigurer configurer <span style="color:#f92672">:</span> defaultHttpConfigurers<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>				http<span style="color:#f92672">.</span><span style="color:#a6e22e">apply</span><span style="color:#f92672">(</span>configurer<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 如果子类实现了该方法就使用子类的，否则就是父类默认的httpSecurity相关配置
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		configure<span style="color:#f92672">(</span>http<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> http<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 核心：获取AuthenticationManager来使用
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">protected</span> AuthenticationManager <span style="color:#a6e22e">authenticationManager</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// AuthenticationManager是否已经初始化，第一次都是没有初始化
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>authenticationManagerInitialized<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 查看子类是否复写configure()来配置鉴权管理构造器
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			configure<span style="color:#f92672">(</span>localConfigureAuthenticationBldr<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// true则获取之前AuthenticationConfiguration中创建的AuthenticationManager
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>disableLocalConfigureAuthenticationBldr<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>				authenticationManager <span style="color:#f92672">=</span> authenticationConfiguration
</span></span><span style="display:flex;"><span>						<span style="color:#f92672">.</span><span style="color:#a6e22e">getAuthenticationManager</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 否则基于子类的实现构建新的security配置类
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				authenticationManager <span style="color:#f92672">=</span> localConfigureAuthenticationBldr<span style="color:#f92672">.</span><span style="color:#a6e22e">build</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 设置初始化标识
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			authenticationManagerInitialized <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> authenticationManager<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">configure</span><span style="color:#f92672">(</span>AuthenticationManagerBuilder auth<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">disableLocalConfigureAuthenticationBldr</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<ol>
<li>
<p>由<code>WebSecurityConfiguration</code>中注入的bean<code>springSecurityFilterChain</code>触发了<code>WebSecurityConfigurerAdapter</code>中的<code>init</code>初始化操作。</p>
</li>
<li>
<p><code>init()</code>会获取容器中的<code>AuthenticationManager</code>，触发<code>HttpSecurity</code>的初始化工作，并设置默认的<code>HttpSecurity</code>参数。</p>
</li>
<li>
<p>最终<code>AuthenticationManager</code>对象作为``parentAuthenticationManager<code>属性被用于</code>ProviderManager`创建，并注入到容器中。</p>
</li>
<li>
<p>和<code>ProviderManager</code>流程类似，<code>WebSecurity</code>和<code>HttpSecurity</code>也是被设置属性参数后通过<code>FilterChainProxy</code>构建成Filter过滤器注入到容器中。</p>
</li>
</ol>
</blockquote>
<h4 id="5-providemanager">5. ProvideManager<a href="#5-providemanager" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p>此处主要解释<code>ProvideManager</code>、<code>AuthenticationManager</code>、<code>AuthenticationProvider</code>三者之间的联系。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">AuthenticationManager</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    Authentication <span style="color:#a6e22e">authenticate</span><span style="color:#f92672">(</span>Authentication authentication<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> AuthenticationException<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">AuthenticationProvider</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    Authentication <span style="color:#a6e22e">authenticate</span><span style="color:#f92672">(</span>Authentication authentication<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> AuthenticationException<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 根据不同角度进行判断（适配器模式）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">supports</span><span style="color:#f92672">(</span>Class<span style="color:#f92672">&lt;?&gt;</span> authentication<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ProviderManager</span> <span style="color:#66d9ef">implements</span> AuthenticationManager<span style="color:#f92672">,</span> MessageSourceAware<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>		InitializingBean <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 持有AuthenticationProvider实现类集合的引用
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">private</span> List<span style="color:#f92672">&lt;</span>AuthenticationProvider<span style="color:#f92672">&gt;</span> providers <span style="color:#f92672">=</span> Collections<span style="color:#f92672">.</span><span style="color:#a6e22e">emptyList</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 会被
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> Authentication <span style="color:#a6e22e">authenticate</span><span style="color:#f92672">(</span>Authentication authentication<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>												<span style="color:#66d9ef">throws</span> AuthenticationException <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 注意此处是两个result，分别对应AuthenticationProvider实现类和AuthenticationManager实现类
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		Authentication result <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>		Authentication parentResult <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 依次调用AuthenticationProvider实现类
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>AuthenticationProvider provider <span style="color:#f92672">:</span> getProviders<span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 如果support为false那么就跳过此次验证
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>provider<span style="color:#f92672">.</span><span style="color:#a6e22e">supports</span><span style="color:#f92672">(</span>toTest<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">continue</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 进行验证，如果验证成功（返回Authentication不为null），则不需要继续鉴权
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				result <span style="color:#f92672">=</span> provider<span style="color:#f92672">.</span><span style="color:#a6e22e">authenticate</span><span style="color:#f92672">(</span>authentication<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>result <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// 结果不为空（成功）则保存detail(ip地址，证书之类的)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>					copyDetails<span style="color:#f92672">(</span>authentication<span style="color:#f92672">,</span> result<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 省略
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 如果结果为null（即没有鉴权成功）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>result <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> parent <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 尝试调用AuthenticationManager的实现类进行鉴权，并将结果赋予result
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>				result <span style="color:#f92672">=</span> parentResult <span style="color:#f92672">=</span> parent<span style="color:#f92672">.</span><span style="color:#a6e22e">authenticate</span><span style="color:#f92672">(</span>authentication<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 省略
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 省略
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p><img src="https://image.leejay.top/FvU2DWc-HPFITz_0jZCnzyqerxFO" alt=""></p>
<blockquote>
<ol>
<li>
<p><code>ProviderManager</code>是<code>AuthenticationManager</code>的实现类，持有<code>AuthenticationProvider</code>集合的引用。</p>
</li>
<li>
<p>容器中可以存在多个<code>AuthenticationProvider</code>的实现类和一个<code>AuthenticationManager</code>实现类。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">configure</span><span style="color:#f92672">(</span>AuthenticationManagerBuilder auth<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 可以配置多个AuthenticationProvider的实现类
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// 但是建议一个UserDetailService对应一个AuthenticationProvider
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    auth<span style="color:#f92672">.</span><span style="color:#a6e22e">authenticationProvider</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">.</span><span style="color:#a6e22e">authenticationProvider</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">.</span><span style="color:#a6e22e">userDetailsService</span><span style="color:#f92672">(</span>userManager<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">.</span><span style="color:#a6e22e">passwordEncoder</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> BCryptPasswordEncoder<span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
<li>
<p><code>ProviderManager</code>在鉴权是会先尝试调用用户指定的单个或多个<code>AuthenticationProvider（没有就跳过）</code>，然后尝试执行<code>AuthenticationManager</code>的实现类进行鉴权。</p>
</li>
</ol>
</blockquote>
<h4 id="6-流程图总结">6. 流程图总结<a href="#6-流程图总结" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<iframe id="embed_dom" name="embed_dom" frameborder="0" style="height:400px;" src="https://www.processon.com/embed/60498ba67d9c08214c661ec2"></iframe>
<blockquote>
<p>直接点击链接在线访问<a href="https://www.processon.com/view/link/6049dcdbe401fd39d60176e1">Spring Security源码解析</a></p>
</blockquote>
<h2 id="filter">Filter<a href="#filter" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<h3 id="spring-security内置过滤器">Spring Security内置过滤器<a href="#spring-security内置过滤器" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>SpringSecurity中内置了一些Filter过滤器，可以通过<code>HttpSecurity</code>进行内置和自定义过滤器配置。</p>
<h4 id="filter执行顺序">Filter执行顺序<a href="#filter执行顺序" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<h5 id="filtercomparator">FilterComparator<a href="#filtercomparator" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">FilterComparator</span> <span style="color:#66d9ef">implements</span> Comparator<span style="color:#f92672">&lt;</span>Filter<span style="color:#f92672">&gt;,</span> Serializable <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    FilterComparator<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 从100开始，依次叠加100，数组越小越靠前
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		Step order <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Step<span style="color:#f92672">(</span>INITIAL_ORDER<span style="color:#f92672">,</span> ORDER_STEP<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		put<span style="color:#f92672">(</span>ChannelProcessingFilter<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> order<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span> <span style="color:#75715e">// 100
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		put<span style="color:#f92672">(</span>ConcurrentSessionFilter<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> order<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span> <span style="color:#75715e">// 200
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		put<span style="color:#f92672">(</span>WebAsyncManagerIntegrationFilter<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> order<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span> <span style="color:#75715e">// 300
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		put<span style="color:#f92672">(</span>SecurityContextPersistenceFilter<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> order<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		put<span style="color:#f92672">(</span>HeaderWriterFilter<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> order<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		put<span style="color:#f92672">(</span>CorsFilter<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> order<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		put<span style="color:#f92672">(</span>CsrfFilter<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> order<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		put<span style="color:#f92672">(</span>LogoutFilter<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> order<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		filterToOrder<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;org.springframework.security.oauth2.client.web.OAuth2AuthorizationRequestRedirectFilter&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>				order<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		filterToOrder<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>		<span style="color:#e6db74">&#34;org.springframework.security.saml2.provider.service.servlet.filter.Saml2WebSsoAuthenticationRequestFilter&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>				order<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		put<span style="color:#f92672">(</span>X509AuthenticationFilter<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> order<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		put<span style="color:#f92672">(</span>AbstractPreAuthenticatedProcessingFilter<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> order<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		filterToOrder<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;org.springframework.security.cas.web.CasAuthenticationFilter&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>				order<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		filterToOrder<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>			<span style="color:#e6db74">&#34;org.springframework.security.oauth2.client.web.OAuth2LoginAuthenticationFilter&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>				order<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		filterToOrder<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>		<span style="color:#e6db74">&#34;org.springframework.security.saml2.provider.service.servlet.filter.Saml2WebSsoAuthenticationFilter&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>				order<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		put<span style="color:#f92672">(</span>UsernamePasswordAuthenticationFilter<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> order<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		put<span style="color:#f92672">(</span>ConcurrentSessionFilter<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> order<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		filterToOrder<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>				<span style="color:#e6db74">&#34;org.springframework.security.openid.OpenIDAuthenticationFilter&#34;</span><span style="color:#f92672">,</span> order<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		put<span style="color:#f92672">(</span>DefaultLoginPageGeneratingFilter<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> order<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		put<span style="color:#f92672">(</span>DefaultLogoutPageGeneratingFilter<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> order<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		put<span style="color:#f92672">(</span>ConcurrentSessionFilter<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> order<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		put<span style="color:#f92672">(</span>DigestAuthenticationFilter<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> order<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		filterToOrder<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>			<span style="color:#e6db74">&#34;org.springframework.security.oauth2.server.resource.web.BearerTokenAuthenticationFilter&#34;</span><span style="color:#f92672">,</span> order<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		put<span style="color:#f92672">(</span>BasicAuthenticationFilter<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> order<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		put<span style="color:#f92672">(</span>RequestCacheAwareFilter<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> order<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		put<span style="color:#f92672">(</span>SecurityContextHolderAwareRequestFilter<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> order<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		put<span style="color:#f92672">(</span>JaasApiIntegrationFilter<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> order<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		put<span style="color:#f92672">(</span>RememberMeAuthenticationFilter<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> order<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		put<span style="color:#f92672">(</span>AnonymousAuthenticationFilter<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> order<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		filterToOrder<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>			<span style="color:#e6db74">&#34;org.springframework.security.oauth2.client.web.OAuth2AuthorizationCodeGrantFilter&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>				order<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		put<span style="color:#f92672">(</span>SessionManagementFilter<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> order<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		put<span style="color:#f92672">(</span>ExceptionTranslationFilter<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> order<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		put<span style="color:#f92672">(</span>FilterSecurityInterceptor<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> order<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		put<span style="color:#f92672">(</span>SwitchUserFilter<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> order<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 通过class名称去map中查找，找不到就去找父类的，还是找不到就返回null
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> Integer <span style="color:#a6e22e">getOrder</span><span style="color:#f92672">(</span>Class<span style="color:#f92672">&lt;?&gt;</span> clazz<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>clazz <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			Integer result <span style="color:#f92672">=</span> filterToOrder<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>clazz<span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>result <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">return</span> result<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>			clazz <span style="color:#f92672">=</span> clazz<span style="color:#f92672">.</span><span style="color:#a6e22e">getSuperclass</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 判断map中是否已存在该名字的过滤器。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isRegistered</span><span style="color:#f92672">(</span>Class<span style="color:#f92672">&lt;?</span> <span style="color:#66d9ef">extends</span> Filter<span style="color:#f92672">&gt;</span> filter<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> getOrder<span style="color:#f92672">(</span>filter<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<ol>
<li>将一些过滤器按照指定顺序排列，从100开始依次叠加100，数值越小越靠前。</li>
<li>通过类名在map中查找并进行找到，判断和比较。</li>
</ol>
</blockquote>
<h5 id="httpsecurity">HttpSecurity<a href="#httpsecurity" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">HttpSecurity</span> <span style="color:#66d9ef">extends</span>
</span></span><span style="display:flex;"><span>		AbstractConfiguredSecurityBuilder<span style="color:#f92672">&lt;</span>DefaultSecurityFilterChain<span style="color:#f92672">,</span> HttpSecurity<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">implements</span> SecurityBuilder<span style="color:#f92672">&lt;</span>DefaultSecurityFilterChain<span style="color:#f92672">&gt;,</span>
</span></span><span style="display:flex;"><span>		HttpSecurityBuilder<span style="color:#f92672">&lt;</span>HttpSecurity<span style="color:#f92672">&gt;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">private</span> FilterComparator comparator <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> FilterComparator<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 添加过滤器到map中
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">public</span> HttpSecurity <span style="color:#a6e22e">addFilter</span><span style="color:#f92672">(</span>Filter filter<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		Class<span style="color:#f92672">&lt;?</span> <span style="color:#66d9ef">extends</span> Filter<span style="color:#f92672">&gt;</span> filterClass <span style="color:#f92672">=</span> filter<span style="color:#f92672">.</span><span style="color:#a6e22e">getClass</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>comparator<span style="color:#f92672">.</span><span style="color:#a6e22e">isRegistered</span><span style="color:#f92672">(</span>filterClass<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> IllegalArgumentException<span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>					<span style="color:#e6db74">&#34;The Filter class &#34;</span>
</span></span><span style="display:flex;"><span>							<span style="color:#f92672">+</span> filterClass<span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>							<span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; does not have a registered order and cannot be added without a specified order. Consider using addFilterBefore or addFilterAfter instead.&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">filters</span><span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>filter<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 将新增过滤器放到指定过滤器之前执行
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">public</span> HttpSecurity <span style="color:#a6e22e">addFilterBefore</span><span style="color:#f92672">(</span>Filter filter<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>			Class<span style="color:#f92672">&lt;?</span> <span style="color:#66d9ef">extends</span> Filter<span style="color:#f92672">&gt;</span> beforeFilter<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		comparator<span style="color:#f92672">.</span><span style="color:#a6e22e">registerBefore</span><span style="color:#f92672">(</span>filter<span style="color:#f92672">.</span><span style="color:#a6e22e">getClass</span><span style="color:#f92672">(),</span> beforeFilter<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> addFilter<span style="color:#f92672">(</span>filter<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 将新增的过滤器放到指定的过滤器位置（即order值相同）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">public</span> HttpSecurity <span style="color:#a6e22e">addFilterAt</span><span style="color:#f92672">(</span>Filter filter<span style="color:#f92672">,</span> Class<span style="color:#f92672">&lt;?</span> <span style="color:#66d9ef">extends</span> Filter<span style="color:#f92672">&gt;</span> atFilter<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">comparator</span><span style="color:#f92672">.</span><span style="color:#a6e22e">registerAt</span><span style="color:#f92672">(</span>filter<span style="color:#f92672">.</span><span style="color:#a6e22e">getClass</span><span style="color:#f92672">(),</span> atFilter<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> addFilter<span style="color:#f92672">(</span>filter<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 将新增的过滤器放到指定过滤器后面
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">public</span> HttpSecurity <span style="color:#a6e22e">addFilterAfter</span><span style="color:#f92672">(</span>Filter filter<span style="color:#f92672">,</span> Class<span style="color:#f92672">&lt;?</span> <span style="color:#66d9ef">extends</span> Filter<span style="color:#f92672">&gt;</span> afterFilter<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		comparator<span style="color:#f92672">.</span><span style="color:#a6e22e">registerAfter</span><span style="color:#f92672">(</span>filter<span style="color:#f92672">.</span><span style="color:#a6e22e">getClass</span><span style="color:#f92672">(),</span> afterFilter<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> addFilter<span style="color:#f92672">(</span>filter<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h4 id="内置过滤器">内置过滤器<a href="#内置过滤器" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<table>
<thead>
<tr>
<th>过滤器</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>ChannelProcessingFilter</td>
<td>过滤哪些请求需要使用https还是http协议</td>
</tr>
<tr>
<td>ConcurrentSessionFilter</td>
<td>判断session是否过期及更新最新的访问时间</td>
</tr>
<tr>
<td>WebAsyncManagerIntegrationFilter</td>
<td>用于集成SecurityContext到Spring异步执行机制中的 WebAsyncManager。</td>
</tr>
<tr>
<td>SecurityContextPersistenceFilter</td>
<td>控制SecurityContext生命周期，请求来时创建，结束时清空</td>
</tr>
<tr>
<td>HeaderWriterFilter</td>
<td>给http请求添加header</td>
</tr>
<tr>
<td>CorsFilter</td>
<td>针对cors跨域进行的设置</td>
</tr>
<tr>
<td>CsrfFilter</td>
<td>用于防止csrf跨站攻击</td>
</tr>
<tr>
<td>LogoutFilter</td>
<td>处理注销的过滤器</td>
</tr>
<tr>
<td>X509AuthenticationFilte</td>
<td>X509认证过滤器</td>
</tr>
<tr>
<td>AbstractPreAuthenticatedProcessingFilter</td>
<td>主要用于身份的提取而不是验证</td>
</tr>
<tr>
<td>CasAuthenticationFilter</td>
<td>CAS单点登录模块，依赖于Spring Security CAS模块</td>
</tr>
<tr>
<td><b><code>UsernamePasswordAuthenticationFilter</code></b></td>
<td>处理用户及密码认证的核心过滤器</td>
</tr>
<tr>
<td>DefaultLoginPageGeneratingFilter</td>
<td>生成默认的登陆页面/login</td>
</tr>
<tr>
<td>DefaultLogoutPageGeneratingFilter</td>
<td>生成默认的登出页/logout</td>
</tr>
<tr>
<td>BasicAuthenticationFilter</td>
<td>负责http头中显示的基本身份验证凭据，默认启用</td>
</tr>
<tr>
<td>RequestCacheAwareFilter</td>
<td>用于处理因登录打断原有请求，继而登陆后自动跳转的功能。</td>
</tr>
<tr>
<td>RememberMeAuthenticationFilter</td>
<td>处理记住我功能的过滤器</td>
</tr>
<tr>
<td>AnonymousAuthenticationFilter</td>
<td>对于无需登录直接访问的资源会授予其匿名用户身份</td>
</tr>
<tr>
<td>SessionManagementFilter</td>
<td>session管理器</td>
</tr>
<tr>
<td>FilterSecurityInterceptor</td>
<td>决定了访问特定路径应该具备的权限（动态权限控制必备）</td>
</tr>
</tbody>
</table>
<h3 id="spring-security过滤器链">Spring Security过滤器链<a href="#spring-security过滤器链" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>在Spring Security Filter中是通过<code>FilterChainProxy</code>来管理多个代理不同路径的<code>SecurityFilterChain</code>过滤器链，同时<code>FilterChainProxy</code>是通过<code>DelegatingFilterProxy</code>加入到过滤器链中的一部分。如下图所示：</p>
<p><img src="https://image.leejay.top/Fn262VRuzsxESP1x-K4XBoie2rsC" alt=""></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">SecurityFilterChain</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">matches</span><span style="color:#f92672">(</span>HttpServletRequest request<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 路径对应的过滤器链
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	List<span style="color:#f92672">&lt;</span>Filter<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">getFilters</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 默认实现
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DefaultSecurityFilterChain</span> <span style="color:#66d9ef">implements</span> SecurityFilterChain <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// WebSecurity.performBuild()会将SecurityFilterChain的实现类作为参数构建为FilterChainProxy
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// FilterChainProxy是一个过滤器链，也是一个过滤器
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">FilterChainProxy</span> <span style="color:#66d9ef">extends</span> GenericFilterBean <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> List<span style="color:#f92672">&lt;</span>SecurityFilterChain<span style="color:#f92672">&gt;</span> filterChains<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">FilterChainProxy</span><span style="color:#f92672">(</span>SecurityFilterChain chain<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">this</span><span style="color:#f92672">(</span>Arrays<span style="color:#f92672">.</span><span style="color:#a6e22e">asList</span><span style="color:#f92672">(</span>chain<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 用于代理一个标准的Servlet Filter 用于集成到IOC的管理
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DelegatingFilterProxy</span> <span style="color:#66d9ef">extends</span> GenericFilterBean <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 为了在Sevlet Filter中注入Spring Bean的特性而出现的
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">GenericFilterBean</span> <span style="color:#66d9ef">implements</span> Filter<span style="color:#f92672">,</span> BeanNameAware<span style="color:#f92672">,</span> EnvironmentAware<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>		EnvironmentCapable<span style="color:#f92672">,</span> ServletContextAware<span style="color:#f92672">,</span> InitializingBean<span style="color:#f92672">,</span> DisposableBean <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<ol>
<li><code>SecurityFilterChain</code>作为构建<code>FilterChainProxy</code>的参数来构建过滤器链。</li>
<li><code>FilterChainProxy</code>默认实现<code>DefaultSecurityFilterChain</code>一般由<code>HttpSecurity</code>创建。</li>
<li><code>FilterChainProxy</code>既是过滤器链也是过滤器。</li>
<li><code>DelegatingFilterProxy</code>可以代理一个<code>Servlet Filter</code>，将其继承到Spring Bean中去。</li>
</ol>
</blockquote>
<hr>
<h2 id="jwtjson-web-token">JWT(Json Web Token)<a href="#jwtjson-web-token" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p><code>JOSE</code>是一种旨在提供在各方之间安全传递声明（claims）的方法的规范集。包含如下规范：</p>
<ul>
<li><code>JWS（RFC 7515） -JSON Web签名</code>，描述生成和处理签名消息。</li>
<li><code>JWE（RFC 7516） -JSON Web加密</code>，描述了保护和处理加密 消息。</li>
<li>JWK（RFC 7517） -JSON Web密钥，描述 Javascript 对象签名和加密中加密密钥的 格式和处理。</li>
<li>JWA（RFC 7518） -JSON Web算法，描述了 Javascript 对象签名和加密中使用的 加密 算法。</li>
<li><code>JWT（RFC 7519） -JSON Web令牌</code>，描述以 JSON 编码并由 JWS 或 JWE 保护的声明的表示形式。</li>
</ul>
<blockquote>
<p><code>JWT</code>又包含<code>JWS</code>和<code>JWE</code>，一般使用的都是基于<code>JWS</code>方式，<code>JWE</code>方法更加安全，但是也更复杂。</p>
</blockquote>
<hr>
<h2 id="rbac">RBAC<a href="#rbac" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>主要包含三个概念，分别是<code>用户</code>、<code>角色</code>和<code>权限</code>。</p>
<ul>
<li>用户</li>
</ul>
<p>不局限于单个用户，可以是一个用户组，也可以是一个部门，只要有访问资源需求的都可以作为用户。</p>
<ul>
<li>角色</li>
</ul>
<p>角色是特定权限的集合。角色是可以<code>继承与分组</code>的，一个角色可以属于多个用户，一个用户可以拥有多个角色。</p>
<ul>
<li>权限</li>
</ul>
<p>粒度最小的权限单位。一般体现在接口的控制上，同一个权限可以属于不同的角色。</p>
<h3 id="基于配置的权限">基于配置的权限<a href="#基于配置的权限" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>http<span style="color:#f92672">.</span><span style="color:#a6e22e">authorizeRequests</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 要求/admin/**路径的请求必须有ADMIN和USER权限
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">.</span><span style="color:#a6e22e">antMatchers</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/admin/**&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">access</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;hasAuthority(&#39;ADMIN&#39;) and hasAuthority(&#39;USER&#39;)&#34;</span><span style="color:#f92672">)</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 只要用户有ADMIN，USER其中一个权限即可
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">.</span><span style="color:#a6e22e">antMatchers</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/admin/**&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">access</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;hasAnyAuthority(&#39;ADMIN&#39;，&#39;USER&#39;)&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 要求/super/**路径必须有SUPER_ADMIN权限
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">.</span><span style="color:#a6e22e">antMatchers</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/super/**&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">access</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;hasAuthority(&#39;SUPER_ADMIN&#39;)&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// /hello路径需要由ROLE_USER的角色
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">.</span><span style="color:#a6e22e">antMatchers</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/hello&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">access</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;hasRole(&#39;USER&#39;)&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// /test是否放行由RbacService.checkPermission()返回值决定
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">.</span><span style="color:#a6e22e">antMatchers</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/test&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">access</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;@rbacService.checkPermission()&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">.</span><span style="color:#a6e22e">antMatchers</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/api/**&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">anonymous</span><span style="color:#f92672">()</span> <span style="color:#75715e">// 可以匿名用户登录
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">.</span><span style="color:#a6e22e">antMatchers</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/**&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">authenticated</span><span style="color:#f92672">()</span> <span style="color:#75715e">// 所有用户都可以访问不需要鉴权
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">.</span><span style="color:#a6e22e">antMatchers</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/a/**&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">permitAll</span><span style="color:#f92672">()</span> <span style="color:#75715e">// 开放请求
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Service</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RbacService</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">checkPermission</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">currentTimeMillis</span><span style="color:#f92672">()</span> <span style="color:#f92672">%</span> 2 <span style="color:#f92672">==</span> 0<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<ol>
<li><code>hasRole</code>和<code>hasAuthority</code>的区别：前者会给角色添加<code>ROLE_</code>前缀，后者不会。</li>
<li><code>hasAnyRole</code>和<code>hasAnyAuthority</code>表明只要用户有其中一种权限就可以登录。</li>
<li><code>anonymous()</code>表明用户不需要登录也可以访问，此用户默认拥有<code>ROLE_ANONYMOUS</code>权限。</li>
<li><code>PermitAll()</code>表明任何用户（匿名和非匿名）都能登录，<code>anonymous()</code>表明只有匿名用户（已登录用户不能登录）才能登录。</li>
</ol>
</blockquote>
<h3 id="基于注解的权限">基于注解的权限<a href="#基于注解的权限" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<h4 id="启动全局权限注解">启动全局权限注解<a href="#启动全局权限注解" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Retention</span><span style="color:#f92672">(</span>value <span style="color:#f92672">=</span> java<span style="color:#f92672">.</span><span style="color:#a6e22e">lang</span><span style="color:#f92672">.</span><span style="color:#a6e22e">annotation</span><span style="color:#f92672">.</span><span style="color:#a6e22e">RetentionPolicy</span><span style="color:#f92672">.</span><span style="color:#a6e22e">RUNTIME</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Target</span><span style="color:#f92672">(</span>value <span style="color:#f92672">=</span> <span style="color:#f92672">{</span> java<span style="color:#f92672">.</span><span style="color:#a6e22e">lang</span><span style="color:#f92672">.</span><span style="color:#a6e22e">annotation</span><span style="color:#f92672">.</span><span style="color:#a6e22e">ElementType</span><span style="color:#f92672">.</span><span style="color:#a6e22e">TYPE</span> <span style="color:#f92672">})</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Documented</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Import</span><span style="color:#f92672">({</span> GlobalMethodSecuritySelector<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span> <span style="color:#f92672">})</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@EnableGlobalAuthentication</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Configuration</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#a6e22e">@interface</span> EnableGlobalMethodSecurity <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 基于表达式进行方法访问控制
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">prePostEnabled</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">default</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 开启@Secured注解
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">securedEnabled</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">default</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 开启JSR-250注解
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">jsr250Enabled</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">default</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">proxyTargetClass</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">default</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>	AdviceMode <span style="color:#a6e22e">mode</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">default</span> AdviceMode<span style="color:#f92672">.</span><span style="color:#a6e22e">PROXY</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">order</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">default</span> Ordered<span style="color:#f92672">.</span><span style="color:#a6e22e">LOWEST_PRECEDENCE</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<ol>
<li>注解的三种方式要选择一种开启。</li>
<li><code>EnableGlobalMethodSecurity</code>核心配置类是<code>GlobalMethodSecurityConfiguration</code></li>
</ol>
</blockquote>
<h4 id="preauthorize">@PreAuthorize<a href="#preauthorize" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@PreAuthorize</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;hasAuthority(&#39;QUERY&#39;)&#34;</span><span style="color:#f92672">)</span>
</span></span></code></pre></div><blockquote>
<p>此方法要求用户具有<code>QUERY</code>权限才能访问，即使配置文件中没有对此路径的访问有权限要求。</p>
</blockquote>
<h4 id="postauthorize">@PostAuthorize<a href="#postauthorize" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@PostAuthorize</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;returnObject.name == &#39;test&#39;&#34;</span><span style="color:#f92672">)</span>
</span></span></code></pre></div><blockquote>
<p>判断当前返回的用户名是否为test，只有条件满足才会返回，否则抛出异常。</p>
</blockquote>
<h4 id="prefilter">@PreFilter<a href="#prefilter" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@PreFilter</span><span style="color:#f92672">(</span>filterTarget <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;ids&#34;</span><span style="color:#f92672">,</span> value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;filterObject%2==0&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">delete</span><span style="color:#f92672">(</span>List<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">&gt;</span> ids<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 只保留偶数的id
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    Stream<span style="color:#f92672">.</span><span style="color:#a6e22e">of</span><span style="color:#f92672">(</span>ids<span style="color:#f92672">).</span><span style="color:#a6e22e">forEach</span><span style="color:#f92672">(</span>System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">::</span>println<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<p>将传入的参数按照条件进行过滤</p>
</blockquote>
<h4 id="postfilter">@PostFilter<a href="#postfilter" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@PostFilter</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;filterObject.name == authentication.name&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> List<span style="color:#f92672">&lt;</span>Person<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">findOne</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    List<span style="color:#f92672">&lt;</span>Person<span style="color:#f92672">&gt;</span> persons <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>    persons<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Person<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;zhangsan&#34;</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>    persons<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Person<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;admin&#34;</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> persons<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<p>只能返回name与当前登录用户名一致的数据。</p>
</blockquote>
<hr>
<h2 id="securitycontext安全上下文">SecurityContext安全上下文<a href="#securitycontext安全上下文" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>与<code>当前线程</code>绑定的安全上下文。可以获取用户的相关信息。我们通过</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>User user <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>User<span style="color:#f92672">)</span>SecurityContextHolder<span style="color:#f92672">.</span><span style="color:#a6e22e">getContext</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getAuthentication</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getPrincipal</span><span style="color:#f92672">();</span>
</span></span></code></pre></div><p>来获取当前登录用户（匿名用户就是<code>anonymousUser</code>字符串）的相关信息。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">SecurityContext</span> <span style="color:#66d9ef">extends</span> Serializable <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 获取当前的认证信息，有可能为null
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    Authentication <span style="color:#a6e22e">getAuthentication</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 用于修改或删除当前的认证信息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setAuthentication</span><span style="color:#f92672">(</span>Authentication authentication<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 安全上下文holder持有安全上下文的引用
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">SecurityContextHolderStrategy</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">clearContext</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>	SecurityContext <span style="color:#a6e22e">getContext</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setContext</span><span style="color:#f92672">(</span>SecurityContext context<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>	SecurityContext <span style="color:#a6e22e">createEmptyContext</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h3 id="securitycontextholder源码解析">SecurityContextHolder源码解析<a href="#securitycontextholder源码解析" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SecurityContextHolder</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 上下文策略类
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> SecurityContextHolderStrategy strategy<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String SYSTEM_PROPERTY <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;spring.security.strategy&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 获取系统变量
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> String strategyName <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">getProperty</span><span style="color:#f92672">(</span>SYSTEM_PROPERTY<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 类加载时被初始化
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">static</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		initialize<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">initialize</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 判断当前的安全上下文的实现类
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>StringUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">hasText</span><span style="color:#f92672">(</span>strategyName<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			strategyName <span style="color:#f92672">=</span> MODE_THREADLOCAL<span style="color:#f92672">;</span> <span style="color:#75715e">// 没设置就采用此默认的
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>strategyName<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>MODE_THREADLOCAL<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			strategy <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ThreadLocalSecurityContextHolderStrategy<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 省略
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 加载自定义的安全上下文实现类
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>				Class<span style="color:#f92672">&lt;?&gt;</span> clazz <span style="color:#f92672">=</span> Class<span style="color:#f92672">.</span><span style="color:#a6e22e">forName</span><span style="color:#f92672">(</span>strategyName<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>				Constructor<span style="color:#f92672">&lt;?&gt;</span> customStrategy <span style="color:#f92672">=</span> clazz<span style="color:#f92672">.</span><span style="color:#a6e22e">getConstructor</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>				strategy <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>SecurityContextHolderStrategy<span style="color:#f92672">)</span> customStrategy<span style="color:#f92672">.</span><span style="color:#a6e22e">newInstance</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception ex<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>				ReflectionUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">handleReflectionException</span><span style="color:#f92672">(</span>ex<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 打印日志用
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		initializeCount<span style="color:#f92672">++;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h3 id="threadlocalsecuritycontextholderstrategy">ThreadLocalSecurityContextHolderStrategy<a href="#threadlocalsecuritycontextholderstrategy" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// 默认的实现类，基于ThreadLocal实现线程隔离，不清楚可以查看ThreadLocal源码
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 详见：https://leejay.top/post/threadlocal%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F/
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ThreadLocalSecurityContextHolderStrategy</span> <span style="color:#66d9ef">implements</span> SecurityContextHolderStrategy <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> ThreadLocal<span style="color:#f92672">&lt;</span>SecurityContext<span style="color:#f92672">&gt;</span> contextHolder <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ThreadLocal<span style="color:#f92672">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">clearContext</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		contextHolder<span style="color:#f92672">.</span><span style="color:#a6e22e">remove</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">public</span> SecurityContext <span style="color:#a6e22e">getContext</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		SecurityContext ctx <span style="color:#f92672">=</span> contextHolder<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>         
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ctx <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			ctx <span style="color:#f92672">=</span> createEmptyContext<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>			contextHolder<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>ctx<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> ctx<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setContext</span><span style="color:#f92672">(</span>SecurityContext context<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		Assert<span style="color:#f92672">.</span><span style="color:#a6e22e">notNull</span><span style="color:#f92672">(</span>context<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Only non-null SecurityContext instances are permitted&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		contextHolder<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>context<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">public</span> SecurityContext <span style="color:#a6e22e">createEmptyContext</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> SecurityContextImpl<span style="color:#f92672">();</span> <span style="color:#75715e">// 调用SecurityContext默认实现类设置权限相关
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h3 id="securitycontextimpl">SecurityContextImpl<a href="#securitycontextimpl" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SecurityContextImpl</span> <span style="color:#66d9ef">implements</span> SecurityContext <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> Authentication authentication<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">public</span> <span style="color:#a6e22e">SecurityContextImpl</span><span style="color:#f92672">()</span> <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">public</span> <span style="color:#a6e22e">SecurityContextImpl</span><span style="color:#f92672">(</span>Authentication authentication<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">authentication</span> <span style="color:#f92672">=</span> authentication<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setAuthentication</span><span style="color:#f92672">(</span>Authentication authentication<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">authentication</span> <span style="color:#f92672">=</span> authentication<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<p>在Filter过滤器处理中会设置<code>Authentication</code>到<code>SecurityContextImpl</code>中。</p>
</blockquote>
<hr>
<h2 id="动态权限">动态权限<a href="#动态权限" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p><code>FilterSecurityInterceptor </code>负责Spring Security中的权限控制。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">FilterSecurityInterceptor</span> <span style="color:#66d9ef">extends</span> AbstractSecurityInterceptor <span style="color:#66d9ef">implements</span>
</span></span><span style="display:flex;"><span>		Filter <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> FilterInvocationSecurityMetadataSource securityMetadataSource<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">doFilter</span><span style="color:#f92672">(</span>ServletRequest request<span style="color:#f92672">,</span> ServletResponse response<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>			FilterChain chain<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> IOException<span style="color:#f92672">,</span> ServletException <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 将当前的请求响应及过滤器链构建成FilterInvocation（即与Http相关连的对象）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		FilterInvocation fi <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> FilterInvocation<span style="color:#f92672">(</span>request<span style="color:#f92672">,</span> response<span style="color:#f92672">,</span> chain<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		invoke<span style="color:#f92672">(</span>fi<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">invoke</span><span style="color:#f92672">(</span>FilterInvocation fi<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> IOException<span style="color:#f92672">,</span> ServletException <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 判断是否有标记
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>fi<span style="color:#f92672">.</span><span style="color:#a6e22e">getRequest</span><span style="color:#f92672">()</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">(</span>fi<span style="color:#f92672">.</span><span style="color:#a6e22e">getRequest</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getAttribute</span><span style="color:#f92672">(</span>FILTER_APPLIED<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">&amp;&amp;</span> observeOncePerRequest<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			fi<span style="color:#f92672">.</span><span style="color:#a6e22e">getChain</span><span style="color:#f92672">().</span><span style="color:#a6e22e">doFilter</span><span style="color:#f92672">(</span>fi<span style="color:#f92672">.</span><span style="color:#a6e22e">getRequest</span><span style="color:#f92672">(),</span> fi<span style="color:#f92672">.</span><span style="color:#a6e22e">getResponse</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 给请求加标记
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>fi<span style="color:#f92672">.</span><span style="color:#a6e22e">getRequest</span><span style="color:#f92672">()</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> observeOncePerRequest<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>				fi<span style="color:#f92672">.</span><span style="color:#a6e22e">getRequest</span><span style="color:#f92672">().</span><span style="color:#a6e22e">setAttribute</span><span style="color:#f92672">(</span>FILTER_APPLIED<span style="color:#f92672">,</span> Boolean<span style="color:#f92672">.</span><span style="color:#a6e22e">TRUE</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 核心代码
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			InterceptorStatusToken token <span style="color:#f92672">=</span> <span style="color:#66d9ef">super</span><span style="color:#f92672">.</span><span style="color:#a6e22e">beforeInvocation</span><span style="color:#f92672">(</span>fi<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>				fi<span style="color:#f92672">.</span><span style="color:#a6e22e">getChain</span><span style="color:#f92672">().</span><span style="color:#a6e22e">doFilter</span><span style="color:#f92672">(</span>fi<span style="color:#f92672">.</span><span style="color:#a6e22e">getRequest</span><span style="color:#f92672">(),</span> fi<span style="color:#f92672">.</span><span style="color:#a6e22e">getResponse</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">super</span><span style="color:#f92672">.</span><span style="color:#a6e22e">finallyInvocation</span><span style="color:#f92672">(</span>token<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">super</span><span style="color:#f92672">.</span><span style="color:#a6e22e">afterInvocation</span><span style="color:#f92672">(</span>token<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AbstractSecurityInterceptor</span> <span style="color:#66d9ef">implements</span> InitializingBean<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>		ApplicationEventPublisherAware<span style="color:#f92672">,</span> MessageSourceAware <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">protected</span> InterceptorStatusToken <span style="color:#a6e22e">beforeInvocation</span><span style="color:#f92672">(</span>Object object<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 获取当前url对应的权限
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		Collection<span style="color:#f92672">&lt;</span>ConfigAttribute<span style="color:#f92672">&gt;</span> attributes <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">obtainSecurityMetadataSource</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">.</span><span style="color:#a6e22e">getAttributes</span><span style="color:#f92672">(</span>object<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 省略
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// 重要！
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 对当前用户的权限和需要的权限进行投票
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">accessDecisionManager</span><span style="color:#f92672">.</span><span style="color:#a6e22e">decide</span><span style="color:#f92672">(</span>authenticated<span style="color:#f92672">,</span> object<span style="color:#f92672">,</span> attributes<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>AccessDeniedException accessDeniedException<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">throw</span> accessDeniedException<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 省略
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<ol>
<li>通过创建<code>FilterInvocationSecurityMetadataSource</code>实现类指定当前url的权限是什么。</li>
<li>通过创建<code>AccessDecisionManager</code>的实现类指定决策管理器策略。</li>
</ol>
</blockquote>
<h3 id="安全权限数据源">安全权限数据源<a href="#安全权限数据源" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<h4 id="自定义权限数据源">自定义权限数据源<a href="#自定义权限数据源" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UrlFilterInvocationSecurityMetadataSource</span> <span style="color:#66d9ef">implements</span> FilterInvocationSecurityMetadataSource <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Collection<span style="color:#f92672">&lt;</span>ConfigAttribute<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">getAttributes</span><span style="color:#f92672">(</span>Object object<span style="color:#f92672">)</span> 
</span></span><span style="display:flex;"><span>        								<span style="color:#66d9ef">throws</span> IllegalArgumentException <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// FilterInvocation是与http对象相关联
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        FilterInvocation f <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>FilterInvocation<span style="color:#f92672">)</span> object<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        String url <span style="color:#f92672">=</span> f<span style="color:#f92672">.</span><span style="color:#a6e22e">getRequestUrl</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>url<span style="color:#f92672">.</span><span style="color:#a6e22e">contains</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/login&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">||</span> url<span style="color:#f92672">.</span><span style="color:#a6e22e">contains</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/logout&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 此处处理动态权限
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span> SecurityConfig<span style="color:#f92672">.</span><span style="color:#a6e22e">createList</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;ADMIN&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;QUERY&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Collection<span style="color:#f92672">&lt;</span>ConfigAttribute<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">getAllConfigAttributes</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">supports</span><span style="color:#f92672">(</span>Class<span style="color:#f92672">&lt;?&gt;</span> clazz<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<p>此处只是模拟赋予url的权限操作，实际业务可能从数据库或其他第三方获取。</p>
</blockquote>
<h3 id="投票模型">投票模型<a href="#投票模型" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<h4 id="自定义accessdecisionmanager">自定义AccessDecisionManager<a href="#自定义accessdecisionmanager" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">AccessDecisionManager</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 决策的核心方法
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">decide</span><span style="color:#f92672">(</span>Authentication authentication<span style="color:#f92672">,</span> Object object<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>			Collection<span style="color:#f92672">&lt;</span>ConfigAttribute<span style="color:#f92672">&gt;</span> configAttributes<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> AccessDeniedException<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>			InsufficientAuthenticationException<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">supports</span><span style="color:#f92672">(</span>ConfigAttribute attribute<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">supports</span><span style="color:#f92672">(</span>Class<span style="color:#f92672">&lt;?&gt;</span> clazz<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 自定义决策管理器
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UrlAccessDecisionManager</span> <span style="color:#66d9ef">implements</span> AccessDecisionManager <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">decide</span><span style="color:#f92672">(</span>Authentication authentication<span style="color:#f92672">,</span> Object object<span style="color:#f92672">,</span> Collection<span style="color:#f92672">&lt;</span>ConfigAttribute<span style="color:#f92672">&gt;</span> configAttributes<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> AccessDeniedException<span style="color:#f92672">,</span> InsufficientAuthenticationException <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>ConfigAttribute configAttribute <span style="color:#f92672">:</span> configAttributes<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 未登录ROLE_ANONYMOUS角色
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>authentication <span style="color:#66d9ef">instanceof</span> AnonymousAuthenticationToken<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> BadCredentialsException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;未登录!&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// ① 当前url请求需要的权限
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            String role <span style="color:#f92672">=</span> configAttribute<span style="color:#f92672">.</span><span style="color:#a6e22e">getAttribute</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// ② 当前用户所具有的角色
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            Collection<span style="color:#f92672">&lt;?</span> <span style="color:#66d9ef">extends</span> GrantedAuthority<span style="color:#f92672">&gt;</span> authorities 
</span></span><span style="display:flex;"><span>                						<span style="color:#f92672">=</span> authentication<span style="color:#f92672">.</span><span style="color:#a6e22e">getAuthorities</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>GrantedAuthority authority <span style="color:#f92672">:</span> authorities<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 只要包含其中一个角色即可访问
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>authority<span style="color:#f92672">.</span><span style="color:#a6e22e">getAuthority</span><span style="color:#f92672">().</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>role<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> AccessDeniedException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;请联系管理员分配权限！&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<ol>
<li><code>AffirmativeBased </code>基于肯定的决策器。 用户持有一个同意访问的角色就能通过。</li>
<li><code>ConsensusBased</code>基于共识的决策器。 用户持有同意的角色数量多于禁止的角色数。</li>
<li><code>UnanimousBased</code> 基于一致的决策器。 用户持有的所有角色都同意访问才能放行。</li>
</ol>
</blockquote>
<h4 id="自定义accessdecisionvoter">自定义AccessDecisionVoter<a href="#自定义accessdecisionvoter" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p><code>AccessDecisionManager</code>的实现类中支持<code>List&lt;AccessDecisionVoter&lt;?&gt;&gt; decisionVoters</code>作为参数传入，所以我们也可以通过创建<code>AccessDecisionVoter</code>的实现类创建自定义投票器。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">AccessDecisionVoter</span><span style="color:#f92672">&lt;</span>S<span style="color:#f92672">&gt;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span> ACCESS_GRANTED <span style="color:#f92672">=</span> 1<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span> ACCESS_ABSTAIN <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span> ACCESS_DENIED <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>1<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 用于判断是否授予访问权限
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">vote</span><span style="color:#f92672">(</span>Authentication authentication<span style="color:#f92672">,</span> S object<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>			Collection<span style="color:#f92672">&lt;</span>ConfigAttribute<span style="color:#f92672">&gt;</span> attributes<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">supports</span><span style="color:#f92672">(</span>ConfigAttribute attribute<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">supports</span><span style="color:#f92672">(</span>Class<span style="color:#f92672">&lt;?&gt;</span> clazz<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h3 id="异常控制器">异常控制器<a href="#异常控制器" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<h4 id="未登录异常控制器">未登录异常控制器<a href="#未登录异常控制器" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AdminAuthenticationEntryPoint</span> <span style="color:#66d9ef">implements</span> AuthenticationEntryPoint <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">commence</span><span style="color:#f92672">(</span>HttpServletRequest request<span style="color:#f92672">,</span> 
</span></span><span style="display:flex;"><span>                         HttpServletResponse response<span style="color:#f92672">,</span> 
</span></span><span style="display:flex;"><span>                         AuthenticationException authException<span style="color:#f92672">)</span> 
</span></span><span style="display:flex;"><span>        									<span style="color:#66d9ef">throws</span> IOException<span style="color:#f92672">,</span> ServletException <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        response<span style="color:#f92672">.</span><span style="color:#a6e22e">setHeader</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Content-type&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;text/html;charset=UTF-8&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        response<span style="color:#f92672">.</span><span style="color:#a6e22e">getWriter</span><span style="color:#f92672">().</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span>ResponseBody<span style="color:#f92672">.</span><span style="color:#a6e22e">error</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;您需要登录！&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>        response<span style="color:#f92672">.</span><span style="color:#a6e22e">flushBuffer</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<p>处理未登录情况下所有访问的接口（放行除外）</p>
</blockquote>
<h4 id="无权限异常控制器">无权限异常控制器<a href="#无权限异常控制器" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UrlAccessDeniedHandler</span> <span style="color:#66d9ef">implements</span> AccessDeniedHandler <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">handle</span><span style="color:#f92672">(</span>HttpServletRequest request<span style="color:#f92672">,</span> 
</span></span><span style="display:flex;"><span>                       HttpServletResponse response<span style="color:#f92672">,</span> 
</span></span><span style="display:flex;"><span>                       AccessDeniedException accessDeniedException<span style="color:#f92672">)</span> 
</span></span><span style="display:flex;"><span>        								<span style="color:#66d9ef">throws</span> IOException<span style="color:#f92672">,</span> ServletException <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        response<span style="color:#f92672">.</span><span style="color:#a6e22e">setHeader</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Content-type&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;text/html;charset=UTF-8&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        response<span style="color:#f92672">.</span><span style="color:#a6e22e">getWriter</span><span style="color:#f92672">().</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span>ResponseBody<span style="color:#f92672">.</span><span style="color:#a6e22e">error</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;您无此权限！&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>        response<span style="color:#f92672">.</span><span style="color:#a6e22e">flushBuffer</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<p>处理登录后没有权限访问的路径</p>
</blockquote>
<h3 id="spring-security-config">Spring Security config<a href="#spring-security-config" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Configuration</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">PermissionSecurityConfig</span> <span style="color:#66d9ef">extends</span> WebSecurityConfigurerAdapter <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">configure</span><span style="color:#f92672">(</span>HttpSecurity http<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        ExpressionUrlAuthorizationConfigurer<span style="color:#f92672">&lt;</span>HttpSecurity<span style="color:#f92672">&gt;.</span><span style="color:#a6e22e">ExpressionInterceptUrlRegistry</span> 									registry <span style="color:#f92672">=</span> http<span style="color:#f92672">.</span><span style="color:#a6e22e">antMatcher</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/**&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">authorizeRequests</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        http<span style="color:#f92672">.</span><span style="color:#a6e22e">csrf</span><span style="color:#f92672">().</span><span style="color:#a6e22e">disable</span><span style="color:#f92672">().</span><span style="color:#a6e22e">cors</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 未登录认证异常
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        http<span style="color:#f92672">.</span><span style="color:#a6e22e">exceptionHandling</span><span style="color:#f92672">().</span><span style="color:#a6e22e">authenticationEntryPoint</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> AdminAuthenticationEntryPoint<span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 登录过后访问无权限的接口时自定义403响应内容
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        http<span style="color:#f92672">.</span><span style="color:#a6e22e">exceptionHandling</span><span style="color:#f92672">().</span><span style="color:#a6e22e">accessDeniedHandler</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> UrlAccessDeniedHandler<span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>        registry<span style="color:#f92672">.</span><span style="color:#a6e22e">withObjectPostProcessor</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> ObjectPostProcessor<span style="color:#f92672">&lt;</span>FilterSecurityInterceptor<span style="color:#f92672">&gt;()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">public</span> <span style="color:#f92672">&lt;</span>O <span style="color:#66d9ef">extends</span> FilterSecurityInterceptor<span style="color:#f92672">&gt;</span> O <span style="color:#a6e22e">postProcess</span><span style="color:#f92672">(</span>O object<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                object<span style="color:#f92672">.</span><span style="color:#a6e22e">setSecurityMetadataSource</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">new</span> UrlFilterInvocationSecurityMetadataSource<span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>                object<span style="color:#f92672">.</span><span style="color:#a6e22e">setAccessDecisionManager</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">new</span> UrlAccessDecisionManager<span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> object<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">});</span>
</span></span><span style="display:flex;"><span>        registry
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">.</span><span style="color:#a6e22e">antMatchers</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/hello&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">hasAuthority</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;ADMIN&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">.</span><span style="color:#a6e22e">antMatchers</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/test&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">anonymous</span><span style="color:#f92672">();</span>  <span style="color:#75715e">// hello还需要权限，其他的不需要了
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">super</span><span style="color:#f92672">.</span><span style="color:#a6e22e">configure</span><span style="color:#f92672">(</span>http<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<p>这里是通过<code>ObjectPostProcessor</code>设置<code>FilterSecurityInterceptor</code>的参数注入到容器中的。之前有提到过，<code>ObjectPostProcessor</code>可以将new出来的对象加入容器中。</p>
</blockquote>

      </div></div>

  
  
<div class="pagination">
    <div class="pagination__title">
        <span class="pagination__title-h">其他文章</span>
        <hr />
    </div>
    <div class="pagination__buttons">
        
        <span class="button previous">
            <a href="https://leejay.top/post/hashmap%E7%9A%84%E5%87%A0%E7%82%B9%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9/">
                <span class="button__icon">←</span>
                <span class="button__text">HashMap的几点注意事项</span>
            </a>
        </span>
        
        
        <span class="button next">
            <a href="https://leejay.top/post/redis%E4%BA%8C%E6%8C%81%E4%B9%85%E5%8C%96%E4%B8%8E%E5%A4%8D%E5%88%B6/">
                <span class="button__text">Redis（二）持久化与复制</span>
                <span class="button__icon">→</span>
            </a>
        </span>
        
    </div>
</div>

  

  

</div>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright copyright--user">
        <span>苏ICP备18050258号</span>
    
        
      </div>
  </div>
</footer>

<script src="https://leejay.top/assets/main.js"></script>
<script src="https://leejay.top/assets/prism.js"></script>






  
</div>

</body>
</html>
