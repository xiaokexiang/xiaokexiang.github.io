<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>ConcurrentHashMap</title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="description" content="ConcurrentHashMap JDK1.8ä¹‹åé‡‡ç”¨çš„æ˜¯æ•°ç»„ &#43; é“¾è¡¨ &#43; çº¢é»‘æ ‘çš„ç»“æ„ï¼Œé€šè¿‡Synchronized &#43; CASå®ç°çº¿ç¨‹å®‰å…¨ï¼Œè€ŒJDK1.7é‡‡ç”¨çš„æ˜¯å°†ä¸€ä¸ªHashMapåˆ†æˆå¤šä¸ªSegmentçš„æ–¹å¼ï¼Œé€šè¿‡ç»§æ‰¿ReentrentLockçš„Segmentåˆ†æ®µé”å®ç°çº¿ç¨‹å®‰å…¨ã€‚
Node // Nodeæ•°ç»„ï¼Œç»„æˆConcurrentHashMapçš„ä¸»è¦ç»“æ„ transient volatile Node&amp;lt;K,V&amp;gt;[] table; // æ‰©å®¹æœŸé—´ä¸ä¸ºnullï¼Œå› ä¸ºå­˜åœ¨ååŠ©æ‰©å®¹çš„æœºåˆ¶ï¼Œæ‰€ä»¥éœ€è¦è®¾ç½®volatileä¿è¯çº¿ç¨‹é—´å¯è§æ€§ private transient volatile Node&amp;lt;K,V&amp;gt;[] nextTable; static class Node&amp;lt;K,V&amp;gt; implements Map.Entry&amp;lt;K,V&amp;gt; { final int hash; final K key; volatile V val; volatile Node&amp;lt;K,V&amp;gt; next; Node(int hash, K key, V val, Node&amp;lt;K,V&amp;gt; next) { this.hash = hash; this.key = key; this.val = val; this.next = next; } } // å¦‚æœä¸€ä¸ªindexä¸‹æ‰€æœ‰çš„èŠ‚ç‚¹å…¨éƒ¨è½¬ç§»å®Œåä¼šæ”¾ç½®ForwardingNodeèŠ‚ç‚¹ï¼Œé˜²æ­¢putæ’å…¥é”™è¯¯ä½ç½® // å¦‚æœæ­£åœ¨æ‰©å®¹ä½†æ˜¯putæ’å…¥çš„ä½ç½®ä¸æ˜¯ForwardingNodeè¿˜æ˜¯å¯ä»¥ç»§ç»­putçš„ï¼Œæ”¯æŒä¸¤è€…å¹¶å‘ // å¦‚æœæ˜¯getçš„æ–¹æ³•ï¼Œé‚£ä¹ˆå°±éœ€è¦è·å–nextTableå±æ€§(æ–°çš„chmçš„å¼•ç”¨)ï¼Œç”¨äºè¿”å›æ–°çš„å€¼ static final class ForwardingNode&amp;lt;K,V&amp;gt; extends Node&amp;lt;K,V&amp;gt; { final Node&amp;lt;K,V&amp;gt;[] nextTable; ForwardingNode(Node&amp;lt;K,V&amp;gt;[] tab) { super(MOVED, null, null, null); this."/>
<meta name="keywords" content=""/>
<meta name="robots" content="noodp"/>
<meta name="google-site-verification" content="e1ELBPEvOV5kwQNtzaLcNt-3iZy83eiNhSZkHhQPecs" />
<meta name="baidu-site-verification" content="aNoX6MUEHW" />
<link rel="canonical" href="https://leejay.top/post/concurrenthashmap/" />

<script type="text/javascript"
        async
        src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"
        >
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\[\[','\]\]']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] },
    'HTML-CSS': {
        showMathMenu: false 
    }
  }
});

MathJax.Hub.Queue(function() {
    
    
    
    var all = MathJax.Hub.getAllJax(), i;
    for(i = 0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
});
</script>

<style>
code.has-jax {
    font: inherit;
    font-size: 100%;
    background: inherit;
    border: inherit;
    color: #515151;
}
.MathJax {
  font-family: 'Fira Code'!important;
  font-weight: bold!important;
  line-height: 2!important;
}
</style>




<link rel="stylesheet" href="https://leejay.top/assets/style.css">




<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://leejay.top/img/apple-touch-icon-144-precomposed.png">
<link rel="shortcut icon" href="https://leejay.top/img/favicon.png">



<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="ConcurrentHashMap"/>
<meta name="twitter:description" content="`ConcurrentHashMap`æ˜¯åŸºäº`CAS &#43; Synchronized`çš„çº¿ç¨‹å®‰å…¨çš„HashMapã€‚"/>



<meta property="og:title" content="ConcurrentHashMap" />
<meta property="og:description" content="`ConcurrentHashMap`æ˜¯åŸºäº`CAS &#43; Synchronized`çš„çº¿ç¨‹å®‰å…¨çš„HashMapã€‚" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://leejay.top/post/concurrenthashmap/" />
<meta property="article:published_time" content="2020-07-14T16:58:36+08:00" />
<meta property="article:modified_time" content="2020-07-14T16:58:36+08:00" /><meta property="og:site_name" content="Aurora" />






  </head>
  <body class="">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a href="https://leejay.top" class="logo" style="text-decoration: none;">
  
    <span class="logo__mark"><svg xmlns="https://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367"/>
</svg></span>
    <span class="logo__text">Aurora</span>
    <span class="logo__cursor"></span>
    <span class="logo__cursor2"></span>
  
</a>
    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/categories">Categories</a></li>
        
      
        
          <li><a href="/tags">Tags</a></li>
        
      
      
    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/categories">Categories</a></li>
      
    
      
        <li><a href="/tags">Tags</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none"/>
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="https://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>
      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  
  

  <div class="post">
    <h1 class="post-title"><a href="https://leejay.top/post/concurrenthashmap/">ConcurrentHashMap</a></h1>
    <div class="post-meta">
      
        <span class="post-date">
          2020-07-14
        </span>

        
          
        
      

      
      
    </div>

    
      <span class="post-tags">
        
        ğŸ–<a href="https://leejay.top/tags/concurrenthashmap/">ConcurrentHashMap </a>&nbsp;
        
      </span>
    

    

    <div class="post-content">
      
      <h3 id="concurrenthashmap">ConcurrentHashMap</h3>
<p><code>JDK1.8</code>ä¹‹åé‡‡ç”¨çš„æ˜¯<code>æ•°ç»„ + é“¾è¡¨ + çº¢é»‘æ ‘</code>çš„ç»“æ„ï¼Œé€šè¿‡<code>Synchronized + CAS</code>å®ç°çº¿ç¨‹å®‰å…¨ï¼Œè€Œ<code>JDK1.7</code>é‡‡ç”¨çš„æ˜¯<code>å°†ä¸€ä¸ªHashMapåˆ†æˆå¤šä¸ªSegment</code>çš„æ–¹å¼ï¼Œé€šè¿‡<code>ç»§æ‰¿ReentrentLockçš„Segmentåˆ†æ®µé”</code>å®ç°çº¿ç¨‹å®‰å…¨ã€‚</p>
<h4 id="node">Node</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// Nodeæ•°ç»„ï¼Œç»„æˆConcurrentHashMapçš„ä¸»è¦ç»“æ„
</span><span style="color:#75715e"></span><span style="color:#66d9ef">transient</span> <span style="color:#66d9ef">volatile</span> Node<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;[]</span> table<span style="color:#f92672">;</span>
<span style="color:#75715e">// æ‰©å®¹æœŸé—´ä¸ä¸ºnullï¼Œå› ä¸ºå­˜åœ¨ååŠ©æ‰©å®¹çš„æœºåˆ¶ï¼Œæ‰€ä»¥éœ€è¦è®¾ç½®volatileä¿è¯çº¿ç¨‹é—´å¯è§æ€§
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">transient</span> <span style="color:#66d9ef">volatile</span> Node<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;[]</span> nextTable<span style="color:#f92672">;</span>
<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Node</span><span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">implements</span> Map<span style="color:#f92672">.</span><span style="color:#a6e22e">Entry</span><span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> hash<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">final</span> K key<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">volatile</span> V val<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">volatile</span> Node<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;</span> next<span style="color:#f92672">;</span>

    Node<span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> hash<span style="color:#f92672">,</span> K key<span style="color:#f92672">,</span> V val<span style="color:#f92672">,</span> Node<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;</span> next<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">hash</span> <span style="color:#f92672">=</span> hash<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">key</span> <span style="color:#f92672">=</span> key<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">val</span> <span style="color:#f92672">=</span> val<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">next</span> <span style="color:#f92672">=</span> next<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
<span style="color:#75715e">// å¦‚æœä¸€ä¸ªindexä¸‹æ‰€æœ‰çš„èŠ‚ç‚¹å…¨éƒ¨è½¬ç§»å®Œåä¼šæ”¾ç½®ForwardingNodeèŠ‚ç‚¹ï¼Œé˜²æ­¢putæ’å…¥é”™è¯¯ä½ç½®
</span><span style="color:#75715e">// å¦‚æœæ­£åœ¨æ‰©å®¹ä½†æ˜¯putæ’å…¥çš„ä½ç½®ä¸æ˜¯ForwardingNodeè¿˜æ˜¯å¯ä»¥ç»§ç»­putçš„ï¼Œæ”¯æŒä¸¤è€…å¹¶å‘
</span><span style="color:#75715e">// å¦‚æœæ˜¯getçš„æ–¹æ³•ï¼Œé‚£ä¹ˆå°±éœ€è¦è·å–nextTableå±æ€§(æ–°çš„chmçš„å¼•ç”¨)ï¼Œç”¨äºè¿”å›æ–°çš„å€¼
</span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ForwardingNode</span><span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">extends</span> Node<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">final</span> Node<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;[]</span> nextTable<span style="color:#f92672">;</span>
    ForwardingNode<span style="color:#f92672">(</span>Node<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;[]</span> tab<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">super</span><span style="color:#f92672">(</span>MOVED<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">nextTable</span> <span style="color:#f92672">=</span> tab<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
<span style="color:#75715e">// çº¢é»‘æ ‘çš„æ ¹èŠ‚ç‚¹ä½¿ç”¨çš„TreeNodeï¼Œä¸å­˜å‚¨key-value
</span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TreeBin</span><span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">extends</span> Node<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;</span> <span style="color:#f92672">{</span>
    TreeNode<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;</span> root<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">volatile</span> TreeNode<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;</span> first<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">volatile</span> Thread waiter<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">volatile</span> <span style="color:#66d9ef">int</span> lockState<span style="color:#f92672">;</span>
    <span style="color:#75715e">// values for lockState
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> WRITER <span style="color:#f92672">=</span> 1<span style="color:#f92672">;</span> <span style="color:#75715e">// set while holding write lock 
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> WAITER <span style="color:#f92672">=</span> 2<span style="color:#f92672">;</span> <span style="color:#75715e">// set when waiting for write lock
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> READER <span style="color:#f92672">=</span> 4<span style="color:#f92672">;</span> <span style="color:#75715e">// increment value for setting read lock
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>
<span style="color:#75715e">// æ„å»ºæˆçº¢é»‘æ ‘æ ‘çš„èŠ‚ç‚¹ç»“æ„
</span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TreeNode</span><span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">extends</span> Node<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;</span> <span style="color:#f92672">{</span>
    TreeNode<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;</span> parent<span style="color:#f92672">;</span>  <span style="color:#75715e">// red-black tree links
</span><span style="color:#75715e"></span>    TreeNode<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;</span> left<span style="color:#f92672">;</span>
    TreeNode<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;</span> right<span style="color:#f92672">;</span>
    TreeNode<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;</span> prev<span style="color:#f92672">;</span>    <span style="color:#75715e">// needed to unlink next upon deletion
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">boolean</span> red<span style="color:#f92672">;</span>

    TreeNode<span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> hash<span style="color:#f92672">,</span> K key<span style="color:#f92672">,</span> V val<span style="color:#f92672">,</span> Node<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;</span> next<span style="color:#f92672">,</span>
             TreeNode<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;</span> parent<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">super</span><span style="color:#f92672">(</span>hash<span style="color:#f92672">,</span> key<span style="color:#f92672">,</span> val<span style="color:#f92672">,</span> next<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">parent</span> <span style="color:#f92672">=</span> parent<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<ol>
<li>
<p><code>Node</code>çš„å®šä¹‰ä¸HashMapç±»ä¼¼ï¼Œåªæ˜¯ç”¨<code>volatileä¿®é¥°valueå’Œnext</code>ï¼Œç”¨äº<code>ä¿è¯çº¿ç¨‹é—´çš„å¯è§æ€§</code>ã€‚</p>
</li>
<li>
<p><code>ForwardingNode</code>èŠ‚ç‚¹ç”¨äºè¡¨ç¤ºæ‰©å®¹æœŸé—´ï¼ŒæŒ‡å®šæ•°ç»„ä½ç½®ä¸‹çš„<code>æ‰€æœ‰èŠ‚ç‚¹</code>å…¨éƒ¨è½¬ç§»åï¼Œä¼š<code>ä½¿ç”¨è¯¥èŠ‚ç‚¹å æ®æŒ‡å®šä½ç½®</code>ï¼Œé˜²æ­¢putæ’å…¥é”™è¯¯çš„ä½ç½®ã€‚</p>
</li>
<li>
<p><code>TreeBin</code>ç”¨äºè¡¨ç¤ºçº¢é»‘æ ‘ç»“æ„æ ¹èŠ‚ç‚¹çš„TreeNodeï¼Œ<code>ä¸å­˜å‚¨key-valueæ•°æ®</code>ã€‚</p>
</li>
<li>
<p><code>TreeNode</code>è¡¨ç¤ºç»„æˆçº¢é»‘æ ‘èŠ‚ç‚¹çš„ç»“æ„ï¼Œ<code>å­˜å‚¨key-valueæ•°æ®</code>ã€‚</p>
</li>
<li>
<p>æˆå‘˜å˜é‡<code>nextTable</code>åœ¨<code>æ‰©å®¹æœŸé—´ä¸ä¸ºnull</code>ï¼Œè¡¨ç¤ºæ‰©å®¹ä¸­ä¸‹ä¸ªéœ€è¦ä½¿ç”¨çš„tableã€‚å› ä¸ºçº¿ç¨‹ååŠ©æ‰©å®¹çš„æœºåˆ¶çš„å­˜åœ¨ï¼Œæ‰€ä»¥ç”¨<code>volatile</code>ä¿®é¥°ï¼Œä¿è¯çº¿ç¨‹é—´çš„å¯è§æ€§ã€‚</p>
</li>
</ol>
</blockquote>
<h4 id="æ„é€ ">æ„é€ </h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// è´Ÿæ•°æ—¶è¡¨ç¤ºä¸ºæ­£åœ¨åˆå§‹åŒ–æˆ–æ‰©å®¹ï¼š-1è¡¨ç¤ºåˆå§‹åŒ–æˆ–-(1+æ´»åŠ¨resizeçº¿ç¨‹æ•°é‡)
</span><span style="color:#75715e">// å½“tableä¸ºnullæ—¶ï¼ŒæŒæœ‰åˆå§‹table sizeç›´åˆ°tableåˆ›å»º(é»˜è®¤ä¸º0)
</span><span style="color:#75715e">// åˆå§‹åŒ–åæŒæœ‰ä¸‹ä¸ªå¤§å°ç›´åˆ°æ‰©å®¹table
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">transient</span> <span style="color:#66d9ef">volatile</span> <span style="color:#66d9ef">int</span> sizeCtl<span style="color:#f92672">;</span>
<span style="color:#66d9ef">public</span> <span style="color:#a6e22e">ConcurrentHashMap</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> initialCapacity<span style="color:#f92672">,</span>
                             <span style="color:#66d9ef">float</span> loadFactor<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> concurrencyLevel<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!(</span>loadFactor <span style="color:#f92672">&gt;</span> 0<span style="color:#f92672">.</span><span style="color:#a6e22e">0f</span><span style="color:#f92672">)</span> <span style="color:#f92672">||</span> initialCapacity <span style="color:#f92672">&lt;</span> 0 <span style="color:#f92672">||</span> concurrencyLevel <span style="color:#f92672">&lt;=</span> 0<span style="color:#f92672">)</span>
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> IllegalArgumentException<span style="color:#f92672">();</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>initialCapacity <span style="color:#f92672">&lt;</span> concurrencyLevel<span style="color:#f92672">)</span>
        initialCapacity <span style="color:#f92672">=</span> concurrencyLevel<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">long</span> size <span style="color:#f92672">=</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">long</span><span style="color:#f92672">)(</span>1<span style="color:#f92672">.</span><span style="color:#a6e22e">0</span> <span style="color:#f92672">+</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">long</span><span style="color:#f92672">)</span>initialCapacity <span style="color:#f92672">/</span> loadFactor<span style="color:#f92672">);</span>
    <span style="color:#75715e">// tableSizeForæ–¹æ³•ç”¨äºä¿è¯å®¹é‡å¿…é¡»æ˜¯2æ¬¡å¹‚
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> cap <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>size <span style="color:#f92672">&gt;=</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">long</span><span style="color:#f92672">)</span>MAXIMUM_CAPACITY<span style="color:#f92672">)</span> <span style="color:#f92672">?</span>
        MAXIMUM_CAPACITY <span style="color:#f92672">:</span> tableSizeFor<span style="color:#f92672">((</span><span style="color:#66d9ef">int</span><span style="color:#f92672">)</span>size<span style="color:#f92672">);</span>
    <span style="color:#75715e">// sizeCtlçš„åˆå§‹å€¼å°±æ˜¯cap
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">sizeCtl</span> <span style="color:#f92672">=</span> cap<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<p><code>æ„é€ æ–¹æ³•åªæ˜¯å®šä¹‰äº†å±æ€§ï¼Œå¹¶æ²¡æœ‰çœŸæ­£çš„å¼€è¾Ÿç©ºé—´åˆ›å»ºå¯¹è±¡</code>ã€‚</p>
<p>initialCapacityï¼šåˆå§‹å®¹é‡ï¼Œé»˜è®¤æ˜¯<code>16</code>ã€‚</p>
<p>loadFactorï¼š æ‰©å®¹å› å­ï¼Œé»˜è®¤æ˜¯<code>0.75f</code>ã€‚</p>
<p>concurrencyLevelï¼šå¹¶å‘çº§åˆ«ï¼Œå¹¶å‘æ›´æ–°çº¿ç¨‹çš„æ•°é‡ã€‚</p>
<p>sizeCtlï¼šç”¨äºæ§åˆ¶åœ¨åˆå§‹åŒ–æˆ–è€…å¹¶å‘æ‰©å®¹æ—¶çš„çº¿ç¨‹æ•°ï¼Œé»˜è®¤ä¸º0ï¼Œå¦åˆ™ä¸ºåˆå§‹å®¹é‡å¤§å°capã€‚åœ¨<code>initTable</code>åˆå§‹åŒ–å<code>sizeCtl = 0.75 * æ•°ç»„å¤§å°</code>ã€‚å½“<code>sizeCtl &lt; 0</code>æ—¶å­˜åœ¨ï¼š<code>-1è¡¨ç¤ºæ­£åœ¨åˆå§‹åŒ–ï¼Œ-(1 + æ´»åŠ¨resizeçº¿ç¨‹ï¼‰è¡¨ç¤ºæ­£åœ¨resize</code>ä¸¤ç§æƒ…å†µçš„å€¼ã€‚</p>
</blockquote>
<hr>
<h3 id="put">put</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> V <span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>K key<span style="color:#f92672">,</span> V value<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> putVal<span style="color:#f92672">(</span>key<span style="color:#f92672">,</span> value<span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> HASH_BITS <span style="color:#f92672">=</span> 0x7fffffff<span style="color:#f92672">;</span>
<span style="color:#75715e">// è®¡ç®—hashå€¼ï¼Œé€šè¿‡é«˜ä½16äº¤äº’é¿å…hashå†²çªï¼Œå¹¶é€šè¿‡&amp;è¿ç®—ä¿è¯æœ€é«˜ä½æ˜¯0
</span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">spread</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> h<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span>h <span style="color:#f92672">^</span> <span style="color:#f92672">(</span>h <span style="color:#f92672">&gt;&gt;&gt;</span> 16<span style="color:#f92672">))</span> <span style="color:#f92672">&amp;</span> HASH_BITS<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>


<span style="color:#75715e">// onlyIfAbsentï¼š  false/true å…è®¸è¦†ç›–/ä¸å…è®¸è¦†ç›–
</span><span style="color:#75715e"></span><span style="color:#66d9ef">final</span> V <span style="color:#a6e22e">putVal</span><span style="color:#f92672">(</span>K key<span style="color:#f92672">,</span> V value<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> onlyIfAbsent<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// keyå’Œvalueéƒ½ä¸å…è®¸ä¸ºnullï¼Œhashmapå…è®¸
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>key <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> value <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> NullPointerException<span style="color:#f92672">();</span>
    <span style="color:#75715e">// è®¡ç®—keyçš„hashå€¼
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> hash <span style="color:#f92672">=</span> spread<span style="color:#f92672">(</span>key<span style="color:#f92672">.</span><span style="color:#a6e22e">hashCode</span><span style="color:#f92672">());</span>
    <span style="color:#66d9ef">int</span> binCount <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
    <span style="color:#75715e">// å®šä¹‰å±€éƒ¨å˜é‡ tab = Node[]
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Node<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;[]</span> tab <span style="color:#f92672">=</span> table<span style="color:#f92672">;;)</span> <span style="color:#f92672">{</span>
        Node<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;</span> f<span style="color:#f92672">;</span> <span style="color:#66d9ef">int</span> n<span style="color:#f92672">,</span> i<span style="color:#f92672">,</span> fh<span style="color:#f92672">;</span>
        <span style="color:#75715e">// å¦‚æœtable = null æˆ– table.length = 0ï¼Œè¯´æ˜tableæ²¡æœ‰åˆå§‹åŒ–
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>tab <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> <span style="color:#f92672">(</span>n <span style="color:#f92672">=</span> tab<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">)</span> <span style="color:#f92672">==</span> 0<span style="color:#f92672">)</span>
            <span style="color:#75715e">// åˆå§‹åŒ–table
</span><span style="color:#75715e"></span>            tab <span style="color:#f92672">=</span> initTable<span style="color:#f92672">();</span>
        <span style="color:#75715e">// å¦‚æœtableä¸ä¸ºnullè¯´æ˜å·²ç»åˆå§‹åŒ–è¿‡
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// è®¡ç®—å½“å‰keyåœ¨table[]å¯¹åº”ä½ç½®æ˜¯å¦ä¸ºnull
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>f <span style="color:#f92672">=</span> tabAt<span style="color:#f92672">(</span>tab<span style="color:#f92672">,</span> i <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>n <span style="color:#f92672">-</span> 1<span style="color:#f92672">)</span> <span style="color:#f92672">&amp;</span> hash<span style="color:#f92672">))</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// casè®¾ç½®Nodeåˆ°æŒ‡å®šindexï¼ŒæˆåŠŸå°±é€€å‡º
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// å¤±è´¥è¯´æ˜æœ‰åŒæ ·indexçš„keyåˆšæ“ä½œæˆåŠŸ
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>casTabAt<span style="color:#f92672">(</span>tab<span style="color:#f92672">,</span> i<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span>
                         <span style="color:#66d9ef">new</span> Node<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;(</span>hash<span style="color:#f92672">,</span> key<span style="color:#f92672">,</span> value<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)))</span>
                <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
        <span style="color:#75715e">// å¦‚æœä¸ä¸ºnullåˆ¤æ–­å½“å‰èŠ‚ç‚¹çš„hash == MOVED(-1)ï¼Œè¡¨ç¤ºå½“å‰æ­£åœ¨å¯¹æ•°ç»„è¿›è¡Œæ‰©å®¹
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>fh <span style="color:#f92672">=</span> f<span style="color:#f92672">.</span><span style="color:#a6e22e">hash</span><span style="color:#f92672">)</span> <span style="color:#f92672">==</span> MOVED<span style="color:#f92672">)</span>
            <span style="color:#75715e">// ååŠ©è¿›è¡Œæ‰©å®¹ï¼Œæ‰©å®¹ä¸‹é¢å†åˆ†æ
</span><span style="color:#75715e"></span>            tab <span style="color:#f92672">=</span> helpTransfer<span style="color:#f92672">(</span>tab<span style="color:#f92672">,</span> f<span style="color:#f92672">);</span>
        <span style="color:#75715e">// å·²ç»åˆå§‹åŒ–ï¼Œä¸”ä¸åœ¨æ‰©å®¹ï¼Œé‚£ä¹ˆè°ƒç”¨synchronizedè¿›è¡Œå…ƒç´ çš„æ·»åŠ 
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
            V oldVal <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
            <span style="color:#75715e">// åŠ é”
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span>f<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// åˆ¤æ–­æœ‰æ²¡æœ‰çº¿ç¨‹å¯¹table[i]è¿›è¡Œä¿®æ”¹
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>tabAt<span style="color:#f92672">(</span>tab<span style="color:#f92672">,</span> i<span style="color:#f92672">)</span> <span style="color:#f92672">==</span> f<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#75715e">// fh &gt;= 0è¯´æ˜æ˜¯é“¾è¡¨ç»“æ„
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>fh <span style="color:#f92672">&gt;=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        binCount <span style="color:#f92672">=</span> 1<span style="color:#f92672">;</span>
                        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Node<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;</span> e <span style="color:#f92672">=</span> f<span style="color:#f92672">;;</span> <span style="color:#f92672">++</span>binCount<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                            K ek<span style="color:#f92672">;</span>
                            <span style="color:#75715e">// å¦‚æœhash keyéƒ½ç›¸åŒï¼Œæ›¿æ¢æ—§å€¼
</span><span style="color:#75715e"></span>                            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>e<span style="color:#f92672">.</span><span style="color:#a6e22e">hash</span> <span style="color:#f92672">==</span> hash <span style="color:#f92672">&amp;&amp;</span>
                                <span style="color:#f92672">((</span>ek <span style="color:#f92672">=</span> e<span style="color:#f92672">.</span><span style="color:#a6e22e">key</span><span style="color:#f92672">)</span> <span style="color:#f92672">==</span> key <span style="color:#f92672">||</span>
                                 <span style="color:#f92672">(</span>ek <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> key<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>ek<span style="color:#f92672">))))</span> <span style="color:#f92672">{</span>
                                oldVal <span style="color:#f92672">=</span> e<span style="color:#f92672">.</span><span style="color:#a6e22e">val</span><span style="color:#f92672">;</span>
                                <span style="color:#75715e">// onlyIfAbsent = false æ‰èƒ½æ›¿æ¢
</span><span style="color:#75715e"></span>                                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>onlyIfAbsent<span style="color:#f92672">)</span>
                                    e<span style="color:#f92672">.</span><span style="color:#a6e22e">val</span> <span style="color:#f92672">=</span> value<span style="color:#f92672">;</span>
                                <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
                            <span style="color:#f92672">}</span>
                            <span style="color:#75715e">// å¦åˆ™æ‰¾åˆ°é“¾è¡¨æœ€åçš„èŠ‚ç‚¹ï¼Œå°†å½“å‰èŠ‚ç‚¹åŠ å…¥é“¾æ¥
</span><span style="color:#75715e"></span>                            Node<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;</span> pred <span style="color:#f92672">=</span> e<span style="color:#f92672">;</span>
                            <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>e <span style="color:#f92672">=</span> e<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">)</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                                pred<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Node<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;(</span>hash<span style="color:#f92672">,</span> key<span style="color:#f92672">,</span>
                                                          value<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
                                <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
                            <span style="color:#f92672">}</span>
                        <span style="color:#f92672">}</span>
                    <span style="color:#f92672">}</span>
                    <span style="color:#75715e">// å¦‚æœä¸æ˜¯é“¾è¡¨åˆ¤æ–­æ˜¯ä¸æ˜¯çº¢é»‘æ ‘
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>f <span style="color:#66d9ef">instanceof</span> TreeBin<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        Node<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;</span> p<span style="color:#f92672">;</span>
                        binCount <span style="color:#f92672">=</span> 2<span style="color:#f92672">;</span>
                        <span style="color:#75715e">// è°ƒç”¨çº¢é»‘æ ‘çš„putæ–¹æ³•ï¼Œè¿”å›ä¸æ˜¯nullè¯´æ˜ä¹‹å‰æœ‰è¿‡è¿™ä¸ªkey
</span><span style="color:#75715e"></span>                        <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>p <span style="color:#f92672">=</span> <span style="color:#f92672">((</span>TreeBin<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;)</span>f<span style="color:#f92672">)</span>
                          <span style="color:#f92672">.</span><span style="color:#a6e22e">putTreeVal</span><span style="color:#f92672">(</span>hash<span style="color:#f92672">,</span> key<span style="color:#f92672">,</span>value<span style="color:#f92672">))</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                            oldVal <span style="color:#f92672">=</span> p<span style="color:#f92672">.</span><span style="color:#a6e22e">val</span><span style="color:#f92672">;</span>
                            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>onlyIfAbsent<span style="color:#f92672">)</span>
                                p<span style="color:#f92672">.</span><span style="color:#a6e22e">val</span> <span style="color:#f92672">=</span> value<span style="color:#f92672">;</span>
                        <span style="color:#f92672">}</span>
                    <span style="color:#f92672">}</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
            <span style="color:#75715e">// åˆ¤æ–­binCount &gt;= 8
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>binCount <span style="color:#f92672">!=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>binCount <span style="color:#f92672">&gt;=</span> TREEIFY_THRESHOLD<span style="color:#f92672">)</span>
                    <span style="color:#75715e">// æˆç«‹å°±è½¬æ¢æˆçº¢é»‘æ ‘æˆ–æ‰©å®¹
</span><span style="color:#75715e"></span>                    treeifyBin<span style="color:#f92672">(</span>tab<span style="color:#f92672">,</span> i<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>oldVal <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
                    <span style="color:#66d9ef">return</span> oldVal<span style="color:#f92672">;</span>
                <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    <span style="color:#75715e">// è¿›è¡Œæ•°é‡ç»Ÿè®¡æˆ–æ‰©å®¹
</span><span style="color:#75715e"></span>    addCount<span style="color:#f92672">(</span>1L<span style="color:#f92672">,</span> binCount<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> Node<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;[]</span> <span style="color:#a6e22e">initTable</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    Node<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;[]</span> tab<span style="color:#f92672">;</span> <span style="color:#66d9ef">int</span> sc<span style="color:#f92672">;</span>
    <span style="color:#75715e">// CAS + è‡ªæ—‹,è€æ­æ¡£ï¼Œtableä¸ä¸ºç©ºå°±é€€å‡ºè‡ªæ—‹
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">while</span> <span style="color:#f92672">((</span>tab <span style="color:#f92672">=</span> table<span style="color:#f92672">)</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> tab<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span> <span style="color:#f92672">==</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// å¦‚æœsizeCtl &lt; 0è¯´æ˜æœ‰å…¶ä»–çº¿ç¨‹æ­£åœ¨åˆå§‹åŒ–æˆ–æ‰©å®¹
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>sc <span style="color:#f92672">=</span> sizeCtl<span style="color:#f92672">)</span> <span style="color:#f92672">&lt;</span> 0<span style="color:#f92672">)</span>
            <span style="color:#75715e">// äº¤å‡ºçº¿ç¨‹æ‰§è¡Œæƒï¼Œåªæ˜¯è‡ªæ—‹
</span><span style="color:#75715e"></span>            Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">yield</span><span style="color:#f92672">();</span> <span style="color:#75715e">// lost initialization race; just spin
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// ä¸æ˜¯ï¼Œåˆ™CASä¿®æ”¹sizeCtlä¸º-1ï¼Œè¡¨ç¤ºæ­£åœ¨åˆå§‹åŒ–
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>U<span style="color:#f92672">.</span><span style="color:#a6e22e">compareAndSwapInt</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> SIZECTL<span style="color:#f92672">,</span> sc<span style="color:#f92672">,</span> <span style="color:#f92672">-</span>1<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// ç»§ç»­åˆ¤æ–­ä¸€æ¬¡table==null
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// ç¡®å®ä¼šå‡ºç°ï¼šæ‰§è¡Œåˆ°æ­¤å¤„çº¿ç¨‹åˆ‡æ¢ï¼Œåˆ«çš„çº¿ç¨‹æ‰§è¡Œäº†åˆå§‹åŒ–
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>tab <span style="color:#f92672">=</span> table<span style="color:#f92672">)</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> tab<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span> <span style="color:#f92672">==</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#75715e">// å¦‚æœsizeCtl &gt; 0è¯´æ˜æ„é€ å‡½æ•°è®¾ç½®äº†sizeCtlï¼Œå¦åˆ™é»˜è®¤cap=16
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">int</span> n <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>sc <span style="color:#f92672">&gt;</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">?</span> sc <span style="color:#f92672">:</span> DEFAULT_CAPACITY<span style="color:#f92672">;</span>
                    <span style="color:#a6e22e">@SuppressWarnings</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;unchecked&#34;</span><span style="color:#f92672">)</span>
                    <span style="color:#75715e">// å®šä¹‰æ•°ç»„çš„å¤§å°
</span><span style="color:#75715e"></span>                    Node<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;[]</span> nt <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>Node<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;[])</span><span style="color:#66d9ef">new</span> Node<span style="color:#f92672">&lt;?,?&gt;[</span>n<span style="color:#f92672">];</span>
                    <span style="color:#75715e">// tableæˆå‘˜å˜é‡æŒ‡å‘ntåˆšåˆ›å»ºçš„æ•°ç»„
</span><span style="color:#75715e"></span>                    table <span style="color:#f92672">=</span> tab <span style="color:#f92672">=</span> nt<span style="color:#f92672">;</span>
                    <span style="color:#75715e">// è®¡ç®—æ–°çš„sizeCtlï¼Œè¡¨ç¤ºä¸‹ä¸€æ¬¡æ‰©å®¹çš„é˜ˆå€¼0.75n
</span><span style="color:#75715e"></span>                    sc <span style="color:#f92672">=</span> n <span style="color:#f92672">-</span> <span style="color:#f92672">(</span>n <span style="color:#f92672">&gt;&gt;&gt;</span> 2<span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
                sizeCtl <span style="color:#f92672">=</span> sc<span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> tab<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> MIN_TREEIFY_CAPACITY <span style="color:#f92672">=</span> 64<span style="color:#f92672">;</span>
<span style="color:#75715e">// åˆ¤æ–­è½¬æˆçº¢é»‘æ ‘è¿˜æ˜¯æ‰©å®¹
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">treeifyBin</span><span style="color:#f92672">(</span>Node<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;[]</span> tab<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> index<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    Node<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;</span> b<span style="color:#f92672">;</span> <span style="color:#66d9ef">int</span> n<span style="color:#f92672">,</span> sc<span style="color:#f92672">;</span>
    <span style="color:#75715e">// tableä¸èƒ½ä¸ºnull
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>tab <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// åˆ¤æ–­æ•°ç»„é•¿åº¦æ˜¯å¦å°äº64
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>n <span style="color:#f92672">=</span> tab<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">)</span> <span style="color:#f92672">&lt;</span> MIN_TREEIFY_CAPACITY<span style="color:#f92672">)</span>
            <span style="color:#75715e">// æ‰©å®¹çš„æ ¸å¿ƒæ–¹æ³•ï¼Œä¸‹é¢å†åˆ†æï¼Œæ‰©å¤§ä¸€å€
</span><span style="color:#75715e"></span>            tryPresize<span style="color:#f92672">(</span>n <span style="color:#f92672">&lt;&lt;</span> 1<span style="color:#f92672">);</span>
        <span style="color:#75715e">// è½¬æˆçº¢é»‘æ ‘
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>b <span style="color:#f92672">=</span> tabAt<span style="color:#f92672">(</span>tab<span style="color:#f92672">,</span> index<span style="color:#f92672">))</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> b<span style="color:#f92672">.</span><span style="color:#a6e22e">hash</span> <span style="color:#f92672">&gt;=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span>b<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>tabAt<span style="color:#f92672">(</span>tab<span style="color:#f92672">,</span> index<span style="color:#f92672">)</span> <span style="color:#f92672">==</span> b<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    TreeNode<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;</span> hd <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> tl <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
                    <span style="color:#75715e">// å°†é“¾è¡¨è½¬æ¢æˆçº¢é»‘æ ‘
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Node<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;</span> e <span style="color:#f92672">=</span> b<span style="color:#f92672">;</span> e <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span> e <span style="color:#f92672">=</span> e<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        <span style="color:#75715e">// éå†æ¯ä¸ªèŠ‚ç‚¹ï¼Œåˆ›å»ºå¯¹åº”çš„TreeNode
</span><span style="color:#75715e"></span>                        TreeNode<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;</span> p <span style="color:#f92672">=</span>
                            <span style="color:#66d9ef">new</span> TreeNode<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;(</span>e<span style="color:#f92672">.</span><span style="color:#a6e22e">hash</span><span style="color:#f92672">,</span> e<span style="color:#f92672">.</span><span style="color:#a6e22e">key</span><span style="color:#f92672">,</span> e<span style="color:#f92672">.</span><span style="color:#a6e22e">val</span><span style="color:#f92672">,</span>
                                              <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
                        <span style="color:#75715e">// å»ºç«‹æ ‘ä¹‹é—´çš„å…³ç³»
</span><span style="color:#75715e"></span>                        <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>p<span style="color:#f92672">.</span><span style="color:#a6e22e">prev</span> <span style="color:#f92672">=</span> tl<span style="color:#f92672">)</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
                            hd <span style="color:#f92672">=</span> p<span style="color:#f92672">;</span>
                        <span style="color:#66d9ef">else</span>
                            tl<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span> <span style="color:#f92672">=</span> p<span style="color:#f92672">;</span>
                        tl <span style="color:#f92672">=</span> p<span style="color:#f92672">;</span>
                    <span style="color:#f92672">}</span>
                    <span style="color:#75715e">// å°†ç¬¬ä¸€ä¸ªæ ‘èŠ‚ç‚¹æ”¾åˆ°TreeBinå®¹å™¨ä¸­
</span><span style="color:#75715e"></span>                    setTabAt<span style="color:#f92672">(</span>tab<span style="color:#f92672">,</span> index<span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> TreeBin<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;(</span>hd<span style="color:#f92672">));</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<ol>
<li>
<p><code>ConcurrentHashMap</code>çš„ putæ–¹æ³•ä¸­ä¸å…è®¸<code>keyå’Œvalueçš„å€¼ä¸ºnull</code>ï¼Œè¿™ä¸HashMapä¸åŒã€‚</p>
</li>
<li>
<p><code>ConcurrentHashMap</code>çš„<code>table(Node[])åœ¨putæ–¹æ³•ä¸­æ‰ä¼šåˆå§‹åŒ–</code>ï¼Œæ„é€ å‡½æ•°ä¸­å¹¶ä¸ä¼šåˆå§‹åŒ–ã€‚</p>
</li>
<li>
<p><code>initTable</code>æ–¹æ³•ä¸­é€šè¿‡<code>è‡ªæ—‹+CAS</code>å®ç°çº¿ç¨‹å®‰å…¨çš„tableåˆå§‹åŒ–ã€‚</p>
</li>
<li>
<p><code>sizeCtl</code>æˆå‘˜å˜é‡åœ¨<code>åˆå§‹åŒ–åå°±ä¸å†ç­‰äºæ•°ç»„é•¿åº¦</code>ï¼Œè€Œæ˜¯ç”¨äºè¡¨ç¤º<code>æ‰©å®¹é˜ˆå€¼(0.75n)</code>ã€‚</p>
</li>
<li>
<p><code>treeifyBin</code>è‹¥<code>å½“å‰table.length &lt; 64æ—¶ä¼šå˜æˆåŸæ¥çš„2å€ï¼Œå¦åˆ™ä¼šè½¬æ¢æˆçº¢é»‘æ ‘</code>ã€‚</p>
</li>
<li>
<p><code>addCount</code>æ–¹æ³•ç”¨äºæ·»åŠ è®¡æ•°ï¼Œå¦‚æœtableå¤ªå°ä¸”è¿˜æœªè°ƒæ•´å¤§å°ï¼Œåˆ™è°ƒç”¨transferæ‰©å®¹ã€‚ å¦‚æœå·²ç»è°ƒæ•´äº†å¤§å°ï¼Œé‚£ä¹ˆéœ€è¦å¸®åŠ©æ‰©å®¹ã€‚</p>
</li>
<li>
<p>æ‰§è¡Œæµç¨‹ï¼š</p>
<p>â‘ åˆ¤æ–­é˜Ÿåˆ—æ˜¯å¦ä¸ºç©ºï¼Œä¸ºç©ºå°±å…ˆåˆå§‹åŒ–é˜Ÿåˆ—ã€‚</p>
<p>â‘¡ä¸ä¸ºç©ºå°±æŸ¥çœ‹æ•°ç»„å½“å‰ä½ç½®æ˜¯å¦ä¸ºnullï¼Œå¦‚æœä¸ºnullç›´æ¥åˆ›å»ºNodeæ”¾åœ¨æ­¤ä½ç½®ã€‚</p>
<p>â‘¢åˆ¤æ–­å½“å‰æ•°ç»„æ˜¯å¦åœ¨<code>æ‰©å®¹(f.hash == MOVED)</code>ï¼Œå¦‚æœæ˜¯æ­£åœ¨æ‰©å®¹ï¼Œé‚£ä¹ˆå½“å‰çº¿ç¨‹ååŠ©æ‰©å®¹ã€‚</p>
<p>â‘£å¦‚æœâ‘ â‘¡â‘¢éƒ½ä¸æˆç«‹ï¼Œé‚£ä¹ˆä½¿ç”¨<code>synchronized</code>åŠ é”å‡†å¤‡æ‰§è¡Œâ‘¤â‘¥ã€‚</p>
<p>â‘¤å¦‚æœå½“å‰èŠ‚ç‚¹å­˜æ”¾çš„æ˜¯é“¾è¡¨ï¼Œé‚£ä¹ˆå°†é“¾è¡¨ä¸­çš„èŠ‚ç‚¹ä¾æ¬¡æ¯”è¾ƒï¼Œå¦‚æœç›¸åŒå°±æ›¿æ¢ï¼Œå¦‚æœæ²¡æœ‰ç›¸åŒçš„é‚£å°±æ·»åŠ åˆ°<code>é“¾è¡¨å°¾éƒ¨</code>ã€‚</p>
<p>â‘¥å¦‚æœå½“å‰èŠ‚ç‚¹å­˜æ”¾çš„æ˜¯çº¢é»‘æ ‘ï¼Œè°ƒç”¨putTreeValæ·»åŠ åˆ°æ ‘ä¸Šï¼Œå¦‚æœåŒä¸€ä¸ªä½ç½®ä¸‹<code>èŠ‚ç‚¹è¶…è¿‡8ä¸ª</code>ï¼Œä¸”<code>æ•°ç»„å¤§å°è¶…è¿‡64</code>ï¼Œé‚£ä¹ˆä¼šå°†é“¾è¡¨è½¬æˆçº¢é»‘æ ‘ï¼Œå¦åˆ™ä¼š<code>æ‰©å®¹æˆåŸæ¥æ•°ç»„ä¸¤å€</code>ã€‚</p>
<p>â‘¦æœ€åæ‰§è¡Œ<code>addCount</code>è®¡æ•°å¹¶åˆ¤æ–­æ˜¯å¦éœ€è¦æ‰©å®¹ã€‚</p>
</li>
</ol>
</blockquote>
<hr>
<h3 id="resize">resize</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> MIN_TRANSFER_STRIDE <span style="color:#f92672">=</span> 16<span style="color:#f92672">;</span>
<span style="color:#75715e">// æ‰©å®¹æœŸé—´è¡¨ç¤ºä¸‹ä¸€ä¸ªæ•°ç»„çš„index
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">transient</span> <span style="color:#66d9ef">volatile</span> <span style="color:#66d9ef">int</span> transferIndex<span style="color:#f92672">;</span>
<span style="color:#75715e">// æ‰©å®¹çš„æ ¸å¿ƒæ–¹æ³•ï¼Œå‚æ•°åŸæœ‰çš„tableå’Œæ‰©å®¹åçš„table
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">transfer</span><span style="color:#f92672">(</span>Node<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;[]</span> tab<span style="color:#f92672">,</span> Node<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;[]</span> nextTab<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// å®šä¹‰æ•°ç»„é•¿åº¦å’Œæ­¥é•¿
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> n <span style="color:#f92672">=</span> tab<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">,</span> stride<span style="color:#f92672">;</span>
    <span style="color:#75715e">// å¦‚æœCPUæ ¸æ•°å¤§äº1ï¼Œè®¡ç®— n/(8*NCPU) &lt; 16æˆç«‹ æ­¥é•¿stride = 16
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// å•æ ¸æƒ…å†µä¸‹ï¼Œé»˜è®¤ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œæ‰©å®¹
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>stride <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>NCPU <span style="color:#f92672">&gt;</span> 1<span style="color:#f92672">)</span> <span style="color:#f92672">?</span> <span style="color:#f92672">(</span>n <span style="color:#f92672">&gt;&gt;&gt;</span> 3<span style="color:#f92672">)</span> <span style="color:#f92672">/</span> NCPU <span style="color:#f92672">:</span> n<span style="color:#f92672">)</span> <span style="color:#f92672">&lt;</span> MIN_TRANSFER_STRIDE<span style="color:#f92672">)</span>
        stride <span style="color:#f92672">=</span> MIN_TRANSFER_STRIDE<span style="color:#f92672">;</span>
    <span style="color:#75715e">// å¦‚æœnextTableä¸ºnullï¼Œé‚£ä¹ˆåˆ›å»ºæ‰©å®¹åçš„table[]ï¼Œé»˜è®¤æ˜¯2å€
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>nextTab <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
            <span style="color:#a6e22e">@SuppressWarnings</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;unchecked&#34;</span><span style="color:#f92672">)</span>
            <span style="color:#75715e">// åˆå§‹åŒ–åˆ›å»ºå¤§å°ä¸º2å€åŸæœ‰æ•°ç»„é•¿åº¦çš„æ•°ç»„
</span><span style="color:#75715e"></span>            Node<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;[]</span> nt <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>Node<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;[])</span><span style="color:#66d9ef">new</span> Node<span style="color:#f92672">&lt;?,?&gt;[</span>n <span style="color:#f92672">&lt;&lt;</span> 1<span style="color:#f92672">];</span>
            nextTab <span style="color:#f92672">=</span> nt<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Throwable ex<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            sizeCtl <span style="color:#f92672">=</span> Integer<span style="color:#f92672">.</span><span style="color:#a6e22e">MAX_VALUE</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
        <span style="color:#75715e">// å°†åˆ›å»ºçš„æ•°ç»„èµ‹äºˆnextTableæˆå‘˜å˜é‡ï¼Œåœ¨æ­¤å¤„è¢«èµ‹å€¼ï¼Œåªæœ‰æ‰©å®¹æœŸé—´æ­¤å‚æ•°ä¸ä¸ºnull
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// è¯´æ˜æ˜¯ç¬¬ä¸€ä¸ªæ‰©å®¹çš„çº¿ç¨‹,æ­¤åå¦‚æœæœ‰å…¶ä»–çº¿ç¨‹è°ƒç”¨putï¼Œé‚£ä¹ˆä¹Ÿä¼šè¿›æ¥å¸®å¿™
</span><span style="color:#75715e"></span>        nextTable <span style="color:#f92672">=</span> nextTab<span style="color:#f92672">;</span>
        <span style="color:#75715e">// é»˜è®¤æ˜¯æ—§tableçš„å¤§å°ï¼Œç”¨äºè¡¨ç¤ºæ•°ç»„æ‰©å®¹è¿›åº¦
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// [0, transferIndex-1]è¡¨ç¤ºè¿˜æœªåˆ†é…åˆ°çº¿ç¨‹æ‰©å®¹çš„éƒ¨åˆ†
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// [transferIndexï¼Œ n-1]è¡¨ç¤ºå·²ç»åˆ†é…ç»™æŸä¸ªçº¿ç¨‹æ­£åœ¨æ‰©å®¹æˆ–å·²ç»æ‰©å®¹å®Œæˆçš„éƒ¨åˆ†
</span><span style="color:#75715e"></span>        transferIndex <span style="color:#f92672">=</span> n<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">int</span> nextn <span style="color:#f92672">=</span> nextTab<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">;</span>
    <span style="color:#75715e">// åˆ›å»ºForwardingNodeï¼Œå¹¶èµ‹å€¼nextTab
</span><span style="color:#75715e"></span>    ForwardingNode<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;</span> fwd <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ForwardingNode<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;(</span>nextTab<span style="color:#f92672">);</span>
    <span style="color:#75715e">// ç»“åˆä¸‹æ–‡ï¼šadvanceè¡¨ç¤ºä»i(transferIndex - 1)åˆ°boundä½ç½®è¿‡ç¨‹ä¸­æ˜¯å¦ä¸€ç›´ç»§ç»­
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">boolean</span> advance <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
    <span style="color:#75715e">// è¡¨ç¤ºæ‰©å®¹æ˜¯å¦ç»“æŸ
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">boolean</span> finishing <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
    <span style="color:#75715e">// i è¡¨ç¤ºä¸º éå†çš„ä¸‹æ ‡ï¼Œboundä¸ºéå†çš„è¾¹ç•Œ
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// i = nextIndex - 1;bound = nextIndex - strideï¼Œæ‹¿ä¸åˆ°ä»»åŠ¡ä¸¤è€…éƒ½ä¸º0
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0<span style="color:#f92672">,</span> bound <span style="color:#f92672">=</span> 0<span style="color:#f92672">;;)</span> <span style="color:#f92672">{</span>
        Node<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;</span> f<span style="color:#f92672">;</span> <span style="color:#66d9ef">int</span> fh<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>advance<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// ä»¥ä¸‹ä¸‰ä¸ªåˆ†æ”¯ï¼Œä¸€ä¸ªæˆåŠŸå°±ä¼šé€€å‡ºwhileå¾ªç¯
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">int</span> nextIndex<span style="color:#f92672">,</span> nextBound<span style="color:#f92672">;</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(--</span>i <span style="color:#f92672">&gt;=</span> bound <span style="color:#f92672">||</span> finishing<span style="color:#f92672">)</span>
                advance <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>nextIndex <span style="color:#f92672">=</span> transferIndex<span style="color:#f92672">)</span> <span style="color:#f92672">&lt;=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                i <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>1<span style="color:#f92672">;</span>
                advance <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
            <span style="color:#75715e">// å› ä¸ºæ‰©å®¹åˆ†é…ç»™å¤šä¸ªçº¿ç¨‹éœ€è¦åŒæ­¥ï¼Œä½¿ç”¨CASæ“ä½œtransferIndex
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// å°è¯•ä¸ºå½“å‰çº¿ç¨‹åˆ†é…æ­¥é•¿ï¼ŒCASæ“ä½œæˆåŠŸå°±è¡¨ç¤ºæ‹¿åˆ°æ­¥é•¿äº†ã€‚
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>U<span style="color:#f92672">.</span><span style="color:#a6e22e">compareAndSwapInt</span>
                     <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> TRANSFERINDEX<span style="color:#f92672">,</span> nextIndex<span style="color:#f92672">,</span>
                      nextBound <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>nextIndex <span style="color:#f92672">&gt;</span> stride <span style="color:#f92672">?</span>
                                   nextIndex <span style="color:#f92672">-</span> stride <span style="color:#f92672">:</span> 0<span style="color:#f92672">)))</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// åˆ†é…æˆåŠŸå°±ä¿®æ”¹boundå’Œiï¼Œadvanceé€€å‡ºå¾ªç¯
</span><span style="color:#75715e"></span>                bound <span style="color:#f92672">=</span> nextBound<span style="color:#f92672">;</span>
                i <span style="color:#f92672">=</span> nextIndex <span style="color:#f92672">-</span> 1<span style="color:#f92672">;</span>
                advance <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
        <span style="color:#75715e">// è‡³æ­¤iä¸ºè´Ÿæ•°ï¼Œæ•´ä¸ªhashmapå·²ç»éå†å®Œæˆäº†ï¼Œå‡†å¤‡æ‰©å®¹
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// å¦‚æœ i&lt;0 æˆ–i &gt;= æ—§æ•°ç»„å¤§å°n æˆ– i + n &gt;= æ–°æ•°ç»„å¤§å°
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>i <span style="color:#f92672">&lt;</span> 0 <span style="color:#f92672">||</span> i <span style="color:#f92672">&gt;=</span> n <span style="color:#f92672">||</span> i <span style="color:#f92672">+</span> n <span style="color:#f92672">&gt;=</span> nextn<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">int</span> sc<span style="color:#f92672">;</span>
            <span style="color:#75715e">// å¦‚æœfinishing = trueè¯´æ˜æ‰©å®¹å®Œæˆ
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>finishing<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// å°†nextTableç½®ä¸ºnullï¼Œå°†
</span><span style="color:#75715e"></span>                nextTable <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
                table <span style="color:#f92672">=</span> nextTab<span style="color:#f92672">;</span>
                sizeCtl <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>n <span style="color:#f92672">&lt;&lt;</span> 1<span style="color:#f92672">)</span> <span style="color:#f92672">-</span> <span style="color:#f92672">(</span>n <span style="color:#f92672">&gt;&gt;&gt;</span> 1<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>U<span style="color:#f92672">.</span><span style="color:#a6e22e">compareAndSwapInt</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> SIZECTL<span style="color:#f92672">,</span> sc <span style="color:#f92672">=</span> sizeCtl<span style="color:#f92672">,</span> sc <span style="color:#f92672">-</span> 1<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>sc <span style="color:#f92672">-</span> 2<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> resizeStamp<span style="color:#f92672">(</span>n<span style="color:#f92672">)</span> <span style="color:#f92672">&lt;&lt;</span> RESIZE_STAMP_SHIFT<span style="color:#f92672">)</span>
                    <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
                finishing <span style="color:#f92672">=</span> advance <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                i <span style="color:#f92672">=</span> n<span style="color:#f92672">;</span> <span style="color:#75715e">// recheck before commit
</span><span style="color:#75715e"></span>            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
        <span style="color:#75715e">// table[i]è¿ç§»å®Œæ¯•ï¼Œæ­¤ä½ç½®æ”¾ä¸ªForwardingNode
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>f <span style="color:#f92672">=</span> tabAt<span style="color:#f92672">(</span>tab<span style="color:#f92672">,</span> i<span style="color:#f92672">))</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
            advance <span style="color:#f92672">=</span> casTabAt<span style="color:#f92672">(</span>tab<span style="color:#f92672">,</span> i<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> fwd<span style="color:#f92672">);</span>
        <span style="color:#75715e">// è¯´æ˜è¿™ä¸ªä½ç½®å·²ç»åœ¨è¿ç§»ä¸­äº† fh = f.hash
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>fh <span style="color:#f92672">=</span> f<span style="color:#f92672">.</span><span style="color:#a6e22e">hash</span><span style="color:#f92672">)</span> <span style="color:#f92672">==</span> MOVED<span style="color:#f92672">)</span>
            advance <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// å¯¹table[i]å¼€å§‹è¿ç§»
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span>f<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// å…ˆåˆ¤æ–­æ­¤ä½ç½®æœ‰æ²¡æœ‰è¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>tabAt<span style="color:#f92672">(</span>tab<span style="color:#f92672">,</span> i<span style="color:#f92672">)</span> <span style="color:#f92672">==</span> f<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    Node<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;</span> ln<span style="color:#f92672">,</span> hn<span style="color:#f92672">;</span>
                    <span style="color:#75715e">// å¦‚æœfh &gt; 0è¯´æ˜æ˜¯é“¾è¡¨
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>fh <span style="color:#f92672">&gt;=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        <span style="color:#66d9ef">int</span> runBit <span style="color:#f92672">=</span> fh <span style="color:#f92672">&amp;</span> n<span style="color:#f92672">;</span>
                        Node<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;</span> lastRun <span style="color:#f92672">=</span> f<span style="color:#f92672">;</span>
                        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Node<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;</span> p <span style="color:#f92672">=</span> f<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">;</span> p <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span> p <span style="color:#f92672">=</span> p<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                            <span style="color:#66d9ef">int</span> b <span style="color:#f92672">=</span> p<span style="color:#f92672">.</span><span style="color:#a6e22e">hash</span> <span style="color:#f92672">&amp;</span> n<span style="color:#f92672">;</span>
                            <span style="color:#75715e">// å½“b!=runBitæ—¶è¡¨æ˜èŠ‚ç‚¹påçš„å…¨éƒ¨èŠ‚ç‚¹çš„hashcodeéƒ½ç›¸åŒ
</span><span style="color:#75715e"></span>                            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>b <span style="color:#f92672">!=</span> runBit<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                                runBit <span style="color:#f92672">=</span> b<span style="color:#f92672">;</span>
                                lastRun <span style="color:#f92672">=</span> p<span style="color:#f92672">;</span>
                            <span style="color:#f92672">}</span>
                        <span style="color:#f92672">}</span>
                        <span style="color:#75715e">// å’Œhashmapä¸€è‡´ hashcode &amp; n = 0å°±ä¸å¹³ç§»ï¼Œä¸ç­‰äºå°±å¹³ç§»
</span><span style="color:#75715e"></span>                        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>runBit <span style="color:#f92672">==</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                            ln <span style="color:#f92672">=</span> lastRun<span style="color:#f92672">;</span>
                            hn <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
                        <span style="color:#f92672">}</span>
                        <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                            hn <span style="color:#f92672">=</span> lastRun<span style="color:#f92672">;</span>
                            ln <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
                        <span style="color:#f92672">}</span>
                        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Node<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;</span> p <span style="color:#f92672">=</span> f<span style="color:#f92672">;</span> p <span style="color:#f92672">!=</span> lastRun<span style="color:#f92672">;</span> p <span style="color:#f92672">=</span> p<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                            <span style="color:#66d9ef">int</span> ph <span style="color:#f92672">=</span> p<span style="color:#f92672">.</span><span style="color:#a6e22e">hash</span><span style="color:#f92672">;</span> K pk <span style="color:#f92672">=</span> p<span style="color:#f92672">.</span><span style="color:#a6e22e">key</span><span style="color:#f92672">;</span> V pv <span style="color:#f92672">=</span> p<span style="color:#f92672">.</span><span style="color:#a6e22e">val</span><span style="color:#f92672">;</span>
                            <span style="color:#75715e">// ä¸‹é¢æ˜¯å°†é“¾è¡¨ä¸­çš„èŠ‚ç‚¹å¹³ç§»åˆ°æ–°çš„æ•°ç»„ä¸­
</span><span style="color:#75715e"></span>                            <span style="color:#75715e">// è¿™ç‚¹hashmapæ˜¯ä¸€è‡´çš„ï¼Œé€šè¿‡hashcode &amp; æ•°ç»„é•¿åº¦æ¥åˆ¤æ–­
</span><span style="color:#75715e"></span>                            <span style="color:#75715e">// å¦‚æœéœ€è¦å¹³ç§»ï¼Œé‚£ä¹ˆå¹³ç§»åçš„index = oldIndex + n
</span><span style="color:#75715e"></span>                            <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>ph <span style="color:#f92672">&amp;</span> n<span style="color:#f92672">)</span> <span style="color:#f92672">==</span> 0<span style="color:#f92672">)</span>
                                ln <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Node<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;(</span>ph<span style="color:#f92672">,</span> pk<span style="color:#f92672">,</span> pv<span style="color:#f92672">,</span> ln<span style="color:#f92672">);</span>
                            <span style="color:#66d9ef">else</span>
                                hn <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Node<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;(</span>ph<span style="color:#f92672">,</span> pk<span style="color:#f92672">,</span> pv<span style="color:#f92672">,</span> hn<span style="color:#f92672">);</span>
                        <span style="color:#f92672">}</span>
                        setTabAt<span style="color:#f92672">(</span>nextTab<span style="color:#f92672">,</span> i<span style="color:#f92672">,</span> ln<span style="color:#f92672">);</span>
                        setTabAt<span style="color:#f92672">(</span>nextTab<span style="color:#f92672">,</span> i <span style="color:#f92672">+</span> n<span style="color:#f92672">,</span> hn<span style="color:#f92672">);</span>
                        setTabAt<span style="color:#f92672">(</span>tab<span style="color:#f92672">,</span> i<span style="color:#f92672">,</span> fwd<span style="color:#f92672">);</span>
                        advance <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                    <span style="color:#f92672">}</span>
                    <span style="color:#75715e">// ä¸‹é¢æ˜¯å¤„ç†çº¢é»‘æ ‘çš„è¿ç§»
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>f <span style="color:#66d9ef">instanceof</span> TreeBin<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        TreeBin<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;</span> t <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>TreeBin<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;)</span>f<span style="color:#f92672">;</span>
                        TreeNode<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;</span> lo <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> loTail <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
                        TreeNode<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;</span> hi <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> hiTail <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
                        <span style="color:#66d9ef">int</span> lc <span style="color:#f92672">=</span> 0<span style="color:#f92672">,</span> hc <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
                        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Node<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;</span> e <span style="color:#f92672">=</span> t<span style="color:#f92672">.</span><span style="color:#a6e22e">first</span><span style="color:#f92672">;</span> e <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span> e <span style="color:#f92672">=</span> e<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                            <span style="color:#66d9ef">int</span> h <span style="color:#f92672">=</span> e<span style="color:#f92672">.</span><span style="color:#a6e22e">hash</span><span style="color:#f92672">;</span>
                            TreeNode<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;</span> p <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> TreeNode<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;</span>
                                <span style="color:#f92672">(</span>h<span style="color:#f92672">,</span> e<span style="color:#f92672">.</span><span style="color:#a6e22e">key</span><span style="color:#f92672">,</span> e<span style="color:#f92672">.</span><span style="color:#a6e22e">val</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
                            <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>h <span style="color:#f92672">&amp;</span> n<span style="color:#f92672">)</span> <span style="color:#f92672">==</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                                <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>p<span style="color:#f92672">.</span><span style="color:#a6e22e">prev</span> <span style="color:#f92672">=</span> loTail<span style="color:#f92672">)</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
                                    lo <span style="color:#f92672">=</span> p<span style="color:#f92672">;</span>
                                <span style="color:#66d9ef">else</span>
                                    loTail<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span> <span style="color:#f92672">=</span> p<span style="color:#f92672">;</span>
                                loTail <span style="color:#f92672">=</span> p<span style="color:#f92672">;</span>
                                <span style="color:#f92672">++</span>lc<span style="color:#f92672">;</span>
                            <span style="color:#f92672">}</span>
                            <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                                <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>p<span style="color:#f92672">.</span><span style="color:#a6e22e">prev</span> <span style="color:#f92672">=</span> hiTail<span style="color:#f92672">)</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
                                    hi <span style="color:#f92672">=</span> p<span style="color:#f92672">;</span>
                                <span style="color:#66d9ef">else</span>
                                    hiTail<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span> <span style="color:#f92672">=</span> p<span style="color:#f92672">;</span>
                                hiTail <span style="color:#f92672">=</span> p<span style="color:#f92672">;</span>
                                <span style="color:#f92672">++</span>hc<span style="color:#f92672">;</span>
                            <span style="color:#f92672">}</span>
                        <span style="color:#f92672">}</span>
                        ln <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>lc <span style="color:#f92672">&lt;=</span> UNTREEIFY_THRESHOLD<span style="color:#f92672">)</span> <span style="color:#f92672">?</span> untreeify<span style="color:#f92672">(</span>lo<span style="color:#f92672">)</span> <span style="color:#f92672">:</span>
                        <span style="color:#f92672">(</span>hc <span style="color:#f92672">!=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">?</span> <span style="color:#66d9ef">new</span> TreeBin<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;(</span>lo<span style="color:#f92672">)</span> <span style="color:#f92672">:</span> t<span style="color:#f92672">;</span>
                        hn <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>hc <span style="color:#f92672">&lt;=</span> UNTREEIFY_THRESHOLD<span style="color:#f92672">)</span> <span style="color:#f92672">?</span> untreeify<span style="color:#f92672">(</span>hi<span style="color:#f92672">)</span> <span style="color:#f92672">:</span>
                        <span style="color:#f92672">(</span>lc <span style="color:#f92672">!=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">?</span> <span style="color:#66d9ef">new</span> TreeBin<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;(</span>hi<span style="color:#f92672">)</span> <span style="color:#f92672">:</span> t<span style="color:#f92672">;</span>
                        setTabAt<span style="color:#f92672">(</span>nextTab<span style="color:#f92672">,</span> i<span style="color:#f92672">,</span> ln<span style="color:#f92672">);</span>
                        setTabAt<span style="color:#f92672">(</span>nextTab<span style="color:#f92672">,</span> i <span style="color:#f92672">+</span> n<span style="color:#f92672">,</span> hn<span style="color:#f92672">);</span>
                        setTabAt<span style="color:#f92672">(</span>tab<span style="color:#f92672">,</span> i<span style="color:#f92672">,</span> fwd<span style="color:#f92672">);</span>
                        advance <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                    <span style="color:#f92672">}</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
<span style="color:#75715e">// tryPersizeå¯ä»¥æ‰©å®¹æŒ‡å®šå¤§å°
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">tryPresize</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> size<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// åˆ¤æ–­sizeæ˜¯å¦è¶…è¿‡MAXIMUM_CAPACITY &gt;&gt;&gt; 1ï¼Œæ˜¯sizeå°±æ˜¯MAXIMUM_CAPACITY
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// å¦å°±è°ƒç”¨tableSizeForç”Ÿæˆå¤§äºsizeçš„æœ€å°2æ­¤å¹‚
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> c <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>size <span style="color:#f92672">&gt;=</span> <span style="color:#f92672">(</span>MAXIMUM_CAPACITY <span style="color:#f92672">&gt;&gt;&gt;</span> 1<span style="color:#f92672">))</span> <span style="color:#f92672">?</span> MAXIMUM_CAPACITY <span style="color:#f92672">:</span>
    tableSizeFor<span style="color:#f92672">(</span>size <span style="color:#f92672">+</span> <span style="color:#f92672">(</span>size <span style="color:#f92672">&gt;&gt;&gt;</span> 1<span style="color:#f92672">)</span> <span style="color:#f92672">+</span> 1<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">int</span> sc<span style="color:#f92672">;</span>
    <span style="color:#75715e">// sizeCtl &lt; 0è¡¨ç¤ºæ­£åœ¨åˆå§‹åŒ–æˆ–æ‰©å®¹
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">while</span> <span style="color:#f92672">((</span>sc <span style="color:#f92672">=</span> sizeCtl<span style="color:#f92672">)</span> <span style="color:#f92672">&gt;=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        Node<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;[]</span> tab <span style="color:#f92672">=</span> table<span style="color:#f92672">;</span> <span style="color:#66d9ef">int</span> n<span style="color:#f92672">;</span>
        <span style="color:#75715e">// å¦‚æœtable = nullï¼ŒsizeCtlè¡¨ç¤ºåˆå§‹å®¹é‡
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>tab <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> <span style="color:#f92672">(</span>n <span style="color:#f92672">=</span> tab<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">)</span> <span style="color:#f92672">==</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// é€‰æ‹©sizeCtlå’Œcapè¾ƒå¤§çš„ä½œä¸ºæ•°ç»„å¤§å°
</span><span style="color:#75715e"></span>            n <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>sc <span style="color:#f92672">&gt;</span> c<span style="color:#f92672">)</span> <span style="color:#f92672">?</span> sc <span style="color:#f92672">:</span> c<span style="color:#f92672">;</span>
            <span style="color:#75715e">// å°è¯•å°†sizeCtlè®¾ä¸º-1è¡¨ç¤ºæ­£åœ¨åˆå§‹åŒ–
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>U<span style="color:#f92672">.</span><span style="color:#a6e22e">compareAndSwapInt</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> SIZECTL<span style="color:#f92672">,</span> sc<span style="color:#f92672">,</span> <span style="color:#f92672">-</span>1<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>table <span style="color:#f92672">==</span> tab<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        <span style="color:#a6e22e">@SuppressWarnings</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;unchecked&#34;</span><span style="color:#f92672">)</span>
                        Node<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;[]</span> nt <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>Node<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;[])</span><span style="color:#66d9ef">new</span> Node<span style="color:#f92672">&lt;?,?&gt;[</span>n<span style="color:#f92672">];</span>
                        table <span style="color:#f92672">=</span> nt<span style="color:#f92672">;</span>
                        <span style="color:#75715e">//sizeCtl = 0.75nï¼Œå³æ‰©å®¹é˜ˆå€¼
</span><span style="color:#75715e"></span>                        sc <span style="color:#f92672">=</span> n <span style="color:#f92672">-</span> <span style="color:#f92672">(</span>n <span style="color:#f92672">&gt;&gt;&gt;</span> 2<span style="color:#f92672">);</span>
                    <span style="color:#f92672">}</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
                    sizeCtl <span style="color:#f92672">=</span> sc<span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
        <span style="color:#75715e">// å¦‚æœcå°äºç­‰äºscæˆ–æ•°ç»„å¤§å°è¶…è¿‡maxï¼Œåˆ™break
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>c <span style="color:#f92672">&lt;=</span> sc <span style="color:#f92672">||</span> n <span style="color:#f92672">&gt;=</span> MAXIMUM_CAPACITY<span style="color:#f92672">)</span>
            <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>tab <span style="color:#f92672">==</span> table<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">int</span> rs <span style="color:#f92672">=</span> resizeStamp<span style="color:#f92672">(</span>n<span style="color:#f92672">);</span>
            <span style="color:#75715e">// sc &lt; 0è¯´æ˜æ­£åœ¨æ‰©å®¹ï¼Œé‚£ä¹ˆå¸®åŠ©æ‰©å®¹
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>sc <span style="color:#f92672">&lt;</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                Node<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;[]</span> nt<span style="color:#f92672">;</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>sc <span style="color:#f92672">&gt;&gt;&gt;</span> RESIZE_STAMP_SHIFT<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> rs <span style="color:#f92672">||</span> sc <span style="color:#f92672">==</span> rs <span style="color:#f92672">+</span> 1 <span style="color:#f92672">||</span>
                    sc <span style="color:#f92672">==</span> rs <span style="color:#f92672">+</span> MAX_RESIZERS <span style="color:#f92672">||</span> <span style="color:#f92672">(</span>nt <span style="color:#f92672">=</span> nextTable<span style="color:#f92672">)</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span>
                    transferIndex <span style="color:#f92672">&lt;=</span> 0<span style="color:#f92672">)</span>
                    <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
                <span style="color:#75715e">// å°†scåŠ 1ï¼Œscè¡¨ç¤ºæ­£åœ¨è¿›è¡Œæ‰©å®¹å¸®å¿™çš„çº¿ç¨‹æ•°é‡
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>U<span style="color:#f92672">.</span><span style="color:#a6e22e">compareAndSwapInt</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> SIZECTL<span style="color:#f92672">,</span> sc<span style="color:#f92672">,</span> sc <span style="color:#f92672">+</span> 1<span style="color:#f92672">))</span>
                    transfer<span style="color:#f92672">(</span>tab<span style="color:#f92672">,</span> nt<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
            <span style="color:#75715e">// å¦‚æœæ²¡æœ‰åˆå§‹åŒ–æˆ–è€…æ­£åœ¨æ‰©å®¹ï¼Œé‚£ä¹ˆå¼€å¯ç¬¬ä¸€æ¬¡æ‰©å®¹
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>U<span style="color:#f92672">.</span><span style="color:#a6e22e">compareAndSwapInt</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> SIZECTL<span style="color:#f92672">,</span> sc<span style="color:#f92672">,</span>
                                         <span style="color:#f92672">(</span>rs <span style="color:#f92672">&lt;&lt;</span> RESIZE_STAMP_SHIFT<span style="color:#f92672">)</span> <span style="color:#f92672">+</span> 2<span style="color:#f92672">))</span>
                transfer<span style="color:#f92672">(</span>tab<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<ol>
<li>
<p>transferæ–¹æ³•éœ€è¦ä¼ å…¥<code>æ‰©å®¹å‰æ•°ç»„tableå’Œæ‰©å®¹åæ•°ç»„nextTable</code>ï¼Œå¦‚æœnextTable=nullï¼Œä¼šè¯»nextTableè¿›è¡Œåˆå§‹åŒ–ï¼Œå¤§å°æ—¶tableçš„2å€ã€‚</p>
</li>
<li>
<p><code>stride</code>è¡¨ç¤ºä¸º<code>æ­¥é•¿</code>ï¼Œä»£è¡¨æ¯ä¸ªçº¿ç¨‹å¤„ç†æ‰©å®¹çš„é•¿åº¦ï¼Œé€šè¿‡å…¬å¼ï¼š<code>(stride = (NCPU &gt; 1) ? (n &gt;&gt;&gt; 3) / NCPU : n)</code>è®¡ç®—å¾—å‡ºï¼Œä¸€èˆ¬æ˜¯16ã€‚</p>
</li>
<li>
<p>transferIndexç”¨äºè¡¨ç¤ºæ•´ä¸ªæ•°ç»„æ‰©å®¹çš„è¿›åº¦ï¼Œå…¶æ‰©å®¹çš„èŒƒå›´ä¸åŒåˆ†åˆ«è¡¨ç¤ºä¸ºï¼š<code>[0ï¼Œtransfer - 1] è¡¨ç¤ºè¿˜æœªåˆ†é…çº¿ç¨‹æ‰©å®¹çš„éƒ¨åˆ†ï¼Œ[transferï¼Œ n(åŸæ•°ç»„é•¿åº¦)]è¡¨ç¤ºä¸ºå·²åˆ†é…çº¿ç¨‹è¿›è¡Œæ‰©å®¹ï¼Œæœ‰å¯èƒ½æ­£åœ¨æ‰©å®¹æˆ–æ‰©å®¹å·²å®Œæˆ</code>ï¼Œå¦‚æœå½“å‰çº¿ç¨‹CASä¿®æ”¹transferIndexæˆåŠŸï¼Œè¯´æ˜å®ƒå¯ä»¥åœ¨<code>æŒ‡å®šæ­¥é•¿èŒƒå›´å†…è¿›è¡Œæ‰©å®¹æ“ä½œ</code>ã€‚</p>
<p><img src="https://image.leejay.top/image/20200713/Jns0xdIrB1m6.png?imageslim" alt=""></p>
</li>
<li>
<p>å‡è®¾æ‰©å®¹è¿˜æœªå®Œæˆä¹‹å‰ï¼Œæœ‰çš„table[i]å·²ç»è½¬ç§»åˆ°æ–°çš„tableä¸­äº†ï¼Œæœ‰çš„è¿˜åœ¨æ—§çš„tableä¸­ï¼Œæ­¤æ—¶æœ‰get()çº¿ç¨‹è®¿é—®æ—§table[]ï¼Œæˆ‘ä»¬ä¼šæ–°å»ºä¸€ä¸ª<code>ForwardingNode</code>ç”¨äºå­˜æ”¾æ–°çš„tableçš„å¼•ç”¨ï¼Œä¿è¯getåˆ°çš„æ˜¯æ–°çš„tableä¸­çš„æ•°æ®ã€‚é‚£å¦‚æœæ˜¯putçº¿ç¨‹å‘¢ï¼Ÿä¼šè°ƒç”¨<code>helpTransfer</code>æ¥å¸®åŠ©æœ€æ—©æ‰©å®¹çš„çº¿ç¨‹æ¥è¿›è¡Œæ‰©å®¹ã€‚</p>
</li>
<li>
<p>ä¸Hashmapä¸­å…³äºé“¾è¡¨çš„æ‰©å®¹ä¸€è‡´ï¼Œä¼šé€šè¿‡<code>hashcode &amp; length == 0</code>åˆ¤æ–­æ˜¯å¦éœ€è¦ç§»ä½ï¼Œå¦‚æœéœ€è¦ç§»ä½ï¼Œé‚£ä¹ˆç§»ä½åçš„<code>index = oldIndex + oldCap</code>ã€‚</p>
</li>
<li>
<p>æ€»ä½“æµç¨‹ï¼š</p>
<p>â‘  è®¡ç®—<code>strideæ­¥é•¿</code>ï¼Œä¸€èˆ¬å€¼ä¸º16ï¼Œå¦‚æœæ‰©å®¹åæ•°ç»„<code>nextTable = null</code>ï¼Œåˆ™åˆå§‹åŒ–nextTableï¼Œä¸”å¤§å°æ˜¯æ‰©å®¹å‰tableçš„2å€ã€‚</p>
<p>â‘¡ å½“å‰çº¿ç¨‹<code>åŸºäºstrideæ­¥é•¿å’ŒtransferIndex(å³old tableå¤§å°)</code>å¼€å§‹è·å–æ‰©å®¹ä»»åŠ¡ï¼Œç›´åˆ°CASä¿®æ”¹<code>transferIndex</code>æˆåŠŸå³è§†ä¸ºè·å–ä»»åŠ¡æˆåŠŸï¼Œå‡†å¤‡æ‰§è¡Œæ‰©å®¹ã€‚</p>
<p>â‘¢ å¦‚æœfinishing = trueè¡¨æ˜æ‰©å®¹ä»»åŠ¡å®Œæˆï¼Œå¦‚æœå½“å‰<code>table[i] = nullï¼Œè¯´æ˜table[i]</code>è¿ç§»å®Œæˆï¼Œé‚£ä¹ˆä¼šæ”¾ç½®<code>FowardingNode</code>ç”¨äºå°†getçº¿ç¨‹<code>è¯·æ±‚è½¬å‘(nextTableè®°å½•æ–°tableå¼•ç”¨)</code>å»æŸ¥è¯¢æ–°çš„tableã€‚</p>
<p>â‘£ æœ€ç»ˆè¿›è¡Œæ‰©å®¹ï¼Œæ ¹æ®é“¾è¡¨æˆ–çº¢é»‘æ ‘åˆ†å¼€æ‰©å®¹ï¼Œé“¾è¡¨ä½¿ç”¨äº†é“¾è¡¨å¹³ç§»çš„ä¼˜åŒ–æ–¹æ³•(<code>æ‰©å®¹åé“¾è¡¨é¡ºåºéç»å¯¹å€’åº</code>)ï¼Œç›´åˆ°æ‰€æœ‰çº¿ç¨‹åˆ†åˆ«æ‰©å®¹ç»“æŸï¼Œæ‰©å®¹æµç¨‹æ‰ç»“æŸã€‚</p>
</li>
</ol>
</blockquote>
<hr>
<h3 id="get">get</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> V <span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>Object key<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    Node<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;[]</span> tab<span style="color:#f92672">;</span> Node<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;</span> e<span style="color:#f92672">,</span> p<span style="color:#f92672">;</span> <span style="color:#66d9ef">int</span> n<span style="color:#f92672">,</span> eh<span style="color:#f92672">;</span> K ek<span style="color:#f92672">;</span>
    <span style="color:#75715e">// è®¡ç®—keyçš„hashcode
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> h <span style="color:#f92672">=</span> spread<span style="color:#f92672">(</span>key<span style="color:#f92672">.</span><span style="color:#a6e22e">hashCode</span><span style="color:#f92672">());</span>
    <span style="color:#75715e">// å¦‚æœtableä¸ä¸ºç©ºä¸”table[i]çš„å€¼ä¸ä¸ºnull
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>tab <span style="color:#f92672">=</span> table<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">(</span>n <span style="color:#f92672">=</span> tab<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">)</span> <span style="color:#f92672">&gt;</span> 0 <span style="color:#f92672">&amp;&amp;</span>
        <span style="color:#f92672">(</span>e <span style="color:#f92672">=</span> tabAt<span style="color:#f92672">(</span>tab<span style="color:#f92672">,</span> <span style="color:#f92672">(</span>n <span style="color:#f92672">-</span> 1<span style="color:#f92672">)</span> <span style="color:#f92672">&amp;</span> h<span style="color:#f92672">))</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// å¦‚æœhashcodeç›¸åŒ
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>eh <span style="color:#f92672">=</span> e<span style="color:#f92672">.</span><span style="color:#a6e22e">hash</span><span style="color:#f92672">)</span> <span style="color:#f92672">==</span> h<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// å¹¶ä¸”keyç›¸åŒ
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>ek <span style="color:#f92672">=</span> e<span style="color:#f92672">.</span><span style="color:#a6e22e">key</span><span style="color:#f92672">)</span> <span style="color:#f92672">==</span> key <span style="color:#f92672">||</span> <span style="color:#f92672">(</span>ek <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> key<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>ek<span style="color:#f92672">)))</span>
                <span style="color:#75715e">// è¿”å›è¯¥ä½ç½®çš„value
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">return</span> e<span style="color:#f92672">.</span><span style="color:#a6e22e">val</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
        <span style="color:#75715e">// eh=-1è¯´æ˜å½“å‰èŠ‚ç‚¹æ—¶ForwardingNodeèŠ‚ç‚¹
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// eh=-2è¯´æ˜æ˜¯TreeBin
</span><span style="color:#75715e"></span>     	<span style="color:#75715e">// ä¸åŒç±»å‹è°ƒç”¨å„è‡ªçš„findæ–¹æ³•
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>eh <span style="color:#f92672">&lt;</span> 0<span style="color:#f92672">)</span>
            <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span>p <span style="color:#f92672">=</span> e<span style="color:#f92672">.</span><span style="color:#a6e22e">find</span><span style="color:#f92672">(</span>h<span style="color:#f92672">,</span> key<span style="color:#f92672">))</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">?</span> p<span style="color:#f92672">.</span><span style="color:#a6e22e">val</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
        <span style="color:#75715e">// eh&gt;=0,è¯´æ˜è¯¥èŠ‚ç‚¹ä¸‹æŒ‚çš„æ˜¯é“¾è¡¨ï¼Œç›´æ¥éå†é“¾è¡¨
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">while</span> <span style="color:#f92672">((</span>e <span style="color:#f92672">=</span> e<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>e<span style="color:#f92672">.</span><span style="color:#a6e22e">hash</span> <span style="color:#f92672">==</span> h <span style="color:#f92672">&amp;&amp;</span>
                <span style="color:#f92672">((</span>ek <span style="color:#f92672">=</span> e<span style="color:#f92672">.</span><span style="color:#a6e22e">key</span><span style="color:#f92672">)</span> <span style="color:#f92672">==</span> key <span style="color:#f92672">||</span> <span style="color:#f92672">(</span>ek <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> key<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>ek<span style="color:#f92672">))))</span>
                <span style="color:#66d9ef">return</span> e<span style="color:#f92672">.</span><span style="color:#a6e22e">val</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    <span style="color:#75715e">// å¦‚æœæŸ¥ä¸åˆ°å°±è¿”å›null
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<p>ä¸ºä»€ä¹ˆget()æ–¹æ³•ä¸éœ€è¦åŠ é”ï¼Ÿ</p>
<p>å› ä¸ºNodeç±»çš„<code>å±æ€§valueè¢«volatileä¿®é¥°</code>ï¼Œä¿è¯çº¿ç¨‹é—´çš„å¯è§æ€§ã€‚å› ä¸ºæ˜¯æ— é”çš„ï¼Œæ‰€ä»¥æ€§èƒ½èƒ½å¤Ÿå¤§å¹…æå‡ã€‚</p>
<p>ä½†æ˜¯<code>ConcurrentHashMap</code>å’Œ<code>CopyOnWriteArrayList</code>ä¸€æ ·ï¼Œéƒ½æ˜¯ä¿è¯äº†<code>æ•°æ®æœ€ç»ˆä¸€è‡´æ€§ï¼Œä¸èƒ½ä¿è¯å®æ—¶ä¸€è‡´æ€§</code>ã€‚å› ä¸º<code>è¯»å†™ä¸äº’æ–¥</code>ï¼Œæ‰€ä»¥çº¿ç¨‹è·å–æŸä¸ªkeyçš„æ—¶å€™æ˜¯çœ‹ä¸åˆ°å¦ä¸€ä¸ªçº¿ç¨‹æ­£åœ¨æ·»åŠ æˆ–ä¿®æ”¹è¯¥keyçš„å€¼ã€‚</p>
</blockquote>
<hr>
<h3 id="æ‰©å®¹æ—¶æœº">æ‰©å®¹æ—¶æœº</h3>
<ul>
<li>æ‰§è¡Œput()æ–¹æ³•ä¸­å¦‚æœ<code>åŒä¸€ä½ç½®ä¸‹èŠ‚ç‚¹æ•°è¶…è¿‡8ä¸ªä¸”æ•°ç»„é•¿åº¦å°äº64æ—¶</code>ï¼Œä¼šè°ƒç”¨treeifyBin()æ–¹æ³•è¿›è¡Œæ‰©å®¹ã€‚</li>
<li>æ‰§è¡Œput()æ–¹æ³•ä¸­å¦‚æœæ£€æµ‹åˆ°èŠ‚ç‚¹çš„<code>hashå€¼ = MOVED</code>ï¼Œé‚£ä¹ˆä¼šè°ƒç”¨<code>helpTransfer</code>è¿›è¡ŒååŠ©æ‰©å®¹ã€‚</li>
<li>æ‰§è¡Œput()æ–¹æ³•ä¸­çš„<code>addCount</code>æ–¹æ³•ï¼Œå¦‚æœæ•°ç»„å…ƒç´ å‘ç”Ÿæ”¹å˜æœ‰å¯èƒ½è°ƒç”¨æ‰©å®¹ã€‚</li>
<li>æ‰§è¡ŒputAll()æ—¶å¦‚æœ<code>å½“å‰æ•°ç»„å¤§å°è¶…è¿‡äº†æ‰©å®¹é˜ˆå€¼</code>ï¼Œä¼šè¿›è¡Œæ‰©å®¹ã€‚</li>
</ul>
<h3 id="æ‰©å®¹æ—¶çš„è¯»å†™æ“ä½œ">æ‰©å®¹æ—¶çš„è¯»å†™æ“ä½œ</h3>
<ul>
<li>å½“æ•°ç»„æ­£åœ¨æ‰©å®¹æ—¶ï¼ŒæŸçº¿ç¨‹è°ƒç”¨äº†<code>get</code>æ–¹æ³•ï¼Œé‚£ä¹ˆå¦‚æœå¯¹åº”çš„table[i]å·²ç»å…¨éƒ¨è¿ç§»ï¼Œé‚£ä¹ˆåªéœ€è¦é€šè¿‡table[i]ä½ç½®ä¸­çš„<code>FowardingNode.nextTable</code>å±æ€§è·å–æ–°çš„tableçš„å¼•ç”¨ã€‚</li>
<li>å½“æ•°ç»„æ­£åœ¨æ‰©å®¹æ—¶ï¼ŒæŸçº¿ç¨‹è°ƒç”¨äº†<code>put</code>æ–¹æ³•ï¼Œé‚£ä¹ˆå½“å‰çº¿ç¨‹ä¼šè°ƒç”¨<code>helpTransfer</code>æ–¹æ³•ååŠ©è¿›è¡Œæ‰©å®¹ã€‚</li>
</ul>

    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h">å…¶ä»–æ–‡ç« </span>
            <hr />
          </div>
          <div class="pagination__buttons">
            
              <span class="button previous">
                <a href="https://leejay.top/post/threadpool/">
                  <span class="button__icon">â†</span>
                  <span class="button__text">ThreadPool</span>
                </a>
              </span>
            
            
              <span class="button next">
                <a href="https://leejay.top/post/concurrentlinkedqueue/">
                  <span class="button__text">ConcurrentLinkedQueue</span>
                  <span class="button__icon">â†’</span>
                </a>
              </span>
            
          </div>
        </div>
      
    


    
      
        

      
    

    </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright copyright--user">è‹ICPå¤‡18050258å·-1</div>
    
  </div>
</footer>

<script src="https://leejay.top/assets/main.js"></script>
<script src="https://leejay.top/assets/prism.js"></script>


      
    </div>

    
  </body>
</html>
