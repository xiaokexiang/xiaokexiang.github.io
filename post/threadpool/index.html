<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>ThreadPool</title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="description" content="ThreadPool ä¸ºä»€ä¹ˆä½¿ç”¨çº¿ç¨‹æ±  æˆ‘ä»¬çŸ¥é“é¢‘ç¹çš„å•ç‹¬åˆ›å»ºçº¿ç¨‹æ˜¯å¾ˆæ¶ˆè€—ç³»ç»Ÿèµ„æºçš„ï¼Œè€Œçº¿ç¨‹æ± ä¸­çº¿ç¨‹æ˜¯å¯ä»¥çº¿ç¨‹å¤ç”¨çš„ï¼Œä¸éœ€è¦æ¯æ¬¡æ‰§è¡Œéƒ½é‡æ–°åˆ›å»ºï¼Œå¹¶ä¸”çº¿ç¨‹æ± å¯ä»¥æä¾›æ§åˆ¶çº¿ç¨‹ä¸ªæ•°ç­‰èµ„æºé™åˆ¶å’Œç®¡ç†çš„æ‰‹æ®µã€‚
å®ç°åŸç† æ‰€è°“çº¿ç¨‹æ± å®ç°åŸç†ï¼šè°ƒç”¨æ–¹ä¸æ–­å‘çº¿ç¨‹æ± ä¸­æ·»åŠ ä»»åŠ¡ï¼Œçº¿ç¨‹æ± ä¸­æœ‰ä¸€ç»„çº¿ç¨‹ï¼Œä¸æ–­çš„ä»é˜Ÿåˆ—ä¸­å–ä»»åŠ¡ã€‚å…¸å‹çš„ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…æ¨¡å‹ã€‚åŸºäºè¿™æ ·çš„åŸç†ï¼Œæˆ‘ä»¬å®ç°çº¿ç¨‹æ± éœ€è¦ä½¿ç”¨åˆ°é˜»å¡é˜Ÿåˆ—ï¼Œé¿å…æ— ä»»åŠ¡æ—¶è½®è¯¢å¸¦æ¥çš„èµ„æºæ¶ˆè€—ã€‚
çº¿ç¨‹æ± ç±»ç»§æ‰¿ä½“ç³»  ThreadPoolExecutorå’ŒScheduledExecutorServiceæ˜¯éœ€è¦å…³æ³¨çš„ä¸¤ä¸ªæ ¸å¿ƒç±»ï¼Œå‰è€…æ˜¯çº¿ç¨‹æ± çš„å…·ä½“å®ç°ï¼Œåè€…é™¤äº†èƒ½å®ç°çº¿ç¨‹æ± çš„åŸºæœ¬åŠŸèƒ½ï¼Œè¿˜å¯ä»¥æä¾›å‘¨æœŸæ€§æ‰§è¡Œä»»åŠ¡åŠŸèƒ½ã€‚
ä»»ä½•éœ€è¦çº¿ç¨‹æ± æ‰§è¡Œçš„ä»»åŠ¡ï¼Œéƒ½å¿…é¡»ç›´æ¥æˆ–é—´æ¥çš„å®ç°Runnableæ¥å£ã€‚
  ThreadPoolExecutor æ„é€  // é˜»å¡é˜Ÿåˆ—ï¼Œå…·ä½“å®ç°ç”±æ„é€ å‡½æ•°å·¨é¡¶ private final BlockingQueue&amp;lt;Runnable&amp;gt; workQueue; private volatile int corePoolSize; private volatile int maximumPoolSize; private volatile long keepAliveTime; // çº¿ç¨‹å·¥å‚ï¼Œç”¨äºå®šä¹‰åˆ›å»ºçº¿ç¨‹çš„æ–¹å¼ï¼Œä¸»è¦æ˜¯å®šä¹‰çº¿ç¨‹nameç­‰ç›¸å…³å‚æ•° private volatile ThreadFactory threadFactory; // æ‹’ç»ç­–ç•¥æœ‰4ç§å†…ç½®çš„ç­–ç•¥ private volatile RejectedExecutionHandler handler; // å‚æ•°æœ€å¤šçš„æ„é€ å‡½æ•° public ThreadPoolExecutor(int corePoolSize, int maximumPoolSize, long keepAliveTime, TimeUnit unit, BlockingQueue&amp;lt;Runnable&amp;gt; workQueue, ThreadFactory threadFactory, RejectedExecutionHandler handler) { if (corePoolSize &amp;lt; 0 || maximumPoolSize &amp;lt;= 0 || maximumPoolSize &amp;lt; corePoolSize || keepAliveTime &amp;lt; 0) throw new IllegalArgumentException(); if (workQueue == null || threadFactory == null || handler == null) throw new NullPointerException(); this."/>
<meta name="keywords" content=""/>
<meta name="robots" content="noodp"/>
<meta name="google-site-verification" content="e1ELBPEvOV5kwQNtzaLcNt-3iZy83eiNhSZkHhQPecs" />
<link rel="canonical" href="https://leejay.top/post/threadpool/" />





<link rel="stylesheet" href="https://leejay.top/assets/style.css">


<link rel="stylesheet" href="https://leejay.top/style.css">

<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://leejay.top/img/apple-touch-icon-144-precomposed.png">
<link rel="shortcut icon" href="https://leejay.top/img/favicon.png">



<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="ThreadPool"/>
<meta name="twitter:description" content="`ThreadPool`å¯ä»¥é¿å…å•ä¸ªçº¿ç¨‹åˆ›å»ºå¸¦æ¥çš„ç³»ç»Ÿèµ„æºçš„æ¶ˆè€—ï¼Œå¹¶ä¸”èƒ½å¤Ÿå®ç°çº¿ç¨‹çš„å¤ç”¨ï¼Œæœ‰æ•ˆèŠ‚çœç³»ç»Ÿèµ„æºã€‚"/>



<meta property="og:title" content="ThreadPool" />
<meta property="og:description" content="`ThreadPool`å¯ä»¥é¿å…å•ä¸ªçº¿ç¨‹åˆ›å»ºå¸¦æ¥çš„ç³»ç»Ÿèµ„æºçš„æ¶ˆè€—ï¼Œå¹¶ä¸”èƒ½å¤Ÿå®ç°çº¿ç¨‹çš„å¤ç”¨ï¼Œæœ‰æ•ˆèŠ‚çœç³»ç»Ÿèµ„æºã€‚" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://leejay.top/post/threadpool/" />
<meta property="article:published_time" content="2020-07-17T17:01:26+08:00" />
<meta property="article:modified_time" content="2020-07-17T17:01:26+08:00" /><meta property="og:site_name" content="Aurora" />






  </head>
  <body class="">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a href="https://leejay.top" class="logo" style="text-decoration: none;">
  
    <span class="logo__mark"><svg xmlns="https://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367"/>
</svg></span>
    <span class="logo__text">Aurora</span>
    <span class="logo__cursor"></span>
    <span class="logo__cursor2"></span>
  
</a>
    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/categories">Categories</a></li>
        
      
        
          <li><a href="/tags">Tags</a></li>
        
      
      
    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/categories">Categories</a></li>
      
    
      
        <li><a href="/tags">Tags</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none"/>
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="https://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>
      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  
  

  <div class="post">
    <h1 class="post-title"><a href="https://leejay.top/post/threadpool/">ThreadPool</a></h1>
    <div class="post-meta">
      
        <span class="post-date">
          2020-07-17
        </span>

        
          
        
      

      
      
    </div>

    
      <span class="post-tags">
        
        ğŸ–<a href="https://leejay.top/tags/threadpool/">ThreadPool </a>&nbsp;
        
      </span>
    

    

    <div class="post-content">
      
      <h3 id="threadpool">ThreadPool</h3>
<h4 id="ä¸ºä»€ä¹ˆä½¿ç”¨çº¿ç¨‹æ± ">ä¸ºä»€ä¹ˆä½¿ç”¨çº¿ç¨‹æ± </h4>
<p>æˆ‘ä»¬çŸ¥é“é¢‘ç¹çš„<code>å•ç‹¬åˆ›å»ºçº¿ç¨‹</code>æ˜¯å¾ˆæ¶ˆè€—ç³»ç»Ÿèµ„æºçš„ï¼Œè€Œçº¿ç¨‹æ± ä¸­çº¿ç¨‹æ˜¯å¯ä»¥<code>çº¿ç¨‹å¤ç”¨</code>çš„ï¼Œä¸éœ€è¦æ¯æ¬¡æ‰§è¡Œéƒ½é‡æ–°åˆ›å»ºï¼Œå¹¶ä¸”çº¿ç¨‹æ± å¯ä»¥æä¾›<code>æ§åˆ¶çº¿ç¨‹ä¸ªæ•°</code>ç­‰èµ„æºé™åˆ¶å’Œç®¡ç†çš„æ‰‹æ®µã€‚</p>
<h4 id="å®ç°åŸç†">å®ç°åŸç†</h4>
<p>æ‰€è°“çº¿ç¨‹æ± å®ç°åŸç†ï¼š<code>è°ƒç”¨æ–¹ä¸æ–­å‘çº¿ç¨‹æ± ä¸­æ·»åŠ ä»»åŠ¡ï¼Œçº¿ç¨‹æ± ä¸­æœ‰ä¸€ç»„çº¿ç¨‹ï¼Œä¸æ–­çš„ä»é˜Ÿåˆ—ä¸­å–ä»»åŠ¡</code>ã€‚å…¸å‹çš„<code>ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…æ¨¡å‹</code>ã€‚åŸºäºè¿™æ ·çš„åŸç†ï¼Œæˆ‘ä»¬å®ç°çº¿ç¨‹æ± éœ€è¦ä½¿ç”¨åˆ°<code>é˜»å¡é˜Ÿåˆ—</code>ï¼Œé¿å…æ— ä»»åŠ¡æ—¶è½®è¯¢å¸¦æ¥çš„èµ„æºæ¶ˆè€—ã€‚</p>
<h4 id="çº¿ç¨‹æ± ç±»ç»§æ‰¿ä½“ç³»">çº¿ç¨‹æ± ç±»ç»§æ‰¿ä½“ç³»</h4>
<p><img src="https://image.leejay.top/image/20200714/4QO7osHQeOu6.png?imageslim" alt=""></p>
<blockquote>
<p><code>ThreadPoolExecutor</code>å’Œ<code>ScheduledExecutorService</code>æ˜¯éœ€è¦å…³æ³¨çš„ä¸¤ä¸ªæ ¸å¿ƒç±»ï¼Œå‰è€…æ˜¯<code>çº¿ç¨‹æ± çš„å…·ä½“å®ç°</code>ï¼Œåè€…é™¤äº†èƒ½å®ç°çº¿ç¨‹æ± çš„åŸºæœ¬åŠŸèƒ½ï¼Œè¿˜å¯ä»¥æä¾›<code>å‘¨æœŸæ€§æ‰§è¡Œä»»åŠ¡</code>åŠŸèƒ½ã€‚</p>
<p>ä»»ä½•éœ€è¦çº¿ç¨‹æ± æ‰§è¡Œçš„ä»»åŠ¡ï¼Œéƒ½å¿…é¡»<code>ç›´æ¥æˆ–é—´æ¥çš„å®ç°Runnableæ¥å£</code>ã€‚</p>
</blockquote>
<hr>
<h3 id="threadpoolexecutor">ThreadPoolExecutor</h3>
<h4 id="æ„é€ ">æ„é€ </h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// é˜»å¡é˜Ÿåˆ—ï¼Œå…·ä½“å®ç°ç”±æ„é€ å‡½æ•°å·¨é¡¶
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> BlockingQueue<span style="color:#f92672">&lt;</span>Runnable<span style="color:#f92672">&gt;</span> workQueue<span style="color:#f92672">;</span>
<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">volatile</span> <span style="color:#66d9ef">int</span> corePoolSize<span style="color:#f92672">;</span>
<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">volatile</span> <span style="color:#66d9ef">int</span> maximumPoolSize<span style="color:#f92672">;</span>
<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">volatile</span> <span style="color:#66d9ef">long</span> keepAliveTime<span style="color:#f92672">;</span>
<span style="color:#75715e">// çº¿ç¨‹å·¥å‚ï¼Œç”¨äºå®šä¹‰åˆ›å»ºçº¿ç¨‹çš„æ–¹å¼ï¼Œä¸»è¦æ˜¯å®šä¹‰çº¿ç¨‹nameç­‰ç›¸å…³å‚æ•°
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">volatile</span> ThreadFactory threadFactory<span style="color:#f92672">;</span>
<span style="color:#75715e">// æ‹’ç»ç­–ç•¥æœ‰4ç§å†…ç½®çš„ç­–ç•¥
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">volatile</span> RejectedExecutionHandler handler<span style="color:#f92672">;</span>
<span style="color:#75715e">// å‚æ•°æœ€å¤šçš„æ„é€ å‡½æ•°
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#a6e22e">ThreadPoolExecutor</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> corePoolSize<span style="color:#f92672">,</span>
                          <span style="color:#66d9ef">int</span> maximumPoolSize<span style="color:#f92672">,</span>
                          <span style="color:#66d9ef">long</span> keepAliveTime<span style="color:#f92672">,</span>
                          TimeUnit unit<span style="color:#f92672">,</span>
                          BlockingQueue<span style="color:#f92672">&lt;</span>Runnable<span style="color:#f92672">&gt;</span> workQueue<span style="color:#f92672">,</span>
                          ThreadFactory threadFactory<span style="color:#f92672">,</span>
                          RejectedExecutionHandler handler<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>corePoolSize <span style="color:#f92672">&lt;</span> 0 <span style="color:#f92672">||</span>
        maximumPoolSize <span style="color:#f92672">&lt;=</span> 0 <span style="color:#f92672">||</span>
        maximumPoolSize <span style="color:#f92672">&lt;</span> corePoolSize <span style="color:#f92672">||</span>
        keepAliveTime <span style="color:#f92672">&lt;</span> 0<span style="color:#f92672">)</span>
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> IllegalArgumentException<span style="color:#f92672">();</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>workQueue <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> threadFactory <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> handler <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> NullPointerException<span style="color:#f92672">();</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">acc</span> <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">getSecurityManager</span><span style="color:#f92672">()</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">?</span>
        <span style="color:#66d9ef">null</span> <span style="color:#f92672">:</span>
    AccessController<span style="color:#f92672">.</span><span style="color:#a6e22e">getContext</span><span style="color:#f92672">();</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">corePoolSize</span> <span style="color:#f92672">=</span> corePoolSize<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">maximumPoolSize</span> <span style="color:#f92672">=</span> maximumPoolSize<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">workQueue</span> <span style="color:#f92672">=</span> workQueue<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">keepAliveTime</span> <span style="color:#f92672">=</span> unit<span style="color:#f92672">.</span><span style="color:#a6e22e">toNanos</span><span style="color:#f92672">(</span>keepAliveTime<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">threadFactory</span> <span style="color:#f92672">=</span> threadFactory<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">handler</span> <span style="color:#f92672">=</span> handler<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<p><code>corePoolSize</code>ï¼šçº¿ç¨‹æ± ä¸­å§‹ç»ˆç»´æŠ¤çš„çº¿ç¨‹ä¸ªæ•°ï¼Œä¸å—è¶…æ—¶å½±å“çš„æ ¸å¿ƒçº¿ç¨‹ã€‚</p>
<p><code>maxPoolSize</code>ï¼š<code>åœ¨corePoolSizeå·²æ»¡ï¼Œä¸”é˜Ÿåˆ—å·²æ»¡ä¼šæ‰©å……çº¿ç¨‹è‡³æ­¤å€¼</code>ï¼Œåœ¨æ­¤ä¹‹å‰åªæœ‰æ ¸å¿ƒçº¿ç¨‹æ‰§è¡Œä»»åŠ¡ã€‚</p>
<p><code>workQueue</code>ï¼šé˜»å¡é˜Ÿåˆ—ï¼Œä»»åŠ¡ä¼šè¢«æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­ï¼Œå…·ä½“å®ç°ç”±ä½¿ç”¨è€…å†³å®šã€‚</p>
<p><code>keepAliveTime</code>ï¼š<code>maxPoolSize</code>ä¸­çš„ç©ºé—²çº¿ç¨‹é”€æ¯éœ€è¦çš„æ—¶é—´ï¼Œé”€æ¯åçº¿ç¨‹æ•°é™è‡³<code>corePoolSize</code>ã€‚</p>
<p><code>threadFactory</code>ï¼šçº¿ç¨‹å·¥å‚ï¼Œç”¨äºç”Ÿäº§çº¿ç¨‹ï¼Œä¸»è¦ç”¨æ¥å®šä¹‰çº¿ç¨‹åå­—ç­‰ç›¸å…³å‚æ•°ã€‚</p>
<p><code>handler</code>ï¼šå½“<code>corePoolSize</code>ã€<code>maxPoolSize</code>å’Œ<code>workQueue</code>éƒ½æ»¡æ—¶çš„æ‰§è¡Œçš„æ‹’ç»ç­–ç•¥ã€‚</p>
</blockquote>
<h4 id="worker">Worker</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">//Workerç»„æˆçš„HashSet
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> HashSet<span style="color:#f92672">&lt;</span>Worker<span style="color:#f92672">&gt;</span> workers <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashSet<span style="color:#f92672">&lt;</span>Worker<span style="color:#f92672">&gt;();</span>
<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Worker</span> <span style="color:#66d9ef">extends</span> AbstractQueuedSynchronizer 
    						<span style="color:#66d9ef">implements</span> Runnable <span style="color:#f92672">{</span>
    
    <span style="color:#75715e">// Workerç»´æŠ¤çš„çº¿ç¨‹å°±æ˜¯ç”¨æ¥æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹ï¼Œæ¯ä¸ªWorkerå¯¹åº”ä¸€ä¸ª
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">final</span> Thread thread<span style="color:#f92672">;</span>
	<span style="color:#75715e">// Workerå¯¹è±¡çš„åˆå§‹ä»»åŠ¡ï¼Œå› ä¸ºçº¿ç¨‹å¤ç”¨å°±ä¼šå­˜åœ¨ä¸€ä¸ªwokeræ‰§è¡Œå¤šä¸ªä»»åŠ¡çš„æƒ…å†µ
</span><span style="color:#75715e"></span>    Runnable firstTask<span style="color:#f92672">;</span>
	<span style="color:#75715e">// è®°å½•å½“å‰workerå®Œæˆçš„ä»»åŠ¡æ¬¡æ•°ï¼Œvolatileä¿®é¥°
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">volatile</span> <span style="color:#66d9ef">long</span> completedTasks<span style="color:#f92672">;</span>

    <span style="color:#75715e">// æ„é€ å‡½æ•°ï¼Œéœ€è¦ä¼ å…¥åˆå§‹ä»»åŠ¡
</span><span style="color:#75715e"></span>    Worker<span style="color:#f92672">(</span>Runnable firstTask<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// åˆå§‹çŠ¶æ€è®¾ä¸º-1ï¼Œå¯åŠ¨æ—¶ä¼šè¢«æ¸…é™¤ï¼Œè¿™é‡Œå¾ˆé‡è¦ï¼ç›®çš„æ˜¯é˜²æ­¢è¢«ä¸­æ–­
</span><span style="color:#75715e"></span>        setState<span style="color:#f92672">(-</span>1<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">firstTask</span> <span style="color:#f92672">=</span> firstTask<span style="color:#f92672">;</span>
        <span style="color:#75715e">// è°ƒç”¨å·¥å‚ç±»åˆ›å»ºçº¿ç¨‹ï¼Œä»»åŠ¡æ˜¯å½“å‰çš„wokerå¯¹è±¡
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">thread</span> <span style="color:#f92672">=</span> getThreadFactory<span style="color:#f92672">().</span><span style="color:#a6e22e">newThread</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#75715e">// workerè¢«è°ƒç”¨æ—¶ä¼šæ‰§è¡Œrunæ–¹æ³•
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> 
        <span style="color:#75715e">// è¿è¡Œå½“å‰worker
</span><span style="color:#75715e"></span>        runWorker<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<p>Workerç±»ä¸»è¦ç”¨äºç»´æŠ¤<code>æ‰§è¡Œä»»åŠ¡çº¿ç¨‹çš„ä¸­æ–­æ§åˆ¶çŠ¶æ€</code>ã€‚</p>
<ol>
<li>Worker<code>å®ç°äº†Runnableæ¥å£ä¸­çš„runæ–¹æ³•</code>ï¼Œåˆå§‹åŒ–æ—¶å°†<code>workerä½œä¸ºRunnableä»»åŠ¡</code>ä¼ å…¥åˆ›å»ºäº†çº¿ç¨‹ã€‚</li>
<li>Workerç»§æ‰¿<code>AbstractQueueSynchronizer</code>æŠ½è±¡ç±»ï¼Œç”¨äº<code>ç®€åŒ–è·å–å’Œé‡Šæ”¾å›´ç»•æ¯ä¸ªWorkeræ‰§è¡Œçš„é”</code>ï¼Œä¸ºäº†é€šè¿‡ä¸­æ–­å”¤é†’<code>ç©ºé—²ä¸­çš„çº¿ç¨‹</code>è€Œ<code>éæ­£åœ¨è¿è¡Œä¸­çš„ä»»åŠ¡</code>(åé¢çš„ä»£ç ä¼šè§£é‡Š)ï¼ŒåŒæ—¶å®ç°äº†è‡ªå·±çš„è·å–é”å’Œé‡Šæ”¾é”çš„é€»è¾‘ï¼Œæ˜¯ä¸ºäº†<code>é¿å…é”çš„é‡å…¥</code>ã€‚</li>
<li>Workeråˆå§‹åŒ–<code>è®¾ç½®stateä¸º-1</code>ï¼Œç›´åˆ°çœŸæ­£å¯åŠ¨æ—¶æ‰ä¼šæ¸…é™¤ï¼Œæ˜¯ä¸ºäº†<code>é˜²æ­¢è¯¥workerè¿˜æ²¡æ‰§è¡Œå°±è¢«æ‰“æ–­</code>ã€‚</li>
</ol>
</blockquote>
<h4 id="ctlå˜é‡">ctlå˜é‡</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// çŠ¶æ€å˜é‡ç”± çº¿ç¨‹æ± è¿è¡ŒçŠ¶æ€(é«˜3ä½)å’Œçº¿ç¨‹æ± å†…æœ‰æ•ˆçº¿ç¨‹æ•°é‡(ä½29ä½)ç»„æˆ
</span><span style="color:#75715e">// åˆå§‹å€¼ï¼š1110 0000 0000 0000 0000 0000 0000 0000
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> AtomicInteger ctl <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> AtomicInteger<span style="color:#f92672">(</span>ctlOf<span style="color:#f92672">(</span>RUNNING<span style="color:#f92672">,</span> 0<span style="color:#f92672">));</span>
<span style="color:#75715e">// COUNT_BITS = 29 ç”¨äºç§»ä½
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> COUNT_BITS <span style="color:#f92672">=</span> Integer<span style="color:#f92672">.</span><span style="color:#a6e22e">SIZE</span> <span style="color:#f92672">-</span> 3<span style="color:#f92672">;</span>
<span style="color:#75715e">// çº¿ç¨‹æ•°é‡æœ€å¤š CAPACITY = 2^29-1 (0001 1111 1111 1111 1111 1111 1111 1111 )
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> CAPACITY   <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>1 <span style="color:#f92672">&lt;&lt;</span> COUNT_BITS<span style="color:#f92672">)</span> <span style="color:#f92672">-</span> 1<span style="color:#f92672">;</span>
<span style="color:#75715e">// 1111 1111 1111 1111 1111 1111 1111 1111 -&gt;
</span><span style="color:#75715e">// 1110 0000 0000 0000 0000 0000 0000 0000
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> RUNNING    <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>1 <span style="color:#f92672">&lt;&lt;</span> COUNT_BITS<span style="color:#f92672">;</span>
<span style="color:#75715e">// 0000 0000 0000 0000 0000 0000 0000 0000 -&gt;
</span><span style="color:#75715e">// 0000 0000 0000 0000 0000 0000 0000 0000
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> SHUTDOWN   <span style="color:#f92672">=</span>  0 <span style="color:#f92672">&lt;&lt;</span> COUNT_BITS<span style="color:#f92672">;</span>
<span style="color:#75715e">// 0000 0000 0000 0000 0000 0000 0000 0001 -&gt;
</span><span style="color:#75715e">// 0010 0000 0000 0000 0000 0000 0000 0000
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> STOP       <span style="color:#f92672">=</span>  1 <span style="color:#f92672">&lt;&lt;</span> COUNT_BITS<span style="color:#f92672">;</span>
<span style="color:#75715e">// 0000 0000 0000 0000 0000 0000 0000 0010 -&gt;
</span><span style="color:#75715e">// 0100 0000 0000 0000 0000 0000 0000 0000
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> TIDYING    <span style="color:#f92672">=</span>  2 <span style="color:#f92672">&lt;&lt;</span> COUNT_BITS<span style="color:#f92672">;</span>
<span style="color:#75715e">// 0000 0000 0000 0000 0000 0000 0000 0011 -&gt; 
</span><span style="color:#75715e">// 0110 0000 0000 0000 0000 0000 0000 0000
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> TERMINATED <span style="color:#f92672">=</span>  3 <span style="color:#f92672">&lt;&lt;</span> COUNT_BITS<span style="color:#f92672">;</span>
<span style="color:#75715e">// ~CAPACITY = 1110 0000 0000 0000 0000 0000 0000 0000
</span><span style="color:#75715e">// c &amp; !CAPACITY åªä¼šå¾—åˆ°é«˜3ä½çš„bitå€¼
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">runStateOf</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> c<span style="color:#f92672">)</span>     <span style="color:#f92672">{</span> <span style="color:#66d9ef">return</span> c <span style="color:#f92672">&amp;</span> <span style="color:#f92672">~</span>CAPACITY<span style="color:#f92672">;</span> <span style="color:#f92672">}</span>
<span style="color:#75715e">// è·å–ä½29ä½çš„bitå€¼
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">workerCountOf</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> c<span style="color:#f92672">)</span>  <span style="color:#f92672">{</span> <span style="color:#66d9ef">return</span> c <span style="color:#f92672">&amp;</span> CAPACITY<span style="color:#f92672">;</span> <span style="color:#f92672">}</span>
<span style="color:#75715e">// å°†é«˜3ä½å’Œä½29ä½ç»„è£…æˆctlå€¼
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">ctlOf</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> rs<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> wc<span style="color:#f92672">)</span> <span style="color:#f92672">{</span> <span style="color:#66d9ef">return</span> rs <span style="color:#f92672">|</span> wc<span style="color:#f92672">;</span> <span style="color:#f92672">}</span>

<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">runStateLessThan</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> c<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> s<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> c <span style="color:#f92672">&lt;</span> s<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">runStateAtLeast</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> c<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> s<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> c <span style="color:#f92672">&gt;=</span> s<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isRunning</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> c<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> c <span style="color:#f92672">&lt;</span> SHUTDOWN<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
<span style="color:#75715e">// CASå‡ctlå€¼åŠ 1
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">compareAndIncrementWorkerCount</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> expect<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> ctl<span style="color:#f92672">.</span><span style="color:#a6e22e">compareAndSet</span><span style="color:#f92672">(</span>expect<span style="color:#f92672">,</span> expect <span style="color:#f92672">+</span> 1<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
<span style="color:#75715e">// CASå°†ctlçš„å€¼å‡1
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">compareAndDecrementWorkerCount</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> expect<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> ctl<span style="color:#f92672">.</span><span style="color:#a6e22e">compareAndSet</span><span style="color:#f92672">(</span>expect<span style="color:#f92672">,</span> expect <span style="color:#f92672">-</span> 1<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e">// å¾ªç¯æ‰§è¡ŒCASç›´åˆ°å‡ctlå‡1æˆåŠŸ
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">decrementWorkerCount</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">do</span> <span style="color:#f92672">{}</span> <span style="color:#66d9ef">while</span> <span style="color:#f92672">(!</span> compareAndDecrementWorkerCount<span style="color:#f92672">(</span>ctl<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">()));</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<p>ctlçŠ¶æ€å˜é‡ç”±<code>çº¿ç¨‹æ± è¿è¡ŒçŠ¶æ€(é«˜3ä½)</code>å’Œ<code>çº¿ç¨‹æ± å†…æœ‰æ•ˆçº¿ç¨‹æ•°é‡(ä½29ä½)</code>æ„æˆã€‚</p>
<p>çº¿ç¨‹æ± çš„çŠ¶æ€åªä¼š<code>ä»å°åˆ°å¤§è¿ç§»(-1-&gt;0-&gt;1-&gt;2-&gt;3)</code>ï¼Œä¸ä¼šé€†å‘è¿ç§»ã€‚</p>
<p><code>RUNNING</code>ï¼š<code>èƒ½å¤Ÿæ¥æ”¶æ–°çš„ä»»åŠ¡</code>ï¼ŒåŠ<code>æ‰§è¡Œåœ¨é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡</code>ã€‚</p>
<p><code>SHUTDOWN</code>ï¼šä¸èƒ½æ¥æ”¶æ–°ä»»åŠ¡ï¼Œä½†è¿˜æ˜¯ä¼š<code>æ‰§è¡Œåœ¨é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡</code>ã€‚</p>
<p><code>STOP</code>ï¼šä¸èƒ½æ¥æ”¶æ–°ä»»åŠ¡ï¼Œä¹Ÿä¸ä¼šæ‰§è¡Œåœ¨é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œæœ€åä¸­æ–­æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ã€‚</p>
<p><code>TIDYING</code>ï¼šæ‰€æœ‰ä»»åŠ¡éƒ½ç»ˆæ­¢ï¼Œworkeræ•°é‡å˜ä¸º0ï¼Œè½¬æ¢ä¸ºæ­¤çŠ¶æ€ä¼šæ‰§è¡Œ<code>terminated()</code>é’©å­å‡½æ•°ã€‚</p>
<p><code>TERMINATED</code>ï¼š<code>terminated()</code>æ‰§è¡Œå®Œæ¯•ï¼Œè‡³æ­¤çº¿ç¨‹æ± æ‰çœŸæ­£å…³é—­ã€‚</p>
<p><img src="https://image.leejay.top/image/20200714/VvPgLR2A4lCT.png?imageslim" alt="çº¿ç¨‹è¿ç§»çŠ¶æ€"></p>
</blockquote>
<hr>
<h3 id="çº¿ç¨‹æ± çš„å…³é—­">çº¿ç¨‹æ± çš„å…³é—­</h3>
<p>æˆ‘ä»¬å…ˆä»<code>shutDown</code>å’Œ<code>shutDownNow</code>ä¸¤ä¸ªæ–¹æ³•å…¥æ‰‹ï¼Œå…ˆäº†è§£çº¿ç¨‹æ± å¦‚ä½•å…³é—­çš„ã€‚</p>
<h4 id="shutdown">shutDown</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">shutdown</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">final</span> ReentrantLock mainLock <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mainLock</span><span style="color:#f92672">;</span>
    <span style="color:#75715e">// è·å–ç‹¬å é”
</span><span style="color:#75715e"></span>    mainLock<span style="color:#f92672">.</span><span style="color:#a6e22e">lock</span><span style="color:#f92672">();</span>
    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// æ ¡éªŒæ˜¯å¦ç”±å…³é—­çº¿ç¨‹æ± çš„æƒé™
</span><span style="color:#75715e"></span>        checkShutdownAccess<span style="color:#f92672">();</span>
        <span style="color:#75715e">// å°†ctlä¿®æ”¹ä¸ºSHUTDOWNæ€
</span><span style="color:#75715e"></span>        advanceRunState<span style="color:#f92672">(</span>SHUTDOWN<span style="color:#f92672">);</span>
        interruptIdleWorkers<span style="color:#f92672">();</span>
        <span style="color:#75715e">// é’©å­å‡½æ•°
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// ScheduledThreadPoolExecutorç”¨äºæ¸…é™¤delayä»»åŠ¡
</span><span style="color:#75715e"></span>        onShutdown<span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
        mainLock<span style="color:#f92672">.</span><span style="color:#a6e22e">unlock</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
    <span style="color:#75715e">// ä¿®æ”¹çº¿ç¨‹æ± çŠ¶æ€(TIDYING TERMINATEDçŠ¶æ€çš„å¤„ç†)
</span><span style="color:#75715e"></span>    tryTerminate<span style="color:#f92672">();</span>
<span style="color:#f92672">}</span>
<span style="color:#75715e">// å°†ctlçŠ¶æ€è½¬æ¢ä¸ºç›®æ ‡çŠ¶æ€æˆ–å·²ç»å˜æˆç›®æ ‡çŠ¶æ€æ—¶ä¿æŒä¸å˜
</span><span style="color:#75715e">// targetState å¯ä»¥æ˜¯ SHUTDOWNæˆ–STOP
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">advanceRunState</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> targetState<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(;;)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// è·å–ctlçŠ¶æ€
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">int</span> c <span style="color:#f92672">=</span> ctl<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">();</span>
        <span style="color:#75715e">// 1. å¦‚æœrunStateAtLeastæˆç«‹ï¼Œè¯´æ˜ c &gt;= targetState
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// è¯´æ˜çŠ¶æ€å·²ç»æ¯”targetè¿˜å¤§ï¼Œé‚£ä¹ˆä¸éœ€è¦å†ä¿®æ”¹äº†ï¼Œä¿æŒä¸å˜
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// 2. step1ä¸æˆç«‹åˆ™CASä¿®æ”¹ctlçŠ¶æ€ç›´åˆ°å°†çŠ¶æ€ä¿®æ”¹ä¸ºtargetState
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>runStateAtLeast<span style="color:#f92672">(</span>c<span style="color:#f92672">,</span> targetState<span style="color:#f92672">)</span> <span style="color:#f92672">||</span>
            ctl<span style="color:#f92672">.</span><span style="color:#a6e22e">compareAndSet</span><span style="color:#f92672">(</span>c<span style="color:#f92672">,</span> ctlOf<span style="color:#f92672">(</span>targetState<span style="color:#f92672">,</span> workerCountOf<span style="color:#f92672">(</span>c<span style="color:#f92672">))))</span>
            <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">interruptIdleWorkers</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    interruptIdleWorkers<span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
<span style="color:#75715e">// ä¸­æ–­å¯èƒ½æ­£åœ¨ç­‰å¾…ä»»åŠ¡çš„çº¿ç¨‹(æŸäº›çº¿ç¨‹å¯èƒ½ä¸ä¼šè¢«ä¸­æ–­)
</span><span style="color:#75715e">// onlyOne = true è‡³å°‘ä¸­æ–­ä¸€ä¸ªworkerçº¿ç¨‹
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">interruptIdleWorkers</span><span style="color:#f92672">(</span><span style="color:#66d9ef">boolean</span> onlyOne<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">final</span> ReentrantLock mainLock <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mainLock</span><span style="color:#f92672">;</span>
    <span style="color:#75715e">// è·å–ç‹¬å é”(ç‹¬å é”é‡å…¥äº†)
</span><span style="color:#75715e"></span>    mainLock<span style="color:#f92672">.</span><span style="color:#a6e22e">lock</span><span style="color:#f92672">();</span>
    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// éå†æ¯ä¸ªworker
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Worker w <span style="color:#f92672">:</span> workers<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// è·å–workerçš„å±æ€§thread
</span><span style="color:#75715e"></span>            Thread t <span style="color:#f92672">=</span> w<span style="color:#f92672">.</span><span style="color:#a6e22e">thread</span><span style="color:#f92672">;</span>
            <span style="color:#75715e">// 1. å¦‚æœå½“å‰çº¿ç¨‹æ²¡æœ‰è¢«ä¸­æ–­ï¼Œé‚£ä¹ˆæ‰§è¡Œstep2
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// 2. å°è¯•è·å–å½“å‰workerçº¿ç¨‹çš„ç‹¬å é”(workeræœ¬èº«å°±æ˜¯é”ï¼Œä¸”åªä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// ç«äº‰è¯¥é”) å¦‚æœè·å–å¤±è´¥è¯´æ˜å½“å‰çº¿ç¨‹æ­£åœ¨æ‰§è¡Œä»»åŠ¡ï¼Œå®ƒä¸æ˜¯ç©ºé—²çš„
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// åªæœ‰1å’Œ2éƒ½æˆç«‹æ‰ä¼šä¸­æ–­å½“å‰çº¿ç¨‹ã€‚
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>t<span style="color:#f92672">.</span><span style="color:#a6e22e">isInterrupted</span><span style="color:#f92672">()</span> <span style="color:#f92672">&amp;&amp;</span> w<span style="color:#f92672">.</span><span style="color:#a6e22e">tryLock</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                    <span style="color:#75715e">// ä¸­æ–­å½“å‰çº¿ç¨‹
</span><span style="color:#75715e"></span>                    t<span style="color:#f92672">.</span><span style="color:#a6e22e">interrupt</span><span style="color:#f92672">();</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>SecurityException ignore<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
                    <span style="color:#75715e">// é‡Šæ”¾workeré”
</span><span style="color:#75715e"></span>                    w<span style="color:#f92672">.</span><span style="color:#a6e22e">unlock</span><span style="color:#f92672">();</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
            <span style="color:#75715e">// å¦‚æœä¸ºtrueè¯´æ˜åªéœ€è¦ä¸­æ–­ä¸€ä¸ªï¼Œbreak
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>onlyOne<span style="color:#f92672">)</span>
                <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
        mainLock<span style="color:#f92672">.</span><span style="color:#a6e22e">unlock</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<p><code>shutDown</code>ä¸ä¼šæ¥å—æ–°çš„ä»»åŠ¡ï¼Œä½†ä¼šæ‰§è¡Œå…ˆå‰æäº¤çš„ä»»åŠ¡ã€‚å¦‚æœå·²shutDownï¼Œå†æ¬¡æ‰§è¡Œä¸ä¼šæœ‰å½±å“ã€‚</p>
<p>æ‰§è¡Œæµç¨‹ï¼š</p>
<ol>
<li>è·å–ç‹¬å é”ï¼Œä¿è¯å…³é—­æ“ä½œå’Œå…¶ä»–æ“ä½œäº’æ–¥ã€‚</li>
<li>æ ¡éªŒæ˜¯å¦æœ‰å…³é—­çº¿ç¨‹æ± æƒé™ã€‚</li>
<li>è‡ªæ—‹ä¿®æ”¹ctlä¸º<code>SHUTDOWN</code>æ€ï¼Œå¦‚æœæ­¤æ—¶<code>ctl &gt; SHUTDOWN</code>ï¼Œåˆ™ä¸åšä¿®æ”¹ã€‚</li>
<li>ä¸­æ–­<code>æ‰€æœ‰æœªè¢«ä¸­æ–­ä¸”ç©ºé—²çš„worker</code>çº¿ç¨‹ã€‚</li>
<li>é‡Šæ”¾ç‹¬å é”ï¼Œå¹¶æ‰§è¡Œ<code>tryTerminate</code>æ–¹æ³•ï¼Œå¤„ç†çº¿ç¨‹æ± çŠ¶æ€è½¬æ¢ã€æ‰§è¡Œ<code>terminate</code>å’Œå”¤é†’ç­‰æ“ä½œã€‚</li>
</ol>
</blockquote>
<h4 id="tryterminate">tryTerminate</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">final</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">tryTerminate</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// è‡ªæ—‹æ‰§è¡Œ
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(;;)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// è·å–ctl
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">int</span> c <span style="color:#f92672">=</span> ctl<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">();</span>
        <span style="color:#75715e">// â‘ æ­£åœ¨RUNNING â‘¡ çº¿ç¨‹æ± çŠ¶æ€å¤§äºç­‰äºTIDYING 
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// â‘¢ å½“å‰çŠ¶æ€ä¸ºshutDownä¸”é˜Ÿåˆ—ä¸ä¸ºç©º
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// ä¸‰è€…ä¸€ä¸ªæˆç«‹å°±è¿”å›ï¼Œä¸ç»§ç»­æ‰§è¡Œ
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>isRunning<span style="color:#f92672">(</span>c<span style="color:#f92672">)</span> <span style="color:#f92672">||</span>
            runStateAtLeast<span style="color:#f92672">(</span>c<span style="color:#f92672">,</span> TIDYING<span style="color:#f92672">)</span> <span style="color:#f92672">||</span>
            <span style="color:#f92672">(</span>runStateOf<span style="color:#f92672">(</span>c<span style="color:#f92672">)</span> <span style="color:#f92672">==</span> SHUTDOWN <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span> workQueue<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">()))</span>
            <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
        <span style="color:#75715e">// å¦‚æœå½“å‰workerçº¿ç¨‹æ•°é‡ä¸ä¸º0
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>workerCountOf<span style="color:#f92672">(</span>c<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// ä¸­æ–­ä¸€ä¸ªç©ºé—²workerçº¿ç¨‹å¹¶è¿”å›
</span><span style="color:#75715e"></span>            interruptIdleWorkers<span style="color:#f92672">(</span>ONLY_ONE<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
		<span style="color:#75715e">// è·å–ç‹¬å é”
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">final</span> ReentrantLock mainLock <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mainLock</span><span style="color:#f92672">;</span>
        mainLock<span style="color:#f92672">.</span><span style="color:#a6e22e">lock</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// åªæœ‰æ­¤å¤„æ‰ä¼šä¿®æ”¹çŠ¶æ€ä¸ºTIDYING!!!
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// CASå°†ctlä¿®æ”¹ä¸ºTIDYING|0
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ctl<span style="color:#f92672">.</span><span style="color:#a6e22e">compareAndSet</span><span style="color:#f92672">(</span>c<span style="color:#f92672">,</span> ctlOf<span style="color:#f92672">(</span>TIDYING<span style="color:#f92672">,</span> 0<span style="color:#f92672">)))</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                    <span style="color:#75715e">// è‡³æ­¤è¯´æ˜çŠ¶æ€ä¸ºTIDYING,workerCount = 0
</span><span style="color:#75715e"></span>                    <span style="color:#75715e">// è°ƒç”¨terminatedé’©å­å‡½æ•°
</span><span style="color:#75715e"></span>                    terminated<span style="color:#f92672">();</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
                    <span style="color:#75715e">// åªæœ‰æ­¤å¤„æ‰ä¼šä¿®æ”¹çŠ¶æ€ä¸ºTERMINATED!!!
</span><span style="color:#75715e"></span>                    <span style="color:#75715e">// å°†çŠ¶æ€è®¾ä¸ºTERMINATED|0
</span><span style="color:#75715e"></span>                    ctl<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>ctlOf<span style="color:#f92672">(</span>TERMINATED<span style="color:#f92672">,</span> 0<span style="color:#f92672">));</span>
                    <span style="color:#75715e">// å”¤é†’awaitTerminationæ–¹æ³•ä¸­ç­‰å¾…çš„çº¿ç¨‹
</span><span style="color:#75715e"></span>                    termination<span style="color:#f92672">.</span><span style="color:#a6e22e">signalAll</span><span style="color:#f92672">();</span>
                <span style="color:#f92672">}</span>
                <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
            mainLock<span style="color:#f92672">.</span><span style="color:#a6e22e">unlock</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<ol>
<li>å¦‚æœ<code>ä¸ºSHUTDOWNæ€ã€çº¿ç¨‹æ± å’Œé˜Ÿåˆ—ä¸ºç©º</code>æˆ–<code>ä¸ºSTOPæ€ä¸”çº¿ç¨‹æ± ä¸ºç©º</code>åˆ™è½¬æ¢ä¸º<code>TIDYINGã€TERMINATED</code>ã€‚</li>
<li>å¦‚æœæ˜¯<code>SHUTDOWNæˆ–STOPæ€</code>ä½†<code>workCount!=0</code>ï¼Œé‚£ä¹ˆä¼šä¸­æ–­ç©ºé—²çš„çº¿ç¨‹ï¼Œä¿è¯å…³æœºçš„ä¿¡å·ä¼ æ’­ã€‚</li>
<li><code>tryTerminate</code>æ–¹æ³•å¹¶ä¸ä¼šå¼ºåˆ¶å…³æœºï¼Œå®ƒåªæ˜¯åœ¨æ­£ç¡®çš„æ—¶é—´å°†çº¿ç¨‹æ± çŠ¶æ€æ”¹ä¸º<code>TIDYING</code>åæ‰§è¡Œ<code>terminated</code>é’©å­å‡½æ•°ï¼Œæœ€åå†å”¤é†’æ‰§è¡Œäº†<code>awaitTermination</code>çš„çº¿ç¨‹ã€‚</li>
<li>åªæœ‰<code>tryTerminate</code>æ–¹æ³•æ‰ä¼šå°†<code>ctl</code>ä¿®æ”¹ä¸º<code>TIDYING</code>æˆ–<code>TERMINATED</code>ï¼Œä¸”<code>è‡ªæ—‹+CAS</code>ç›´åˆ°æˆåŠŸã€‚</li>
<li>æˆ‘ä»¬éœ€åœ¨<code>ä»»ä½•å¯èƒ½ç»ˆæ­¢çš„æ“ä½œä¹‹å</code>ï¼Œè°ƒç”¨<code>tryTerminate</code>æ–¹æ³•ã€‚æ¯”å¦‚<code>å‡å°‘workerçº¿ç¨‹æ•°é‡</code>æˆ–<code>åœ¨shutdownæœŸé—´ä»é˜Ÿåˆ—ä¸­åˆ é™¤ä»»åŠ¡</code>ã€‚</li>
</ol>
</blockquote>
<h4 id="await">await</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// é˜»å¡ç›´åˆ°ä¸‰ä¸ªæ¡ä»¶æ»¡è¶³å…¶ä¸€ï¼š1. æ‰€æœ‰ä»»åŠ¡åœ¨shutdownåå®Œæˆ 2. è¶…æ—¶ 3.å½“å‰çº¿ç¨‹è¢«ä¸­æ–­
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">awaitTermination</span><span style="color:#f92672">(</span><span style="color:#66d9ef">long</span> timeout<span style="color:#f92672">,</span> TimeUnit unit<span style="color:#f92672">)</span>
    								<span style="color:#66d9ef">throws</span> InterruptedException <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">long</span> nanos <span style="color:#f92672">=</span> unit<span style="color:#f92672">.</span><span style="color:#a6e22e">toNanos</span><span style="color:#f92672">(</span>timeout<span style="color:#f92672">);</span>
    <span style="color:#75715e">// è·å–ç‹¬å é”
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">final</span> ReentrantLock mainLock <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mainLock</span><span style="color:#f92672">;</span>
    mainLock<span style="color:#f92672">.</span><span style="color:#a6e22e">lock</span><span style="color:#f92672">();</span>
    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// å¾ªç¯æ‰§è¡Œ
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(;;)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// å¦‚æœæˆç«‹è¯´æ˜çº¿ç¨‹æ± çŠ¶æ€æ—¶TERMINATED
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>runStateAtLeast<span style="color:#f92672">(</span>ctl<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(),</span> TERMINATED<span style="color:#f92672">))</span>
                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
            <span style="color:#75715e">// è¶…æ—¶äº†é‚£ä¹ˆé€€å‡º
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>nanos <span style="color:#f92672">&lt;=</span> 0<span style="color:#f92672">)</span>
                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
            <span style="color:#75715e">// å¦åˆ™è°ƒç”¨condition.awaitNanosç­‰å¾…æŒ‡å®šæ—¶é•¿
</span><span style="color:#75715e"></span>            nanos <span style="color:#f92672">=</span> termination<span style="color:#f92672">.</span><span style="color:#a6e22e">awaitNanos</span><span style="color:#f92672">(</span>nanos<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
        mainLock<span style="color:#f92672">.</span><span style="color:#a6e22e">unlock</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<p><code>awaitTermination</code>ä¼šé˜»å¡ç›´åˆ°ä»¥ä¸‹ä¸‰ä¸ªæ¡ä»¶æ»¡è¶³å…¶ä¸€ï¼š</p>
<ol>
<li>åœ¨è°ƒç”¨<code>shutDownæˆ–shutDownNow</code>åï¼Œæ‰€æœ‰ä»»åŠ¡éƒ½å·²å®Œæˆã€‚</li>
<li>æŒ‡å®šæ—¶é—´è¶…æ—¶äº†ã€‚</li>
<li>å½“å‰çº¿ç¨‹è¢«ä¸­æ–­äº†ã€‚</li>
</ol>
<p>åœ¨<code>tryTerminate</code>æ–¹æ³•ä¸­ç¡®å®å­˜åœ¨<code>å”¤é†’å› æ‰§è¡ŒawaitTerminationæ–¹æ³•ç­‰å¾…çš„çº¿ç¨‹</code>çš„ä»£ç ã€‚</p>
</blockquote>
<h4 id="shutdownnow">shutDownNow</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// è¯¥æ–¹æ³•ä¼šå°è¯•ä¸­æ–­æ‰€æœ‰æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ï¼Œè¿”å›æ­£åœ¨ç­‰å¾…æ‰§è¡Œçš„ä»»åŠ¡åˆ—è¡¨
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> List<span style="color:#f92672">&lt;</span>Runnable<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">shutdownNow</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    List<span style="color:#f92672">&lt;</span>Runnable<span style="color:#f92672">&gt;</span> tasks<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">final</span> ReentrantLock mainLock <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mainLock</span><span style="color:#f92672">;</span>
    <span style="color:#75715e">// è·å–ç‹¬å é”
</span><span style="color:#75715e"></span>    mainLock<span style="color:#f92672">.</span><span style="color:#a6e22e">lock</span><span style="color:#f92672">();</span>
    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// æ ¡éªŒæ˜¯å¦æœ‰å…³é—­çº¿ç¨‹æ± çš„æƒé™
</span><span style="color:#75715e"></span>        checkShutdownAccess<span style="color:#f92672">();</span>
        <span style="color:#75715e">// è‡ªæ—‹æ‰§è¡ŒCASä¿®æ”¹ctlä¸ºSTOP
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// å¦‚æœshutDownæ–¹æ³•é‡Šæ”¾é”åï¼Œæ‰§è¡ŒtryTerminateå‰ï¼Œçº¿ç¨‹æ‰§è¡Œäº†shutDownNow
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// é‚£ä¹ˆä¼šå‘ç”ŸSHUTDOWN -&gt; STOPçŠ¶æ€çš„è½¬æ¢
</span><span style="color:#75715e"></span>        advanceRunState<span style="color:#f92672">(</span>STOP<span style="color:#f92672">);</span>
        <span style="color:#75715e">// ä¸­æ–­æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹å’Œæ­£åœ¨ç­‰å¾…çš„çº¿ç¨‹
</span><span style="color:#75715e"></span>        interruptWorkers<span style="color:#f92672">();</span>
        <span style="color:#75715e">// è¿”å›æ­£åœ¨ç­‰å¾…çš„workerçº¿ç¨‹
</span><span style="color:#75715e"></span>        tasks <span style="color:#f92672">=</span> drainQueue<span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
        mainLock<span style="color:#f92672">.</span><span style="color:#a6e22e">unlock</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
    tryTerminate<span style="color:#f92672">();</span>
    <span style="color:#66d9ef">return</span> tasks<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
<span style="color:#75715e">// ä¸­æ–­å…¨éƒ¨worker
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">interruptWorkers</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">final</span> ReentrantLock mainLock <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mainLock</span><span style="color:#f92672">;</span>
    mainLock<span style="color:#f92672">.</span><span style="color:#a6e22e">lock</span><span style="color:#f92672">();</span>
    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// è¿™é‡Œå¹¶æ²¡æœ‰ä½¿ç”¨tryLockè¿›è¡Œçº¿ç¨‹ç©ºé—²åˆ¤æ–­
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Worker w <span style="color:#f92672">:</span> workers<span style="color:#f92672">)</span>
            w<span style="color:#f92672">.</span><span style="color:#a6e22e">interruptIfStarted</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
        mainLock<span style="color:#f92672">.</span><span style="color:#a6e22e">unlock</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
<span style="color:#75715e">// æ³¨æ„æ–¹æ³•åï¼Œå·²ç»å¼€å§‹çš„æ‰èƒ½ä¸­æ–­
</span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">interruptIfStarted</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    Thread t<span style="color:#f92672">;</span>
    <span style="color:#75715e">// æˆ‘ä»¬åˆå§‹åŒ–workerå¯¹è±¡çš„æ—¶å€™æŠŠstateè®¾ä¸ºäº†-1ï¼Œè¿™é‡Œçš„getState&gt;=0æ˜¯ä¿è¯åˆšåˆ›å»ºçš„
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// workerå¯¹è±¡ä¸èƒ½è¢«æ‰“æ–­
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// thread != nullåªæ˜¯æ­£å¸¸çš„åˆ¤ç©ºæ ¡éªŒ
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// å¦‚æœçº¿ç¨‹æ²¡è¢«ä¸­æ–­é‚£ä¹ˆä¸­æ–­å½“å‰çº¿ç¨‹
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>getState<span style="color:#f92672">()</span> <span style="color:#f92672">&gt;=</span> 0 <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">(</span>t <span style="color:#f92672">=</span> thread<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>t<span style="color:#f92672">.</span><span style="color:#a6e22e">isInterrupted</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
            t<span style="color:#f92672">.</span><span style="color:#a6e22e">interrupt</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>SecurityException ignore<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
<span style="color:#75715e">// å°†é˜»å¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡è½¬æˆlistè¿”å›ï¼Œå¦‚æœæ˜¯å»¶æ—¶é˜Ÿåˆ—æˆ–å…¶ä»–å¯¼è‡´ä¸èƒ½é€šè¿‡drainToè½¬ç§»çš„ä»»åŠ¡ï¼Œ
</span><span style="color:#75715e">// å¾ªç¯åˆ é™¤å¹¶æ·»åŠ åˆ°listä¸­
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> List<span style="color:#f92672">&lt;</span>Runnable<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">drainQueue</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// è·å–æ„é€ å‡½æ•°æŒ‡å®šçš„é˜»å¡é˜Ÿåˆ—
</span><span style="color:#75715e"></span>    BlockingQueue<span style="color:#f92672">&lt;</span>Runnable<span style="color:#f92672">&gt;</span> q <span style="color:#f92672">=</span> workQueue<span style="color:#f92672">;</span>
    <span style="color:#75715e">// åˆ›å»ºç”¨äºè¿”å›çš„list
</span><span style="color:#75715e"></span>    ArrayList<span style="color:#f92672">&lt;</span>Runnable<span style="color:#f92672">&gt;</span> taskList <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;</span>Runnable<span style="color:#f92672">&gt;();</span>
    <span style="color:#75715e">// å°†é˜»å¡é˜Ÿåˆ—ä¸­çš„Runnableè½¬ç§»åˆ°listï¼Œå¹¶åˆ é™¤æ—§çš„å…ƒç´ 
</span><span style="color:#75715e"></span>    q<span style="color:#f92672">.</span><span style="color:#a6e22e">drainTo</span><span style="color:#f92672">(</span>taskList<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>q<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// è¿™é‡Œè®¾ç½®äº†æ•°ç»„å¤§å°ä¸º1(æ•°ç»„å¤§å°ç¡®å®šä¸ä¼šå˜åŒ–)
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// é€šè¿‡å¾ªç¯æ¯æ¬¡éƒ½è·å–qä¸­çš„ä¸€ä¸ªä»»åŠ¡ï¼Œç›´åˆ°æˆåŠŸç§»é™¤å®ƒï¼Œæ·»åŠ åˆ°é˜Ÿlistï¼Œå†æ‰§è¡Œä¸‹ä¸€ä»»åŠ¡
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Runnable r <span style="color:#f92672">:</span> q<span style="color:#f92672">.</span><span style="color:#a6e22e">toArray</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Runnable<span style="color:#f92672">[</span>0<span style="color:#f92672">]))</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>q<span style="color:#f92672">.</span><span style="color:#a6e22e">remove</span><span style="color:#f92672">(</span>r<span style="color:#f92672">))</span>
                taskList<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>r<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> taskList<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<p><code>shutDownNow</code>ä¼š<code>ä¸­æ–­æ­£åœ¨æ‰§è¡ŒåŠæ­£åœ¨ç­‰å¾…çš„workerçº¿ç¨‹</code>ã€‚å¹¶ä¼š<code>è¿”å›é˜»å¡é˜Ÿåˆ—ä¸­çš„å…¨éƒ¨ä»»åŠ¡å¹¶åˆ é™¤</code>ã€‚</p>
<p><code>shutDownNow</code>æ‰§è¡Œæµç¨‹ï¼š</p>
<ol>
<li>è·å–ç‹¬å é”ï¼Œä¿è¯å…³é—­æ“ä½œå’Œå…¶ä»–æ“ä½œäº’æ–¥ã€‚</li>
<li>æ ¡éªŒæ˜¯å¦æœ‰å…³é—­çº¿ç¨‹æ± æƒé™ã€‚</li>
<li>è‡ªæ—‹ä¿®æ”¹ctlä¸º<code>STOP</code>æ€ï¼Œå¦‚æœæ­¤æ—¶<code>ctl &gt; STOP</code>ï¼Œåˆ™ä¸åšä¿®æ”¹ã€‚å¦‚æœæ­¤æ—¶<code>ctl = SHUTDOWN</code>ï¼Œé‚£ä¹ˆä¼šå°†<code>SHUTDOWN</code>æ”¹ä¸º<code>STOP</code>ï¼Œä¹Ÿå°±æ˜¯10-12è¡Œä»£ç æ³¨é‡Šæ‰€é‡Šã€‚</li>
<li>ä¸­æ–­<code>æ‰€æœ‰æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹åŠæ­£åœ¨ç­‰å¾…çš„çº¿ç¨‹(åˆšåˆ›å»ºçš„state=-1workerçº¿ç¨‹ä¸ä¼šè¢«ä¸­æ–­)</code>ï¼Œå¹¶<code>åœ¨è¿”å›é˜»å¡é˜Ÿåˆ—ä¸­çš„å…¨éƒ¨ä»»åŠ¡å¹¶æ¸…ç©ºé˜Ÿåˆ—</code>ã€‚</li>
<li>é‡Šæ”¾ç‹¬å é”ï¼Œå¹¶æ‰§è¡Œ<code>tryTerminate</code>æ–¹æ³•ï¼Œå¤„ç†çº¿ç¨‹æ± çŠ¶æ€è½¬æ¢ã€æ‰§è¡Œ<code>terminate</code>å’Œå”¤é†’ç­‰æ“ä½œã€‚</li>
</ol>
</blockquote>
<h4 id="æ­£ç¡®çš„å…³é—­çº¿ç¨‹æ± ">æ­£ç¡®çš„å…³é—­çº¿ç¨‹æ± </h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Slf4j</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ThreadPoolExecutorTest</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> ExecutorService POOL <span style="color:#f92672">=</span> 		ThreadPoolSingleton<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstance</span><span style="color:#f92672">();</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        POOL<span style="color:#f92672">.</span><span style="color:#a6e22e">execute</span><span style="color:#f92672">(()</span> <span style="color:#f92672">-&gt;</span> <span style="color:#f92672">{</span>
            log<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;prepare to sleep ...&#34;</span><span style="color:#f92672">);</span>
            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">sleep</span><span style="color:#f92672">(</span>5000<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>InterruptedException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">});</span>
        POOL<span style="color:#f92672">.</span><span style="color:#a6e22e">shutdown</span><span style="color:#f92672">();</span><span style="color:#75715e">// ä¹Ÿå¯ä»¥ä½¿ç”¨shutDownNow()
</span><span style="color:#75715e"></span>        log<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;è°ƒç”¨shutDownæ–¹æ³• ... &#34;</span><span style="color:#f92672">);</span>
        
        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">boolean</span> loop<span style="color:#f92672">;</span>
            <span style="color:#66d9ef">do</span> <span style="color:#f92672">{</span>
                loop <span style="color:#f92672">=</span> <span style="color:#f92672">!</span>POOL<span style="color:#f92672">.</span><span style="color:#a6e22e">awaitTermination</span><span style="color:#f92672">(</span>3<span style="color:#f92672">,</span> TimeUnit<span style="color:#f92672">.</span><span style="color:#a6e22e">SECONDS</span><span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>loop<span style="color:#f92672">);</span>
            log<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Thread Pool çœŸæ­£å…³é—­æ‹‰ ...&#34;</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>InterruptedException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            log<span style="color:#f92672">.</span><span style="color:#a6e22e">error</span><span style="color:#f92672">(</span>e<span style="color:#f92672">.</span><span style="color:#a6e22e">getMessage</span><span style="color:#f92672">());</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
<span style="color:#75715e">// çº¿ç¨‹æ± çš„å•ä¾‹ç±»
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ThreadPoolSingleton</span> <span style="color:#66d9ef">implements</span> Serializable <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">ThreadPoolSingleton</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> RuntimeException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Can not exec constructor&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> ThreadPoolExecutor <span style="color:#a6e22e">getInstance</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> Holder<span style="color:#f92672">.</span><span style="color:#a6e22e">THREAD_POOL_EXECUTOR</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Holder</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> ThreadPoolExecutor THREAD_POOL_EXECUTOR <span style="color:#f92672">=</span>
            <span style="color:#66d9ef">new</span> ThreadPoolExecutor<span style="color:#f92672">(</span>
                2<span style="color:#f92672">,</span>
                32<span style="color:#f92672">,</span>
                60<span style="color:#f92672">,</span>
                TimeUnit<span style="color:#f92672">.</span><span style="color:#a6e22e">SECONDS</span><span style="color:#f92672">,</span>
                <span style="color:#66d9ef">new</span> ArrayBlockingQueue<span style="color:#f92672">&lt;&gt;(</span>10<span style="color:#f92672">),</span>
                <span style="color:#66d9ef">new</span> CustomizableThreadFactory<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Thread-Pool-&#34;</span><span style="color:#f92672">),</span>
                <span style="color:#66d9ef">new</span> ThreadPoolExecutor<span style="color:#f92672">.</span><span style="color:#a6e22e">CallerRunsPolicy</span><span style="color:#f92672">());</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> Object <span style="color:#a6e22e">readResolve</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> getInstance<span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h4 id="æ€»ç»“">æ€»ç»“</h4>
<ul>
<li>
<p><code>shutDown</code>å’Œ<code>shutDownNow</code>éƒ½ä¼šå»<code>ä¿®æ”¹ctlçŠ¶æ€</code>ï¼Œå¹¶<code>ä¸­æ–­çº¿ç¨‹</code>ï¼Œæœ€åè°ƒç”¨<code>tryTerminate</code>æ–¹æ³•ã€‚</p>
</li>
<li>
<p>shutDownå’ŒshutDownNowåŒºåˆ«</p>
<table>
<thead>
<tr>
<th></th>
<th>ä¸­æ–­çº¿ç¨‹ç±»å‹</th>
<th>é˜»å¡é˜Ÿåˆ—</th>
</tr>
</thead>
<tbody>
<tr>
<td>shutDown</td>
<td>ä¸­æ–­ç©ºé—²çº¿ç¨‹</td>
<td>ä¸æ¸…ç©ºé˜»å¡é˜Ÿåˆ—ï¼Œç­‰å¾…ä»»åŠ¡å…¨éƒ¨æ‰§è¡Œå®Œæˆ</td>
</tr>
<tr>
<td>shutDownNow</td>
<td>ä¸­æ–­ç©ºé—²çº¿ç¨‹å’Œæ­£åœ¨æ‰§è¡Œçº¿ç¨‹</td>
<td>æ¸…ç©ºé˜»å¡é˜Ÿåˆ—ï¼Œå¹¶è¿”å›é˜»å¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡</td>
</tr>
</tbody>
</table>
</li>
<li>
<p><code>tryTerminate</code>åªæ˜¯å¤„ç†<code>TIDYING</code>å’Œ<code>TERMINATED</code>çŠ¶æ€ã€æ‰§è¡Œé’©å­å‡½æ•°åŠå”¤é†’ç­‰å¾…çº¿ç¨‹ï¼Œ<code>ä¸ä¼šå¼ºåˆ¶å…³æœº</code>ã€‚</p>
</li>
<li>
<p>çº¿ç¨‹æ± å…³é—­çš„æµç¨‹çŠ¶æ€å›¾</p>
<p><img src="https://image.leejay.top/image/20200714/C5qLgqKHxr5W.png?imageslim" alt=""></p>
</li>
</ul>
<hr>
<h3 id="çº¿ç¨‹æ± æ·»åŠ ä»»åŠ¡">çº¿ç¨‹æ± æ·»åŠ ä»»åŠ¡</h3>
<h4 id="execute">execute</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// æäº¤ä»»åŠ¡ç»™çº¿ç¨‹æ± ï¼Œæ²¡æœ‰è·å–ç‹¬å é”çš„æ“ä½œ
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">execute</span><span style="color:#f92672">(</span>Runnable command<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// commandä¸èƒ½ä¸ºç©º
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>command <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> NullPointerException<span style="color:#f92672">();</span>
    <span style="color:#75715e">// è·å–ctlå˜é‡ï¼Œé»˜è®¤æ˜¯ RUNNING|0 å³ 1110 0000 0000 0000 0000 0000 0000 0000
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> c <span style="color:#f92672">=</span> ctl<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">();</span>
    <span style="color:#75715e">// åˆ¤æ–­workeræ•°é‡æ˜¯å¦å°äºcorePoolSize
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>workerCountOf<span style="color:#f92672">(</span>c<span style="color:#f92672">)</span> <span style="color:#f92672">&lt;</span> corePoolSize<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// æ·»åŠ workerçº¿ç¨‹å¹¶æŠŠä»»åŠ¡äº¤ç»™workerï¼Œtrueè¡¨ç¤ºå¾€æ ¸å¿ƒæ± ä¸­æ·»åŠ 
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>addWorker<span style="color:#f92672">(</span>command<span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">))</span>
            <span style="color:#75715e">// æ·»åŠ æˆåŠŸè¿”å›
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
        <span style="color:#75715e">// æ·»åŠ å¤±è´¥è·å–ctlå˜é‡
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// æ­¤å¤„å¤±è´¥åŸå› ï¼šcorePoolSizeå·²ç»æ»¡äº†æˆ–çº¿ç¨‹æ± ç»ˆæ­¢äº†
</span><span style="color:#75715e"></span>        c <span style="color:#f92672">=</span> ctl<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
    <span style="color:#75715e">// æ‰€ä»¥åˆ¤æ–­æ˜¯å¦è¿˜åœ¨RUNNINGçŠ¶æ€ï¼Œå¦‚æœæ˜¯å°±å¾€é˜»å¡é˜Ÿåˆ—æ·»åŠ ä»»åŠ¡ï¼Œå¦‚æœé˜Ÿåˆ—æ»¡ä¼šè¿”å›false
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>isRunning<span style="color:#f92672">(</span>c<span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span> workQueue<span style="color:#f92672">.</span><span style="color:#a6e22e">offer</span><span style="color:#f92672">(</span>command<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// ä»»åŠ¡æ·»åŠ åˆ°é˜Ÿåˆ—æˆåŠŸï¼Œç»§ç»­åˆ¤æ–­çŠ¶æ€
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">int</span> recheck <span style="color:#f92672">=</span> ctl<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">();</span>
        <span style="color:#75715e">// å› ä¸ºexecuteä¸æ˜¯è·å–é”æ‰§è¡Œï¼Œæ‰€ä»¥å¦‚æœåˆšæ·»åŠ å®Œçº¿ç¨‹æˆåŠŸï¼Œå¦ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨shutDown
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// æ–¹æ³•ä¿®æ”¹ä¸ºSHUTDOWNæ€ï¼Œ æ‰€ä»¥éœ€è¦ç»§ç»­åˆ¤æ–­ï¼Œå¦‚æœæ­¤æ—¶ä¸æ˜¯RUNNINGï¼Œ
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// é‚£ä¹ˆè°ƒç”¨removeç§»é™¤å½“å‰ä»»åŠ¡ï¼Œå¦‚æœç§»é™¤æˆåŠŸï¼Œé‚£ä¹ˆè°ƒç”¨æ‹’ç»ç­–ç•¥ã€‚
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// å¦‚æœè°ƒç”¨å¤±è´¥ï¼Œæœ‰å¯èƒ½è¿™ä¸ªä»»åŠ¡åˆšè¢«æ‰§è¡Œäº†ï¼Œå°±ä¼šåˆ é™¤å¤±è´¥
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span> isRunning<span style="color:#f92672">(</span>recheck<span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span> remove<span style="color:#f92672">(</span>command<span style="color:#f92672">))</span>
            reject<span style="color:#f92672">(</span>command<span style="color:#f92672">);</span>
        <span style="color:#75715e">// æ‰§è¡Œåˆ°æ­¤å­˜åœ¨ä¸¤ç§æƒ…å†µ: 1. æ­¤æ—¶è¿˜æ˜¯RUNNINGæ€ 2. ä¸æ˜¯RUNNINGæ€ï¼Œç§»é™¤ä»»åŠ¡å¤±è´¥
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// é’ˆå¯¹1æ­¤æ—¶å­˜åœ¨ä»»åŠ¡ï¼Œä½†workercount = 0ï¼Œæ‰€ä»¥éœ€è¦åˆ›å»ºçº¿ç¨‹æ¥æ‰§è¡Œè¿™ä¸ªä»»åŠ¡
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// é’ˆå¯¹2ï¼Œå¦‚æœä»»åŠ¡åˆšè¢«æ‹¿èµ°ï¼Œé‚£ä¹ˆworkerçº¿ç¨‹æ•°ä¸ä¼šä¸º0ã€‚
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>workerCountOf<span style="color:#f92672">(</span>recheck<span style="color:#f92672">)</span> <span style="color:#f92672">==</span> 0<span style="color:#f92672">)</span>
            addWorker<span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#75715e">// è‡³æ­¤è¯´æ˜corePoolSizeæ»¡äº†ï¼Œé˜Ÿåˆ—ä¹Ÿæ»¡äº†ï¼Œé‚£ä¹ˆæ·»åŠ çº¿ç¨‹ç›´åˆ°maxPoolSize
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>addWorker<span style="color:#f92672">(</span>command<span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">))</span>
        <span style="color:#75715e">// å¦‚æœè¿˜æ·»åŠ å¤±è´¥ï¼Œè¯´æ˜å·²ç»è¾¾åˆ°maxPoolSizeäº†ã€‚è°ƒç”¨æ‹’ç»ç­–ç•¥
</span><span style="color:#75715e"></span>        reject<span style="color:#f92672">(</span>command<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
<span style="color:#75715e">// ç§»é™¤ä»»åŠ¡ï¼Œå¦‚æœä»»åŠ¡å·²è¢«æ‰§è¡Œé‚£ä¹ˆå°±è¿”å›false
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">remove</span><span style="color:#f92672">(</span>Runnable task<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// ä»é˜Ÿåˆ—ä¸­ç§»é™¤ä»»åŠ¡
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">boolean</span> removed <span style="color:#f92672">=</span> workQueue<span style="color:#f92672">.</span><span style="color:#a6e22e">remove</span><span style="color:#f92672">(</span>task<span style="color:#f92672">);</span>
    <span style="color:#75715e">// ä¹‹å‰åˆ†ætryTerminateæ—¶è¯´è¿‡ï¼šä»»ä½•å¯èƒ½ç»ˆæ­¢æ“ä½œåè°ƒç”¨tryTerminate
</span><span style="color:#75715e"></span>    tryTerminate<span style="color:#f92672">();</span>
    <span style="color:#66d9ef">return</span> removed<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e">// è°ƒç”¨æ‹’ç»ç­–ç•¥å…·ä½“çš„å®ç°ç±»
</span><span style="color:#75715e"></span><span style="color:#66d9ef">final</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">reject</span><span style="color:#f92672">(</span>Runnable command<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    handler<span style="color:#f92672">.</span><span style="color:#a6e22e">rejectedExecution</span><span style="color:#f92672">(</span>command<span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<p>æ‰§è¡Œæµç¨‹ï¼š</p>
<ol>
<li>åˆ¤æ–­<code>workerCount &lt; corePoolSize</code>æ˜¯å¦æˆç«‹ï¼Œæˆç«‹è°ƒç”¨<code>addWorker</code>å¹¶è¿”å›ï¼Œä¸æˆç«‹æ‰§è¡Œstep2ã€‚</li>
<li>å¦‚æœå¤„äº<code>RUNNINGæ€ &amp;&amp; ä»»åŠ¡åŠ å…¥é˜»å¡é˜Ÿåˆ—</code>ï¼Œä¸æˆåŠŸè°ƒç”¨step3ã€‚è‹¥æˆåŠŸï¼Œå› ä¸ºexecuteæ–¹æ³•æ²¡æœ‰åŠ é”æ‰§è¡Œï¼Œæ‰€ä»¥éœ€è¦<code>double-check</code>çŠ¶æ€ï¼Œå¦‚æœ<code>ä¸å¤„äºRUNNINGæ€åˆ™å°è¯•ç§»é™¤åˆšæ·»åŠ çš„ä»»åŠ¡</code>ï¼Œè‹¥<code>å¤„äºRUNNINGæ€æˆ–ç§»é™¤å¤±è´¥</code>ï¼Œåˆ¤æ–­å½“å‰<code>workerCount == 0</code>ï¼Œæˆç«‹åˆ™è°ƒç”¨<code>addWorker</code>æ·»åŠ çº¿ç¨‹æ‰§è¡ŒåˆšåŠ å…¥çš„ä»»åŠ¡ã€‚</li>
<li>æ‰§è¡Œè‡³æ­¤ï¼Œè¯´æ˜ï¼šè¦ä¹ˆ<code>çº¿ç¨‹æ± ä¸å¤„äºRUNNINGæ€</code>ï¼Œè°ƒç”¨<code>addWorker</code>æ·»åŠ çº¿ç¨‹ä¹Ÿä¼šè¿”å›falseï¼Œæ‰§è¡Œ<code>reject</code>æ‹’ç»ç­–ç•¥ã€‚è¦ä¹ˆ<code>corePoolSizeå’Œé˜»å¡é˜Ÿåˆ—å·²æ»¡</code>ï¼Œé‚£ä¹ˆè°ƒç”¨<code>addWorker</code>å½“çº¿ç¨‹æ•°è¾¾åˆ°<code>maxPoolSize</code>æ—¶ä¹Ÿä¼šè¿”å›falseï¼Œæ‰§è¡Œ<code>reject</code>æ‹’ç»ç­–ç•¥ã€‚</li>
</ol>
</blockquote>
<h4 id="addworker">addWorker</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// æ ¸å¿ƒæ–¹æ³•
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">addWorker</span><span style="color:#f92672">(</span>Runnable firstTask<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> core<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    retry<span style="color:#f92672">:</span>
    <span style="color:#75715e">// â‘  ç¬¬ä¸€ä¸ªè‡ªæ—‹: æ ¹æ®çŠ¶æ€çš„ä¸åŒï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦å¢åŠ workerCount
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(;;)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// è·å–ctlå˜é‡
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">int</span> c <span style="color:#f92672">=</span> ctl<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">();</span>
        <span style="color:#75715e">// è·å–è¿è¡ŒçŠ¶æ€
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">int</span> rs <span style="color:#f92672">=</span> runStateOf<span style="color:#f92672">(</span>c<span style="color:#f92672">);</span>
		<span style="color:#75715e">// å¦‚æœ rs != SHUTDOWN å°±ä¸éœ€è¦å†å¤„ç†äº†
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// rs = SHUTDOWNæ—¶ï¼Œä¸æ¥å—æ–°çš„ä»»åŠ¡(task != null)ï¼Œå¤„ç†é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// rs = SHUTDOWNæ—¶ï¼Œæ— ä»»åŠ¡æ—¶ï¼Œé˜Ÿåˆ—ä¸ä¸ºç©ºå°±å¸®åŠ©æ‰§è¡Œé˜Ÿåˆ—ä¸­ä»»åŠ¡
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>rs <span style="color:#f92672">&gt;=</span> SHUTDOWN <span style="color:#f92672">&amp;&amp;</span>
            <span style="color:#f92672">!</span> <span style="color:#f92672">(</span>rs <span style="color:#f92672">==</span> SHUTDOWN <span style="color:#f92672">&amp;&amp;</span>
               firstTask <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span>
               <span style="color:#f92672">!</span> workQueue<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">()))</span>
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
		<span style="color:#75715e">// â‘¡ ç¬¬äºŒä¸ªè‡ªæ—‹ï¼šä¸»è¦å¤„ç†workerCountæ˜¯å¦è¶…è¿‡é˜ˆå€¼åŠè‡ªå¢
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(;;)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// è·å–workerçº¿ç¨‹æ•°é‡
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">int</span> wc <span style="color:#f92672">=</span> workerCountOf<span style="color:#f92672">(</span>c<span style="color:#f92672">);</span>
            <span style="color:#75715e">// å¦‚æœwcè¶…è¿‡é˜ˆå€¼ï¼Œç›´æ¥è¿”å›false
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// core: trueå°±å’ŒcorePoolSzieæ¯”ï¼Œfalseå°±å’ŒmaxPoolSizeæ¯”
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>wc <span style="color:#f92672">&gt;=</span> CAPACITY <span style="color:#f92672">||</span>
                wc <span style="color:#f92672">&gt;=</span> <span style="color:#f92672">(</span>core <span style="color:#f92672">?</span> corePoolSize <span style="color:#f92672">:</span> maximumPoolSize<span style="color:#f92672">))</span>
                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
            <span style="color:#75715e">// å°è¯•CASå°†ctl + 1	
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>compareAndIncrementWorkerCount<span style="color:#f92672">(</span>c<span style="color:#f92672">))</span>
                <span style="color:#75715e">// æˆåŠŸæ‰èƒ½è·³å‡ºå¾ªç¯
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">break</span> retry<span style="color:#f92672">;</span>
            <span style="color:#75715e">// å†æ¬¡è·å–ctlåˆ¤æ–­rsçŠ¶æ€æ˜¯å¦è¢«ä¿®æ”¹
</span><span style="color:#75715e"></span>            c <span style="color:#f92672">=</span> ctl<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">();</span>
            <span style="color:#75715e">// åœ¨æ‰§è¡ŒaddWorkerçš„æœŸé—´ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹å°è¯•ä¿®æ”¹äº†è¿è¡ŒçŠ¶æ€
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>runStateOf<span style="color:#f92672">(</span>c<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> rs<span style="color:#f92672">)</span>
                <span style="color:#75715e">// è¢«ä¿®æ”¹å°±ç»§ç»­å¤–å±‚å¾ªç¯
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">continue</span> retry<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    <span style="color:#75715e">// ç¬¬ä¸‰éƒ¨åˆ† â‘¢
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// è¡¨ç¤ºä»»åŠ¡æ˜¯å¦å¼€å¯
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">boolean</span> workerStarted <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
    <span style="color:#75715e">// è¡¨ç¤ºä»»åŠ¡æ˜¯å¦æ·»åŠ 
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">boolean</span> workerAdded <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
    Worker w <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// åˆ›å»ºworkerå¯¹è±¡ï¼Œèµ‹äºˆä»»åŠ¡ï¼Œå¹¶é€šè¿‡çº¿ç¨‹å·¥å‚åˆ›å»ºå¤„ç†è¯¥ä»»åŠ¡çš„çº¿ç¨‹
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// æ³¨æ„æ­¤å¤„çš„task å¯èƒ½ç­‰äº null
</span><span style="color:#75715e"></span>        w <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Worker<span style="color:#f92672">(</span>firstTask<span style="color:#f92672">);</span>
        <span style="color:#75715e">// è·å–æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹ï¼Œå¦‚æœå› ä¸ºçº¿ç¨‹å·¥å‚åˆ›å»ºçº¿ç¨‹è¿”å›nullæˆ–çº¿ç¨‹å¯åŠ¨å¯¼è‡´çš„OOM
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// éƒ½ä¼šå¯¼è‡´æ­¤å¤„çš„t=nullï¼Œé‚£ä¹ˆåœ¨finallyä¸­ä¼šå›æ»š
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">final</span> Thread t <span style="color:#f92672">=</span> w<span style="color:#f92672">.</span><span style="color:#a6e22e">thread</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>t <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">final</span> ReentrantLock mainLock <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mainLock</span><span style="color:#f92672">;</span>
            <span style="color:#75715e">// è·å–ç‹¬å é”
</span><span style="color:#75715e"></span>            mainLock<span style="color:#f92672">.</span><span style="color:#a6e22e">lock</span><span style="color:#f92672">();</span>
            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// è·å–é”åè¿˜è¦åˆ¤æ–­çŠ¶æ€ï¼Œå› ä¸ºå¯èƒ½åœ¨è·å–é”ç­‰å¾…çš„æ—¶å€™çŠ¶æ€è¢«ä¿®æ”¹
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">int</span> rs <span style="color:#f92672">=</span> runStateOf<span style="color:#f92672">(</span>ctl<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">());</span>
				<span style="color:#75715e">// rs = RUNNING æˆ– ï¼ˆrs = SHUTDOWN ä¸” task = nullï¼‰
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// çŠ¶æ€ä¸ºSHUTDOWNï¼Œä½†ä»»åŠ¡ä¸ºnullä¹Ÿæ·»åŠ åˆ°æ± ä¸­ï¼Œå› ä¸ºæ­¤æ—¶çš„é˜»å¡é˜Ÿåˆ—
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// è‚¯å®šä¸ä¸ºç©ºï¼Œç”¨äºååŠ©å¤„ç†ä»»åŠ¡ï¼Œè®©çº¿ç¨‹æ± æ—©ç‚¹å…³æœº
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>rs <span style="color:#f92672">&lt;</span> SHUTDOWN <span style="color:#f92672">||</span>
                    <span style="color:#f92672">(</span>rs <span style="color:#f92672">==</span> SHUTDOWN <span style="color:#f92672">&amp;&amp;</span> firstTask <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                    <span style="color:#75715e">// åˆ¤æ–­çº¿ç¨‹æ˜¯å¦startæˆ–è¿˜æ²¡æœ‰dead
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>t<span style="color:#f92672">.</span><span style="color:#a6e22e">isAlive</span><span style="color:#f92672">())</span>
                        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> IllegalThreadStateException<span style="color:#f92672">();</span>
                    <span style="color:#75715e">// æ·»åŠ åˆ°HashSet&lt;Worker&gt;ä¸­
</span><span style="color:#75715e"></span>                    workers<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>w<span style="color:#f92672">);</span>
                    <span style="color:#75715e">// è·å–é˜Ÿåˆ—å¤§å°
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">int</span> s <span style="color:#f92672">=</span> workers<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">();</span>
                    <span style="color:#75715e">// åªæœ‰è¿™ä¸ªåœ°æ–¹ä¼šä¿®æ”¹largePoolSize
</span><span style="color:#75715e"></span>                    <span style="color:#75715e">// è¿™é‡Œçš„åˆ¤æ–­è¯´æ˜å­˜åœ¨å¦ä¸€å¤„ä¼šç§»é™¤workerï¼Œæ‰€ä»¥è¦ä¿è¯
</span><span style="color:#75715e"></span>                    <span style="color:#75715e">// åªæœ‰é˜Ÿåˆ—å¤§å°å¤§äºå½“å‰largePoolSizeå†æ›´æ–°è¯¥æˆå‘˜å˜é‡
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>s <span style="color:#f92672">&gt;</span> largestPoolSize<span style="color:#f92672">)</span>
                        largestPoolSize <span style="color:#f92672">=</span> s<span style="color:#f92672">;</span>
                    <span style="color:#75715e">// ä¿®æ”¹å˜é‡
</span><span style="color:#75715e"></span>                    workerAdded <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// é‡Šæ”¾ç‹¬å é”
</span><span style="color:#75715e"></span>                mainLock<span style="color:#f92672">.</span><span style="color:#a6e22e">unlock</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span>
            <span style="color:#75715e">// åªæœ‰æ·»åŠ åˆ°workeré˜Ÿåˆ—ä¸­æ‰ä¼šå¯åŠ¨ä»»åŠ¡
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>workerAdded<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// æ‰§è¡ŒWorkerç±»ä¸­çš„runæ–¹æ³•ï¼Œä¸‹ä¸€ç« åˆ†æ
</span><span style="color:#75715e"></span>                t<span style="color:#f92672">.</span><span style="color:#a6e22e">start</span><span style="color:#f92672">();</span>
                <span style="color:#75715e">// ä¿®æ”¹å˜é‡
</span><span style="color:#75715e"></span>                workerStarted <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// ç¬¬å››éƒ¨åˆ†â‘£
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// workerStarted = falseï¼Œé‚£ä¹ˆworkerAddedè‚¯å®šæ˜¯false
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// è¯´æ˜ t=null | t!=nullä½†(rs &gt; shutdown or(rs=shutdownä½†task!=null)ï¼‰
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span> workerStarted<span style="color:#f92672">)</span>
            <span style="color:#75715e">// ä»»åŠ¡å›æ»š
</span><span style="color:#75715e"></span>            addWorkerFailed<span style="color:#f92672">(</span>w<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> workerStarted<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
<span style="color:#75715e">// æ²¡æœ‰æˆåŠŸæ·»åŠ ä»»åŠ¡ï¼Œé‚£ä¹ˆéœ€è¦å›æ»š
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">addWorkerFailed</span><span style="color:#f92672">(</span>Worker w<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">final</span> ReentrantLock mainLock <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mainLock</span><span style="color:#f92672">;</span>
    <span style="color:#75715e">// è·å–ç‹¬å é”
</span><span style="color:#75715e"></span>    mainLock<span style="color:#f92672">.</span><span style="color:#a6e22e">lock</span><span style="color:#f92672">();</span>
    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// ç§»é™¤worker
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>w <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
            workers<span style="color:#f92672">.</span><span style="color:#a6e22e">remove</span><span style="color:#f92672">(</span>w<span style="color:#f92672">);</span>
        <span style="color:#75715e">// å°†workerCount-1
</span><span style="color:#75715e"></span>        decrementWorkerCount<span style="color:#f92672">();</span>
        <span style="color:#75715e">// è°ƒç”¨tryTerminateï¼Œå› ä¸ºå¯èƒ½çº¿ç¨‹æ± è¢«shutdownäº†
</span><span style="color:#75715e"></span>        tryTerminate<span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
        mainLock<span style="color:#f92672">.</span><span style="color:#a6e22e">unlock</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<p>æ‰§è¡Œæµç¨‹åˆ†ä¸ºå››ä¸ªéƒ¨åˆ†è¿›è¡Œåˆ†æï¼š</p>
<ol>
<li>
<p>ç¬¬ä¸€éƒ¨åˆ†å¯¹çº¿ç¨‹æ± çš„çŠ¶æ€è¿›è¡Œåˆ¤æ–­ï¼Œ<code>ç»§ç»­æ‰§è¡Œç¬¬äºŒéƒ¨åˆ†</code>éœ€è¦ç¬¦åˆä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶ä¸­ä¸€ä¸ªå³å¯ï¼š</p>
<p>â‘  çº¿ç¨‹æ± çŠ¶æ€ä¸º<code>RUNNING</code>ã€‚</p>
<p>â‘¡ çº¿ç¨‹æ± çŠ¶æ€ä¸º<code>SHUTDOWN</code>æ—¶ï¼Œ<code>firstTask == null</code>ä¸”<code>é˜»å¡é˜Ÿåˆ—ä¸ä¸ºç©º</code>ã€‚(è¾…åŠ©ç†è§£ï¼šå½“çº¿ç¨‹æ± çŠ¶æ€ä¸º<code>SHUTDOWN</code>æ—¶<code>ä¸æ¥å—æ–°çš„ä»»åŠ¡</code>ï¼Œä½†æ˜¯<code>å·²å­˜åœ¨é˜»å¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡å½“å‰çº¿ç¨‹å¯ä»¥ååŠ©æ‰§è¡Œ</code>ã€‚)</p>
</li>
<li>
<p>ç¬¬äºŒéƒ¨åˆ†åˆ¤æ–­<code>workerCountæ˜¯å¦è¶…è¿‡é˜ˆå€¼</code>ï¼Œå¦‚æœæ²¡æœ‰åˆ™<code>CASä¿®æ”¹workerCount</code>ï¼Œå¦‚æœ<code>workerCount CAS</code>ä¿®æ”¹æœŸé—´çŠ¶æ€å˜åŒ–ï¼Œåˆ™å›åˆ°ç¬¬ä¸€éƒ¨åˆ†ç»§ç»­æ‰§è¡Œã€‚</p>
</li>
<li>
<p>ç¬¬ä¸‰éƒ¨åˆ†åˆ›å»º<code>workerå¯¹è±¡</code>ï¼Œå¹¶<code>åŠ å…¥çº¿ç¨‹æ± ä¸­</code>ï¼Œä¹‹å<code>å¼€å¯çº¿ç¨‹æ‰§è¡Œä»»åŠ¡</code>ã€‚å¦‚ä¸‹æƒ…å†µæ‰§è¡Œç¬¬å››éƒ¨åˆ†ï¼š</p>
<p>â‘  å½“å‰workerå¯¹è±¡<code>é€šè¿‡çº¿ç¨‹å·¥å‚åˆ›å»ºçš„çº¿ç¨‹è¿”å›null</code>ã€‚</p>
<p>â‘¡ è·å–ç‹¬å é”è¿‡ç¨‹ä¸­çŠ¶æ€å˜åŒ–äº†ï¼š<code>rs != RUNNING</code> ä¸” <code>rs = SHUTDOWN æ—¶ firstTask != null</code>ã€‚</p>
</li>
<li>
<p>ç¬¬å››éƒ¨åˆ†æ‰§è¡Œå›æ»šæ“ä½œï¼š<code>ç§»é™¤worker</code>ã€<code>CASå°†workerCountå‡1</code>å’Œ<code>è°ƒç”¨tryTerminate</code>ã€‚</p>
</li>
</ol>
<p>addWorkeræ–¹æ³•ä¸»è¦æ˜¯<code>æ·»åŠ workerçº¿ç¨‹åˆ°çº¿ç¨‹æ± ä¸­ï¼Œå¹¶å¯åŠ¨çº¿ç¨‹æ‰§è¡Œä»»åŠ¡</code>ï¼Œworkerçº¿ç¨‹åˆ†ä¸ºä¸¤ç±»ï¼š</p>
<ol>
<li>
<p><code>æœ‰firstTaskä»»åŠ¡</code>çš„çº¿ç¨‹ã€‚</p>
</li>
<li>
<p><code>æ²¡æœ‰firstTaskä»»åŠ¡</code>çš„ååŠ©çº¿ç¨‹ï¼š</p>
</li>
</ol>
<p>â€‹     â‘  çº¿ç¨‹æ± <code>å¤„äºSHUTDOWNæœŸé—´ï¼ŒååŠ©å¿«é€Ÿå¤„ç†é˜»å¡é˜Ÿåˆ—ä»»åŠ¡</code>çš„çº¿ç¨‹ã€‚</p>
<p>â€‹     â‘¡ çº¿ç¨‹æ± ä¸­<code>æ²¡æœ‰å›ºå®šçº¿ç¨‹(å³corePoolSize=0)</code>ï¼Œä½†æ­¤æ—¶æœ‰ä»»åŠ¡éœ€è¦æ‰§è¡Œçš„æƒ…å†µã€‚</p>
</blockquote>
<hr>
<h3 id="çº¿ç¨‹æ± æ‰§è¡Œä»»åŠ¡">çº¿ç¨‹æ± æ‰§è¡Œä»»åŠ¡</h3>
<h4 id="runworker">runWorker</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// å› ä¸ºworkerå¯¹è±¡æœ¬èº«å°±æ˜¯å®ç°äº†Runnableæ¥å£ï¼Œæ‰€ä»¥çº¿ç¨‹å¯åŠ¨æ—¶è°ƒç”¨runæ–¹æ³•
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    runWorker<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
<span style="color:#75715e">// Worker unlockçš„æ ¸å¿ƒæ–¹æ³•
</span><span style="color:#75715e"></span><span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">tryRelease</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> unused<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// ä¸ä¼šåˆ¤æ–­æ˜¯ä½ æ˜¯å¦æ˜¯æŒæœ‰ç‹¬å é”çš„çº¿ç¨‹
</span><span style="color:#75715e"></span>    setExclusiveOwnerThread<span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
    setState<span style="color:#f92672">(</span>0<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">final</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">runWorker</span><span style="color:#f92672">(</span>Worker w<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// è·å–å½“å‰çº¿ç¨‹ï¼Œå³æ‰§è¡Œè¯¥ä»»åŠ¡çš„çº¿ç¨‹
</span><span style="color:#75715e"></span>    Thread wt <span style="color:#f92672">=</span> Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">currentThread</span><span style="color:#f92672">();</span>
    <span style="color:#75715e">// è·å–ä»»åŠ¡
</span><span style="color:#75715e"></span>    Runnable task <span style="color:#f92672">=</span> w<span style="color:#f92672">.</span><span style="color:#a6e22e">firstTask</span><span style="color:#f92672">;</span>
    <span style="color:#75715e">// å°†firstTaskå±æ€§è®¾ä¸ºnull
</span><span style="color:#75715e"></span>    w<span style="color:#f92672">.</span><span style="color:#a6e22e">firstTask</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
    <span style="color:#75715e">// unlockä¼šå°†stateè®¾ä¸º0ï¼Œä¸ºä»€ä¹ˆè¿™é‡Œè¿™æ ·ï¼Ÿ
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// å› ä¸ºåˆå§‹åŒ–workerå¯¹è±¡çš„æ—¶å€™ä¼šå°†stateè®¾ä¸º-1ï¼Œé˜²æ­¢çº¿ç¨‹æ± çš„ä¸­æ–­æ–¹æ³•ä¸­æ–­åˆšåˆ›å»ºçš„worker
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// é™¤æ­¤ä¹‹å¤–è¿˜ä¸ºäº†ä¸‹é¢çš„w.lockï¼Œèƒ½å¤Ÿæ­£å¸¸çš„è·å–ç‹¬å é”ï¼Œä¹Ÿæ–¹ä¾¿äº†shutDownæ–¹æ³•ä¸­
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// åˆ¤æ–­çº¿ç¨‹æ˜¯å¦ç©ºé—²çš„tryLockçš„æ­£ç¡®æ‰§è¡Œ
</span><span style="color:#75715e"></span>    w<span style="color:#f92672">.</span><span style="color:#a6e22e">unlock</span><span style="color:#f92672">();</span>
    <span style="color:#66d9ef">boolean</span> completedAbruptly <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// å¦‚æœtask != nullè¯´æ˜å½“å‰çº¿ç¨‹æœ‰ä»»åŠ¡çš„
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// å¦‚æœtask = nullè¯´æ˜æ˜¯ååŠ©çº¿ç¨‹ï¼Œéœ€è¦å»é˜»å¡é˜Ÿåˆ—æ‹¿ä»»åŠ¡
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>task <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> <span style="color:#f92672">(</span>task <span style="color:#f92672">=</span> getTask<span style="color:#f92672">())</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// è‡³æ­¤è‚¯å®šæ‹¿åˆ°äº†ä»»åŠ¡
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// ä¸ºä»€ä¹ˆæ­¤å¤„è¦è·å–é”ï¼Œworkerç‹¬å é”åªä¼šè¢«å½“å‰ä¸€ä¸ªçº¿ç¨‹æŒæœ‰å•Šï¼Ÿ
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// 1. shutDownæ–¹æ³•ä¸­è°ƒç”¨çš„ä¸­æ–­æ–¹æ³•ä¼šé€šè¿‡tryLockåˆ¤æ–­çº¿ç¨‹æ˜¯å¦ç©ºé—²
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// 2. é¿å…workerçº¿ç¨‹è¢«ä¸­æ–­ï¼Œworkerå®ç°äº†ç‹¬å é”å¤§éƒ¨åˆ†åŠŸèƒ½ï¼Œä¸åŠæ—¶å“åº”ä¸­æ–­
</span><span style="color:#75715e"></span>            w<span style="color:#f92672">.</span><span style="color:#a6e22e">lock</span><span style="color:#f92672">();</span>
            <span style="color:#75715e">// å¦‚æœçº¿ç¨‹æ± æ­£åœ¨ç»ˆæ­¢ï¼Œé‚£ä¹ˆä¸­æ–­å½“å‰çº¿ç¨‹ï¼Œå¦‚æœä¸æ˜¯ï¼Œé‚£ä¹ˆä¸è®©çº¿ç¨‹è¢«ä¸­æ–­
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>runStateAtLeast<span style="color:#f92672">(</span>ctl<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(),</span> STOP<span style="color:#f92672">)</span> <span style="color:#f92672">||</span>
                 <span style="color:#f92672">(</span>Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">interrupted</span><span style="color:#f92672">()</span> <span style="color:#f92672">&amp;&amp;</span>
                  runStateAtLeast<span style="color:#f92672">(</span>ctl<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(),</span> STOP<span style="color:#f92672">)))</span> <span style="color:#f92672">&amp;&amp;</span>
                <span style="color:#f92672">!</span>wt<span style="color:#f92672">.</span><span style="color:#a6e22e">isInterrupted</span><span style="color:#f92672">())</span>
                wt<span style="color:#f92672">.</span><span style="color:#a6e22e">interrupt</span><span style="color:#f92672">();</span>
            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// é’©å­å‡½æ•°ï¼Œç”¨äºè‡ªå®šä¹‰ä»»åŠ¡æ‰§è¡Œå‰è°ƒç”¨
</span><span style="color:#75715e"></span>                beforeExecute<span style="color:#f92672">(</span>wt<span style="color:#f92672">,</span> task<span style="color:#f92672">);</span>
                Throwable thrown <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
                <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                    <span style="color:#75715e">// è¿™é‡Œç”¨æˆ·ä¼ å…¥çš„ä»»åŠ¡æ‰çœŸæ­£è¢«æ‰§è¡Œ
</span><span style="color:#75715e"></span>                    task<span style="color:#f92672">.</span><span style="color:#a6e22e">run</span><span style="color:#f92672">();</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>RuntimeException x<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    thrown <span style="color:#f92672">=</span> x<span style="color:#f92672">;</span> <span style="color:#66d9ef">throw</span> x<span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Error x<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    thrown <span style="color:#f92672">=</span> x<span style="color:#f92672">;</span> <span style="color:#66d9ef">throw</span> x<span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Throwable x<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    thrown <span style="color:#f92672">=</span> x<span style="color:#f92672">;</span> <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error<span style="color:#f92672">(</span>x<span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
                    <span style="color:#75715e">// é’©å­å‡½æ•°ï¼Œä»»åŠ¡æ‰§è¡Œåè°ƒç”¨
</span><span style="color:#75715e"></span>                    afterExecute<span style="color:#f92672">(</span>task<span style="color:#f92672">,</span> thrown<span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// æ¸…ç©ºtask
</span><span style="color:#75715e"></span>                task <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
                <span style="color:#75715e">// å°†completeTask + 1
</span><span style="color:#75715e"></span>                w<span style="color:#f92672">.</span><span style="color:#a6e22e">completedTasks</span><span style="color:#f92672">++;</span>
                w<span style="color:#f92672">.</span><span style="color:#a6e22e">unlock</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
        <span style="color:#75715e">// ä¿®æ”¹completedAbruptlyå‚æ•°ã€‚å¦‚æœä¸ºtrueè¯´æ˜æ˜¯å¼‚å¸¸ç»“æŸçš„
</span><span style="color:#75715e"></span>        completedAbruptly <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// å¤„ç†workerçš„é€€å‡º
</span><span style="color:#75715e"></span>        processWorkerExit<span style="color:#f92672">(</span>w<span style="color:#f92672">,</span> completedAbruptly<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<ol>
<li><code>runWorker</code>æ–¹æ³•ä¼šåˆ¤æ–­<code>firstTask != null</code>æ˜¯å¦æˆç«‹ï¼Œå¦‚æœä¸æˆç«‹å†å»<code>é˜»å¡é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡</code>ã€‚</li>
<li><code>w.lock()</code>åçš„ç¬¬ä¸€å¤„åˆ¤æ–­ï¼Œä¸»è¦ç›®çš„ï¼š<code>å¦‚æœçº¿ç¨‹æ± æ­£åœ¨ä¸­æ–­ï¼Œé‚£ä¹ˆä¸­æ–­å½“å‰çº¿ç¨‹ã€‚å¦‚æœä¸æ˜¯ï¼Œé‚£ä¹ˆä¸è®©å½“å‰çº¿ç¨‹è¢«ä¸­æ–­</code>ï¼ˆ<code>w.lock</code>å<code>state=1</code>ï¼Œæ‰€ä»¥æ˜¯èƒ½è¢«<code>shutDownNow</code>ä¸­çš„ä¸­æ–­æ–¹æ³•ä¸­æ–­çš„ï¼‰ã€‚</li>
<li>è°ƒç”¨<code>beforeExecute</code>é’©å­å‡½æ•°ï¼Œæ­¤æ—¶æ‰çœŸæ­£çš„æ‰§è¡Œç”¨æˆ·ä¼ å…¥çš„ä»»åŠ¡ã€‚</li>
<li>æ‰§è¡Œ<code>afterExecute</code>é’©å­å‡½æ•°ï¼Œæ¸…ç©ºtaskï¼Œå°†<code>workrer.completedTasks+1</code></li>
<li>å¦‚æœ<code>getTaskè¿”å›null</code>æˆ–<code>æ‰§è¡Œä»»åŠ¡å‘ç”Ÿå¼‚å¸¸</code>ï¼Œæœ€ç»ˆè°ƒç”¨<code>processWorkerExit</code>æ–¹æ³•ã€‚</li>
</ol>
</blockquote>
<h4 id="gettask">getTask</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// ä»é˜»å¡é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> Runnable <span style="color:#a6e22e">getTask</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// ç”¨äºåˆ¤æ–­ä¸Šæ¬¡pollæ˜¯å¦è¶…æ—¶
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">boolean</span> timedOut <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
	<span style="color:#75715e">// è‡ªæ—‹æ‰§è¡Œ
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(;;)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// è·å–ctlçŠ¶æ€
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">int</span> c <span style="color:#f92672">=</span> ctl<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">();</span>
        <span style="color:#75715e">// è·å–è¿è¡ŒçŠ¶æ€
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">int</span> rs <span style="color:#f92672">=</span> runStateOf<span style="color:#f92672">(</span>c<span style="color:#f92672">);</span>
        <span style="color:#75715e">// å¦‚æœçº¿ç¨‹æ± æ­£åœ¨shutdown æˆ– é˜Ÿåˆ—å·²ç©ºï¼Œé‚£ä¹ˆå°†workerCount-1å¹¶è¿”å›null
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>rs <span style="color:#f92672">&gt;=</span> SHUTDOWN <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">(</span>rs <span style="color:#f92672">&gt;=</span> STOP <span style="color:#f92672">||</span> workQueue<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">()))</span> <span style="color:#f92672">{</span>
            decrementWorkerCount<span style="color:#f92672">();</span>
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
		<span style="color:#75715e">// è·å–workerCount
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">int</span> wc <span style="color:#f92672">=</span> workerCountOf<span style="color:#f92672">(</span>c<span style="color:#f92672">);</span>
        <span style="color:#75715e">// allowCoreThreadTimeOutè¡¨ç¤ºæ ¸å¿ƒæ•°é‡çš„çº¿ç¨‹ä¸å…è®¸è¶…æ—¶ï¼Œé»˜è®¤false
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// wc &gt; corePoolSizeæ—¶è¿”å›true
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">boolean</span> timed <span style="color:#f92672">=</span> allowCoreThreadTimeOut <span style="color:#f92672">||</span> wc <span style="color:#f92672">&gt;</span> corePoolSize<span style="color:#f92672">;</span>
		<span style="color:#75715e">// å› ä¸ºsetMaximumPoolSizeï¼Œæ‰€ä»¥wc &gt; maxä¼šå‡ºç°
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// 1. å¦‚æœwcè¶…è¿‡max æˆ– (wcå¤§äºcorePoolSizeä¸”ä¸Šæ¬¡pollè¶…æ—¶äº†)
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>wc <span style="color:#f92672">&gt;</span> maximumPoolSize <span style="color:#f92672">||</span> <span style="color:#f92672">(</span>timed <span style="color:#f92672">&amp;&amp;</span> timedOut<span style="color:#f92672">))</span>
            <span style="color:#75715e">// å¦‚æœwc&gt;1æˆ–é˜Ÿåˆ—ä¸ºç©ºï¼Œä¸€ç›´å‡å°‘wcç›´åˆ°1
</span><span style="color:#75715e"></span>            <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">(</span>wc <span style="color:#f92672">&gt;</span> 1 <span style="color:#f92672">||</span> workQueue<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">()))</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>compareAndDecrementWorkerCount<span style="color:#f92672">(</span>c<span style="color:#f92672">))</span>
                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">continue</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// å¦‚æœæ˜¯trueè°ƒç”¨pollé˜»å¡ï¼Œå¦åˆ™è°ƒç”¨takeé˜»å¡è·å–
</span><span style="color:#75715e"></span>            Runnable r <span style="color:#f92672">=</span> timed <span style="color:#f92672">?</span>
                workQueue<span style="color:#f92672">.</span><span style="color:#a6e22e">poll</span><span style="color:#f92672">(</span>keepAliveTime<span style="color:#f92672">,</span> TimeUnit<span style="color:#f92672">.</span><span style="color:#a6e22e">NANOSECONDS</span><span style="color:#f92672">)</span> <span style="color:#f92672">:</span>
            workQueue<span style="color:#f92672">.</span><span style="color:#a6e22e">take</span><span style="color:#f92672">();</span>
            <span style="color:#75715e">// ä¸ä¸ºnullè¿”å›
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>r <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
                <span style="color:#66d9ef">return</span> r<span style="color:#f92672">;</span>
            <span style="color:#75715e">// ä¸ºnullè®¾ç½®timeOutç»§ç»­å¾ªç¯ï¼Œä¹Ÿå°±æ˜¯workerä¸€ç›´åœ¨è·å–ä»»åŠ¡
</span><span style="color:#75715e"></span>            timedOut <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>InterruptedException retry<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// å¦‚æœgetTaskè¿‡ç¨‹ä¸­è¢«ä¸­æ–­äº†ï¼Œç»§ç»­å¾ªç¯
</span><span style="color:#75715e"></span>            timedOut <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<ol>
<li>ç¬¬ä¸€ä¸ªåˆ¤æ–­ï¼šå¦‚æœçº¿ç¨‹æ± çŠ¶æ€å˜æˆ<code>SHUTDOWNæˆ–é˜Ÿåˆ—å·²ç©º</code>ï¼Œé‚£ä¹ˆå°†<code>workerCountå‡1å¹¶è¿”å›null</code>ã€‚</li>
<li><code>allowCoreThreadTimeOut</code>å‚æ•°è¡¨æ˜<code>corePoolSizeæŒ‡å®šæ•°é‡çš„æ ¸å¿ƒçº¿ç¨‹èƒ½å¦è¶…æ—¶ï¼Œé»˜è®¤ä¸ºfalse</code>ã€‚</li>
<li>ç¬¬äºŒä¸ªåˆ¤æ–­ï¼šå¦‚æœ â‘ <code>wcè¶…è¿‡maxPoolSize</code>æˆ–<code>(wc &gt; corePoolSize ä¸” ä¸Šæ¬¡pollè¶…æ—¶)</code>ï¼Œé‚£ä¹ˆç»§ç»­åˆ¤æ–­ã€‚ â‘¡<code>wc &gt; 1æˆ– é˜»å¡é˜Ÿåˆ—ä¸ºç©º</code>ï¼Œè‹¥ä¸¤è€…éƒ½æˆç«‹ï¼Œé‚£ä¹ˆä¼šå°†wcå‡1ï¼Œå¤šæ¬¡å¾ªç¯åå¯èƒ½<code>wc=1</code>ã€‚</li>
<li>æ ¹æ®<code>wc &gt; corePoolSize</code>è¿”å›<code>true/false</code>æ¥å†³å®šè°ƒç”¨çš„æ˜¯<code>poll(time)/take()</code>ï¼Œå‰è€…é˜»å¡<code>keepAliveTime</code>ï¼Œåè€…<code>ä¸€ç›´é˜»å¡ç›´åˆ°è·å–äº†ä»»åŠ¡</code>ã€‚æœ€ç»ˆä¸€å®šä¼šæœ‰<code>å°äºç­‰äºcorePoolSizeæ•°é‡çš„çº¿ç¨‹</code>ä¸€ç›´åœ¨takeå¤„é˜»å¡ç­‰å¾…ä»»åŠ¡ã€‚</li>
<li>å¦‚æœ<code>è·å–çš„ä»»åŠ¡!=null</code>åˆ™è¿”å›ï¼Œå¦åˆ™è®¾ç½®<code>timeOut=true</code>ã€‚å‘ç”Ÿå¼‚å¸¸åˆ™è®¾ç½®<code>timeOut=false</code>ã€‚</li>
</ol>
</blockquote>
<h4 id="processworkerexit">processWorkerExit</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// completedAbruptly =trueè¡¨æ˜runWorkeræ˜¯å¼‚å¸¸é€€å‡ºçš„
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">processWorkerExit</span><span style="color:#f92672">(</span>Worker w<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> completedAbruptly<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// å¦‚æœå¼‚å¸¸é€€å‡ºï¼Œé‚£ä¹ˆå°†workerCountå‡1
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>completedAbruptly<span style="color:#f92672">)</span>
        decrementWorkerCount<span style="color:#f92672">();</span>
    <span style="color:#66d9ef">final</span> ReentrantLock mainLock <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mainLock</span><span style="color:#f92672">;</span>
    <span style="color:#75715e">// è·å–ç‹¬å é”
</span><span style="color:#75715e"></span>    mainLock<span style="color:#f92672">.</span><span style="color:#a6e22e">lock</span><span style="color:#f92672">();</span>
    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// å°†æˆå‘˜å˜é‡completedTaskCountåŠ ä¸Šworkerå¤„ç†çš„çº¿ç¨‹æ•°é‡
</span><span style="color:#75715e"></span>        completedTaskCount <span style="color:#f92672">+=</span> w<span style="color:#f92672">.</span><span style="color:#a6e22e">completedTasks</span><span style="color:#f92672">;</span>
        <span style="color:#75715e">// ä»çº¿ç¨‹æ± ä¸­ç§»é™¤è¯¥worker
</span><span style="color:#75715e"></span>        workers<span style="color:#f92672">.</span><span style="color:#a6e22e">remove</span><span style="color:#f92672">(</span>w<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
        mainLock<span style="color:#f92672">.</span><span style="color:#a6e22e">unlock</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
	<span style="color:#75715e">// ç§»é™¤workeråå¿…é¡»è°ƒç”¨çš„æ–¹æ³•
</span><span style="color:#75715e"></span>    tryTerminate<span style="color:#f92672">();</span>
	<span style="color:#75715e">// è·å–ctl
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> c <span style="color:#f92672">=</span> ctl<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">();</span>
    <span style="color:#75715e">// åˆ¤æ–­çŠ¶æ€æ˜¯å¦å°äºSTOPï¼Œå³ä½¿æ˜¯SHUTDOWNçŠ¶æ€ï¼Œä¹Ÿéœ€è¦å°†é˜Ÿåˆ—ä¸­ä»»åŠ¡å…¨éƒ¨æ‰§è¡Œå®Œæˆæ‰è¡Œ
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// æ‰€ä»¥éœ€è¦ä¿æŒ&gt;=corePoolSizeæ•°é‡çš„worker
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>runStateLessThan<span style="color:#f92672">(</span>c<span style="color:#f92672">,</span> STOP<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// workeréå¼‚å¸¸é€€å‡º
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>completedAbruptly<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// åˆ¤æ–­ä¿ç•™corePoolSizeæ•°é‡çš„çº¿ç¨‹æ˜¯å¦è¶…æ—¶
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">int</span> min <span style="color:#f92672">=</span> allowCoreThreadTimeOut <span style="color:#f92672">?</span> 0 <span style="color:#f92672">:</span> corePoolSize<span style="color:#f92672">;</span>
            <span style="color:#75715e">// å¦‚æœmin=0,ä½†é˜»å¡é˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œè‡³å°‘ä¿ç•™ä¸€ä¸ªworker
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>min <span style="color:#f92672">==</span> 0 <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span> workQueue<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">())</span>
                min <span style="color:#f92672">=</span> 1<span style="color:#f92672">;</span>
            <span style="color:#75715e">// å¦‚æœmin!=0,ä¸”workerCount &gt;= minç›´æ¥é€€å‡º
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>workerCountOf<span style="color:#f92672">(</span>c<span style="color:#f92672">)</span> <span style="color:#f92672">&gt;=</span> min<span style="color:#f92672">)</span>
                <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span> <span style="color:#75715e">// replacement not needed
</span><span style="color:#75715e"></span>        <span style="color:#f92672">}</span>
        <span style="color:#75715e">// å¦‚æœæ˜¯å¼‚å¸¸é€€å‡ºï¼Œç›´æ¥addWorker
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// å¦‚æœworkerCount&lt; minï¼Œå¢åŠ ä¸€ä¸ªnull taskçš„worker
</span><span style="color:#75715e"></span>        addWorker<span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<p>ä½•æ—¶è°ƒç”¨æ­¤æ–¹æ³•å¤„ç†workerçš„é€€å‡ºï¼Ÿ</p>
<p>â‘  æ‰§è¡Œ<code>runWorker</code>æ–¹æ³•æ—¶å‘ç”Ÿäº†å¼‚å¸¸ã€‚</p>
<p>â‘¡ <code>getTaskæ–¹æ³•è¿”å›null</code>æ—¶ä¼šè°ƒç”¨ã€‚</p>
<ol>
<li>
<p>å¦‚æœ<code>completedAbruptly=true</code>è¯´æ˜<code>runWorker</code>å¼‚å¸¸é€€å‡ºï¼Œå°†<code>workerCount-1</code>.</p>
</li>
<li>
<p>è·å–ç‹¬å é”ï¼Œå°†workeræ‰§è¡Œçš„ä»»åŠ¡æ•°ä¼ é€’ç»™çº¿ç¨‹æ± <code>completedTaskCount</code>å¹¶ç§»é™¤è¯¥workerã€‚</p>
</li>
<li>
<p>å¦‚æœ<code>rs &lt; STOP</code>æ—¶ï¼š</p>
<p>â‘  å½“å‰workeræ­£å¸¸é€€å‡ºçš„ï¼Œå¦‚æœ<code>allowCoreThreadTimeOut=true</code>ä¸”<code>é˜Ÿåˆ—ä¸ä¸ºç©º</code>ï¼Œé‚£ä¹ˆè‡³å°‘ä¿ç•™ä¸€ä¸ªworkerã€‚å¦‚æœ<code>allowCoreThreadTimeOut=false</code>ï¼Œé‚£ä¹ˆä»…åœ¨<code>workerCount &lt; corePoolSize</code>æ—¶å¢åŠ ä¸€ä¸ªworkerã€‚</p>
<p>â‘¡ å¦‚æœå½“å‰workeréæ­£å¸¸é€€å‡ºçš„ï¼Œç›´æ¥æ·»åŠ ä¸€ä¸ªworkerã€‚</p>
</li>
</ol>
</blockquote>
<hr>
<h3 id="çº¿ç¨‹æ± æ‹’ç»ç­–ç•¥">çº¿ç¨‹æ± æ‹’ç»ç­–ç•¥</h3>
<table>
<thead>
<tr>
<th>ç­–ç•¥</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody>
<tr>
<td>AbortPolicy</td>
<td>ç›´æ¥æŠ›å‡ºä¸€ä¸ªRejectedExecutionExceptionå¼‚å¸¸</td>
</tr>
<tr>
<td>CallerRunsPolicy</td>
<td>ç›´æ¥ç”±è°ƒç”¨è€…æ‰§è¡Œè¯¥ä»»åŠ¡ï¼Œå¦‚æœçº¿ç¨‹æ± å…³é—­ï¼Œè¯¥ä»»åŠ¡ä¼šè¢«ä¸¢å¼ƒ</td>
</tr>
<tr>
<td>DiscardPolicy</td>
<td>ä¸åšå¤„ç†ï¼Œå°†è¯¥ä»»åŠ¡ç›´æ¥ä¸¢å¼ƒ</td>
</tr>
<tr>
<td>DiscardOldestPolicy</td>
<td>ä¸¢å¼ƒé˜Ÿåˆ—ä¸­æœ€è€çš„ä»»åŠ¡å¹¶é‡è¯•è¯¥ä»»åŠ¡ï¼Œå¦‚æœçº¿ç¨‹æ± å…³é—­ï¼Œè¯¥ä»»åŠ¡ä¼šè¢«ä¸¢å¼ƒ</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="çº¿ç¨‹æ± æ‰§è¡Œç¤ºæ„å›¾">çº¿ç¨‹æ± æ‰§è¡Œç¤ºæ„å›¾</h3>
<p><img src="https://image.leejay.top/image/20200716/sMWBHgaW5lsx.png?imageslim" alt=""></p>
<hr>
<h3 id="çº¿ç¨‹æ± é—®é¢˜æ±‡æ€»">çº¿ç¨‹æ± é—®é¢˜æ±‡æ€»</h3>
<ul>
<li>ä¸ºä»€ä¹ˆWorkerç±»é€‰æ‹©ç»§æ‰¿äº†AQSè€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨ThreadPoolExecutorçš„ReentrentLockï¼Ÿ</li>
</ul>
<blockquote>
<p>æºç æ³¨é‡Šï¼šDoug leaå¸Œæœ›å®ç°çš„æ˜¯<code>éå¯é‡å…¥çš„äº’æ–¥é”</code>ï¼Œä¸å¸Œæœ›workeråœ¨è°ƒç”¨ç±»ä¼¼<code>setCorePoolSize</code>ä¹‹ç±»çš„çº¿ç¨‹æ± æ§åˆ¶æ–¹æ³•æ—¶èƒ½å¤Ÿé‡æ–°è·å–è¯¥é”ã€‚</p>
<p>å› ä¸º<code>éœ€è¦ç¬¦åˆä¸€å®šçš„æ¡ä»¶æ‰èƒ½ä¸­æ–­workerçº¿ç¨‹</code>ï¼Œè¿™ä¸ªæ¡ä»¶æ˜¯é€šè¿‡è®¾ç½®<code>state=-1</code>æ¥å®ç°ã€‚è€ŒThreadPoolExecutorä¸­çš„<code>ReentrantLock</code>ä¸èƒ½å®ç°è¿™ä¸ªéœ€æ±‚ï¼Œæ‰€ä»¥éœ€è¦é¢å¤–ç»§æ‰¿AQSã€‚</p>
<p><code>setCorePoolSize-&gt; interruptIdleWorkers()-&gt; interruptIdleWorkers(false)-&gt; tryLock()</code></p>
</blockquote>
<ul>
<li>ä¸ºä»€ä¹ˆåˆå§‹åŒ–Workerå¯¹è±¡æ—¶ä¼šå°†stateè®¾ä¸º-1ï¼Ÿ</li>
</ul>
<blockquote>
<p>Workerå¯¹è±¡åœ¨åˆå§‹åŒ–çš„æ—¶å€™ä¼šå°†<code>state = -1</code>ï¼Œ<code>é˜²æ­¢workeråœ¨åˆšåˆå§‹åŒ–åè¿˜æ²¡æœ‰æ‰§è¡Œä»»åŠ¡å°±è¢«ä¸­æ–­</code>ã€‚å› ä¸º<code>shutDownå’ŒshutDownNow</code>æ–¹æ³•ä¸­éƒ½æœ‰ä¸­æ–­çº¿ç¨‹çš„æ–¹æ³•ï¼Œåªæ˜¯é€»è¾‘ä¸åŒè€Œå·²ï¼Œå‰è€…æ˜¯é€šè¿‡<code>tryLock</code>æ¥ä¸­æ–­ç©ºé—²çº¿ç¨‹(<code>åªæœ‰state=0æ—¶æ‰ä¼šæˆåŠŸ</code>)ï¼Œåè€…æ˜¯é€šè¿‡<code>state &gt;= 0å°†å·²åˆå§‹åŒ–è¿˜æœªæ‰§è¡Œ</code>çš„workeræ’é™¤åœ¨å¤–ã€‚</p>
</blockquote>
<ul>
<li>ä¸ºä»€ä¹ˆrunWorkeræ–¹æ³•ä¸­ä¼šå…ˆè°ƒç”¨unlockå†è°ƒç”¨lockæ–¹æ³•ï¼Ÿ</li>
</ul>
<blockquote>
<p><code>worker.unlock</code>æ–¹æ³•çš„æ ¸å¿ƒåœ¨äº<code>tryRelease</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•è®¾ç½®<code>state = 0</code>åï¼Œlockæ–¹æ³•æ‰æœ‰å¯èƒ½æ‰§è¡ŒæˆåŠŸï¼Œ<code>å¦åˆ™æ°¸è¿œæ— æ³•è·å–é”</code>ã€‚é™¤æ­¤ä¹‹å¤–è¿˜æœ‰æ§åˆ¶ä¸­æ–­çš„ä½œç”¨ï¼š</p>
<ol>
<li><code>å½“å‰workerå¯ä»¥è¢«åç»­shutDownNowä¸­æ–­æ“ä½œæ‰€ä¸­æ–­</code>ã€‚</li>
<li><code>è®©åç»­è°ƒç”¨shutDownæ“ä½œçš„çº¿ç¨‹é€šè¿‡tryLockåˆ¤æ–­workeræ˜¯å¦ç©ºé—²</code>ã€‚</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">tryAcquire</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> unused<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// å¦‚æœæ˜¯state=-1ï¼ŒCASæ°¸è¿œä¸ä¼šæˆåŠŸ
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>compareAndSetState<span style="color:#f92672">(</span>0<span style="color:#f92672">,</span> 1<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        setExclusiveOwnerThread<span style="color:#f92672">(</span>Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">currentThread</span><span style="color:#f92672">());</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div></blockquote>
<ul>
<li>çº¿ç¨‹æ± ä¸ºä½•èƒ½å¤ŸæŒæœ‰çº¿ç¨‹ä¸é‡Šæ”¾ï¼Œåœ¨æœ‰ä»»åŠ¡çš„æ—¶å€™ç«‹å³æ‰§è¡Œï¼Ÿ</li>
</ul>
<blockquote>
<p>æ ¸å¿ƒåœ¨äº<code>getTask</code>æ–¹æ³•ä¸­ï¼Œ<code>æ ¸å¿ƒçº¿ç¨‹</code>ä¼šæ‰§è¡Œ<code>take()</code>æ–¹æ³•é˜»å¡ç›´åˆ°ä»»åŠ¡åˆ°æ¥ï¼Œ<code>éæ ¸å¿ƒçº¿ç¨‹</code>ä¼šæ‰§è¡Œ<code>poll()é˜»å¡keepAliveTimeåè¶…æ—¶</code>ï¼Œ<code>getTask</code>è¿”å›nullï¼Œæœ€ç»ˆè°ƒç”¨<code>processWorkerExit</code>è®©å½“å‰workeræ¨å‡ºã€‚</p>
</blockquote>
<ul>
<li>çº¿ç¨‹æ± corePoolSizeè¯¥å¦‚ä½•è®¾ç½®ï¼Ÿ</li>
</ul>
<blockquote>
<p>corePoolSizeç”¨äºè®¾ç½®<code>æŒ‡å®šæ•°é‡çš„æ ¸å¿ƒçº¿ç¨‹</code>ï¼Œè¿™äº›çº¿ç¨‹æ˜¯å³ä½¿<code>é—²ç½®å’Œè¶…æ—¶ä¹Ÿä¸ä¼šè¢«å›æ”¶çš„</code>ã€‚</p>
<p>corePoolSizeçš„è®¾ç½®åŸºäºä»¥ä¸‹å…¬å¼ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">NThreads <span style="color:#f92672">=</span> NCPUS <span style="color:#f92672">*</span> UCPU <span style="color:#f92672">*</span> <span style="color:#f92672">(</span>1 <span style="color:#f92672">+</span> W<span style="color:#f92672">/</span>C<span style="color:#f92672">)</span>
NThreads<span style="color:#960050;background-color:#1e0010">ï¼š</span>çº¿ç¨‹æ•°é‡
NCpus<span style="color:#960050;background-color:#1e0010">ï¼š</span>cpuæ ¸æ•°<span style="color:#f92672">(</span>Runtime<span style="color:#f92672">.</span><span style="color:#a6e22e">getRuntime</span><span style="color:#f92672">().</span><span style="color:#a6e22e">availableProcessors</span><span style="color:#f92672">()</span>å¯è®¡ç®—<span style="color:#f92672">)</span>
UCpus: cpuä½¿ç”¨ç‡<span style="color:#f92672">(</span>0<span style="color:#f92672">~</span>1<span style="color:#f92672">)</span>
W<span style="color:#f92672">/</span>C<span style="color:#960050;background-color:#1e0010">ï¼š</span> wait time<span style="color:#f92672">/</span>compute time  Cpuè¿è¡Œç±»å‹åˆ†ä¸ºI<span style="color:#f92672">/</span>Oå¯†é›†å‹<span style="color:#f92672">(</span>W<span style="color:#f92672">)</span>å’Œè®¡ç®—å¯†é›†å‹<span style="color:#f92672">(</span>C<span style="color:#f92672">)</span>    
</code></pre></div><blockquote>
<p>å‡è®¾ï¼šCPUä½¿ç”¨ç‡æ˜¯100%ï¼Œé‚£ä¹ˆå…¬å¼å¯ä»¥å˜æˆï¼š<code>NThreads = NCpus * (1 + W/C)</code></p>
<ol>
<li>å¦‚æœæ˜¯<code>I/Oå¯†é›†å‹(æ•°æ®åº“äº¤äº’ã€æ–‡ä»¶ä¸Šä¼ ä¸‹è½½ã€ç½‘ç»œæ•°æ®ä¼ è¾“ç­‰)</code>ï¼ŒWè¶Šå¤§ï¼Œé‚£ä¹ˆ W/C &gt; 1ï¼Œ NThreads &gt;= 2 * NCpusã€‚</li>
<li>å¦‚æœæ˜¯<code>è®¡ç®—å¯†é›†å‹(å¤æ‚ç®—æ³•ä¹‹ç±»çš„)</code>ï¼ŒW æ¥è¿‘äº0ï¼ŒNThreads &gt;= NCpusï¼Œæ¨èNCpus+1ï¼Œè¿™æ ·å³ä½¿<code>å½“è®¡ç®—å¯†é›†å‹çº¿ç¨‹å¶å°”ç”±äºç¼ºå¤±æ•…éšœæˆ–è€…å…¶ä»–åŸå› çº¿ç¨‹æš‚åœï¼Œè¿™ä¸ªé¢å¤–çš„çº¿ç¨‹ä¹Ÿèƒ½ç¡®ä¿CPUæ—¶é’Ÿå‘¨æœŸä¸è¢«æµªè´¹</code>ï¼Œ è‡³äºå¤šä¸€ä¸ªcpuä¸Šä¸‹æ–‡åˆ‡æ¢æ˜¯å¦å€¼å¾—ï¼Œå…·ä½“é¡¹ç›®å…·ä½“æµ‹è¯•ã€‚</li>
</ol>
<p>æ¨èï¼š<code> I/Oå¯†é›†å‹ï¼š NThread = 2NCpuã€‚ è®¡ç®—å¯†é›†å‹ NThread = NCpus + 1</code>ã€‚</p>
</blockquote>
</blockquote>

    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h">å…¶ä»–æ–‡ç« </span>
            <hr />
          </div>
          <div class="pagination__buttons">
            
              <span class="button previous">
                <a href="https://leejay.top/post/future/">
                  <span class="button__icon">â†</span>
                  <span class="button__text">Future</span>
                </a>
              </span>
            
            
              <span class="button next">
                <a href="https://leejay.top/post/concurrenthashmap/">
                  <span class="button__text">ConcurrentHashMap</span>
                  <span class="button__icon">â†’</span>
                </a>
              </span>
            
          </div>
        </div>
      
    


    
      
        

      
    

    </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright copyright--user">è‹ICPå¤‡18050258å·-1</div>
    
  </div>
</footer>

<script src="https://leejay.top/assets/main.js"></script>
<script src="https://leejay.top/assets/prism.js"></script>
<script type="text/javascript"
src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    showProcessingMessages: false, //å…³é—­jsåŠ è½½è¿‡ç¨‹ä¿¡æ¯
    messageStyle: "none", //ä¸æ˜¾ç¤ºä¿¡æ¯
    extensions: ["tex2jax.js"],
    jax: ["input/TeX", "output/HTML-CSS"],
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre','code', 'a', 'annotation', 'annotation-xml'],
      ignoreClass: 'crayon-.*' // 'crayon-' å¼€å¤´çš„ç±»ï¼Œå±äºWordpressä»£ç é«˜äº®åº“ï¼Œè¿™éƒ¨åˆ†ä¸éœ€è¦å¤„ç†ï¼Œå¦åˆ™ä¼šå¯¼è‡´æ˜¾ç¤ºä¸æ­£ç¡®,è¿™éƒ¨åˆ†æ˜¯æ­£åˆ™å¼ï¼Œå¤šæ¡ä¹‹é—´ç”¨'|'åˆ†å‰²    
    },
    'HTML-CSS': {
        showMathMenu: false //ç¦ç”¨å³é”®èœå•
    }
  });
</script>


      
    </div>

    
  </body>
</html>
