<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>CAS :: é»„æ˜ç°ç™½éª¨ â€” Just a normal blog</title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="description" content="åˆ¤æ–­æ•°æ®æ˜¯å¦è¢«ä¿®æ”¹ï¼ŒåŒæ—¶å†™å›æ–°å€¼ï¼Œè¿™ä¸¤ä¸ªæ“ä½œè¦åˆæˆä¸€ä¸ªåŸå­æ“ä½œï¼Œè¿™å°±æ˜¯CAS(compare and swap)ã€‚
ä¹‹å‰å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œæˆ‘ä»¬å¯¹å˜é‡è¿›è¡Œè®¡ç®—éƒ½æ˜¯å¯¹å…¶åŠ é”æ¥å®ç°ï¼Œä½†æ˜¯ç°åœ¨æˆ‘ä»¬å¯ä»¥ç”¨è¿‡Atomicç›¸å…³çš„ç±»æ¥å®ç°ç›¸åŒçš„æ•ˆæœä¸”æ€§èƒ½æ›´å¥½ã€‚è€ŒAtomicIntegerå°±æ˜¯å…¶ä¸­çš„ä¸€å‘˜ï¼Œå…¶åº•å±‚å°±æ˜¯é€šè¿‡CASæ¥å®ç°çš„ã€‚
// ä¼ªä»£ç  class AtomicInteger { // ä¿è¯å†…å­˜å¯è§æ€§ 	private volatile int value; public final int getAndIncrement() { for(;;) { int current = get(); int next = current &#43; 1; // casæ›¿æ¢  if (compareAndSwap(current, next)) { return current; } } } public int get() { return value; } }  ä¹è§‚é”ï¼šè¯»æ“ä½œä¸ä¸Šé”ï¼Œç­‰åˆ°å†™æ“ä½œçš„æ—¶å€™ï¼Œåˆ¤æ–­æ•°æ®åœ¨æ­¤æœŸé—´æ˜¯å¦è¢«ä¿®æ”¹ï¼Œå¦‚æœå·²è¢«ä¿®æ”¹ï¼Œåˆ™é‡å¤è¯¥æµç¨‹ï¼Œç›´åˆ°æŠŠå€¼å†™å›å»ã€‚CASå°±æ˜¯ä¹è§‚é”çš„ä½“ç°ã€‚
 CASçš„ç›¸å…³æ–¹æ³•éƒ½è¢«å°è£…åœ¨Unsafeç±»ä¸­ï¼Œæˆ‘ä»¬ä»¥AtomicIntegerä¸­æ“ä½œcompareAndSwapInt()ä¸ºä¾‹ã€‚
/** * var1: è¿™é‡Œå°±æ˜¯AtomicIntegerå¯¹è±¡ * var2: AotmicInteger ä¸­çš„æˆå‘˜å˜é‡ï¼Œlongå‹æ•´æ•°ï¼Œå˜é‡åœ¨ç±»ä¸­çš„å†…å­˜åç§»é‡ * å¯ä»¥é€šè¿‡unsafe.objectFieldOffset(Field var1)æ¥è·å¾— * var4ï¼šå˜é‡çš„æ—§å€¼ * var5: å˜é‡çš„æ–°å€¼ */ public final native boolean compareAndSwapInt(Object var1, long var2, int var4, int var5)  Unsafeç±»æä¾›äº†ä¸‰ç§ç±»å‹çš„CASæ“ä½œï¼šintã€longã€Objectï¼Œåˆ†åˆ«å¯¹åº”compareAndSwapInt()ã€compareAndSwapLong()ã€compareAndSwapObject()ã€‚"/>
<meta name="keywords" content=""/>
<meta name="robots" content="noodp"/>
<link rel="canonical" href="https://xiaokexiang.github.io/post/cas/" />





<link rel="stylesheet" href="https://xiaokexiang.github.io/assets/style.css">


<link rel="stylesheet" href="https://xiaokexiang.github.io/style.css">


<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://xiaokexiang.github.io/img/apple-touch-icon-144-precomposed.png">
<link rel="shortcut icon" href="https://xiaokexiang.github.io/img/favicon.png">



<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="CAS"/>
<meta name="twitter:description" content="Javaå¹¶å‘ä¸­`ä¹è§‚é”çš„å®ç°`ï¼Œå¤§éƒ¨åˆ†å¹¶å‘æ¡†æ¶éƒ½åŸºäºCASå®ç°ã€‚"/>



<meta property="og:title" content="CAS" />
<meta property="og:description" content="Javaå¹¶å‘ä¸­`ä¹è§‚é”çš„å®ç°`ï¼Œå¤§éƒ¨åˆ†å¹¶å‘æ¡†æ¶éƒ½åŸºäºCASå®ç°ã€‚" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://xiaokexiang.github.io/post/cas/" />
<meta property="article:published_time" content="2020-06-12T22:49:05+08:00" />
<meta property="article:modified_time" content="2020-06-12T22:49:05+08:00" /><meta property="og:site_name" content="é»„æ˜ç°ç™½éª¨" />






  </head>
  <body class="">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a href="https://xiaokexiang.github.io" class="logo" style="text-decoration: none;">
  
    <span class="logo__mark"><svg xmlns="https://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367"/>
</svg></span>
    <span class="logo__text">é»„æ˜ç°ç™½éª¨</span>
    <span class="logo__cursor"></span>
    <span class="logo__cursor2"></span>
  
</a>
    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/categories">Categories</a></li>
        
      
        
          <li><a href="/tags">Tags</a></li>
        
      
      
    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/categories">Categories</a></li>
      
    
      
        <li><a href="/tags">Tags</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none"/>
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="https://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>
      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  
  

  <div class="post">
    <h1 class="post-title"><a href="https://xiaokexiang.github.io/post/cas/">CAS</a></h1>
    <div class="post-meta">
      
        <span class="post-date">
          2020-06-12
        </span>

        
          
        
      

      
      
    </div>

    
      <span class="post-tags">
        
        ğŸ–<a href="https://xiaokexiang.github.io/tags/cas/">CAS </a>&nbsp;
        
        ğŸ–<a href="https://xiaokexiang.github.io/tags/%E5%8E%9F%E5%AD%90%E6%80%A7/">åŸå­æ€§</a>&nbsp;
        
      </span>
    

    

    <div class="post-content">
      
      <p>åˆ¤æ–­æ•°æ®æ˜¯å¦è¢«ä¿®æ”¹ï¼ŒåŒæ—¶å†™å›æ–°å€¼ï¼Œè¿™ä¸¤ä¸ªæ“ä½œè¦åˆæˆä¸€ä¸ªåŸå­æ“ä½œï¼Œè¿™å°±æ˜¯CAS(compare and swap)ã€‚</p>
<p>ä¹‹å‰å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œæˆ‘ä»¬å¯¹å˜é‡è¿›è¡Œè®¡ç®—éƒ½æ˜¯å¯¹å…¶åŠ é”æ¥å®ç°ï¼Œä½†æ˜¯ç°åœ¨æˆ‘ä»¬å¯ä»¥ç”¨è¿‡Atomicç›¸å…³çš„ç±»æ¥å®ç°ç›¸åŒçš„æ•ˆæœä¸”æ€§èƒ½æ›´å¥½ã€‚è€Œ<code>AtomicInteger</code>å°±æ˜¯å…¶ä¸­çš„ä¸€å‘˜ï¼Œå…¶åº•å±‚å°±æ˜¯é€šè¿‡CASæ¥å®ç°çš„ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// ä¼ªä»£ç 
</span><span style="color:#75715e"></span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AtomicInteger</span> <span style="color:#f92672">{</span>
	<span style="color:#75715e">// ä¿è¯å†…å­˜å¯è§æ€§
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">volatile</span> <span style="color:#66d9ef">int</span> value<span style="color:#f92672">;</span>
	
	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">getAndIncrement</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
		<span style="color:#66d9ef">for</span><span style="color:#f92672">(;;)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">int</span> current <span style="color:#f92672">=</span> get<span style="color:#f92672">();</span>
            <span style="color:#66d9ef">int</span> next <span style="color:#f92672">=</span> current <span style="color:#f92672">+</span> 1<span style="color:#f92672">;</span>
            <span style="color:#75715e">// casæ›¿æ¢
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>compareAndSwap<span style="color:#f92672">(</span>current<span style="color:#f92672">,</span> next<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            	<span style="color:#66d9ef">return</span> current<span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
		<span style="color:#f92672">}</span>
	<span style="color:#f92672">}</span>
	
	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">get</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
		<span style="color:#66d9ef">return</span> value<span style="color:#f92672">;</span>
	<span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<p>ä¹è§‚é”ï¼šè¯»æ“ä½œä¸ä¸Šé”ï¼Œç­‰åˆ°å†™æ“ä½œçš„æ—¶å€™ï¼Œåˆ¤æ–­æ•°æ®åœ¨æ­¤æœŸé—´æ˜¯å¦è¢«ä¿®æ”¹ï¼Œå¦‚æœå·²è¢«ä¿®æ”¹ï¼Œåˆ™é‡å¤è¯¥æµç¨‹ï¼Œç›´åˆ°æŠŠå€¼å†™å›å»ã€‚CASå°±æ˜¯ä¹è§‚é”çš„ä½“ç°ã€‚</p>
</blockquote>
<p>CASçš„ç›¸å…³æ–¹æ³•éƒ½è¢«å°è£…åœ¨<code>Unsafeç±»</code>ä¸­ï¼Œæˆ‘ä»¬ä»¥<code>AtomicIntegerä¸­æ“ä½œcompareAndSwapInt()</code>ä¸ºä¾‹ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">/**
</span><span style="color:#75715e"> * var1: è¿™é‡Œå°±æ˜¯AtomicIntegerå¯¹è±¡
</span><span style="color:#75715e"> * var2: AotmicInteger ä¸­çš„æˆå‘˜å˜é‡ï¼Œlongå‹æ•´æ•°ï¼Œå˜é‡åœ¨ç±»ä¸­çš„å†…å­˜åç§»é‡
</span><span style="color:#75715e"> *       å¯ä»¥é€šè¿‡unsafe.objectFieldOffset(Field var1)æ¥è·å¾—
</span><span style="color:#75715e"> * var4ï¼šå˜é‡çš„æ—§å€¼
</span><span style="color:#75715e"> * var5: å˜é‡çš„æ–°å€¼
</span><span style="color:#75715e"> */</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">native</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">compareAndSwapInt</span><span style="color:#f92672">(</span>Object var1<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> var2<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> var4<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> var5<span style="color:#f92672">)</span>
</code></pre></div><blockquote>
<p>Unsafeç±»æä¾›äº†ä¸‰ç§ç±»å‹çš„CASæ“ä½œï¼šintã€longã€Objectï¼Œåˆ†åˆ«å¯¹åº”compareAndSwapInt()ã€compareAndSwapLong()ã€compareAndSwapObject()ã€‚</p>
</blockquote>
<hr>
<h4 id="abaé—®é¢˜">ABAé—®é¢˜</h4>
<p>å› ä¸ºCASæ˜¯åŸºäºå€¼æ¥åšæ¯”è¾ƒçš„ï¼Œå¦‚æœçº¿ç¨‹Aå°†å˜é‡ä»Xæ”¹æˆYï¼Œåˆæ”¹å›Xï¼Œå°½ç®¡æ”¹è¿‡ä¸¤æ¬¡ï¼Œä½†æ˜¯çº¿ç¨‹Bå»ä¿®æ”¹çš„æ—¶å€™ä¼šè®¤ä¸ºè¿™ä¸ªå˜é‡æ²¡æœ‰è¢«ä¿®æ”¹è¿‡ã€‚</p>
<h4 id="atomicstampedreference">AtomicStampedReference</h4>
<p><code>AtomicStampedReferenceé€šè¿‡å¼•å…¥å€¼å’Œç‰ˆæœ¬å·çš„æ¦‚å¿µ</code>ç”¨äºè§£å†³CASä¸­ABAçš„é—®é¢˜ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AtomicStampedReference</span><span style="color:#f92672">&lt;</span>V<span style="color:#f92672">&gt;</span> <span style="color:#f92672">{</span>
	<span style="color:#75715e">// é€šè¿‡é™æ€å†…éƒ¨ç±»æ„å»ºPairå¯¹è±¡å®ç°compareAndSwapObject()
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Pair</span><span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">final</span> T reference<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> stamp<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">Pair</span><span style="color:#f92672">(</span>T reference<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> stamp<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">reference</span> <span style="color:#f92672">=</span> reference<span style="color:#f92672">;</span>
            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">stamp</span> <span style="color:#f92672">=</span> stamp<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">static</span> <span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> Pair<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">of</span><span style="color:#f92672">(</span>T reference<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> stamp<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> Pair<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;(</span>reference<span style="color:#f92672">,</span> stamp<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">volatile</span> Pair<span style="color:#f92672">&lt;</span>V<span style="color:#f92672">&gt;</span> pair<span style="color:#f92672">;</span>
    <span style="color:#75715e">// å…ˆåˆ¤æ–­expectã€newä¸currentæ˜¯å¦ç›¸ç­‰ï¼Œå†å†³å®šæ˜¯å¦çš„è°ƒç”¨casåˆ¤æ–­
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">compareAndSet</span><span style="color:#f92672">(</span>V   expectedReference<span style="color:#f92672">,</span>
                                 V   newReference<span style="color:#f92672">,</span>
                                 <span style="color:#66d9ef">int</span> expectedStamp<span style="color:#f92672">,</span>
                                 <span style="color:#66d9ef">int</span> newStamp<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        Pair<span style="color:#f92672">&lt;</span>V<span style="color:#f92672">&gt;</span> current <span style="color:#f92672">=</span> pair<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">return</span>
            expectedReference <span style="color:#f92672">==</span> current<span style="color:#f92672">.</span><span style="color:#a6e22e">reference</span> <span style="color:#f92672">&amp;&amp;</span>
            expectedStamp <span style="color:#f92672">==</span> current<span style="color:#f92672">.</span><span style="color:#a6e22e">stamp</span> <span style="color:#f92672">&amp;&amp;</span>
            <span style="color:#f92672">((</span>newReference <span style="color:#f92672">==</span> current<span style="color:#f92672">.</span><span style="color:#a6e22e">reference</span> <span style="color:#f92672">&amp;&amp;</span>
              newStamp <span style="color:#f92672">==</span> current<span style="color:#f92672">.</span><span style="color:#a6e22e">stamp</span><span style="color:#f92672">)</span> <span style="color:#f92672">||</span>
             casPair<span style="color:#f92672">(</span>current<span style="color:#f92672">,</span> Pair<span style="color:#f92672">.</span><span style="color:#a6e22e">of</span><span style="color:#f92672">(</span>newReference<span style="color:#f92672">,</span> newStamp<span style="color:#f92672">)));</span>
    <span style="color:#f92672">}</span>
    
    <span style="color:#75715e">// compareAndSwapObject()
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">casPair</span><span style="color:#f92672">(</span>Pair<span style="color:#f92672">&lt;</span>V<span style="color:#f92672">&gt;</span> cmp<span style="color:#f92672">,</span> Pair<span style="color:#f92672">&lt;</span>V<span style="color:#f92672">&gt;</span> val<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> UNSAFE<span style="color:#f92672">.</span><span style="color:#a6e22e">compareAndSwapObject</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> pairOffset<span style="color:#f92672">,</span> cmp<span style="color:#f92672">,</span> val<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<p>é€šè¿‡åˆ¤æ–­æ–°æ—§å¼•ç”¨ä¸ç‰ˆæœ¬å·æ˜¯å¦ç›¸ç­‰æ¥åˆ¤æ–­ä¿®æ”¹æ˜¯å¦æˆåŠŸã€‚</p>
</blockquote>
<hr>
<h4 id="atomicmarkablereference">AtomicMarkableReference</h4>
<p>ä¸<code>AtomicStampedReference</code>ç±»ä¼¼ï¼Œä½†æ˜¯å…¶å†…éƒ¨ç±»ä¼ å…¥çš„æ˜¯<code>å¼•ç”¨ + booleanå€¼</code>ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AtomicMarkableReference</span><span style="color:#f92672">&lt;</span>V<span style="color:#f92672">&gt;</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Pair</span><span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">final</span> T reference<span style="color:#f92672">;</span>
        <span style="color:#75715e">// ä¸AtomicMarkableReferenceç›¸æ¯”ä¸åŒç‚¹
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> mark<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">Pair</span><span style="color:#f92672">(</span>T reference<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> mark<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">reference</span> <span style="color:#f92672">=</span> reference<span style="color:#f92672">;</span>
            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mark</span> <span style="color:#f92672">=</span> mark<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">static</span> <span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> Pair<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">of</span><span style="color:#f92672">(</span>T reference<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> mark<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> Pair<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;(</span>reference<span style="color:#f92672">,</span> mark<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">volatile</span> Pair<span style="color:#f92672">&lt;</span>V<span style="color:#f92672">&gt;</span> pair<span style="color:#f92672">;</span>
    <span style="color:#f92672">...</span> 
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<p>å› ä¸ºPair<!-- raw HTML omitted -->åªæ¥å—booleanå€¼ä½œä¸ºç‰ˆæœ¬å·ï¼Œæ‰€ä»¥ä¸èƒ½å®Œå…¨é¿å…ABAé—®é¢˜ï¼Œåªèƒ½æ˜¯é™ä½å‘ç”Ÿçš„æ¦‚ç‡ã€‚</p>
</blockquote>
<hr>
<h4 id="atomicintegerfieldupdater">AtomicIntegerFieldUpdater</h4>
<p>ç”¨äºå®ç°å¯¹<code>æŸä¸ªä¸èƒ½ä¿®æ”¹æºä»£ç ç±»çš„ã€è¢«volatileä¿®é¥°çš„æˆå‘˜å˜é‡</code>çš„åŸå­æ“ä½œã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AtomicIntegerFieldUpdater</span><span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> <span style="color:#f92672">{</span>
    
    <span style="color:#75715e">// ä¼ å…¥éœ€è¦ä¿®æ”¹çš„ç±»çš„classå¯¹è±¡ä»¥åŠå¯¹åº”æˆå‘˜å˜é‡çš„åå­—
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#f92672">&lt;</span>U<span style="color:#f92672">&gt;</span> AtomicIntegerFieldUpdater<span style="color:#f92672">&lt;</span>U<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">newUpdater</span><span style="color:#f92672">(</span>Class<span style="color:#f92672">&lt;</span>U<span style="color:#f92672">&gt;</span> tclass<span style="color:#f92672">,</span>
                                                          String fieldName<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// è°ƒç”¨å®ç°ç±»æ„é€ å‚æ•°ï¼Œä¼šåˆ¤æ–­volatileä¿®é¥°çš„æˆå‘˜å˜é‡ç±»å‹æ˜¯å¦æ˜¯int
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> AtomicIntegerFieldUpdaterImpl<span style="color:#f92672">&lt;</span>U<span style="color:#f92672">&gt;</span>
            <span style="color:#f92672">(</span>tclass<span style="color:#f92672">,</span> fieldName<span style="color:#f92672">,</span> Reflection<span style="color:#f92672">.</span><span style="color:#a6e22e">getCallerClass</span><span style="color:#f92672">());</span>
    <span style="color:#f92672">}</span> 
    
    <span style="color:#75715e">// ç”±AtomicIntegerFieldUpdaterå®ç°ç±»å®ç°
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">compareAndSet</span><span style="color:#f92672">(</span>T obj<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> expect<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> update<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// åˆ¤æ–­objæ˜¯ä¸æ˜¯ä¸Šé¢tclassç±»å‹
</span><span style="color:#75715e"></span>        accessCheck<span style="color:#f92672">(</span>obj<span style="color:#f92672">);</span>
        <span style="color:#75715e">// æœ€ç»ˆè¿˜æ˜¯è°ƒç”¨compareAndSwapIntå»æ›´æ–°å€¼
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span> U<span style="color:#f92672">.</span><span style="color:#a6e22e">compareAndSwapInt</span><span style="color:#f92672">(</span>obj<span style="color:#f92672">,</span> offset<span style="color:#f92672">,</span> expect<span style="color:#f92672">,</span> update<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<p>é™¤äº†AtomicIntegerFieldUpdaterï¼ŒåŒæ ·æœ‰AtomicLongFieldUpdaterå’ŒAtomicReferenceFieldUpdaterã€‚</p>
</blockquote>
<hr>
<h4 id="atomicintegerarray">AtomicIntegerArray</h4>
<p>å®ç°å¯¹æ•°ç»„å…ƒç´ çš„åŸå­æ“ä½œï¼Œå¹¶ä¸æ˜¯å¯¹æ•´ä¸ªæ•°ç»„ï¼Œè€Œæ˜¯é’ˆå¯¹æ•°ç»„ä¸­çš„ä¸€ä¸ªå…ƒç´ çš„åŸå­æ“ä½œã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// è·å–æ•°ç»„çš„é¦–åœ°å€çš„ä½ç½®
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> base <span style="color:#f92672">=</span> unsafe<span style="color:#f92672">.</span><span style="color:#a6e22e">arrayBaseOffset</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span><span style="color:#f92672">[].</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
<span style="color:#75715e">// shiftæ ‡è¯†scaleä¸­1çš„ä½ç½®(å› ä¸ºscale=2^*ï¼Œæ‰€ä»¥scaleä¸­åªä¼šæœ‰ä¸€ä½æ˜¯1ï¼Œè¿™ä¸ªä½ç½®å³shift)
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> shift<span style="color:#f92672">;</span>
<span style="color:#66d9ef">static</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// ç¡®ä¿scaleæ˜¯2çš„æ•´æ•°æ¬¡æ–¹: 2^*
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> scale <span style="color:#f92672">=</span> unsafe<span style="color:#f92672">.</span><span style="color:#a6e22e">arrayIndexScale</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span><span style="color:#f92672">[].</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>scale <span style="color:#f92672">&amp;</span> <span style="color:#f92672">(</span>scale <span style="color:#f92672">-</span> 1<span style="color:#f92672">))</span> <span style="color:#f92672">!=</span> 0<span style="color:#f92672">)</span>
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;data type scale not a power of two&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#75715e">// è¿”å›scaleä¸­æœ€é«˜ä½ä¹‹å‰çš„0
</span><span style="color:#75715e"></span>    shift <span style="color:#f92672">=</span> 31 <span style="color:#f92672">-</span> Integer<span style="color:#f92672">.</span><span style="color:#a6e22e">numberOfLeadingZeros</span><span style="color:#f92672">(</span>scale<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
<span style="color:#75715e">/**
</span><span style="color:#75715e"> * iï¼šå³ä¸ºè„šæ ‡ï¼Œä¼šè¢«è½¬æ¢æˆå†…å­˜åç§»é‡
</span><span style="color:#75715e"> * expectï¼šæœŸå¾…çš„intå€¼
</span><span style="color:#75715e"> * updateï¼šæ›´æ–°çš„intå€¼
</span><span style="color:#75715e"> */</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">compareAndSet</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> expect<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> update<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
	<span style="color:#66d9ef">return</span> compareAndSetRaw<span style="color:#f92672">(</span>checkedByteOffset<span style="color:#f92672">(</span>i<span style="color:#f92672">),</span> expect<span style="color:#f92672">,</span> update<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">long</span> <span style="color:#a6e22e">checkedByteOffset</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>i <span style="color:#f92672">&lt;</span> 0 <span style="color:#f92672">||</span> i <span style="color:#f92672">&gt;=</span> array<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">)</span>
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> IndexOutOfBoundsException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;index &#34;</span> <span style="color:#f92672">+</span> i<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">return</span> byteOffset<span style="color:#f92672">(</span>i<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
<span style="color:#75715e">// æœ€ç»ˆåœ¨è¿™é‡Œè½¬æ¢æˆå†…å­˜åç§»é‡
</span><span style="color:#75715e">// æ•°ç»„çš„é¦–åœ°å€ + è„šæ ‡(ç¬¬å‡ ä¸ª) * æ•°ç»„å…ƒç´ å¤§å°sacle
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">long</span> <span style="color:#a6e22e">byteOffset</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// ä¹Ÿå°±æ˜¯ i * scale + base
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">((</span><span style="color:#66d9ef">long</span><span style="color:#f92672">)</span> i <span style="color:#f92672">&lt;&lt;</span> shift<span style="color:#f92672">)</span> <span style="color:#f92672">+</span> base<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
<span style="color:#75715e">// arrayå³ä¸ºint[]å¯¹è±¡ offsetå³ä¸ºå†…å­˜åç§»é‡
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">compareAndSetRaw</span><span style="color:#f92672">(</span><span style="color:#66d9ef">long</span> offset<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> expect<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> update<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> unsafe<span style="color:#f92672">.</span><span style="color:#a6e22e">compareAndSwapInt</span><span style="color:#f92672">(</span>array<span style="color:#f92672">,</span> offset<span style="color:#f92672">,</span> expect<span style="color:#f92672">,</span> update<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<p>é™¤äº†AtomicIntegerArrayè¿˜åŒ…æ‹¬AtomicLongArrayå’ŒAtomicReferenceArrayã€‚</p>
</blockquote>
<hr>
<h4 id="striped64åŠç›¸å…³å­ç±»">Striped64åŠç›¸å…³å­ç±»</h4>
<p>JDK8ä¹‹ååˆæä¾›äº†<code>Stripedã€LongAddrã€DoubleAddrã€LongAccumulatorå’ŒDoubleAccumulator</code>ç”¨äºå®ç°å¯¹<code>longå’Œdouble</code>çš„åŸå­æ€§æ“ä½œã€‚</p>
<p>LongAddrç±»ï¼Œå…¶åŸç†æ˜¯<code>å°†ä¸€ä¸ªLongå‹æ‹†åˆ†æˆå¤šä»½ï¼Œæ‹†æˆä¸€ä¸ªbaseå˜é‡å¤–åŠ å¤šä¸ªcellï¼Œæ¯ä¸€ä¸ªcelléƒ½åŒ…è£…äº†ä¸€ä¸ªLongå‹å˜é‡ï¼Œé«˜å¹¶å‘ä¸‹å¹³æ‘Šåˆ°Cellä¸Šï¼Œæœ€åå–å€¼å†å°†baseå’Œcellç´¯åŠ æ±‚sumè¿ç®—</code>ã€‚Cellå°±å­˜åœ¨äºLongAddræŠ½è±¡çˆ¶ç±»Striped64ä¸­ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Striped64</span> <span style="color:#66d9ef">extends</span> Number <span style="color:#f92672">{</span>
    <span style="color:#75715e">// ä¸€ä¸ªbase+å¤šä¸ªcell
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">@sun.misc.Contended</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Cell</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// volatileä¿®é¥°çš„longå‹å˜é‡
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">volatile</span> <span style="color:#66d9ef">long</span> value<span style="color:#f92672">;</span>
        Cell<span style="color:#f92672">(</span><span style="color:#66d9ef">long</span> x<span style="color:#f92672">)</span> <span style="color:#f92672">{</span> value <span style="color:#f92672">=</span> x<span style="color:#f92672">;</span> <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">cas</span><span style="color:#f92672">(</span><span style="color:#66d9ef">long</span> cmp<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> val<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// CAS
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">return</span> UNSAFE<span style="color:#f92672">.</span><span style="color:#a6e22e">compareAndSwapLong</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> valueOffset<span style="color:#f92672">,</span> cmp<span style="color:#f92672">,</span> val<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// Unsafe mechanics
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> sun<span style="color:#f92672">.</span><span style="color:#a6e22e">misc</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Unsafe</span> UNSAFE<span style="color:#f92672">;</span>
        <span style="color:#75715e">// Cellä¸­valueåœ¨å†…å­˜ä¸­çš„åç§»é‡
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">long</span> valueOffset<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">static</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                UNSAFE <span style="color:#f92672">=</span> sun<span style="color:#f92672">.</span><span style="color:#a6e22e">misc</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Unsafe</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getUnsafe</span><span style="color:#f92672">();</span>
                Class<span style="color:#f92672">&lt;?&gt;</span> ak <span style="color:#f92672">=</span> Cell<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">;</span>
                <span style="color:#75715e">// è·å–åç§»é‡
</span><span style="color:#75715e"></span>                valueOffset <span style="color:#f92672">=</span> UNSAFE<span style="color:#f92672">.</span><span style="color:#a6e22e">objectFieldOffset</span>
                    <span style="color:#f92672">(</span>ak<span style="color:#f92672">.</span><span style="color:#a6e22e">getDeclaredField</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;value&#34;</span><span style="color:#f92672">));</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error<span style="color:#f92672">(</span>e<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
<span style="color:#75715e">// LongAdder base åˆå§‹å€¼æ˜¯0 åªèƒ½è¿›è¡Œç´¯åŠ æ“ä½œ
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">LongAdder</span> <span style="color:#66d9ef">extends</span> Striped64 <span style="color:#66d9ef">implements</span> Serializable <span style="color:#f92672">{</span>
    <span style="color:#75715e">// æ±‚æ€»å€¼
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">long</span> <span style="color:#a6e22e">sum</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        Cell<span style="color:#f92672">[]</span> as <span style="color:#f92672">=</span> cells<span style="color:#f92672">;</span> Cell a<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">long</span> sum <span style="color:#f92672">=</span> base<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>as <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// å¾ªç¯è¯»å–ç´¯åŠ ï¼ŒéåŒæ­¥
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> as<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">;</span> <span style="color:#f92672">++</span>i<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>a <span style="color:#f92672">=</span> as<span style="color:#f92672">[</span>i<span style="color:#f92672">])</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
                    sum <span style="color:#f92672">+=</span> a<span style="color:#f92672">.</span><span style="color:#a6e22e">value</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">return</span> sum<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
<span style="color:#75715e">// LongAccumulatorä¸LongAdderä¸åŒç‚¹åœ¨äºæ„é€ å‡½æ•°ï¼ŒLongAccumulatorå¯ä»¥è‡ªå®šä¹‰æ“ä½œç¬¦å’Œåˆå§‹å€¼
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">LongAccumulator</span> <span style="color:#66d9ef">extends</span> Striped64 <span style="color:#66d9ef">implements</span> Serializable <span style="color:#f92672">{</span>
	<span style="color:#66d9ef">public</span> <span style="color:#a6e22e">LongAccumulator</span><span style="color:#f92672">(</span>LongBinaryOperator accumulatorFunction<span style="color:#f92672">,</span>
                           <span style="color:#66d9ef">long</span> identity<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">function</span> <span style="color:#f92672">=</span> accumulatorFunction<span style="color:#f92672">;</span>
        base <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">identity</span> <span style="color:#f92672">=</span> identity<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
    
</code></pre></div><blockquote>
<p>ç›¸æ¯”äºAtomicLongï¼ŒLongAddræ›´é€‚åˆäºé«˜å¹¶å‘çš„ç»Ÿè®¡åœºæ™¯ï¼Œè€Œä¸æ˜¯å¯¹æŸä¸ªLongå‹å˜é‡è¿›è¡Œä¸¥æ ¼åŒæ­¥çš„åœºæ™¯ã€‚</p>
</blockquote>
<hr>
<h4 id="ä¼ªå…±äº«ä¸ç¼“å­˜è¡Œå¡«å……">ä¼ªå…±äº«ä¸ç¼“å­˜è¡Œå¡«å……</h4>
<p>JDK8ä¸­é€šè¿‡<code>@sun.misc.Contented</code>æ³¨è§£å®ç°ç¼“å­˜è¡Œå¡«å……çš„ä½œç”¨ã€‚</p>
<p>åœ¨CPUæ¶æ„ä¸­ï¼Œæ¯ä¸ªCPUéƒ½æœ‰è‡ªå·±çš„ç¼“å­˜ã€‚<code>ç¼“å­˜ä¸ä¸»å†…å­˜è¿›è¡Œæ•°æ®äº¤æ¢çš„åŸºæœ¬å•ä½å«Cache Lineç¼“å­˜è¡Œ</code>ã€‚åœ¨64ä½çš„X86æ¶æ„ä¸­ï¼Œç¼“å­˜è¡Œå¤§å°æ˜¯64byte(8ä¸ªlongå‹)ï¼Œæ„å‘³ç€å½“ç¼“å­˜è¡Œå¤±æ•ˆï¼Œéœ€è¦åˆ·æ–°åˆ°ä¸»å†…å­˜çš„æ—¶å€™ï¼Œæœ€å°‘éœ€è¦åˆ·æ–°64å­—èŠ‚ã€‚</p>
<p><img src="https://image.leejay.top/image/20200605/Q1vhuTbvuFNq.png?imageslim" alt=""></p>
<p>æˆ‘ä»¬å‡è®¾ä¸»å†…å­˜ä¸­æœ‰xï¼Œyï¼Œzä¸‰ä¸ªLongå‹å˜é‡ï¼Œè¢«Core1å’ŒCore2è¯»åˆ°è‡ªå·±çš„ç¼“å­˜ï¼Œæ”¾åœ¨åŒä¸€ä¸ªç¼“å­˜è¡Œï¼Œå½“Core1å¯¹å˜é‡xè¿›è¡Œä¿®æ”¹ï¼Œé‚£ä¹ˆå®ƒéœ€è¦<code>å¤±æ•ˆä¸€æ•´è¡ŒCache Line</code>ï¼Œå¹¶é€šè¿‡CPUæ€»çº¿å‘æ¶ˆæ¯é€šçŸ¥Core2å¯¹åº”çš„Cache Lineå¤±æ•ˆã€‚<code>æ‰€ä»¥å³ä½¿yå’Œzæ²¡æœ‰è¢«ä¿®æ”¹ï¼Œå› ä¸ºå’Œxå¤„äºåŒä¸€ä¸ªç¼“å­˜è¡Œï¼Œæ‰€ä»¥xã€yã€zéƒ½éœ€è¦å¤±æ•ˆï¼Œè¿™å°±å«åšä¼ªå…±äº«é—®é¢˜</code>ã€‚</p>
<p>æˆ‘ä»¬é€šè¿‡å°†xï¼Œyï¼Œzä¸‰ä¸ªå˜é‡åˆ†å¸ƒåˆ°ä¸åŒçš„ç¼“å­˜è¡Œå¹¶ä¸”å¡«å……7ä¸ªæ— ç”¨çš„Longå‹æ¥å¡«å……ç¼“å­˜è¡Œï¼Œç”¨äºé¿å…<code>ä¼ªå…±äº«é—®é¢˜</code>ï¼ŒJDK8ä¹‹å‰éƒ½æ˜¯é€šè¿‡ä¸‹é¢çš„ç±»ä¼¼ä»£ç æ¥å®ç°ï¼ŒJDK8ä¹‹ååˆ™æ˜¯é€šè¿‡<code>@sun.misc.Contented</code>å®ç°æ­¤åŠŸèƒ½ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Test</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">volatile</span> <span style="color:#66d9ef">long</span> value<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">long</span> a <span style="color:#f92672">,</span>b <span style="color:#f92672">,</span>c <span style="color:#f92672">,</span>d <span style="color:#f92672">,</span>e <span style="color:#f92672">,</span>f <span style="color:#f92672">,</span>g<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>

<span style="color:#a6e22e">@sun.misc.Contended</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">demo</span><span style="color:#f92672">{</span>
    <span style="color:#66d9ef">volatile</span> <span style="color:#66d9ef">long</span> value<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><hr>

    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h">å…¶ä»–æ–‡ç« </span>
            <hr />
          </div>
          <div class="pagination__buttons">
            
              <span class="button previous">
                <a href="https://xiaokexiang.github.io/post/reentrantlock/">
                  <span class="button__icon">â†</span>
                  <span class="button__text">AQSä¸ReentrantLockç‹¬å é”</span>
                </a>
              </span>
            
            
              <span class="button next">
                <a href="https://xiaokexiang.github.io/post/volatile/">
                  <span class="button__text">volatile</span>
                  <span class="button__icon">â†’</span>
                </a>
              </span>
            
          </div>
        </div>
      
    


    
      
        

      
    

    </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright copyright--user">è‹ICPå¤‡18050258å·-1</div>
    
  </div>
</footer>

<script src="https://xiaokexiang.github.io/assets/main.js"></script>
<script src="https://xiaokexiang.github.io/assets/prism.js"></script>


      
    </div>

    
  </body>
</html>
