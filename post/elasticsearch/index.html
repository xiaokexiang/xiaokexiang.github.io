<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>Elasticsearch操作文档 :: Keep Improving</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="前置知识 Elasticsearch是一个分布式，RESTful风格的搜索和数据分析引擎。
概念点 ES是面向文档的，文档是最小单位，对应着关系型数据库中的一条数据。 index索引除了存储所有映射类型的字段，还包含一些设置，ex: refresh_interval（新增文档对于搜索可见的时间间隔，准实时）。 集群由n个节点（n≥1）组成，节点由m个分片（m≥1）组成。索引由x个主分片（x≥1）和y个副本分片（y≥0）组成。（副本可以在运行时增加，而主分片不行，在创建索引前必须决定其数量） 新增文档时，会根据文档的id进行hash计算确认一个主分区A（shard_num = hash(_id) % 主分片个数），如果A分区不在当前节点，那么ES会将文档索引到A分区所在的目标节点上，并同步到非目标节点的主分片中，并通过各节点的主分片与副本分片进行同步。 RESTful ES的查询会涉及到RESTful的相关概念
其中GET、HEAD、PUT、DELETE是幂等的操作（即任意多次执行所产生的影响均与一次执行的影响相同） POST不是幂等的操作（即每次调用都会创建一个新的资源，但实际会通过数据库主键或其他方式进行限制）。PATCH也不是幂等的，因为相比PUT对资源的全部更新，PATCH强调的是部分更新，如果是依赖于当前值的&#43;&#43;操作，那么必定是非幂等的。 GET、HEAD是安全的操作，仅仅是查询资源并不会修改资源，PUT、PATHC、DELETE、POST是不安全的操作，会修改资源数据。 type移除 ES中的index、type、document、field分别对应着关系型数据库中的database、table、row、column，在ES8.0版本中已经不在支持type。
在es中同一个index中不同的type是存储在同一个lucene索引文件中的，不同type中相同名字的字段的含义必须相同。
但关系型数据库中的table是独立存储的，所以type在es中的用途就十分有限。
环境搭建 docker部署 # 基于docker部署es7.8.0 mkdir -p /root/es/plugins /root/es/data /root/es/config &amp;amp;&amp;amp; touch /root/es/config/elasticsearch.yml &amp;amp;&amp;amp; chmod 777 /root/es/** docker run -d --name es -p 9200:9200 -p 9300:9300 \ -v /root/es/data:/usr/share/elasticsearch/data \ -v /root/es/plugins:/usr/share/elasticsearch/plugins \ -v /root/es/conig/elasticsearch.yml:/usr/share/elasticsearch/conig/elasticsearch.yml \ -e &amp;#34;discovery.type=single-node&amp;#34; \ -e &amp;#34;ES_JAVA_OPTS=-Xms512m -Xmx512m&amp;#34; \ docker.io/library/elasticsearch:7.8.0 配置分词器 # 配置分词器 wget https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.8.0/elasticsearch-analysis-ik-7.8.0.zip \ &amp;amp;&amp;amp; mkdir -p ik/ &amp;amp;&amp;amp; unzip -od ik/ elasticsearch-analysis-ik-7." />
<meta name="keywords" content="" />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://leejay.top/post/elasticsearch/" />




<link rel="stylesheet" href="https://leejay.top/assets/style.css">






<link rel="apple-touch-icon" href="https://leejay.top/img/favicon.png">

  <link rel="shortcut icon" href="https://leejay.top/img/favicon.png">



<meta name="twitter:card" content="summary" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Elasticsearch操作文档">
<meta property="og:description" content="Elasticsearch是一个`分布式`，`RESTful`风格的搜索和数据分析引擎。" />
<meta property="og:url" content="https://leejay.top/post/elasticsearch/" />
<meta property="og:site_name" content="Keep Improving" />

  
    <meta property="og:image" content="https://leejay.top/img/favicon.png">
  

<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">

  <meta property="article:section" content="elasticsearch" />


  <meta property="article:published_time" content="2023-02-09 14:17:55 &#43;0800 &#43;0800" />










<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fira+Code">

</head>
<body class="orange">


<div class="container center headings--one-size">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="https://leejay.top">
  <div class="logo">
    HelloWorld
  </div>
</a>

    </div>
    
  </div>
  
  
  
  <script async src="https://cdn.bootcdn.net/ajax/libs/mermaid/9.1.1/mermaid.min.js"></script>
  
  <script type="text/javascript"
        async
        src="https://cdn.bootcss.com/mathjax/2.7.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\[\[','\]\]']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
});

MathJax.Hub.Queue(function() {
    
    
    
    var all = MathJax.Hub.getAllJax(), i;
    for(i = 0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
});
</script>

<style>
code.has-jax {
    font: inherit;
    font-size: 100%;
    background: inherit;
    border: inherit;
    color: #515151;
}
</style>

</header>


  <div class="content">
    
<div class="post">
  
  
    









<div class="toc" id="toc_id">

    <div class="page-header"><strong> ↓ 目录 ↓ </strong></div>

    <div id="page-scrollspy" class="toc-nav">

        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e5%89%8d%e7%bd%ae%e7%9f%a5%e8%af%86">
                    前置知识
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e6%a6%82%e5%bf%b5%e7%82%b9">
                    概念点
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#restful">
                    RESTful
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#type%e7%a7%bb%e9%99%a4">
                    type移除
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e7%8e%af%e5%a2%83%e6%90%ad%e5%bb%ba">
                    环境搭建
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#docker%e9%83%a8%e7%bd%b2">
                    docker部署
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e9%85%8d%e7%bd%ae%e5%88%86%e8%af%8d%e5%99%a8">
                    配置分词器
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e5%b8%b8%e8%a7%81%e5%88%86%e8%af%8d%e5%99%a8">
                    常见分词器
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#kibana">
                    kibana
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e5%9f%ba%e7%a1%80%e6%93%8d%e4%bd%9c">
                    基础操作
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e7%b4%a2%e5%bc%95">
                    索引
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e6%96%87%e6%a1%a3">
                    文档
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e8%84%9a%e6%9c%ac">
                    脚本
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e7%b4%a2%e5%bc%95%e5%ae%9a%e4%b9%89">
                    索引定义
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e6%89%b9%e9%87%8f%e6%93%8d%e4%bd%9c">
                    批量操作
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e9%ab%98%e7%ba%a7%e6%93%8d%e4%bd%9cquery-dsl">
                    高级操作（Query DSL）
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e6%95%b0%e6%8d%ae%e6%a8%a1%e6%8b%9f">
                    数据模拟
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e5%9f%ba%e7%a1%80%e6%9f%a5%e8%af%a2">
                    基础查询
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e5%8c%b9%e9%85%8d%e6%9f%a5%e8%af%a2">
                    匹配查询
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e7%b2%be%e7%a1%ae%e6%9f%a5%e8%af%a2">
                    精确查询
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e6%9d%a1%e4%bb%b6%e6%9f%a5%e8%af%a2">
                    条件查询
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e8%bf%87%e6%bb%a4%e5%99%a8">
                    过滤器
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e5%85%b6%e4%bb%96%e6%9f%a5%e8%af%a2">
                    其他查询
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e8%81%9a%e5%90%88%e6%93%8d%e4%bd%9c">
                    聚合操作
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e5%8d%95%e5%80%bc%e8%81%9a%e5%90%88">
                    单值聚合
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e5%a4%9a%e5%80%bc%e8%81%9a%e5%90%88">
                    多值聚合
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e6%b7%b1%e5%ba%a6%e5%88%86%e9%a1%b5">
                    深度分页
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#fromsize">
                    from&amp;size
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#scroll">
                    scroll
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#search_after">
                    search_after
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e5%af%b9%e6%af%94">
                    对比
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        

    </div>

</div>



  
  <h1 class="post-title">
    <a href="https://leejay.top/post/elasticsearch/">Elasticsearch操作文档</a></h1>
  <div class="post-meta">
    
      <span class="post-date">
        2023-02-09 
      </span>
    
    
  </div>

  
  <span class="post-tags">
    
    #<a href="https://leejay.top/tags/elasticsearch-/">elasticsearch </a>&nbsp;
    
  </span>
  

  

  

  <div class="post-content"><div>
        <h3 id="前置知识">前置知识<a href="#前置知识" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>Elasticsearch是一个分布式，<code>RESTful</code>风格的搜索和数据分析引擎。</p>
<h4 id="概念点">概念点<a href="#概念点" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<ul>
<li>ES是面向文档的，文档是最小单位，对应着关系型数据库中的一条数据。</li>
<li>index索引除了存储所有映射类型的字段，还包含一些设置，ex: refresh_interval（新增文档对于搜索可见的时间间隔，准实时）。</li>
<li>集群由n个节点（n≥1）组成，节点由m个分片（m≥1）组成。索引由x个主分片（x≥1）和y个副本分片（y≥0）组成。（<code>副本可以在运行时增加，而主分片不行，在创建索引前必须决定其数量</code>）</li>
<li>新增文档时，会根据文档的id进行hash计算确认一个主分区A（shard_num = hash(_id) % 主分片个数），如果A分区不在当前节点，那么ES会将文档索引到A分区所在的目标节点上，并同步到非目标节点的主分片中，并通过各节点的主分片与副本分片进行同步。</li>
</ul>
<h4 id="restful">RESTful<a href="#restful" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<blockquote>
<p>ES的查询会涉及到<code>RESTful</code>的相关概念</p>
<ol>
<li>其中<code>GET、HEAD、PUT、DELETE</code>是幂等的操作（即任意多次执行所产生的影响均与一次执行的影响相同）</li>
<li><code>POST</code>不是幂等的操作（即每次调用都会创建一个新的资源，但实际会通过数据库主键或其他方式进行限制）。<code>PATCH</code>也不是幂等的，因为相比<code>PUT</code>对资源的全部更新，<code>PATCH</code>强调的是部分更新，如果是依赖于当前值的++操作，那么必定是非幂等的。</li>
<li><code>GET、HEAD</code>是安全的操作，仅仅是查询资源并不会修改资源，<code>PUT、PATHC、DELETE、POST</code>是不安全的操作，会修改资源数据。</li>
</ol>
</blockquote>
<h4 id="type移除">type移除<a href="#type移除" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p>ES中的<code>index、type、document、field</code>分别对应着关系型数据库中的<code>database、table、row、column</code>，在<code>ES8.0</code>版本中已经不在支持<code>type</code>。</p>
<blockquote>
<ol>
<li>
<p>在es中同一个index中不同的type是存储在同一个lucene索引文件中的，不同type中相同名字的字段的含义必须相同。</p>
</li>
<li>
<p>但关系型数据库中的table是独立存储的，所以type在es中的用途就十分有限。</p>
</li>
</ol>
</blockquote>
<hr>
<h3 id="环境搭建">环境搭建<a href="#环境搭建" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<h4 id="docker部署">docker部署<a href="#docker部署" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 基于docker部署es7.8.0</span>
</span></span><span style="display:flex;"><span>mkdir -p /root/es/plugins /root/es/data /root/es/config <span style="color:#f92672">&amp;&amp;</span> touch /root/es/config/elasticsearch.yml <span style="color:#f92672">&amp;&amp;</span> chmod <span style="color:#ae81ff">777</span> /root/es/**
</span></span><span style="display:flex;"><span>docker run -d --name es -p 9200:9200 -p 9300:9300 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-v /root/es/data:/usr/share/elasticsearch/data <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-v /root/es/plugins:/usr/share/elasticsearch/plugins <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-v /root/es/conig/elasticsearch.yml:/usr/share/elasticsearch/conig/elasticsearch.yml <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-e <span style="color:#e6db74">&#34;discovery.type=single-node&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-e <span style="color:#e6db74">&#34;ES_JAVA_OPTS=-Xms512m -Xmx512m&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>docker.io/library/elasticsearch:7.8.0
</span></span></code></pre></div><h4 id="配置分词器">配置分词器<a href="#配置分词器" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 配置分词器</span>
</span></span><span style="display:flex;"><span>wget https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.8.0/elasticsearch-analysis-ik-7.8.0.zip <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#f92672">&amp;&amp;</span> mkdir -p ik/ <span style="color:#f92672">&amp;&amp;</span> unzip -od ik/ elasticsearch-analysis-ik-7.8.0.zip <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#f92672">&amp;&amp;</span> docker cp ik es:/usr/share/elasticsearch/plugins/ <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#f92672">&amp;&amp;</span> docker restart es
</span></span></code></pre></div><blockquote>
<p>docker es是什么版本就使用什么版本的ik分词器，具体文档参考<a href="https://github.com/medcl/elasticsearch-analysis-ik">elasticsearch-analysis-ik</a>。</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"># 分词器验证
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">PUT /index
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">PUT /index/_mapping
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{&#34;properties&#34;: {&#34;content&#34;: {&#34;type&#34;: &#34;text&#34;, &#34;analyzer&#34;: &#34;ik_max_word&#34;,&#34;search_analyzer&#34;:&#34;ik_smart&#34;}}}
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">GET /index/_mapping
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"># 查看指定索引下的分词结果
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">POST /{index}/_analyze
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">	&#34;text&#34;: &#34;用来验证分词结果&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">	&#34;analyzer&#34;: &#34;ik_max_word&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}
</span></span></span></code></pre></div><h4 id="常见分词器">常见分词器<a href="#常见分词器" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<table>
<thead>
<tr>
<th style="text-align:center">分词器</th>
<th style="text-align:center">效果</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><strong>standard</strong></td>
<td style="text-align:center">默认的分词器，会将大小转小写，按照单词分词。</td>
</tr>
<tr>
<td style="text-align:center"><strong>ik</strong></td>
<td style="text-align:center">中文分词器，支持自定义词库。</td>
</tr>
<tr>
<td style="text-align:center">simple</td>
<td style="text-align:center">会将大写转小写，按照非字母切分，符号过滤</td>
</tr>
<tr>
<td style="text-align:center">whitespace</td>
<td style="text-align:center">按照空格分词，不会转小写。</td>
</tr>
<tr>
<td style="text-align:center">custom</td>
<td style="text-align:center">自定义分词器</td>
</tr>
</tbody>
</table>
<h4 id="kibana">kibana<a href="#kibana" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;server.name: kibana\nserver.host: &#34;</span>0<span style="color:#e6db74">&#34;\nelasticsearch.hosts: [ &#34;</span>http://<span style="color:#f92672">{</span>esIp<span style="color:#f92672">}</span>:<span style="color:#f92672">{</span>esPort<span style="color:#f92672">}</span><span style="color:#e6db74">&#34; ]\nxpack.monitoring.ui.container.elasticsearch.enabled: true&#34;</span> &gt; /root/kibana.yml
</span></span><span style="display:flex;"><span>docker run -d --name<span style="color:#f92672">=</span>kibana --restart<span style="color:#f92672">=</span>always -p 5601:5601 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -v /root/kibana.yml:/usr/share/kibana/config/kibana.yml <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  docker.elastic.co/kibana/kibana:7.8.0
</span></span></code></pre></div><blockquote>
<ol>
<li>ES的地址要写ip地址，不要写localhost。kibana的版本与ES的版本保持一致。</li>
</ol>
</blockquote>
<h3 id="基础操作">基础操作<a href="#基础操作" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<h4 id="索引">索引<a href="#索引" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"># 创建索引
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">PUT /shopping
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"># 查询索引
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">GET /shopping
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"># 查询全部的索引
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">GET /_cat/indices?v
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"># 删除索引
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">DELETE /shopping
</span></span></span></code></pre></div><blockquote>
<ol>
<li>如果使用POST创建索引，会提示错误，因为即不能存在同样名称的索引，不满足幂等要求。</li>
<li>使用curl命令时，如果希望展示美化格式，那么需要加上?pretty，默认是将结果展示为一行。</li>
</ol>
</blockquote>
<h4 id="文档">文档<a href="#文档" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"># 创建文档
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">POST /{index}/_doc {body}
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"># 创建指定id的文档
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">PUT /{index}/_create/{id} {body}
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"># 查询指定id的文档
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">GET /{index}/_doc/{id}
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"># 查询索引下全部的文档
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">GET /{index}/_search
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"># 更新文档（局部）
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">POST /{index}/_update/{id} {&#34;doc&#34;:{&#34;field&#34;:&#34;value&#34;}}
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"># 更新文档(全量)
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">PUT/POST /{index}/_doc/{id} {body}
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"># 删除文档
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">DELETE /{index}/_doc/{id}
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"># 删除索引下的全部文档
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">DELETE /{index}/_delete_by_query {&#34;query&#34;:{&#34;match_all&#34;: {}}}
</span></span></span></code></pre></div><blockquote>
<ol>
<li>创建文档（不指定id）时并不要求是幂等的操作，多次创建返回的id并不相同，所以创建文档需要使用POST请求。</li>
<li>如果创建指定id的文档，那么这个请求是幂等的（即相同id的文档只能创建一次），所以需要使用PUT请求。</li>
<li>ES中默认的脚本是<code>painless</code>，也支持<code>expression、mustache</code>。</li>
</ol>
</blockquote>
<h4 id="脚本">脚本<a href="#脚本" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"># 脚本查询：将文档中所有的age增加2
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">GET /{index}/_search
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;script_fields&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &#34;my_doubled_field&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &#34;script&#34;: { 
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &#34;source&#34;: &#34;doc[&#39;age&#39;].value * params[&#39;multiplier&#39;]&#34;, 
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &#34;lang&#34;: &#34;painless&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &#34;params&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">          &#34;multiplier&#34;: 2
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"># 存储脚本
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">POST /_scripts/{script_name}
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;script&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &#34;lang&#34;: &#34;painless&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &#34;source&#34;: &#34;doc[&#39;age&#39;].value * params[&#39;multiplier&#39;]&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"># 查询脚本
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">GET /_scripts/{script_name}
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"># 查询时使用脚本
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">GET /{index}/_search
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;query&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &#34;script_score&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &#34;query&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &#34;match_all&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      },
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &#34;script&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &#34;id&#34;: {script_name}, 
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &#34;params&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">          &#34;multiplier&#34;: 3
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}
</span></span></span></code></pre></div><blockquote>
<ol>
<li>如果脚本对应的字段没有文档数据，那么会提示错误。</li>
<li>在search查询中使用脚本id查询的话，脚本执行的结果在<code>max_core</code>这个参数中。</li>
</ol>
</blockquote>
<h4 id="索引定义">索引定义<a href="#索引定义" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p>索引定义（mapping） 类似于数据库中的表结构定义 <code>schema</code>，用于定义index中的字段名称，类型等相关设置。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"># 创建索引同时指定mapping
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">PUT /{index}
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;mappings&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &#34;properties&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &#34;category&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &#34;type&#34;: &#34;text&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">PUT /{index}/_mapping
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &#34;properties&#34;:{
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &#34;name&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">            &#34;type&#34;: &#34;text&#34;, // 可以被分词
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">            &#34;index&#34;: true,  // 可以被索引查询（默认true）
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">            &#34;analyzer&#34;:&#34;ik_max_word&#34;, // 指定文档存储时为ik分词器
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      		&#34;search_analyzer&#34;: &#34;standard&#34; // 搜索时对输入按照标准分词器分词
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      		&#34;copy_to&#34;: &#34;nick_name&#34; // copy_to 在搜索时使用nick_name也可以实现搜索
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        },
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &#34;sex&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">            &#34;type&#34;: &#34;boolean&#34;, // 布尔类型
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        },
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &#34;phone&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">            &#34;type&#34;: &#34;keyword&#34;,  // 不能被分词，完整匹配
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">            &#34;index&#34;: false,     // 不能被索引查询
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">            &#34;ignore_above&#34;: 256 // 超过此值的数据不会被索引
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        },
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &#34;age&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        	&#34;type&#34;: &#34;byte/short/long/double/float/int&#34; // 数值型
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        },
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &#34;birthday&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        	&#34;type&#34;:&#34;date&#34; // 日期类型
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        	&#34;format&#34;: &#34;basic_date&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"># 为已存在的mapping添加新的字段（已经存在的mapping字段无法修改只能新增！）
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">PUT /{index}/_mapping
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">	&#34;properties&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">		&#34;address&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">			&#34;type&#34;: &#34;text&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">			&#34;index&#34;: true
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">		}
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">	}
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}
</span></span></span></code></pre></div><blockquote>
<ol>
<li>与其他类型新增保持一致，因为是幂等的（不能重复），所以需要基于PUT创建。</li>
<li><code>text</code>为文本类型会被分词，<code>keyword</code>为关键字类型不会分词，需要<code>完全匹配（区分大小写）</code>，<code>index</code>表示能否被索引，如果设置false，查询时使用该字段会报错。</li>
<li>ES默认为整数值分配long，浮点数值分配double。ES date类型支持<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-date-format.html">多种format格式</a>（也支持<code>yyyy-MM-dd</code>形式）。</li>
<li>text、keyword、number、date都可以用来定义数组，我们只需要在传参的时候传入数组，ES会自动转换。</li>
<li>copy_to可以将多个字段都赋值给代理字段，查询支持使用代理字段查询。比如使用nick_name也能匹配到name的数据。</li>
<li>更多mapping参数定义请点击查看<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-params.html">→官网文档←</a>。</li>
</ol>
</blockquote>
<h4 id="批量操作">批量操作<a href="#批量操作" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"># 批量新增
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">POST /_bulk
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{&#34;create&#34;: {&#34;_index&#34;:{index1},&#34;_id&#34;: {id1}}}
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{&#34;field1&#34;: &#34;value1&#34;, &#34;field2&#34;: &#34;value2&#34;}
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{&#34;create&#34;: {&#34;_index&#34;:{index2},&#34;_id&#34;: {id2}}}
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{&#34;field1&#34;: &#34;value1&#34;, &#34;field2&#34;: &#34;value2&#34;}
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"># 批量修改
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">POST /_bulk
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{&#34;update&#34;: {&#34;_index&#34;:{index1}, &#34;id&#34;: {id1}}}
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{&#34;doc&#34;: {&#34;field1&#34;:&#34;value1&#34;}}
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{&#34;update&#34;: {&#34;_index&#34;:{index2},&#34;_id&#34;: {id2}}}
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{&#34;doc&#34;: {&#34;field1&#34;:&#34;value2&#34;}}
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#批量删除
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">POST /_bulk
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{&#34;delete&#34;: {&#34;_index&#34;:{index1},&#34;_id&#34;: {id1}}}
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{&#34;delete&#34;: {&#34;_index&#34;:{index2},&#34;_id&#34;: {id2}}}
</span></span></span></code></pre></div><blockquote>
<ol>
<li>批量修改，不是全量覆盖，如果字段存在那么替换，如果不存在就新增。</li>
<li>如果操作的是同一个index，那么可以直接写在url路径中，在body中就不要传递index参数。</li>
</ol>
</blockquote>
<hr>
<h3 id="高级操作query-dsl">高级操作（Query DSL）<a href="#高级操作query-dsl" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<h4 id="数据模拟">数据模拟<a href="#数据模拟" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"># 创建index &amp; mapping
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">PUT /product
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;mappings&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &#34;properties&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &#34;title&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &#34;type&#34;: &#34;text&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      },
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &#34;time&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &#34;type&#34;: &#34;date&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &#34;format&#34;: &#34;yyyyMMdd&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      },
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &#34;name&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &#34;type&#34;: &#34;text&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &#34;analyzer&#34;: &#34;ik_max_word&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      },
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &#34;category&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &#34;type&#34;: &#34;keyword&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      },
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &#34;price&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &#34;type&#34;: &#34;double&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"># 批量插入数据
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">POST /product/_bulk
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{&#34;create&#34;: {&#34;_id&#34;: &#34;1001&#34;}}
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{&#34;title&#34;: &#34;buy apple Phone&#34;, &#34;time&#34;: 20220910, &#34;name&#34;:&#34;苹果手机&#34;, &#34;category&#34;: &#34;Phone&#34;, &#34;price&#34;: 4999.00}
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{&#34;create&#34;: {&#34;_id&#34;: &#34;1002&#34;}}
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{&#34;title&#34;: &#34;buy huawei Phone&#34;,&#34;time&#34;: 20221120, &#34;name&#34;:&#34;华为手机&#34;, &#34;category&#34;: &#34;Phone&#34;, &#34;price&#34;: 6999.00}
</span></span></span></code></pre></div><blockquote>
<p>在使用默认的standard分词器时，<code>buy apple Phone</code> 会被分词为<code>buy</code>、<code>apple</code>、<code>phone</code>，注意<code>Phone -&gt; phone</code>。同样<code>buy huawei Phone</code>也被分词为了<code>buy</code>、<code>huawei</code>、<code>phone</code>。</p>
</blockquote>
<h4 id="基础查询">基础查询<a href="#基础查询" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p>搜索条件包含：query（包含过滤、查询条件）、_source（自定义返回字段）、from&amp;size（分页查询）、sort（排序，默认按照score排序）四大模块。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"># 查询全部数据
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">POST /product/_search
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;query&#34;:{
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &#34;match_all&#34;: {} // 匹配全部
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  },
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;_source&#34;: &#34;title&#34;, // 只返回source
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;sort&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &#34;_id&#34;: {      // _id倒序
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &#34;order&#34;: &#34;desc&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  ]
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"># 查询全部数据进阶版
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">POST /{index}/_search
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;query&#34;:{
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &#34;match_all&#34;: {} // 匹配全部
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  },
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;_source&#34;: {&#34;includes&#34;: [&#34;title&#34;], &#34;excludes&#34;: [&#34;_i*&#34;]}, // 支持*，只返回includes中的排除了excludes中的字段。
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;sort&#34;: [     // 多个排序条件
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    {&#34;_id&#34;: &#34;desc&#34;},
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &#34;_score&#34; // 默认asc顺序
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  ]
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}
</span></span></span></code></pre></div><h4 id="匹配查询">匹配查询<a href="#匹配查询" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<h5 id="match">match<a href="#match" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"># 单个单词查询
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">POST /product/_search 
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &#34;query&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &#34;match&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">            &#34;title&#34;: &#34;buy&#34; // 通过字段匹配
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"># 多个单词查询 匹配2条（buy apple Phone 和 buy huawei Phone）
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">POST /{index}/_search
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">	&#34;query&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">		&#34;match&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">			&#34;title&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">				&#34;query&#34;: &#34;apple huawei&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">				&#34;operator&#34;: &#34;or&#34; // 多单词查询需要文档全满足或一个满足
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">			}
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">		}
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">	}
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"># 高亮显示
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">POST /product/_search
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;query&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &#34;match&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &#34;title&#34;: &#34;Phone&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  },
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;highlight&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &#34;fields&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &#34;title&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &#34;pre_tags&#34;: &#34;&lt;em&gt;&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &#34;post_tags&#34;: &#34;&lt;/em&gt;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}
</span></span></span></code></pre></div><blockquote>
<ol>
<li>在数据模拟中我们解释道，标准分词器会将大写转换为小写，所以使用<code>phone</code>去匹配时，2条数据都符合。</li>
<li>如果match中查询多个单词，默认（or）是有一个符合要求的文档就会被查询出来。</li>
</ol>
</blockquote>
<h5 id="match_all">match_all<a href="#match_all" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"># 完全匹配
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">POST /product/_search
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">	&#34;query&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">		&#34;match_all&#34;: {} // 完全匹配
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">	}
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}
</span></span></span></code></pre></div><h5 id="multi_match">multi_match<a href="#multi_match" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">POST /product/_search
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;query&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &#34;multi_match&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &#34;query&#34;: &#34;apple&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &#34;fields&#34;: [&#34;title&#34;,&#34;name&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}
</span></span></span></code></pre></div><blockquote>
<p>等同于多个字段的match，只要有一个字段match就算匹配成功。</p>
</blockquote>
<h5 id="match_phrase">match_phrase<a href="#match_phrase" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"># 默认slop
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">POST /product/_search
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;query&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &#34;match_phrase&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &#34;title&#34;: &#34;apple phone&#34;, // buy apple Phone 和 buy huawei Phone √
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &#34;slop&#34;: 0  // 默认为0
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"># 指定slop
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">POST /product/_search
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;query&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &#34;match_phrase&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &#34;title&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &#34;query&#34;: &#34;buy phone&#34;, // buy apple Phone 和 buy huawei Phone √
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &#34;slop&#34;: 1
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}
</span></span></span></code></pre></div><blockquote>
<ol>
<li>match_phrase被称为短语搜索，要求所有的分词都必须同时出现在文档里面，且位置都必须相邻。</li>
<li>slop表示短语分词后，各个词之间的距离整合后进行匹配查询，slop=1时，<code>buy phone</code>等于<code>buy * phone</code>。</li>
</ol>
</blockquote>
<h5 id="match_phrase_prefix">match_phrase_prefix<a href="#match_phrase_prefix" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">POST /product/_search
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;query&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &#34;match_phrase_prefix&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &#34;title&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &#34;query&#34;: &#34;buy apple&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &#34;max_expansions&#34;: 10
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}
</span></span></span></code></pre></div><blockquote>
<p>match_phrase_prefix在match_phrase基础上进行查询，如果查询词为<code>buy apple</code>，那么根据<code>buy apple *</code> 进行匹配，默认最多返回50个匹配的结果，可以通过设置<code>max_expansions</code>限制结果返回。常用于搜索时的<code>auto complete</code>。</p>
</blockquote>
<h4 id="精确查询">精确查询<a href="#精确查询" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<h5 id="term">term<a href="#term" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">POST /product/_search
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;query&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &#34;term&#34;: { // term完全匹配
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &#34;category&#34;: &#34;Phone&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}
</span></span></span></code></pre></div><blockquote>
<ol>
<li>term与match不同点在于：term是精确匹配，term不会对搜索词进行分词。</li>
<li>例如category是text类型，对应的文档值是<code>huaiwei phone</code>，那么经过默认分词器会出现<code>huawei</code>和<code>phone</code>两个token（单词），此时用term去匹配，如果搜索词是<code>huawei</code>，那么可以匹配到，如果是<code>huawei phone</code>，那么无法匹配。</li>
<li>若<code>category</code>是<code>keyword</code>类型（添加文档字段不会被分词），那么经过默认分词器会出现一个<code>huawei phone</code>的token，此时用term去匹配，如果是<code>huawei</code>，那么无法匹配到，如果是<code>huawei phone</code>，则是可以匹配到。</li>
</ol>
</blockquote>
<h5 id="terms">terms<a href="#terms" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">POST /product/_search
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;query&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &#34;bool&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &#34;must&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">          &#34;terms&#34;: { // 效果等同于title in (&#34;buy&#34;, &#34;huawei&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">            &#34;title&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">              &#34;buy&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">              &#34;huawei&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">            ]
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">          }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      ]
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}
</span></span></span></code></pre></div><blockquote>
<ol>
<li>term适用于一个词（一个体现在不分词，而不是一个单词），terms用于匹配多个词，效果等同于SQL中的in (?,?)查询。</li>
</ol>
</blockquote>
<h4 id="条件查询">条件查询<a href="#条件查询" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<h5 id="bool">bool<a href="#bool" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"># 多条件bool查询
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">POST /{index}/_search
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;query&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &#34;bool&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &#34;must&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">          &#34;match&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">            &#34;title&#34;: &#34;phone&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">          }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      ],
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &#34;must_not&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">          &#34;range&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">            &#34;time&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">              &#34;gt&#34;: &#34;now-4M/M&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">            }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">          }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      ],
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &#34;should&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">          &#34;term&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">            &#34;name&#34;: &#34;手机&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">          }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      ]
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}
</span></span></span></code></pre></div><blockquote>
<ol>
<li>must、must_not、should分别对应Sql中的and、not和or。filter可用于范围过滤，但是并不作用于score计算。</li>
<li>每个关键字里面都可以包含多个条件，多个关键字组合使用时，必须保证三者都满足的文档才会被返回。</li>
<li>(title=&ldquo;phone&rdquo;) &amp;&amp; (time &lt; now-4M/M) &amp;&amp; (name=&ldquo;手机&rdquo;)  = true的文档才会被返回。</li>
</ol>
</blockquote>
<h4 id="过滤器">过滤器<a href="#过滤器" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<h5 id="filter">filter<a href="#filter" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">POST /product/_search
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;query&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &#34;bool&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &#34;must&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">          &#34;term&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">            &#34;title&#34;: &#34;phone&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">          }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      ],
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &#34;filter&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">          &#34;range&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">            &#34;time&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">              &#34;gte&#34;: 20221010,
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">              &#34;lte&#34;: 20230101
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">            }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">          }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      ]
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}
</span></span></span></code></pre></div><blockquote>
<ol>
<li>query查询注重匹配度，filter注重是否匹配，filter适合大范围筛选数据，query适合精确匹配数据，两者可以配合使用。</li>
<li>filter可以进行缓存匹配，命中就返回文档，而query需要进行额外一步（计算score）并且不支持缓存。</li>
<li>ES通过bitmap(0/1)集合来表示文档是否匹配过滤器，那么在过滤器应用于其他请求时，就不需要再次计算匹配。</li>
<li>filter不光可以作用在<code>bool</code>查询中，也支持在<code>aggs</code>聚合中使用。</li>
</ol>
</blockquote>
<h4 id="其他查询">其他查询<a href="#其他查询" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<h5 id="query_string">query_string<a href="#query_string" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">POST /product/_search
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;query&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &#34;query_string&#34;: {   // 更推荐simple_query_string
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &#34;default_field&#34;: &#34;nick_name&#34;, 
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &#34;fields&#34;: [&#34;nick_name&#34;, &#34;title&#34;], // 与default_field不能共存，只能二选一出现。
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &#34;query&#34;: &#34;apple Phone1&#34; // 默认会对搜索词进行分词再匹配，与match相同。
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}
</span></span></span></code></pre></div><blockquote>
<ol>
<li>query_string在不显式指定default_field属性时，默认会对所有文档的字段都进行匹配。会影响性能，不推荐使用。</li>
<li>相比query_string，更推荐simple_query_string，使用时必须要指定查询哪些字段。</li>
</ol>
</blockquote>
<h5 id="range">range<a href="#range" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"># 范围查询
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">POST /product/_search
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;query&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &#34;range&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &#34;time&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &#34;lte&#34;: &#34;20221101&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"># 范围查询，指定日期格式
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">POST /product/_search
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;query&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &#34;range&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &#34;time&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &#34;lte&#34;: &#34;2022-11-01&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &#34;format&#34;: &#34;yyyy-MM-dd||yyyyMMdd&#34; // ES会将输入的yyyy-MM-dd的参数转换为yyyyMMdd
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}
</span></span></span></code></pre></div><blockquote>
<ol>
<li>基于时间进行查询时，需要注意输入的格式需要与mapping中定义的格式相同。</li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.17/query-dsl-range-query.html">date类型</a>支持表达式（y表示年，M表示月，d表示天），比如<code>20221010||/M</code>表示为<code>20221001</code>，<code>20221010||/y</code>表示为<code>20220101</code>，<code>now-1y/d</code>表示为当前时间减1年后包含日的时间，若now为<code>20221010</code>，那么结果为<code>20211010</code>。同理<code>now-4M/M</code>，结果为<code>20220601</code>。</li>
</ol>
</blockquote>
<h5 id="prefix">prefix<a href="#prefix" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">POST /product/_search
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;query&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &#34;prefix&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &#34;title&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &#34;value&#34;: &#34;苹果&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}
</span></span></span></code></pre></div><blockquote>
<ol>
<li>prefix不会对搜索词进行分析，大小写敏感，score永远为1，不能缓存的filter。</li>
</ol>
</blockquote>
<h5 id="wildcard">wildcard<a href="#wildcard" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">POST /product/_search
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;query&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &#34;wildcard&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &#34;title&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &#34;value&#34;: &#34;b*&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}
</span></span></span></code></pre></div><blockquote>
<ol>
<li>wildcard使用通配符进行查询，*匹配多个字符或汉字，?匹配一个字符或汉字。</li>
<li>大小写敏感，如果是<code>buy apple phone</code>，那么通配符是<code>bu*</code>这种才可以，<code>buy app*</code>是不能完全匹配的。</li>
<li>尽量避免<code>*b</code>这样的操作，和mysql一样，避免左通配让索引失效。</li>
</ol>
</blockquote>
<h5 id="exist">exist<a href="#exist" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">POST /product/_search
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;query&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &#34;bool&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &#34;filter&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">          &#34;exists&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">            &#34;field&#34;: &#34;name&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">          }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      ]
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}
</span></span></span></code></pre></div><blockquote>
<p>用于判断字段是否存在，存在会返回文档信息。</p>
</blockquote>
<hr>
<h3 id="聚合操作">聚合操作<a href="#聚合操作" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<ol>
<li>
<p>如果查询和聚合一起出现，那么ES会先根据查询过滤文档，对符合条件的文档再进行聚合操作。</p>
</li>
<li>
<p>需要注意的是<code>text</code>类型的因为会分词，尽量不要用于聚合，建议使用<code>keyword</code>类型的字段进行聚合。在此前提下仍需要聚合的话，有两种方式：</p>
</li>
</ol>
<ul>
<li>使用<code>字段.keyword</code>替代<code>字段</code>，即使用<code>name.keyword</code>作为聚合field。</li>
<li>设置字段类型时，加上<code>fielddata:true</code>的配置。</li>
</ul>
<h4 id="单值聚合">单值聚合<a href="#单值聚合" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">POST /product/_search
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;aggs&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &#34;avg_aggs&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &#34;avg&#34;: {           // 聚合类型： 平均值
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &#34;field&#34;: &#34;price&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  },
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;size&#34;: 0
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}
</span></span></span></code></pre></div><blockquote>
<ol>
<li>聚合类型：value_count（数量汇总）、avg（平均值）、sum（求和）、max（最大值）、min（最小值）、cardinality（基数）。</li>
<li><a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/cardinality.html">cardinality</a>作用等同于SQL中的count(distinct)，但是它是一个近似算法，ES提供了<code>precision_threshold</code>来设置阈值，默认是100，<code>字段基数如果在阈值以下，几乎100%是准确的，高于阈值会为了节省内存而牺牲精度</code>。</li>
</ol>
</blockquote>
<h4 id="多值聚合">多值聚合<a href="#多值聚合" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<h5 id="percentiles">percentiles<a href="#percentiles" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">POST /product/_search
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;aggs&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &#34;percent_aggs&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &#34;percentiles&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &#34;field&#34;: &#34;price&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &#34;percents&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">          50
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        ]
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  },
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;size&#34;: 0
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"># 结果
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;took&#34; : 0,
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;timed_out&#34; : false,
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;_shards&#34; : {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &#34;total&#34; : 1,
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &#34;successful&#34; : 1,
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &#34;skipped&#34; : 0,
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &#34;failed&#34; : 0
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  },
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;hits&#34; : {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &#34;total&#34; : {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &#34;value&#34; : 2,
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &#34;relation&#34; : &#34;eq&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    },
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &#34;max_score&#34; : null,
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &#34;hits&#34; : [ ]
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  },
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;aggregations&#34; : {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &#34;percent_aggs&#34; : {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &#34;values&#34; : {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &#34;50.0&#34; : 5999.0 // 符合条件的值中，50%的数据不超过5999.0
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}
</span></span></span></code></pre></div><blockquote>
<ol>
<li>percentiles理解成百分位，用来表示所有值中百分之多少比这个值低，这个百分比是查询时传递的参数。</li>
</ol>
</blockquote>
<h5 id="percentile_ranks">percentile_ranks<a href="#percentile_ranks" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">POST /product/_search
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;aggs&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &#34;percent_aggs&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &#34;percentile_ranks&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &#34;field&#34;: &#34;price&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &#34;values&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">          4999
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        ]
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  },
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;size&#34;: 0
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}
</span></span></span></code></pre></div><blockquote>
<ol>
<li>与percentiles完全相反，查询时传递值参数，计算百分比，即百分之多少的数据低于这个值</li>
</ol>
</blockquote>
<h5 id="stats">stats<a href="#stats" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">POST /product/_search
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;aggs&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &#34;stats_aggs&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &#34;stats&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &#34;field&#34;: &#34;price&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  },
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;size&#34;: 0
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}
</span></span></span></code></pre></div><blockquote>
<ol>
<li>stats是<code>count、min、max、avg、sum</code>指标的汇总。</li>
</ol>
</blockquote>
<h5 id="extended_stats">extended_stats<a href="#extended_stats" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;aggs&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &#34;stats_aggs&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &#34;extended_stats&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &#34;field&#34;: &#34;price&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  },
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;size&#34;: 0
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}
</span></span></span></code></pre></div><blockquote>
<ol>
<li>extended_stats是stats的扩展，添加了<code>标准差和平方和</code>。</li>
</ol>
</blockquote>
<h5 id="terms-1">terms<a href="#terms-1" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">POST /product/_search
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;aggs&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &#34;terms_aggs&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &#34;terms&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &#34;field&#34;: &#34;price&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &#34;size&#34;: 10, // 分片数据汇总后返回的数量
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &#34;shard_size&#34;: &#34;10&#34;, // 每个分片最多返回的数量
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &#34;min_doc_count&#34;: &#34;10&#34;, // group by后最小的count数量，低于此数量的不展示
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &#34;include&#34;: &#34;.*&#34;, // 通配符过滤bucket数据
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &#34;exclude&#34;: &#34;.*&#34;, // 排除符合的bucket数据
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &#34;order&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">          &#34;_key&#34;: &#34;desc&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">          &#34;_count&#34;: &#34;asc&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  },
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;size&#34;: 0
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}
</span></span></span></code></pre></div><blockquote>
<ol>
<li>terms中的size用于控制聚合中符合条件的doc_count数量，即group by price limit size。</li>
<li>terms支持对结果排序，<code>_key</code>表示按照字母顺序，<code>_count</code>表示按照聚合后的统计数量进行排序。</li>
</ol>
</blockquote>
<h5 id="range-1">range<a href="#range-1" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">POST /product/_search
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;aggs&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &#34;range_aggs&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &#34;range&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &#34;field&#34;: &#34;price&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &#34;ranges&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">          {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">            &#34;from&#34;: 4000,
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">            &#34;to&#34;: 7000
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">          }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        ]
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"># 时间range聚合
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">POST /product/_search
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;aggs&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &#34;date_aggs&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &#34;date_range&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &#34;field&#34;: &#34;time&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &#34;ranges&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">          {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">            &#34;from&#34;: &#34;now-1y/y&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">            &#34;to&#34;: 20221101
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">          }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        ]
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}
</span></span></span></code></pre></div><blockquote>
<ol>
<li>range支持多个区间的桶聚合，返回的结果中将<code>from-to</code>组合成key返回，范围区间为<code>左闭右开</code>。</li>
<li><code>date_range</code>中时间字段同样支持<code>date</code>表达式。</li>
</ol>
</blockquote>
<h5 id="histogram">histogram<a href="#histogram" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">POST /product/_search
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;aggs&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &#34;histogram_aggs&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &#34;histogram&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &#34;field&#34;: &#34;price&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &#34;interval&#34;: 50, 
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &#34;min_doc_count&#34;: 0
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"> &#34;aggregations&#34; : {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &#34;histogram_aggs&#34; : {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &#34;buckets&#34; : [
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">          &#34;key&#34; : 4950.0, // 表示 4950 -&gt; (4950 +interval)这个区间有1条符合条件的文档
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">          &#34;doc_count&#34; : 1
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      ]
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"># date_histogram
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">POST /product/_search
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;aggs&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &#34;histogram_aggs&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &#34;date_histogram&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &#34;field&#34;: &#34;time&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &#34;calendar_interval&#34;: &#34;1d&#34;, // 支持分钟 (1m)、小时 (1h)、天 (1d)、星期 (1w)、月 (1M)、季度 (1q)、年 (1y)
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &#34;missing&#34;: &#34;20220907&#34;, 
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &#34;time_zone&#34;: &#34;+08:00&#34;, 
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &#34;min_doc_count&#34;: 1
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}
</span></span></span></code></pre></div><blockquote>
<ol>
<li>histogram又称为直方图聚合，interval用于指定区间的间隔，min_doc_count用于筛选符合数量的区间。</li>
</ol>
</blockquote>
<h5 id="nested">nested<a href="#nested" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">POST /product/_search
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;aggs&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &#34;first_aggs&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &#34;terms&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &#34;field&#34;: &#34;category&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      },
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &#34;aggs&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &#34;second_aggs&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">          &#34;terms&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">            &#34;field&#34;: &#34;price&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">            &#34;size&#34;: 10
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">          }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}
</span></span></span></code></pre></div><blockquote>
<ol>
<li>嵌套聚合，就是在第一个聚合的基础上再次聚合。</li>
</ol>
</blockquote>
<h5 id="global">global<a href="#global" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">POST /product/_search
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;query&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &#34;bool&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &#34;must&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">          &#34;match_all&#34;: {}
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      ],
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &#34;filter&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">          &#34;range&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">            &#34;time&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">              &#34;gte&#34;: 20221001,
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">              &#34;lte&#34;: 20221020
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">            }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">          }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      ]
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  },
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;aggs&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &#34;first_aggs&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &#34;global&#34;: {},
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &#34;aggs&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &#34;first_aggs&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">          &#34;terms&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">            &#34;field&#34;: &#34;category&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">          }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}
</span></span></span></code></pre></div><blockquote>
<ol>
<li>如果使用了global，那么搜索查询和聚合两者互不影响，即聚合的文档不由搜索决定。</li>
</ol>
</blockquote>
<hr>
<h3 id="深度分页">深度分页<a href="#深度分页" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<h4 id="fromsize">from&amp;size<a href="#fromsize" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p>from表示查询的起始位置，size表示每页的文档数量，<code>from=100&amp;size=20</code>表示查询<code>100-120</code>条数据。</p>
<p>ES在处理from&amp;size的查询时，会先从每个分片上拿取数据，然后在协调节点（coordinating node）上对数据汇总排序，如果是9900-10000的数据，ES会汇总10000条文档，取9900-10000的文档数据返回。所以分页越深，ES需要的内存越多，开销越大。这也是为什么ES默认现在<code>from+size&lt;=10000</code>的原因。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"># 修改from + size 限制数量
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">PUT /{index}/_settings
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">	&#34;index.max_result_window&#34;: &#34;10001&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}
</span></span></span></code></pre></div><h4 id="scroll">scroll<a href="#scroll" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p>scroll查询作用于需要查询大量的文档，同时对文档的实时性要求不高的情况。使用scroll查询，第一次会生成当前查询条件的快照（快照的缓存时间由查询语句决定），后面每次翻页都基于快照的结果（有新的数据进来也不会被查询出来），滚动查询结果知道没有匹配的文档。</p>
<p>协调节点接受到scroll请求，会请求各个节点的数据，将符合条件的文档id汇总，打成快照缓存下来（query），当后续请求携带scroll_id时，根据这个scroll_id定位到各个节点的游标位置（fetch），最后汇总返回指定size的文档（merge）。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"># 第一次请求
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">POST /product/_search/?scroll=1m
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;from&#34;: 0, // from第一次只能为0，可以省略不写
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;size&#34;: 1
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"># 请求时需要携带上一次请求返回的scroll_id
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">POST /_search/scroll
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;scroll_id&#34;: &#34;FGluY2x1ZGVfY29udGV4dF91dWlkDXF1ZXJ5QW5kRmV0Y2gBFDZjMUNNSVlCRC1nd3VJaW5wa0dWAAAAAAAAp9IWekFfNnF0SnZTd0NNQk92VUJ5MUo1QQ==&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;scroll&#34;: &#34;1m&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"># 删除所有scroll
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">DELETE /_search/scroll/_all
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"># 删除指定scroll
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">DELETE /_search/scoll
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;scroll_id&#34;: [&#34;xxxqdqqd==&#34;,&#34;dadwqdqw==&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}
</span></span></span></code></pre></div><blockquote>
<ol>
<li>第一次请求返回的scroll_id在ES7.8版本中是不变的，可以一直作为参数请求直到快照过期。</li>
<li>因为实时性问题，scroll用于实时性不高的任务，比如后台导出大量数据等。</li>
</ol>
</blockquote>
<h4 id="search_after">search_after<a href="#search_after" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"># 第一次查询
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">POST /product/_search
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;query&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &#34;match_all&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  },
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;from&#34;: 0, // 第一次传必须是第一页，所以可以省略
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;size&#34;: 1, // 指定每次滚动查询的size
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;sort&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &#34;_id&#34;:&#34;desc&#34;, //_id是文档默认id
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &#34;id&#34;: &#34;desc&#34;  // id是mapping中定义的业务id
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  ]
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"> ...
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;hits&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    ...
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &#34;sort&#34; : [
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &#34;EM3zM4YBD-gwuIin6Jtp&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        1001
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      ]
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"># 第二次请求需要携带search_after参数
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">POST /product/_search
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;query&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &#34;match_all&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  },
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;search_after&#34;: [&#34;EM3zM4YBD-gwuIin6Jtp&#34;,&#34;1001&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;sort&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &#34;_id&#34;:&#34;desc&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &#34;id&#34;: &#34;desc&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  ]
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}
</span></span></span></code></pre></div><blockquote>
<ol>
<li>search_after必须先要指定sort排序（可以是多个字段），并且从第一页开始搜索，并且需要文档有唯一索引（一般是_id或自定义的唯一索引，在新增文档的时候，最好不要指定<code>_id</code>，让ES默认生成）。</li>
<li>search_after不能指定from，只能请求下一页的业务场景（滚动查询），与scroll相比，两者都采用了游标的方式实现滚动查询，但相比scroll基于快照的不实时，search_after每次查询都会针对<code>最新的文档</code>，即在search_after查询期间，排序的顺序可能是变化的。</li>
<li>我们假设有2个shard，指定time为排序字段，查询20条数据，那么每个shard执行<code>order by time where time &gt; 0 limit 20</code>，在协调节点汇总后取前20条数据。</li>
<li>第一次查询返回的索引值作为第二次查询的参数，即<code>order by time where time &gt; $max_time limit 20</code>，协调节点汇总返回前20条，以此循环反复，直到没有数据返回。</li>
<li>假设我们存在id为<code>1,3,4</code>的文档数据，size=1，第一次查询我们获取到第一条数据（id=1），在我们查询第二条之前，如果查询了插入了id为2的文档数据，此时继续查询时，会查询到这条文档id为2的数据（假设文档立即入库，实际上还受到refresh_interval的影响）。</li>
</ol>
</blockquote>
<h4 id="对比">对比<a href="#对比" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<table>
<thead>
<tr>
<th>分页类型</th>
<th>优点</th>
<th>缺点</th>
</tr>
</thead>
<tbody>
<tr>
<td>from&amp;size</td>
<td>使用简单灵活、支持跳页</td>
<td>深度分页占用大量资源，默认from+size&lt;=10000</td>
</tr>
<tr>
<td>scroll</td>
<td>适用非实时处理大量数据</td>
<td>基于快照，数据非实时，不能跳页</td>
</tr>
<tr>
<td>search_after</td>
<td>参数无状态，实时查询。</td>
<td>需要指定排序和唯一字段，不能跳页。</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"># 验证scroll的非实时和search_after的实时查询
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"># 1. 新建索引和mapping
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">PUT /test
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;mappings&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &#34;properties&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &#34;uuid&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &#34;type&#34;: &#34;keyword&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      },
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &#34;name&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &#34;type&#34;: &#34;text&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"># 2. 新增2条文档，uuid不连续
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">POST /test/_bulk
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{&#34;create&#34;: {}}
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{&#34;uuid&#34;: &#34;1001&#34;,&#34;name&#34;: &#34;小米手机&#34;}
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{&#34;create&#34;: {}}
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{&#34;uuid&#34;: &#34;1003&#34;,&#34;name&#34;: &#34;苹果手机&#34;}
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"># 3.1 执行scroll的第一步请求
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">POST /test/_search?scroll=1m
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;size&#34;: 1
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"># 3.2 执行 search_after的第一步请求
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">POST /test/_search
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;query&#34;: {&#34;match_all&#34;: {}},
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;size&#34;: 1,
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;sort&#34;: [&#34;uuid&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"># 4. 执行文档插入操作，uuid为1002
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">POST /test/_doc
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;uuid&#34;: &#34;1002&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &#34;name&#34;: &#34;华为手机&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"># 5. 分别执行scroll和search_after第二步查询文档数据查看结果。
</span></span></span></code></pre></div><blockquote>
<ol>
<li>按照上述的查询流程，第五步查询时，scroll查询的是uuid为1003的数据（非实时），search_after查询的是uuid为1002的新增数据（实时）。</li>
</ol>
</blockquote>

      </div></div>

  
  
<div class="pagination">
    <div class="pagination__title">
        <span class="pagination__title-h">其他文章</span>
        <hr />
    </div>
    <div class="pagination__buttons">
        
        <span class="button previous">
            <a href="https://leejay.top/post/raspberrypi/">
                <span class="button__icon">←</span>
                <span class="button__text">Raspberrypi搭建指南</span>
            </a>
        </span>
        
        
        <span class="button next">
            <a href="https://leejay.top/post/knowledge/">
                <span class="button__text">Java中的小知识点</span>
                <span class="button__icon">→</span>
            </a>
        </span>
        
    </div>
</div>

  

  

</div>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright copyright--user">
        <span><a rel="nofollow" href="https://beian.miit.gov.cn/" target="_blank">苏ICP备18050258号-1</a></span>
    
        
      </div>
  </div>
</footer>

<script src="https://leejay.top/assets/main.js"></script>
<script src="https://leejay.top/assets/prism.js"></script>






  
</div>

</body>
</html>
