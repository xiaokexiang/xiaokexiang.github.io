<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>Kubernetes概念入门 :: Keep Improving</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="容器与虚拟机的区别 虚拟机（VM）是虚拟化底层计算机，每个VM不仅需要运行操作系统的完整副本，还需要运行操作系统需要运行的所有硬件的虚拟副本。这就意味着需要大量的硬件资源。
相比VM，容器只需要虚拟化操作系统。每个容器共享主机操作系统内核。相比VM功能类似，但是开销少很多。但是VM提供了完全隔离的环境。
容器内的进程是运行在宿主机的操作系统上的，而虚拟机内的进程是运行在不同的操作系统上的，但容器内的进程是与其他进程隔离的。、
  VM内的指令执行流程：VM程序指令 -&amp;gt; VM操作系统内核 -&amp;gt; 宿主机管理程序 -&amp;gt; 宿主机内核。  容器会完全指定运行在宿主机上的同一个内核的系统调用，容器间是共享操作系统内核。   容器的隔离机制实现 Linux命名空间 每个进程只能看到自己的系统视图（文件、进程、网络接口、主机名等）。进程不单单只属于一个命名空间，而是属于每个类型的一个命名空间。类型包括Mount(mnt)、Process ID(pid)、NetWork(net)、Inter-process communication(ipd)、UTS、User ID(user)。
Linux控制组 基于cgroups实现，它是Linux内核功能，限制一个进程或一组进程的资源使用不超过被分配的量。
Kubernetes基本概念 Kubernetes Master &amp;amp; Node Kubernetes运行流程   在应用程序运行时，可以增加或减少副本数量。也可以交由kubernetes进行判断。 kubernetes可能需要在集群中迁移你的容器，比如运行的节点失败时、为其他容器腾空间从节点移除时。   Docker Command # 运行容器并输出hello world docker run busybox echo hello world Dockerfile const http = require(&amp;#39;http&amp;#39;); const os = require(&amp;#39;os&amp;#39;);  console .log (&amp;#34;Kub i a server starting ... &amp;#34;); var handler = function(request, response){  console." />
<meta name="keywords" content="" />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://leejay.top/post/kubernetes%E6%A6%82%E5%BF%B5%E5%85%A5%E9%97%A8/" />




<link rel="stylesheet" href="https://leejay.top/assets/style.css">






<link rel="apple-touch-icon" href="https://leejay.top/img/favicon.png">

  <link rel="shortcut icon" href="https://leejay.top/img/favicon.png">



<meta name="twitter:card" content="summary" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Kubernetes概念入门">
<meta property="og:description" content="Kubernetes是用于自动部署，扩展和管理容器化应用程序的开源系统。" />
<meta property="og:url" content="https://leejay.top/post/kubernetes%E6%A6%82%E5%BF%B5%E5%85%A5%E9%97%A8/" />
<meta property="og:site_name" content="Keep Improving" />

  
    <meta property="og:image" content="https://leejay.top/img/favicon.png">
  

<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">

  <meta property="article:section" content="Kubernetes " />


  <meta property="article:published_time" content="2021-04-09 11:07:57 &#43;0800 &#43;0800" />










<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fira+Code">

</head>
<body class="orange">


<div class="container center headings--one-size">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="https://leejay.top">
  <div class="logo">
    HelloWorld
  </div>
</a>

    </div>
    
  </div>
  
</header>


  <div class="content">
    
<div class="post">
  
  
    









<div class="toc" id="toc_id">

    <div class="page-header"><strong>- CATALOG -</strong></div>

    <div id="page-scrollspy" class="toc-nav">

        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e5%ae%b9%e5%99%a8%e4%b8%8e%e8%99%9a%e6%8b%9f%e6%9c%ba%e7%9a%84%e5%8c%ba%e5%88%ab">
                    容器与虚拟机的区别
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e5%ae%b9%e5%99%a8%e7%9a%84%e9%9a%94%e7%a6%bb%e6%9c%ba%e5%88%b6%e5%ae%9e%e7%8e%b0">
                    容器的隔离机制实现
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#linux%e5%91%bd%e5%90%8d%e7%a9%ba%e9%97%b4">
                    Linux命名空间
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#linux%e6%8e%a7%e5%88%b6%e7%bb%84">
                    Linux控制组
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#kubernetes%e5%9f%ba%e6%9c%ac%e6%a6%82%e5%bf%b5">
                    Kubernetes基本概念
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#kubernetes-master--node">
                    Kubernetes Master &amp; Node
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#kubernetes%e8%bf%90%e8%a1%8c%e6%b5%81%e7%a8%8b">
                    Kubernetes运行流程
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#docker">
                    Docker
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#command">
                    Command
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#dockerfile">
                    Dockerfile
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#docker%e9%95%9c%e5%83%8f%e6%8e%a8%e9%80%81">
                    Docker镜像推送
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#kubernetes">
                    Kubernetes
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e9%83%a8%e7%bd%b2">
                    部署
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e5%9f%ba%e4%ba%8eminikube%e9%83%a8%e7%bd%b2">
                    基于minikube部署
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e5%9f%ba%e4%ba%8ekubeadm%e9%83%a8%e7%bd%b2">
                    基于kubeadm部署
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e5%9f%ba%e6%9c%ac%e6%a6%82%e5%bf%b5%e4%b8%8e%e5%91%bd%e4%bb%a4">
                    基本概念与命令
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#pod">
                    Pod
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e6%a0%87%e7%ad%belabel">
                    标签（label）
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e6%b3%a8%e8%a7%a3annotation">
                    注解（annotation）
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e5%91%bd%e5%90%8d%e7%a9%ba%e9%97%b4namespace">
                    命名空间（namespace）
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#service">
                    Service
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e5%8d%b7%e6%9c%8d%e5%8a%a1%e6%8c%82%e8%bd%bd">
                    卷（服务挂载）
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#configmap--secret">
                    ConfigMap &amp; Secret
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#downward-api">
                    Downward API
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#kubernetes-api">
                    Kubernetes API
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#deployment">
                    Deployment
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#%e6%9b%b4%e6%96%b0%e7%ad%96%e7%95%a5">
                    更新策略
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#deployment%e5%8d%87%e7%ba%a7">
                    Deployment升级
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#deployment%e4%bf%ae%e6%94%b9%e6%96%b9%e5%bc%8f">
                    Deployment修改方式
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#deployment%e5%9b%9e%e6%bb%9a">
                    Deployment回滚
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#deployment%e5%8d%87%e7%ba%a7%e7%ad%96%e7%95%a5">
                    Deployment升级策略
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#deployment%e9%85%8d%e7%bd%ae%e5%b0%b1%e7%bb%aa%e6%8e%a2%e9%92%88">
                    Deployment配置就绪探针
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link" href="#statefulset">
                    StatefulSet
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        

    </div>

</div>



  
  <h1 class="post-title">
    <a href="https://leejay.top/post/kubernetes%E6%A6%82%E5%BF%B5%E5%85%A5%E9%97%A8/">Kubernetes概念入门</a></h1>
  <div class="post-meta">
    
      <span class="post-date">
        2021-04-09 
      </span>
    
    
  </div>

  
  <span class="post-tags">
    
    #<a href="https://leejay.top/tags/kubernetes-/">Kubernetes </a>&nbsp;
    
  </span>
  

  

  

  <div class="post-content"><div>
        <h2 id="容器与虚拟机的区别">容器与虚拟机的区别<a href="#容器与虚拟机的区别" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>虚拟机（VM）是虚拟化底层计算机，每个VM不仅需要运行<code>操作系统的完整副本</code>，还需要运行操作系统需要运行的所有<code>硬件的虚拟副本</code>。这就意味着需要大量的硬件资源。</p>
<p>相比VM，容器只需要虚拟化<code>操作系统</code>。每个容器共享主机操作系统内核。相比VM功能类似，但是开销少很多。但是VM提供了完全隔离的环境。</p>
<p>容器内的进程是运行在宿主机的操作系统上的，而虚拟机内的进程是运行在不同的操作系统上的，但容器内的进程是与其他进程隔离的。、</p>
<p><img src="https://image.leejay.top/FouxGZ-cOAR4ONol65GI0j4-JrnE" alt=""></p>
<blockquote>
<ol>
<li>VM内的指令执行流程：<code>VM程序指令 -&gt; VM操作系统内核 -&gt; 宿主机管理程序 -&gt; 宿主机内核。 </code></li>
<li>容器会完全指定运行在宿主机上的同一个内核的系统调用，容器间是共享操作系统内核。</li>
</ol>
</blockquote>
<h2 id="容器的隔离机制实现">容器的隔离机制实现<a href="#容器的隔离机制实现" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<h3 id="linux命名空间">Linux命名空间<a href="#linux命名空间" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>每个进程只能看到自己的系统视图（文件、进程、网络接口、主机名等）。进程不单单只属于一个命名空间，而是属于<code>每个类型</code>的一个命名空间。类型包括<code>Mount(mnt)</code>、<code>Process ID(pid)</code>、<code>NetWork(net)</code>、<code>Inter-process communication(ipd)</code>、<code>UTS</code>、<code>User ID(user)</code>。</p>
<h3 id="linux控制组">Linux控制组<a href="#linux控制组" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>基于<code>cgroups</code>实现，它是Linux内核功能，限制一个进程或一组进程的资源使用不超过被分配的量。</p>
<h2 id="kubernetes基本概念">Kubernetes基本概念<a href="#kubernetes基本概念" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<h3 id="kubernetes-master--node">Kubernetes Master &amp; Node<a href="#kubernetes-master--node" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p><img src="https://image.leejay.top/Fj-qU9AfR_V8wil_7ax3NgelK7dN" alt=""></p>
<h3 id="kubernetes运行流程">Kubernetes运行流程<a href="#kubernetes运行流程" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p><img src="https://image.leejay.top/Fq7Rgjt1Z_vaKn9ZnmaNAxcfiq5l" alt=""></p>
<blockquote>
<ol>
<li>在应用程序运行时，可以增加或减少副本数量。也可以交由kubernetes进行判断。</li>
<li>kubernetes可能需要在集群中迁移你的容器，比如运行的节点失败时、为其他容器腾空间从节点移除时。</li>
</ol>
</blockquote>
<h2 id="docker">Docker<a href="#docker" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<h3 id="command">Command<a href="#command" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 运行容器并输出hello world</span>
</span></span><span style="display:flex;"><span>docker run busybox echo hello world
</span></span></code></pre></div><h3 id="dockerfile">Dockerfile<a href="#dockerfile" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">http</span>  <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;http&#39;</span>); 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">os</span>  <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;os&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">console</span> .<span style="color:#a6e22e">log</span> (<span style="color:#e6db74">&#34;Kub i a server starting ... &#34;</span>); 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">handler</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">request</span>, <span style="color:#a6e22e">response</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span> (<span style="color:#e6db74">&#34;Rece i ved request from ” + request connection. remoteAddress&#34;</span>); 
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">response</span>.<span style="color:#a6e22e">writeHead</span>(<span style="color:#ae81ff">200</span>); 
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">response</span>.<span style="color:#a6e22e">end</span>(<span style="color:#e6db74">&#34;You&#39;ve hit &#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">hostname</span>() <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; \n &#34;</span>); 
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">www</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">createServer</span>(<span style="color:#a6e22e">handler</span>) ; 
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">www</span>.<span style="color:#a6e22e">listen</span>(<span style="color:#ae81ff">8080</span>);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 构建nodejs项目用于容器部署
</span></span></span></code></pre></div><ul>
<li>编写Dockerfile</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> node:7 # 基于什么镜像制作</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ADD</span> app.js /app.js <span style="color:#75715e"># 将当前目录下的app.js移到容器根目录</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENTRYPOINT</span> [<span style="color:#e6db74">&#34;node&#34;</span>, <span style="color:#e6db74">&#34;app.js&#34;</span>] <span style="color:#75715e"># 启动容器时的执行命令</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><ul>
<li>镜像打包</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span>docker build -t <span style="color:#e6db74">${</span>name<span style="color:#e6db74">}</span> .<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><ul>
<li>进入容器内部</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker exec -it <span style="color:#e6db74">${</span>docker name<span style="color:#e6db74">}</span> bash
</span></span></code></pre></div><blockquote>
<ol>
<li><code>-i</code>表明标准输入流保持开放</li>
<li><code>-t</code>用于分配一个伪终端</li>
</ol>
</blockquote>
<h3 id="docker镜像推送">Docker镜像推送<a href="#docker镜像推送" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker <span style="color:#e6db74">${</span>local_image<span style="color:#e6db74">}</span> <span style="color:#e6db74">${</span>your account name<span style="color:#e6db74">}</span>/<span style="color:#e6db74">${</span>remote_image<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>docker busybox xiaokexiang/busy <span style="color:#75715e"># 将本地镜像加自己账户名前缀的tag</span>
</span></span><span style="display:flex;"><span>docker login <span style="color:#75715e"># docker 账户登录</span>
</span></span><span style="display:flex;"><span>docker push xiaokexiang/busybox <span style="color:#75715e"># 推送到远端</span>
</span></span></code></pre></div><h2 id="kubernetes">Kubernetes<a href="#kubernetes" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<h3 id="部署">部署<a href="#部署" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<h4 id="基于minikube部署">基于minikube部署<a href="#基于minikube部署" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<ul>
<li>kubectl</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>export REGISTRY_MIRROR<span style="color:#f92672">=</span>https://registry.cn-hangzhou.aliyuncs.com
</span></span><span style="display:flex;"><span>curl -sSL https://kuboard.cn/install-script/v1.19.x/install_kubelet.sh | sh -s 1.19.2
</span></span></code></pre></div><ul>
<li>MiniKube</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 拉取二进制包（基于阿里云镜像）</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># https://developer.aliyun.com/article/221687</span>
</span></span><span style="display:flex;"><span>curl -Lo minikube https://kubernetes.oss-cn-hangzhou.aliyuncs.com/minikube/releases/v1.17.1/minikube-linux-amd64 <span style="color:#f92672">&amp;&amp;</span> chmod +x minikube <span style="color:#f92672">&amp;&amp;</span> sudo mv minikube /usr/local/bin/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 创建用户（不能使用root启动）</span>
</span></span><span style="display:flex;"><span>adduser k8s
</span></span><span style="display:flex;"><span>passwd k8s
</span></span><span style="display:flex;"><span>sudo groupadd docker
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 添加到用户组</span>
</span></span><span style="display:flex;"><span>sudo usermod -aG docker k8s
</span></span><span style="display:flex;"><span>// 激活用户组
</span></span><span style="display:flex;"><span>newgrp docker
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 启动</span>
</span></span><span style="display:flex;"><span>minikube start
</span></span></code></pre></div><h4 id="基于kubeadm部署">基于kubeadm部署<a href="#基于kubeadm部署" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p><a href="./kubeadm部署.md">kubeadm部署</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 查看node状态</span>
</span></span><span style="display:flex;"><span>kubectl get nodes
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 赋予node 角色信息</span>
</span></span><span style="display:flex;"><span>kubectl label nodes k8s-node1 node-role.kubernetes.io/node<span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 清除node 角色信息</span>
</span></span><span style="display:flex;"><span>kubectl label nodes k8s-node1 node-role.kubernetes.io/node-
</span></span></code></pre></div><h3 id="基本概念与命令">基本概念与命令<a href="#基本概念与命令" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<h4 id="pod">Pod<a href="#pod" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p>一个Pod是一组紧密相关的容器（kubernetes中的基本部署单元），它们总是<code>一起运行在同一个工作节点上（或同一个Linux命名空间中）</code>。<code>每个Pod就相当于一个独立的逻辑机器</code>，拥有自己的IP、主机名、进程等，运行一个应用程序，可以是单个进程的运行在单个容器中，也可以是<code>每个进程都运行在自己的容器中</code>。</p>
<p><img src="https://image.leejay.top/FozNgUDN5hlTyAnD_nittm3RosUs" alt=""></p>
<blockquote>
<ol>
<li>同一个Pod内的多个容器共享相同的Linux命名空间，拥有相同的IP、主机名、网络接口等。</li>
<li>同一个Pod内的容器不能出现相同的端口号，可以通过<code>localhost</code>地址进行互相访问。</li>
<li>默认情况下容器间的目录互相隔离，但是可以通过<code>Volume</code>实现文件目录共享。</li>
</ol>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 创建名为kubia的pod</span>
</span></span><span style="display:flex;"><span>kubectl run kubia --image<span style="color:#f92672">=</span>xiaokexiang/kubia --port <span style="color:#ae81ff">8080</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 获取default的pods列表（显示更详细信息）</span>
</span></span><span style="display:flex;"><span>kubectl get pods -o wide 
</span></span></code></pre></div><ul>
<li>
<h5 id="pod内容器数量的选择">Pod内容器数量的选择<a href="#pod内容器数量的选择" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h5>
</li>
</ul>
<p><img src="https://image.leejay.top/FuccR-aTqHyY9gll868rRIGzUaXg" alt=""></p>
<blockquote>
<ol>
<li>一个容器中不应该包含多个进程，Pod也不需要包含多个容器，多个Pod也不需要部署在同一台工作节点上。</li>
<li>Pod内是否包含多个容器取决于这些容器代表的是一个整体还是相互独立的组件。</li>
</ol>
</blockquote>
<h5 id="基于yaml构建pod">基于Yaml构建Pod<a href="#基于yaml构建pod" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 查看已有pod的yaml</span>
</span></span><span style="display:flex;"><span>kubectl get pod kubia -o yaml
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看yaml中字段含义</span>
</span></span><span style="display:flex;"><span>kubectl explain pods
</span></span><span style="display:flex;"><span>kubectl explain pod.spec
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span> <span style="color:#75715e"># 描述遵循V1版本的Api</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span> <span style="color:#75715e"># 描述一个pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>: <span style="color:#75715e"># 用于描述名称、命令空间、标签等其他容器信息</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kubia </span> <span style="color:#75715e"># pod的名称</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>: <span style="color:#75715e"># pod内容的实际说明，pod的容器、卷和其他数据</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">image</span>: <span style="color:#ae81ff">xiaokexiang/kubia</span> <span style="color:#75715e"># 创建容器需要的镜像</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kubia</span> <span style="color:#75715e"># 容器的名称</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">8080</span> <span style="color:#75715e"># 应用监听的端口号</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span> <span style="color:#75715e"># 应用监听的协议</span>
</span></span></code></pre></div><h5 id="pod基本命令">Pod基本命令<a href="#pod基本命令" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 基于yaml创建pod，无法更新</span>
</span></span><span style="display:flex;"><span>kubectl create -f kubia.yaml
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 当yaml修改时，apply可以更新</span>
</span></span><span style="display:flex;"><span>kubectl apply -f kubia.yaml
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 获取pod的yaml或json格式的配置</span>
</span></span><span style="display:flex;"><span>kubectl get pod kubia -o yaml/json
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看pod日志，默认pod删除日志也会被清空</span>
</span></span><span style="display:flex;"><span>kubectl logs -f kubia
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看多容器pod的日志,查看多容器pod中名为abc容器的日志</span>
</span></span><span style="display:flex;"><span>kubectl logs -f kubia -c abc
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 不通过service实现本地8888端口访问pod8080端口</span>
</span></span><span style="display:flex;"><span>kubectl port-forward kubia 8888:8080
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 删除pod</span>
</span></span><span style="display:flex;"><span>kubectl delete pod kubia
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 删除多个pod</span>
</span></span><span style="display:flex;"><span>kubectl delete pod kubia,kubia-gpu
</span></span></code></pre></div><h5 id="pod的健康检查">Pod的健康检查<a href="#pod的健康检查" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h5>
<ul>
<li>liveness存活探针</li>
</ul>
<p>可以为<code>pod内的每个容器都单独指定存活探针</code>，如果探测失败，那么k8s会定期执行探针并重新启动容器。</p>
<p>可以通过<code>HTTP（状态码）</code>、<code>TCP（建立连接）</code>、<code>EXEC探针（容器内执行命令）</code>进行容器探测。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">name</span>: <span style="color:#ae81ff">kubia-liveness</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>	- <span style="color:#f92672">image</span>: <span style="color:#ae81ff">luksa/kubia-unhealthy</span>
</span></span><span style="display:flex;"><span>	  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kubia</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">livenessProbe</span>: <span style="color:#75715e">#http存活探针</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">httpGet</span>: 
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/  </span> <span style="color:#75715e"># 请求路径</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8080</span>   <span style="color:#75715e">#请求端口</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">15</span> <span style="color:#75715e"># 探针在启动后等待15s再探测</span>
</span></span></code></pre></div><blockquote>
<p>此镜像在五次GET请求后会返回500的错误状态码，k8s检测到后<code>会自动创建新的容器（而不是重启原来的容器）</code>。</p>
<p>通过<code>kubectl desribe pod kubia-liveness</code>查看容器运行的情况。</p>
<p><img src="https://image.leejay.top/FlAUIsxMRVNa0aFd-5mhLjNs24GO" alt=""></p>
</blockquote>
<ul>
<li>Readnesses就绪探针</li>
</ul>
<p>就绪探针定期调用，用来确定特定的Pod是否能接收客户端请求。与存活探针类似，具有<code>Exec探针</code>、<code>HTTP GET探针</code>、<code>TCP Socket探针</code>三种方式。如果就绪探针检查的Pod没有准备就绪，那么是不会被加入到<code>svc</code>服务中的。</p>
<blockquote>
<p>Q：存活探针与就绪探针的区别？</p>
<p>A：就绪探针下，如果容器未通过准备检查，那么<code>不会被终止或重新启动</code>。存活探针会杀死异常的容器并启动新的正常容器来保证Pod正常工作。就绪探针确保只有准备好处理请求的Pod才可以接受请求。如果就绪探测失败，就会<code>从服务中移除该Pod</code>。</p>
</blockquote>
<p><img src="https://image.leejay.top/FpNh6aOeUA7J0hwUml8gEwWPcbP2" alt=""></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ReplicationController</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">name</span>: <span style="color:#ae81ff">kubia-replication</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">app</span>: <span style="color:#ae81ff">kubia</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">app</span>: <span style="color:#ae81ff">kubia</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>			- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kubia</span>
</span></span><span style="display:flex;"><span>			  <span style="color:#f92672">image</span>: <span style="color:#ae81ff">xiaokexiang/kubia</span>
</span></span><span style="display:flex;"><span>			  <span style="color:#f92672">readinessProbe</span>: <span style="color:#75715e">#默认10s检查一次</span>
</span></span><span style="display:flex;"><span>			  	<span style="color:#f92672">exec</span>:
</span></span><span style="display:flex;"><span>			  		<span style="color:#f92672">command</span>:
</span></span><span style="display:flex;"><span>			  		- <span style="color:#ae81ff">ls</span>
</span></span><span style="display:flex;"><span>			  		- <span style="color:#ae81ff">/var/ready</span> <span style="color:#75715e"># 基于EXEC的容器的就绪探针</span>
</span></span><span style="display:flex;"><span>			  <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>			  - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">8080</span>
</span></span></code></pre></div><blockquote>
<p>使用就绪探针，可以使Pod异常时，从所有的SVC中移除。</p>
</blockquote>
<ul>
<li>Headless</li>
</ul>
<p>将服务spec中的clusterIP字段设置为None的服务被称为headless服务。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">annotation</span>:
</span></span><span style="display:flex;"><span>	    <span style="color:#75715e"># 开启：无论pod是否准备完毕都添加到服务中</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">service.alpha.kubernetes.io/tolerate-unready-endpoints</span>: <span style="color:#e6db74">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kubia-headless</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">clusterIP</span>: <span style="color:#ae81ff">None</span> <span style="color:#75715e"># headless 核心</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">8080</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">kubia</span>
</span></span></code></pre></div><blockquote>
<p><code>kubectl  run dnsutils --image=tutum/dnsutils --generator=run-pod/v1 --command -- sleep infinity</code>创建DNS Pod来查看DNS解析。</p>
<p><code>kubectl exec dnsutils nslookup kubia-headless</code>查看Pod是否能够访问。</p>
</blockquote>
<h5 id="replicationcontroller">ReplicationController<a href="#replicationcontroller" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h5>
<p>ReplicationController可以确保它监控的pod始终保持运行状态。ReplicationController通过标签选择器（label）管理一个Pod的多个副本，这样当节点故障时，被ReplicationController管理的Pod会被<code>重新创建</code>。</p>
<ul>
<li>ReplicationController的作用</li>
</ul>
<p><img src="https://image.leejay.top/FhmTtTqgDwYLSRW9xkCEr9sDC1ci" alt=""></p>
<ul>
<li>ReplicationController协调流程</li>
</ul>
<p><img src="https://image.leejay.top/FmQRcwEG8kmqaYnP9oiy6XJtneh0" alt=""></p>
<blockquote>
<p>核心在于<code>标签选择器</code>、<code>replica副本数量</code>、<code>Pod模板</code>。其中<code>replica副本数量</code>的修改会影响现有的Pod。</p>
<p>ReplicationController能够确保<code>一个Pod的持续运行</code>，当集群节点发生故障时，为故障的节点上它管理的所有Pod创建替代副本，能够实现<code>Pod的水平伸缩</code>。</p>
</blockquote>
<ul>
<li>ReplicationController的创建</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ReplicationController</span> <span style="color:#75715e"># 指定类型</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">name</span>: <span style="color:#ae81ff">kubia-replication</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">3</span> <span style="color:#75715e"># 指定副本数量</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">selector</span>: <span style="color:#75715e"># 标签选择器（也可以不写，k8s会从template中提取）</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">app</span>: <span style="color:#ae81ff">kubia</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">template</span>: <span style="color:#75715e"># 设置模板</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">app</span>: <span style="color:#ae81ff">kubia</span> <span style="color:#75715e"># 这里的标签要与标签选择器的相同，否则无限创建容器</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>			- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kubia</span>
</span></span><span style="display:flex;"><span>			  <span style="color:#f92672">image</span>: <span style="color:#ae81ff">xiaokexiang/kubia</span>
</span></span><span style="display:flex;"><span>			  <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>			  - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">8080</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 创建replicationController</span>
</span></span><span style="display:flex;"><span>kubectl apply -f kubia-replication.yaml
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 获取replicationController信息</span>
</span></span><span style="display:flex;"><span>kubectl get rc
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看rc信息</span>
</span></span><span style="display:flex;"><span>kubectl describe rc kubia-replication
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 将某个pod移除rc管理（即修改该pod的label）</span>
</span></span><span style="display:flex;"><span>kubectl label pod kubia app<span style="color:#f92672">=</span>no --overwrite
</span></span><span style="display:flex;"><span>kubectl delete pod kubia
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 编辑replicationController的配置文件</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 修改label</span>
</span></span><span style="display:flex;"><span>kubectl edit rc kubia-replication
</span></span><span style="display:flex;"><span><span style="color:#75715e"># rc水平扩容,副本数为4</span>
</span></span><span style="display:flex;"><span>kubectl scale rc kubia-replication 1--replicas<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 删除rc的同时不删除rc管理的pod</span>
</span></span><span style="display:flex;"><span>kubectl delete rc kubia-replication --cascade<span style="color:#f92672">=</span>false
</span></span></code></pre></div><blockquote>
<p>当我们手动delete pod时，通过<code>kubectl get pods</code>查看</p>
<p><img src="https://image.leejay.top/Fp-q07H4tbqRq_WRe-4fdcQreSlm" alt=""></p>
<p>当我们手动修改ReplicationController中的label标签后</p>
<p><img src="https://image.leejay.top/FvBnV2-NQ893shmPO-Avu3cTixAE" alt=""></p>
</blockquote>
<h5 id="replicaset">ReplicaSet<a href="#replicaset" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h5>
<p>它是新一代的 ReplicationController ，并且将其完全替换掉（ ReplicationController 最终将被弃用）。相比ReplicationController具有如下优势：</p>
<ul>
<li>可以匹配多个标签（env=dev，app=kubia），可以使用通配符进行匹配（env=*）</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span> <span style="color:#75715e"># 属于的版本号</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ReplicaSet</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kubia-replicaset</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>: <span style="color:#75715e"># 基于matchLabels选择器</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">kubia</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">kubia</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kubia</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">xiaokexiang/kubia</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>	      - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">8080</span>
</span></span></code></pre></div><blockquote>
<p>如果节点上已经存在三个<code>app=kubia</code>的Pod，那么创建ReplicaSet后会将这个三个Pod纳入管理。</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 创建replicaSet</span>
</span></span><span style="display:flex;"><span>kubectl apply -f kubia-replicaset.yaml
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 默认情况下如果存在label标签相同的pod会被加入rs的管理</span>
</span></span><span style="display:flex;"><span>kubectl get pods
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看rs</span>
</span></span><span style="display:flex;"><span>kubectl get rs
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看指定rs详情</span>
</span></span><span style="display:flex;"><span>kubectl describe rs kubia-replicaset
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 删除rs但不删除pod</span>
</span></span><span style="display:flex;"><span>kubectl delete rs kubia-replicaset --cascade<span style="color:#f92672">=</span>false
</span></span></code></pre></div><ul>
<li>标签选择器</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span> <span style="color:#75715e"># 属于的版本号</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ReplicaSet</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kubia-replicaset</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchExpressions</span>: <span style="color:#75715e"># 基于matchLabels选择器</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">app</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">operator</span>: <span style="color:#ae81ff">In</span> <span style="color:#75715e"># 除了In，还有NotIn、Exists、DoesNotExist</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">values</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#ae81ff">kubia</span>
</span></span></code></pre></div><h5 id="daemonset">DaemonSet<a href="#daemonset" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h5>
<p>相比ReplicationController（ReplicaSet）将<code>副本随机分配在各个节点上</code>，DaemonSet可以<code>在每个节点上只运行一个Pod副本</code>。它没有期望副本（replicas）的概念，因为它的工作是确保一个Pod匹配它的选择器并在每个节点上运行。</p>
<p>如果节点下线，那么DaemonSet不会在其他地方重新创建Pod，但是当一个新的节点加入集群时，它会立刻部署一个新的Pod的实例。若有人无意中删除一个节点上的Pod，那么DaemonSet会从Pod模板创建并部署一个新的Pod。</p>
<blockquote>
<p>DaemonSet一般用于<code>管理系统服务</code>，即使节点配置了不可调度，DaemonSet也会部署Pod到此节点。需要注意的是：<code>DaemonSet不会将Pod部署在master节点上</code>。</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">DaemonSet</span> <span style="color:#75715e"># 设置DaemonSet类型</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">name</span>: <span style="color:#ae81ff">ssd-monitor</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">selector</span>: <span style="color:#75715e"># 指定标签选择器</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">app</span>: <span style="color:#ae81ff">ssd-monitor</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">app</span>: <span style="color:#ae81ff">ssd-monitor</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">nodeSelector</span>: <span style="color:#75715e"># 这些Pod只能部署到disk=ssd的node节点上</span>
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">disk</span>: <span style="color:#ae81ff">ssd</span>
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>			- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">main</span>
</span></span><span style="display:flex;"><span>			  <span style="color:#f92672">image</span>: <span style="color:#ae81ff">luksa/ssd-monitor</span>
</span></span></code></pre></div><p><img src="https://image.leejay.top/FkbSlaZKNoTvabGr9GyCuGNAwi0Z" alt=""></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 先将节点设置label： disk=ssd</span>
</span></span><span style="display:flex;"><span>kubectl label node k8s-node1 disk<span style="color:#f92672">=</span>ssd
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 创建daemonset</span>
</span></span><span style="display:flex;"><span>kubectl apply -f ssd-monitor-daemonset.yaml
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 我们修改node的标签为disk=hdd，ds管理的pod会被删除</span>
</span></span><span style="display:flex;"><span>kubectl label nodes k8s-node1 disk<span style="color:#f92672">=</span>hdd --overwrite
</span></span></code></pre></div><p><img src="https://image.leejay.top/FvaUT7VzitLYrU55lEbuWJNAyFrv" alt=""><img src="https://image.leejay.top/FrNtnq91RiC-7jf0h33lVbICYBtz" alt=""></p>
<h5 id="job">Job<a href="#job" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h5>
<p>相比之前的ReplicationController、ReplicaSet、DaemonSet持续运行任务，永远达不到完成态。<code>Job</code>提供了Pod在内部进程成功结束时，不重启容器。在发生节点故障时，由Job管理的Pod按照ReplicaSet的Pod方式重新安排到其他节点或<code>进程本身异常退出则重新启动容器</code>。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">batch/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Job</span> <span style="color:#75715e"># 类型为Job</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">name</span>: <span style="color:#ae81ff">batch-job</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">backoffLimit</span>: <span style="color:#ae81ff">6</span> <span style="color:#75715e"># job被标记为失败之前的重试次数，默认为6</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">completions</span>: <span style="color:#ae81ff">5</span>  <span style="color:#75715e"># 使得job顺序运行5个pod（如果其中失败一个，会重启一次，那么最终会超过5个）</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">parallelism</span>: <span style="color:#ae81ff">2</span> <span style="color:#75715e"># pod并行运行的数量，job运行时最多有2个pod在运行</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">app</span>: <span style="color:#ae81ff">batch-job</span> <span style="color:#75715e"># 指定模板的label</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">activeDeadlineSeconds</span>: <span style="color:#ae81ff">10</span> <span style="color:#75715e"># 限制pod的运行时间，超过此时间会终止pod并标记为失败</span>
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">restartPolicy</span>: <span style="color:#ae81ff">OnFailure</span> <span style="color:#75715e">#重启策略不能时Always</span>
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>			- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">main</span>
</span></span><span style="display:flex;"><span>			  <span style="color:#f92672">image</span>: <span style="color:#ae81ff">luksa/batch-job</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 创建job</span>
</span></span><span style="display:flex;"><span>kubectl apply -f job.yaml
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看job</span>
</span></span><span style="display:flex;"><span>kubectl get job
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 删除job，管理的pod也会被删除</span>
</span></span><span style="display:flex;"><span>kubectl delete job batch-job
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 修改job中pod的并行数量</span>
</span></span><span style="display:flex;"><span>kubectl edit job
</span></span></code></pre></div><blockquote>
<p>job管理的Pod任务完成后会显示<code>Completed</code>状态。</p>
</blockquote>
<h5 id="cronjob">CronJob<a href="#cronjob" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h5>
<p>相比Job，CronJob是基于Cron表达式的定时Job任务。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">batch/v1beta1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">CronJob</span> <span style="color:#75715e"># 类型为CronJob</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">name</span>: <span style="color:#ae81ff">batch-cron-job</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">schedule</span>: <span style="color:#e6db74">&#34;*/1 * * * *&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">staringDeadlineSeconds</span>: <span style="color:#ae81ff">15</span> <span style="color:#75715e"># pod必须在指定时间后15s内开始运行</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">jobTemplate</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">batch-job</span> <span style="color:#75715e"># 指定模板的label</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">activeDeadlineSeconds</span>: <span style="color:#ae81ff">10</span> <span style="color:#75715e"># 限制pod的运行时间</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">restartPolicy</span>: <span style="color:#ae81ff">OnFailure</span> <span style="color:#75715e">#重启策略不能时Always</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>                    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">main</span>
</span></span><span style="display:flex;"><span>                      <span style="color:#f92672">image</span>: <span style="color:#ae81ff">luksa/batch-job</span>
</span></span></code></pre></div><blockquote>
<p>Cron表达式不清楚的查看这篇文章<a href="https://leejay.top/post/linux%E4%B8%8Bcron%E5%AE%9A%E6%97%B6%E5%99%A8/">Cron表达式</a>。</p>
</blockquote>
<h4 id="标签label">标签（label）<a href="#标签label" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span> <span style="color:#75715e"># 描述遵循V1版本的Api</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span> <span style="color:#75715e"># 描述一个pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>: <span style="color:#75715e"># 用于描述名称、命令空间、标签等其他容器信息</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kubia </span> <span style="color:#75715e"># pod的名称</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">labels</span>: <span style="color:#75715e"># 创建多个label</span>
</span></span><span style="display:flex;"><span>   	 <span style="color:#f92672">creation_mode</span>: <span style="color:#ae81ff">manual</span>
</span></span><span style="display:flex;"><span>   	 <span style="color:#f92672">env</span>: <span style="color:#ae81ff">prod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>: <span style="color:#75715e"># pod内容的实际说明，pod的容器、卷和其他数据</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">image</span>: <span style="color:#ae81ff">xiaokexiang/kubia</span> <span style="color:#75715e"># 创建容器需要的镜像</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kubia</span> <span style="color:#75715e"># 容器的名称</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">8080</span> <span style="color:#75715e"># 应用监听的端口号</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span> <span style="color:#75715e"># 应用监听的协议</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 查看label标签</span>
</span></span><span style="display:flex;"><span>kubectl get pods --show-labels
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看creation_mode,env两个标签页</span>
</span></span><span style="display:flex;"><span>kubectl get pods -L creation_mode,env
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 给pod添加label标签 -&gt; version: v1</span>
</span></span><span style="display:flex;"><span>kubectl label pod kubia version<span style="color:#f92672">=</span>v1
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 给已有的pod修改标签</span>
</span></span><span style="display:flex;"><span>kubectl label pod kubia env<span style="color:#f92672">=</span>dev --overwrite
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 列出env标签有值的pod</span>
</span></span><span style="display:flex;"><span>kubectl get pods -L env -l env
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 列出env标签值为dev的pod</span>
</span></span><span style="display:flex;"><span>kubectl get pods -L env -l env<span style="color:#f92672">=</span>dev
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 列出符合多个label标签条件的pod</span>
</span></span><span style="display:flex;"><span>kubectl get pods -L env -l env<span style="color:#f92672">=</span>dev,creation_mode<span style="color:#f92672">=</span>manual
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 列出不包含env标签的pod</span>
</span></span><span style="display:flex;"><span>kubectl get pods -L env -l <span style="color:#e6db74">&#39;!env&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 列出env标签值不为dev的pod(包含不存在env标签的值)</span>
</span></span><span style="display:flex;"><span>kubectl get pods -L env -l <span style="color:#e6db74">&#39;env!=dev&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 列出env值 in (prod,env)的数据</span>
</span></span><span style="display:flex;"><span>kubectl get pods -L env -l <span style="color:#e6db74">&#39;env in (prod,dev)&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 列出env值 not in (prod,env)的数据</span>
</span></span><span style="display:flex;"><span>kubectl get pods -L env -l <span style="color:#e6db74">&#39;env not in (prod,dev)&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 删除指定标签的pod</span>
</span></span><span style="display:flex;"><span>kubectl delete pod -l env<span style="color:#f92672">=</span>dev
</span></span></code></pre></div><ul>
<li>
<p>基于label的Pod调度</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 给node添加label -&gt; gpu=true</span>
</span></span><span style="display:flex;"><span>kubectl label node k8s-node1 gpu<span style="color:#f92672">=</span>true
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看gpu=true的node</span>
</span></span><span style="display:flex;"><span>kubectl get node -L gpu -l gpu<span style="color:#f92672">=</span>true
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span> <span style="color:#75715e"># 描述遵循V1版本的Api</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span> <span style="color:#75715e"># 描述一个pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>: <span style="color:#75715e"># 用于描述名称、命令空间、标签等其他容器信息</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kubia-gpu </span> <span style="color:#75715e"># pod的名称</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">creation_mode</span>: <span style="color:#ae81ff">manual</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">env</span>: <span style="color:#ae81ff">prod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>: <span style="color:#75715e"># pod内容的实际说明，pod的容器、卷和其他数据</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">nodeSelector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">gpu</span>: <span style="color:#e6db74">&#34;true&#34;</span>  <span style="color:#75715e"># 只将pod部署到gpu=true的pod上</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">image</span>: <span style="color:#ae81ff">xiaokexiang/kubia</span> <span style="color:#75715e"># 创建容器需要的镜像</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kubia</span> <span style="color:#75715e"># 容器的名称</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">8080</span> <span style="color:#75715e"># 应用监听的端口号</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span> <span style="color:#75715e"># 应用监听的协议</span>
</span></span></code></pre></div></li>
</ul>
<h4 id="注解annotation">注解（annotation）<a href="#注解annotation" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p>相比label而言，annotation不是为了保存标识信息而存在的，不能像label一样进行分组。主要是为了给api或者pod添加说明，且可以容纳更多的信息。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 给pod添加注解</span>
</span></span><span style="display:flex;"><span>kubectl annotate pod kubia test/annotation<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;hello world&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看pod的注解</span>
</span></span><span style="display:flex;"><span>kubectl describe pod kubia
</span></span></code></pre></div><h4 id="命名空间namespace">命名空间（namespace）<a href="#命名空间namespace" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p>相比于label为pod指定一个或多个标签的作用，namespace提供了<code>一个命名空间内的资源名称唯一，两个不同的命名空间允许有相同的资源名称</code>的特性，提供了类似<code>作用域</code>的概念，每个命名空间内的相同资源互不影响。</p>
<blockquote>
<p>命名空间提供了<code>隔离</code>的概念，但网络隔离取决于k8s集群的网络方案。如果网络不隔离的话，通过ip不同命名空间的资源是可以互相访问的。</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 获取所有的命名空间</span>
</span></span><span style="display:flex;"><span>kubectl get ns
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查询指定命名空间下的pod</span>
</span></span><span style="display:flex;"><span>kubectl get pods -n kube-system
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 创建namespace:custom</span>
</span></span><span style="display:flex;"><span>kubectl create ns custom
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 创建指定namespace的pod</span>
</span></span><span style="display:flex;"><span>kubectl apply -f kubia-custom.yaml -n custom
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 删除指定的命名空间（pod也会被删除）</span>
</span></span><span style="display:flex;"><span>kubectl delete ns custom
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 删除当前命名空间下的所有pod</span>
</span></span><span style="display:flex;"><span>kubectl delete pods --all
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 删除当前命名空间的几乎所有资源</span>
</span></span><span style="display:flex;"><span>kubectl delete all --all
</span></span></code></pre></div><h5 id="切换命名空间">切换命名空间<a href="#切换命名空间" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h5>
<ul>
<li>查看当前的namespace</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubectl config view
</span></span></code></pre></div><ul>
<li>添加alias用于快速切换namespace</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 基于alias的命名空间切换,写入别名到.bashrc配置</span>
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt; EOF &gt;&gt; ~/.bashrc
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">alias kcd=&#39;kubectl config set-context $(kubectl config current-context) --namespace&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>source ~/.bashrc
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 切换到custom namespace</span>
</span></span><span style="display:flex;"><span>kcd custom
</span></span></code></pre></div><ul>
<li>不使用alias切换</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 将当前context的namespace修改为default</span>
</span></span><span style="display:flex;"><span>kubectl config set-context --n defaultkubectl config set-context --current --namespace<span style="color:#f92672">=</span>default
</span></span></code></pre></div><h4 id="service">Service<a href="#service" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p>Kubernetes服务是为一组功能相同的Pod<code>提供单一不变的接入点的资源</code>。到达服务IP和端口的请求将被转发到属于该服务内的的容器的IP和端口。</p>
<p>Pod的存在是短暂的，一个Pod可能在任何时候消失，新生成的Pod和原有的Pod具有不同的IP地址，当服务被创建时，会得到一个静态的IP，客户端通过这个IP连接到服务，而不是直接连接Pod。</p>
<p><img src="https://image.leejay.top/FvuVqEyEl5Hy5Ng_cWUcMV3RW7QQ" alt=""></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">name</span>: <span style="color:#ae81ff">kubia</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>	- <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span> <span style="color:#75715e"># 服务可用端口</span>
</span></span><span style="display:flex;"><span>	  <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">8080</span> <span style="color:#75715e"># 服务转发到容器的端口</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">app</span>: <span style="color:#ae81ff">kubia</span> <span style="color:#75715e"># app=kubia的pod都属于该服务</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 将pod暴露成服务，po即pod的缩写</span>
</span></span><span style="display:flex;"><span>kubectl expose po kubia --type<span style="color:#f92672">=</span>LoadBalancer --name kubia-http
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 基于yaml创建service</span>
</span></span><span style="display:flex;"><span>kubectl apply -f kubia
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看服务 svc即service的缩写</span>
</span></span><span style="display:flex;"><span>kubectl get svc
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 集群内的服务访问（--表示k8s命令的结束）</span>
</span></span><span style="display:flex;"><span>kubectl exec kubia -- curl -s http://10.106.78.175
</span></span></code></pre></div><blockquote>
<p><img src="https://image.leejay.top/FkIeSzokhxq-kKyPDkk3kmf5ugxj" alt=""></p>
<p>也可以从Node节点上进行访问或创建Pod进行访问。</p>
<p><img src="https://image.leejay.top/Fk59Yq-ILj98KL7lnQvTqPWPzkHs" alt=""></p>
</blockquote>
<h5 id="服务亲和性">服务亲和性<a href="#服务亲和性" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h5>
<p>默认情况下服务代理通常将每个连接随机指向选中的后端Pod中的一个。如果我们希望客户端的所有请求都指向同一个客户端，配置服务<code>亲和性</code>可以实现该功能。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">name</span>: <span style="color:#ae81ff">kubia</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">sessionAffinity</span>: <span style="color:#ae81ff">ClientIP</span> <span style="color:#75715e"># 此参数会导致每次都请求同一个Pod（默认是None）</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>	- <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span> <span style="color:#75715e"># 服务可用端口</span>
</span></span><span style="display:flex;"><span>	  <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">8080</span> <span style="color:#75715e"># 服务转发到容器的端口</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">app</span>: <span style="color:#ae81ff">kubia</span> <span style="color:#75715e"># app=kubia的pod都属于该服务</span>
</span></span></code></pre></div><blockquote>
<p>请求该Service，都会指向同一个Pod。</p>
</blockquote>
<h5 id="服务暴露多个端口">服务暴露多个端口<a href="#服务暴露多个端口" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># 直接在yaml中配置Service的多port</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">name</span>: <span style="color:#ae81ff">kubia</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>	- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">http</span>
</span></span><span style="display:flex;"><span>	  <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span> <span style="color:#75715e"># 服务可用端口</span>
</span></span><span style="display:flex;"><span>	  <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">8080</span> <span style="color:#75715e"># 服务转发到容器的端口</span>
</span></span><span style="display:flex;"><span>	- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">https</span>
</span></span><span style="display:flex;"><span>	  <span style="color:#f92672">port</span>: <span style="color:#ae81ff">443</span>
</span></span><span style="display:flex;"><span>	  <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">8443</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">app</span>: <span style="color:#ae81ff">kubia</span> <span style="color:#75715e"># app=kubia的pod都属于该服务</span>
</span></span></code></pre></div><blockquote>
<p><code>不同的端口在一个容器中只能适用于一个标签选择器</code>，若想分别对应不同的，需要多个容器。</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># 基于pod的yaml在service进行多port配置</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>	- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">http</span>
</span></span><span style="display:flex;"><span>	  <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">8080</span>
</span></span><span style="display:flex;"><span>	- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">https</span>
</span></span><span style="display:flex;"><span>	  <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">8443</span>
</span></span><span style="display:flex;"><span>	  
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>	- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">http</span>
</span></span><span style="display:flex;"><span>	  <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>	  <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">http</span> <span style="color:#75715e"># Pod中的名称</span>
</span></span><span style="display:flex;"><span>	- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">https</span>
</span></span><span style="display:flex;"><span>	  <span style="color:#f92672">port</span>: <span style="color:#ae81ff">443</span>
</span></span><span style="display:flex;"><span>	  <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">https</span> <span style="color:#75715e"># Pod中的名称</span>
</span></span></code></pre></div><h5 id="endpoint">EndPoint<a href="#endpoint" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h5>
<p>Pod与Service进行通讯是需要通过<code>EndPoint</code>来实现的，我们创建Service时可以不指定<code>标签选择器</code>，这样Service不知道我们需要管理哪些Pod，所以需要我们手动创建EndPoint</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># 创建不带Pod选择器的服务</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">name</span>: <span style="color:#ae81ff">external-service</span> <span style="color:#75715e"># 这个名字必须与service配置名相同</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>	- <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span> <span style="color:#75715e"># 只指定port不指定选择器</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Endpoints</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">name</span>: <span style="color:#ae81ff">external-service</span> <span style="color:#75715e"># 这个名字必须与service配置名相同</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">subsets</span>:
</span></span><span style="display:flex;"><span>	- <span style="color:#f92672">addresses</span>:
</span></span><span style="display:flex;"><span>	  - <span style="color:#f92672">ip</span>: <span style="color:#ae81ff">11.11.11.11</span> <span style="color:#75715e">#服务将连接重定向到endpoint的ip地址</span>
</span></span><span style="display:flex;"><span>	  - <span style="color:#f92672">ip</span>: <span style="color:#ae81ff">22.22.22.22</span>
</span></span><span style="display:flex;"><span>	  <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>	  - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span> <span style="color:#75715e"># endpoint的目标端口</span>
</span></span></code></pre></div><p><img src="https://image.leejay.top/FiEc_ugGyuqbDUbBst6eMU_J1-1o" alt=""></p>
<h5 id="暴露服务给外部客户端">暴露服务给外部客户端<a href="#暴露服务给外部客户端" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h5>
<h6 id="nodeport">NodePort<a href="#nodeport" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h6>
<p>将服务类型设置成NodePort（每个集群节点都会在节点上打开一个端口），该端口接受到的流量重定向到基础服务。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">name</span>: <span style="color:#ae81ff">kubia-nodeport</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">type</span>: <span style="color:#ae81ff">NodePort </span> <span style="color:#75715e"># 为NodePort设置集群IP端口号</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>	- <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span> <span style="color:#75715e"># 服务集群IP的端口号</span>
</span></span><span style="display:flex;"><span>	  <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">8080</span> <span style="color:#75715e"># Pod的目标端口号</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">nodePort</span>: <span style="color:#ae81ff">30123</span> <span style="color:#75715e"># 通过集群节点的30123端口可以访问</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    	<span style="color:#f92672">app</span>: <span style="color:#ae81ff">kubia</span>
</span></span></code></pre></div><blockquote>
<p>用户可以通过<code>$CLUSTER-IP:80</code>、<code>$MASTER-IP:30123</code>或<code>$NODE-IP:30123</code>进行访问。</p>
</blockquote>
<h6 id="loadbalance">LoadBalance<a href="#loadbalance" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h6>
<p>NodePort的一种扩展，服务可以通过一个负载均衡器来访问，负载均衡器将流量重定向到跨所有节点的节点端口，客户端通过负载均衡器的IP连接到服务。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">name</span>: <span style="color:#ae81ff">kubia-loadbalancer</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">externalTrafficcPolicy</span>: <span style="color:#ae81ff">Local</span> <span style="color:#75715e"># 外部访问的将重定向到同一节点上的Pod，不存在就挂起</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">type</span>: <span style="color:#ae81ff">LoadBalancer</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>	- <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>	  <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">8080</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">app</span>: <span style="color:#ae81ff">kubia</span>
</span></span></code></pre></div><blockquote>
<p>LoadBalancer基于NodePort并实现负载均衡，刚创建svc的时候k8s需要一些时间创建负载均衡器。</p>
<p>浏览器基于ip+port访问的时候，我们会发现每次访问的Pod都是相同的？</p>
<p>这和<code>会话亲和性</code>是没有关系的，即使设置成<code>sessionAffinity: None</code>，是因为浏览器基于<code>keep-alive</code>连接，而curl每次都会打开一个新的连接，首次打开与服务的连接时，会随机选择一个新的集群，将所有的数据发送到单个集群。所以只要换个tab页请求就能看到返回的Pod不一样了。</p>
</blockquote>
<h6 id="ingress">Ingress<a href="#ingress" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h6>
<p>创建一个Ingress资源，这是完全不同的机制，通过一个IP地址公开多个服务。</p>
<p><img src="https://image.leejay.top/Fp9nlHS-n9i0lpzFe1fubWC_ktyc" alt=""></p>
<blockquote>
<p>为什么需要Ingress呢？</p>
<p>相比每个LoadBalancer服务都需要自己的负载均衡器以及独有的公网IP地址。Ingress只需要一个公网IP就能够为许多服务提供访问，Ingress会根据客户端的请求的主机名和路径转发到对应的服务。</p>
</blockquote>
<p>我们需要先创建<code>Ingress控制器</code>，继而通过控制器创建Ingress资源进行管理。此处我们安装Nginx-Ingress-Controller。</p>
<ul>
<li>安装Nginx-Ingress-Controller</li>
</ul>
<blockquote>
<p><a href="https://blog.csdn.net/qq_33430322/article/details/113885788">https://blog.csdn.net/qq_33430322/article/details/113885788</a></p>
</blockquote>
<ul>
<li>创建Ingress资源（同一个主机同一个路径）</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span> <span style="color:#75715e"># 属于的版本号</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ReplicaSet</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kubia-replicaset</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>: <span style="color:#75715e"># 基于matchLabels选择器</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">kubia</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">kubia</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kubia</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">xiaokexiang/kubia</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">8080</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kubia</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">type</span>: <span style="color:#ae81ff">NodePort</span> <span style="color:#75715e"># 不要求一定是NodePort</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span> <span style="color:#75715e"># 服务可用端口</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">8080</span> <span style="color:#75715e"># 服务转发到容器的端口</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">nodePort</span>: <span style="color:#ae81ff">30123</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">app</span>: <span style="color:#ae81ff">kubia</span> <span style="color:#75715e"># app=kubia的pod都属于该服务</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">extensions/v1beta1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Ingress</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kubia</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>	- <span style="color:#f92672">host</span>: <span style="color:#ae81ff">kubia.example.com</span>
</span></span><span style="display:flex;"><span>	  <span style="color:#f92672">http</span>:
</span></span><span style="display:flex;"><span>      	<span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>     	- <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/</span>
</span></span><span style="display:flex;"><span>      		<span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">serviceName</span>: <span style="color:#ae81ff">kubia-nodeport</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">servicePort</span>: <span style="color:#ae81ff">80</span> <span style="color:#75715e"># 这里的端口不是30123是80（服务处理的是80）</span>
</span></span></code></pre></div><blockquote>
<ol>
<li><code>kubectl apply -f kubia-replicaset.yaml</code>基于rs创建Pod。</li>
<li><code>kubectl apply -f kubia-servic.yaml</code> 创建svc服务。</li>
<li><code>kubectl get ingress -n ingress-nginx</code>基于svc服务创建ingress。</li>
<li>配置hosts映射，kubia.example.com 映射到 Node的ip地址。</li>
</ol>
</blockquote>
<p><img src="https://image.leejay.top/Fo804pOzRSnMgcGTT2-okuw2hyo2" alt=""></p>
<ul>
<li>创建Ingress资源（同一个主机不同路径）</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">extensions/v1beta1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Ingress</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kubia</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>	- <span style="color:#f92672">host</span>: <span style="color:#ae81ff">kubia.example.com</span>
</span></span><span style="display:flex;"><span>	  <span style="color:#f92672">http</span>:
</span></span><span style="display:flex;"><span>      	<span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>     	- <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/a</span>
</span></span><span style="display:flex;"><span>      		<span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">serviceName</span>: <span style="color:#ae81ff">kubia</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">servicePort</span>: <span style="color:#ae81ff">80</span> <span style="color:#75715e"># 这里的端口不是30123是80（服务处理的是80）</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/b</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">serviceName</span>: <span style="color:#ae81ff">kubia-v2</span> <span style="color:#75715e"># 不同的服务</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">service</span>: <span style="color:#ae81ff">80</span> 
</span></span></code></pre></div><blockquote>
<p><code>curl kubia.example.com/a</code>和<code>curl kubia.example.com/b</code></p>
</blockquote>
<ul>
<li>创建Ingress资源（不同主机不同路径）</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">extensions/v1beta1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Ingress</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kubia</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>	- <span style="color:#f92672">host</span>: <span style="color:#ae81ff">kubia.example.com</span>
</span></span><span style="display:flex;"><span>	  <span style="color:#f92672">http</span>:
</span></span><span style="display:flex;"><span>      	<span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>     	- <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/a</span>
</span></span><span style="display:flex;"><span>      		<span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">serviceName</span>: <span style="color:#ae81ff">kubia</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">servicePort</span>: <span style="color:#ae81ff">80</span> <span style="color:#75715e"># 这里的端口不是30123是80（服务处理的是80）</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">foo.example.com</span>
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">http</span>:
</span></span><span style="display:flex;"><span>       	 <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>       	 - <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/b</span>
</span></span><span style="display:flex;"><span>       	 	 <span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>       	 	   <span style="color:#f92672">serviceName</span>: <span style="color:#ae81ff">kubia-v2</span>
</span></span><span style="display:flex;"><span>       	 	   <span style="color:#f92672">servicePort</span>: <span style="color:#ae81ff">80</span>
</span></span></code></pre></div><blockquote>
<p><code>curl kubia.example.com/a</code>和<code>curl foo.example.com/b</code></p>
</blockquote>
<ul>
<li>Ingress配置TLS认证</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 生成证书</span>
</span></span><span style="display:flex;"><span>openssl genrsa -out tls.key <span style="color:#ae81ff">2048</span>
</span></span><span style="display:flex;"><span>openssl req -new -x509 -key tls.key -out tls.cert -days <span style="color:#ae81ff">360</span> -subj /CN<span style="color:#f92672">=</span>kubia.example.com
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 生成secret</span>
</span></span><span style="display:flex;"><span>kubectl create secret tls tls-secret --cert<span style="color:#f92672">=</span>tls.cert --key<span style="color:#f92672">=</span>tls.key
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">extensions/v1beta1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Ingress</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kubia</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>: 
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">tls</span>: <span style="color:#75715e"># 配置证书</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">hosts</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#ae81ff">kubia.example.com</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">secretName</span>: <span style="color:#ae81ff">tls-secret</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">kubia.example.com</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">http</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>                - <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#f92672">backend</span>: 
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">serviceName</span>: <span style="color:#ae81ff">kubia</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">servicePort</span>: <span style="color:#ae81ff">80</span>
</span></span></code></pre></div><h4 id="卷服务挂载">卷（服务挂载）<a href="#卷服务挂载" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<blockquote>
<p><code>Pod中的每个容器都有自己独立的文件系统</code>，k8s通过<code>定义存储卷</code>来实现Pod在重启后能够识别前一个容器写入卷的所有文件，且存储卷可以被Pod内的所有容器使用。</p>
</blockquote>
<p>k8s的卷是Pod的一个组成部分，不能单独创建和删除。Pod内的每个容器都可以使用卷，但必须要先将它挂载在每个需要访问它的容器中。</p>
<h5 id="卷的类型">卷的类型<a href="#卷的类型" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h5>
<table>
<thead>
<tr>
<th>类型</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>emptyDir</td>
<td>用于存储临时数据的简单空目录</td>
</tr>
<tr>
<td>hostPath</td>
<td>用于将目录从工作节点的文件系统挂载到Pod中</td>
</tr>
<tr>
<td>gitRepo</td>
<td>通过检出git仓库来初始化卷</td>
</tr>
<tr>
<td>nfs</td>
<td>挂载到Pod中的NFS共享卷</td>
</tr>
</tbody>
</table>
<ul>
<li>emptyDir</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">name</span>: <span style="color:#ae81ff">fortune</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>	- <span style="color:#f92672">image</span>: <span style="color:#ae81ff">luksa/fortune</span>
</span></span><span style="display:flex;"><span>  	  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">html_generator</span>
</span></span><span style="display:flex;"><span>  	  <span style="color:#f92672">volumeMounts</span>:
</span></span><span style="display:flex;"><span>  	  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">html</span> <span style="color:#75715e"># 将html的卷挂载在容器内的/var/htdocs中</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/var/htdocs</span>
</span></span><span style="display:flex;"><span>	- <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:alpine</span>
</span></span><span style="display:flex;"><span>  	  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">web-server</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">volumeMounts</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">html</span> <span style="color:#75715e"># 将html的卷挂载在容器内的/usr/share/nginx/html中且是只读的</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/usr/share/nginx/html</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">readOnly</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ports</span>:  <span style="color:#75715e"># nginx暴露的端口号</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">protocol</span>:  <span style="color:#ae81ff">TCP</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumes</span>: <span style="color:#75715e">#创建名为html的emptyDir卷，挂载在上面两个容器中</span>
</span></span><span style="display:flex;"><span>	- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">html</span>
</span></span><span style="display:flex;"><span>  	  <span style="color:#f92672">emptyDir</span>: {}
</span></span><span style="display:flex;"><span>  	<span style="color:#75715e"># emptyDir:</span>
</span></span><span style="display:flex;"><span>  	  <span style="color:#75715e"># medium: Memory # emptyDir的文件会被存储在内存中</span>
</span></span></code></pre></div><blockquote>
<p>在Pod中创建两个容器，基于挂载实现一个容器负责向指定目录写入文件内容，一个容器负责读取这个目录下的文件内容。</p>
</blockquote>
<ul>
<li>gitRepo</li>
</ul>
<p>相比emptyDir，gitRepo只是最初用Git仓库的内容填充了emptyDir。但是并不能和对应的仓库进行同步，卷重的文件不会被更新，但如果Pod是基于ReplicationController（或ReplicaSet）进行管理，那么通过删除Pod，重新创建时卷则会包含最新的内容。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">gitrepo-volume-pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:alpine</span> <span style="color:#75715e"># 创建nginx容器</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">web-server</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumeMounts</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">html</span> <span style="color:#75715e"># 将html挂载到/usr/local/nginx/html目录下</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/usr/local/nginx/html</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">readOnly</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">html</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">gitRepo</span>: <span style="color:#75715e"># 选择gitRepo</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">repository</span>: <span style="color:#ae81ff">https://github.com/luksa/kubia-website-example.git</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">revision</span>: <span style="color:#ae81ff">master</span> <span style="color:#75715e"># 分支</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">directory</span>: <span style="color:#ae81ff">.</span> <span style="color:#75715e"># clone到根目录</span>
</span></span></code></pre></div><blockquote>
<p>或使用<code>gitsync sidecar</code>实现不删除重启容器，将更新内容挂载到目录实现动态更新。</p>
</blockquote>
<ul>
<li>hostPath</li>
</ul>
<p>hostPath卷指向节点文件系统上的特定文件或者目录。在同一个节点上运行并在其hostPath卷中使用相同路径的Pod可以看到相同的文件。</p>
<p><img src="https://image.leejay.top/FoZsxQDiO8dZNKJjEkHMQ6YDIYyl" alt=""></p>
<blockquote>
<p><code>hostPath</code>卷是<code>持久性</code>存储，之前的<code>emptyDir</code>和<code>gitRepo</code>都会随着Pod被删除时删除。</p>
<p>通常用于单节点集群中的持久化部署。</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-hostpath</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:alpine</span> <span style="color:#75715e"># 创建nginx容器</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">web-server</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumeMounts</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">html</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/usr/local/nginx/html</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">html</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">hostPath</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/opt/nginx</span> <span style="color:#75715e"># 挂载节点上的文件系统</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">type</span>: <span style="color:#ae81ff">DirectoryOrCreate</span> <span style="color:#75715e"># 目录不存在就创建</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#       type: FileOrCreate # 文件不存在就创建</span>
</span></span></code></pre></div><blockquote>
<p>我们需要查看Pod在哪个node节点，那么就去node节点上的文件系统查看。</p>
</blockquote>
<h5 id="持久卷与持久卷声明">持久卷与持久卷声明<a href="#持久卷与持久卷声明" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h5>
<p><img src="https://image.leejay.top/Ftq8UQJwkhQKKcvVhRAgl1eO5fec" alt=""></p>
<blockquote>
<p>当集群用户需要在其Pod使用持久化存储时，他们首先创建持久化声明（PersistentVolumeClaim）清单，指定所需要的<code>最低容量要求和访问模式</code>。</p>
<p>持久卷声明可以当作Pod中的一个卷来使用，其他用户不能使用相同的持久卷（除非先删除）。</p>
</blockquote>
<ul>
<li>持久卷</li>
</ul>
<p><code>Persistent Volume（pv）</code>持久卷，相对于<code>Volumes</code>存储一些有必要保存的数据，它主要是为了管理集群的存储。且它相对于Pod独立创建。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># 持久化卷</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">PersistentVolume</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">mongodb-pv</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">capacity</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">storage</span>: <span style="color:#ae81ff">200Mi</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumeMode</span>: <span style="color:#ae81ff">Filesystem</span> <span style="color:#75715e"># 默认值，或设置Block（块设备）</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">accessModes</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">ReadWriteOnce</span> <span style="color:#75715e"># 被单个客户端挂载为读写模式</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">ReadOnlyMany</span> <span style="color:#75715e"># 被多个客户端挂载为读模式</span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e">#- ReadWriteMany # 被多个客户端挂载为读写模式 </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">persistentVolumeReclaimPolicy</span>: <span style="color:#ae81ff">Recycle</span> <span style="color:#75715e"># 当pvc被释放后的操作，pv被回收，或者Retain/delete保留</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">storageClassName</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">local</span>: <span style="color:#75715e"># 基于本地的pv</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/opt</span> <span style="color:#75715e"># 本地磁盘的路径</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">nodeAffinity</span>: <span style="color:#75715e"># 设置Node的亲和性</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">required</span>: <span style="color:#75715e"># 使用此块pv的node必须在k8s-node1上</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">nodeSelectorTerms</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">matchExpressions</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">kubernetes.io/hostname</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">operator</span>: <span style="color:#ae81ff">In</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">values</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#ae81ff">k8s-node1</span>
</span></span></code></pre></div><ul>
<li>持久卷声明</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">PersistentVolumeClaim</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">mongodb-pvc</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">requests</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">storage</span>: <span style="color:#ae81ff">100Mi</span> <span style="color:#75715e"># 申请1GB的空间</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">accessModes</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">ReadWriteOnce</span> <span style="color:#75715e"># 允许单个客户端访问（同时支持读和写）</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">storageClassName</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span></code></pre></div><blockquote>
<p>当我们创建好持久卷声明（pvc）后，k8s会找到适当的持久卷并绑定该声明（<code>持久卷容量必须大于声明的需求</code>）</p>
<ul>
<li>
<p>查看pv<img src="https://image.leejay.top/FidraFaWFpAyG2h2dU9xl3aaHShg" alt=""></p>
</li>
<li>
<p>查看pvc<img src="https://image.leejay.top/FlMTXuf6shrSsakF-dlO83cwsEOI" alt=""></p>
</li>
</ul>
</blockquote>
<ul>
<li>Pod中使用持久卷声明</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">mongodb</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">image</span>: <span style="color:#ae81ff">mongo</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">mongodb</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumeMounts</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">mongodb-data</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/data/db</span> <span style="color:#75715e"># 容器内的/data/db挂载pvc</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">27017</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">protcol</span>: <span style="color:#ae81ff">TCP</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">mongodb-data</span> <span style="color:#75715e"># 与上面的挂载名称对应</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">persistentVolumeClaim</span>:
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">claimName</span>: <span style="color:#ae81ff">mongodb-pvc</span> <span style="color:#75715e"># 此处是上文的pvc名称</span>
</span></span></code></pre></div><blockquote>
<p>将PVC和Pod进行挂载。</p>
<p><img src="https://image.leejay.top/FobLQT8OqAUSBPhp132uRWFdr5n4" alt=""></p>
<p>如果我们删除Pod，那么Pod绑定的PVC还存在，那么新的Pod可以读取前一个Pod存放的数据。我们可以通过配置PV中的<code>persistentVolumeReclaimPolicy</code>参数为<code>Recycle</code>进行回收。</p>
</blockquote>
<h4 id="configmap--secret">ConfigMap &amp; Secret<a href="#configmap--secret" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<h5 id="在容器中指定环境变量">在容器中指定环境变量<a href="#在容器中指定环境变量" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">env-pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">image</span>: <span style="color:#ae81ff">luksa/fortune:env</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">html-generator</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumeMounts</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">local</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/var/htdocs/index.html</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">env</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name: INTERVAL # key java</span>: <span style="color:#ae81ff">System.get(&#34;INTERVAL&#34;)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;30&#34;</span> <span style="color:#75715e"># 字符串不需要引号，数值需要</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">local</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">hostPath</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/opt/nginx/index.html</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">type</span>: <span style="color:#ae81ff">FileOrCreate</span>
</span></span></code></pre></div><blockquote>
<p>参数在Pod的yaml中指定。一旦创建不能修改。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">env</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">name1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">value</span>: <span style="color:#ae81ff">hello</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">name2</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;${name1} world&#34;</span> <span style="color:#75715e"># 引用第一个变量的值</span>
</span></span></code></pre></div></blockquote>
<h5 id="configmap">ConfigMap<a href="#configmap" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h5>
<p>k8st允许将配置分离到单独的资源配置对象ConfigMap中，本质就是一个键值对。应用无需读取ConfigMap，映射的内容通过环境变量或卷文件的形式传递给容器。通过<code>${ENV_VAR}$</code>的形式引用环境变量。</p>
<ul>
<li>基于命令创建</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 创建configMap key-value为 sleep-interval: 25</span>
</span></span><span style="display:flex;"><span>kubectl create configmap fortune-config --from-literal<span style="color:#f92672">=</span>sleep-interval<span style="color:#f92672">=</span><span style="color:#ae81ff">25</span> --from-literal<span style="color:#f92672">=</span>hello<span style="color:#f92672">=</span>world
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 从配置文件中读取value[]</span>
</span></span><span style="display:flex;"><span>kubectl create configmap fortune-config-v2 --from-file<span style="color:#f92672">=</span>custom-key<span style="color:#f92672">=</span>config.conf
</span></span></code></pre></div><ul>
<li>基于yaml创建</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ConfigMap</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">fortune-config</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">data</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">sleep-interval</span>: <span style="color:#e6db74">&#34;25&#34;</span>
</span></span></code></pre></div><ul>
<li>ConfigMap中某个条目作为环境变量</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">fortune-env-configmap</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">image</span>: <span style="color:#ae81ff">luksa/forune:env</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">env</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">INTERVAL </span> <span style="color:#75715e"># key</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># value来自fortune-config中的sleep-interval</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">valueFrom</span>: 
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">configMapKeyRef</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">fortune-config</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">key</span>: <span style="color:#ae81ff">sleep-interval</span>
</span></span></code></pre></div><blockquote>
<p>如果ConfigMap不存在，那么Pod会启动失败，等到此ConfigMap存在了就自动启动，无需重新创建。</p>
</blockquote>
<ul>
<li>ConfigMap的所有条目作为环境变量</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">fortune-env-all-pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">image</span>: <span style="color:#ae81ff">luksa/fortune:env</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">envFrom</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">prefix</span>: <span style="color:#ae81ff">CONFIG_ </span> <span style="color:#75715e"># 所有的前缀都加上CONFIG_</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">configMapRef</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">fortune-env</span> <span style="color:#75715e"># 引用哪个configmap</span>
</span></span></code></pre></div><blockquote>
<p>如果ConfigMap中存在非法的key（例如hello-world），那么创建环境变量时会被自动忽略。</p>
</blockquote>
<ul>
<li>ConfigMap中的某个条目作为命令行参数</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">fortune-arg-configmap</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">image</span>: <span style="color:#ae81ff">luksa/fortune:args</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">env</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">INTERVAL</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">valueFrom</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">configMapKeyRef</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">fortune-config</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">key</span>: <span style="color:#ae81ff">sleep-interval</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">args</span>: [<span style="color:#e6db74">&#34;${INTERVAL}&#34;</span>]
</span></span></code></pre></div><ul>
<li>基于文件传递大配置文件</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 创建nginx配置文件</span>
</span></span><span style="display:flex;"><span>cat &gt;&gt; ./nginx-config.conf <span style="color:#e6db74">&lt;&lt;EOF 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  server {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   listen    80;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   server_name www.kubia-example.com;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   gzip on;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   gzip_types text/plain application/xml;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   localtion / {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     root /usr/share/nginx/html;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     index index.html index.htm;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 基于文件创建配置</span>
</span></span><span style="display:flex;"><span>kubectl create configmap fortune-config --from-file<span style="color:#f92672">=</span>nginx.conf
</span></span></code></pre></div><ul>
<li>基于yaml传递大配置文件</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># configMap</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ConfigMap</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">fortune-config</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">data</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">my-nginx-config</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    server {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      listen 80;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      server_name www.kubia-example.com;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      gzip on;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      gzip_type text/plain application/xml;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      location / {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        root /usr/share/nginx/html;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        index index.html index.htm;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    }</span>    
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">sleep-interval</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    </span>    <span style="color:#ae81ff">25</span>
</span></span></code></pre></div><blockquote>
<p>configMap的namespace必须与pod的相同，且创建早于Pod。</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">fortune-configmap-volume</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.19.2</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">web-server</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumeMounts</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">config</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/etc/nginx/conf.d</span> <span style="color:#75715e">#容器内部挂载的容器</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">readOnly</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">config</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">configMap</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">fortune-config</span> <span style="color:#75715e"># 引用上文创建的CM</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">defaultMode</span>: <span style="color:#ae81ff">0777</span> <span style="color:#75715e"># 设置权限</span>
</span></span></code></pre></div><blockquote>
<p>如果我们不想挂载整个卷，只想挂载某个文件，可以进行如下配置：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">config</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">configMap</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">fortune-config</span> <span style="color:#75715e"># 引用上文创建的CM</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">items</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">my-nginx-config</span> <span style="color:#75715e"># 指定对应的key</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">path</span>: <span style="color:#ae81ff">gzip.conf</span> <span style="color:#75715e"># 将值存储在这个文件中</span>
</span></span></code></pre></div><p><code>默认情况下挂载文件夹内的原有文件会被隐藏。</code>如果我们想原有的文件不被隐藏，需要使用<code>subPath</code>参数。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">volumeMounts</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">config</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/etc/something.conf</span> <span style="color:#75715e"># 挂载至某一文件</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">subPath</span>: <span style="color:#ae81ff">myconfig.conf</span> <span style="color:#75715e"># 挂载指定cm：config中的条目</span>
</span></span></code></pre></div><p><code>整个卷挂载</code>的文件在修改后会被应用监听到进行重载，<code>只挂载部分文件</code>则不会进行热更新。</p>
</blockquote>
<h5 id="secret">Secret<a href="#secret" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h5>
<ul>
<li>默认令牌Secret</li>
</ul>
<p>每个Pod都会被自动挂载上一个Secret卷，包含三个条目：<code>ca.crt</code>、<code>namespace</code>、<code>token</code>。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 查看secret下的文件</span>
</span></span><span style="display:flex;"><span>kubectl exec pod ls /var/run/secrets/kubernetes.io/serviceaccount/
</span></span></code></pre></div><ul>
<li>创建secret</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 生成证书</span>
</span></span><span style="display:flex;"><span>openssl genrsa -out https.key <span style="color:#ae81ff">2048</span>
</span></span><span style="display:flex;"><span>openssl req -new -x509 -key https.key -out https.cert -days <span style="color:#ae81ff">360</span> -subj /CN<span style="color:#f92672">=</span>www.kubia-example.com
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 生成secret</span>
</span></span><span style="display:flex;"><span>kubectl create secret generic fortune-https --from-file<span style="color:#f92672">=</span>https.key --from-file<span style="color:#f92672">=</span>https.cert --from-file<span style="color:#f92672">=</span>foo
</span></span></code></pre></div><blockquote>
<p>上文在基于ingress处理网络时就使用了secret。</p>
</blockquote>
<ul>
<li>查看secret</li>
</ul>
<p><img src="https://image.leejay.top/FrQrlr-tf5mO-p10qKILkz0hXEGZ" alt=""></p>
<blockquote>
<p>secret中的data会经过<code>base64</code>编码处理。目的是为了二进制数据也可以转换为纯文本。</p>
</blockquote>
<ul>
<li>Pod中使用secret</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># configMap</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ConfigMap</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">fortune-config</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">data</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">my-nginx-config.conf</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    server {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      listen                80;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      listen                443 ssl;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      server_name           www.kubia-example.com;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      ssl_certificate       certs/https.cert;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      ssl_certificate_key   certs/https.key;  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      ssl_protocols         TLSv1 TLSv1.1 TLSv1.2;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      ssl_ciphers           HIGH:!aNULL:!MD5;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      location / {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        root /usr/share/nginx/html;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        index index.html index.htm;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     }</span>    
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">sleep-interval</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    </span>    <span style="color:#ae81ff">25</span>
</span></span></code></pre></div><blockquote>
<p>配置文件的当前目录是<code>/etc/nginx</code>。</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">fortune-https</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">image</span>: <span style="color:#ae81ff">luksa/fortune:env</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">html-generator</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">env</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">INTERVAL</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">valueFrom</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">configMapKeyRef</span>: <span style="color:#75715e"># 获取cm中的value</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">fortune-config</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">key</span>: <span style="color:#ae81ff">sleep-interval</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumeMounts</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">html</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/var/htdocs</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.19.2</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">web-server</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumeMounts</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">html</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/usr/share/nginx/html</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">readOnly</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">config </span> <span style="color:#75715e"># https.conf 放到此目录下</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/etc/nginx/conf.d</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">readOnly</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">certs</span> <span style="color:#75715e"># secret中存放的证书放到此目录下</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/etc/nginx/certs/</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">readOnly</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">443</span>
</span></span><span style="display:flex;"><span>  :
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">html</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">emptyDir</span>: {}
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">config</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">configMap</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">fortune-config</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">items</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">my-nginx-config.conf</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">path</span>: <span style="color:#ae81ff">https.conf</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">certs</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">secret</span>: <span style="color:#75715e"># 将secret挂载，需要和https.conf</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">secretName</span>: <span style="color:#ae81ff">fortune-https</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># 基于环境变量使用secret</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">fortune-https</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">image</span>: <span style="color:#ae81ff">luksa/fortune:env</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">html-generator</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">env</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">FOO_SECRET</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">valueFrom</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">secretKeyRef</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">fortune-https</span> <span style="color:#75715e">#secret名称</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">key</span>: <span style="color:#ae81ff">foo</span> <span style="color:#75715e"># 对应的key</span>
</span></span></code></pre></div><blockquote>
<p><code>curl https://localhost -k</code>进行https测试。</p>
</blockquote>
<h4 id="downward-api">Downward API<a href="#downward-api" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p>将Pod的元数据（<code>事先无法知道的数据，ex Pod名</code>，Yaml中已定义的数据）通过<code>环境变量或文件</code>的方式给Pod内的容器调用。</p>
<p><img src="https://image.leejay.top/Fo2PkMv00ZDKljelL67DkSjDjfE1" alt=""></p>
<blockquote>
<p>Pod manifest是预先定义的数据，还有容器运行后才知道的数据，都交予downwardAPI进行暴露。</p>
</blockquote>
<p>DownwardAPI可以传递：<code>Pod名称</code>、<code>Pod IP</code>、<code>Pod的ns</code>、<code>Pod运行节点的名称</code>、<code>Pod运行所属服务账号的名称</code>、<code>每个容器请求的CPU和内存使用量</code>、<code>每个容器可以使用的CPU和内存的限制</code>、<code>Pod的标签</code>、<code>Pod的注解</code>。</p>
<ul>
<li>基于环境变量暴露</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">downward</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">main</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;sleep&#34;</span>, <span style="color:#e6db74">&#34;99999999&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">requests</span>: <span style="color:#75715e"># 限制cpu和内存大小</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">100m</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">90Mi</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">limits</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">100m</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">90Mi</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">env</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">POD_NAME</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">valueFrom</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">fieldRef</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">fieldPath</span>: <span style="color:#ae81ff">metadata.name</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">POD_NAMESPACE</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">valueFrom</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">fieldRef</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">fieldPath</span>: <span style="color:#ae81ff">metadata.namespace</span>
</span></span><span style="display:flex;"><span>	- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">POD_IP</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">valueFrom</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">fieldRef</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">fieldPath</span>: <span style="color:#ae81ff">status.podIP</span>
</span></span><span style="display:flex;"><span>	- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">NODE_NAME</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">valueFrom</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">fieldRef</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">fieldPath</span>: <span style="color:#ae81ff">spec.nodeName</span>
</span></span><span style="display:flex;"><span>	- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">SERVICE_ACCOUNT</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">valueFrom</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">fieldRef</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">fieldPath</span>: <span style="color:#ae81ff">spec.serviceAccountName</span>
</span></span><span style="display:flex;"><span>	- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">CONTAINER_CPU_REQUEST_MILLICORES</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">valueFrom</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">resourceFieldRef</span>:
</span></span><span style="display:flex;"><span>	      <span style="color:#f92672">resource</span>: <span style="color:#ae81ff">requests.cpu</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">divisor</span>: <span style="color:#ae81ff">1m</span> <span style="color:#75715e"># 定义基数单位 </span>
</span></span><span style="display:flex;"><span>	- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">CONTAINER_MEMORY_LIMIT_KIBIBYTES</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">valueFrom</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">resourceFieldRef</span>:
</span></span><span style="display:flex;"><span>	      <span style="color:#f92672">resource</span>: <span style="color:#ae81ff">limits.memory</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">divisor</span>: <span style="color:#ae81ff">1Ki</span> <span style="color:#75715e"># 定义基数单位 </span>
</span></span></code></pre></div><blockquote>
<p>通过查看Pod的环境变量，确定DownwardAPI是否生效</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubectl exec downward -- env
</span></span></code></pre></div><p><img src="https://image.leejay.top/Fghh0IPjOfaMPgd-7nAAiQGeGkz4" alt=""></p>
</blockquote>
<ul>
<li>基于卷暴露</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">downward2</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">foo</span>: <span style="color:#ae81ff">bar</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">key1</span>: <span style="color:#ae81ff">value1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">key2</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      multi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      line
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      value</span>      
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">main</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;sleep&#34;</span>, <span style="color:#e6db74">&#34;99999999&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">requests</span>: <span style="color:#75715e"># 限制cpu和内存大小</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">100m</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">90Mi</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">limits</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">100m</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">90Mi</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumeMounts</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">downward</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/etc/downward</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">downward</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">downwardAPI</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">items</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">path</span>: <span style="color:#e6db74">&#34;podName&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">fieldRef</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">fieldPath</span>: <span style="color:#ae81ff">metadata.name</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">path</span>: <span style="color:#e6db74">&#34;podNamespace&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">fieldRef</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">fieldPath</span>: <span style="color:#ae81ff">metadata.namespace</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">path</span>: <span style="color:#e6db74">&#34;labels&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">fieldRef</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">fieldPath</span>: <span style="color:#ae81ff">metadata.labels</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">path</span>: <span style="color:#e6db74">&#34;annotations&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">fieldRef</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">fieldPath</span>: <span style="color:#ae81ff">metadata.annotations</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">path</span>: <span style="color:#e6db74">&#34;containerCpuRequestMilliCores&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">resourceFieldRef</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">containerName</span>: <span style="color:#ae81ff">main</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">resource</span>: <span style="color:#ae81ff">requests.cpu</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">divisor</span>: <span style="color:#ae81ff">1m</span> <span style="color:#75715e"># 定义基数单位 </span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">path</span>: <span style="color:#e6db74">&#34;containerMemoryLimitBytes&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">resourceFieldRef</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">containerName</span>: <span style="color:#ae81ff">main</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">resource</span>: <span style="color:#ae81ff">limits.memory</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">divisor</span>: <span style="color:#ae81ff">1Ki</span> <span style="color:#75715e"># 定义基数单位</span>
</span></span></code></pre></div><blockquote>
<p><code>kubectl exec downward2 -- ls -lL /etc/downward</code></p>
<p><img src="https://image.leejay.top/FjwibRAMwynGFzv_weiLA1htDV4l" alt=""></p>
</blockquote>
<h4 id="kubernetes-api">Kubernetes API<a href="#kubernetes-api" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 查看集群信息</span>
</span></span><span style="display:flex;"><span>kubectl cluster-info
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 开启代理</span>
</span></span><span style="display:flex;"><span>kubectl proxy
</span></span><span style="display:flex;"><span>&gt; Starting to serve on 127.0.0.1:8001
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看Kubernetes API</span>
</span></span><span style="display:flex;"><span>curl localhost:8001
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 在拥有svc服务的pod上访问</span>
</span></span><span style="display:flex;"><span>curl https://kubernetes -k
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 将CA证书写入环境变量</span>
</span></span><span style="display:flex;"><span>export CURL_CA_BUNDLE<span style="color:#f92672">=</span>/var/run/secrets/kubernetes.io/serviceaccount/ca.crt
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 为API服务器授权</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 1. 将token作为环境变量</span>
</span></span><span style="display:flex;"><span>TOKEN<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>cat /var/run/secrets/kubernetes.io/serviceaccount/token<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2. curl访问</span>
</span></span><span style="display:flex;"><span>curl -H <span style="color:#e6db74">&#34;Authorization: Bearer </span>$TOKEN<span style="color:#e6db74">&#34;</span> https://kubernetes
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># 基于ambassador容器简化与API服务器的交互</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">curl-with-ambassador</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">main</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">tutum/curl</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;sleep&#34;</span>, <span style="color:#e6db74">&#34;9999999&#34;</span>]
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ambassador</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">luksa/kubectl-proxy:1.6.2</span>
</span></span></code></pre></div><h3 id="deployment">Deployment<a href="#deployment" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<h4 id="更新策略">更新策略<a href="#更新策略" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<ul>
<li>直接删除所有现有的pod，然后创建新的pod（<code>存在一段时间服务不可用</code>）。</li>
<li>创建新的pod，等待成功运行后，再删除旧的pod（<code>需要更多的硬件资源</code>）。</li>
<li>创建新的pod，等待成功运行后，按照创建顺序删除旧的pod（又称为<code>滚动升级</code>）。</li>
</ul>
<p>Deployment是一种更高阶资源，用于部署应用程序并以<code>声明的方式</code>升级应用（RS和RC属于更底层的概念）。当创建一个Deployment时，ReplicaSet资源也会随之创建，实际的Pod是由Deployment的ReplicaSet创建和管理的，而不是Deployment直接创建和管理。</p>
<blockquote>
<p>Deployment可以用于协调多个RC来管理Pod，实现Pod的升级、扩容等功能。</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># Deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kubia-deployment-v1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">kubia</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">kubia</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">kubia</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nodejs</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">luksa/kubia:v1</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#75715e"># service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kubia</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">sessionAffinity</span>: <span style="color:#ae81ff">ClientIP</span> <span style="color:#75715e"># 默认None</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">LoadBalancer</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span> <span style="color:#75715e"># 服务可用端口</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">8080</span> <span style="color:#75715e"># 服务转发到容器的端口</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">kubia</span> <span style="color:#75715e"># app=kubia的pod都属于该服务</span>
</span></span></code></pre></div><blockquote>
<p><code>kubectl apply -f kubia-deployment-v1.yaml --record</code></p>
<p>Deployment会负责创建一个ReplicaSet管理Pods，<code>--record</code>用于记录历史版本号。</p>
<p><code>kubectl rollout status deployment kubia-deployment-v1</code>查看升级状态。</p>
</blockquote>
<h4 id="deployment升级">Deployment升级<a href="#deployment升级" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p>默认情况下是执行<code>滚动升级（RollingUpdate）</code>策略。还有<code>删除再创建（Recreate）</code>策略，一次删除全部旧的Pod再创建新的Pod。需要注意的是，只有我们<code>修改了Pod模板</code>才会导致Deployment的更新。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 减缓滚动升级速度,patch命令修改Deployment的自有属性，不会触发Pod的任何更新</span>
</span></span><span style="display:flex;"><span>kubectl patch deployment kubia-deployment-v1 -p <span style="color:#e6db74">&#39;{&#34;spec&#34;: {&#34;minReadySeconds&#34;: 10}}&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 更新镜像为luksa:v2</span>
</span></span><span style="display:flex;"><span>kubectl set image deployment kubia-deployment-v1 nodejs<span style="color:#f92672">=</span>luksa/kubia:v2
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 循环请求服务（开窗口并行）</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> true; <span style="color:#66d9ef">do</span> curl 10.110.71.58; sleep 2; <span style="color:#66d9ef">done</span>
</span></span></code></pre></div><blockquote>
<p>执行滚动升级后，新的容器启动后会依次关闭旧的容器。
<img src="https://image.leejay.top/FmZFe4RW8DYoHNd-XzpFGBOrKrS9" alt=""></p>
<p><img src="https://image.leejay.top/Ft-OGwUJpSsUoP4-I8-Knkwoojd2" alt=""></p>
<p>另一边我们可以看到请求的响应由V1变为了V2。<img src="https://image.leejay.top/Fm9IKNeQZbAwue3BZZNQddMjo0KB" alt=""></p>
</blockquote>
<h4 id="deployment修改方式">Deployment修改方式<a href="#deployment修改方式" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<table>
<thead>
<tr>
<th>方法</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>kubectl edit</strong></td>
<td>使用默认编辑器打开资源配置。<code>kubectl edit deployment kubia</code></td>
</tr>
<tr>
<td><strong>kubectl patch</strong></td>
<td>修改单个属性。<code>kubectl patch deployment Kubia -p '{&quot;spec&quot;: {&quot;minReadySeconds&quot;: 10}}'</code></td>
</tr>
<tr>
<td><strong>kubectl apply</strong></td>
<td>通过完整的yaml或json文件修改对象。<code>kubectl apply -f kubia.yaml</code></td>
</tr>
<tr>
<td><strong>kubectl replace</strong></td>
<td>替换原有yaml或json创建的对象。<code>kubectl replace -f kubia.yaml</code></td>
</tr>
<tr>
<td><strong>kubectl setimage</strong></td>
<td>修改pod、rc、rs、deploymeny、ds、job内的镜像。<code>kubectl set image deployment kubia nodejs=luksa:v2</code></td>
</tr>
</tbody>
</table>
<h4 id="deployment回滚">Deployment回滚<a href="#deployment回滚" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 升级到v3版本用于后面回滚</span>
</span></span><span style="display:flex;"><span>kubectl set image deployment kubia-deployment-v1 nodejs<span style="color:#f92672">=</span>luksa/kubia:v3
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 回滚当前版本到上一个版本</span>
</span></span><span style="display:flex;"><span>kubectl rollout undo deployment kubia-deployment-v1
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看滚动升级历史</span>
</span></span><span style="display:flex;"><span>kubectl rollout history deployment kubia-deployment-v1
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 回滚到指定版本（history可以看到）</span>
</span></span><span style="display:flex;"><span>kubectl rollout undo deployment kubia-deployment-v1 --to-revision<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 暂停升级</span>
</span></span><span style="display:flex;"><span>kubectl rollout pause deployment kubia-deployment-v1
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 恢复升级</span>
</span></span><span style="display:flex;"><span>kubectl rollout resume deployment kubia-deployment-v1
</span></span></code></pre></div><blockquote>
<p>如果在升级过程中运行回滚，那么会直接停止滚动升级。已创建的Pod会被老Pod替代。</p>
</blockquote>
<h4 id="deployment升级策略">Deployment升级策略<a href="#deployment升级策略" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kubia-deployment-v1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">kubia</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">minReadySeconds</span>: <span style="color:#ae81ff">10</span>  <span style="color:#75715e"># Pod需要至少运行10s后才能视为可用（探针）</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">strategy</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rollingUpdate</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">maxSurge</span>: <span style="color:#ae81ff">1</span> <span style="color:#75715e"># 基于期望的副本数上Pod最多允许超过的数量（3+1）</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">maxUnavailable</span>: <span style="color:#ae81ff">0</span> <span style="color:#75715e"># 最多不可以Pod数量</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">RollingUpdate</span> <span style="color:#75715e"># 滚动升级</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">kubia</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">kubia</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nodejs</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">luksa/kubia:v1</span>
</span></span></code></pre></div><p><img src="https://image.leejay.top/Fk9PDjz3r31aO1q4uPLMF9Qx34Fa" alt=""></p>
<h4 id="deployment配置就绪探针">Deployment配置就绪探针<a href="#deployment配置就绪探针" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kubia-deployment-v1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">kubia</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">minReadySeconds</span>: <span style="color:#ae81ff">10</span>  <span style="color:#75715e"># Pod需要至少运行10s后才能视为可用（用于就绪探针工作）</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">progressDeadlineSeconds</span>: <span style="color:#ae81ff">300</span> <span style="color:#75715e"># 设置滚动升级超过5分钟就失败</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">strategy</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rollingUpdate</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">maxSurge</span>: <span style="color:#ae81ff">1</span> <span style="color:#75715e"># 基于期望的副本数上Pod最多允许超过的数量（3+1）</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">maxUnavailable</span>: <span style="color:#ae81ff">0</span> <span style="color:#75715e"># 最多不可以Pod数量</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">RollingUpdate</span> <span style="color:#75715e"># 滚动升级</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">kubia</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">kubia</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nodejs</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">luksa/kubia:v1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">readinessProbe</span>: <span style="color:#75715e"># 定义就绪探针每隔1s执行依次</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">httpGet</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/ </span> <span style="color:#75715e"># 发送http get请求</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8080</span>
</span></span></code></pre></div><blockquote>
<p>当Deployment进行Pod升级的时候，就绪探针每隔1s会发起一次请求，请求失败后被标记为<code>未就绪</code>。<img src="https://image.leejay.top/Fi2BLLwSimFPEcFghGrNXhNurtwk" alt=""></p>
<p>Pod成功的有3个，没有ready的就是就绪探针探测不可用的Pod（升级失败）。</p>
<p>默认<code>10分钟</code>内不能完成滚动升级，就会视为失败。<img src="https://image.leejay.top/FtGEDC_M-jGuiXty8nVjwlpReyws" alt=""></p>
</blockquote>
<h3 id="statefulset">StatefulSet<a href="#statefulset" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>它是专门定制的类应用，这类应用中的每一个实例都是不可替代的个体，都有稳定的名字、存储和状态。而这些Pod又称为<code>有状态Pod</code>。</p>
<blockquote>
<p>相比于ReplicaSet、ReplicaController，StatefulSet创建的<code>Pod应用都可以拥有一组独立的数据卷</code>，且创建的Pod名字都是规律的，不是随机的。StatefulSet在某个节点失效时，创建与之前<code>一模一样</code>的Pod，而其他的则是使用一个不相干的新的Pod替换。并且<code>修改StatefulSet的配置后并不会重新启动Pod（删除Pod可以触发）</code>，这点和RS相同。</p>
<p><img src="https://image.leejay.top/Fs_BdvUPHXrdxCft8aWwrDpEx21F" alt=""></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># 需要创建持久卷,statefulset里面几个副本就创建几个持久卷</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">PersistentVolume</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pv</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">capacity</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">storage</span>: <span style="color:#ae81ff">200Mi</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumeMode</span>: <span style="color:#ae81ff">Filesystem</span> <span style="color:#75715e"># 默认值，或设置Block（块设备）</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">accessModes</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">ReadWriteOnce</span> <span style="color:#75715e"># 被单个客户端挂载为读写模式</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">ReadOnlyMany</span> <span style="color:#75715e"># 被多个客户端挂载为读模式</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">ReadWriteMany</span> <span style="color:#75715e"># 被多个客户端挂载为读写模式 </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">persistentVolumeReclaimPolicy</span>: <span style="color:#ae81ff">Recycle</span> <span style="color:#75715e"># 当pvc被释放后的操作，pv被回收</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">local</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/opt</span> <span style="color:#75715e"># 本地磁盘的路径</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">nodeAffinity</span>: <span style="color:#75715e"># 设置Node的亲和性</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">required</span>: <span style="color:#75715e"># 使用此块pv的node必须在k8s-node1上</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">nodeSelectorTerms</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">matchExpressions</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">kubernetes.io/hostname</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">operator</span>: <span style="color:#ae81ff">In</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">values</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#ae81ff">k8s-node1</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># 需要先创建用于有状态Pod之间提供网络标识的headless service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kubia-stateful</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">clusterIP</span>: <span style="color:#ae81ff">None</span> <span style="color:#75715e"># headless核心</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">kubia</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">http</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># statefulSet</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1beta1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">StatefulSet</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kubia-stateful</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">serviceName</span>: <span style="color:#ae81ff">kubia</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">kubia</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">kubia</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kubia</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">luksa/kubia-pet</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">http</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">8080</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">volumeMounts</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">data</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/var/data</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumeClaimTemplates</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">data</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">requests</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">storage</span>: <span style="color:#ae81ff">1Mi</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">accessModes</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">ReadWriteOnce</span>
</span></span></code></pre></div><blockquote>
<p><code>statefulSet</code>会等到第一个Pod启动完毕后才会启动第二个Pod。如果某个Pod被删除，那么statefulSet会创建一个新的Pod（标识符、存储相同的新Pod，<code>新旧Pod不一定会在一个node上</code>）。</p>
<p><img src="https://image.leejay.top/FgjEI4fIfZEuQeKMB_HqPOsyoLA3" alt=""></p>
<p>我们可以通过<code>curl -X POST -d &quot;Hey there! This greeting was submitted to kubia-0. &quot; localhost:8001/api/v1/namespaces/default/pods/kubia-stateful-0/proxy/</code>前后访问两次来判断新旧Pod是否使用相同的存储空间和标识符。</p>
<p>如果我们需要对statefulSet进行缩容，那么会<code>优先删除索引值高</code>的Pod，然后再删除索引值次高的。</p>
</blockquote>

      </div></div>

  
  
<div class="pagination">
    <div class="pagination__title">
        <span class="pagination__title-h">其他文章</span>
        <hr />
    </div>
    <div class="pagination__buttons">
        
        <span class="button previous">
            <a href="https://leejay.top/post/%E5%85%B3%E4%BA%8Eenableaspectjautoproxy%E6%B3%A8%E8%A7%A3%E5%BC%95%E5%87%BA%E7%9A%84%E8%8B%A5%E5%B9%B2%E9%97%AE%E9%A2%98/">
                <span class="button__icon">←</span>
                <span class="button__text">关于EnableAspectJAutoProxy注解引出的若干问题</span>
            </a>
        </span>
        
        
        <span class="button next">
            <a href="https://leejay.top/post/hashmap%E7%9A%84%E5%87%A0%E7%82%B9%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9/">
                <span class="button__text">HashMap的几点注意事项</span>
                <span class="button__icon">→</span>
            </a>
        </span>
        
    </div>
</div>

  

  

</div>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright copyright--user">
        <span>苏ICP备18050258号</span>
    
        
      </div>
  </div>
</footer>

<script src="https://leejay.top/assets/main.js"></script>
<script src="https://leejay.top/assets/prism.js"></script>







  
</div>

</body>
</html>
