<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>Future</title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="description" content="Future public interface Future&amp;lt;V&amp;gt; { // è·å–ä»»åŠ¡ç»“æœ  V get() throws InterruptedException, ExecutionException; // è·å–ä»»åŠ¡ç»“æœï¼Œå¸¦è¶…æ—¶æœºåˆ¶  V get(long timeout, TimeUnit unit) throws InterruptedException, ExecutionException, TimeoutException; // ä»»åŠ¡æ˜¯å¦å®Œæˆ  boolean isDone(); // ä»»åŠ¡æ˜¯å¦å–æ¶ˆ  boolean isCancelled(); // å–æ¶ˆä»»åŠ¡  boolean cancel(boolean mayInterruptIfRunning); } ThreadPoolExecutorä¸­çš„submitæ–¹æ³•æ˜¯ç”±ä»–çš„çˆ¶ç±»AbstractExecutorServiceå®ç°çš„
public &amp;lt;T&amp;gt; Future&amp;lt;T&amp;gt; submit(Callable&amp;lt;T&amp;gt; task) { if (task == null) throw new NullPointerException(); // å°è£…callableå¯¹è±¡  RunnableFuture&amp;lt;T&amp;gt; ftask = newTaskFor(task); // å†è°ƒç”¨çº¿ç¨‹æ± çš„executeæ–¹æ³•  execute(ftask); // è¿”å›FutureTask  return ftask; } // å°†callableä½œä¸ºå‚æ•°ä¼ å…¥FutureTaskå¯¹è±¡ protected &amp;lt;T&amp;gt; RunnableFuture&amp;lt;T&amp;gt; newTaskFor(Callable&amp;lt;T&amp;gt; callable) { return new FutureTask&amp;lt;T&amp;gt;(callable); }  FutureTask ç±»çš„ç»§æ‰¿ç»“æ„ public class FutureTask&amp;lt;V&amp;gt; implements RunnableFuture&amp;lt;V&amp;gt; { } public interface RunnableFuture&amp;lt;V&amp;gt; extends Runnable, Future&amp;lt;V&amp;gt; { void run(); }  FutureTaskå®ç°äº†RunnableFutureï¼Œè€ŒRunnableFutureç»§æ‰¿äº†Runnableå’ŒFutureã€‚é‚£ä¹ˆFutureTaskå³æ‹¥æœ‰Runnableç‰¹æ€§ï¼Œå¯ä»¥é…åˆçº¿ç¨‹æ± æ‰§è¡Œï¼Œåˆæ‹¥æœ‰äº†Futureç‰¹æ€§ï¼Œå¯ä»¥è·å–æ‰§è¡Œç»“æœã€‚"/>
<meta name="keywords" content=""/>
<meta name="robots" content="noodp"/>
<meta name="google-site-verification" content="e1ELBPEvOV5kwQNtzaLcNt-3iZy83eiNhSZkHhQPecs" />
<link rel="canonical" href="https://leejay.top/post/future/" />





<link rel="stylesheet" href="https://leejay.top/assets/style.css">


<link rel="stylesheet" href="https://leejay.top/style.css">

<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://leejay.top/img/apple-touch-icon-144-precomposed.png">
<link rel="shortcut icon" href="https://leejay.top/img/favicon.png">



<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Future"/>
<meta name="twitter:description" content="å› ä¸ºåŸæœ‰çš„çº¿ç¨‹æ‰§è¡Œ`æ— æ³•è·å–åˆ°è¿”å›ç»“æœ`ï¼Œæ‰€ä»¥ä¸ºäº†å¼¥è¡¥çº¿ç¨‹æ— è¿”å›å€¼çš„é—®é¢˜ï¼Œæ‰è¯ç”Ÿäº†Futureç±»ã€‚"/>



<meta property="og:title" content="Future" />
<meta property="og:description" content="å› ä¸ºåŸæœ‰çš„çº¿ç¨‹æ‰§è¡Œ`æ— æ³•è·å–åˆ°è¿”å›ç»“æœ`ï¼Œæ‰€ä»¥ä¸ºäº†å¼¥è¡¥çº¿ç¨‹æ— è¿”å›å€¼çš„é—®é¢˜ï¼Œæ‰è¯ç”Ÿäº†Futureç±»ã€‚" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://leejay.top/post/future/" />
<meta property="article:published_time" content="2020-07-19T17:11:13+08:00" />
<meta property="article:modified_time" content="2020-07-19T17:11:13+08:00" /><meta property="og:site_name" content="Aurora" />






  </head>
  <body class="">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a href="https://leejay.top" class="logo" style="text-decoration: none;">
  
    <span class="logo__mark"><svg xmlns="https://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367"/>
</svg></span>
    <span class="logo__text">Aurora</span>
    <span class="logo__cursor"></span>
    <span class="logo__cursor2"></span>
  
</a>
    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/categories">Categories</a></li>
        
      
        
          <li><a href="/tags">Tags</a></li>
        
      
      
    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/categories">Categories</a></li>
      
    
      
        <li><a href="/tags">Tags</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none"/>
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="https://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>
      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  
  

  <div class="post">
    <h1 class="post-title"><a href="https://leejay.top/post/future/">Future</a></h1>
    <div class="post-meta">
      
        <span class="post-date">
          2020-07-19
        </span>

        
          
        
      

      
      
    </div>

    
      <span class="post-tags">
        
        ğŸ–<a href="https://leejay.top/tags/future/">Future </a>&nbsp;
        
        ğŸ–<a href="https://leejay.top/tags/futuretask/">FutureTask</a>&nbsp;
        
      </span>
    

    

    <div class="post-content">
      
      <h3 id="future">Future</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">Future</span><span style="color:#f92672">&lt;</span>V<span style="color:#f92672">&gt;</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// è·å–ä»»åŠ¡ç»“æœ
</span><span style="color:#75715e"></span>    V <span style="color:#a6e22e">get</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> InterruptedException<span style="color:#f92672">,</span> ExecutionException<span style="color:#f92672">;</span>
    <span style="color:#75715e">// è·å–ä»»åŠ¡ç»“æœï¼Œå¸¦è¶…æ—¶æœºåˆ¶
</span><span style="color:#75715e"></span>    V <span style="color:#a6e22e">get</span><span style="color:#f92672">(</span><span style="color:#66d9ef">long</span> timeout<span style="color:#f92672">,</span> TimeUnit unit<span style="color:#f92672">)</span>
        <span style="color:#66d9ef">throws</span> InterruptedException<span style="color:#f92672">,</span> ExecutionException<span style="color:#f92672">,</span> TimeoutException<span style="color:#f92672">;</span>
    <span style="color:#75715e">// ä»»åŠ¡æ˜¯å¦å®Œæˆ
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isDone</span><span style="color:#f92672">();</span>
    <span style="color:#75715e">// ä»»åŠ¡æ˜¯å¦å–æ¶ˆ
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isCancelled</span><span style="color:#f92672">();</span>
    <span style="color:#75715e">// å–æ¶ˆä»»åŠ¡
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">cancel</span><span style="color:#f92672">(</span><span style="color:#66d9ef">boolean</span> mayInterruptIfRunning<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>ThreadPoolExecutorä¸­çš„submitæ–¹æ³•æ˜¯ç”±ä»–çš„çˆ¶ç±»<code>AbstractExecutorService</code>å®ç°çš„</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> Future<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">submit</span><span style="color:#f92672">(</span>Callable<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> task<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>task <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> NullPointerException<span style="color:#f92672">();</span>
    <span style="color:#75715e">// å°è£…callableå¯¹è±¡
</span><span style="color:#75715e"></span>    RunnableFuture<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> ftask <span style="color:#f92672">=</span> newTaskFor<span style="color:#f92672">(</span>task<span style="color:#f92672">);</span>
    <span style="color:#75715e">// å†è°ƒç”¨çº¿ç¨‹æ± çš„executeæ–¹æ³•
</span><span style="color:#75715e"></span>    execute<span style="color:#f92672">(</span>ftask<span style="color:#f92672">);</span>
    <span style="color:#75715e">// è¿”å›FutureTask
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> ftask<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
<span style="color:#75715e">// å°†callableä½œä¸ºå‚æ•°ä¼ å…¥FutureTaskå¯¹è±¡
</span><span style="color:#75715e"></span><span style="color:#66d9ef">protected</span> <span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> RunnableFuture<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">newTaskFor</span><span style="color:#f92672">(</span>Callable<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> callable<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> FutureTask<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;(</span>callable<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><hr>
<h3 id="futuretask">FutureTask</h3>
<h4 id="ç±»çš„ç»§æ‰¿ç»“æ„">ç±»çš„ç»§æ‰¿ç»“æ„</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">FutureTask</span><span style="color:#f92672">&lt;</span>V<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">implements</span> RunnableFuture<span style="color:#f92672">&lt;</span>V<span style="color:#f92672">&gt;</span> <span style="color:#f92672">{</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">RunnableFuture</span><span style="color:#f92672">&lt;</span>V<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">extends</span> Runnable<span style="color:#f92672">,</span> Future<span style="color:#f92672">&lt;</span>V<span style="color:#f92672">&gt;</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">();</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<p><code>FutureTask</code>å®ç°äº†<code>RunnableFuture</code>ï¼Œè€Œ<code>RunnableFuture</code>ç»§æ‰¿äº†<code>Runnable</code>å’Œ<code>Future</code>ã€‚é‚£ä¹ˆ<code>FutureTask</code>å³æ‹¥æœ‰<code>Runnable</code>ç‰¹æ€§ï¼Œå¯ä»¥é…åˆçº¿ç¨‹æ± æ‰§è¡Œï¼Œåˆæ‹¥æœ‰äº†<code>Future</code>ç‰¹æ€§ï¼Œå¯ä»¥è·å–æ‰§è¡Œç»“æœã€‚</p>
</blockquote>
<h4 id="æ„é€ å‡½æ•°">æ„é€ å‡½æ•°</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#a6e22e">FutureTask</span><span style="color:#f92672">(</span>Callable<span style="color:#f92672">&lt;</span>V<span style="color:#f92672">&gt;</span> callable<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// åˆ¤ç©º
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>callable <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> NullPointerException<span style="color:#f92672">();</span>
    <span style="color:#75715e">// æˆå‘˜å±æ€§èµ‹å€¼
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">callable</span> <span style="color:#f92672">=</span> callable<span style="color:#f92672">;</span>
    <span style="color:#75715e">// çŠ¶æ€èµ‹å€¼
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">state</span> <span style="color:#f92672">=</span> NEW<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
<span style="color:#75715e">// å¦‚æœä¼ å…¥çš„æ˜¯runnableå’Œresult
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#a6e22e">FutureTask</span><span style="color:#f92672">(</span>Runnable runnable<span style="color:#f92672">,</span> V result<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// ä¼šæ‰§è¡ŒExecutors.callableå°†ä»–ä»¬è½¬æ¢æˆCallableå¯¹è±¡
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// æœ¬è´¨æ˜¯é€šè¿‡å®ç°Callableæ¥å£çš„é€‚é…å™¨ç±»è¿›è¡Œè½¬æ¢
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">callable</span> <span style="color:#f92672">=</span> Executors<span style="color:#f92672">.</span><span style="color:#a6e22e">callable</span><span style="color:#f92672">(</span>runnable<span style="color:#f92672">,</span> result<span style="color:#f92672">);</span>
    <span style="color:#75715e">// stateèµ‹å€¼
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">state</span> <span style="color:#f92672">=</span> NEW<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<p>æ„é€ å‡½æ•°æ²¡æœ‰ç‰¹åˆ«çš„ï¼Œå°±æ˜¯å°†ä¼ å…¥çš„<code>Callable</code>å¯¹è±¡èµ‹å€¼ç»™æˆå‘˜å˜é‡ï¼Œä»¥åŠåˆå§‹åŒ–<code>state</code>çŠ¶æ€ã€‚</p>
</blockquote>
<h4 id="æˆå‘˜å±æ€§">æˆå‘˜å±æ€§</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// ç”¨äºget()è¿”å›çš„ç»“æœæˆ–æŠ›å‡ºçš„å¼‚å¸¸
</span><span style="color:#75715e">// évolatileä¿®é¥°çš„åŸå› ï¼šè¯»å†™çš„æ—¶å€™é€šè¿‡stateçš„æ¥ä¿æŠ¤
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> Object outcome<span style="color:#f92672">;</span> 
<span style="color:#75715e">// è¿è¡Œcallableçš„çº¿ç¨‹
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">volatile</span> Thread runner<span style="color:#f92672">;</span>
<span style="color:#75715e">// ç­‰å¾…çº¿ç¨‹çš„é©±åŠ¨æ ˆ
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">volatile</span> WaitNode waiters<span style="color:#f92672">;</span>
<span style="color:#75715e">// å¾…æ‰§è¡Œçš„ä»»åŠ¡ï¼Œæ‰§è¡Œåä¼šä¸ºnull
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> Callable<span style="color:#f92672">&lt;</span>V<span style="color:#f92672">&gt;</span> callable<span style="color:#f92672">;</span>
<span style="color:#75715e">// ç”¨äºè¡¨ç¤ºä»»åŠ¡çš„çŠ¶æ€
</span><span style="color:#75715e">// å¯èƒ½çš„çŠ¶æ€è½¬æ¢:
</span><span style="color:#75715e">// NEW -&gt; COMPLETEING -&gt; NORMAL
</span><span style="color:#75715e">// NEW -&gt; COMPLETEING -&gt;EXCEPTIONAL
</span><span style="color:#75715e">// NEW -&gt; CANCELLED
</span><span style="color:#75715e">// NEW -&gt; INTERRUPTING -&gt; INTERRUPTED
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">volatile</span> <span style="color:#66d9ef">int</span> state<span style="color:#f92672">;</span>
<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> NEW          <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> COMPLETING   <span style="color:#f92672">=</span> 1<span style="color:#f92672">;</span>
<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> NORMAL       <span style="color:#f92672">=</span> 2<span style="color:#f92672">;</span>
<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> EXCEPTIONAL  <span style="color:#f92672">=</span> 3<span style="color:#f92672">;</span>
<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> CANCELLED    <span style="color:#f92672">=</span> 4<span style="color:#f92672">;</span>
<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> INTERRUPTING <span style="color:#f92672">=</span> 5<span style="color:#f92672">;</span>
<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> INTERRUPTED  <span style="color:#f92672">=</span> 6<span style="color:#f92672">;</span>

<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">WaitNode</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// å½“å‰çº¿ç¨‹
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">volatile</span> Thread thread<span style="color:#f92672">;</span>
    <span style="color:#75715e">// nextèŠ‚ç‚¹
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">volatile</span> WaitNode next<span style="color:#f92672">;</span>
    WaitNode<span style="color:#f92672">()</span> <span style="color:#f92672">{</span> thread <span style="color:#f92672">=</span> Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">currentThread</span><span style="color:#f92672">();</span> <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<p>stateå…±æœ‰7ç§çŠ¶æ€ï¼Œé‚£ä¹ˆåªä¼šæœ‰å¦‚ä¸‹å››ç§çŠ¶æ€è½¬æ¢æµç¨‹ï¼š</p>
<ol>
<li>ä»»åŠ¡æ‰§è¡Œé¡ºåˆ©å®Œæˆï¼š<code>NEW -&gt; COMPLETEING -&gt; NORMAL</code></li>
<li>ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹å‡ºç°å¼‚å¸¸ï¼š<code>NEW -&gt; COMPLETEING -&gt;EXCEPTIONAL</code></li>
<li>ä»»åŠ¡è¿‡ç¨‹è¢«å–æ¶ˆï¼š<code>NEW -&gt; CANCELLED</code></li>
<li>ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­è¢«ä¸­æ–­ï¼š<code>NEW -&gt; INTERRUPTING -&gt; INTERRUPTED</code></li>
</ol>
</blockquote>
<hr>
<h4 id="run">run</h4>
<p>å› ä¸º<code>FutureTask</code>é—´æ¥å®ç°äº†<code>Runnable</code>æ¥å£ï¼Œæ‰€ä»¥åœ¨é€šè¿‡çº¿ç¨‹æ± æ‰§è¡Œæ—¶ï¼Œä¼šä»<code>run</code>å¼€å§‹æ‰§è¡Œã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// 1. å¦‚æœçŠ¶æ€ä¸æ˜¯NEWï¼Œè¯´æ˜ä»»åŠ¡æ‰§è¡Œè¿‡æˆ–å·²å–æ¶ˆæˆ–è¢«ä¸­æ–­äº†ï¼Œç›´æ¥è¿”å›
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// å¦‚æœ1ä¸æˆç«‹ï¼Œé‚£ä¹ˆæ­¤æ—¶çŠ¶æ€ä¸ºNEWï¼Œå°è¯•å°†å½“å‰çº¿ç¨‹ä¿å­˜åœ¨runnerå±æ€§ä¸­
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>state <span style="color:#f92672">!=</span> NEW <span style="color:#f92672">||</span>
        <span style="color:#f92672">!</span>UNSAFE<span style="color:#f92672">.</span><span style="color:#a6e22e">compareAndSwapObject</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> runnerOffset<span style="color:#f92672">,</span>
                                     <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">currentThread</span><span style="color:#f92672">()))</span>
        <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// è·å–ä»»åŠ¡
</span><span style="color:#75715e"></span>        Callable<span style="color:#f92672">&lt;</span>V<span style="color:#f92672">&gt;</span> c <span style="color:#f92672">=</span> callable<span style="color:#f92672">;</span>
        <span style="color:#75715e">// å†æ¬¡åˆ¤æ–­
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>c <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> state <span style="color:#f92672">==</span> NEW<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            V result<span style="color:#f92672">;</span>
            <span style="color:#75715e">// ç”¨äºæ ‡è®°æ˜¯å¦ä¿å­˜ç»“æœ
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">boolean</span> ran<span style="color:#f92672">;</span>
            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// è°ƒç”¨callæ–¹æ³•è·å–è¿”å›å€¼
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// ä¼šé˜»å¡åœ¨æ­¤ç›´åˆ°å®Œæˆæˆ–æŠ›å‡ºå¼‚å¸¸
</span><span style="color:#75715e"></span>                result <span style="color:#f92672">=</span> c<span style="color:#f92672">.</span><span style="color:#a6e22e">call</span><span style="color:#f92672">();</span>
                ran <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Throwable ex<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// å¦‚æœå‘ç”Ÿå¼‚å¸¸
</span><span style="color:#75715e"></span>                result <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
                ran <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
                <span style="color:#75715e">// è®¾ç½®å¼‚å¸¸
</span><span style="color:#75715e"></span>                setException<span style="color:#f92672">(</span>ex<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
            <span style="color:#75715e">// å¦‚æœæ²¡æœ‰å‘ç”Ÿå¼‚å¸¸ï¼Œä¸”æ‰§è¡Œå®Œæˆ
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ran<span style="color:#f92672">)</span>
                <span style="color:#75715e">// setè¿”å›å€¼
</span><span style="color:#75715e"></span>                set<span style="color:#f92672">(</span>result<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// æ¸…ç©ºrunnerå±æ€§
</span><span style="color:#75715e"></span>        runner <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
        <span style="color:#75715e">// æ¸…ç©ºrunnerå¿…é¡»è¦é‡æ–°è¯»å–stateçŠ¶æ€
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// é˜²æ­¢ä¸­æ–­è¢«é—æ¼
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">int</span> s <span style="color:#f92672">=</span> state<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>s <span style="color:#f92672">&gt;=</span> INTERRUPTING<span style="color:#f92672">)</span>
            handlePossibleCancellationInterrupt<span style="color:#f92672">(</span>s<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
<span style="color:#75715e">// ç¡®ä¿æ¥è‡ªå¯èƒ½çš„cancelï¼ˆtrueï¼‰çš„ä»»ä½•ä¸­æ–­ä»…åœ¨runæˆ–runAndResetæ—¶ä¼ é€’ç»™ä»»åŠ¡ã€‚
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">handlePossibleCancellationInterrupt</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> s<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// æ‰§è¡Œè‡³æ­¤è¯´æ˜å½“å‰çº¿ç¨‹å³å°†è¢«ä¸­æ–­ï¼Œé‚£ä¹ˆåˆ¤æ–­stateçŠ¶æ€å¹¶spinè‡ªæ—‹ï¼Œäº¤å‡ºcpuæ‰§è¡Œæƒ
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// è®©æ‰§è¡Œcancelçš„çº¿ç¨‹æ—©æ—¥æ‰§è¡Œå®Œä¸­æ–­æµç¨‹
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>s <span style="color:#f92672">==</span> INTERRUPTING<span style="color:#f92672">)</span>
        <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>state <span style="color:#f92672">==</span> INTERRUPTING<span style="color:#f92672">)</span>
            Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">yield</span><span style="color:#f92672">();</span> <span style="color:#75715e">// wait out pending interrupt
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// è¿™é‡Œè¡¥ä¸€ä¸‹ï¼š
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//Doug leaçš„æ³¨é‡Šä¸­è¯´ï¼šæˆ‘ä»¬å¸Œæœ›æ¸…é™¤æ‰€æœ‰ä»cancelæ–¹æ³•ä¸­è·å–åˆ°çš„ä¸­æ–­ï¼Œä½†æ˜¯ï¼Œ
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// æˆ‘ä»¬éœ€è¦å…è®¸ä½¿ç”¨ä¸­æ–­ä½œä¸ºä»»åŠ¡ä¸å…¶è°ƒç”¨æ–¹é€šä¿¡çš„ç‹¬ç«‹æœºåˆ¶ï¼Œå¹¶ä¸”æˆ‘ä»¬æ²¡æœ‰åŠæ³•
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//åªæ¸…é™¤cancelæ–¹æ³•çš„ä¸­æ–­
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>
<span style="color:#75715e">// å¤„ç†è¿”å›å€¼
</span><span style="color:#75715e"></span><span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>V v<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// å°è¯•å°†çŠ¶æ€NEW -&gt; COMPLETEING
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>UNSAFE<span style="color:#f92672">.</span><span style="color:#a6e22e">compareAndSwapInt</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> stateOffset<span style="color:#f92672">,</span> NEW<span style="color:#f92672">,</span> COMPLETING<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">//å°†è¿”å›å€¼èµ‹äºˆoutcome
</span><span style="color:#75715e"></span>        outcome <span style="color:#f92672">=</span> v<span style="color:#f92672">;</span>
        <span style="color:#75715e">// å’Œè®¾ç½®å¼‚å¸¸ä¸åŒï¼ŒCOMPLETEING -&gt; NORMAL
</span><span style="color:#75715e"></span>        UNSAFE<span style="color:#f92672">.</span><span style="color:#a6e22e">putOrderedInt</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> stateOffset<span style="color:#f92672">,</span> NORMAL<span style="color:#f92672">);</span> 
        finishCompletion<span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
<span style="color:#75715e">// å¤„ç†å¼‚å¸¸
</span><span style="color:#75715e"></span><span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setException</span><span style="color:#f92672">(</span>Throwable t<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// å°è¯•å°†stateç”±NEW -&gt; COMPLETEING
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>UNSAFE<span style="color:#f92672">.</span><span style="color:#a6e22e">compareAndSwapInt</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> stateOffset<span style="color:#f92672">,</span> NEW<span style="color:#f92672">,</span> COMPLETING<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// ä¸ºä»€ä¹ˆè¿™é‡Œä¸éœ€è¦åŒæ­¥ï¼Ÿ
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// æˆ‘ä»¬å‡è®¾çº¿ç¨‹Aæ‰§è¡Œäº†runæ–¹æ³•ï¼Œå½“å‘ç”Ÿå¼‚å¸¸ï¼Œé‚£ä¹ˆä¼šæ‰§è¡Œåˆ°æ­¤
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// å¦‚æœCASæˆåŠŸäº†ï¼ŒstateçŠ¶æ€è¢«ä¿®æ”¹ï¼Œé‚£ä¹ˆå…¶ä»–çº¿ç¨‹æƒ³è¦æ‰§è¡ŒsetExceptionæ–¹æ³•
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// åªèƒ½é€šè¿‡runæˆ–runAndResetï¼Œä½†ä»–ä»¬æ— æ³•é€šè¿‡ç¬¬ä¸€æ­¥çš„stateæ ¡éªŒ
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// ä¹Ÿæ˜¯outcomeæ³¨é‡Šä¸­è¯´çš„outcomeé€šè¿‡stateè¯»å†™çŠ¶æ€æ¥ä¿æŠ¤
</span><span style="color:#75715e"></span>        outcome <span style="color:#f92672">=</span> t<span style="color:#f92672">;</span>
        <span style="color:#75715e">// è®¾ç½®outcomeæˆåŠŸåæ‰§è¡ŒCASä¿®æ”¹ä¸ºEXCEPTIONAL
</span><span style="color:#75715e"></span>        UNSAFE<span style="color:#f92672">.</span><span style="color:#a6e22e">putOrderedInt</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> stateOffset<span style="color:#f92672">,</span> EXCEPTIONAL<span style="color:#f92672">);</span>
        <span style="color:#75715e">// ä»»åŠ¡å®Œæˆåè°ƒç”¨
</span><span style="color:#75715e"></span>        finishCompletion<span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e">// ç§»é™¤å’Œå”¤é†’æ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹ï¼Œæ‰§è¡Œé’©å­å‡½æ•°doneï¼Œå¹¶å°†callableè®¾ä¸ºnull
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">finishCompletion</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// æ­¤åˆ»éœ€è¦state &gt; COMPLETEING
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// å¦‚æœwaiters!=null
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>WaitNode q<span style="color:#f92672">;</span> <span style="color:#f92672">(</span>q <span style="color:#f92672">=</span> waiters<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">//CASå°†waiterså±æ€§è®¾ä¸ºnull(cancelå’ŒremoveWaitersä¹Ÿä¼šä¿®æ”¹waiterså±æ€§)
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>UNSAFE<span style="color:#f92672">.</span><span style="color:#a6e22e">compareAndSwapObject</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> waitersOffset<span style="color:#f92672">,</span> q<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// å¾ªç¯å¤„ç†waitersåŠå®ƒçš„nextèŠ‚ç‚¹
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">for</span> <span style="color:#f92672">(;;)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// è·å–ç­‰å¾…çš„çº¿ç¨‹
</span><span style="color:#75715e"></span>                Thread t <span style="color:#f92672">=</span> q<span style="color:#f92672">.</span><span style="color:#a6e22e">thread</span><span style="color:#f92672">;</span>
                <span style="color:#75715e">// å¦‚æœä¸ä¸ºnull
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>t <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#75715e">// å°†å…¶ç½®ä¸ºnull
</span><span style="color:#75715e"></span>                    q<span style="color:#f92672">.</span><span style="color:#a6e22e">thread</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
                    <span style="color:#75715e">// å¹¶unparkè¯¥çº¿ç¨‹
</span><span style="color:#75715e"></span>                    LockSupport<span style="color:#f92672">.</span><span style="color:#a6e22e">unpark</span><span style="color:#f92672">(</span>t<span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>
                <span style="color:#75715e">// è·å–ä¸‹ä¸€ä¸ªwaitNode
</span><span style="color:#75715e"></span>                WaitNode next <span style="color:#f92672">=</span> q<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">;</span>
                <span style="color:#75715e">// å¦‚æœnext = nullå°±é€€å‡ºå¾ªç¯
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>next <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
                    <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
                <span style="color:#75715e">// å°†qçš„nextå±æ€§è®¾ä¸ºnullæ–¹ä¾¿GC
</span><span style="color:#75715e"></span>                q<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
                <span style="color:#75715e">// å°†nextèµ‹äºˆqï¼Œç»§ç»­å¾ªç¯
</span><span style="color:#75715e"></span>                q <span style="color:#f92672">=</span> next<span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
            <span style="color:#75715e">// å†…å¾ªç¯é€€å‡ºåå¤–å¾ªç¯ä¹Ÿç›´æ¥é€€å‡º
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
	<span style="color:#75715e">// æ‰§è¡Œé’©å­å‡½æ•°
</span><span style="color:#75715e"></span>    done<span style="color:#f92672">();</span>
	<span style="color:#75715e">// å°†callableè®¾ä¸ºnull
</span><span style="color:#75715e"></span>    callable <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>        <span style="color:#75715e">// to reduce footprint
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<p><code>FutureTask</code>æ–¹æ³•çš„æ‰§è¡Œæ—¶é—´å°±æ˜¯<code>ThreadPoolExecutor</code>æ‰§è¡Œ<code>runWorker</code>ä¸­çš„<code>task.run</code>æ—¶è¢«è°ƒç”¨ã€‚</p>
<p><code>FutureTask #run</code>æ‰§è¡Œæµç¨‹ï¼š</p>
<ol>
<li>è‹¥<code>state!=NEW</code>æˆ–<code>æ— æ³•CASä¿®æ”¹runner</code>ç›´æ¥è¿”å›ï¼Œè¯´æ˜<code>æœ‰å…¶ä»–çº¿ç¨‹åœ¨æ‰§è¡Œrun</code>æˆ–<code>è¯¥ä»»åŠ¡å·²è¢«æ‰§è¡Œè¿‡</code>ã€‚</li>
<li>è°ƒç”¨<code>Callabel #call</code>æ–¹æ³•ï¼Œé˜»å¡ç­‰å¾…æ‰§è¡Œå®Œæ¯•ï¼Œå¦‚æœæˆåŠŸè·å–å€¼ï¼Œè°ƒç”¨<code>set(value)</code>ã€‚å¦‚æœè·å–å€¼æœŸé—´æŠ›å‡ºå¼‚å¸¸ï¼Œé‚£ä¹ˆè°ƒç”¨<code>setException()</code>ã€‚</li>
<li><code>set()ä¸setException()</code>æ–¹æ³•æ‰§è¡Œæµç¨‹ç±»ä¼¼ï¼Œ<code>state = COMPLETING</code>æ˜¯ä¸­é—´çŠ¶æ€ï¼Œå‰è€…æœ€ç»ˆä¼šè®¾ç½®<code>state = NORMAL</code>ï¼Œåè€…ä¼šè®¾ç½®<code>state = EXCEPIONAL</code>ï¼Œå¹¶ä¸”ä¸¤è€…æœ€ç»ˆéƒ½ä¼šè°ƒç”¨<code>finishCompletion</code>æ¥å”¤é†’<code>waiterså±æ€§ä¸‹ç­‰å¾…çš„çº¿ç¨‹ã€æ‰§è¡Œdone()é’©å­å‡½æ•°åŠå°†callableæ¸…ç©ºã€‚</code></li>
<li>æœ€åæ¸…ç©º<code>runner</code>å±æ€§ï¼Œå¹¶åœ¨æ­¤æ£€æŸ¥çŠ¶æ€ï¼Œå¦‚æœæ­¤æ—¶åˆ«çš„çº¿ç¨‹æ‰§è¡Œäº†<code>cancel(true)</code>æ–¹æ³•ï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦æ‰§è¡Œè‡ªæ—‹å¹¶äº¤å‡ºCPUæ‰§è¡Œæƒï¼Œè®©æ‰§è¡Œ<code>cancel</code>çš„çº¿ç¨‹æ—©æ—¥æ‰§è¡Œå®Œä¸­æ–­ã€‚</li>
</ol>
</blockquote>
<hr>
<h3 id="cancel">cancel</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// mayInterruptIfRunning true/false:
</span><span style="color:#75715e">// æ‰§è¡Œè¯¥ä»»åŠ¡çš„çº¿ç¨‹æ˜¯å¦éœ€è¦ä¸­æ–­/æ­£åœ¨æ‰§è¡Œä»»åŠ¡å…è®¸è¢«å®Œæˆ
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">cancel</span><span style="color:#f92672">(</span><span style="color:#66d9ef">boolean</span> mayInterruptIfRunning<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// å¦‚æœstate!=NEW,é‚£ä¹ˆä¼šç›´æ¥è¿”å›
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// å¦‚æœstate=NEWï¼Œé‚£ä¹ˆåŸºäºmayInterruptIfRunningçš„å€¼
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// å¦‚æœä¸ºtrueå°†NEW CASä¿®æ”¹ä¸ºINTERRUPTING,å¦åˆ™CASä¿®æ”¹ä¸ºCANCELLED
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// å¦‚æœä¿®æ”¹æˆåŠŸï¼Œæ‰ä¼šç»§ç»­æ‰§è¡Œï¼Œå¦åˆ™ç›´æ¥é€€å‡º
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!(</span>state <span style="color:#f92672">==</span> NEW <span style="color:#f92672">&amp;&amp;</span>
          UNSAFE<span style="color:#f92672">.</span><span style="color:#a6e22e">compareAndSwapInt</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> stateOffset<span style="color:#f92672">,</span> NEW<span style="color:#f92672">,</span>
                         mayInterruptIfRunning <span style="color:#f92672">?</span> INTERRUPTING <span style="color:#f92672">:</span> CANCELLED<span style="color:#f92672">)))</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>   
        <span style="color:#75715e">// ä¸ºtrueæ‰ä¼šæ‰§è¡Œä¸­æ–­æ“ä½œ
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mayInterruptIfRunning<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// å°†runnerçº¿ç¨‹ä¸­æ–­
</span><span style="color:#75715e"></span>                Thread t <span style="color:#f92672">=</span> runner<span style="color:#f92672">;</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>t <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
                    t<span style="color:#f92672">.</span><span style="color:#a6e22e">interrupt</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// CASå°†stateä¿®æ”¹ä¸ºINTERRUPTED
</span><span style="color:#75715e"></span>                UNSAFE<span style="color:#f92672">.</span><span style="color:#a6e22e">putOrderedInt</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> stateOffset<span style="color:#f92672">,</span> INTERRUPTED<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
        finishCompletion<span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<p><code>cancel</code>æ–¹æ³•çš„å…³é”®åœ¨äºå‚æ•°<code>mayInterruptIfRunning</code>ï¼š</p>
<p>â€‹	â‘  trueè¯´æ˜æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹ä¼šè¢«ä¸­æ–­ã€‚</p>
<p>â€‹	â‘¡ falseè¯´æ˜æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹ä¸ä¼šè¢«ä¸­æ–­ã€‚</p>
<p><code>cancel</code>ä¼šå¤„ç†ä¸¤ç§çŠ¶æ€ï¼š</p>
<p>â€‹	â‘  <code>NEW -&gt; INTERRUPTING(å‡†å¤‡æ‰“æ–­æ‰§è¡Œä»»åŠ¡çº¿ç¨‹) -&gt; INTERRUPTED(çº¿ç¨‹å·²è¢«æ‰“æ–­)</code></p>
<p>â€‹	â‘¡ <code>NEW -&gt; CANCELLED</code>ï¼Œä»»åŠ¡è¢«å–æ¶ˆï¼Œä¸å…è®¸ä¸­æ–­ã€‚</p>
<p><code>cancel</code>æ–¹æ³•è¦æ±‚åªæœ‰åœ¨<code>state = NEW</code>çš„æ—¶å€™æ‰èƒ½å¤Ÿ<code>é€‰æ‹©ä¸­æ–­æˆ–ä¸ä¸­æ–­çº¿ç¨‹</code>ã€‚æˆ‘ä»¬å‡è®¾çº¿ç¨‹Aæ‰§è¡Œ<code>run</code>æ–¹æ³•ç›´åˆ°<code>set()</code>æ–¹æ³•å¤„åˆ‡æ¢åˆ°çº¿ç¨‹Bï¼Œæ­¤æ—¶çº¿ç¨‹Bæ‰§è¡Œ<code>cancel(true)</code>ï¼Œä¼šè®¾ç½®<code>state = INTERRUPTING</code>ï¼Œä¸­æ–­çº¿ç¨‹åè®¾ç½®<code>state = INTERRUPTED</code>ï¼Œæ­¤æ—¶åˆ‡æ¢å›çº¿ç¨‹Aï¼Œçº¿ç¨‹Aæ‰§è¡Œ<code>set()</code>å¤±è´¥ï¼Œæ­¤æ—¶ä¼šæ‰§è¡Œ<code>finally</code>ä¸­å¤„ç†ä¸­æ–­çš„é€»è¾‘ï¼Œå°†æ‰§è¡Œæƒäº¤ç»™çº¿ç¨‹Bè¿›è¡Œä¸­æ–­çš„å¤„ç†ã€‚</p>
</blockquote>
<hr>
<h3 id="awaitdone">awaitDone</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// ç­‰å¾…å®Œæˆ æˆ–å› ä¸ºä¸­æ–­æˆ–è¶…æ—¶å¯¼è‡´çš„ç»ˆæ­¢
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">awaitDone</span><span style="color:#f92672">(</span><span style="color:#66d9ef">boolean</span> timed<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> nanos<span style="color:#f92672">)</span>
        					<span style="color:#66d9ef">throws</span> InterruptedException <span style="color:#f92672">{</span>
    <span style="color:#75715e">// è®¡ç®—deadline
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">long</span> deadline <span style="color:#f92672">=</span> timed <span style="color:#f92672">?</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">nanoTime</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> nanos <span style="color:#f92672">:</span> 0L<span style="color:#f92672">;</span>
    WaitNode q <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
    <span style="color:#75715e">// ç”¨äºè¡¨ç¤ºæ˜¯å¦æˆåŠŸåŠ å…¥waiteré˜Ÿåˆ—ä¸­
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">boolean</span> queued <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
    <span style="color:#75715e">// è‡ªæ—‹
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(;;)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­ï¼Œå¦‚æœè¢«ä¸­æ–­è¿˜ä¼šé¡ºä¾¿æ¸…é™¤ä¸­æ–­çŠ¶æ€
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">interrupted</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// ç§»é™¤waiter
</span><span style="color:#75715e"></span>            removeWaiter<span style="color:#f92672">(</span>q<span style="color:#f92672">);</span>
            <span style="color:#75715e">// æŠ›å‡ºä¸­æ–­å¼‚å¸¸
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> InterruptedException<span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>
		<span style="color:#75715e">// è·å–state
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">int</span> s <span style="color:#f92672">=</span> state<span style="color:#f92672">;</span>
        <span style="color:#75715e">// å¦‚æœstate&gt;COMPLETINGï¼Œè¯´æ˜æµç¨‹å·²ç»èµ°å®Œ
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// è¦ä¹ˆæ­£å¸¸ç»“æŸï¼Œè¦ä¹ˆcanceläº†ï¼Œè¦ä¹ˆè¢«ä¸­æ–­äº†
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>s <span style="color:#f92672">&gt;</span> COMPLETING<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// å¦‚æœthreadä¸ä¸ºnullå°±æ¸…ç©ºå®ƒ
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>q <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
                q<span style="color:#f92672">.</span><span style="color:#a6e22e">thread</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
            <span style="color:#75715e">// è¿”å›stateè·³å‡ºå¾ªç¯
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">return</span> s<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
        <span style="color:#75715e">// å¦‚æœstate=COMPLETING,è¯´æ˜æ­£åœ¨è®¾ç½®outcomeï¼Œé‚£ä¹ˆè®©å‡ºcpuæ‰§è¡Œæƒ
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>s <span style="color:#f92672">==</span> COMPLETING<span style="color:#f92672">)</span>
            Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">yield</span><span style="color:#f92672">();</span>
        <span style="color:#75715e">// æ„å»ºæ–°çš„waitNodeèŠ‚ç‚¹
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>q <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
            q <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> WaitNode<span style="color:#f92672">();</span>
        <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>queued<span style="color:#f92672">)</span>
            <span style="color:#75715e">// è¿™é‡Œéœ€è¦æ³¨æ„ä¸‹ï¼Œå°†waitersæ›¿æ¢ä¸ºqçš„åŒæ—¶è®¾ç½®q.next = waiters
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// æ ˆç»“æ„ï¼Œå…ˆè¿›åå‡º
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// CASæˆåŠŸï¼Œä¸‹æ¬¡å°±ä¸ä¼šæ‰§è¡Œè¯¥å¤„ä»£ç 
</span><span style="color:#75715e"></span>            queued <span style="color:#f92672">=</span> UNSAFE<span style="color:#f92672">.</span><span style="color:#a6e22e">compareAndSwapObject</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> waitersOffset<span style="color:#f92672">,</span>
                                                 q<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span> <span style="color:#f92672">=</span> waiters<span style="color:#f92672">,</span> q<span style="color:#f92672">);</span>
        <span style="color:#75715e">// å¦‚æœè®¾ç½®äº†è¶…æ—¶æ—¶é—´ä¼šæ‰§è¡Œæ­¤å¤„ä»£ç 
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>timed<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            nanos <span style="color:#f92672">=</span> deadline <span style="color:#f92672">-</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">nanoTime</span><span style="color:#f92672">();</span>
            <span style="color:#75715e">// å¦‚æœç­‰å¾…æ—¶å€™åˆ°äº†ï¼Œé‚£ä¹ˆä»é˜Ÿåˆ—ç§»é™¤ï¼Œå¹¶ä¸å†ç­‰å¾…è¿”å›stateé€€å‡ºå¾ªç¯
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>nanos <span style="color:#f92672">&lt;=</span> 0L<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                removeWaiter<span style="color:#f92672">(</span>q<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">return</span> state<span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
            <span style="color:#75715e">// é˜»å¡æŒ‡å®šæ—¶é•¿
</span><span style="color:#75715e"></span>            LockSupport<span style="color:#f92672">.</span><span style="color:#a6e22e">parkNanos</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> nanos<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">else</span>
            <span style="color:#75715e">// å¦‚æœæ²¡è®¾ç½®å°è¯•åˆ™æŒ‚èµ·å½“å‰çº¿ç¨‹
</span><span style="color:#75715e"></span>            LockSupport<span style="color:#f92672">.</span><span style="color:#a6e22e">park</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<p>è¯¥æ–¹æ³•çš„ç›®çš„ï¼šè®©<code>å½“å‰çº¿ç¨‹ç­‰å¾…ä»»åŠ¡å®Œæˆ</code>æˆ–<code>å› ä¸ºä¸­æ–­æˆ–è¶…æ—¶å¯¼è‡´çš„ä¸­æ–­</code>è€Œè¿”å›ã€‚</p>
<p>è¯¥æ–¹æ³•æ¯æ¬¡æ‰§è¡Œéƒ½ä¼šå…ˆè¿›è¡Œä¸‰ä¸ªåˆ¤æ–­ï¼š</p>
<p>â€‹	â‘  <code>å…ˆåˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­</code>ï¼Œå¦‚æœè¢«ä¸­æ–­å°±æŠ›å‡ºä¸­æ–­å¼‚å¸¸ã€‚</p>
<p>â€‹    â‘¡ <code>å†åˆ¤æ–­stateçŠ¶æ€ï¼Œè‹¥state &gt; COMPLETING</code>ï¼Œè¯´æ˜æµç¨‹å·²ç»å¿«èµ°å®Œäº†(ä¸ç®¡æ˜¯æ­£å¸¸è¿˜æ˜¯ä¸æ­£å¸¸)ã€‚</p>
<p>â€‹	â‘¢  <code>åˆ¤æ–­state = COMPLETING</code>æ˜¯å¦æˆç«‹ï¼Œæˆç«‹è¯´æ˜æ­£åœ¨è®¾ç½®<code>outcomt</code>ï¼Œé‚£ä¹ˆäº¤å‡ºCPUæ§åˆ¶æƒã€‚</p>
<p>å¦‚æœä¸‰ä¸ªåˆ¤æ–­éƒ½èƒ½é€šè¿‡çš„è¯ï¼Œé‚£ä¹ˆè¯¥æ–¹æ³•è‡³å°‘ä¼šå¾ªç¯ä¸‰æ¬¡ï¼š</p>
<p>â€‹	â‘  å› ä¸º<code>q = null</code>ï¼Œ<code>q = new WaitNode()</code>ã€‚</p>
<p>â€‹	â‘¡ å› ä¸º<code>!queued = true</code>ï¼Œå°†<code>qè®¾ä¸ºwaiterså±æ€§åŒæ—¶ï¼Œå°†åŸwaitersæŒ‚åœ¨qçš„nextå±æ€§ä¸‹</code>ã€‚ç±»ä¼¼æ ˆç»“æ„.</p>
<p>â€‹	â‘¢ å¦‚æœè®¾ç½®äº†è¶…æ—¶ï¼Œä¼š<code>é˜»å¡æŒ‡å®šæ—¶é•¿æœ€ç»ˆé€€å‡º</code>ï¼Œå¦åˆ™ä¼šä¸€ç›´é˜»å¡ç›´åˆ°è¢«<code>set()/setException()</code>å”¤é†’ã€‚</p>
</blockquote>
<hr>
<h3 id="get">get</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> V <span style="color:#a6e22e">get</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> InterruptedException<span style="color:#f92672">,</span> ExecutionException <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">int</span> s <span style="color:#f92672">=</span> state<span style="color:#f92672">;</span>
    <span style="color:#75715e">// å¦‚æœstate çŠ¶æ€ &lt;= COMPLETEINGï¼Œè¯´æ˜æ­¤æ—¶å‡†å¤‡è®¾ç½®outcomeæˆ–è¿˜æ²¡æœ‰æ‰§è¡Œrun
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>s <span style="color:#f92672">&lt;=</span> COMPLETING<span style="color:#f92672">)</span>
        <span style="color:#75715e">// å°†å½“å‰çº¿ç¨‹åŠ å…¥é˜»å¡é˜Ÿåˆ—ï¼Œç­‰å¾…ä»»åŠ¡æ‰§è¡Œå®Œæˆå”¤é†’
</span><span style="color:#75715e"></span>        s <span style="color:#f92672">=</span> awaitDone<span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> 0L<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">return</span> report<span style="color:#f92672">(</span>s<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
<span style="color:#75715e">// getæŒ‡å®šæ—¶é•¿
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> V <span style="color:#a6e22e">get</span><span style="color:#f92672">(</span><span style="color:#66d9ef">long</span> timeout<span style="color:#f92672">,</span> TimeUnit unit<span style="color:#f92672">)</span>
        <span style="color:#66d9ef">throws</span> InterruptedException<span style="color:#f92672">,</span> ExecutionException<span style="color:#f92672">,</span> TimeoutException <span style="color:#f92672">{</span>
    <span style="color:#75715e">// åˆ¤ç©º
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>unit <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> NullPointerException<span style="color:#f92672">();</span>
    <span style="color:#66d9ef">int</span> s <span style="color:#f92672">=</span> state<span style="color:#f92672">;</span>
    <span style="color:#75715e">// å¦‚æœä»»åŠ¡è¿˜æœªå®Œæˆæˆ–è€…ç­‰å¾…æ‰§è¡Œæ—¶é•¿åå”¤é†’ï¼Œä»»åŠ¡è¿˜æ˜¯æ²¡æœ‰å®Œæˆï¼ŒæŠ›å‡ºè¶…æ—¶å¼‚å¸¸
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>s <span style="color:#f92672">&lt;=</span> COMPLETING <span style="color:#f92672">&amp;&amp;</span>
        <span style="color:#f92672">(</span>s <span style="color:#f92672">=</span> awaitDone<span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">,</span> unit<span style="color:#f92672">.</span><span style="color:#a6e22e">toNanos</span><span style="color:#f92672">(</span>timeout<span style="color:#f92672">)))</span> <span style="color:#f92672">&lt;=</span> COMPLETING<span style="color:#f92672">)</span>
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> TimeoutException<span style="color:#f92672">();</span>
    <span style="color:#66d9ef">return</span> report<span style="color:#f92672">(</span>s<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
<span style="color:#75715e">// è¿”å›å·²å®Œæˆä»»åŠ¡çš„ç»“æœæˆ–æŠ›å‡ºå¼‚å¸¸
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> V <span style="color:#a6e22e">report</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> s<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> ExecutionException <span style="color:#f92672">{</span>
    <span style="color:#75715e">// è·å–outcome
</span><span style="color:#75715e"></span>    Object x <span style="color:#f92672">=</span> outcome<span style="color:#f92672">;</span>
    <span style="color:#75715e">// å¦‚æœçŠ¶æ€ä¸ºNORMALï¼Œè¯´æ˜ä»»åŠ¡æ­£å¸¸ç»“æŸ
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>s <span style="color:#f92672">==</span> NORMAL<span style="color:#f92672">)</span>
        <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span>V<span style="color:#f92672">)</span>x<span style="color:#f92672">;</span>
    <span style="color:#75715e">// state &gt;= CANCELLEDè¯´æ˜ä»»åŠ¡è¢«canceläº†
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>s <span style="color:#f92672">&gt;=</span> CANCELLED<span style="color:#f92672">)</span>
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> CancellationException<span style="color:#f92672">();</span>
    <span style="color:#75715e">// å…¶ä»–æƒ…å†µæŠ›å‡ºExecutionExceptionå¼‚å¸¸
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> ExecutionException<span style="color:#f92672">((</span>Throwable<span style="color:#f92672">)</span>x<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>

</code></pre></div><blockquote>
<p>get()æ–¹æ³•ä¼šå…ˆåˆ¤æ–­<code>state &lt;= COMPLETING</code>ä»»åŠ¡æ˜¯å¦å®Œæˆï¼Œå¦‚æœæ²¡æœ‰å®Œæˆï¼Œä¼šè°ƒç”¨<code>awaitDone</code>è¿›è¡Œé˜»å¡ã€‚ç›´åˆ°ä»»åŠ¡å®Œæˆä¼šè°ƒç”¨<code>finishCompletion</code>å”¤é†’é˜»å¡çº¿ç¨‹ã€‚</p>
<p>get(time)åœ¨åˆ¤æ–­<code>state &lt;= COMPLETING</code>çš„åŒæ—¶ï¼Œä¹Ÿä¼šåˆ¤æ–­<code>awaitDome(time)</code>åä»»åŠ¡æ˜¯å¦ä»æœªå®Œæˆï¼Œè‹¥ä»æœªå®Œæˆï¼Œå°±æŠ›å‡º<code>è¶…æ—¶å¼‚å¸¸</code>ã€‚</p>
<p>ä¸¤ä¸ªæ–¹æ³•æœ€ç»ˆéƒ½è°ƒç”¨<code>report()</code>ï¼Œé€šè¿‡<code>state</code>æ¥åˆ¤æ–­æ˜¯è¿”å›<code>å€¼è¿˜æ˜¯æŠ›å‡ºå¼‚å¸¸</code>ã€‚</p>
</blockquote>

    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h">å…¶ä»–æ–‡ç« </span>
            <hr />
          </div>
          <div class="pagination__buttons">
            
              <span class="button previous">
                <a href="https://leejay.top/post/%E4%BA%8C%E5%8F%89%E5%A0%86%E6%97%B6%E9%97%B4%E5%A4%8D%E6%9D%82%E5%BA%A6%E5%88%86%E6%9E%90/">
                  <span class="button__icon">â†</span>
                  <span class="button__text">äºŒå‰å †æ—¶é—´å¤æ‚åº¦åˆ†æ</span>
                </a>
              </span>
            
            
              <span class="button next">
                <a href="https://leejay.top/post/threadpool/">
                  <span class="button__text">ThreadPool</span>
                  <span class="button__icon">â†’</span>
                </a>
              </span>
            
          </div>
        </div>
      
    


    
      
        

      
    

    </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright copyright--user">è‹ICPå¤‡18050258å·-1</div>
    
  </div>
</footer>

<script src="https://leejay.top/assets/main.js"></script>
<script src="https://leejay.top/assets/prism.js"></script>
<script type="text/javascript"
src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    showProcessingMessages: false, //å…³é—­jsåŠ è½½è¿‡ç¨‹ä¿¡æ¯
    messageStyle: "none", //ä¸æ˜¾ç¤ºä¿¡æ¯
    extensions: ["tex2jax.js"],
    jax: ["input/TeX", "output/HTML-CSS"],
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre','code', 'a', 'annotation', 'annotation-xml'],
      ignoreClass: 'crayon-.*' // 'crayon-' å¼€å¤´çš„ç±»ï¼Œå±äºWordpressä»£ç é«˜äº®åº“ï¼Œè¿™éƒ¨åˆ†ä¸éœ€è¦å¤„ç†ï¼Œå¦åˆ™ä¼šå¯¼è‡´æ˜¾ç¤ºä¸æ­£ç¡®,è¿™éƒ¨åˆ†æ˜¯æ­£åˆ™å¼ï¼Œå¤šæ¡ä¹‹é—´ç”¨'|'åˆ†å‰²    
    },
    'HTML-CSS': {
        showMathMenu: false //ç¦ç”¨å³é”®èœå•
    }
  });
</script>


      
    </div>

    
  </body>
</html>
